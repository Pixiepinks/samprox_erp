<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mind | SAMPROX ERP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" />
</head>
<body>
    <div class="page">
        <header class="topbar">
            <div class="brand">
                <div class="brand__logo">S</div>
                <div class="brand__details">
                    <p class="brand__name">SAMPROX ERP</p>
                    <p class="brand__section">7M Operations Overview</p>
                </div>
            </div>
            <div class="topbar__actions">
                <div class="user-summary">
                    <span class="user-summary__name" id="user-name"></span>
                    <span class="user-summary__role" id="user-role"></span>
                </div>
                <button type="button" class="button button--secondary" id="logout">Sign out</button>
            </div>
        </header>
        <nav class="subnav" aria-label="7M navigation">
            <a class="subnav__link subnav__link--active" href="{{ url_for('ui.mind_page') }}">Mind</a>
            <a class="subnav__link" href="{{ url_for('ui.man_page') }}">Man</a>
            <a class="subnav__link" href="{{ url_for('ui.machines_page') }}">Machine</a>
            <a class="subnav__link" href="{{ url_for('ui.material_page') }}">Material</a>
            <a class="subnav__link" href="{{ url_for('ui.market_page') }}">Market</a>
            <a class="subnav__link" href="{{ url_for('ui.manufacturing_page') }}">Manufacturing</a>
            <a class="subnav__link" href="{{ url_for('ui.money_page') }}">Money</a>
        </nav>
        <section class="section">
            <header class="section__header">
                <h1>Manage the entire operation with the 7M model</h1>
            </header>
            <p class="section__description">
                Track each resource pillar with focused workspaces. Use the cards below to open the
                dedicated page for each "M" and keep teams aligned on their responsibilities.
            </p>
            <div class="dashboard">
                <article class="card">
                    <h2 class="card__title">Mind</h2>
                    <p class="card__description">
                        Align leadership focus, strategic initiatives, and continuous improvement efforts.
                        Keep a pulse on innovation projects and cultural priorities across the operation.
                    </p>
                    <div class="card__actions">
                        <a class="card__link" href="{{ url_for('ui.mind_page') }}">Open Mind workspace</a>
                    </div>
                </article>
                <article class="card">
                    <h2 class="card__title">Man</h2>
                    <p class="card__description">
                        Coordinate workforce planning, team assignments, and skill development. Capture
                        training needs and ensure the right people are assigned to the right jobs.
                    </p>
                    <div class="card__actions">
                        <a class="card__link" href="{{ url_for('ui.man_page') }}">Open Man workspace</a>
                    </div>
                </article>
                <article class="card">
                    <h2 class="card__title">Machine</h2>
                    <p class="card__description">
                        Monitor machine health, schedule maintenance, and review asset utilization. Log
                        maintenance jobs and keep equipment ready for production.
                    </p>
                    <div class="card__actions">
                        <a class="card__link" href="{{ url_for('ui.machines_page') }}">Open Machine workspace</a>
                    </div>
                </article>
                <article class="card">
                    <h2 class="card__title">Material</h2>
                    <p class="card__description">
                        Keep an eye on inventory balances, supplier performance, and material movement.
                        Track what is on hand and what needs to be reordered to support production.
                    </p>
                    <div class="card__actions">
                        <a class="card__link" href="{{ url_for('ui.material_page') }}">Open Material workspace</a>
                    </div>
                </article>
                <article class="card">
                    <h2 class="card__title">Market</h2>
                    <p class="card__description">
                        Review customer demand, order pipelines, and market feedback. Align production
                        priorities with sales opportunities and customer commitments.
                    </p>
                    <div class="card__actions">
                        <a class="card__link" href="{{ url_for('ui.market_page') }}">Open Market workspace</a>
                    </div>
                </article>
                <article class="card">
                    <h2 class="card__title">Manufacturing</h2>
                    <p class="card__description">
                        Coordinate production schedules, capacity plans, and in-process quality checks
                        to keep every order on track from release to shipment.
                    </p>
                    <div class="card__actions">
                        <a class="card__link" href="{{ url_for('ui.manufacturing_page') }}">Open Manufacturing workspace</a>
                    </div>
                </article>
                <article class="card">
                    <h2 class="card__title">Money</h2>
                    <p class="card__description">
                        Stay on top of budgets, job costs, and cash flow. Build visibility into
                        financial performance to inform operational decisions.
                    </p>
                    <div class="card__actions">
                        <a class="card__link" href="{{ url_for('ui.money_page') }}">Open Money workspace</a>
                    </div>
                </article>
            </div>
            <section class="production-chart" aria-labelledby="production-chart-title">
                <header class="production-chart__header">
                    <div>
                        <h2 id="production-chart-title">Monthly production</h2>
                        <p>Review day-by-day output and spot trends instantly.</p>
                    </div>
                    <div class="production-chart__controls">
                        <label class="production-chart__select">
                            <span>Time period</span>
                            <select id="production-period"></select>
                        </label>
                        <button type="button" class="button button--ghost" id="production-compare-toggle" aria-pressed="false">
                            Compare with previous month
                        </button>
                    </div>
                </header>
                <div class="production-chart__body">
                    <p id="production-status" class="production-chart__status" role="status" hidden></p>
                    <div class="production-chart__summary" id="production-summary" aria-live="polite"></div>
                    <div class="production-chart__canvas">
                        <canvas id="production-chart" height="320" aria-label="Daily production bar chart" role="img"></canvas>
                    </div>
                </div>
            </section>
        </section>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" integrity="sha384-2hsX9lbZx66ijOEX08NEz6q0Go7slp6eyfrSxgJQnJ6vq6VI0RZIueukgPHmR8h4" crossorigin="anonymous"></script>
    <script>
        const token = localStorage.getItem("samprox_token");
        const userRaw = localStorage.getItem("samprox_user");
        let user;

        try {
            user = userRaw ? JSON.parse(userRaw) : null;
        } catch (_) {
            user = null;
        }

        if (!token || !user) {
            window.location.href = "/";
        }

        const roleLabels = {
            admin: "Admin",
            production_manager: "Production Manager",
            maintenance_manager: "Maintenance Manager",
            technician: "Technician",
        };

        const userNameEl = document.getElementById("user-name");
        const userRoleEl = document.getElementById("user-role");
        const logoutButton = document.getElementById("logout");

        userNameEl.textContent = user?.name || "Unknown";
        userRoleEl.textContent = roleLabels[user?.role] || "";

        logoutButton.addEventListener("click", () => {
            localStorage.removeItem("samprox_token");
            localStorage.removeItem("samprox_user");
            window.location.href = "/";
        });

        const periodSelect = document.getElementById("production-period");
        const compareToggle = document.getElementById("production-compare-toggle");
        const summaryContainer = document.getElementById("production-summary");
        const chartCanvas = document.getElementById("production-chart");
        const statusEl = document.getElementById("production-status");

        const monthlyCache = new Map();

        const formatNumber = (value, { minimumFractionDigits = 0, maximumFractionDigits = 0 } = {}) => {
            const numericValue = Number(value) || 0;
            return numericValue.toLocaleString(undefined, {
                minimumFractionDigits,
                maximumFractionDigits,
            });
        };

        const formatQuantity = (value) => formatNumber(value, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        const setStatus = (message, type = "info") => {
            if (!statusEl) {
                return;
            }
            if (!message) {
                statusEl.textContent = "";
                statusEl.hidden = true;
                statusEl.classList.remove("production-chart__status--error");
                return;
            }
            statusEl.textContent = message;
            statusEl.hidden = false;
            statusEl.classList.toggle("production-chart__status--error", type === "error");
        };

        const buildSummary = (periodData, compareData = null) => {
            const values = (periodData?.values || []).map((value) => Number(value) || 0);
            if (!values.length) {
                summaryContainer.innerHTML = "";
                return;
            }

            const total = Number(periodData?.total_quantity_tons ?? values.reduce((sum, value) => sum + value, 0));
            const average = Number(periodData?.average_quantity_tons ?? (total / values.length));
            const peakValue = Number(periodData?.peak_quantity_tons ?? Math.max(...values));
            const peakDayIndex = periodData?.peak_day ? periodData.peak_day - 1 : values.indexOf(peakValue);
            const peakDay = peakDayIndex >= 0 ? peakDayIndex + 1 : null;

            const summaryMetrics = [
                {
                    label: "Total (tons)",
                    value: formatQuantity(total),
                },
                {
                    label: "Average / day (tons)",
                    value: formatQuantity(average),
                },
                {
                    label: "Peak day",
                    value: peakDay
                        ? `Day ${peakDay} – ${formatQuantity(peakValue)} tons`
                        : "No production recorded",
                },
            ];

            if (compareData) {
                const compareValues = (compareData.values || []).map((value) => Number(value) || 0);
                const compareTotal = Number(compareData.total_quantity_tons ?? compareValues.reduce((sum, value) => sum + value, 0));
                const delta = total - compareTotal;
                const deltaPercentage = compareTotal !== 0 ? ((delta / compareTotal) * 100).toFixed(1) : null;
                summaryMetrics.push({
                    label: "Change vs. prior month",
                    value:
                        compareTotal === 0
                            ? `${delta >= 0 ? "+" : ""}${formatQuantity(delta)} tons`
                            : `${delta >= 0 ? "+" : ""}${formatQuantity(delta)} tons (${deltaPercentage}%)`,
                });
            }

            summaryContainer.innerHTML = summaryMetrics
                .map(
                    (metric) => `
                        <div class="production-chart__metric">
                            <span class="production-chart__metric-label">${metric.label}</span>
                            <span class="production-chart__metric-value">${metric.value}</span>
                        </div>
                    `,
                )
                .join("");
        };

        const getPreviousPeriodKey = (periodKey) => {
            if (!periodKey) {
                return null;
            }
            const [yearStr, monthStr] = periodKey.split("-");
            const year = Number(yearStr);
            const month = Number(monthStr);
            if (!Number.isFinite(year) || !Number.isFinite(month)) {
                return null;
            }
            const previousDate = new Date(year, month - 2, 1);
            const previousYear = previousDate.getFullYear();
            const previousMonth = previousDate.getMonth() + 1;
            return `${previousYear.toString().padStart(4, "0")}-${previousMonth
                .toString()
                .padStart(2, "0")}`;
        };

        const loadPeriodData = async (periodKey) => {
            if (!periodKey) {
                throw new Error("Select a period to view production data.");
            }
            if (monthlyCache.has(periodKey)) {
                return monthlyCache.get(periodKey);
            }

            const params = new URLSearchParams({ period: periodKey });
            const response = await fetch(`/api/production/monthly-summary?${params.toString()}`, {
                headers: {
                    Authorization: `Bearer ${token}`,
                },
            });

            if (!response.ok) {
                const payload = await response.json().catch(() => null);
                const message = payload?.msg || "Unable to load production data.";
                throw new Error(message);
            }

            const payload = await response.json();
            const normalizedValues = (payload.values || []).map((value) => Number(value) || 0);
            const data = {
                ...payload,
                values: normalizedValues,
            };

            monthlyCache.set(periodKey, data);
            return data;
        };

        const buildDataset = (primaryData, comparisonData = null) => {
            const labels = Array.from({ length: primaryData.days || primaryData.values.length }, (_, index) => index + 1);

            const datasets = [
                {
                    label: primaryData.label,
                    data: [...primaryData.values],
                    backgroundColor: "rgba(37, 99, 235, 0.65)",
                    borderRadius: 6,
                    maxBarThickness: 18,
                },
            ];

            if (comparisonData) {
                const comparisonValues = labels.map((_, index) => {
                    if (index < comparisonData.values.length) {
                        return comparisonData.values[index];
                    }
                    return null;
                });

                datasets.push({
                    label: comparisonData.label,
                    data: comparisonValues,
                    backgroundColor: "rgba(148, 163, 184, 0.65)",
                    borderRadius: 6,
                    maxBarThickness: 18,
                });
            }

            return { labels, datasets };
        };

        const renderChart = (dataset) => {
            if (!dataset) {
                return;
            }

            if (window.productionChartInstance) {
                window.productionChartInstance.data.labels = dataset.labels;
                window.productionChartInstance.data.datasets = dataset.datasets;
                window.productionChartInstance.update();
                return;
            }

            window.productionChartInstance = new Chart(chartCanvas, {
                type: "bar",
                data: dataset,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: "Day of month",
                            },
                            grid: {
                                display: false,
                            },
                            ticks: {
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 15,
                            },
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: "Tons produced",
                            },
                            ticks: {
                                callback: (value) => formatQuantity(value),
                            },
                        },
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                usePointStyle: true,
                            },
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.dataset.label || "";
                                    const value = context.parsed.y;
                                    return `${label}: ${formatQuantity(value)} tons`;
                                },
                            },
                        },
                    },
                },
            });
        };

        let activeRequestId = 0;

        const updateChart = async () => {
            const requestId = ++activeRequestId;
            const periodKey = periodSelect.value;
            const includePrevious = compareToggle.getAttribute("aria-pressed") === "true";

            summaryContainer.innerHTML = "";
            setStatus("Loading daily production…");

            try {
                const primaryData = await loadPeriodData(periodKey);
                if (requestId !== activeRequestId) {
                    return;
                }

                let comparisonData = null;
                if (includePrevious) {
                    const previousKey = getPreviousPeriodKey(periodKey);
                    if (previousKey) {
                        comparisonData = await loadPeriodData(previousKey);
                    }
                }

                if (requestId !== activeRequestId) {
                    return;
                }

                const dataset = buildDataset(primaryData, comparisonData);
                buildSummary(primaryData, comparisonData);
                renderChart(dataset);
                setStatus("");
            } catch (error) {
                if (requestId !== activeRequestId) {
                    return;
                }
                console.error(error);
                renderChart(null);
                setStatus(error.message || "Unable to load production data.", "error");
            }
        };

        const buildPeriodOptions = () => {
            const monthsToShow = 6;
            const today = new Date();
            periodSelect.innerHTML = "";

            for (let offset = 0; offset < monthsToShow; offset += 1) {
                const optionDate = new Date(today.getFullYear(), today.getMonth() - offset, 1);
                const key = `${optionDate.getFullYear().toString().padStart(4, "0")}-${(optionDate.getMonth() + 1)
                    .toString()
                    .padStart(2, "0")}`;
                const label = optionDate.toLocaleDateString(undefined, {
                    month: "long",
                    year: "numeric",
                });
                const option = document.createElement("option");
                option.value = key;
                option.textContent = label;
                periodSelect.appendChild(option);
            }
        };

        periodSelect.addEventListener("change", () => {
            updateChart();
        });

        compareToggle.addEventListener("click", () => {
            const isActive = compareToggle.getAttribute("aria-pressed") === "true";
            compareToggle.setAttribute("aria-pressed", String(!isActive));
            compareToggle.classList.toggle("button--active", !isActive);
            updateChart();
        });

        buildPeriodOptions();
        updateChart();
    </script>
</body>
</html>
