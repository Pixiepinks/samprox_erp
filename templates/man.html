<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Man | SAMPROX ERP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" />
</head>
<body>
    <div class="page">
        <header class="topbar">
            <div class="brand">
                <div class="brand__logo">S</div>
                <div class="brand__details">
                    <p class="brand__name">SAMPROX ERP</p>
                    <p class="brand__section">Man Resource Planning</p>
                </div>
            </div>
            <div class="topbar__actions">
                <a class="button button--ghost" href="{{ url_for('ui.mind_page') }}">Mind</a>
                <div class="user-summary">
                    <span class="user-summary__name" id="user-name"></span>
                    <span class="user-summary__role" id="user-role"></span>
                </div>
                <button type="button" class="button button--secondary" id="logout">Sign out</button>
            </div>
        </header>
        <nav class="subnav" aria-label="7M navigation">
            <a class="subnav__link" href="{{ url_for('ui.mind_page') }}">Mind</a>
            <a class="subnav__link subnav__link--active" href="{{ url_for('ui.man_page') }}">Man</a>
            <a class="subnav__link" href="{{ url_for('ui.machines_page') }}">Machine</a>
            <a class="subnav__link" href="{{ url_for('ui.material_page') }}">Material</a>
            <a class="subnav__link" href="{{ url_for('ui.market_page') }}">Market</a>
            <a class="subnav__link" href="{{ url_for('ui.manufacturing_page') }}">Manufacturing</a>
            <a class="subnav__link" href="{{ url_for('ui.money_page') }}">Money</a>
        </nav>
        <section class="section">
            <header class="section__header">
                <h1>People & capability overview</h1>
            </header>
            <p class="section__description">
                Manage the workforce pipeline by tracking available skills, upcoming shifts, and
                training requirements. Use this page to ensure the right technicians are ready for
                each maintenance job and production order.
            </p>
            <div class="section__grid">
                <article class="tile">
                    <h2 class="tile__title">Team roster</h2>
                    <p class="tile__description">
                        View key team members, their roles, and certification status. Identify coverage
                        gaps before they impact production schedules.
                    </p>
                </article>
                <article class="tile">
                    <h2 class="tile__title">Training tracker</h2>
                    <p class="tile__description">
                        Monitor mandatory trainings, license renewals, and development plans to keep the
                        workforce compliant and skilled.
                    </p>
                </article>
                <article class="tile">
                    <h2 class="tile__title">Shift planning</h2>
                    <p class="tile__description">
                        Align technician shifts with maintenance demand and active work orders. Balance
                        workloads to prevent burnout.
                    </p>
                </article>
                <article class="tile">
                    <h2 class="tile__title">Safety briefings</h2>
                    <p class="tile__description">
                        Document toolbox talks and safety observations. Share recurring hazards with the
                        wider team to improve awareness.
                    </p>
                </article>
            </div>
            <section class="work-calendar" aria-labelledby="work-calendar-heading">
                <div class="work-calendar__header">
                    <div class="work-calendar__intro">
                        <h2 class="work-calendar__title" id="work-calendar-heading">Work calendar</h2>
                        <p class="work-calendar__description">
                            Plan working days and public holidays for the team. Times are shown in the Asia/Colombo timezone.
                        </p>
                    </div>
                    <div class="work-calendar__controls" role="group" aria-label="Select calendar month">
                        <label class="work-calendar__selector">
                            <span class="work-calendar__selector-label">Year</span>
                            <select class="edit-form__input work-calendar__select" id="work-calendar-year"></select>
                        </label>
                        <label class="work-calendar__selector">
                            <span class="work-calendar__selector-label">Month</span>
                            <select class="edit-form__input work-calendar__select" id="work-calendar-month"></select>
                        </label>
                    </div>
                </div>
                <div class="work-calendar__content">
                    <div class="work-calendar__weekdays" aria-hidden="true">
                        <span class="work-calendar__weekday">Mon</span>
                        <span class="work-calendar__weekday">Tue</span>
                        <span class="work-calendar__weekday">Wed</span>
                        <span class="work-calendar__weekday">Thu</span>
                        <span class="work-calendar__weekday">Fri</span>
                        <span class="work-calendar__weekday">Sat</span>
                        <span class="work-calendar__weekday">Sun</span>
                    </div>
                    <div class="work-calendar__grid" id="work-calendar-grid" role="grid" aria-labelledby="work-calendar-heading"></div>
                    <div class="work-calendar__loading" id="work-calendar-loading" hidden>
                        <span class="work-calendar__loading-text">Loading calendar…</span>
                    </div>
                </div>
                <p class="work-calendar__message" id="work-calendar-message" hidden></p>
            </section>
            <section class="team-directory" aria-labelledby="team-directory-heading">
                <h2 class="team-directory__title" id="team-directory-heading">Team members</h2>
                <div class="table-container">
                    <table class="team-table team-table--simple">
                        <thead>
                            <tr>
                                <th scope="col">ID</th>
                                <th scope="col">Reg No</th>
                                <th scope="col">Image</th>
                                <th scope="col">Name</th>
                                <th scope="col">Nickname</th>
                                <th scope="col">EPF</th>
                                <th scope="col">Position</th>
                                <th scope="col">Pay category</th>
                                <th scope="col">Join date</th>
                                <th scope="col">Status</th>
                                <th scope="col">Created at</th>
                                <th scope="col">Updated at</th>
                                <th scope="col">Personal detail</th>
                                <th scope="col">Assignments</th>
                                <th scope="col">Training records</th>
                                <th scope="col">Employment log</th>
                                <th scope="col">Files</th>
                                <th scope="col">Assets</th>
                                <th scope="col" id="team-update-column-header">Update</th>
                            </tr>
                        </thead>
                        <tbody id="team-table-body"></tbody>
                    </table>
                </div>
                <p class="team-directory__empty" id="team-empty-state" hidden>
                    No team members available yet.
                </p>
                <section class="team-form" id="team-form-section">
                    <h3 class="team-form__title">Register a team member</h3>
                    <p class="team-form__description">
                        Keep the roster current by logging new colleagues as soon as they join the team.
                    </p>
                    <p class="team-form__editing" id="team-form-editing" hidden>
                        Editing <strong id="team-form-editing-name"></strong>
                        <button type="button" class="button button--ghost button--small" id="team-form-cancel-edit">
                            Cancel
                        </button>
                    </p>
                    <div class="team-form__feedback">
                        <p class="alert alert--error" id="team-form-error" hidden></p>
                        <p class="alert alert--success" id="team-form-success" hidden></p>
                    </div>
                    <form class="edit-form" id="team-form">
                        <div class="edit-form__grid">
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-reg-number">
                                    Registration number <span class="required">*</span>
                                </label>
                                <input
                                    class="edit-form__input"
                                    id="team-reg-number"
                                    name="regNumber"
                                    type="text"
                                    autocomplete="off"
                                    required
                                />
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-name">
                                    Name <span class="required">*</span>
                                </label>
                                <input
                                    class="edit-form__input"
                                    id="team-name"
                                    name="name"
                                    type="text"
                                    autocomplete="name"
                                    required
                                />
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-nickname">Nickname</label>
                                <input
                                    class="edit-form__input"
                                    id="team-nickname"
                                    name="nickname"
                                    type="text"
                                    autocomplete="off"
                                />
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-epf">EPF number</label>
                                <input
                                    class="edit-form__input"
                                    id="team-epf"
                                    name="epf"
                                    type="text"
                                    autocomplete="off"
                                />
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-position">Position</label>
                                <input
                                    class="edit-form__input"
                                    id="team-position"
                                    name="position"
                                    type="text"
                                    autocomplete="organization-title"
                                />
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-pay-category">Pay category</label>
                                <select class="edit-form__input" id="team-pay-category" name="payCategory">
                                    <option value="Office" selected>Office</option>
                                    <option value="Factory">Factory</option>
                                    <option value="Casual">Casual</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-join-date">Date of join</label>
                                <input
                                    class="edit-form__input"
                                    id="team-join-date"
                                    name="joinDate"
                                    type="date"
                                />
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-status">Status</label>
                                <select class="edit-form__input" id="team-status" name="status">
                                    <option value="Active" selected>Active</option>
                                    <option value="On Leave">On Leave</option>
                                    <option value="Inactive">Inactive</option>
                                </select>
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-image">Profile image URL</label>
                                <input
                                    class="edit-form__input"
                                    id="team-image"
                                    name="image"
                                    type="url"
                                    inputmode="url"
                                    placeholder="https://example.com/profile.jpg"
                                />
                            </div>
                            <div class="edit-form__field edit-form__field--full">
                                <label class="edit-form__label" for="team-personal-detail">Personal detail</label>
                                <div class="team-form__bank-actions">
                                    <button
                                        type="button"
                                        class="button button--primary button--small"
                                        id="team-bank-detail-button"
                                    >
                                        Personal Detail
                                    </button>
                                    <p
                                        class="team-form__bank-summary team-form__bank-summary--empty"
                                        id="team-bank-detail-summary"
                                    >
                                        No personal detail added yet.
                                    </p>
                                </div>
                                <input type="hidden" id="team-bank-account-name" name="bankAccountName" />
                                <input type="hidden" id="team-bank-name" name="bankName" />
                                <input type="hidden" id="team-branch-name" name="branchName" />
                                <input type="hidden" id="team-bank-account-number" name="bankAccountNumber" />
                                <textarea
                                    class="edit-form__input"
                                    id="team-personal-detail"
                                    name="personalDetail"
                                    rows="3"
                                ></textarea>
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-assignments">Assignments</label>
                                <textarea
                                    class="edit-form__input"
                                    id="team-assignments"
                                    name="assignments"
                                    rows="3"
                                ></textarea>
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-training">Training records</label>
                                <textarea
                                    class="edit-form__input"
                                    id="team-training"
                                    name="trainingRecords"
                                    rows="3"
                                ></textarea>
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-employment-log">Employment log</label>
                                <textarea
                                    class="edit-form__input"
                                    id="team-employment-log"
                                    name="employmentLog"
                                    rows="3"
                                ></textarea>
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-files">Files</label>
                                <textarea
                                    class="edit-form__input"
                                    id="team-files"
                                    name="files"
                                    rows="3"
                                ></textarea>
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-assets">Controlled assets</label>
                                <textarea
                                    class="edit-form__input"
                                    id="team-assets"
                                    name="assets"
                                    rows="3"
                                ></textarea>
                            </div>
                        </div>
                        <div class="edit-form__actions">
                            <button type="submit" class="button button--primary team-form__submit">Save member</button>
                            <button type="button" class="button button--ghost team-form__cancel" id="team-form-cancel-edit-footer" hidden>
                                Cancel edit
                            </button>
                        </div>
                    </form>
                </section>
                <section class="salary-section" aria-labelledby="salary-section-heading">
                    <div class="salary-section__header">
                        <h3 class="salary-section__title" id="salary-section-heading">Salary sheet</h3>
                        <p class="salary-section__description">
                            Record and review the monthly salary breakdown for every active employee.
                        </p>
                    </div>
                    <div class="salary-section__controls">
                        <label class="salary-section__month" for="salary-month-selector">
                            Salary month
                            <input
                                class="salary-section__month-input edit-form__input"
                                type="month"
                                id="salary-month-selector"
                                name="salaryMonth"
                            />
                        </label>
                    </div>
                    <div class="table-container">
                        <table class="team-table salary-table">
                            <thead>
                                <tr>
                                    <th scope="col">Reg No</th>
                                    <th scope="col">Name</th>
                                    <th scope="col">Basic Salary</th>
                                    <th scope="col">Day Salary</th>
                                    <th scope="col">General Allowance</th>
                                    <th scope="col">Transport Allowance</th>
                                    <th scope="col">Attendance Allowance</th>
                                    <th scope="col">Special Allowance</th>
                                    <th scope="col">Performance Bonus</th>
                                    <th scope="col">Total Day Salary</th>
                                    <th scope="col">Target Allowance</th>
                                    <th scope="col">Overtime</th>
                                    <th scope="col">Gross Salary</th>
                                    <th scope="col">Provident Fund</th>
                                    <th scope="col">Other Deduction</th>
                                    <th scope="col">Salary Advance</th>
                                    <th scope="col">No Pay</th>
                                    <th scope="col">Total Deduction</th>
                                    <th scope="col">Net Pay</th>
                                    <th scope="col">Record Attendance</th>
                                    <th scope="col">Manage Salary</th>
                                </tr>
                            </thead>
                            <tbody id="salary-table-body"></tbody>
                        </table>
                    </div>
                    <p class="salary-section__empty" id="salary-empty-state" hidden>
                        No active team members available for the selected month.
                    </p>
                </section>
            </section>
        </section>
    </div>
    <div class="modal" id="workday-modal" hidden aria-hidden="true">
        <div class="modal__overlay" data-modal-dismiss></div>
        <div class="modal__content" role="dialog" aria-modal="true" aria-labelledby="workday-modal-title">
            <header class="modal__header">
                <h2 class="modal__title" id="workday-modal-title">Update work day</h2>
                <button type="button" class="modal__close" id="workday-modal-close" aria-label="Close work day editor">
                    &times;
                </button>
            </header>
            <div class="modal__body">
                <form class="edit-form workday-form" id="workday-form">
                    <p class="workday-form__date" id="workday-form-date">—</p>
                    <fieldset class="workday-form__field-group">
                        <legend class="workday-form__label">Work status</legend>
                        <div class="workday-form__options">
                            <label class="workday-form__option">
                                <input type="radio" name="isWorkDay" value="true" id="workday-status-work" checked />
                                <span>Work day</span>
                            </label>
                            <label class="workday-form__option">
                                <input type="radio" name="isWorkDay" value="false" id="workday-status-off" />
                                <span>Not work day</span>
                            </label>
                        </div>
                    </fieldset>
                    <div class="edit-form__field">
                        <label class="edit-form__label" for="workday-holiday">Holiday name</label>
                        <input
                            class="edit-form__input"
                            id="workday-holiday"
                            name="holidayName"
                            type="text"
                            maxlength="120"
                            autocomplete="off"
                            placeholder="Enter holiday name"
                            disabled
                        />
                    </div>
                    <p class="workday-form__hint" id="workday-form-hint">
                        Holiday name is optional and only applies to non-working days.
                    </p>
                    <p class="workday-form__error" id="workday-form-error" hidden></p>
                    <div class="modal__actions">
                        <button type="button" class="button button--ghost" id="workday-modal-cancel">Cancel</button>
                        <button type="submit" class="button button--primary" id="workday-modal-save">Save day</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal" id="attendance-modal" hidden aria-hidden="true">
        <div class="modal__overlay" data-modal-dismiss></div>
        <div
            class="modal__content"
            role="dialog"
            aria-modal="true"
            aria-labelledby="attendance-modal-title"
        >
            <header class="modal__header">
                <h2 class="modal__title" id="attendance-modal-title">Record attendance</h2>
                <button
                    type="button"
                    class="modal__close"
                    id="attendance-modal-close"
                    aria-label="Close attendance form"
                >
                    &times;
                </button>
            </header>
            <div class="modal__body">
                <form class="attendance-form" id="attendance-form">
                    <div class="attendance-form__summary salary-form__summary">
                        <p class="attendance-form__summary-item salary-form__summary-item">
                            <span class="attendance-form__summary-label salary-form__summary-label">Employee</span>
                            <span
                                class="attendance-form__summary-value salary-form__summary-value"
                                id="attendance-form-member-name"
                            >
                                —
                            </span>
                        </p>
                        <p class="attendance-form__summary-item salary-form__summary-item">
                            <span class="attendance-form__summary-label salary-form__summary-label">Reg No</span>
                            <span
                                class="attendance-form__summary-value salary-form__summary-value"
                                id="attendance-form-regno"
                            >
                                —
                            </span>
                        </p>
                        <p class="attendance-form__summary-item salary-form__summary-item">
                            <span class="attendance-form__summary-label salary-form__summary-label">Month</span>
                            <span
                                class="attendance-form__summary-value salary-form__summary-value"
                                id="attendance-summary-month"
                            >
                                —
                            </span>
                        </p>
                        <div class="attendance-summary__cards">
                            <div class="attendance-summary__totals">
                                <span class="attendance-summary__totals-label">Total Pay Hours</span>
                                <span class="attendance-summary__totals-main" id="attendance-total-pay-hours"
                                    >00:00</span
                                >
                                <div class="attendance-summary__totals-detail">
                                    <span class="attendance-summary__totals-sub-label">Regular Hours</span>
                                    <span
                                        class="attendance-summary__totals-sub-value"
                                        id="attendance-total-regular-hours"
                                    >00:00</span>
                                </div>
                                <div class="attendance-summary__totals-detail">
                                    <span class="attendance-summary__totals-sub-label">OT Hours</span>
                                    <span
                                        class="attendance-summary__totals-sub-value"
                                        id="attendance-total-ot-hours"
                                    >00:00</span>
                                </div>
                            </div>
                            <div class="attendance-summary__leave" aria-live="polite">
                                <h3 class="attendance-summary__leave-title">Leave summary</h3>
                                <dl class="attendance-summary__leave-list">
                                    <div class="attendance-summary__leave-item">
                                        <dt class="attendance-summary__leave-term">Workdays (month)</dt>
                                        <dd
                                            class="attendance-summary__leave-value"
                                            id="attendance-leave-workdays"
                                        >—</dd>
                                    </div>
                                    <div class="attendance-summary__leave-item">
                                        <dt class="attendance-summary__leave-term">No-pay days (month)</dt>
                                        <dd
                                            class="attendance-summary__leave-value"
                                            id="attendance-leave-nopay"
                                        >—</dd>
                                    </div>
                                    <div class="attendance-summary__leave-item">
                                        <dt class="attendance-summary__leave-term">Annual Leave B/F</dt>
                                        <dd
                                            class="attendance-summary__leave-value"
                                            id="attendance-leave-annual-bf"
                                        >—</dd>
                                    </div>
                                    <div class="attendance-summary__leave-item">
                                        <dt class="attendance-summary__leave-term">Annual Leave (This Month)</dt>
                                        <dd
                                            class="attendance-summary__leave-value"
                                            id="attendance-leave-annual-this"
                                        >—</dd>
                                    </div>
                                    <div class="attendance-summary__leave-item">
                                        <dt class="attendance-summary__leave-term">Annual Leave Balance</dt>
                                        <dd
                                            class="attendance-summary__leave-value"
                                            id="attendance-leave-annual-balance"
                                        >—</dd>
                                    </div>
                                    <div class="attendance-summary__leave-item">
                                        <dt class="attendance-summary__leave-term">Medical Leave B/F</dt>
                                        <dd
                                            class="attendance-summary__leave-value"
                                            id="attendance-leave-medical-bf"
                                        >—</dd>
                                    </div>
                                    <div class="attendance-summary__leave-item">
                                        <dt class="attendance-summary__leave-term">Medical Leave (This Month)</dt>
                                        <dd
                                            class="attendance-summary__leave-value"
                                            id="attendance-leave-medical-this"
                                        >—</dd>
                                    </div>
                                    <div class="attendance-summary__leave-item">
                                        <dt class="attendance-summary__leave-term">Medical Leave Balance</dt>
                                        <dd
                                            class="attendance-summary__leave-value"
                                            id="attendance-leave-medical-balance"
                                        >—</dd>
                                    </div>
                                </dl>
                            </div>
                        </div>
                    </div>
                    <div class="table-container attendance-table-container">
                        <table class="team-table attendance-table">
                            <thead>
                                <tr>
                                    <th scope="col">Date</th>
                                    <th scope="col">On time</th>
                                    <th scope="col">Off time</th>
                                    <th scope="col">Actual hours</th>
                                    <th scope="col">Pay hours</th>
                                    <th scope="col">OT hours</th>
                                    <th scope="col">Day Status</th>
                                </tr>
                            </thead>
                            <tbody id="attendance-table-body"></tbody>
                        </table>
                    </div>
                    <div class="modal__actions">
                        <button
                            type="button"
                            class="button button--ghost"
                            id="attendance-modal-cancel"
                        >
                            Cancel
                        </button>
                        <button type="submit" class="button button--primary">Save attendance</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal" id="salary-modal" hidden aria-hidden="true">
        <div class="modal__overlay" data-modal-dismiss></div>
        <div class="modal__content" role="dialog" aria-modal="true" aria-labelledby="salary-modal-title">
            <header class="modal__header">
                <h2 class="modal__title" id="salary-modal-title">Update salary</h2>
                <button type="button" class="modal__close" id="salary-modal-close" aria-label="Close salary form">
                    &times;
                </button>
            </header>
            <div class="modal__body">
                <form class="edit-form salary-form" id="salary-form">
                    <div class="salary-form__summary">
                        <p class="salary-form__summary-item">
                            <span class="salary-form__summary-label">Employee</span>
                            <span class="salary-form__summary-value" id="salary-form-member-name">—</span>
                        </p>
                        <p class="salary-form__summary-item">
                            <span class="salary-form__summary-label">Reg No</span>
                            <span class="salary-form__summary-value" id="salary-form-regno">—</span>
                        </p>
                    </div>
                    <div class="edit-form__grid salary-form__grid">
                        <div class="edit-form__field edit-form__field--full">
                            <label class="edit-form__label" for="salary-form-month">Salary month</label>
                            <input
                                class="edit-form__input"
                                type="month"
                                id="salary-form-month"
                                name="salaryMonth"
                                required
                            />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-basic-salary">Basic salary</label>
                            <input class="edit-form__input" type="number" step="0.01" id="salary-basic-salary" name="basicSalary" />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-day-salary">Day salary</label>
                            <input class="edit-form__input" type="number" step="0.01" id="salary-day-salary" name="daySalary" />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-general-allowance">General allowance</label>
                            <input
                                class="edit-form__input"
                                type="number"
                                step="0.01"
                                id="salary-general-allowance"
                                name="generalAllowance"
                            />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-transport-allowance">Transport allowance</label>
                            <input
                                class="edit-form__input"
                                type="number"
                                step="0.01"
                                id="salary-transport-allowance"
                                name="transportAllowance"
                            />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-attendance-allowance">Attendance allowance</label>
                            <input
                                class="edit-form__input"
                                type="number"
                                step="0.01"
                                id="salary-attendance-allowance"
                                name="attendanceAllowance"
                            />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-special-allowance">Special allowance</label>
                            <input
                                class="edit-form__input"
                                type="number"
                                step="0.01"
                                id="salary-special-allowance"
                                name="specialAllowance"
                            />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-performance-bonus">Performance bonus</label>
                            <input
                                class="edit-form__input"
                                type="number"
                                step="0.01"
                                id="salary-performance-bonus"
                                name="performanceBonus"
                            />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-production">Total Day Salary</label>
                            <input class="edit-form__input" type="number" step="0.01" id="salary-production" name="production" />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-target-allowance">Target allowance</label>
                            <input
                                class="edit-form__input"
                                type="number"
                                step="0.01"
                                id="salary-target-allowance"
                                name="targetAllowance"
                            />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-overtime">Overtime</label>
                            <input class="edit-form__input" type="number" step="0.01" id="salary-overtime" name="overtime" />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-casual-ot-rate">Casual OT Rate</label>
                            <input
                                class="edit-form__input"
                                type="number"
                                step="0.01"
                                id="salary-casual-ot-rate"
                                name="casualOtRate"
                                placeholder="Enter Casual OT Rate"
                            />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-gross-salary">Gross salary</label>
                            <input class="edit-form__input" type="number" step="0.01" id="salary-gross-salary" name="grossSalary" />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-provident-fund">Provident fund</label>
                            <input
                                class="edit-form__input"
                                type="number"
                                step="0.01"
                                id="salary-provident-fund"
                                name="providentFund"
                            />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-other-deduction">Other deduction</label>
                            <input
                                class="edit-form__input"
                                type="number"
                                step="0.01"
                                id="salary-other-deduction"
                                name="otherDeduction"
                            />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-salary-advance">Salary advance</label>
                            <input
                                class="edit-form__input"
                                type="number"
                                step="0.01"
                                id="salary-salary-advance"
                                name="salaryAdvance"
                            />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-no-pay">No pay</label>
                            <input class="edit-form__input" type="number" step="0.01" id="salary-no-pay" name="noPay" />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-total-deduction">Total deduction</label>
                            <input
                                class="edit-form__input"
                                type="number"
                                step="0.01"
                                id="salary-total-deduction"
                                name="totalDeduction"
                            />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-net-pay">Net pay</label>
                            <input class="edit-form__input" type="number" step="0.01" id="salary-net-pay" name="netPay" />
                        </div>
                    </div>
                    <div class="modal__actions">
                        <button type="button" class="button button--ghost" id="salary-modal-cancel">Cancel</button>
                        <button type="submit" class="button button--primary">Save salary</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal" id="bank-detail-modal" hidden aria-hidden="true">
        <div class="modal__overlay" data-modal-dismiss></div>
        <div
            class="modal__content"
            role="dialog"
            aria-modal="true"
            aria-labelledby="bank-detail-modal-title"
        >
            <header class="modal__header modal__header--with-actions">
                <h2 class="modal__title" id="bank-detail-modal-title">Personal detail</h2>
                <div class="modal__header-actions">
                    <button
                        type="button"
                        class="button button--ghost button--small"
                        id="bank-detail-edit-toggle"
                        hidden
                    >
                        Edit
                    </button>
                    <button
                        type="button"
                        class="modal__close"
                        id="bank-detail-modal-close"
                        aria-label="Close personal detail editor"
                    >
                        &times;
                    </button>
                </div>
            </header>
            <div class="modal__body">
                <form class="edit-form" id="bank-detail-form">
                    <p class="modal__hint" id="bank-detail-modal-hint"></p>
                    <p class="alert alert--error" id="bank-detail-error" hidden></p>
                    <p class="alert alert--success" id="bank-detail-success" hidden></p>
                    <div class="edit-form__grid">
                        <div class="edit-form__field edit-form__field--full">
                            <label class="edit-form__label" for="bank-detail-account-name">Bank account name</label>
                            <input
                                class="edit-form__input"
                                id="bank-detail-account-name"
                                name="bankAccountName"
                                type="text"
                                autocomplete="off"
                            />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="bank-detail-bank-name">Bank name</label>
                            <input
                                class="edit-form__input"
                                id="bank-detail-bank-name"
                                name="bankName"
                                type="text"
                                autocomplete="off"
                            />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="bank-detail-branch-name">Branch name</label>
                            <input
                                class="edit-form__input"
                                id="bank-detail-branch-name"
                                name="branchName"
                                type="text"
                                autocomplete="off"
                            />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="bank-detail-account-number">Bank account number</label>
                            <input
                                class="edit-form__input"
                                id="bank-detail-account-number"
                                name="bankAccountNumber"
                                type="text"
                                inputmode="numeric"
                                autocomplete="off"
                            />
                        </div>
                    </div>
                    <div class="modal__actions">
                        <button type="button" class="button button--ghost" id="bank-detail-modal-cancel">Cancel</button>
                        <button type="submit" class="button button--primary" id="bank-detail-save-button">
                            Save details
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        const token = localStorage.getItem("samprox_token");
        const userRaw = localStorage.getItem("samprox_user");
        let user;

        try {
            user = userRaw ? JSON.parse(userRaw) : null;
        } catch (_) {
            user = null;
        }

        if (!token || !user) {
            window.location.href = "/";
        }

        const roleLabels = {
            admin: "Admin",
            production_manager: "Production Manager",
            maintenance_manager: "Maintenance Manager",
            technician: "Technician",
        };

        const userNameEl = document.getElementById("user-name");
        const userRoleEl = document.getElementById("user-role");
        const logoutButton = document.getElementById("logout");

        userNameEl.textContent = user?.name || "Unknown";
        userRoleEl.textContent = roleLabels[user?.role] || "";

        logoutButton.addEventListener("click", () => {
            localStorage.removeItem("samprox_token");
            localStorage.removeItem("samprox_user");
            window.location.href = "/";
        });

        const authHeaders = {
            Accept: "application/json",
            ...(token ? { Authorization: `Bearer ${token}` } : {}),
        };

        // =====================
        // Helpers: normalize date & status for API
        // =====================
        function toYyyyMmDd(input) {
            if (!input) return null;
            const d = new Date(input);
            if (!isNaN(d.getTime())) return d.toISOString().slice(0, 10);
            const mdy = /^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/.exec(String(input).trim());
            if (mdy) {
                const [, m, dd, y] = mdy;
                return `${y}-${String(m).padStart(2, "0")}-${String(dd).padStart(2, "0")}`;
            }
            const ymd = /^(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})$/.exec(String(input).trim());
            if (ymd) {
                const [, y, m, dd] = ymd;
                return `${y}-${String(m).padStart(2, "0")}-${String(dd).padStart(2, "0")}`;
            }
            return null;
        }

        function normalizeStatus(value) {
            if (!value) return "Active";
            const map = {
                "active": "Active",
                "inactive": "Inactive",
                "on leave": "On Leave",
                "on_leave": "On Leave",
                "on-leave": "On Leave",
            };
            return map[String(value).trim().toLowerCase()] ?? "Active";
        }

        const tableBody = document.getElementById("team-table-body");
        const emptyState = document.getElementById("team-empty-state");
        const formSection = document.getElementById("team-form-section");
        const teamForm = document.getElementById("team-form");
        const teamFormError = document.getElementById("team-form-error");
        const teamFormSuccess = document.getElementById("team-form-success");
        const teamFormSubmitButton = teamForm?.querySelector(".team-form__submit");
        const teamFormEditingBanner = document.getElementById("team-form-editing");
        const teamFormEditingName = document.getElementById("team-form-editing-name");
        const teamFormCancelEditBanner = document.getElementById("team-form-cancel-edit");
        const teamFormCancelEditFooter = document.getElementById(
            "team-form-cancel-edit-footer"
        );
        const updateColumnHeader = document.getElementById(
            "team-update-column-header"
        );
        const regNumberInput = document.getElementById("team-reg-number");
        const joinDateInput = document.getElementById("team-join-date");
        const payCategorySelect = document.getElementById("team-pay-category");
        const statusSelect = document.getElementById("team-status");
        const nameInput = document.getElementById("team-name");
        const nicknameInput = document.getElementById("team-nickname");
        const epfInput = document.getElementById("team-epf");
        const positionInput = document.getElementById("team-position");
        const imageInput = document.getElementById("team-image");
        const personalDetailInput = document.getElementById("team-personal-detail");
        const bankDetailButton = document.getElementById("team-bank-detail-button");
        const bankDetailSummary = document.getElementById("team-bank-detail-summary");
        const bankAccountNameHidden = document.getElementById("team-bank-account-name");
        const bankNameHidden = document.getElementById("team-bank-name");
        const branchNameHidden = document.getElementById("team-branch-name");
        const bankAccountNumberHidden = document.getElementById("team-bank-account-number");
        const assignmentsInput = document.getElementById("team-assignments");
        const trainingInput = document.getElementById("team-training");
        const employmentLogInput = document.getElementById("team-employment-log");
        const filesInput = document.getElementById("team-files");
        const assetsInput = document.getElementById("team-assets");
        const bankDetailModal = document.getElementById("bank-detail-modal");
        const bankDetailModalClose = document.getElementById("bank-detail-modal-close");
        const bankDetailModalCancel = document.getElementById("bank-detail-modal-cancel");
        const bankDetailEditToggle = document.getElementById("bank-detail-edit-toggle");
        const bankDetailForm = document.getElementById("bank-detail-form");
        const bankDetailError = document.getElementById("bank-detail-error");
        const bankDetailSuccess = document.getElementById("bank-detail-success");
        const bankDetailHint = document.getElementById("bank-detail-modal-hint");
        const bankDetailSaveButton = document.getElementById("bank-detail-save-button");
        const bankDetailAccountNameInput = document.getElementById("bank-detail-account-name");
        const bankDetailBankNameInput = document.getElementById("bank-detail-bank-name");
        const bankDetailBranchNameInput = document.getElementById("bank-detail-branch-name");
        const bankDetailAccountNumberInput = document.getElementById("bank-detail-account-number");
        const bankDetailFieldInputs = {
            bankAccountName: bankDetailAccountNameInput,
            bankName: bankDetailBankNameInput,
            branchName: bankDetailBranchNameInput,
            bankAccountNumber: bankDetailAccountNumberInput,
        };
        const salaryTableBody = document.getElementById("salary-table-body");
        const salaryEmptyState = document.getElementById("salary-empty-state");
        const salaryMonthSelector = document.getElementById("salary-month-selector");
        const attendanceModal = document.getElementById("attendance-modal");
        const attendanceModalClose = document.getElementById("attendance-modal-close");
        const attendanceModalCancel = document.getElementById("attendance-modal-cancel");
        const attendanceForm = document.getElementById("attendance-form");
        const attendanceTableBody = document.getElementById("attendance-table-body");
        const attendanceFormMemberName = document.getElementById("attendance-form-member-name");
        const attendanceFormRegno = document.getElementById("attendance-form-regno");
        const attendanceSummaryMonth = document.getElementById("attendance-summary-month");
        const attendanceTotalPayHours = document.getElementById("attendance-total-pay-hours");
        const attendanceTotalRegularHours = document.getElementById(
            "attendance-total-regular-hours",
        );
        const attendanceTotalOvertimeHours = document.getElementById("attendance-total-ot-hours");
        const attendanceLeaveElements = {
            workDays: document.getElementById("attendance-leave-workdays"),
            noPayDays: document.getElementById("attendance-leave-nopay"),
            annualBroughtForward: document.getElementById("attendance-leave-annual-bf"),
            annualThisMonth: document.getElementById("attendance-leave-annual-this"),
            annualBalance: document.getElementById("attendance-leave-annual-balance"),
            medicalBroughtForward: document.getElementById("attendance-leave-medical-bf"),
            medicalThisMonth: document.getElementById("attendance-leave-medical-this"),
            medicalBalance: document.getElementById("attendance-leave-medical-balance"),
        };
        const salaryModal = document.getElementById("salary-modal");
        const salaryModalTitle = document.getElementById("salary-modal-title");
        const salaryModalClose = document.getElementById("salary-modal-close");
        const salaryModalCancel = document.getElementById("salary-modal-cancel");
        const salaryForm = document.getElementById("salary-form");
        const salaryFormMonth = document.getElementById("salary-form-month");
        const salaryFormMemberName = document.getElementById("salary-form-member-name");
        const salaryFormRegno = document.getElementById("salary-form-regno");
        const workCalendarYearSelect = document.getElementById("work-calendar-year");
        const workCalendarMonthSelect = document.getElementById("work-calendar-month");
        const workCalendarGrid = document.getElementById("work-calendar-grid");
        const workCalendarLoading = document.getElementById("work-calendar-loading");
        const workCalendarMessage = document.getElementById("work-calendar-message");
        const workdayModal = document.getElementById("workday-modal");
        const workdayModalClose = document.getElementById("workday-modal-close");
        const workdayModalCancel = document.getElementById("workday-modal-cancel");
        const workdayForm = document.getElementById("workday-form");
        const workdayDateDisplay = document.getElementById("workday-form-date");
        const workdayStatusWork = document.getElementById("workday-status-work");
        const workdayStatusOff = document.getElementById("workday-status-off");
        const workdayHolidayInput = document.getElementById("workday-holiday");
        const workdayFormError = document.getElementById("workday-form-error");
        const workdayModalSave = document.getElementById("workday-modal-save");

        const canManageMembers = ["admin", "production_manager"].includes(user?.role);

        if (!canManageMembers && formSection) {
            formSection.hidden = true;
        }

        if (!canManageMembers && updateColumnHeader) {
            updateColumnHeader.remove();
        }

        const salaryFieldDefinitions = [
            { name: "basicSalary", label: "Basic Salary" },
            { name: "daySalary", label: "Day Salary" },
            { name: "generalAllowance", label: "General Allowance" },
            { name: "transportAllowance", label: "Transport Allowance" },
            { name: "attendanceAllowance", label: "Attendance Allowance" },
            { name: "specialAllowance", label: "Special Allowance" },
            { name: "performanceBonus", label: "Performance Bonus" },
            { name: "production", label: "Total Day Salary" },
            { name: "targetAllowance", label: "Target Allowance" },
            { name: "overtime", label: "Overtime" },
            { name: "grossSalary", label: "Gross Salary" },
            { name: "providentFund", label: "Provident Fund" },
            { name: "otherDeduction", label: "Other Deduction" },
            { name: "salaryAdvance", label: "Salary Advance" },
            { name: "noPay", label: "No Pay" },
            { name: "totalDeduction", label: "Total Deduction" },
            { name: "netPay", label: "Net Pay" },
        ];

        const salaryDataStore = Object.create(null);
        const casualOtRateStore = Object.create(null);
        const attendanceDataStore = Object.create(null);
        const computedAttendanceAllowanceStore = Object.create(null);
        const computedTargetAllowanceStore = Object.create(null);
        const attendanceLeaveSummaryStore = Object.create(null);
        const workCalendarStore = new Map();
        const memberKeyById = new Map();
        let activeMembers = [];
        let editingMemberId = null;
        let salaryModalContext = null;
        let attendanceModalContext = null;
        let bankDetailModalState = null;
        let workdayModalContext = null;
        let workCalendarState = { year: null, month: null, loading: false };

        const WORK_CALENDAR_WEEKDAY_INDEX = {
            Mon: 0,
            Tue: 1,
            Wed: 2,
            Thu: 3,
            Fri: 4,
            Sat: 5,
            Sun: 6,
        };

        const numberFormatter = new Intl.NumberFormat(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
        });
        const TIME_24_HOUR_PATTERN = /^(\d{1,2}):([0-5]\d)$/;
        const TIME_12_HOUR_PATTERN = /^(\d{1,2}):([0-5]\d)\s*(AM|PM)$/i;
        const TIME_COMPACT_PATTERN = /^(\d{1,2})([0-5]\d)$/;
        const attendanceDateFormatter = new Intl.DateTimeFormat(undefined, {
            year: "numeric",
            month: "short",
            day: "2-digit",
        });
        const attendanceMonthFormatter = new Intl.DateTimeFormat(undefined, {
            year: "numeric",
            month: "long",
        });
        const COLOMBO_TIME_ZONE = "Asia/Colombo";
        const workCalendarDateFormatter = new Intl.DateTimeFormat(undefined, {
            timeZone: COLOMBO_TIME_ZONE,
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
        });
        const workCalendarTodayFormatter = new Intl.DateTimeFormat("en-CA", {
            timeZone: COLOMBO_TIME_ZONE,
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
        });
        const workCalendarWeekdayFormatter = new Intl.DateTimeFormat("en-GB", {
            timeZone: COLOMBO_TIME_ZONE,
            weekday: "short",
        });
        const WORK_CALENDAR_MONTH_NAMES = Array.from({ length: 12 }, (_, index) =>
            new Date(Date.UTC(2000, index, 1)).toLocaleString(undefined, { month: "long" })
        );

        const getInitialSalaryMonth = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, "0");
            return `${year}-${month}`;
        };

        const normalizeMonthValue = (value) => {
            if (typeof value !== "string") {
                return "";
            }
            const trimmed = value.trim();
            const match = /^(\d{4})-(\d{2})$/.exec(trimmed);
            if (!match) {
                return "";
            }
            const month = Number(match[2]);
            if (Number.isNaN(month) || month < 1 || month > 12) {
                return "";
            }
            return `${match[1]}-${String(month).padStart(2, "0")}`;
        };

        const formatIsoDate = (year, month, day) =>
            `${String(year).padStart(4, "0")}-${String(month).padStart(2, "0")}-${String(day).padStart(2, "0")}`;

        const parseIsoDate = (value) => {
            if (typeof value !== "string") {
                return null;
            }
            const match = /^(\d{4})-(\d{2})-(\d{2})$/.exec(value.trim());
            if (!match) {
                return null;
            }
            const year = Number(match[1]);
            const month = Number(match[2]);
            const day = Number(match[3]);
            if (
                !Number.isFinite(year) ||
                !Number.isFinite(month) ||
                !Number.isFinite(day) ||
                month < 1 ||
                month > 12 ||
                day < 1 ||
                day > 31
            ) {
                return null;
            }
            return { year, month, day };
        };

        const getMonthKey = (year, month) => `${year}-${String(month).padStart(2, "0")}`;

        const getTodayIso = () => {
            const parts = workCalendarTodayFormatter.formatToParts(new Date());
            const lookup = Object.create(null);
            for (const part of parts) {
                lookup[part.type] = part.value;
            }
            if (!lookup.year || !lookup.month || !lookup.day) {
                return "";
            }
            return `${lookup.year}-${lookup.month}-${lookup.day}`;
        };

        const getWeekdayIndex = (year, month, day) => {
            const date = new Date(Date.UTC(year, month - 1, day));
            const label = workCalendarWeekdayFormatter.format(date);
            return WORK_CALENDAR_WEEKDAY_INDEX[label] ?? 0;
        };

        const buildCalendarCells = (year, month) => {
            const monthIndex = month - 1;
            const firstDayIndex = getWeekdayIndex(year, month, 1);
            const cells = [];

            const previousMonthDate = new Date(Date.UTC(year, monthIndex, 0));
            const previousMonthDays = previousMonthDate.getUTCDate();
            const previousMonthYear = previousMonthDate.getUTCFullYear();
            const previousMonthIndex = previousMonthDate.getUTCMonth();

            for (let offset = firstDayIndex - 1; offset >= 0; offset -= 1) {
                const dayNumber = previousMonthDays - offset;
                const iso = formatIsoDate(
                    previousMonthYear,
                    previousMonthIndex + 1,
                    dayNumber,
                );
                cells.push({
                    iso,
                    dayNumber,
                    year: previousMonthYear,
                    month: previousMonthIndex + 1,
                    inCurrentMonth: false,
                });
            }

            const daysInMonth = new Date(Date.UTC(year, monthIndex + 1, 0)).getUTCDate();
            for (let day = 1; day <= daysInMonth; day += 1) {
                const iso = formatIsoDate(year, month, day);
                cells.push({
                    iso,
                    dayNumber: day,
                    year,
                    month,
                    inCurrentMonth: true,
                });
            }

            const totalCells = 42;
            let nextDate = new Date(Date.UTC(year, monthIndex + 1, 1));
            while (cells.length < totalCells) {
                const nextYear = nextDate.getUTCFullYear();
                const nextMonth = nextDate.getUTCMonth() + 1;
                const nextDay = nextDate.getUTCDate();
                cells.push({
                    iso: formatIsoDate(nextYear, nextMonth, nextDay),
                    dayNumber: nextDay,
                    year: nextYear,
                    month: nextMonth,
                    inCurrentMonth: false,
                });
                nextDate.setUTCDate(nextDate.getUTCDate() + 1);
            }

            return cells;
        };

        const createColomboDate = (iso) => new Date(`${iso}T00:00:00+05:30`);

        const truncateHolidayName = (value) => {
            if (typeof value !== "string") {
                return "";
            }
            const trimmed = value.trim();
            if (trimmed.length <= 28) {
                return trimmed;
            }
            return `${trimmed.slice(0, 27)}…`;
        };

        const setWorkCalendarLoading = (isLoading) => {
            workCalendarState = {
                ...workCalendarState,
                loading: Boolean(isLoading),
            };

            if (workCalendarLoading) {
                workCalendarLoading.hidden = !isLoading;
                workCalendarLoading.style.display = isLoading ? "flex" : "none";
            }
            if (workCalendarGrid) {
                workCalendarGrid.setAttribute("aria-busy", isLoading ? "true" : "false");
            }
            if (workCalendarYearSelect) {
                workCalendarYearSelect.disabled = isLoading;
            }
            if (workCalendarMonthSelect) {
                workCalendarMonthSelect.disabled = isLoading;
            }
        };

        const showWorkCalendarMessage = (message, tone = "info") => {
            if (!workCalendarMessage) {
                return;
            }
            workCalendarMessage.textContent = message;
            workCalendarMessage.hidden = false;
            workCalendarMessage.classList.remove(
                "work-calendar__message--error",
                "work-calendar__message--success",
            );
            if (tone === "error") {
                workCalendarMessage.classList.add("work-calendar__message--error");
            } else if (tone === "success") {
                workCalendarMessage.classList.add("work-calendar__message--success");
            }
        };

        const hideWorkCalendarMessage = () => {
            if (!workCalendarMessage) {
                return;
            }
            workCalendarMessage.hidden = true;
            workCalendarMessage.textContent = "";
            workCalendarMessage.classList.remove(
                "work-calendar__message--error",
                "work-calendar__message--success",
            );
        };

        const ensureWorkCalendarYearOptions = (activeYear) => {
            if (!workCalendarYearSelect) {
                return;
            }
            const baseYear = Number.isFinite(activeYear) ? activeYear : new Date().getFullYear();
            const years = [];
            for (let year = baseYear - 2; year <= baseYear + 2; year += 1) {
                years.push(year);
            }

            let requiresUpdate = workCalendarYearSelect.options.length !== years.length;
            if (!requiresUpdate) {
                requiresUpdate = years.some((year, index) => {
                    const option = workCalendarYearSelect.options[index];
                    return Number.parseInt(option.value, 10) !== year;
                });
            }

            if (requiresUpdate) {
                workCalendarYearSelect.innerHTML = "";
                years.forEach((year) => {
                    const option = document.createElement("option");
                    option.value = String(year);
                    option.textContent = String(year);
                    workCalendarYearSelect.appendChild(option);
                });
            }

            workCalendarYearSelect.value = String(activeYear);
        };

        const ensureWorkCalendarMonthOptions = (activeMonth) => {
            if (!workCalendarMonthSelect) {
                return;
            }
            if (workCalendarMonthSelect.options.length !== 12) {
                workCalendarMonthSelect.innerHTML = "";
                WORK_CALENDAR_MONTH_NAMES.forEach((name, index) => {
                    const option = document.createElement("option");
                    option.value = String(index + 1);
                    option.textContent = name;
                    workCalendarMonthSelect.appendChild(option);
                });
            }
            workCalendarMonthSelect.value = String(activeMonth);
        };

        const setWorkCalendarSelectors = (year, month) => {
            ensureWorkCalendarYearOptions(year);
            ensureWorkCalendarMonthOptions(month);
        };

        const getWorkCalendarMonthStore = (year, month) =>
            workCalendarStore.get(getMonthKey(year, month));

        const ensureWorkCalendarMonthData = async (year, month, { force = false } = {}) => {
            const key = getMonthKey(year, month);
            if (!force && workCalendarStore.has(key)) {
                return workCalendarStore.get(key);
            }

            setWorkCalendarLoading(true);

            try {
                const params = new URLSearchParams({
                    year: String(year),
                    month: String(month),
                });
                const response = await fetch(`/api/team/work-calendar?${params.toString()}`, {
                    headers: authHeaders,
                });

                let data = null;
                try {
                    data = await response.json();
                } catch (_error) {
                    data = null;
                }

                if (!response.ok) {
                    const message = data?.msg || "Unable to load the work calendar.";
                    throw new Error(message);
                }

                const map = new Map();
                if (data && Array.isArray(data.days)) {
                    data.days.forEach((item) => {
                        if (!item || typeof item.date !== "string") {
                            return;
                        }
                        map.set(item.date, {
                            isWorkDay: item.isWorkDay !== false,
                            holidayName:
                                typeof item.holidayName === "string" && item.holidayName
                                    ? item.holidayName
                                    : null,
                            updatedAt: item.updatedAt || null,
                        });
                    });
                }

                workCalendarStore.set(key, map);
                return map;
            } finally {
                setWorkCalendarLoading(false);
            }
        };

        const updateWorkCalendarStoreEntry = (iso, entry) => {
            const parts = parseIsoDate(iso);
            if (!parts) {
                return;
            }
            const key = getMonthKey(parts.year, parts.month);
            if (!workCalendarStore.has(key)) {
                workCalendarStore.set(key, new Map());
            }
            const store = workCalendarStore.get(key);

            if (!entry || (entry.isWorkDay !== false && !entry.holidayName)) {
                store.delete(iso);
            } else {
                store.set(iso, {
                    isWorkDay: entry.isWorkDay !== false,
                    holidayName: entry.holidayName ? String(entry.holidayName) : null,
                    updatedAt: entry.updatedAt || null,
                });
            }

            if (store.size === 0) {
                workCalendarStore.delete(key);
            }
        };

        const renderWorkCalendar = () => {
            if (!workCalendarGrid || !workCalendarState.year || !workCalendarState.month) {
                return;
            }

            const { year, month } = workCalendarState;
            const cells = buildCalendarCells(year, month);
            const monthStore = getWorkCalendarMonthStore(year, month);
            const todayIso = getTodayIso();

            workCalendarGrid.innerHTML = "";
            workCalendarGrid.dataset.month = getMonthKey(year, month);

            cells.forEach((cell) => {
                const button = document.createElement("button");
                button.type = "button";
                button.className = "work-calendar__day";
                button.dataset.date = cell.iso;

                if (!cell.inCurrentMonth) {
                    button.classList.add("work-calendar__day--muted");
                }

                const entry = monthStore?.get(cell.iso);
                const isWorkDay = entry ? entry.isWorkDay !== false : true;

                if (!isWorkDay) {
                    button.classList.add("work-calendar__day--off");
                }

                if (cell.iso === todayIso) {
                    button.classList.add("work-calendar__day--today");
                }

                const numberEl = document.createElement("span");
                numberEl.className = "work-calendar__day-number";
                numberEl.textContent = String(cell.dayNumber);
                button.appendChild(numberEl);

                const badge = document.createElement("span");
                badge.className = `work-calendar__badge ${
                    isWorkDay ? "work-calendar__badge--work" : "work-calendar__badge--off"
                }`;
                badge.textContent = isWorkDay ? "✅ Work day" : "❌ Not work day";
                button.appendChild(badge);

                if (!isWorkDay && entry?.holidayName) {
                    const holiday = document.createElement("span");
                    holiday.className = "work-calendar__holiday";
                    holiday.textContent = truncateHolidayName(entry.holidayName);
                    holiday.title = entry.holidayName;
                    button.appendChild(holiday);
                }

                const labelDate = workCalendarDateFormatter.format(createColomboDate(cell.iso));
                button.setAttribute(
                    "aria-label",
                    `${labelDate}: ${isWorkDay ? "Work day" : "Not work day"}`,
                );

                button.addEventListener("click", async () => {
                    if (!cell.inCurrentMonth) {
                        try {
                            await setWorkCalendarMonth(cell.year, cell.month);
                        } catch (error) {
                            console.error("Failed to change calendar month", error);
                            return;
                        }
                    }
                    openWorkdayModal(cell.iso);
                });

                workCalendarGrid.appendChild(button);
            });
        };

        const setWorkCalendarMonth = async (year, month, { force = false } = {}) => {
            if (!Number.isFinite(year) || !Number.isFinite(month)) {
                return;
            }
            if (month < 1 || month > 12) {
                return;
            }

            workCalendarState = {
                ...workCalendarState,
                year,
                month,
            };

            setWorkCalendarSelectors(year, month);

            try {
                await ensureWorkCalendarMonthData(year, month, { force });
                hideWorkCalendarMessage();
            } catch (error) {
                console.error("Unable to load work calendar", error);
                showWorkCalendarMessage(
                    error?.message || "Unable to load the work calendar.",
                    "error",
                );
            }

            renderWorkCalendar();
        };

        const updateHolidayInputState = (isNotWorkDay, value = "") => {
            if (!workdayHolidayInput) {
                return;
            }
            workdayHolidayInput.disabled = !isNotWorkDay;
            if (isNotWorkDay) {
                workdayHolidayInput.value = value || "";
            } else {
                workdayHolidayInput.value = "";
            }
        };

        const closeWorkdayModal = () => {
            if (!workdayModal) {
                return;
            }
            workdayModal.classList.remove("modal--open");
            workdayModal.setAttribute("hidden", "");
            workdayModal.setAttribute("aria-hidden", "true");
            document.body.classList.remove("modal-open");
            if (workdayForm) {
                workdayForm.reset();
            }
            updateHolidayInputState(false);
            if (workdayFormError) {
                workdayFormError.hidden = true;
                workdayFormError.textContent = "";
            }
            workdayModalContext = null;
            if (workdayModal.dataset) {
                delete workdayModal.dataset.date;
            }
        };

        const openWorkdayModal = (iso) => {
            if (!workdayModal || !workdayForm) {
                return;
            }
            const parts = parseIsoDate(iso);
            if (!parts) {
                return;
            }
            const key = getMonthKey(parts.year, parts.month);
            const store = workCalendarStore.get(key);
            const entry = store?.get(iso);
            const isWorkDay = entry ? entry.isWorkDay !== false : true;

            workdayForm.reset();

            if (workdayDateDisplay) {
                workdayDateDisplay.textContent = workCalendarDateFormatter.format(
                    createColomboDate(iso),
                );
            }
            if (workdayFormError) {
                workdayFormError.hidden = true;
                workdayFormError.textContent = "";
            }

            if (workdayStatusWork) {
                workdayStatusWork.checked = isWorkDay;
            }
            if (workdayStatusOff) {
                workdayStatusOff.checked = !isWorkDay;
            }

            updateHolidayInputState(!isWorkDay, entry?.holidayName ?? "");

            workdayModalContext = {
                iso,
                year: parts.year,
                month: parts.month,
            };

            workdayModal.removeAttribute("hidden");
            workdayModal.setAttribute("aria-hidden", "false");
            workdayModal.classList.add("modal--open");
            document.body.classList.add("modal-open");
            workdayModal.dataset.date = iso;

            const focusTarget = !isWorkDay && workdayHolidayInput ? workdayHolidayInput : workdayStatusOff;
            if (focusTarget) {
                setTimeout(() => focusTarget.focus(), 0);
            }
        };

        const normalizeTimeValue = (value) => {
            if (typeof value !== "string") {
                return "";
            }

            let text = value.trim();
            if (!text) {
                return "";
            }

            text = text.replace(/[.]/g, ":").replace(/\s+/g, " ");

            const twelveHourMatch = TIME_12_HOUR_PATTERN.exec(text);
            if (twelveHourMatch) {
                let [_, hours, minutes, meridiem] = twelveHourMatch;
                let hourNumber = Number.parseInt(hours, 10);
                if (Number.isNaN(hourNumber)) {
                    return "";
                }

                meridiem = meridiem.toUpperCase();
                if (meridiem === "AM") {
                    if (hourNumber === 12) {
                        hourNumber = 0;
                    }
                } else if (meridiem === "PM") {
                    if (hourNumber !== 12) {
                        hourNumber += 12;
                    }
                }

                if (hourNumber < 0 || hourNumber > 23) {
                    return "";
                }

                return `${String(hourNumber).padStart(2, "0")}:${minutes}`;
            }

            const twentyFourHourMatch = TIME_24_HOUR_PATTERN.exec(text);
            if (twentyFourHourMatch) {
                const [, hours, minutes] = twentyFourHourMatch;
                const hourNumber = Number.parseInt(hours, 10);

                if (!Number.isNaN(hourNumber) && hourNumber >= 0 && hourNumber <= 23) {
                    return `${String(hourNumber).padStart(2, "0")}:${minutes}`;
                }
            }

            const compactMatch = TIME_COMPACT_PATTERN.exec(text);
            if (compactMatch) {
                const [, hours, minutes] = compactMatch;
                const hourNumber = Number.parseInt(hours, 10);

                if (!Number.isNaN(hourNumber) && hourNumber >= 0 && hourNumber <= 23) {
                    return `${String(hourNumber).padStart(2, "0")}:${minutes}`;
                }
            }

            return "";
        };

        const MINUTES_PER_DAY = 24 * 60;

        const parseTimeToMinutes = (value) => {
            if (typeof value !== "string") {
                return null;
            }

            const match = /^(\d{1,2}):([0-5]\d)$/.exec(value.trim());
            if (!match) {
                return null;
            }

            const hours = Number.parseInt(match[1], 10);
            const minutes = Number.parseInt(match[2], 10);

            if (
                Number.isNaN(hours) ||
                Number.isNaN(minutes) ||
                hours < 0 ||
                hours > 23 ||
                minutes < 0 ||
                minutes > 59
            ) {
                return null;
            }

            return hours * 60 + minutes;
        };

        const buildTimeAdjustments = (rules) =>
            rules
                .map(({ start, end, target }) => {
                    const startMinutes = parseTimeToMinutes(start);
                    const endMinutes = parseTimeToMinutes(end);
                    const targetMinutes = parseTimeToMinutes(target);

                    if (
                        startMinutes == null ||
                        endMinutes == null ||
                        targetMinutes == null
                    ) {
                        return null;
                    }

                    return {
                        start: Math.min(startMinutes, endMinutes),
                        end: Math.max(startMinutes, endMinutes),
                        target: targetMinutes,
                    };
                })
                .filter(Boolean);

        const ON_TIME_ADJUSTMENTS = buildTimeAdjustments([
            { start: "06:36", end: "07:04", target: "07:00" },
            { start: "07:05", end: "07:16", target: "07:15" },
            { start: "07:17", end: "07:31", target: "07:30" },
            { start: "07:32", end: "07:46", target: "07:45" },
            { start: "07:46", end: "08:04", target: "08:00" },
        ]);

        const OFF_TIME_ADJUSTMENTS = buildTimeAdjustments([
            { start: "18:59", end: "19:14", target: "19:00" },
            { start: "18:44", end: "18:58", target: "18:45" },
            { start: "18:29", end: "18:43", target: "18:30" },
            { start: "18:14", end: "18:28", target: "18:15" },
            { start: "17:58", end: "18:13", target: "18:00" },
        ]);

        const applyTimeAdjustment = (minutes, adjustments) => {
            if (!Number.isFinite(minutes)) {
                return null;
            }

            for (const adjustment of adjustments) {
                if (minutes >= adjustment.start && minutes <= adjustment.end) {
                    return adjustment.target;
                }
            }

            return minutes;
        };

        const formatMinutesAsDuration = (minutes) => {
            if (!Number.isFinite(minutes) || minutes < 0) {
                return "—";
            }

            const hours = Math.floor(minutes / 60);
            const remainingMinutes = minutes % 60;

            return `${String(hours).padStart(2, "0")}:${String(remainingMinutes).padStart(
                2,
                "0"
            )}`;
        };

        const computeDurationMinutes = (startMinutes, endMinutes) => {
            if (!Number.isFinite(startMinutes) || !Number.isFinite(endMinutes)) {
                return null;
            }

            let difference = endMinutes - startMinutes;
            if (difference < 0) {
                difference += MINUTES_PER_DAY;
            }

            if (difference < 0) {
                return null;
            }

            return difference;
        };

        const computeActualMinutes = (onValue, offValue) => {
            const onMinutes = parseTimeToMinutes(onValue);
            const offMinutes = parseTimeToMinutes(offValue);

            if (onMinutes == null || offMinutes == null) {
                return null;
            }

            return computeDurationMinutes(onMinutes, offMinutes);
        };

        const computePayMinutes = (onValue, offValue) => {
            const onMinutes = parseTimeToMinutes(onValue);
            const offMinutes = parseTimeToMinutes(offValue);

            if (onMinutes == null || offMinutes == null) {
                return null;
            }

            const adjustedOn = applyTimeAdjustment(onMinutes, ON_TIME_ADJUSTMENTS);
            const adjustedOff = applyTimeAdjustment(offMinutes, OFF_TIME_ADJUSTMENTS);

            if (adjustedOn == null || adjustedOff == null) {
                return null;
            }

            return computeDurationMinutes(adjustedOn, adjustedOff);
        };

        const MEAL_BREAK_START_MINUTES = parseTimeToMinutes("12:45") ?? 12 * 60 + 45;
        const MEAL_BREAK_END_MINUTES = parseTimeToMinutes("13:45") ?? 13 * 60 + 45;

        const getWorkCalendarDayInfo = (iso) => {
            const parts = parseIsoDate(iso);
            if (!parts) {
                return { isWorkDay: true, parts: null };
            }

            const store = getWorkCalendarMonthStore(parts.year, parts.month);
            const entry = store?.get(iso);

            return {
                isWorkDay: entry ? entry.isWorkDay !== false : true,
                parts,
            };
        };

        const doesPeriodIncludeMealBreak = (startMinutes, endMinutes) => {
            if (!Number.isFinite(startMinutes) || !Number.isFinite(endMinutes)) {
                return false;
            }

            let adjustedEnd = endMinutes;
            if (adjustedEnd <= startMinutes) {
                adjustedEnd += MINUTES_PER_DAY;
            }

            const intervals = [
                [MEAL_BREAK_START_MINUTES, MEAL_BREAK_END_MINUTES],
                [
                    MEAL_BREAK_START_MINUTES + MINUTES_PER_DAY,
                    MEAL_BREAK_END_MINUTES + MINUTES_PER_DAY,
                ],
            ];

            return intervals.some(
                ([mealStart, mealEnd]) => startMinutes < mealEnd && adjustedEnd > mealStart,
            );
        };

        const computeRegularAndOvertimeMinutes = (iso, onValue, offValue, payMinutes) => {
            if (!iso || !Number.isFinite(payMinutes) || payMinutes < 0) {
                return { regularMinutes: null, overtimeMinutes: null };
            }

            const info = getWorkCalendarDayInfo(iso);
            if (!info.parts) {
                return {
                    regularMinutes: payMinutes,
                    overtimeMinutes: 0,
                };
            }

            if (!info.isWorkDay) {
                const onMinutes = parseTimeToMinutes(onValue);
                const offMinutes = parseTimeToMinutes(offValue);
                let overtimeMinutes = payMinutes;

                if (
                    Number.isFinite(onMinutes) &&
                    Number.isFinite(offMinutes) &&
                    doesPeriodIncludeMealBreak(onMinutes, offMinutes) &&
                    overtimeMinutes > 0
                ) {
                    overtimeMinutes = Math.max(overtimeMinutes - 60, 0);
                }

                return {
                    regularMinutes: 0,
                    overtimeMinutes,
                };
            }

            const date = new Date(Date.UTC(info.parts.year, info.parts.month - 1, info.parts.day));
            const dayOfWeek = date.getUTCDay();
            let regularLimitMinutes = 9 * 60;
            if (dayOfWeek === 6) {
                regularLimitMinutes = 5 * 60;
            }

            const overtimeMinutes = Math.max(payMinutes - regularLimitMinutes, 0);
            const regularMinutes = Math.max(Math.min(payMinutes, regularLimitMinutes), 0);

            return { regularMinutes, overtimeMinutes };
        };

        const setAttendanceRowMinutes = (row, key, minutes) => {
            if (!row || !row.dataset || !key) {
                return;
            }

            if (Number.isFinite(minutes) && minutes >= 0) {
                row.dataset[key] = String(Math.round(minutes));
            } else if (Object.prototype.hasOwnProperty.call(row.dataset, key)) {
                delete row.dataset[key];
            }
        };

        const ATTENDANCE_DAY_STATUS_OPTIONS = [
            "Work Day",
            "Not Work Day",
            "Annual Leave",
            "Medical Leave",
            "Special Company Holiday",
            "No Pay Leave",
        ];
        const ATTENDANCE_DAY_STATUS_DEFAULT = ATTENDANCE_DAY_STATUS_OPTIONS[0];

        const normalizeDayStatusValue = (value) => {
            if (typeof value !== "string") {
                return "";
            }
            const trimmed = value.trim();
            return ATTENDANCE_DAY_STATUS_OPTIONS.includes(trimmed) ? trimmed : "";
        };

        const resolveDayStatusValue = (value) => {
            const normalized = normalizeDayStatusValue(value);
            if (normalized) {
                return normalized;
            }
            return ATTENDANCE_DAY_STATUS_DEFAULT;
        };

        const isWorkCalendarDateWorkDay = (iso) => {
            const parts = parseIsoDate(iso);
            if (!parts) {
                return true;
            }
            const store = getWorkCalendarMonthStore(parts.year, parts.month);
            if (!store) {
                return true;
            }
            const entry = store.get(iso);
            return entry ? entry.isWorkDay !== false : true;
        };

        const setDayStatusValue = (select, hiddenInput, value) => {
            const resolved = resolveDayStatusValue(value);
            if (select) {
                select.value = resolved;
            }
            if (hiddenInput) {
                hiddenInput.value = resolved;
            }
            return resolved;
        };

        const applyDayStatusRules = (select, hiddenInput, iso, { payMinutes } = {}) => {
            if (!select && !hiddenInput) {
                return;
            }

            const calendarIsWorkDay = isWorkCalendarDateWorkDay(iso);
            const validPayMinutes = Number.isFinite(payMinutes) && payMinutes >= 0 ? payMinutes : null;

            if (!calendarIsWorkDay) {
                const value = setDayStatusValue(select, hiddenInput, "Not Work Day");
                if (select) {
                    select.disabled = true;
                    select.setAttribute("aria-disabled", "true");
                }
                if (hiddenInput) {
                    hiddenInput.disabled = false;
                    hiddenInput.value = value;
                }
                return;
            }

            if (validPayMinutes != null && validPayMinutes > 0) {
                const value = setDayStatusValue(select, hiddenInput, "Work Day");
                if (select) {
                    select.disabled = true;
                    select.setAttribute("aria-disabled", "true");
                }
                if (hiddenInput) {
                    hiddenInput.disabled = false;
                    hiddenInput.value = value;
                }
                return;
            }

            const candidateValues = [
                select?.dataset?.userValue,
                select?.dataset?.initialValue,
            ];
            let target = "";
            for (const candidate of candidateValues) {
                const normalized = normalizeDayStatusValue(candidate);
                if (normalized) {
                    target = normalized;
                    break;
                }
            }

            const value = setDayStatusValue(select, hiddenInput, target);
            if (select) {
                select.disabled = false;
                select.removeAttribute("aria-disabled");
            }
            if (hiddenInput) {
                hiddenInput.disabled = true;
                hiddenInput.value = value;
            }
        };

        const refreshAttendanceTotals = () => {
            if (!attendanceTableBody) {
                return;
            }

            const rows = Array.from(attendanceTableBody.querySelectorAll("tr[data-date]")) || [];
            let totalPay = 0;
            let totalRegular = 0;
            let totalOvertime = 0;
            let hasPay = false;
            let hasRegular = false;
            let hasOvertime = false;

            rows.forEach((row) => {
                const pay = Number.parseInt(row.dataset.payMinutes ?? "", 10);
                if (Number.isFinite(pay)) {
                    totalPay += pay;
                    hasPay = true;
                }

                const regular = Number.parseInt(row.dataset.regularMinutes ?? "", 10);
                if (Number.isFinite(regular)) {
                    totalRegular += regular;
                    hasRegular = true;
                }

                const overtime = Number.parseInt(row.dataset.overtimeMinutes ?? "", 10);
                if (Number.isFinite(overtime)) {
                    totalOvertime += overtime;
                    hasOvertime = true;
                }
            });

            if (attendanceTotalPayHours) {
                attendanceTotalPayHours.textContent = hasPay
                    ? formatMinutesAsDuration(totalPay)
                    : "00:00";
            }

            if (attendanceTotalRegularHours) {
                attendanceTotalRegularHours.textContent = hasRegular
                    ? formatMinutesAsDuration(totalRegular)
                    : "00:00";
            }

            if (attendanceTotalOvertimeHours) {
                attendanceTotalOvertimeHours.textContent = hasOvertime
                    ? formatMinutesAsDuration(totalOvertime)
                    : "00:00";
            }

            updateAttendanceLeaveSummaryDisplay();
        };

        const resetAttendanceTotals = () => {
            if (attendanceTotalPayHours) {
                attendanceTotalPayHours.textContent = "00:00";
            }
            if (attendanceTotalRegularHours) {
                attendanceTotalRegularHours.textContent = "00:00";
            }
            if (attendanceTotalOvertimeHours) {
                attendanceTotalOvertimeHours.textContent = "00:00";
            }
        };

        const ensureIntegerValue = (value) => {
            if (typeof value === "number" && Number.isFinite(value)) {
                return Math.trunc(value);
            }
            if (typeof value === "string") {
                const trimmed = value.trim();
                if (!trimmed) {
                    return null;
                }
                const parsed = Number.parseInt(trimmed, 10);
                return Number.isFinite(parsed) ? parsed : null;
            }
            return null;
        };

        const cloneLeaveSummary = (summary) => {
            if (!summary || typeof summary !== "object") {
                return null;
            }
            const annual = summary.annual && typeof summary.annual === "object" ? summary.annual : {};
            const medical = summary.medical && typeof summary.medical === "object" ? summary.medical : {};
            return {
                workDays: ensureIntegerValue(summary.workDays),
                noPayDays: ensureIntegerValue(summary.noPayDays),
                annual: {
                    broughtForward: ensureIntegerValue(annual.broughtForward),
                    thisMonth: ensureIntegerValue(annual.thisMonth),
                    balance: ensureIntegerValue(annual.balance),
                },
                medical: {
                    broughtForward: ensureIntegerValue(medical.broughtForward),
                    thisMonth: ensureIntegerValue(medical.thisMonth),
                    balance: ensureIntegerValue(medical.balance),
                },
            };
        };

        const getAttendanceLeaveSummaryRecord = (month, memberKey) => {
            if (!month || !memberKey) {
                return null;
            }
            return attendanceLeaveSummaryStore[month]?.[memberKey] || null;
        };

        const resetAttendanceLeaveSummaryDisplay = () => {
            Object.values(attendanceLeaveElements).forEach((element) => {
                if (element) {
                    element.textContent = "—";
                }
            });
        };

        const computeAttendanceDraftLeaveCounts = () => {
            if (!attendanceTableBody) {
                return null;
            }

            const rows = Array.from(attendanceTableBody.querySelectorAll("tr[data-date]"));
            if (rows.length === 0) {
                return { workDays: 0, noPayDays: 0, annualLeave: 0, medicalLeave: 0 };
            }

            const counts = { workDays: 0, noPayDays: 0, annualLeave: 0, medicalLeave: 0 };

            rows.forEach((row) => {
                const payMinutes = Number.parseInt(row.dataset.payMinutes ?? "", 10);
                if (Number.isFinite(payMinutes) && payMinutes > 0) {
                    counts.workDays += 1;
                }

                const statusInput = row.querySelector(
                    ".attendance-table__status input[type='hidden'][name^='status-']",
                );
                const status = normalizeDayStatusValue(statusInput?.value ?? "");
                if (status === "No Pay Leave") {
                    counts.noPayDays += 1;
                } else if (status === "Annual Leave") {
                    counts.annualLeave += 1;
                } else if (status === "Medical Leave") {
                    counts.medicalLeave += 1;
                }
            });

            return counts;
        };

        const formatLeaveDisplayValue = (value) => {
            if (value == null || Number.isNaN(value)) {
                return "—";
            }
            return String(value);
        };

        const applyAttendanceLeaveSummary = (storedSummary) => {
            const result = {
                workDays: ensureIntegerValue(storedSummary?.workDays),
                noPayDays: ensureIntegerValue(storedSummary?.noPayDays),
                annual: {
                    broughtForward: ensureIntegerValue(storedSummary?.annual?.broughtForward),
                    thisMonth: ensureIntegerValue(storedSummary?.annual?.thisMonth),
                    balance: ensureIntegerValue(storedSummary?.annual?.balance),
                },
                medical: {
                    broughtForward: ensureIntegerValue(storedSummary?.medical?.broughtForward),
                    thisMonth: ensureIntegerValue(storedSummary?.medical?.thisMonth),
                    balance: ensureIntegerValue(storedSummary?.medical?.balance),
                },
            };

            const draftCounts = computeAttendanceDraftLeaveCounts();

            if (draftCounts) {
                result.workDays = draftCounts.workDays;
                result.noPayDays = draftCounts.noPayDays;

                const annualBroughtForward = ensureIntegerValue(result.annual.broughtForward);
                if (annualBroughtForward != null) {
                    result.annual.broughtForward = annualBroughtForward;
                    result.annual.thisMonth = draftCounts.annualLeave;
                    result.annual.balance = annualBroughtForward - draftCounts.annualLeave;
                } else {
                    result.annual.thisMonth = draftCounts.annualLeave;
                    result.annual.balance = null;
                }

                const medicalBroughtForward = ensureIntegerValue(result.medical.broughtForward);
                if (medicalBroughtForward != null) {
                    result.medical.broughtForward = medicalBroughtForward;
                    result.medical.thisMonth = draftCounts.medicalLeave;
                    result.medical.balance = medicalBroughtForward - draftCounts.medicalLeave;
                } else {
                    result.medical.thisMonth = draftCounts.medicalLeave;
                    result.medical.balance = null;
                }
            }

            if (attendanceLeaveElements.workDays) {
                attendanceLeaveElements.workDays.textContent = formatLeaveDisplayValue(
                    result.workDays,
                );
            }
            if (attendanceLeaveElements.noPayDays) {
                attendanceLeaveElements.noPayDays.textContent = formatLeaveDisplayValue(
                    result.noPayDays,
                );
            }
            if (attendanceLeaveElements.annualBroughtForward) {
                attendanceLeaveElements.annualBroughtForward.textContent = formatLeaveDisplayValue(
                    result.annual.broughtForward,
                );
            }
            if (attendanceLeaveElements.annualThisMonth) {
                attendanceLeaveElements.annualThisMonth.textContent = formatLeaveDisplayValue(
                    result.annual.thisMonth,
                );
            }
            if (attendanceLeaveElements.annualBalance) {
                attendanceLeaveElements.annualBalance.textContent = formatLeaveDisplayValue(
                    result.annual.balance,
                );
            }
            if (attendanceLeaveElements.medicalBroughtForward) {
                attendanceLeaveElements.medicalBroughtForward.textContent = formatLeaveDisplayValue(
                    result.medical.broughtForward,
                );
            }
            if (attendanceLeaveElements.medicalThisMonth) {
                attendanceLeaveElements.medicalThisMonth.textContent = formatLeaveDisplayValue(
                    result.medical.thisMonth,
                );
            }
            if (attendanceLeaveElements.medicalBalance) {
                attendanceLeaveElements.medicalBalance.textContent = formatLeaveDisplayValue(
                    result.medical.balance,
                );
            }
        };

        const updateAttendanceLeaveSummaryDisplay = () => {
            if (!attendanceModalContext?.memberKey) {
                resetAttendanceLeaveSummaryDisplay();
                return;
            }

            const normalizedMonth =
                normalizeMonthValue(currentSalaryMonth) || currentSalaryMonth;
            const summary = getAttendanceLeaveSummaryRecord(
                normalizedMonth,
                attendanceModalContext.memberKey,
            );
            applyAttendanceLeaveSummary(summary);
        };

        const setAttendanceLeaveSummaryRecord = (month, memberKey, summary) => {
            const normalizedMonth = normalizeMonthValue(month);
            if (!normalizedMonth || !memberKey) {
                return;
            }

            if (!attendanceLeaveSummaryStore[normalizedMonth]) {
                attendanceLeaveSummaryStore[normalizedMonth] = {};
            }

            const store = attendanceLeaveSummaryStore[normalizedMonth];
            const cloned = cloneLeaveSummary(summary);

            if (cloned) {
                store[memberKey] = cloned;
            } else if (store[memberKey]) {
                delete store[memberKey];
                if (Object.keys(store).length === 0) {
                    delete attendanceLeaveSummaryStore[normalizedMonth];
                }
            } else if (Object.keys(store).length === 0) {
                delete attendanceLeaveSummaryStore[normalizedMonth];
            }

            if (
                attendanceModalContext?.memberKey === memberKey &&
                (normalizeMonthValue(currentSalaryMonth) || currentSalaryMonth) === normalizedMonth
            ) {
                updateAttendanceLeaveSummaryDisplay();
            }
        };

        const fetchAttendanceLeaveSummary = async (memberId, month) => {
            const normalizedMonth = normalizeMonthValue(month);
            if (memberId == null || !normalizedMonth) {
                return null;
            }

            try {
                const response = await fetch(
                    `/api/team/attendance/${memberId}/summary?month=${encodeURIComponent(normalizedMonth)}`,
                    { headers: authHeaders },
                );

                if (response.status === 401) {
                    logoutButton.click();
                    return null;
                }

                if (!response.ok) {
                    throw new Error(`Request failed with status ${response.status}`);
                }

                const body = await response.json().catch(() => ({}));
                return body?.leaveSummary || null;
            } catch (error) {
                console.error("Failed to load leave summary", error);
                return null;
            }
        };

        const loadAttendanceLeaveSummaryForModal = async () => {
            if (!attendanceModalContext?.memberKey) {
                return;
            }

            const normalizedMonth =
                normalizeMonthValue(currentSalaryMonth) || currentSalaryMonth;
            updateAttendanceLeaveSummaryDisplay();

            const memberId = attendanceModalContext.memberId;
            if (memberId == null || !normalizedMonth) {
                return;
            }

            const summary = await fetchAttendanceLeaveSummary(memberId, normalizedMonth);
            if (summary) {
                setAttendanceLeaveSummaryRecord(normalizedMonth, attendanceModalContext.memberKey, summary);
            }
        };

        const updateAttendanceHoursDisplay = (
            row,
            iso,
            onInput,
            offInput,
            actualNode,
            payNode,
            overtimeNode,
            options = {},
        ) => {
            if (!row || !iso || !onInput || !offInput || !actualNode || !payNode || !overtimeNode) {
                return;
            }

            const normalizedOn = normalizeTimeValue(onInput.value ?? "");
            const normalizedOff = normalizeTimeValue(offInput.value ?? "");

            const actualMinutes = computeActualMinutes(normalizedOn, normalizedOff);
            const payMinutes = computePayMinutes(normalizedOn, normalizedOff);

            let regularMinutes = null;
            let overtimeMinutes = null;

            if (Number.isFinite(payMinutes)) {
                const result = computeRegularAndOvertimeMinutes(
                    iso,
                    normalizedOn,
                    normalizedOff,
                    payMinutes,
                );
                regularMinutes = result.regularMinutes;
                overtimeMinutes = result.overtimeMinutes;
            }

            actualNode.textContent =
                actualMinutes != null ? formatMinutesAsDuration(actualMinutes) : "—";
            payNode.textContent = payMinutes != null ? formatMinutesAsDuration(payMinutes) : "—";
            overtimeNode.textContent =
                overtimeMinutes != null ? formatMinutesAsDuration(overtimeMinutes) : "—";

            setAttendanceRowMinutes(row, "payMinutes", payMinutes);
            setAttendanceRowMinutes(row, "regularMinutes", regularMinutes);
            setAttendanceRowMinutes(row, "overtimeMinutes", overtimeMinutes);

            if (options?.dayStatus) {
                applyDayStatusRules(
                    options.dayStatus.select,
                    options.dayStatus.hiddenInput,
                    iso,
                    { payMinutes },
                );
            }

            refreshAttendanceTotals();

            return {
                actualMinutes,
                payMinutes,
                regularMinutes,
                overtimeMinutes,
            };
        };

        const parseMemberId = (value) => {
            if (typeof value === "number" && Number.isFinite(value)) {
                return value;
            }
            if (typeof value === "string") {
                const trimmed = value.trim();
                if (trimmed) {
                    const parsed = Number.parseInt(trimmed, 10);
                    if (Number.isFinite(parsed)) {
                        return parsed;
                    }
                }
            }
            return null;
        };

        const fetchAttendanceRecords = async (month) => {
            const normalized = normalizeMonthValue(month);
            if (!normalized) {
                return;
            }

            try {
                const response = await fetch(`/api/team/attendance?month=${encodeURIComponent(normalized)}`, {
                    headers: authHeaders,
                });

                if (response.status === 401) {
                    logoutButton.click();
                    return;
                }

                if (!response.ok) {
                    throw new Error(`Request failed with status ${response.status}`);
                }

                const body = await response.json().catch(() => ({}));
                const records = Array.isArray(body?.records) ? body.records : [];
                const monthStore = Object.create(null);

                if (casualOtRateStore[normalized]) {
                    delete casualOtRateStore[normalized];
                }

                records.forEach((record) => {
                    const memberId = parseMemberId(record?.memberId);
                    if (memberId == null) {
                        return;
                    }
                    const storeKey = memberKeyById.get(memberId);
                    if (!storeKey) {
                        return;
                    }
                    const entries = record?.entries;
                    if (
                        entries &&
                        typeof entries === "object" &&
                        Object.keys(entries).length > 0
                    ) {
                        monthStore[storeKey] = entries;
                    }

                    if (record?.leaveSummary) {
                        setAttendanceLeaveSummaryRecord(
                            normalized,
                            storeKey,
                            record.leaveSummary,
                        );
                    }
                });

                attendanceDataStore[normalized] = monthStore;
            } catch (error) {
                console.error("Failed to load attendance records", error);
            }
        };

        const fetchSalaryRecords = async (month) => {
            const normalized = normalizeMonthValue(month);
            if (!normalized) {
                return;
            }

            try {
                const response = await fetch(`/api/team/salary?month=${encodeURIComponent(normalized)}`, {
                    headers: authHeaders,
                });

                if (response.status === 401) {
                    logoutButton.click();
                    return;
                }

                if (!response.ok) {
                    throw new Error(`Request failed with status ${response.status}`);
                }

                const body = await response.json().catch(() => ({}));
                const records = Array.isArray(body?.records) ? body.records : [];
                const monthStore = Object.create(null);

                records.forEach((record) => {
                    const memberId = parseMemberId(record?.memberId);
                    if (memberId == null) {
                        return;
                    }
                    const storeKey = memberKeyById.get(memberId);
                    if (!storeKey) {
                        return;
                    }
                    const components = record?.components;
                    if (
                        components &&
                        typeof components === "object" &&
                        Object.keys(components).length > 0
                    ) {
                        monthStore[storeKey] = components;

                        const rateValue = components.casualOtRate;
                        if (rateValue != null && rateValue !== "") {
                            setCasualOtRate(normalized, storeKey, rateValue);
                        } else {
                            removeCasualOtRate(normalized, storeKey);
                        }
                    }
                });

                salaryDataStore[normalized] = monthStore;

                const targetAllowances =
                    body && typeof body === "object" ? body.targetAllowances : null;
                if (targetAllowances && typeof targetAllowances === "object") {
                    const allowanceStore = Object.create(null);

                    Object.entries(targetAllowances).forEach(([memberIdValue, rawValue]) => {
                        const memberId = parseMemberId(memberIdValue);
                        if (memberId == null) {
                            return;
                        }
                        const storeKey = memberKeyById.get(memberId);
                        if (!storeKey) {
                            return;
                        }

                        let numericValue = null;
                        if (typeof rawValue === "number") {
                            numericValue = rawValue;
                        } else if (typeof rawValue === "string") {
                            const trimmed = rawValue.trim();
                            if (!trimmed) {
                                numericValue = 0;
                            } else {
                                const parsed = Number.parseFloat(trimmed);
                                if (Number.isFinite(parsed)) {
                                    numericValue = parsed;
                                }
                            }
                        }

                        if (Number.isFinite(numericValue)) {
                            allowanceStore[storeKey] = numericValue;
                        }
                    });

                    computedTargetAllowanceStore[normalized] = allowanceStore;
                } else {
                    delete computedTargetAllowanceStore[normalized];
                }
            } catch (error) {
                console.error("Failed to load salary records", error);
                delete computedTargetAllowanceStore[normalized];
            }
        };

        const ATTENDANCE_ALLOWANCE_AMOUNTS = {
            0: 11000,
            1: 9000,
            2: 7500,
            3: 5500,
        };
        const ATTENDANCE_ALLOWANCE_DAILY_RATE = 5500 / 22;
        const MIN_ATTENDANCE_ALLOWANCE_WORK_DAYS = 18;

        const getMonthParts = (value) => {
            const normalized = normalizeMonthValue(value);
            if (!normalized) {
                return null;
            }

            const [yearStr, monthStr] = normalized.split("-");
            const year = Number.parseInt(yearStr, 10);
            const month = Number.parseInt(monthStr, 10);

            if (!Number.isFinite(year) || !Number.isFinite(month)) {
                return null;
            }

            return { normalized, year, month };
        };

        const getMemberPayCategory = (member) => {
            if (!member || typeof member !== "object") {
                return "";
            }
            const raw = member.payCategory ?? member.pay_category;
            if (typeof raw !== "string") {
                return "";
            }
            return raw.trim();
        };

        const isFactoryPayCategory = (member) =>
            getMemberPayCategory(member).toLowerCase() === "factory";

        const getWorkCalendarSummaryForMonth = async (month) => {
            const parts = getMonthParts(month);
            if (!parts) {
                return null;
            }

            let store = getWorkCalendarMonthStore(parts.year, parts.month);
            if (!store) {
                try {
                    store = await ensureWorkCalendarMonthData(parts.year, parts.month);
                } catch (error) {
                    console.error(
                        "Unable to load work calendar for attendance allowance calculations",
                        error,
                    );
                    store = getWorkCalendarMonthStore(parts.year, parts.month);
                }
            }

            if (!store) {
                store = new Map();
            }

            const todayIso = getTodayIso();
            const todayParts = parseIsoDate(todayIso);
            const isCurrentMonth =
                todayParts &&
                todayParts.year === parts.year &&
                todayParts.month === parts.month;

            const workDaySet = new Set();
            const futureWorkDaySet = new Set();
            const daysInMonth = new Date(parts.year, parts.month, 0).getDate();

            for (let day = 1; day <= daysInMonth; day += 1) {
                const iso = formatIsoDate(parts.year, parts.month, day);
                const entry = store.get(iso);
                const isWorkDay = entry ? entry.isWorkDay !== false : true;
                if (isWorkDay) {
                    workDaySet.add(iso);
                    if (isCurrentMonth && todayIso && iso >= todayIso) {
                        futureWorkDaySet.add(iso);
                    }
                }
            }

            return {
                workDaySet,
                totalWorkDays: workDaySet.size,
                futureWorkDaySet,
                futureWorkDayCount: futureWorkDaySet.size,
                isCurrentMonth,
            };
        };

        const countWorkedDaysForRecord = (record, workDaySet) => {
            const workedDaySet = new Set();

            if (!record || typeof record !== "object") {
                return { count: 0, workedDaySet };
            }

            let count = 0;
            Object.entries(record).forEach(([iso, entry]) => {
                if (workDaySet && workDaySet.size > 0 && !workDaySet.has(iso)) {
                    return;
                }
                if (!entry || typeof entry !== "object") {
                    return;
                }
                const on = typeof entry.onTime === "string" ? entry.onTime.trim() : "";
                const off = typeof entry.offTime === "string" ? entry.offTime.trim() : "";
                if (on || off) {
                    count += 1;
                    workedDaySet.add(iso);
                }
            });
            return { count, workedDaySet };
        };

        const computeAttendanceAllowanceAmount = (workedDays, totalWorkDays) => {
            if (!Number.isFinite(workedDays) || !Number.isFinite(totalWorkDays)) {
                return null;
            }

            if (totalWorkDays <= 0) {
                return null;
            }

            if (workedDays < MIN_ATTENDANCE_ALLOWANCE_WORK_DAYS) {
                return 0;
            }

            const absences = Math.max(totalWorkDays - workedDays, 0);

            if (Object.prototype.hasOwnProperty.call(ATTENDANCE_ALLOWANCE_AMOUNTS, absences)) {
                return ATTENDANCE_ALLOWANCE_AMOUNTS[absences];
            }

            if (absences >= 4) {
                const computed = ATTENDANCE_ALLOWANCE_DAILY_RATE * workedDays;
                const rounded = Math.round((computed + Number.EPSILON) * 100) / 100;
                return rounded;
            }

            return null;
        };

        const getComputedAttendanceAllowance = (month, memberKey) => {
            const normalized = normalizeMonthValue(month);
            if (!normalized || !memberKey) {
                return null;
            }

            const monthStore = computedAttendanceAllowanceStore[normalized];
            if (!monthStore) {
                return null;
            }

            if (Object.prototype.hasOwnProperty.call(monthStore, memberKey)) {
                return monthStore[memberKey];
            }

            return null;
        };

        const getComputedTargetAllowance = (month, memberKey) => {
            const normalized = normalizeMonthValue(month);
            if (!normalized || !memberKey) {
                return null;
            }

            const monthStore = computedTargetAllowanceStore[normalized];
            if (!monthStore) {
                return null;
            }

            if (Object.prototype.hasOwnProperty.call(monthStore, memberKey)) {
                return monthStore[memberKey];
            }

            return null;
        };

        const updateComputedAttendanceAllowances = async (month) => {
            const parts = getMonthParts(month);
            if (!parts) {
                return;
            }

            computedAttendanceAllowanceStore[parts.normalized] = {};

            if (!Array.isArray(activeMembers) || activeMembers.length === 0) {
                return;
            }

            const calendarSummary = await getWorkCalendarSummaryForMonth(parts.normalized);
            if (!calendarSummary || calendarSummary.totalWorkDays <= 0) {
                return;
            }

            const monthAttendanceStore = attendanceDataStore[parts.normalized] || {};
            const allowances = Object.create(null);

            activeMembers.forEach((member, index) => {
                if (!isFactoryPayCategory(member)) {
                    return;
                }

                const memberKey = computeMemberKey(member, index);
                if (!memberKey) {
                    return;
                }

                const record = monthAttendanceStore[memberKey] || {};
                const { count: recordedWorkedDays, workedDaySet } =
                    countWorkedDaysForRecord(record, calendarSummary.workDaySet);

                let effectiveWorkedDays = recordedWorkedDays;

                if (
                    calendarSummary.isCurrentMonth &&
                    calendarSummary.futureWorkDaySet &&
                    calendarSummary.futureWorkDaySet.size > 0
                ) {
                    calendarSummary.futureWorkDaySet.forEach((iso) => {
                        if (workedDaySet.has(iso)) {
                            return;
                        }
                        if (Object.prototype.hasOwnProperty.call(record, iso)) {
                            return;
                        }
                        effectiveWorkedDays += 1;
                    });
                }

                if (calendarSummary.totalWorkDays > 0) {
                    effectiveWorkedDays = Math.min(
                        effectiveWorkedDays,
                        calendarSummary.totalWorkDays,
                    );
                }

                const computedValue = computeAttendanceAllowanceAmount(
                    effectiveWorkedDays,
                    calendarSummary.totalWorkDays,
                );

                if (computedValue != null) {
                    allowances[memberKey] = computedValue;
                }
            });

            computedAttendanceAllowanceStore[parts.normalized] = allowances;
        };

        const refreshMonthData = async (month = currentSalaryMonth) => {
            const normalized = normalizeMonthValue(month);
            if (!normalized) {
                return;
            }

            await Promise.all([
                fetchAttendanceRecords(normalized),
                fetchSalaryRecords(normalized),
            ]);

            await updateComputedAttendanceAllowances(normalized);

            renderSalarySheet();
            refreshAttendanceModalContents();

            if (
                salaryModalContext?.memberKey &&
                normalizeMonthValue(salaryFormMonth?.value || normalized) === normalized
            ) {
                populateSalaryFormFields(
                    getSalaryRecord(normalized, salaryModalContext.memberKey),
                    {
                        memberKey: salaryModalContext.memberKey,
                        month: normalized,
                        member: salaryModalContext.member,
                    },
                );
            }
        };

        const getMonthDateEntries = (month) => {
            const normalized = normalizeMonthValue(month);
            if (!normalized) {
                return [];
            }

            const [yearStr, monthStr] = normalized.split("-");
            const year = Number(yearStr);
            const monthIndex = Number(monthStr) - 1;

            if (!Number.isFinite(year) || !Number.isFinite(monthIndex)) {
                return [];
            }

            if (monthIndex < 0 || monthIndex > 11) {
                return [];
            }

            const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
            const entries = [];

            for (let day = 1; day <= daysInMonth; day += 1) {
                const iso = `${year}-${String(monthIndex + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
                const display = attendanceDateFormatter.format(
                    new Date(year, monthIndex, day)
                );
                entries.push({ iso, display });
            }

            return entries;
        };

        const formatAttendanceMonthLabel = (month) => {
            const normalized = normalizeMonthValue(month);
            if (!normalized) {
                return "—";
            }

            const [yearStr, monthStr] = normalized.split("-");
            const year = Number(yearStr);
            const monthIndex = Number(monthStr) - 1;
            if (!Number.isFinite(year) || !Number.isFinite(monthIndex)) {
                return "—";
            }

            const date = new Date(year, monthIndex, 1);
            if (Number.isNaN(date.getTime())) {
                return "—";
            }

            return attendanceMonthFormatter.format(date);
        };

        const formatSalaryValue = (value) => {
            if (value == null) {
                return "—";
            }
            const stringValue = String(value).trim();
            if (!stringValue) {
                return "—";
            }
            const numeric = Number(stringValue);
            if (Number.isFinite(numeric)) {
                return numberFormatter.format(numeric);
            }
            return stringValue;
        };

        const formatNumberForInput = (value) => {
            if (!Number.isFinite(value)) {
                return "";
            }

            const rounded = Math.round((value + Number.EPSILON) * 100) / 100;
            const normalized = Math.abs(rounded) < 0.005 ? 0 : rounded;
            return normalized.toFixed(2);
        };

        const memberHasEpfNumber = (member) => {
            if (!member || typeof member !== "object") {
                return false;
            }

            const value = member.epf;
            if (typeof value === "string") {
                return value.trim().length > 0;
            }

            return value != null;
        };

        const parseNumericAmount = (value) => {
            if (typeof value === "number") {
                return Number.isFinite(value) ? value : null;
            }

            if (typeof value === "string") {
                const normalized = value.replace(/,/g, "").trim();
                if (!normalized) {
                    return null;
                }

                const parsed = Number.parseFloat(normalized);
                return Number.isFinite(parsed) ? parsed : null;
            }

            return null;
        };

        const computeProvidentFundAmount = (member, basicSalaryValue) => {
            if (!memberHasEpfNumber(member)) {
                return null;
            }

            const numericBasic = parseNumericAmount(basicSalaryValue);
            if (!Number.isFinite(numericBasic)) {
                return null;
            }

            const amount = numericBasic * 0.08;
            return Math.round((amount + Number.EPSILON) * 100) / 100;
        };

        const computeMemberKey = (member, fallbackIndex = null) => {
            if (!member || typeof member !== "object") {
                return fallbackIndex != null ? `idx:${fallbackIndex}` : null;
            }
            if (member.id != null) {
                return `id:${member.id}`;
            }
            if (member.regNumber != null) {
                return `reg:${member.regNumber}`;
            }
            if (member.name) {
                return `name:${member.name}`;
            }
            return fallbackIndex != null ? `idx:${fallbackIndex}` : null;
        };

        let currentSalaryMonth = getInitialSalaryMonth();

        if (salaryMonthSelector) {
            const normalizedExisting = normalizeMonthValue(salaryMonthSelector.value);
            if (normalizedExisting) {
                currentSalaryMonth = normalizedExisting;
            } else {
                salaryMonthSelector.value = currentSalaryMonth;
            }

            salaryMonthSelector.addEventListener("change", async (event) => {
                const nextValue = normalizeMonthValue(event.target.value);
                if (!nextValue) {
                    event.target.value = currentSalaryMonth;
                    return;
                }
                currentSalaryMonth = nextValue;
                try {
                    await refreshMonthData(currentSalaryMonth);
                } catch (error) {
                    console.error("Failed to refresh monthly data", error);
                }
            });
        }

        const todayIso = getTodayIso();
        const todayParts = parseIsoDate(todayIso);
        const fallbackDate = new Date();
        const initialCalendarYear = todayParts?.year ?? fallbackDate.getFullYear();
        const initialCalendarMonth = todayParts?.month ?? fallbackDate.getMonth() + 1;

        const initializeWorkCalendar = async () => {
            try {
                await setWorkCalendarMonth(initialCalendarYear, initialCalendarMonth, {
                    force: true,
                });
            } catch (error) {
                console.error("Failed to initialize work calendar", error);
                showWorkCalendarMessage(
                    "Unable to load the work calendar. Refresh to try again.",
                    "error",
                );
            }
        };

        initializeWorkCalendar();

        if (workCalendarYearSelect) {
            workCalendarYearSelect.addEventListener("change", async (event) => {
                const nextYear = Number.parseInt(event.target.value, 10);
                if (!Number.isFinite(nextYear)) {
                    if (workCalendarState.year) {
                        event.target.value = String(workCalendarState.year);
                    }
                    return;
                }
                const month = workCalendarState.month ?? initialCalendarMonth;
                await setWorkCalendarMonth(nextYear, month);
            });
        }

        if (workCalendarMonthSelect) {
            workCalendarMonthSelect.addEventListener("change", async (event) => {
                const nextMonth = Number.parseInt(event.target.value, 10);
                if (!Number.isFinite(nextMonth) || nextMonth < 1 || nextMonth > 12) {
                    if (workCalendarState.month) {
                        event.target.value = String(workCalendarState.month);
                    }
                    return;
                }
                const year = workCalendarState.year ?? initialCalendarYear;
                await setWorkCalendarMonth(year, nextMonth);
            });
        }

        if (workdayStatusWork) {
            workdayStatusWork.addEventListener("change", () => {
                if (workdayStatusWork.checked) {
                    updateHolidayInputState(false);
                }
            });
        }

        if (workdayStatusOff) {
            workdayStatusOff.addEventListener("change", () => {
                if (workdayStatusOff.checked) {
                    updateHolidayInputState(true);
                    if (workdayHolidayInput) {
                        workdayHolidayInput.focus();
                    }
                }
            });
        }

        const sanitizeText = (value, fallback = "—") => {
            if (typeof value === "string") {
                const trimmed = value.trim();
                return trimmed || fallback;
            }

            if (value == null) {
                return fallback;
            }

            const stringValue = String(value).trim();
            return stringValue || fallback;
        };

        const BANK_DETAIL_FIELDS = [
            "bankAccountName",
            "bankName",
            "branchName",
            "bankAccountNumber",
        ];

        const getBankDetailValues = (source = {}) => {
            const values = {};
            BANK_DETAIL_FIELDS.forEach((field) => {
                const value = source?.[field];
                if (typeof value === "string") {
                    values[field] = value.trim();
                } else if (value == null) {
                    values[field] = "";
                } else {
                    values[field] = String(value).trim();
                }
            });
            return values;
        };

        const getMemberBankDetails = (member) =>
            getBankDetailValues({
                bankAccountName: member?.bankAccountName ?? member?.bank_account_name,
                bankName: member?.bankName ?? member?.bank_name,
                branchName: member?.branchName ?? member?.branch_name,
                bankAccountNumber: member?.bankAccountNumber ?? member?.bank_account_number,
            });

        const hasBankDetail = (detail) => {
            if (!detail) {
                return false;
            }
            return BANK_DETAIL_FIELDS.some((field) => {
                const value = detail[field];
                return typeof value === "string" && value.trim();
            });
        };

        const getHiddenBankDetailValues = () =>
            getBankDetailValues({
                bankAccountName: bankAccountNameHidden?.value ?? "",
                bankName: bankNameHidden?.value ?? "",
                branchName: branchNameHidden?.value ?? "",
                bankAccountNumber: bankAccountNumberHidden?.value ?? "",
            });

        const formatBankDetailSummary = (values) => {
            const parts = [];
            const namePart = values.bankAccountName?.trim();
            if (namePart) {
                parts.push(namePart);
            }
            const bankParts = [values.bankName, values.branchName]
                .map((part) => (typeof part === "string" ? part.trim() : ""))
                .filter(Boolean);
            if (bankParts.length) {
                parts.push(bankParts.join(" – "));
            }
            const numberPart = values.bankAccountNumber?.trim();
            if (numberPart) {
                parts.push(`Acc: ${numberPart}`);
            }
            return parts.join(" • ") || "";
        };

        const updateBankDetailSummary = () => {
            if (!bankDetailSummary) {
                return;
            }
            const values = getHiddenBankDetailValues();
            if (hasBankDetail(values)) {
                bankDetailSummary.textContent = formatBankDetailSummary(values);
                bankDetailSummary.classList.remove("team-form__bank-summary--empty");
            } else {
                bankDetailSummary.textContent = "No personal detail added yet.";
                bankDetailSummary.classList.add("team-form__bank-summary--empty");
            }
        };

        const setHiddenBankDetailValues = (values = {}) => {
            const resolved = getBankDetailValues(values);
            if (bankAccountNameHidden) {
                bankAccountNameHidden.value = resolved.bankAccountName;
            }
            if (bankNameHidden) {
                bankNameHidden.value = resolved.bankName;
            }
            if (branchNameHidden) {
                branchNameHidden.value = resolved.branchName;
            }
            if (bankAccountNumberHidden) {
                bankAccountNumberHidden.value = resolved.bankAccountNumber;
            }
            updateBankDetailSummary();
        };

        updateBankDetailSummary();

        const resolveImageUrl = (value) => {
            if (typeof value !== "string") {
                return "";
            }

            const trimmed = value.trim();
            if (!trimmed) {
                return "";
            }

            if (/^https?:\/\//i.test(trimmed)) {
                try {
                    const parsed = new URL(trimmed);
                    if (parsed.hostname === "github.com") {
                        const segments = parsed.pathname.split("/").filter(Boolean);
                        const pivotIndex = segments.findIndex((segment) =>
                            ["blob", "raw"].includes(segment.toLowerCase())
                        );
                        if (pivotIndex !== -1 && pivotIndex + 1 < segments.length) {
                            const rawSegments = [
                                ...segments.slice(0, pivotIndex),
                                ...segments.slice(pivotIndex + 1),
                            ];
                            return `https://raw.githubusercontent.com/${rawSegments.join("/")}`;
                        }
                    }

                    return parsed.toString();
                } catch (_error) {
                    return trimmed;
                }
            }

            return trimmed;
        };

        const formatJoinDate = (value) => {
            if (!value) {
                return "—";
            }

            try {
                const parsed = new Date(value);
                if (Number.isNaN(parsed.getTime())) {
                    return sanitizeText(value);
                }

                return parsed.toLocaleDateString(undefined, {
                    year: "numeric",
                    month: "short",
                    day: "numeric",
                });
            } catch (error) {
                console.warn("Unable to format join date", error);
                return sanitizeText(value);
            }
        };

        const formatDateTime = (value) => {
            if (!value) {
                return "—";
            }

            try {
                const parsed = new Date(value);
                if (Number.isNaN(parsed.getTime())) {
                    return sanitizeText(value);
                }

                return parsed.toLocaleString(undefined, {
                    year: "numeric",
                    month: "short",
                    day: "numeric",
                    hour: "2-digit",
                    minute: "2-digit",
                });
            } catch (error) {
                console.warn("Unable to format date/time", error);
                return sanitizeText(value);
            }
        };

        const renderEmptyState = (message) => {
            if (!emptyState) {
                return;
            }

            if (typeof message === "string") {
                emptyState.textContent = message;
            }

            emptyState.hidden = false;
        };

        const hideEmptyState = () => {
            if (emptyState) {
                emptyState.hidden = true;
            }
        };

        const createCell = (label, value) => {
            const cell = document.createElement("td");
            cell.setAttribute("data-label", label);

            if (value instanceof Node) {
                cell.appendChild(value);
            } else {
                cell.textContent = value;
            }

            return cell;
        };

        const getMemberDisplayName = (member) => {
            const candidates = [member?.name, member?.nickname, member?.regNumber];

            for (const candidate of candidates) {
                if (typeof candidate === "string") {
                    const trimmed = candidate.trim();
                    if (trimmed) {
                        return trimmed;
                    }
                }
            }

            return "Team member";
        };

        const createAvatarElement = (member) => {
            const wrapper = document.createElement("div");
            wrapper.className = "team-table__avatar";

            const displayName = getMemberDisplayName(member);
            const imageUrl = resolveImageUrl(
                typeof member?.image === "string" ? member.image : ""
            );

            const setPlaceholder = () => {
                wrapper.innerHTML = "";
                wrapper.setAttribute("role", "img");
                wrapper.setAttribute(
                    "aria-label",
                    `${displayName} profile placeholder`
                );

                const placeholder = document.createElement("div");
                placeholder.className = "team-table__avatar-placeholder";
                const [firstChar] = Array.from(displayName);
                placeholder.textContent = firstChar
                    ? firstChar.toUpperCase()
                    : "?";
                placeholder.setAttribute("aria-hidden", "true");
                wrapper.appendChild(placeholder);
            };

            if (imageUrl) {
                const img = document.createElement("img");
                img.src = imageUrl;
                img.alt = `${displayName} profile photo`;
                img.loading = "lazy";
                img.decoding = "async";
                img.referrerPolicy = "no-referrer";
                img.addEventListener("error", () => {
                    setPlaceholder();
                });
                wrapper.appendChild(img);
            } else {
                setPlaceholder();
            }

            wrapper.title = `${displayName}'s profile`;

            return wrapper;
        };

        const createPersonalDetailCell = (member) => {
            const container = document.createElement("div");
            container.className = "team-table__personal-detail";

            const detailValues = getMemberBankDetails(member);
            const hasDetail = hasBankDetail(detailValues);

            const actionButton = document.createElement("button");
            actionButton.type = "button";
            actionButton.className =
                "button button--secondary button--small team-table__personal-detail-button";
            actionButton.textContent = hasDetail ? "View" : "Add";
            actionButton.setAttribute(
                "aria-label",
                `${hasDetail ? "View" : "Add"} personal detail for ${getMemberDisplayName(member)}`
            );
            actionButton.addEventListener("click", () => {
                openBankDetailModalForMember(member);
            });
            container.appendChild(actionButton);

            const personalDetailText =
                typeof member?.personalDetail === "string"
                    ? member.personalDetail.trim()
                    : "";
            if (personalDetailText) {
                const note = document.createElement("div");
                note.className = "team-table__personal-detail-note";
                note.textContent = personalDetailText;
                container.appendChild(note);
            }

            return container;
        };

        const getAttendanceRecord = (month, memberKey) => {
            if (!month || !memberKey) {
                return null;
            }
            return attendanceDataStore[month]?.[memberKey] || null;
        };

        const setAttendanceRecord = (month, memberKey, record) => {
            if (!month || !memberKey) {
                return;
            }
            if (!attendanceDataStore[month]) {
                attendanceDataStore[month] = {};
            }
            attendanceDataStore[month][memberKey] = record;
        };

        const removeAttendanceRecord = (month, memberKey) => {
            if (!month || !memberKey || !attendanceDataStore[month]) {
                return;
            }
            delete attendanceDataStore[month][memberKey];
            if (Object.keys(attendanceDataStore[month]).length === 0) {
                delete attendanceDataStore[month];
            }
        };

        const getSalaryRecord = (month, memberKey) => {
            if (!month || !memberKey) {
                return null;
            }
            return salaryDataStore[month]?.[memberKey] || null;
        };

        const getCasualOtRate = (month, memberKey) => {
            if (!month || !memberKey) {
                return "";
            }
            return casualOtRateStore[month]?.[memberKey] ?? "";
        };

        const setCasualOtRate = (month, memberKey, value) => {
            if (!month || !memberKey) {
                return;
            }

            let normalizedValue = "";
            if (typeof value === "string") {
                normalizedValue = value.trim();
            } else if (typeof value === "number" && Number.isFinite(value)) {
                normalizedValue = String(value);
            }

            if (!normalizedValue) {
                removeCasualOtRate(month, memberKey);
                return;
            }

            if (!casualOtRateStore[month]) {
                casualOtRateStore[month] = {};
            }

            casualOtRateStore[month][memberKey] = normalizedValue;
        };

        const removeCasualOtRate = (month, memberKey) => {
            if (!month || !memberKey || !casualOtRateStore[month]) {
                return;
            }
            delete casualOtRateStore[month][memberKey];
            if (Object.keys(casualOtRateStore[month]).length === 0) {
                delete casualOtRateStore[month];
            }
        };

        const setSalaryRecord = (month, memberKey, record) => {
            const normalizedMonth = normalizeMonthValue(month) || month;
            if (!normalizedMonth || !memberKey) {
                return;
            }

            if (!salaryDataStore[normalizedMonth]) {
                salaryDataStore[normalizedMonth] = {};
            }

            salaryDataStore[normalizedMonth][memberKey] = record;

            if (record && typeof record === "object" && record.casualOtRate != null) {
                setCasualOtRate(normalizedMonth, memberKey, record.casualOtRate);
            } else {
                removeCasualOtRate(normalizedMonth, memberKey);
            }
        };

        const removeSalaryRecord = (month, memberKey) => {
            const normalizedMonth = normalizeMonthValue(month) || month;
            if (!normalizedMonth || !memberKey || !salaryDataStore[normalizedMonth]) {
                return;
            }
            delete salaryDataStore[normalizedMonth][memberKey];
            if (Object.keys(salaryDataStore[normalizedMonth]).length === 0) {
                delete salaryDataStore[normalizedMonth];
            }
            removeCasualOtRate(normalizedMonth, memberKey);
        };

        const parseNumericValue = (value) => {
            if (typeof value === "number" && Number.isFinite(value)) {
                return value;
            }
            if (typeof value === "string") {
                const normalized = value.replace(/,/g, "").trim();
                if (!normalized) {
                    return 0;
                }
                const parsed = Number.parseFloat(normalized);
                if (Number.isFinite(parsed)) {
                    return parsed;
                }
            }
            return 0;
        };

        const roundCurrencyValue = (value) => {
            if (!Number.isFinite(value)) {
                return 0;
            }
            const rounded = Math.round((value + Number.EPSILON) * 100) / 100;
            return Math.abs(rounded) < 0.005 ? 0 : rounded;
        };

        const computeOvertimeMinutesForEntry = (iso, entry) => {
            if (!iso || !entry || typeof entry !== "object") {
                return 0;
            }

            const onValue = typeof entry.onTime === "string" ? entry.onTime : "";
            const offValue = typeof entry.offTime === "string" ? entry.offTime : "";

            if (!onValue && !offValue) {
                return 0;
            }

            const payMinutes = computePayMinutes(onValue, offValue);
            if (!Number.isFinite(payMinutes)) {
                return 0;
            }

            const { overtimeMinutes } = computeRegularAndOvertimeMinutes(
                iso,
                onValue,
                offValue,
                payMinutes,
            );

            return Number.isFinite(overtimeMinutes) ? overtimeMinutes : 0;
        };

        const getMonthlyOvertimeMinutes = (month, memberKey) => {
            const normalized = normalizeMonthValue(month);
            if (!normalized || !memberKey) {
                return 0;
            }

            const record = getAttendanceRecord(normalized, memberKey);
            if (!record || typeof record !== "object") {
                return 0;
            }

            let total = 0;
            Object.entries(record).forEach(([iso, entry]) => {
                if (typeof iso !== "string" || !iso.startsWith(normalized)) {
                    return;
                }
                const minutes = computeOvertimeMinutesForEntry(iso, entry);
                if (Number.isFinite(minutes)) {
                    total += minutes;
                }
            });

            return total;
        };

        const getComputedOvertimeAmount = (month, memberKey, member, overrides = {}) => {
            const normalized = normalizeMonthValue(month);
            if (!normalized || !memberKey) {
                return 0;
            }

            const totalMinutes = getMonthlyOvertimeMinutes(normalized, memberKey);
            if (!Number.isFinite(totalMinutes) || totalMinutes <= 0) {
                return 0;
            }

            const totalHours = totalMinutes / 60;
            if (!Number.isFinite(totalHours) || totalHours <= 0) {
                return 0;
            }

            const salaryRecord = getSalaryRecord(normalized, memberKey) || {};
            const payCategory = getMemberPayCategory(member).toLowerCase();
            if (payCategory === "factory") {
                const overrideBasicSalary =
                    overrides && Object.prototype.hasOwnProperty.call(overrides, "basicSalary")
                        ? overrides.basicSalary
                        : salaryRecord?.basicSalary;
                const basicSalary = parseNumericValue(overrideBasicSalary);
                if (!Number.isFinite(basicSalary) || basicSalary <= 0) {
                    return 0;
                }
                return roundCurrencyValue((basicSalary / 200) * 1.5 * totalHours);
            }

            if (payCategory === "casual") {
                if (
                    overrides &&
                    Object.prototype.hasOwnProperty.call(overrides, "casualOtRate")
                ) {
                    const overrideRate = parseNumericValue(overrides.casualOtRate);
                    if (!Number.isFinite(overrideRate) || overrideRate <= 0) {
                        return 0;
                    }
                    return roundCurrencyValue(overrideRate * totalHours);
                }

                let casualRate = parseNumericValue(
                    getCasualOtRate(normalized, memberKey),
                );

                if (!Number.isFinite(casualRate) || casualRate <= 0) {
                    casualRate = parseNumericValue(salaryRecord?.casualOtRate);
                }

                if (!Number.isFinite(casualRate) || casualRate <= 0) {
                    return 0;
                }

                return roundCurrencyValue(casualRate * totalHours);
            }

            return 0;
        };

        const updateAttendanceSummary = (member) => {
            if (attendanceFormMemberName) {
                attendanceFormMemberName.textContent = getMemberDisplayName(member);
            }
            if (attendanceFormRegno) {
                attendanceFormRegno.textContent = sanitizeText(member?.regNumber);
            }
            if (attendanceSummaryMonth) {
                attendanceSummaryMonth.textContent = formatAttendanceMonthLabel(
                    currentSalaryMonth
                );
            }
        };

        const renderAttendanceTableRows = () => {
            if (!attendanceTableBody) {
                return;
            }

            attendanceTableBody.innerHTML = "";
            resetAttendanceTotals();

            const memberKey = attendanceModalContext?.memberKey;
            if (!memberKey) {
                return;
            }

            const entries = getMonthDateEntries(currentSalaryMonth);
            const record = getAttendanceRecord(currentSalaryMonth, memberKey) || {};

            if (entries.length === 0) {
                const row = document.createElement("tr");
                const cell = document.createElement("td");
                cell.colSpan = 7;
                cell.textContent = "No calendar days available for the selected month.";
                row.appendChild(cell);
                attendanceTableBody.appendChild(row);
                resetAttendanceTotals();
                return;
            }

            entries.forEach(({ iso, display }) => {
                const row = document.createElement("tr");
                row.dataset.date = iso;

                row.appendChild(createCell("Date", display));

                const onInput = document.createElement("input");
                onInput.type = "text";
                onInput.name = `on-${iso}`;
                onInput.className = "attendance-table__time-input edit-form__input";
                onInput.placeholder = "HH:MM";
                onInput.pattern = "^(?:[01]?\\d|2[0-3]):[0-5]\\d$";
                onInput.inputMode = "numeric";
                onInput.autocomplete = "off";
                onInput.spellcheck = false;
                onInput.maxLength = 5;
                onInput.setAttribute(
                    "aria-label",
                    `On time for ${display} (24-hour format)`
                );
                const normalizedOnTime = normalizeTimeValue(record?.[iso]?.onTime ?? "");
                if (normalizedOnTime) {
                    onInput.value = normalizedOnTime;
                }

                const offInput = document.createElement("input");
                offInput.type = "text";
                offInput.name = `off-${iso}`;
                offInput.className = "attendance-table__time-input edit-form__input";
                offInput.placeholder = "HH:MM";
                offInput.pattern = "^(?:[01]?\\d|2[0-3]):[0-5]\\d$";
                offInput.inputMode = "numeric";
                offInput.autocomplete = "off";
                offInput.spellcheck = false;
                offInput.maxLength = 5;
                offInput.setAttribute(
                    "aria-label",
                    `Off time for ${display} (24-hour format)`
                );
                const normalizedOffTime = normalizeTimeValue(record?.[iso]?.offTime ?? "");
                if (normalizedOffTime) {
                    offInput.value = normalizedOffTime;
                }

                const actualValue = document.createElement("span");
                actualValue.className = "attendance-table__hours-value";
                actualValue.textContent = "—";

                const payValue = document.createElement("span");
                payValue.className = "attendance-table__hours-value";
                payValue.textContent = "—";

                const overtimeValue = document.createElement("span");
                overtimeValue.className = "attendance-table__hours-value";
                overtimeValue.textContent = "—";

                row.appendChild(createCell("On time", onInput));
                row.appendChild(createCell("Off time", offInput));

                const actualCell = createCell("Actual hours", actualValue);
                actualCell.classList.add("attendance-table__hours-cell");
                row.appendChild(actualCell);

                const payCell = createCell("Pay hours", payValue);
                payCell.classList.add("attendance-table__hours-cell");
                row.appendChild(payCell);

                const overtimeCell = createCell("OT hours", overtimeValue);
                overtimeCell.classList.add("attendance-table__hours-cell");
                row.appendChild(overtimeCell);

                const dayStatusSelect = document.createElement("select");
                dayStatusSelect.name = `status-${iso}`;
                dayStatusSelect.className = "attendance-table__status-select edit-form__input";
                dayStatusSelect.setAttribute("aria-label", `Day status for ${display}`);
                ATTENDANCE_DAY_STATUS_OPTIONS.forEach((label) => {
                    const option = document.createElement("option");
                    option.value = label;
                    option.textContent = label;
                    dayStatusSelect.appendChild(option);
                });

                const dayStatusHidden = document.createElement("input");
                dayStatusHidden.type = "hidden";
                dayStatusHidden.name = `status-${iso}`;
                dayStatusHidden.disabled = true;

                const savedDayStatus = normalizeDayStatusValue(record?.[iso]?.dayStatus);
                if (savedDayStatus) {
                    dayStatusSelect.dataset.initialValue = savedDayStatus;
                    dayStatusSelect.dataset.userValue = savedDayStatus;
                } else {
                    dayStatusSelect.dataset.initialValue = "";
                }
                setDayStatusValue(dayStatusSelect, dayStatusHidden, savedDayStatus);

                dayStatusSelect.addEventListener("change", () => {
                    const normalized = normalizeDayStatusValue(dayStatusSelect.value);
                    if (normalized) {
                        dayStatusSelect.dataset.userValue = normalized;
                    } else {
                        delete dayStatusSelect.dataset.userValue;
                    }
                    setDayStatusValue(dayStatusSelect, dayStatusHidden, normalized);
                });

                const statusContainer = document.createElement("div");
                statusContainer.className = "attendance-table__status";
                statusContainer.appendChild(dayStatusSelect);
                statusContainer.appendChild(dayStatusHidden);
                row.appendChild(createCell("Day Status", statusContainer));

                const refreshHours = () => {
                    updateAttendanceHoursDisplay(
                        row,
                        iso,
                        onInput,
                        offInput,
                        actualValue,
                        payValue,
                        overtimeValue,
                        {
                            dayStatus: {
                                select: dayStatusSelect,
                                hiddenInput: dayStatusHidden,
                            },
                        },
                    );
                };

                onInput.addEventListener("input", refreshHours);
                offInput.addEventListener("input", refreshHours);

                refreshHours();

                attendanceTableBody.appendChild(row);
            });

            updateAttendanceLeaveSummaryDisplay();
        };

        const refreshAttendanceModalContents = () => {
            if (!attendanceModal || attendanceModal.hasAttribute("hidden")) {
                return;
            }

            if (!attendanceModalContext?.member) {
                return;
            }

            updateAttendanceSummary(attendanceModalContext.member);
            renderAttendanceTableRows();
            loadAttendanceLeaveSummaryForModal();
        };

        const closeAttendanceModal = () => {
            if (!attendanceModal) {
                return;
            }

            attendanceModal.classList.remove("modal--open");
            attendanceModal.setAttribute("hidden", "");
            attendanceModal.setAttribute("aria-hidden", "true");
            document.body.classList.remove("modal-open");
            if (attendanceForm) {
                attendanceForm.reset();
            }
            if (attendanceTableBody) {
                attendanceTableBody.innerHTML = "";
                resetAttendanceTotals();
            }
            resetAttendanceLeaveSummaryDisplay();
            if (attendanceFormMemberName) {
                attendanceFormMemberName.textContent = "—";
            }
            if (attendanceFormRegno) {
                attendanceFormRegno.textContent = "—";
            }
            if (attendanceSummaryMonth) {
                attendanceSummaryMonth.textContent = "—";
            }
            attendanceModalContext = null;
            if (attendanceModal?.dataset) {
                delete attendanceModal.dataset.memberKey;
            }
        };

        const openAttendanceModal = (member, providedKey) => {
            if (!attendanceModal || !attendanceForm) {
                return;
            }

            if (salaryModal && !salaryModal.hasAttribute("hidden")) {
                closeSalaryModal();
            }

            const memberKey = providedKey ?? computeMemberKey(member);
            if (!memberKey) {
                return;
            }

            const memberId = parseMemberId(member?.id);
            attendanceModalContext = { member, memberKey, memberId };
            attendanceModal.removeAttribute("hidden");
            attendanceModal.setAttribute("aria-hidden", "false");
            attendanceModal.classList.add("modal--open");
            attendanceModal.dataset.memberKey = memberKey;
            document.body.classList.add("modal-open");

            attendanceForm.reset();
            resetAttendanceLeaveSummaryDisplay();
            updateAttendanceSummary(member);
            renderAttendanceTableRows();
            loadAttendanceLeaveSummaryForModal();

            window.requestAnimationFrame(() => {
                const firstField = attendanceTableBody?.querySelector(
                    ".attendance-table__time-input"
                );
                if (firstField) {
                    firstField.focus();
                }
            });
        };

        const renderSalarySheet = () => {
            if (!salaryTableBody) {
                return;
            }

            salaryTableBody.innerHTML = "";

            if (!Array.isArray(activeMembers) || activeMembers.length === 0) {
                if (salaryEmptyState) {
                    salaryEmptyState.hidden = false;
                }
                return;
            }

            if (salaryEmptyState) {
                salaryEmptyState.hidden = true;
            }

            const monthStore = salaryDataStore[currentSalaryMonth] || {};

            activeMembers.forEach((member, index) => {
                const memberKey = computeMemberKey(member, index);
                const record = memberKey ? monthStore[memberKey] || {} : {};
                const isFactoryMember = isFactoryPayCategory(member);
                const computedAllowance = isFactoryMember
                    ? getComputedAttendanceAllowance(currentSalaryMonth, memberKey)
                    : null;
                const computedTargetAllowance = isFactoryMember
                    ? getComputedTargetAllowance(currentSalaryMonth, memberKey)
                    : null;
                let displayRecord = record;

                if (isFactoryMember) {
                    if (computedAllowance != null) {
                        displayRecord = {
                            ...record,
                            attendanceAllowance: computedAllowance,
                        };
                    }
                    if (computedTargetAllowance != null) {
                        if (displayRecord && typeof displayRecord === "object") {
                            displayRecord = {
                                ...displayRecord,
                                targetAllowance: computedTargetAllowance,
                            };
                        } else {
                            displayRecord = { targetAllowance: computedTargetAllowance };
                        }
                    }
                } else if (record?.attendanceAllowance != null) {
                    displayRecord = {
                        ...record,
                        attendanceAllowance: null,
                    };
                    if (record?.targetAllowance != null) {
                        displayRecord.targetAllowance = null;
                    }
                } else if (record?.targetAllowance != null) {
                    displayRecord = {
                        ...record,
                        targetAllowance: null,
                    };
                }

                const computedOvertimeAmount = getComputedOvertimeAmount(
                    currentSalaryMonth,
                    memberKey,
                    member,
                );
                if (Number.isFinite(computedOvertimeAmount)) {
                    const formattedOvertime = formatNumberForInput(computedOvertimeAmount);
                    if (displayRecord && typeof displayRecord === "object") {
                        displayRecord = {
                            ...displayRecord,
                            overtime: formattedOvertime,
                        };
                    } else {
                        displayRecord = { overtime: formattedOvertime };
                    }
                }
                const row = document.createElement("tr");

                row.appendChild(createCell("Reg No", sanitizeText(member?.regNumber)));

                const nameButton = document.createElement("button");
                nameButton.type = "button";
                nameButton.className = "salary-table__name-button";
                nameButton.textContent = getMemberDisplayName(member);
                nameButton.addEventListener("click", () => {
                    openSalaryModal(member, memberKey);
                });
                row.appendChild(createCell("Name", nameButton));

                const computedProvidentFundAmount = computeProvidentFundAmount(
                    member,
                    displayRecord &&
                        typeof displayRecord === "object" &&
                        displayRecord.basicSalary != null
                        ? displayRecord.basicSalary
                        : record?.basicSalary,
                );

                if (computedProvidentFundAmount != null) {
                    const formattedProvidentFund = formatNumberForInput(
                        computedProvidentFundAmount,
                    );

                    if (displayRecord && typeof displayRecord === "object") {
                        displayRecord = {
                            ...displayRecord,
                            providentFund: formattedProvidentFund,
                        };
                    } else {
                        displayRecord = { providentFund: formattedProvidentFund };
                    }
                } else if (
                    displayRecord &&
                    typeof displayRecord === "object" &&
                    displayRecord.providentFund != null
                ) {
                    displayRecord = { ...displayRecord, providentFund: null };
                }

                salaryFieldDefinitions.forEach(({ label, name }) => {
                    row.appendChild(
                        createCell(label, formatSalaryValue(displayRecord?.[name])),
                    );
                });

                const attendanceButton = document.createElement("button");
                attendanceButton.type = "button";
                attendanceButton.className = "salary-table__action-button";
                attendanceButton.textContent = "Record attendance";
                attendanceButton.addEventListener("click", () => {
                    openAttendanceModal(member, memberKey);
                });
                row.appendChild(createCell("Record Attendance", attendanceButton));

                const salaryButton = document.createElement("button");
                salaryButton.type = "button";
                salaryButton.className = "salary-table__action-button";
                salaryButton.textContent = "Update salary";
                salaryButton.addEventListener("click", () => {
                    openSalaryModal(member, memberKey);
                });
                row.appendChild(createCell("Manage Salary", salaryButton));

                salaryTableBody.appendChild(row);
            });
        };

        const setActiveMembers = (members) => {
            if (!Array.isArray(members)) {
                activeMembers = [];
                memberKeyById.clear();
                renderSalarySheet();
                return;
            }

            activeMembers = members.filter(
                (member) => normalizeStatus(member?.status) === "Active"
            );

            memberKeyById.clear();
            activeMembers.forEach((member, index) => {
                const key = computeMemberKey(member, index);
                const memberId = parseMemberId(member?.id);
                if (key && memberId != null) {
                    memberKeyById.set(memberId, key);
                }
            });
            renderSalarySheet();
        };

        const populateSalaryFormFields = (record, { memberKey, month, member } = {}) => {
            if (!salaryForm) {
                return;
            }

            const contextMember = member ?? salaryModalContext?.member ?? null;
            const targetMemberKey = memberKey ?? salaryModalContext?.memberKey ?? null;
            const targetMonth =
                normalizeMonthValue(month) ||
                normalizeMonthValue(salaryFormMonth?.value) ||
                normalizeMonthValue(currentSalaryMonth) ||
                currentSalaryMonth;
            const isFactoryMember = isFactoryPayCategory(contextMember);
            const computedAllowance = isFactoryMember
                ? getComputedAttendanceAllowance(targetMonth, targetMemberKey)
                : null;
            const computedTargetAllowance = isFactoryMember
                ? getComputedTargetAllowance(targetMonth, targetMemberKey)
                : null;

            salaryFieldDefinitions.forEach(({ name }) => {
                const input = salaryForm.elements[name];
                if (input) {
                    let value = record?.[name] ?? "";

                    input.readOnly = false;
                    input.removeAttribute("aria-readonly");
                    input.disabled = false;

                    if (name === "attendanceAllowance") {
                        input.disabled = !isFactoryMember;

                        if (!isFactoryMember) {
                            input.value = "";
                            return;
                        }

                        if (computedAllowance != null) {
                            value = formatNumberForInput(computedAllowance);
                        }
                    } else if (name === "targetAllowance") {
                        input.disabled = !isFactoryMember;

                        if (!isFactoryMember) {
                            input.value = "";
                            return;
                        }

                        if (computedTargetAllowance != null) {
                            value = formatNumberForInput(computedTargetAllowance);
                        }
                    } else if (name === "overtime") {
                        input.disabled = false;
                        input.readOnly = true;
                        input.setAttribute("aria-readonly", "true");

                        const overtimeAmount = getComputedOvertimeAmount(
                            targetMonth,
                            targetMemberKey,
                            contextMember,
                            record || {},
                        );
                        if (Number.isFinite(overtimeAmount)) {
                            value = formatNumberForInput(overtimeAmount);
                        } else {
                            value = "";
                        }
                    } else if (name === "providentFund") {
                        input.readOnly = true;
                        input.setAttribute("aria-readonly", "true");

                        const computedAmount = computeProvidentFundAmount(
                            contextMember,
                            record?.basicSalary ??
                                salaryForm.elements?.basicSalary?.value ??
                                value,
                        );

                        if (computedAmount == null) {
                            input.value = "";
                            return;
                        }

                        value = formatNumberForInput(computedAmount);
                    }

                    input.value = value ?? "";
                }
            });

            const casualOtRateInput = salaryForm.elements?.casualOtRate;
            if (casualOtRateInput) {
                let storedCasualOtRate = getCasualOtRate(targetMonth, targetMemberKey);
                if (!storedCasualOtRate && record?.casualOtRate != null) {
                    setCasualOtRate(targetMonth, targetMemberKey, record.casualOtRate);
                    storedCasualOtRate = getCasualOtRate(targetMonth, targetMemberKey);
                }

                if (!storedCasualOtRate) {
                    removeCasualOtRate(targetMonth, targetMemberKey);
                }

                casualOtRateInput.value = storedCasualOtRate;
            }

            refreshSalaryFormOvertime();
            refreshSalaryFormProvidentFund({ basicSalary: record?.basicSalary });
        };

        const refreshSalaryFormOvertime = () => {
            if (!salaryForm) {
                return;
            }

            const overtimeInput = salaryForm.elements?.overtime;
            if (!overtimeInput) {
                return;
            }

            const member = salaryModalContext?.member ?? null;
            const memberKey = salaryModalContext?.memberKey ?? null;
            const normalizedMonth =
                normalizeMonthValue(salaryFormMonth?.value) ||
                normalizeMonthValue(currentSalaryMonth) ||
                currentSalaryMonth;

            const overrides = {};
            const basicSalaryInput = salaryForm.elements?.basicSalary;
            if (basicSalaryInput && typeof basicSalaryInput.value === "string") {
                overrides.basicSalary = basicSalaryInput.value;
            }

            const casualOtRateInput = salaryForm.elements?.casualOtRate;
            if (casualOtRateInput && typeof casualOtRateInput.value === "string") {
                overrides.casualOtRate = casualOtRateInput.value;
            }

            const amount = getComputedOvertimeAmount(
                normalizedMonth,
                memberKey,
                member,
                overrides,
            );

            overtimeInput.value = Number.isFinite(amount)
                ? formatNumberForInput(amount)
                : "";
        };

        const refreshSalaryFormProvidentFund = (overrides = {}) => {
            if (!salaryForm) {
                return;
            }

            const providentFundInput = salaryForm.elements?.providentFund;
            if (!providentFundInput) {
                return;
            }

            providentFundInput.readOnly = true;
            providentFundInput.setAttribute("aria-readonly", "true");

            const member = salaryModalContext?.member ?? null;
            const basicOverride = overrides?.basicSalary;
            const basicValue =
                basicOverride != null
                    ? basicOverride
                    : salaryForm.elements?.basicSalary?.value;

            const amount = computeProvidentFundAmount(member, basicValue);

            if (amount == null) {
                providentFundInput.value = "";
                return;
            }

            providentFundInput.value = formatNumberForInput(amount);
        };

        if (salaryForm?.elements?.basicSalary) {
            salaryForm.elements.basicSalary.addEventListener(
                "input",
                (event) => {
                    refreshSalaryFormOvertime();
                    refreshSalaryFormProvidentFund({
                        basicSalary:
                            typeof event?.target?.value === "string"
                                ? event.target.value
                                : undefined,
                    });
                },
            );
        }

        if (salaryForm?.elements?.casualOtRate) {
            const casualOtRateInput = salaryForm.elements.casualOtRate;
            const persistCasualOtRate = () => {
                if (!salaryModalContext?.memberKey) {
                    return;
                }

                const normalizedMonth =
                    normalizeMonthValue(salaryFormMonth?.value) ||
                    normalizeMonthValue(currentSalaryMonth) ||
                    currentSalaryMonth;
                const value =
                    typeof casualOtRateInput.value === "string"
                        ? casualOtRateInput.value
                        : "";

                if (value.trim()) {
                    setCasualOtRate(normalizedMonth, salaryModalContext.memberKey, value);
                } else {
                    removeCasualOtRate(normalizedMonth, salaryModalContext.memberKey);
                }

                refreshSalaryFormOvertime();
            };

            casualOtRateInput.addEventListener("input", persistCasualOtRate);
            casualOtRateInput.addEventListener("change", persistCasualOtRate);
        }

        const closeSalaryModal = () => {
            if (!salaryModal) {
                return;
            }
            salaryModal.setAttribute("hidden", "");
            salaryModal.setAttribute("aria-hidden", "true");
            salaryModal.classList.remove("modal--open");
            document.body.classList.remove("modal-open");
            if (salaryForm) {
                salaryForm.reset();
            }
            if (salaryFormMonth) {
                salaryFormMonth.value = currentSalaryMonth;
            }
            salaryModalContext = null;
            if (salaryModal?.dataset) {
                delete salaryModal.dataset.memberKey;
            }
        };

        const openSalaryModal = (member, providedKey) => {
            if (!salaryModal || !salaryForm) {
                return;
            }

            if (attendanceModal && !attendanceModal.hasAttribute("hidden")) {
                closeAttendanceModal();
            }

            const memberKey = providedKey ?? computeMemberKey(member);
            if (!memberKey) {
                return;
            }

            const memberId = parseMemberId(member?.id);
            salaryModalContext = { member, memberKey, memberId };
            salaryModal.removeAttribute("hidden");
            salaryModal.setAttribute("aria-hidden", "false");
            salaryModal.classList.add("modal--open");
            salaryModal.dataset.memberKey = memberKey;
            document.body.classList.add("modal-open");

            const displayName = getMemberDisplayName(member);
            if (salaryModalTitle) {
                salaryModalTitle.textContent = `Update salary for ${displayName}`;
            }
            if (salaryFormMemberName) {
                salaryFormMemberName.textContent = displayName;
            }
            if (salaryFormRegno) {
                salaryFormRegno.textContent = sanitizeText(member?.regNumber);
            }
            if (salaryFormMonth) {
                salaryFormMonth.value = currentSalaryMonth;
            }

            populateSalaryFormFields(getSalaryRecord(currentSalaryMonth, memberKey), {
                memberKey,
                month: currentSalaryMonth,
                member,
            });

            window.requestAnimationFrame(() => {
                const firstEditableField = salaryForm.querySelector(
                    "input[name='basicSalary']"
                );
                if (firstEditableField) {
                    firstEditableField.focus();
                }
            });
        };

        const setBankDetailFormValues = (values = {}) => {
            const resolved = getBankDetailValues(values);
            Object.entries(bankDetailFieldInputs).forEach(([field, input]) => {
                if (!input) {
                    return;
                }
                input.value = resolved[field];
            });
        };

        const getBankDetailFormValues = () => {
            const values = {};
            Object.entries(bankDetailFieldInputs).forEach(([field, input]) => {
                values[field] = input?.value ?? "";
            });
            return getBankDetailValues(values);
        };

        const resetBankDetailFeedback = () => {
            if (bankDetailError) {
                bankDetailError.hidden = true;
                bankDetailError.textContent = "";
            }
            if (bankDetailSuccess) {
                bankDetailSuccess.hidden = true;
                bankDetailSuccess.textContent = "";
            }
        };

        const showBankDetailError = (message) => {
            if (!bankDetailError) {
                return;
            }
            bankDetailError.textContent = message;
            bankDetailError.hidden = false;
            if (bankDetailSuccess) {
                bankDetailSuccess.hidden = true;
                bankDetailSuccess.textContent = "";
            }
        };

        const showBankDetailSuccess = (message) => {
            if (!bankDetailSuccess) {
                return;
            }
            bankDetailSuccess.textContent = message;
            bankDetailSuccess.hidden = false;
            if (bankDetailError) {
                bankDetailError.hidden = true;
                bankDetailError.textContent = "";
            }
        };

        const setBankDetailHint = (text) => {
            if (!bankDetailHint) {
                return;
            }
            const normalized = typeof text === "string" ? text.trim() : "";
            if (normalized) {
                bankDetailHint.textContent = normalized;
                bankDetailHint.hidden = false;
            } else {
                bankDetailHint.textContent = "";
                bankDetailHint.hidden = true;
            }
        };

        const setBankDetailFieldsDisabled = (disabled) => {
            Object.values(bankDetailFieldInputs).forEach((input) => {
                if (input) {
                    input.disabled = disabled;
                }
            });
        };

        const updateBankDetailControls = () => {
            const contextType = bankDetailModalState?.context?.type;
            const editing =
                contextType === "form" || bankDetailModalState?.editing === true;
            const loading = bankDetailModalState?.loading === true;

            if (bankDetailEditToggle) {
                if (contextType === "member") {
                    bankDetailEditToggle.hidden = false;
                    bankDetailEditToggle.textContent = editing
                        ? "Cancel edit"
                        : "Edit";
                    bankDetailEditToggle.disabled = loading;
                } else {
                    bankDetailEditToggle.hidden = true;
                    bankDetailEditToggle.disabled = false;
                }
            }

            if (bankDetailSaveButton) {
                const disableSave = loading || (contextType === "member" && !editing);
                bankDetailSaveButton.disabled = disableSave;
            }
        };

        const setBankDetailEditing = (editing, { focusField = true } = {}) => {
            if (!bankDetailModalState) {
                return;
            }
            const contextType = bankDetailModalState.context?.type;
            if (contextType === "form") {
                editing = true;
            }

            bankDetailModalState = {
                ...bankDetailModalState,
                editing,
            };

            const disableFields = contextType === "member" ? !editing : false;
            setBankDetailFieldsDisabled(disableFields);

            if (!editing && bankDetailModalState.values) {
                setBankDetailFormValues(bankDetailModalState.values);
            }

            updateBankDetailControls();

            if (editing && focusField) {
                window.requestAnimationFrame(() => {
                    bankDetailAccountNameInput?.focus();
                });
            }
        };

        const setBankDetailLoading = (loading) => {
            if (!bankDetailModalState) {
                return;
            }
            bankDetailModalState = {
                ...bankDetailModalState,
                loading,
            };

            if (loading) {
                setBankDetailFieldsDisabled(true);
            } else {
                const contextType = bankDetailModalState.context?.type;
                const disableFields = contextType === "member" ? !bankDetailModalState.editing : false;
                setBankDetailFieldsDisabled(disableFields);
            }

            updateBankDetailControls();
        };

        const closeBankDetailModal = () => {
            if (!bankDetailModal) {
                return;
            }
            bankDetailModal.classList.remove("modal--open");
            bankDetailModal.setAttribute("hidden", "");
            bankDetailModal.setAttribute("aria-hidden", "true");
            document.body.classList.remove("modal-open");
            if (bankDetailForm) {
                bankDetailForm.reset();
            }
            if (bankDetailModal?.dataset) {
                delete bankDetailModal.dataset.memberId;
            }
            resetBankDetailFeedback();
            setBankDetailHint("");
            bankDetailModalState = null;
        };

        const openBankDetailModalForForm = () => {
            if (!bankDetailModal || !bankDetailForm) {
                return;
            }

            if (attendanceModal && !attendanceModal.hasAttribute("hidden")) {
                closeAttendanceModal();
            }
            if (salaryModal && !salaryModal.hasAttribute("hidden")) {
                closeSalaryModal();
            }

            const values = getHiddenBankDetailValues();
            bankDetailModalState = {
                context: { type: "form" },
                editing: true,
                loading: false,
                values,
            };

            resetBankDetailFeedback();
            setBankDetailHint("These details will be submitted with the team member.");
            setBankDetailFormValues(values);
            setBankDetailFieldsDisabled(false);
            updateBankDetailControls();

            bankDetailModal.removeAttribute("hidden");
            bankDetailModal.setAttribute("aria-hidden", "false");
            bankDetailModal.classList.add("modal--open");
            document.body.classList.add("modal-open");

            window.requestAnimationFrame(() => {
                bankDetailAccountNameInput?.focus();
            });
        };

        const openBankDetailModalForMember = async (member) => {
            if (!bankDetailModal || !bankDetailForm) {
                return;
            }

            const memberId = parseMemberId(member?.id);
            if (memberId == null) {
                return;
            }

            if (attendanceModal && !attendanceModal.hasAttribute("hidden")) {
                closeAttendanceModal();
            }
            if (salaryModal && !salaryModal.hasAttribute("hidden")) {
                closeSalaryModal();
            }

            const displayName = getMemberDisplayName(member);
            bankDetailModalState = {
                context: { type: "member", memberId, member, displayName },
                editing: false,
                loading: true,
                values: getBankDetailValues({}),
            };

            resetBankDetailFeedback();
            setBankDetailHint(`Loading personal detail for ${displayName}…`);
            setBankDetailFormValues({});
            setBankDetailFieldsDisabled(true);
            updateBankDetailControls();

            bankDetailModal.removeAttribute("hidden");
            bankDetailModal.setAttribute("aria-hidden", "false");
            bankDetailModal.classList.add("modal--open");
            document.body.classList.add("modal-open");
            bankDetailModal.dataset.memberId = String(memberId);

            try {
                const response = await fetch(
                    `/api/team/members/${memberId}/personal-detail`,
                    {
                        headers: authHeaders,
                    }
                );

                if (response.status === 401) {
                    logoutButton.click();
                    return;
                }

                if (!response.ok) {
                    const errorBody = await response.json().catch(() => null);
                    const message = errorBody?.msg || `Request failed with status ${response.status}`;
                    throw new Error(message);
                }

                const data = await response.json();
                const values = getBankDetailValues(data);
                const hasExisting = hasBankDetail(values);

                bankDetailModalState = {
                    context: { type: "member", memberId, member, displayName },
                    editing: hasExisting ? false : true,
                    loading: false,
                    values,
                };

                setBankDetailFormValues(values);
                setBankDetailHint(
                    hasExisting
                        ? `Viewing personal detail for ${displayName}.`
                        : `Add personal detail for ${displayName}.`
                );
                setBankDetailEditing(bankDetailModalState.editing, { focusField: hasExisting === false });
            } catch (error) {
                console.error("Failed to load personal detail", error);
                bankDetailModalState = {
                    context: { type: "member", memberId, member, displayName },
                    editing: false,
                    loading: false,
                    values: getBankDetailValues({}),
                };
                setBankDetailFormValues({});
                setBankDetailFieldsDisabled(true);
                updateBankDetailControls();
                showBankDetailError(
                    error?.message || "Unable to load personal detail. Please try again."
                );
                setBankDetailHint(`Personal detail is unavailable for ${displayName}.`);
            }
        };


        if (workdayModalClose) {
            workdayModalClose.addEventListener("click", () => {
                closeWorkdayModal();
            });
        }

        if (workdayModalCancel) {
            workdayModalCancel.addEventListener("click", () => {
                closeWorkdayModal();
            });
        }

        if (workdayModal) {
            workdayModal.addEventListener("click", (event) => {
                if (event.target?.dataset?.modalDismiss !== undefined) {
                    closeWorkdayModal();
                }
            });
        }

        if (attendanceModalClose) {
            attendanceModalClose.addEventListener("click", () => {
                closeAttendanceModal();
            });
        }

        if (attendanceModalCancel) {
            attendanceModalCancel.addEventListener("click", () => {
                closeAttendanceModal();
            });
        }

        if (attendanceModal) {
            attendanceModal.addEventListener("click", (event) => {
                if (event.target?.dataset?.modalDismiss !== undefined) {
                    closeAttendanceModal();
                }
            });
        }

        if (salaryModalClose) {
            salaryModalClose.addEventListener("click", () => {
                closeSalaryModal();
            });
        }

        if (salaryModalCancel) {
            salaryModalCancel.addEventListener("click", () => {
                closeSalaryModal();
            });
        }

        if (salaryModal) {
            salaryModal.addEventListener("click", (event) => {
                if (event.target?.dataset?.modalDismiss !== undefined) {
                    closeSalaryModal();
                }
            });
        }

        if (bankDetailModalClose) {
            bankDetailModalClose.addEventListener("click", () => {
                closeBankDetailModal();
            });
        }

        if (bankDetailModalCancel) {
            bankDetailModalCancel.addEventListener("click", () => {
                closeBankDetailModal();
            });
        }

        if (bankDetailModal) {
            bankDetailModal.addEventListener("click", (event) => {
                if (event.target?.dataset?.modalDismiss !== undefined) {
                    closeBankDetailModal();
                }
            });
        }

        if (bankDetailEditToggle) {
            bankDetailEditToggle.addEventListener("click", () => {
                if (!bankDetailModalState || bankDetailModalState.context?.type !== "member") {
                    return;
                }

                const currentlyEditing = bankDetailModalState.editing === true;
                resetBankDetailFeedback();

                if (currentlyEditing) {
                    setBankDetailEditing(false, { focusField: false });
                    const displayName = bankDetailModalState.context?.displayName;
                    if (displayName) {
                        setBankDetailHint(`Viewing personal detail for ${displayName}.`);
                    }
                } else {
                    setBankDetailEditing(true);
                    const displayName = bankDetailModalState.context?.displayName;
                    if (displayName) {
                        setBankDetailHint(`Editing personal detail for ${displayName}.`);
                    }
                }
            });
        }

        document.addEventListener("keydown", (event) => {
            if (event.key !== "Escape") {
                return;
            }

            if (workdayModal && !workdayModal.hasAttribute("hidden")) {
                closeWorkdayModal();
                return;
            }

            if (attendanceModal && !attendanceModal.hasAttribute("hidden")) {
                closeAttendanceModal();
                return;
            }

            if (bankDetailModal && !bankDetailModal.hasAttribute("hidden")) {
                closeBankDetailModal();
                return;
            }

            if (salaryModal && !salaryModal.hasAttribute("hidden")) {
                closeSalaryModal();
            }
        });

        if (workdayForm) {
            workdayForm.addEventListener("submit", async (event) => {
                event.preventDefault();

                if (!workdayModalContext?.iso) {
                    closeWorkdayModal();
                    return;
                }

                const iso = workdayModalContext.iso;
                const isWorkDay = workdayStatusWork?.checked !== false;
                const holidayName =
                    !isWorkDay && workdayHolidayInput
                        ? workdayHolidayInput.value.trim()
                        : "";

                if (workdayFormError) {
                    workdayFormError.hidden = true;
                    workdayFormError.textContent = "";
                }

                if (workdayModalSave) {
                    workdayModalSave.disabled = true;
                }

                try {
                    const response = await fetch(
                        `/api/team/work-calendar/${encodeURIComponent(iso)}`,
                        {
                            method: "PUT",
                            headers: {
                                ...authHeaders,
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                isWorkDay,
                                holidayName: isWorkDay ? null : holidayName || null,
                            }),
                        },
                    );

                    let data = null;
                    try {
                        data = await response.json();
                    } catch (_error) {
                        data = null;
                    }

                    if (!response.ok) {
                        const message = data?.msg || "Unable to save the selected day.";
                        if (workdayFormError) {
                            workdayFormError.textContent = message;
                            workdayFormError.hidden = false;
                        } else {
                            window.alert(message);
                        }
                        return;
                    }

                    updateWorkCalendarStoreEntry(iso, data);
                    closeWorkdayModal();
                    renderWorkCalendar();

                    const label = workCalendarDateFormatter.format(createColomboDate(iso));
                    showWorkCalendarMessage(
                        `Saved calendar settings for ${label}.`,
                        "success",
                    );

                    const isoParts = parseIsoDate(iso);
                    if (isoParts) {
                        const normalizedMonth = normalizeMonthValue(
                            getMonthKey(isoParts.year, isoParts.month),
                        );

                        if (normalizedMonth) {
                            try {
                                await updateComputedAttendanceAllowances(normalizedMonth);
                            } catch (error) {
                                console.error(
                                    "Failed to refresh attendance allowance after calendar update",
                                    error,
                                );
                            }

                            if (
                                normalizeMonthValue(currentSalaryMonth) === normalizedMonth
                            ) {
                                renderSalarySheet();

                                if (salaryModalContext?.memberKey) {
                                    populateSalaryFormFields(
                                        getSalaryRecord(
                                            normalizedMonth,
                                            salaryModalContext.memberKey,
                                        ),
                                        {
                                            memberKey: salaryModalContext.memberKey,
                                            month: normalizedMonth,
                                            member: salaryModalContext.member,
                                        },
                                    );
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error("Failed to save work calendar day", error);
                    if (workdayFormError) {
                        workdayFormError.textContent =
                            "Unable to save the selected day. Please try again.";
                        workdayFormError.hidden = false;
                    } else {
                        window.alert(
                            "Unable to save the selected day. Please try again.",
                        );
                    }
                } finally {
                    if (workdayModalSave) {
                        workdayModalSave.disabled = false;
                    }
                }
            });
        }

        if (attendanceForm) {
            attendanceForm.addEventListener("submit", async (event) => {
                event.preventDefault();

                if (!attendanceForm.checkValidity()) {
                    attendanceForm.reportValidity();
                    return;
                }

                if (!attendanceModalContext?.memberKey) {
                    closeAttendanceModal();
                    return;
                }

                const normalizedMonth = normalizeMonthValue(currentSalaryMonth) || currentSalaryMonth;
                if (!normalizedMonth) {
                    window.alert("Select a valid month before saving attendance.");
                    return;
                }

                const formData = new FormData(attendanceForm);
                const entries = getMonthDateEntries(normalizedMonth);
                const record = {};

                entries.forEach(({ iso }) => {
                    const onValueRaw = formData.get(`on-${iso}`);
                    const offValueRaw = formData.get(`off-${iso}`);
                    const statusValueRaw = formData.get(`status-${iso}`);
                    const onValue = normalizeTimeValue(
                        typeof onValueRaw === "string" ? onValueRaw : ""
                    );
                    const offValue = normalizeTimeValue(
                        typeof offValueRaw === "string" ? offValueRaw : ""
                    );
                    const dayStatus = normalizeDayStatusValue(
                        typeof statusValueRaw === "string" ? statusValueRaw : ""
                    );
                    const includeDayStatus =
                        dayStatus &&
                        (dayStatus !== "Work Day" ||
                            onValue ||
                            offValue ||
                            !isWorkCalendarDateWorkDay(iso));

                    if (onValue || offValue || includeDayStatus) {
                        const entry = {};
                        if (onValue) {
                            entry.onTime = onValue;
                        }
                        if (offValue) {
                            entry.offTime = offValue;
                        }
                        if (includeDayStatus) {
                            entry.dayStatus = dayStatus;
                        }
                        record[iso] = entry;
                    }
                });

                const { memberId, memberKey } = attendanceModalContext;
                let responseData = null;

                if (memberId != null) {
                    try {
                        const response = await fetch(`/api/team/attendance/${memberId}`, {
                            method: "PUT",
                            headers: {
                                ...authHeaders,
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({ month: normalizedMonth, entries: record }),
                        });

                        if (response.status === 401) {
                            logoutButton.click();
                            return;
                        }

                        responseData = await response.json().catch(() => ({}));

                        if (!response.ok) {
                            const message = responseData?.msg || "Unable to save attendance.";
                            window.alert(message);
                            return;
                        }
                    } catch (error) {
                        console.error("Failed to save attendance", error);
                        window.alert("Unable to save attendance. Please try again.");
                        return;
                    }
                }

                if (Object.keys(record).length > 0) {
                    const payload =
                        responseData?.entries && typeof responseData.entries === "object"
                            ? responseData.entries
                            : record;
                    setAttendanceRecord(normalizedMonth, memberKey, payload);
                } else {
                    removeAttendanceRecord(normalizedMonth, memberKey);
                }

                if (
                    responseData &&
                    Object.prototype.hasOwnProperty.call(responseData, "leaveSummary")
                ) {
                    setAttendanceLeaveSummaryRecord(
                        normalizedMonth,
                        memberKey,
                        responseData.leaveSummary,
                    );
                }

                try {
                    await updateComputedAttendanceAllowances(normalizedMonth);
                } catch (error) {
                    console.error(
                        "Failed to update attendance allowance after attendance save",
                        error,
                    );
                }

                renderSalarySheet();

                if (
                    salaryModalContext?.memberKey &&
                    normalizeMonthValue(salaryFormMonth?.value || currentSalaryMonth) ===
                        normalizedMonth
                ) {
                    populateSalaryFormFields(
                        getSalaryRecord(normalizedMonth, salaryModalContext.memberKey),
                        {
                            memberKey: salaryModalContext.memberKey,
                            month: normalizedMonth,
                            member: salaryModalContext.member,
                        },
                    );
                }

                closeAttendanceModal();
            });
        }

        if (bankDetailForm) {
            bankDetailForm.addEventListener("submit", async (event) => {
                event.preventDefault();

                if (!bankDetailModalState) {
                    closeBankDetailModal();
                    return;
                }

                resetBankDetailFeedback();

                const values = getBankDetailFormValues();
                const contextType = bankDetailModalState.context?.type;

                if (contextType === "form") {
                    setHiddenBankDetailValues(values);
                    closeBankDetailModal();
                    return;
                }

                const memberId = bankDetailModalState.context?.memberId;
                if (memberId == null) {
                    showBankDetailError(
                        "Unable to determine which member to update. Please close and try again."
                    );
                    return;
                }

                setBankDetailLoading(true);

                try {
                    const response = await fetch(
                        `/api/team/members/${memberId}/personal-detail`,
                        {
                            method: "PATCH",
                            headers: {
                                ...authHeaders,
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify(values),
                        }
                    );

                    if (response.status === 401) {
                        logoutButton.click();
                        return;
                    }

                    if (!response.ok) {
                        const errorBody = await response.json().catch(() => null);
                        const message =
                            errorBody?.msg || `Request failed with status ${response.status}`;
                        throw new Error(message);
                    }

                    const payload = await response.json();
                    const savedValues = getBankDetailValues(payload);
                    bankDetailModalState = {
                        ...bankDetailModalState,
                        values: savedValues,
                        editing: false,
                        loading: false,
                    };
                    setBankDetailFormValues(savedValues);
                    setBankDetailFieldsDisabled(true);
                    updateBankDetailControls();
                    const displayName = bankDetailModalState.context?.displayName;
                    if (displayName) {
                        setBankDetailHint(`Viewing personal detail for ${displayName}.`);
                    }
                    showBankDetailSuccess("Personal detail saved.");
                    await loadTeamMembers();
                } catch (error) {
                    console.error("Failed to update personal detail", error);
                    showBankDetailError(
                        error?.message || "Unable to save personal detail."
                    );
                } finally {
                    setBankDetailLoading(false);
                }
            });
        }

        if (salaryFormMonth) {
            salaryFormMonth.addEventListener("change", (event) => {
                const normalized = normalizeMonthValue(event.target.value);
                if (!normalized) {
                    event.target.value = currentSalaryMonth;
                    return;
                }

                const memberKey = salaryModalContext?.memberKey;
                if (!memberKey) {
                    return;
                }

                populateSalaryFormFields(getSalaryRecord(normalized, memberKey), {
                    memberKey,
                    month: normalized,
                    member: salaryModalContext?.member,
                });
            });
        }

        if (salaryForm) {
            salaryForm.addEventListener("submit", async (event) => {
                event.preventDefault();

                if (!salaryModalContext?.memberKey) {
                    closeSalaryModal();
                    return;
                }

                const formData = new FormData(salaryForm);
                const monthRaw = formData.get("salaryMonth");
                const normalizedMonth = normalizeMonthValue(monthRaw) || currentSalaryMonth;
                const record = {};

                salaryFieldDefinitions.forEach(({ name }) => {
                    const rawValue = formData.get(name);
                    if (typeof rawValue === "string") {
                        const trimmed = rawValue.trim();
                        if (trimmed) {
                            record[name] = trimmed;
                        }
                    }
                });

                const casualOtRateField = salaryForm.elements?.casualOtRate;
                if (casualOtRateField && typeof casualOtRateField.value === "string") {
                    const trimmedRate = casualOtRateField.value.trim();
                    if (trimmedRate) {
                        record.casualOtRate = trimmedRate;
                        setCasualOtRate(normalizedMonth, salaryModalContext.memberKey, trimmedRate);
                    } else {
                        delete record.casualOtRate;
                        removeCasualOtRate(normalizedMonth, salaryModalContext.memberKey);
                    }
                }

                if (!isFactoryPayCategory(salaryModalContext?.member)) {
                    delete record.attendanceAllowance;
                }

                delete record.overtime;

                const { memberId, memberKey } = salaryModalContext;
                let responseData = null;

                if (memberId != null) {
                    try {
                        const response = await fetch(`/api/team/salary/${memberId}`, {
                            method: "PUT",
                            headers: {
                                ...authHeaders,
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({ month: normalizedMonth, components: record }),
                        });

                        if (response.status === 401) {
                            logoutButton.click();
                            return;
                        }

                        responseData = await response.json().catch(() => ({}));

                        if (!response.ok) {
                            const message = responseData?.msg || "Unable to save salary details.";
                            window.alert(message);
                            return;
                        }
                    } catch (error) {
                        console.error("Failed to save salary record", error);
                        window.alert("Unable to save salary. Please try again.");
                        return;
                    }
                }

                if (Object.keys(record).length > 0) {
                    const payload =
                        responseData?.components && typeof responseData.components === "object"
                            ? responseData.components
                            : record;
                    setSalaryRecord(normalizedMonth, memberKey, payload);
                } else {
                    removeSalaryRecord(normalizedMonth, memberKey);
                }

                currentSalaryMonth = normalizedMonth;
                if (salaryMonthSelector) {
                    salaryMonthSelector.value = currentSalaryMonth;
                }

                closeSalaryModal();

                try {
                    await refreshMonthData(currentSalaryMonth);
                } catch (error) {
                    console.error("Failed to refresh monthly data after salary update", error);
                    renderSalarySheet();
                }
            });
        }

        const isEditingMember = () => editingMemberId != null;

        const setSelectValue = (select, value) => {
            if (!select) {
                return;
            }

            const options = Array.from(select.options || []);
            const normalized =
                typeof value === "string"
                    ? value
                    : value != null
                    ? String(value)
                    : "";

            const match = options.find((option) => option.value === normalized);

            if (match) {
                select.value = match.value;
            } else if (options.length > 0) {
                select.value = options[0].value;
            } else {
                select.value = "";
            }
        };

        const setFieldValue = (field, value) => {
            if (!field) {
                return;
            }

            if (typeof value === "string") {
                field.value = value;
                return;
            }

            if (value == null) {
                field.value = "";
                return;
            }

            field.value = String(value);
        };

        const exitEditMode = () => {
            editingMemberId = null;

            if (teamForm?.dataset) {
                delete teamForm.dataset.mode;
                delete teamForm.dataset.memberId;
            }

            if (teamForm) {
                teamForm.reset();
            }

            setHiddenBankDetailValues({});

            if (regNumberInput) {
                regNumberInput.disabled = false;
            }

            if (teamFormSubmitButton) {
                teamFormSubmitButton.textContent = "Save member";
            }

            if (teamFormEditingBanner) {
                teamFormEditingBanner.hidden = true;
            }

            if (teamFormEditingName) {
                teamFormEditingName.textContent = "";
            }

            if (teamFormCancelEditFooter) {
                teamFormCancelEditFooter.hidden = true;
                teamFormCancelEditFooter.disabled = false;
            }

            if (teamFormCancelEditBanner) {
                teamFormCancelEditBanner.disabled = false;
            }

            window.requestAnimationFrame(() => {
                if (teamForm) {
                    const firstField = teamForm.querySelector(
                        "input:not([type='hidden']):not([disabled]), textarea, select"
                    );
                    firstField?.focus();
                }
            });
        };

        const enterEditMode = (member) => {
            if (!teamForm || !canManageMembers) {
                return;
            }

            const memberId = parseMemberId(member?.id);

            if (memberId == null) {
                return;
            }

            editingMemberId = memberId;

            if (teamForm.dataset) {
                teamForm.dataset.mode = "edit";
                teamForm.dataset.memberId = String(memberId);
            }

            resetFormFeedback();

            const displayName = getMemberDisplayName(member);

            setFieldValue(regNumberInput, member?.regNumber);

            if (regNumberInput) {
                regNumberInput.disabled = true;
            }

            setFieldValue(nameInput, member?.name);
            setFieldValue(nicknameInput, member?.nickname);
            setFieldValue(epfInput, member?.epf);
            setFieldValue(positionInput, member?.position);
            setSelectValue(payCategorySelect, member?.payCategory);

            const normalizedJoinDate = toYyyyMmDd(member?.joinDate);
            if (joinDateInput) {
                joinDateInput.value = normalizedJoinDate ?? "";
            }

            setSelectValue(statusSelect, normalizeStatus(member?.status));
            const imageValue = member?.image ?? member?.imageUrl ?? member?.image_url;
            setFieldValue(imageInput, imageValue);
            setHiddenBankDetailValues(getMemberBankDetails(member));
            setFieldValue(personalDetailInput, member?.personalDetail);
            setFieldValue(assignmentsInput, member?.assignments);
            setFieldValue(trainingInput, member?.trainingRecords);
            setFieldValue(employmentLogInput, member?.employmentLog);
            setFieldValue(filesInput, member?.files);
            setFieldValue(assetsInput, member?.assets);

            if (teamFormSubmitButton) {
                teamFormSubmitButton.textContent = "Update member";
            }

            if (teamFormEditingBanner) {
                teamFormEditingBanner.hidden = false;
            }

            if (teamFormEditingName) {
                teamFormEditingName.textContent = displayName;
            }

            if (teamFormCancelEditFooter) {
                teamFormCancelEditFooter.hidden = false;
                teamFormCancelEditFooter.disabled = false;
            }

            if (teamFormCancelEditBanner) {
                teamFormCancelEditBanner.disabled = false;
            }

            if (teamForm) {
                teamForm.scrollIntoView({ behavior: "smooth", block: "start" });
            }

            window.requestAnimationFrame(() => {
                if (nameInput && !nameInput.disabled) {
                    nameInput.focus();
                }
            });
        };

        const cancelEditing = () => {
            if (!isEditingMember()) {
                return;
            }

            exitEditMode();
            resetFormFeedback();
        };

        if (teamFormCancelEditBanner) {
            teamFormCancelEditBanner.addEventListener("click", cancelEditing);
        }

        if (teamFormCancelEditFooter) {
            teamFormCancelEditFooter.addEventListener("click", cancelEditing);
        }

        if (bankDetailButton && canManageMembers) {
            bankDetailButton.addEventListener("click", () => {
                openBankDetailModalForForm();
            });
        }

        const renderMembers = (members) => {
            if (!tableBody) {
                return;
            }

            tableBody.innerHTML = "";

            if (!Array.isArray(members) || members.length === 0) {
                renderEmptyState();
                return;
            }

            hideEmptyState();

            members.forEach((member) => {
                const row = document.createElement("tr");

                const avatarElement = createAvatarElement(member);
                const personalDetailCell = createPersonalDetailCell(member);

                const cells = [
                    ["ID", sanitizeText(member?.id)],
                    ["Reg No", sanitizeText(member?.regNumber)],
                    ["Image", avatarElement],
                    ["Name", sanitizeText(member?.name)],
                    ["Nickname", sanitizeText(member?.nickname)],
                    ["EPF", sanitizeText(member?.epf)],
                    ["Position", sanitizeText(member?.position)],
                    ["Pay category", sanitizeText(member?.payCategory)],
                    ["Join date", formatJoinDate(member?.joinDate)],
                    ["Status", sanitizeText(member?.status)],
                    ["Created at", formatDateTime(member?.createdAt)],
                    ["Updated at", formatDateTime(member?.updatedAt)],
                    ["Personal detail", personalDetailCell],
                    ["Assignments", sanitizeText(member?.assignments)],
                    ["Training records", sanitizeText(member?.trainingRecords)],
                    ["Employment log", sanitizeText(member?.employmentLog)],
                    ["Files", sanitizeText(member?.files)],
                    ["Assets", sanitizeText(member?.assets)],
                ];

                cells.forEach(([label, value]) => {
                    const cell = createCell(label, value);

                    if (label === "Image") {
                        cell.classList.add("team-table__cell--avatar");
                    }

                    row.appendChild(cell);
                });

                if (canManageMembers) {
                    const actionCell = document.createElement("td");
                    actionCell.classList.add("team-table__cell--actions");
                    actionCell.setAttribute("data-label", "Update");

                    const updateButton = document.createElement("button");
                    updateButton.type = "button";
                    updateButton.className =
                        "button button--secondary button--small team-table__update-button";
                    updateButton.textContent = "Update";
                    updateButton.setAttribute(
                        "aria-label",
                        `Update ${getMemberDisplayName(member)}`
                    );
                    updateButton.addEventListener("click", () => {
                        enterEditMode(member);
                    });

                    actionCell.appendChild(updateButton);
                    row.appendChild(actionCell);
                }

                tableBody.appendChild(row);
            });
        };

        const loadTeamMembers = async () => {
            if (!tableBody) {
                return;
            }

            try {
                const response = await fetch("/api/team/members", {
                    headers: authHeaders,
                });

                if (response.status === 401) {
                    logoutButton.click();
                    return;
                }

                if (!response.ok) {
                    throw new Error(`Request failed with status ${response.status}`);
                }

                const data = await response.json();
                renderMembers(data);
                setActiveMembers(data);
                await refreshMonthData(currentSalaryMonth);
            } catch (error) {
                console.error("Failed to load team members", error);
                if (tableBody) {
                    tableBody.innerHTML = "";
                }
                renderEmptyState("Unable to load team members.");
                setActiveMembers([]);
            }
        };

        const resetFormFeedback = () => {
            if (teamFormError) {
                teamFormError.hidden = true;
                teamFormError.textContent = "";
            }
            if (teamFormSuccess) {
                teamFormSuccess.hidden = true;
                teamFormSuccess.textContent = "";
            }
        };

        const showFormError = (message) => {
            if (!teamFormError) {
                return;
            }
            teamFormError.textContent = message;
            teamFormError.hidden = false;
            if (teamFormSuccess) {
                teamFormSuccess.hidden = true;
                teamFormSuccess.textContent = "";
            }
        };

        const showFormSuccess = (message) => {
            if (!teamFormSuccess) {
                return;
            }
            teamFormSuccess.textContent = message;
            teamFormSuccess.hidden = false;
            if (teamFormError) {
                teamFormError.hidden = true;
                teamFormError.textContent = "";
            }
        };

        const setFormDisabled = (disabled) => {
            if (!teamForm) {
                return;
            }
            Array.from(teamForm.elements || []).forEach((element) => {
                element.disabled = disabled;
            });

            if (teamFormCancelEditBanner) {
                teamFormCancelEditBanner.disabled = disabled;
            }
        };

        if (teamForm && canManageMembers) {
            teamForm.addEventListener("submit", async (event) => {
                event.preventDefault();

                if (!teamForm.checkValidity()) {
                    teamForm.reportValidity();
                    return;
                }

                resetFormFeedback();

                const formData = new FormData(teamForm);
                const payload = {};

                const editing = isEditingMember();
                const memberId = editingMemberId;

                if (editing && memberId == null) {
                    showFormError(
                        "Unable to determine which member to update. Please refresh and try again."
                    );
                    return;
                }

                if (!editing) {
                    const regRaw = formData.get("regNumber");
                    const regNumber = typeof regRaw === "string" ? regRaw.trim() : "";
                    if (!regNumber) {
                        showFormError("Registration number and name are required.");
                        return;
                    }
                    payload.regNumber = regNumber;
                }

                const nameRaw = formData.get("name");
                const nameValue = typeof nameRaw === "string" ? nameRaw.trim() : "";
                if (!nameValue) {
                    showFormError("Registration number and name are required.");
                    return;
                }
                payload.name = nameValue;

                const joinDateRaw = formData.get("joinDate");
                const normalizedDate = toYyyyMmDd(joinDateRaw);

                if (joinDateRaw && !normalizedDate) {
                    showFormError("Invalid date for join date. Please use YYYY-MM-DD.");
                    return;
                }

                if (normalizedDate) {
                    payload.joinDate = normalizedDate;
                }

                const statusRaw = formData.get("status");
                if (typeof statusRaw === "string" && statusRaw.trim()) {
                    payload.status = normalizeStatus(statusRaw);
                }

                const optionalFields = [
                    "nickname",
                    "epf",
                    "position",
                    "payCategory",
                    "image",
                    "bankAccountName",
                    "bankName",
                    "branchName",
                    "bankAccountNumber",
                    "personalDetail",
                    "assignments",
                    "trainingRecords",
                    "employmentLog",
                    "files",
                    "assets",
                ];

                optionalFields.forEach((field) => {
                    const rawValue = formData.get(field);
                    if (typeof rawValue !== "string") {
                        return;
                    }
                    const trimmed = rawValue.trim();
                    if (trimmed) {
                        payload[field] = trimmed;
                    } else if (editing) {
                        payload[field] = "";
                    }
                });

                setFormDisabled(true);

                try {
                    let response;

                    if (editing) {
                        response = await fetch(`/api/team/members/${memberId}`, {
                            method: "PATCH",
                            headers: {
                                ...authHeaders,
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify(payload),
                        });
                    } else {
                        response = await fetch("/api/team/members", {
                            method: "POST",
                            headers: {
                                ...authHeaders,
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify(payload),
                        });
                    }

                    if (response.status === 401) {
                        logoutButton.click();
                        return;
                    }

                    const body = await response.json().catch(() => ({}));

                    if (!response.ok) {
                        const defaultMessage = editing
                            ? "Unable to update team member."
                            : "Unable to register team member.";
                        const message = body?.msg || defaultMessage;
                        showFormError(message);
                        return;
                    }

                    if (editing) {
                        showFormSuccess("Team member updated successfully.");
                        exitEditMode();
                    } else {
                        showFormSuccess("Team member registered successfully.");
                        teamForm.reset();
                    }

                    await loadTeamMembers();
                } catch (error) {
                    const defaultMessage = editing
                        ? "Unable to update team member."
                        : "Unable to register team member.";
                    showFormError(error?.message || defaultMessage);
                } finally {
                    setFormDisabled(false);
                }
            });

            teamForm.addEventListener("input", () => {
                if (teamFormError && !teamFormError.hidden) {
                    teamFormError.hidden = true;
                    teamFormError.textContent = "";
                }
                if (teamFormSuccess && !teamFormSuccess.hidden) {
                    teamFormSuccess.hidden = true;
                    teamFormSuccess.textContent = "";
                }
            });
        }

        loadTeamMembers();
    </script>
</body>
</html>

