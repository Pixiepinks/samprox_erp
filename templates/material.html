<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Material | SAMPROX ERP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" />
</head>
<body>
    <div class="page">
        <header class="topbar">
            <div class="brand">
                <div class="brand__logo">S</div>
                <div class="brand__details">
                    <p class="brand__name">SAMPROX ERP</p>
                    <p class="brand__section">Material Control</p>
                </div>
            </div>
            <div class="topbar__actions">
                <a class="button button--ghost" href="{{ url_for('ui.mind_page') }}">Mind</a>
                <div class="user-summary">
                    <span class="user-summary__name" id="user-name"></span>
                    <span class="user-summary__role" id="user-role"></span>
                </div>
                <button type="button" class="button button--secondary" id="logout">Sign out</button>
            </div>
        </header>
        <nav class="subnav" aria-label="7M navigation">
            <a class="subnav__link" href="{{ url_for('ui.mind_page') }}">Mind</a>
            <a class="subnav__link" href="{{ url_for('ui.man_page') }}">Man</a>
            <a class="subnav__link" href="{{ url_for('ui.machines_page') }}">Machine</a>
            <a class="subnav__link subnav__link--active" href="{{ url_for('ui.material_page') }}">Material</a>
            <a class="subnav__link" href="{{ url_for('ui.market_page') }}">Market</a>
            <a class="subnav__link" href="{{ url_for('ui.manufacturing_page') }}">Manufacturing</a>
            <a class="subnav__link" href="{{ url_for('ui.money_page') }}">Money</a>
        </nav>
        <section class="section">
            <header class="section__header">
                <h1>Inventory & supply visibility</h1>
            </header>
            <p class="section__description">
                Keep production running by tracking raw materials, spare parts, and consumables. Review
                what is on hand, what is reserved for jobs, and what needs to be ordered next.
            </p>
            <div class="section__grid">
                <article class="tile">
                    <h2 class="tile__title">Stock snapshot</h2>
                    <p class="tile__description">
                        Monitor inventory aging and reorder thresholds to prevent stock-outs.
                    </p>
                </article>
                <article class="tile">
                    <h2 class="tile__title">Supplier performance</h2>
                    <p class="tile__description">
                        Review supplier lead times and delivery quality to guide purchasing decisions.
                    </p>
                </article>
                <article class="tile">
                    <h2 class="tile__title">Consumption trends</h2>
                    <p class="tile__description">
                        Analyze how materials are consumed across jobs to forecast future demand.
                    </p>
                </article>
                <article class="tile">
                    <h2 class="tile__title">Pending requisitions</h2>
                    <p class="tile__description">
                        Follow up on open purchase requests and approvals so critical parts arrive on
                        time.
                    </p>
                </article>
            </div>
            <div class="material-receipts-card supplier-registry-card">
                <div class="material-receipts-card__header">
                    <div>
                        <h2 class="material-receipts-card__title">Supplier registry</h2>
                        <p class="material-receipts-card__meta">
                            Review registered suppliers and keep their contact details at your fingertips.
                        </p>
                    </div>
                    <a class="button" href="{{ url_for('ui.material_mrn_new_page') }}">Register supplier</a>
                </div>
                <form class="material-receipts-card__search" id="supplier-search-form">
                    <label class="sr-only" for="supplier-search-input">Search suppliers</label>
                    <input
                        id="supplier-search-input"
                        type="search"
                        name="q"
                        placeholder="Search by supplier name, registration, or contact"
                        autocomplete="off"
                    />
                    <div class="material-receipts-card__actions">
                        <button type="submit" class="button button--secondary">Search</button>
                        <button type="button" class="button button--ghost" id="supplier-clear-button">Clear</button>
                    </div>
                </form>
                <p class="empty-state" id="supplier-empty-state">Loading suppliers…</p>
                <div class="table-wrapper" id="supplier-table-wrapper" hidden>
                    <table class="data-table" id="supplier-table">
                        <thead>
                            <tr>
                                <th scope="col">Supplier</th>
                                <th scope="col">Registration no.</th>
                                <th scope="col">Category</th>
                                <th scope="col">Primary phone</th>
                                <th scope="col">Credit period</th>
                            </tr>
                        </thead>
                        <tbody id="supplier-table-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="material-receipts-card">
                <div class="material-receipts-card__header">
                    <div>
                        <h2 class="material-receipts-card__title">Material receipts</h2>
                        <p class="material-receipts-card__meta">
                            Review the latest material receipt notes recorded by your team.
                        </p>
                    </div>
                    <a class="button" href="{{ url_for('ui.material_mrn_new_page') }}">Record material receipt</a>
                </div>
                <form class="material-receipts-card__search" id="mrn-search-form">
                    <label class="sr-only" for="mrn-search-input">Search material receipts</label>
                    <input
                        id="mrn-search-input"
                        type="search"
                        name="q"
                        placeholder="Search by MRN number, supplier, or material"
                        autocomplete="off"
                    />
                    <div class="material-receipts-card__actions">
                        <button type="submit" class="button button--secondary">Search</button>
                        <button type="button" class="button button--ghost" id="mrn-clear-button">Clear</button>
                    </div>
                </form>
                <p class="empty-state" id="mrn-empty-state">Loading material receipts…</p>
                <div class="table-wrapper" id="mrn-table-wrapper" hidden>
                    <table class="data-table" id="mrn-table">
                        <thead>
                            <tr>
                                <th scope="col">MRN number</th>
                                <th scope="col">Date</th>
                                <th scope="col">Supplier</th>
                                <th scope="col">Material</th>
                                <th scope="col">Qty (Ton)</th>
                                <th scope="col">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="mrn-table-body"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>
    <script>
        const token = localStorage.getItem("samprox_token");
        const userRaw = localStorage.getItem("samprox_user");
        let user;

        try {
            user = userRaw ? JSON.parse(userRaw) : null;
        } catch (_) {
            user = null;
        }

        if (!token || !user) {
            window.location.href = "/";
        }

        const roleLabels = {
            admin: "Admin",
            production_manager: "Production Manager",
            maintenance_manager: "Maintenance Manager",
            technician: "Technician",
        };

        const userNameEl = document.getElementById("user-name");
        const userRoleEl = document.getElementById("user-role");
        const logoutButton = document.getElementById("logout");

        userNameEl.textContent = user?.name || "Unknown";
        userRoleEl.textContent = roleLabels[user?.role] || "";

        logoutButton.addEventListener("click", () => {
            localStorage.removeItem("samprox_token");
            localStorage.removeItem("samprox_user");
            window.location.href = "/";
        });

        const supplierTableBody = document.getElementById("supplier-table-body");
        const supplierTableWrapper = document.getElementById("supplier-table-wrapper");
        const supplierEmptyState = document.getElementById("supplier-empty-state");
        const supplierSearchForm = document.getElementById("supplier-search-form");
        const supplierSearchInput = document.getElementById("supplier-search-input");
        const supplierClearButton = document.getElementById("supplier-clear-button");

        const mrnTableBody = document.getElementById("mrn-table-body");
        const mrnTableWrapper = document.getElementById("mrn-table-wrapper");
        const mrnEmptyState = document.getElementById("mrn-empty-state");
        const mrnSearchForm = document.getElementById("mrn-search-form");
        const mrnSearchInput = document.getElementById("mrn-search-input");
        const mrnClearButton = document.getElementById("mrn-clear-button");

        function formatNumber(value, fractionDigits) {
            const numeric = Number.parseFloat(value);
            if (Number.isNaN(numeric)) {
                return "—";
            }
            return numeric.toLocaleString(undefined, {
                minimumFractionDigits: fractionDigits,
                maximumFractionDigits: fractionDigits,
            });
        }

        function renderSupplierRows(items) {
            if (!supplierTableBody || !supplierTableWrapper || !supplierEmptyState) {
                return;
            }

            supplierTableBody.innerHTML = "";

            if (!items || items.length === 0) {
                supplierTableWrapper.hidden = true;
                supplierEmptyState.hidden = false;
                supplierEmptyState.textContent = "No suppliers registered yet.";
                return;
            }

            items.forEach((item) => {
                const row = document.createElement("tr");

                const nameCell = document.createElement("td");
                nameCell.textContent = item.name || "—";
                row.appendChild(nameCell);

                const regCell = document.createElement("td");
                regCell.textContent = item.supplierRegNo || "—";
                row.appendChild(regCell);

                const categoryCell = document.createElement("td");
                categoryCell.textContent = item.category || "—";
                row.appendChild(categoryCell);

                const phoneCell = document.createElement("td");
                phoneCell.textContent = item.primaryPhone || item.phone || "—";
                row.appendChild(phoneCell);

                const creditCell = document.createElement("td");
                creditCell.textContent = item.creditPeriod || "—";
                row.appendChild(creditCell);

                supplierTableBody.appendChild(row);
            });

            supplierEmptyState.hidden = true;
            supplierTableWrapper.hidden = false;
        }

        async function loadSuppliers(query = "") {
            if (!supplierTableBody || !supplierEmptyState) {
                return;
            }

            supplierEmptyState.hidden = false;
            supplierEmptyState.textContent = "Loading suppliers…";
            if (supplierTableWrapper) {
                supplierTableWrapper.hidden = true;
            }

            try {
                const url = new URL("/api/material/suppliers", window.location.origin);
                url.searchParams.set("limit", "15");
                if (query && query.trim()) {
                    url.searchParams.set("search", query.trim());
                }
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error("Failed to load suppliers");
                }
                const data = await response.json();
                if (!Array.isArray(data)) {
                    renderSupplierRows([]);
                    return;
                }
                renderSupplierRows(data);
            } catch (error) {
                console.error(error);
                supplierEmptyState.hidden = false;
                supplierEmptyState.textContent =
                    "Unable to load suppliers right now. Please try again.";
            }
        }

        function formatDate(value) {
            if (!value) {
                return "—";
            }
            const parts = value.split("-");
            if (parts.length !== 3) {
                return value;
            }
            const [year, month, day] = parts.map((part) => Number.parseInt(part, 10));
            if (Number.isNaN(year) || Number.isNaN(month) || Number.isNaN(day)) {
                return value;
            }
            const dateObject = new Date(year, month - 1, day);
            return dateObject.toLocaleDateString(undefined, {
                year: "numeric",
                month: "short",
                day: "numeric",
            });
        }

        if (supplierSearchForm) {
            supplierSearchForm.addEventListener("submit", (event) => {
                event.preventDefault();
                const query = supplierSearchInput ? supplierSearchInput.value : "";
                loadSuppliers(query);
            });
        }

        if (supplierClearButton) {
            supplierClearButton.addEventListener("click", () => {
                if (supplierSearchInput) {
                    supplierSearchInput.value = "";
                }
                loadSuppliers("");
            });
        }

        if (supplierSearchInput) {
            supplierSearchInput.addEventListener("input", () => {
                if (supplierSearchInput.value.trim() === "") {
                    loadSuppliers("");
                }
            });
        }

        function renderMrnRows(items) {
            if (!mrnTableBody || !mrnTableWrapper || !mrnEmptyState) {
                return;
            }

            mrnTableBody.innerHTML = "";

            if (!items || items.length === 0) {
                mrnTableWrapper.hidden = true;
                mrnEmptyState.hidden = false;
                mrnEmptyState.textContent = "No material receipts recorded yet.";
                return;
            }

            items.forEach((item) => {
                const row = document.createElement("tr");

                const mrnCell = document.createElement("td");
                const mrnLink = document.createElement("a");
                mrnLink.className = "data-table__link";
                mrnLink.href = `/material/mrn/${item.id}`;
                mrnLink.textContent = item.mrn_no;
                mrnCell.appendChild(mrnLink);
                row.appendChild(mrnCell);

                const dateCell = document.createElement("td");
                dateCell.textContent = formatDate(item.date);
                row.appendChild(dateCell);

                const supplierCell = document.createElement("td");
                supplierCell.textContent =
                    (item.supplier && item.supplier.name) || item.vehicle_no || "—";
                row.appendChild(supplierCell);

                const materialCell = document.createElement("td");
                let materialSummary = "—";
                if (Array.isArray(item.items) && item.items.length > 0) {
                    const firstItem = item.items[0];
                    const firstName = (firstItem.item && firstItem.item.name) || firstItem.name || "—";
                    if (item.items.length === 1) {
                        materialSummary = firstName;
                    } else {
                        materialSummary = `${firstName} + ${item.items.length - 1} more`;
                    }
                }
                materialCell.textContent = materialSummary;
                row.appendChild(materialCell);

                const qtyCell = document.createElement("td");
                qtyCell.textContent = formatNumber(item.qty_ton, 3);
                row.appendChild(qtyCell);

                const amountCell = document.createElement("td");
                amountCell.textContent = formatNumber(item.amount, 2);
                row.appendChild(amountCell);

                mrnTableBody.appendChild(row);
            });

            mrnEmptyState.hidden = true;
            mrnTableWrapper.hidden = false;
        }

        async function loadMrns(query = "") {
            if (!mrnTableBody || !mrnEmptyState) {
                return;
            }

            mrnEmptyState.hidden = false;
            mrnEmptyState.textContent = "Loading material receipts…";
            if (mrnTableWrapper) {
                mrnTableWrapper.hidden = true;
            }

            try {
                const url = new URL("/api/material/mrn", window.location.origin);
                if (query && query.trim()) {
                    url.searchParams.set("q", query.trim());
                }
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error("Failed to load MRNs");
                }
                const data = await response.json();
                if (!Array.isArray(data)) {
                    renderMrnRows([]);
                    return;
                }
                renderMrnRows(data);
            } catch (error) {
                console.error(error);
                mrnEmptyState.hidden = false;
                mrnEmptyState.textContent =
                    "Unable to load material receipts right now. Please try again.";
            }
        }

        if (mrnSearchForm) {
            mrnSearchForm.addEventListener("submit", (event) => {
                event.preventDefault();
                const query = mrnSearchInput ? mrnSearchInput.value : "";
                loadMrns(query);
            });
        }

        if (mrnClearButton) {
            mrnClearButton.addEventListener("click", () => {
                if (mrnSearchInput) {
                    mrnSearchInput.value = "";
                }
                loadMrns("");
            });
        }

        if (mrnSearchInput) {
            mrnSearchInput.addEventListener("input", () => {
                if (mrnSearchInput.value.trim() === "") {
                    loadMrns("");
                }
            });
        }

        loadSuppliers("");
        loadMrns("");
    </script>
</body>
</html>
