<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MRN {{ mrn.mrn_no }} | SAMPROX ERP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
        :root {
            color-scheme: only light;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        @page {
            size: A5 landscape;
            margin: 12mm;
        }

        body {
            margin: 0;
            font-family: "Inter", sans-serif;
            background: #e5e7eb;
            color: #0f172a;
            display: flex;
            justify-content: center;
            padding: 28px;
        }

        img {
            display: block;
            max-width: 100%;
        }

        html {
            font-size: 12px;
        }

        main {
            width: 100%;
            max-width: 220mm;
        }

        .print-sheet {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 20px 45px rgba(15, 23, 42, 0.18);
            padding: 24px 28px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .sheet-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 24px;
        }

        .company-block {
            display: grid;
            gap: 2px;
            font-size: 1.2rem;
            line-height: 1.35;
        }

        .company-name {
            font-size: 1.4rem;
            font-weight: 700;
        }

        .logo-block {
            width: 120px;
            flex-shrink: 0;
        }

        .document-title {
            text-align: center;
            font-size: 2.2rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin: 2px 0 6px;
        }

        .meta-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 14px;
        }

        .meta-block {
            display: grid;
            gap: 6px;
        }

        .meta-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
            font-size: 1.05rem;
            line-height: 1.3;
        }

        .meta-label {
            font-weight: 600;
            color: #1f2937;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .meta-value {
            font-weight: 500;
            color: #111827;
            text-align: right;
            white-space: nowrap;
            font-size: 0.95rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #0f172a;
            color: #ffffff;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 1.1rem;
        }

        th,
        td {
            border: 1px solid #d1d5db;
            padding: 10px 9px;
            font-size: 1.1rem;
        }

        td:nth-child(4),
        th:nth-child(4) {
            text-align: right;
        }

        tbody tr:nth-of-type(even) {
            background: #f9fafb;
        }

        tfoot td {
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            border-top: 2px solid #0f172a;
        }

        tfoot td:first-child {
            text-align: right;
            padding-right: 18px;
        }

        tfoot td:last-child {
            text-align: right;
        }

        .signature-section {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 36px;
            margin-top: 10px;
        }

        .signature-slot {
            display: grid;
            gap: 12px;
        }

        .signature-bar {
            height: 40px;
            border-bottom: 2px solid #111827;
        }

        .signature-label {
            text-align: center;
            font-size: 1.05rem;
            font-weight: 700;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            color: #0f172a;
        }

        .empty-state {
            margin: 12px 0 0;
            padding: 18px;
            border: 1px dashed #d1d5db;
            background: #f9fafb;
            font-size: 1.05rem;
            color: #6b7280;
            text-align: center;
        }

        @media print {
            html {
                font-size: 11px;
            }

            body {
                background: #ffffff;
                padding: 0;
            }

            .print-sheet {
                border-radius: 0;
                box-shadow: none;
                padding: 16mm;
            }
        }
    </style>
</head>
<body>
    <main>
        <article class="print-sheet">
            <header class="sheet-header">
                <div class="company-block">
                    <span class="company-name">Samprox International (Pvt) Ltd</span>
                    <span>16/2, Sasanawardenarama Mawatha,</span>
                    <span>Galawilawatta, Homagama</span>
                </div>
                <div class="logo-block">
                    <img src="{{ url_for('static', filename='profile_images/GRNLOGO.png') }}" alt="Company logo" />
                </div>
            </header>

            <h1 class="document-title">Material Receipt Note</h1>

            <section class="meta-grid" aria-label="Document metadata">
                <div class="meta-block">
                    <div class="meta-row">
                        <span class="meta-label">Date</span>
                        <span class="meta-value">{{ mrn.date.strftime('%Y-%m-%d') }}</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-label">MRN No</span>
                        <span class="meta-value">{{ mrn.mrn_no }}</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-label">Supplier</span>
                        <span class="meta-value">{{ mrn.supplier.name if mrn.supplier else "—" }}</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-label">Sourcing Type</span>
                        <span class="meta-value">{{ mrn.sourcing_type or "—" }}</span>
                    </div>
                </div>
                <div class="meta-block">
                    <div class="meta-row">
                        <span class="meta-label">Weigh Bridge In</span>
                        <span class="meta-value">{{ mrn.weigh_in_time.strftime('%Y-%m-%d %H:%M') }}</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-label">Weigh Bridge Out</span>
                        <span class="meta-value">{{ mrn.weigh_out_time.strftime('%Y-%m-%d %H:%M') }}</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-label">Weigh Bridge Slip</span>
                        <span class="meta-value">{{ mrn.weighing_slip_no or "—" }}</span>
                    </div>
                </div>
                <div class="meta-block">
                    <div class="meta-row">
                        <span class="meta-label">Vehicle No</span>
                        <span class="meta-value">{{ mrn.vehicle_no or "—" }}</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-label">Security Officer</span>
                        <span class="meta-value">{{ mrn.security_officer_name or "—" }}</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-label">Authorized Person</span>
                        <span class="meta-value">{{ mrn.authorized_person_name or "—" }}</span>
                    </div>
                </div>
            </section>

            <section aria-label="Item details">
                {% if mrn.items %}
                <table>
                    <thead>
                        <tr>
                            <th scope="col">Item</th>
                            <th scope="col">First Weight (Kg)</th>
                            <th scope="col">Second Weight (Kg)</th>
                            <th scope="col">Qty (Ton)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for line in mrn.items %}
                        <tr>
                            <td>{{ line.item.name if line.item else "—" }}</td>
                            <td>
                                {% if line.first_weight_kg is not none %}
                                    {{ '%.3f'|format(line.first_weight_kg) }}
                                {% else %}
                                    —
                                {% endif %}
                            </td>
                            <td>
                                {% if line.second_weight_kg is not none %}
                                    {{ '%.3f'|format(line.second_weight_kg) }}
                                {% else %}
                                    —
                                {% endif %}
                            </td>
                            <td>{{ '%.3f'|format(line.qty_ton) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3">TOTAL (TON)</td>
                            <td>{{ '%.3f'|format(mrn.qty_ton) }}</td>
                        </tr>
                    </tfoot>
                </table>
                {% else %}
                <p class="empty-state">No item details recorded.</p>
                {% endif %}
            </section>

            <section class="signature-section" aria-label="Approvals">
                <div class="signature-slot">
                    <span class="signature-bar" aria-hidden="true"></span>
                    <span class="signature-label">Checked By</span>
                </div>
                <div class="signature-slot">
                    <span class="signature-bar" aria-hidden="true"></span>
                    <span class="signature-label">Approved By</span>
                </div>
            </section>
        </article>
    </main>

    <script>
        const token = localStorage.getItem("samprox_token");
        const userRaw = localStorage.getItem("samprox_user");

        let user;
        try {
            user = userRaw ? JSON.parse(userRaw) : null;
        } catch (error) {
            user = null;
        }

        if (!token || !user) {
            window.location.href = "/";
        }

        if (user?.role === "maintenance_manager" && window.location.pathname !== "/machines") {
            window.location.replace("/machines");
        }

        window.addEventListener("load", () => {
            setTimeout(() => {
                window.print();
            }, 250);
        });
    </script>
</body>
</html>
