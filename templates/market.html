<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Market | SAMPROX ERP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" />
</head>
<body>
    <div class="page">
        <header class="topbar">
            <div class="brand">
                <div class="brand__logo">S</div>
                <div class="brand__details">
                    <p class="brand__name">SAMPROX ERP</p>
                    <p class="brand__section">Market Insights</p>
                </div>
            </div>
            <div class="topbar__actions">
                <a class="button button--ghost" href="{{ url_for('ui.mind_page') }}">Mind</a>
                <div class="user-summary">
                    <span class="user-summary__name" id="user-name"></span>
                    <span class="user-summary__role" id="user-role"></span>
                </div>
                <button type="button" class="button button--secondary" id="logout">Sign out</button>
            </div>
        </header>
        <nav class="subnav" aria-label="7M navigation">
            <a class="subnav__link" href="{{ url_for('ui.mind_page') }}">Mind</a>
            <a class="subnav__link" href="{{ url_for('ui.man_page') }}">Man</a>
            <a class="subnav__link" href="{{ url_for('ui.machines_page') }}">Machine</a>
            <a class="subnav__link" href="{{ url_for('ui.material_page') }}">Material</a>
            <a class="subnav__link subnav__link--active" href="{{ url_for('ui.market_page') }}">Market</a>
            <a class="subnav__link" href="{{ url_for('ui.manufacturing_page') }}">Manufacturing</a>
            <a class="subnav__link" href="{{ url_for('ui.money_page') }}">Money</a>
        </nav>
        <section class="section">
            <header class="section__header">
                <h1>Demand & customer alignment</h1>
            </header>
            <p class="section__description">
                Keep production aligned with market demand by reviewing orders, forecasts, and customer
                feedback. Use this page to coordinate priorities across sales, production, and service.
            </p>
            <article class="production-card sales-summary" id="sales-summary" aria-labelledby="sales-summary-title">
                <header class="production-card__header sales-summary__header">
                    <div>
                        <h2 id="sales-summary-title">Sales performance snapshot</h2>
                        <p class="sales-summary__subtitle">
                            Quick glance at how actual sales are trending against the current year.
                        </p>
                    </div>
                    <p id="sales-summary-status" class="sales-summary__status" role="status"></p>
                </header>
                <div class="sales-summary__grid" role="list">
                    <article class="summary-card" role="listitem">
                        <h3 class="summary-card__title">Year-to-date sales qty</h3>
                        <p class="summary-card__subtitle">Tons dispatched so far this year</p>
                        <p class="summary-card__value" id="summary-ytd-quantity">--</p>
                        <svg class="sparkline" viewBox="0 0 100 36" preserveAspectRatio="none" aria-hidden="true">
                            <polygon class="sparkline__fill" id="summary-ytd-quantity-fill" points=""></polygon>
                            <polyline class="sparkline__line" id="summary-ytd-quantity-line" points=""></polyline>
                        </svg>
                    </article>
                    <article class="summary-card" role="listitem">
                        <h3 class="summary-card__title">Year-to-date sales value</h3>
                        <p class="summary-card__subtitle">Actual revenue captured in the current year</p>
                        <p class="summary-card__value" id="summary-ytd-value">--</p>
                        <svg class="sparkline" viewBox="0 0 100 36" preserveAspectRatio="none" aria-hidden="true">
                            <polygon class="sparkline__fill" id="summary-ytd-value-fill" points=""></polygon>
                            <polyline class="sparkline__line" id="summary-ytd-value-line" points=""></polyline>
                        </svg>
                    </article>
                    <article class="summary-card" role="listitem">
                        <h3 class="summary-card__title">Month-to-date sales</h3>
                        <p class="summary-card__subtitle">Actual sales recorded in the selected month</p>
                        <p class="summary-card__value" id="summary-mtd-value">--</p>
                        <p class="summary-card__detail" id="summary-mtd-quantity">Qty: --</p>
                        <svg class="sparkline" viewBox="0 0 100 36" preserveAspectRatio="none" aria-hidden="true">
                            <polygon class="sparkline__fill" id="summary-mtd-value-fill" points=""></polygon>
                            <polyline class="sparkline__line" id="summary-mtd-value-line" points=""></polyline>
                        </svg>
                    </article>
                    <article class="summary-card summary-card--compact" role="listitem">
                        <h3 class="summary-card__title">Monthly average unit price</h3>
                        <p class="summary-card__subtitle">Calculated from month-to-date actuals</p>
                        <p class="summary-card__value" id="summary-average-price">--</p>
                        <p class="summary-card__detail">Keep tabs on pricing discipline</p>
                    </article>
                    <article class="summary-card summary-card--accent" role="listitem">
                        <h3 class="summary-card__title">Top customer</h3>
                        <p class="summary-card__subtitle">Highest sales value year-to-date</p>
                        <p class="summary-card__value" id="summary-top-customer-name">--</p>
                        <p class="summary-card__detail" id="summary-top-customer-value">Value: --</p>
                        <p class="summary-card__detail" id="summary-top-customer-quantity">Qty: --</p>
                    </article>
                </div>
            </article>
            <div class="section__grid">
                <article class="tile">
                    <h2 class="tile__title">Sales pipeline</h2>
                    <p class="tile__description">
                        Track upcoming orders and opportunities to plan capacity and inventory.
                    </p>
                </article>
                <article class="tile">
                    <h2 class="tile__title">Customer feedback</h2>
                    <p class="tile__description">
                        Collect insights from support tickets and surveys to improve service quality.
                    </p>
                </article>
                <article class="tile">
                    <h2 class="tile__title">Competitor watch</h2>
                    <p class="tile__description">
                        Highlight market trends and competitor moves that influence pricing or demand.
                    </p>
                </article>
                <article class="tile">
                    <h2 class="tile__title">Promotion calendar</h2>
                    <p class="tile__description">
                        Coordinate marketing campaigns with production capabilities to avoid bottlenecks.
                    </p>
                </article>
            </div>
            <article class="production-card sales-entry" aria-labelledby="sales-entry-title">
                <header class="production-card__header sales-entry__header">
                    <div>
                        <h2 id="sales-entry-title">Record sales entry</h2>
                        <p class="sales-entry__subtitle">
                            Capture forecasted or actual sales to instantly refresh the performance report below.
                        </p>
                    </div>
                    <div class="sales-entry__summary" aria-live="polite">
                        <span class="sales-entry__summary-label">Sales value (Rs)</span>
                        <span class="sales-entry__summary-value" id="sales-entry-total">0</span>
                    </div>
                </header>
                <p
                    id="sales-entry-mode"
                    class="sales-entry__mode"
                    role="status"
                    aria-live="polite"
                ></p>
                <form
                    id="sales-entry-form"
                    class="sales-entry__form"
                    aria-label="Record sales entry"
                    novalidate
                >
                    <div class="sales-form__grid">
                        <div class="sales-input">
                            <label for="sales-entry-date">Date <span class="required">*</span></label>
                            <input
                                type="date"
                                id="sales-entry-date"
                                name="date"
                                class="sales-input__control"
                                required
                            />
                        </div>
                        <div class="sales-input sales-input--customer">
                            <label for="sales-entry-customer">Customer <span class="required">*</span></label>
                            <div class="sales-input__customer-controls">
                                <select
                                    id="sales-entry-customer"
                                    name="customer_id"
                                    class="sales-input__control"
                                    required
                                ></select>
                                <button
                                    type="button"
                                    class="button button--ghost sales-input__add-customer"
                                    id="sales-entry-add-customer"
                                >
                                    Add new customer
                                </button>
                            </div>
                        </div>
                        <div class="sales-input">
                            <label for="sales-entry-type">Entry type <span class="required">*</span></label>
                            <select
                                id="sales-entry-type"
                                name="sale_type"
                                class="sales-input__control"
                                required
                            >
                                <option value="actual">Actual sale</option>
                                <option value="forecast">Forecast sale</option>
                            </select>
                        </div>
                        <div class="sales-input">
                            <label for="sales-entry-unit-price">Unit price (Rs/Ton) <span class="required">*</span></label>
                            <input
                                type="number"
                                id="sales-entry-unit-price"
                                name="unit_price"
                                class="sales-input__control"
                                inputmode="decimal"
                                step="0.01"
                                min="0"
                                placeholder="0.00"
                                required
                            />
                        </div>
                        <div class="sales-input">
                            <label for="sales-entry-quantity">Quantity (Tons) <span class="required">*</span></label>
                            <input
                                type="number"
                                id="sales-entry-quantity"
                                name="quantity_tons"
                                class="sales-input__control"
                                inputmode="decimal"
                                step="0.01"
                                min="0"
                                placeholder="0.00"
                                required
                            />
                        </div>
                        <div class="sales-input">
                            <label for="sales-entry-delivery-note">Delivery Note No <span class="required">*</span></label>
                            <input
                                type="text"
                                id="sales-entry-delivery-note"
                                name="delivery_note_number"
                                class="sales-input__control"
                                autocomplete="off"
                            />
                        </div>
                        <div class="sales-input">
                            <label for="sales-entry-weigh-slip">Weigh Slip No</label>
                            <input
                                type="text"
                                id="sales-entry-weigh-slip"
                                name="weigh_slip_number"
                                class="sales-input__control"
                                autocomplete="off"
                            />
                        </div>
                        <div class="sales-input">
                            <label for="sales-entry-loader-1">Loader 1 Name <span class="required">*</span></label>
                            <select
                                id="sales-entry-loader-1"
                                name="loader1_id"
                                class="sales-input__control"
                                required
                            >
                                <option value="">Select loader</option>
                            </select>
                        </div>
                        <div class="sales-input">
                            <label for="sales-entry-loader-2">Loader 2 Name</label>
                            <select
                                id="sales-entry-loader-2"
                                name="loader2_id"
                                class="sales-input__control"
                            >
                                <option value="">Select loader</option>
                            </select>
                        </div>
                        <div class="sales-input">
                            <label for="sales-entry-loader-3">Loader 3 Name</label>
                            <select
                                id="sales-entry-loader-3"
                                name="loader3_id"
                                class="sales-input__control"
                            >
                                <option value="">Select loader</option>
                            </select>
                        </div>
                    </div>
                    <div class="sales-entry__actions">
                        <button type="submit" class="button" id="sales-entry-submit">Save entry</button>
                    </div>
                </form>
                <p id="sales-entry-feedback" class="sales-entry__feedback" role="status" aria-live="polite"></p>
            </article>
            <dialog
                id="customer-dialog"
                class="modal"
                aria-labelledby="customer-dialog-title"
                aria-modal="true"
            >
                <form id="customer-form" class="modal__form">
                    <header class="modal__header">
                        <h2 id="customer-dialog-title" class="modal__title">Add new customer</h2>
                        <p class="modal__subtitle">Customer ID will be assigned automatically (e.g. 00001).</p>
                    </header>
                    <div class="modal__grid">
                        <label class="modal__field" for="customer-name">
                            <span class="modal__label">Customer name</span>
                            <input id="customer-name" name="name" type="text" class="modal__input" required />
                        </label>
                        <label class="modal__field" for="customer-category">
                            <span class="modal__label">Category</span>
                            <select id="customer-category" name="category" class="modal__select" required></select>
                        </label>
                        <label class="modal__field" for="customer-credit-term">
                            <span class="modal__label">Credit term</span>
                            <select id="customer-credit-term" name="credit_term" class="modal__select" required></select>
                        </label>
                        <label class="modal__field" for="customer-transport-mode">
                            <span class="modal__label">Transport mode</span>
                            <select id="customer-transport-mode" name="transport_mode" class="modal__select" required></select>
                        </label>
                        <label class="modal__field" for="customer-type">
                            <span class="modal__label">Type</span>
                            <select id="customer-type" name="customer_type" class="modal__select" required></select>
                        </label>
                        <label class="modal__field" for="customer-sales-coordinator-name">
                            <span class="modal__label">Sales coordinator name</span>
                            <input
                                id="customer-sales-coordinator-name"
                                name="sales_coordinator_name"
                                type="text"
                                class="modal__input"
                                required
                            />
                        </label>
                        <label class="modal__field" for="customer-sales-coordinator-phone">
                            <span class="modal__label">Sales coordinator telephone</span>
                            <input
                                id="customer-sales-coordinator-phone"
                                name="sales_coordinator_phone"
                                type="tel"
                                class="modal__input"
                                required
                            />
                        </label>
                        <label class="modal__field" for="customer-store-keeper-name">
                            <span class="modal__label">Store keeper name</span>
                            <input
                                id="customer-store-keeper-name"
                                name="store_keeper_name"
                                type="text"
                                class="modal__input"
                                required
                            />
                        </label>
                        <label class="modal__field" for="customer-store-keeper-phone">
                            <span class="modal__label">Store keeper telephone</span>
                            <input
                                id="customer-store-keeper-phone"
                                name="store_keeper_phone"
                                type="tel"
                                class="modal__input"
                                required
                            />
                        </label>
                        <label class="modal__field" for="customer-payment-coordinator-name">
                            <span class="modal__label">Payment coordinator name</span>
                            <input
                                id="customer-payment-coordinator-name"
                                name="payment_coordinator_name"
                                type="text"
                                class="modal__input"
                                required
                            />
                        </label>
                        <label class="modal__field" for="customer-payment-coordinator-phone">
                            <span class="modal__label">Payment coordinator telephone</span>
                            <input
                                id="customer-payment-coordinator-phone"
                                name="payment_coordinator_phone"
                                type="tel"
                                class="modal__input"
                                required
                            />
                        </label>
                        <label class="modal__field modal__field--full" for="customer-special-note">
                            <span class="modal__label">Special note</span>
                            <textarea
                                id="customer-special-note"
                                name="special_note"
                                class="modal__textarea"
                                rows="3"
                                required
                            ></textarea>
                        </label>
                    </div>
                    <p id="customer-form-feedback" class="modal__feedback" role="status" aria-live="polite"></p>
                    <div class="modal__actions">
                        <button type="button" class="button button--secondary" id="customer-form-cancel">Cancel</button>
                        <button type="submit" class="button" id="customer-form-submit">Save customer</button>
                    </div>
                </form>
            </dialog>
            <article class="production-card sales-report" aria-labelledby="sales-report-title">
                <div class="production-card__header">
                    <div>
                        <h2 id="sales-report-title">Customer sales performance</h2>
                        <p id="sales-report-subtitle" class="sales-report__subtitle">
                            Select a month and year to compare forecasted versus actual sales by customer.
                        </p>
                    </div>
                    <form id="sales-report-form" class="sales-report__controls" aria-label="Customer sales filters">
                        <label class="sales-report__field" for="sales-report-month">
                            <span class="sales-report__label">Month</span>
                            <select id="sales-report-month" name="month" class="sales-report__input" required></select>
                        </label>
                        <label class="sales-report__field" for="sales-report-year">
                            <span class="sales-report__label">Year</span>
                            <select id="sales-report-year" name="year" class="sales-report__input" required></select>
                        </label>
                        <label class="sales-report__field" for="sales-report-customer">
                            <span class="sales-report__label">Customer</span>
                            <select id="sales-report-customer" name="customer_id" class="sales-report__input">
                                <option value="">All customers</option>
                            </select>
                        </label>
                        <button type="submit" class="button" id="sales-report-submit">Load report</button>
                    </form>
                </div>
                <p id="sales-report-feedback" class="sales-report__feedback" role="status" aria-live="polite"></p>
                <div id="sales-report-overview" class="sales-report__overview" aria-live="polite"></div>
                <div id="sales-report-results" class="sales-report__results" aria-live="polite"></div>
            </article>
        </section>
    </div>
    <script>
        const token = localStorage.getItem("samprox_token");
        const userRaw = localStorage.getItem("samprox_user");
        let user;

        try {
            user = userRaw ? JSON.parse(userRaw) : null;
        } catch (_) {
            user = null;
        }

        if (!token || !user) {
            window.location.href = "/";
        }

        if (user?.role === "maintenance_manager" && window.location.pathname !== "/machines") {
            window.location.replace("/machines");
        }

        const roleLabels = {
            admin: "Admin",
            production_manager: "Production Manager",
            maintenance_manager: "Maintenance Manager",
            finance_manager: "Finance Manager",
            technician: "Technician",
        };

        const userNameEl = document.getElementById("user-name");
        const userRoleEl = document.getElementById("user-role");
        const logoutButton = document.getElementById("logout");
        const entryForm = document.getElementById("sales-entry-form");
        const entryDateInput = document.getElementById("sales-entry-date");
        const entryCustomerSelect = document.getElementById("sales-entry-customer");
        const entryAddCustomerButton = document.getElementById("sales-entry-add-customer");
        const entryTypeSelect = document.getElementById("sales-entry-type");
        const entryUnitPriceInput = document.getElementById("sales-entry-unit-price");
        const entryQuantityInput = document.getElementById("sales-entry-quantity");
        const entryDeliveryNoteInput = document.getElementById("sales-entry-delivery-note");
        const entryWeighSlipInput = document.getElementById("sales-entry-weigh-slip");
        const entryLoader1Select = document.getElementById("sales-entry-loader-1");
        const entryLoader2Select = document.getElementById("sales-entry-loader-2");
        const entryLoader3Select = document.getElementById("sales-entry-loader-3");
        const entryTotalOutput = document.getElementById("sales-entry-total");
        const entryFeedbackEl = document.getElementById("sales-entry-feedback");
        const entryModeMessageEl = document.getElementById("sales-entry-mode");
        const entrySubmitButton = document.getElementById("sales-entry-submit");
        const customerDialog = document.getElementById("customer-dialog");
        const customerForm = document.getElementById("customer-form");
        const customerFormSubmit = document.getElementById("customer-form-submit");
        const customerFormCancel = document.getElementById("customer-form-cancel");
        const customerFormFeedback = document.getElementById("customer-form-feedback");
        const customerCategorySelect = document.getElementById("customer-category");
        const customerCreditTermSelect = document.getElementById("customer-credit-term");
        const customerTransportSelect = document.getElementById("customer-transport-mode");
        const customerTypeSelect = document.getElementById("customer-type");
        const customerNameInput = document.getElementById("customer-name");
        const customerSalesCoordinatorName = document.getElementById("customer-sales-coordinator-name");
        const customerSalesCoordinatorPhone = document.getElementById("customer-sales-coordinator-phone");
        const customerStoreKeeperName = document.getElementById("customer-store-keeper-name");
        const customerStoreKeeperPhone = document.getElementById("customer-store-keeper-phone");
        const customerPaymentCoordinatorName = document.getElementById("customer-payment-coordinator-name");
        const customerPaymentCoordinatorPhone = document.getElementById("customer-payment-coordinator-phone");
        const customerSpecialNote = document.getElementById("customer-special-note");
        const addCustomerOptionValue = "__create__";
        const loaderSelects = [entryLoader1Select, entryLoader2Select, entryLoader3Select];
        let currentEditingEntry = null;
        const dialogSupported =
            typeof HTMLDialogElement === "function" &&
            typeof HTMLDialogElement.prototype.showModal === "function";

        if (customerDialog && !dialogSupported) {
            customerDialog.setAttribute("data-polyfill", "true");
            customerDialog.setAttribute("hidden", "");
        }

        function handleUnauthorized() {
            localStorage.removeItem("samprox_token");
            localStorage.removeItem("samprox_user");
            window.location.href = "/";
        }

        if (userNameEl) {
            userNameEl.textContent = user?.name || "Unknown";
        }
        if (userRoleEl) {
            userRoleEl.textContent = roleLabels[user?.role] || "";
        }

        if (logoutButton) {
            logoutButton.addEventListener("click", () => {
                handleUnauthorized();
            });
        }

        const monthNames = [
            "January",
            "February",
            "March",
            "April",
            "May",
            "June",
            "July",
            "August",
            "September",
            "October",
            "November",
            "December",
        ];

        const reportForm = document.getElementById("sales-report-form");
        const monthSelect = document.getElementById("sales-report-month");
        const yearSelect = document.getElementById("sales-report-year");
        const customerSelect = document.getElementById("sales-report-customer");
        const submitButton = document.getElementById("sales-report-submit");
        const feedbackEl = document.getElementById("sales-report-feedback");
        const overviewEl = document.getElementById("sales-report-overview");
        const resultsEl = document.getElementById("sales-report-results");
        const subtitleEl = document.getElementById("sales-report-subtitle");
        const summaryContainer = document.getElementById("sales-summary");
        const summaryStatusEl = document.getElementById("sales-summary-status");
        const summaryElements = {
            ytdQuantity: {
                valueEl: document.getElementById("summary-ytd-quantity"),
                lineEl: document.getElementById("summary-ytd-quantity-line"),
                fillEl: document.getElementById("summary-ytd-quantity-fill"),
            },
            ytdValue: {
                valueEl: document.getElementById("summary-ytd-value"),
                lineEl: document.getElementById("summary-ytd-value-line"),
                fillEl: document.getElementById("summary-ytd-value-fill"),
            },
            mtdSales: {
                valueEl: document.getElementById("summary-mtd-value"),
                quantityEl: document.getElementById("summary-mtd-quantity"),
                lineEl: document.getElementById("summary-mtd-value-line"),
                fillEl: document.getElementById("summary-mtd-value-fill"),
            },
            averagePrice: {
                valueEl: document.getElementById("summary-average-price"),
            },
            topCustomer: {
                nameEl: document.getElementById("summary-top-customer-name"),
                valueEl: document.getElementById("summary-top-customer-value"),
                quantityEl: document.getElementById("summary-top-customer-quantity"),
            },
        };

        const customerCategoryOptions = [
            { value: "plantation", label: "Plantation" },
            { value: "industrial", label: "Industrial" },
        ];
        const customerCreditTermOptions = [
            { value: "cash", label: "Cash" },
            { value: "14_days", label: "14 Days" },
            { value: "30_days", label: "30 Days" },
            { value: "45_days", label: "45 Days" },
            { value: "60_days", label: "60 Days" },
        ];
        const customerTransportOptions = [
            { value: "samprox_lorry", label: "Samprox lorry" },
            { value: "customer_lorry", label: "Customer lorry" },
        ];
        const customerTypeOptions = [
            { value: "regular", label: "Regular" },
            { value: "seasonal", label: "Seasonal" },
        ];

        const knownCustomers = new Map();
        let loaderOptions = [];
        const quantityFormatter = new Intl.NumberFormat(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
        });
        const currencyFormatter = new Intl.NumberFormat(undefined, {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
        });

        function populateSelectOptions(select, options) {
            if (!select) {
                return;
            }
            select.innerHTML = "";
            options.forEach((option) => {
                const el = document.createElement("option");
                el.value = option.value;
                el.textContent = option.label;
                select.appendChild(el);
            });
        }

        function populateCustomerFormOptions() {
            populateSelectOptions(customerCategorySelect, customerCategoryOptions);
            populateSelectOptions(customerCreditTermSelect, customerCreditTermOptions);
            populateSelectOptions(customerTransportSelect, customerTransportOptions);
            populateSelectOptions(customerTypeSelect, customerTypeOptions);
        }

        function formatNumber(value) {
            return quantityFormatter.format(value || 0);
        }

        function formatCurrencyNumber(value) {
            return currencyFormatter.format(value || 0);
        }

        function formatCurrency(value) {
            return `Rs ${formatCurrencyNumber(value)}`;
        }

        function formatTons(value) {
            return `${formatNumber(value)} tons`;
        }

        function formatUnitPrice(value) {
            return `Rs ${formatCurrencyNumber(value)} <span class="summary-card__unit">/ ton</span>`;
        }

        function formatFriendlyDate(value) {
            if (!value) {
                return "the selected date";
            }

            const parsed = new Date(value);
            if (Number.isNaN(parsed.getTime())) {
                return value;
            }

            return parsed.toLocaleDateString(undefined, {
                year: "numeric",
                month: "short",
                day: "numeric",
            });
        }

        function formatAverageUnitPrice(amount, quantity) {
            if (!quantity) {
                return "--";
            }

            const unitPrice = amount / quantity;
            return `Rs ${formatCurrencyNumber(unitPrice)} / ton`;
        }

        function extractFirstName(name) {
            if (typeof name !== "string") {
                return "";
            }

            const trimmed = name.trim();
            if (!trimmed) {
                return "";
            }

            const [firstName] = trimmed.split(/\s+/);
            return firstName || "";
        }

        function updateSubtitle(year, month) {
            if (!subtitleEl) {
                return;
            }
            if (!year || !month) {
                subtitleEl.textContent =
                    "Select a month and year to compare forecasted versus actual sales by customer.";
                return;
            }
            const monthIndex = Math.max(1, Math.min(12, Number(month))) - 1;
            const monthName = monthNames[monthIndex] || "";
            subtitleEl.textContent = `${monthName} ${year}`.trim();
        }

        function setFeedback(message, variant = "info") {
            if (!feedbackEl) {
                return;
            }

            const variants = ["sales-report__feedback--error", "sales-report__feedback--success", "sales-report__feedback--info"];
            feedbackEl.classList.remove("sales-report__feedback--visible", ...variants);

            if (!message) {
                feedbackEl.textContent = "";
                return;
            }

            feedbackEl.textContent = message;
            if (variant === "error") {
                feedbackEl.classList.add("sales-report__feedback--error");
            } else if (variant === "success") {
                feedbackEl.classList.add("sales-report__feedback--success");
            } else {
                feedbackEl.classList.add("sales-report__feedback--info");
            }
            feedbackEl.classList.add("sales-report__feedback--visible");
        }

        function clearOverview() {
            if (!overviewEl) {
                return;
            }

            overviewEl.classList.remove("sales-report__overview--visible");
            overviewEl.innerHTML = "";
        }

        function calculateOverviewMetrics(customers) {
            const totalCustomers = Array.isArray(customers) ? customers.length : 0;
            const metrics = {
                totals: {
                    forecastQuantity: 0,
                    forecastAmount: 0,
                    actualQuantity: 0,
                    actualAmount: 0,
                },
                counts: {
                    forecast: 0,
                    actual: 0,
                    total: totalCustomers,
                },
                forecastOnly: [],
                categories: {
                    industrial: {
                        customers: 0,
                        forecast: { quantity: 0, amount: 0 },
                        actual: { quantity: 0, amount: 0 },
                    },
                    plantation: {
                        customers: 0,
                        forecast: { quantity: 0, amount: 0 },
                        actual: { quantity: 0, amount: 0 },
                    },
                },
            };

            if (!Array.isArray(customers)) {
                return metrics;
            }

            customers.forEach((customer) => {
                const forecastQuantity = Number.parseFloat(customer?.monthly_forecast_quantity_tons ?? 0) || 0;
                const forecastAmount = Number.parseFloat(customer?.monthly_forecast_total ?? 0) || 0;
                const actualQuantity = Number.parseFloat(customer?.monthly_actual_quantity_tons ?? 0) || 0;
                const actualAmount = Number.parseFloat(customer?.monthly_actual_total ?? 0) || 0;
                const categoryKey = String(customer?.customer_category || "").toLowerCase();

                metrics.totals.forecastQuantity += forecastQuantity;
                metrics.totals.forecastAmount += forecastAmount;
                metrics.totals.actualQuantity += actualQuantity;
                metrics.totals.actualAmount += actualAmount;

                if (forecastQuantity > 0 || forecastAmount > 0) {
                    metrics.counts.forecast += 1;
                }
                if (actualQuantity > 0 || actualAmount > 0) {
                    metrics.counts.actual += 1;
                }
                if (
                    (forecastQuantity > 0 || forecastAmount > 0) &&
                    actualQuantity === 0 &&
                    actualAmount === 0
                ) {
                    const customerName = customer?.customer_name || customer?.name || "Unnamed customer";
                    metrics.forecastOnly.push(customerName);
                }

                const categoryBucket = metrics.categories[categoryKey];
                if (categoryBucket) {
                    categoryBucket.customers += 1;
                    categoryBucket.forecast.quantity += forecastQuantity;
                    categoryBucket.forecast.amount += forecastAmount;
                    categoryBucket.actual.quantity += actualQuantity;
                    categoryBucket.actual.amount += actualAmount;
                }
            });

            return metrics;
        }

        function createOverviewCard({ title, value, details = [], tone }) {
            const card = document.createElement("article");
            card.className = "sales-report__overview-card";
            if (tone) {
                card.classList.add(`sales-report__overview-card--${tone}`);
            }

            const titleEl = document.createElement("h4");
            titleEl.className = "sales-report__overview-card-title";
            titleEl.textContent = title;
            card.appendChild(titleEl);

            const valueEl = document.createElement("p");
            valueEl.className = "sales-report__overview-value";
            valueEl.textContent = value;
            card.appendChild(valueEl);

            details
                .filter(Boolean)
                .forEach((detail) => {
                    if (detail?.type === "list") {
                        const listEl = document.createElement("ul");
                        listEl.className = "sales-report__overview-list";
                        const items = Array.isArray(detail.items) ? detail.items : [];
                        if (items.length === 0) {
                            const itemEl = document.createElement("li");
                            itemEl.textContent = "None";
                            listEl.appendChild(itemEl);
                        } else {
                            items.forEach((item) => {
                                const itemEl = document.createElement("li");
                                itemEl.textContent = item;
                                listEl.appendChild(itemEl);
                            });
                        }
                        card.appendChild(listEl);
                    } else if (detail?.text) {
                        const detailEl = document.createElement("p");
                        detailEl.className = "sales-report__overview-detail";
                        detailEl.textContent = detail.text;
                        card.appendChild(detailEl);
                    }
                });

            return card;
        }

        function createOverviewGroup(title, cards) {
            const section = document.createElement("section");
            section.className = "sales-report__overview-group";

            const heading = document.createElement("h3");
            heading.className = "sales-report__overview-heading";
            heading.textContent = title;
            section.appendChild(heading);

            const grid = document.createElement("div");
            grid.className = "sales-report__overview-grid";
            cards.filter(Boolean).forEach((card) => {
                grid.appendChild(card);
            });
            section.appendChild(grid);

            return section;
        }

        function renderOverview(customers) {
            if (!overviewEl) {
                return;
            }

            clearOverview();

            if (!Array.isArray(customers) || customers.length === 0) {
                return;
            }

            const metrics = calculateOverviewMetrics(customers);
            overviewEl.classList.add("sales-report__overview--visible");

            const salesGroup = createOverviewGroup("Sales snapshot", [
                createOverviewCard({
                    title: "Forecast sales",
                    value: formatTons(metrics.totals.forecastQuantity),
                    details: [
                        { text: `Value: ${formatCurrency(metrics.totals.forecastAmount)}` },
                        {
                            text: `Avg unit price: ${formatAverageUnitPrice(
                                metrics.totals.forecastAmount,
                                metrics.totals.forecastQuantity,
                            )}`,
                        },
                    ],
                    tone: "forecast",
                }),
                createOverviewCard({
                    title: "Actual sales",
                    value: formatTons(metrics.totals.actualQuantity),
                    details: [
                        { text: `Value: ${formatCurrency(metrics.totals.actualAmount)}` },
                        {
                            text: `Avg unit price: ${formatAverageUnitPrice(
                                metrics.totals.actualAmount,
                                metrics.totals.actualQuantity,
                            )}`,
                        },
                    ],
                    tone: "actual",
                }),
            ]);

            const coverageGroup = createOverviewGroup("Customer coverage", [
                createOverviewCard({
                    title: "Customers with forecast",
                    value: String(metrics.counts.forecast),
                    details: [
                        {
                            text: `Out of ${metrics.counts.total} loaded ${
                                metrics.counts.total === 1 ? "customer" : "customers"
                            }`,
                        },
                    ],
                    tone: "forecast",
                }),
                createOverviewCard({
                    title: "Customers with actuals",
                    value: String(metrics.counts.actual),
                    details: [
                        {
                            text: `Out of ${metrics.counts.total} loaded ${
                                metrics.counts.total === 1 ? "customer" : "customers"
                            }`,
                        },
                    ],
                    tone: "actual",
                }),
                createOverviewCard({
                    title: "Forecast without orders",
                    value: String(metrics.forecastOnly.length),
                    details:
                        metrics.forecastOnly.length > 0
                            ? [
                                  {
                                      type: "list",
                                      items: metrics.forecastOnly.slice(0, 5),
                                  },
                                  metrics.forecastOnly.length > 5
                                      ? {
                                            text: `+${
                                                metrics.forecastOnly.length - 5
                                            } more forecast customers awaiting orders`,
                                        }
                                      : null,
                              ]
                            : [{ text: "All forecasted customers placed orders." }],
                    tone: metrics.forecastOnly.length ? "alert" : undefined,
                }),
            ]);

            const sections = [salesGroup, coverageGroup];

            const industrialStats = metrics.categories.industrial;
            if (industrialStats.customers > 0) {
                sections.push(
                    createOverviewGroup("Industrial channel", [
                        createOverviewCard({
                            title: "Forecast industrial sales",
                            value: formatTons(industrialStats.forecast.quantity),
                            details: [
                                { text: `Value: ${formatCurrency(industrialStats.forecast.amount)}` },
                                {
                                    text: `Avg unit price: ${formatAverageUnitPrice(
                                        industrialStats.forecast.amount,
                                        industrialStats.forecast.quantity,
                                    )}`,
                                },
                            ],
                            tone: "forecast",
                        }),
                        createOverviewCard({
                            title: "Actual industrial sales",
                            value: formatTons(industrialStats.actual.quantity),
                            details: [
                                { text: `Value: ${formatCurrency(industrialStats.actual.amount)}` },
                                {
                                    text: `Avg unit price: ${formatAverageUnitPrice(
                                        industrialStats.actual.amount,
                                        industrialStats.actual.quantity,
                                    )}`,
                                },
                            ],
                            tone: "actual",
                        }),
                    ]),
                );
            }

            const plantationStats = metrics.categories.plantation;
            if (plantationStats.customers > 0) {
                sections.push(
                    createOverviewGroup("Plantation channel", [
                        createOverviewCard({
                            title: "Forecast plantation sales",
                            value: formatTons(plantationStats.forecast.quantity),
                            details: [
                                { text: `Value: ${formatCurrency(plantationStats.forecast.amount)}` },
                                {
                                    text: `Avg unit price: ${formatAverageUnitPrice(
                                        plantationStats.forecast.amount,
                                        plantationStats.forecast.quantity,
                                    )}`,
                                },
                            ],
                            tone: "forecast",
                        }),
                        createOverviewCard({
                            title: "Actual plantation sales",
                            value: formatTons(plantationStats.actual.quantity),
                            details: [
                                { text: `Value: ${formatCurrency(plantationStats.actual.amount)}` },
                                {
                                    text: `Avg unit price: ${formatAverageUnitPrice(
                                        plantationStats.actual.amount,
                                        plantationStats.actual.quantity,
                                    )}`,
                                },
                            ],
                            tone: "actual",
                        }),
                    ]),
                );
            }

            sections.forEach((section) => {
                overviewEl.appendChild(section);
            });
        }

        function setEntryFeedback(message, variant = "info") {
            if (!entryFeedbackEl) {
                return;
            }

            const variants = ["sales-entry__feedback--error", "sales-entry__feedback--success"];
            entryFeedbackEl.classList.remove("sales-entry__feedback--visible", ...variants);

            if (!message) {
                entryFeedbackEl.textContent = "";
                return;
            }

            entryFeedbackEl.textContent = message;
            if (variant === "error") {
                entryFeedbackEl.classList.add("sales-entry__feedback--error");
            } else if (variant === "success") {
                entryFeedbackEl.classList.add("sales-entry__feedback--success");
            }
            entryFeedbackEl.classList.add("sales-entry__feedback--visible");
        }

        function renderEditingState() {
            if (!entryForm) {
                return;
            }

            if (currentEditingEntry) {
                entryForm.classList.add("sales-entry__form--editing");
            } else {
                entryForm.classList.remove("sales-entry__form--editing");
            }

            if (entrySubmitButton) {
                entrySubmitButton.textContent = currentEditingEntry ? "Update entry" : "Save entry";
            }

            if (!entryModeMessageEl) {
                return;
            }

            if (!currentEditingEntry) {
                entryModeMessageEl.textContent = "";
                entryModeMessageEl.classList.remove("sales-entry__mode--visible");
                return;
            }

            const friendlyType =
                currentEditingEntry.sale_type === "forecast" ? "forecast" : "actual";
            const displayDate = formatFriendlyDate(currentEditingEntry.date);
            entryModeMessageEl.textContent =
                `Editing existing ${friendlyType} entry for ${displayDate}. Updates will overwrite the saved values.`;
            entryModeMessageEl.classList.add("sales-entry__mode--visible");
        }

        function setEditingState(entry, saleType) {
            if (!entry) {
                currentEditingEntry = null;
                renderEditingState();
                return;
            }

            const normalizedSaleType = saleType === "forecast" ? "forecast" : "actual";
            currentEditingEntry = {
                id: entry.id != null ? String(entry.id) : null,
                sale_type: normalizedSaleType,
                date: entry.date || "",
                customer_id: entry.customer_id != null ? String(entry.customer_id) : "",
            };
            renderEditingState();
        }

        function clearSalesEntryValues() {
            if (entryUnitPriceInput) {
                entryUnitPriceInput.value = "";
            }
            if (entryQuantityInput) {
                entryQuantityInput.value = "";
            }
            if (entryDeliveryNoteInput) {
                entryDeliveryNoteInput.value = "";
            }
            if (entryWeighSlipInput) {
                entryWeighSlipInput.value = "";
            }
            loaderSelects.forEach((select) => {
                if (select) {
                    select.value = "";
                }
            });
            updateEntryTotal();
        }

        function populateSalesEntryForm(entry, saleType) {
            if (!entry) {
                return;
            }

            const normalizedSaleType = saleType === "forecast" ? "forecast" : "actual";

            if (entryCustomerSelect && entry.customer_id != null) {
                entryCustomerSelect.value = String(entry.customer_id);
            }

            if (entryDateInput && entry.date) {
                entryDateInput.value = entry.date;
            }

            if (entryTypeSelect) {
                entryTypeSelect.value = normalizedSaleType;
            }

            updateLoaderFieldState();

            if (entryUnitPriceInput) {
                entryUnitPriceInput.value =
                    entry.unit_price != null ? String(entry.unit_price) : "";
            }
            if (entryQuantityInput) {
                entryQuantityInput.value =
                    entry.quantity_tons != null ? String(entry.quantity_tons) : "";
            }

            if (normalizedSaleType === "actual") {
                if (entryDeliveryNoteInput) {
                    entryDeliveryNoteInput.value = entry.delivery_note_number || "";
                }
                if (entryWeighSlipInput) {
                    entryWeighSlipInput.value = entry.weigh_slip_number || "";
                }
                if (entryLoader1Select) {
                    entryLoader1Select.value = entry.loader1_id != null ? String(entry.loader1_id) : "";
                }
                if (entryLoader2Select) {
                    entryLoader2Select.value = entry.loader2_id != null ? String(entry.loader2_id) : "";
                }
                if (entryLoader3Select) {
                    entryLoader3Select.value = entry.loader3_id != null ? String(entry.loader3_id) : "";
                }
            } else {
                if (entryDeliveryNoteInput) {
                    entryDeliveryNoteInput.value = "";
                }
                if (entryWeighSlipInput) {
                    entryWeighSlipInput.value = "";
                }
                loaderSelects.forEach((select) => {
                    if (select) {
                        select.value = "";
                    }
                });
            }

            updateEntryTotal();
        }

        async function loadExistingEntryForSelection() {
            if (!token) {
                return;
            }

            const dateValue = entryDateInput?.value || "";
            const customerValue = entryCustomerSelect?.value || "";
            const saleTypeValue = entryTypeSelect?.value || "";

            if (
                !dateValue ||
                !customerValue ||
                customerValue === addCustomerOptionValue ||
                !saleTypeValue
            ) {
                setEditingState(null);
                clearSalesEntryValues();
                updateLoaderFieldState();
                return;
            }

            try {
                const params = new URLSearchParams({
                    customer_id: customerValue,
                    sale_type: saleTypeValue,
                    date: dateValue,
                });

                const response = await fetch(`/api/market/sales?${params.toString()}`, {
                    headers: {
                        Authorization: `Bearer ${token}`,
                        Accept: "application/json",
                    },
                });

                if (response.status === 401) {
                    handleUnauthorized();
                    return;
                }

                if (response.status === 404) {
                    setEditingState(null);
                    clearSalesEntryValues();
                    updateLoaderFieldState();
                    return;
                }

                const data = await response.json().catch(() => ({}));

                if (!response.ok) {
                    throw new Error(data.msg || "Unable to load saved entry.");
                }

                if (!data.entry) {
                    setEditingState(null);
                    clearSalesEntryValues();
                    updateLoaderFieldState();
                    return;
                }

                populateSalesEntryForm(data.entry, saleTypeValue);
                setEditingState(data.entry, saleTypeValue);
            } catch (error) {
                console.error(error);
                setEditingState(null);
                clearSalesEntryValues();
                updateLoaderFieldState();
                setEntryFeedback(error?.message || "Unable to load saved entry.", "error");
            }
        }

        function handleEntrySelectionChange(event) {
            if (currentEditingEntry && event?.target === entryDateInput) {
                currentEditingEntry.date = entryDateInput?.value || "";
                renderEditingState();
                return;
            }

            if (currentEditingEntry) {
                setEditingState(null);
                clearSalesEntryValues();
                updateLoaderFieldState();
            }

            loadExistingEntryForSelection();
        }

        function formatCustomerLabel(customer) {
            if (!customer) {
                return "";
            }
            return customer.code ? `${customer.code}  ${customer.name}` : customer.name;
        }

        function normalizeCustomer(customer) {
            if (!customer) {
                return null;
            }

            const id = customer.id ?? customer.customer_id;
            const name = customer.name ?? customer.customer_name;
            if (!id || !name) {
                return null;
            }

            return {
                ...customer,
                id: String(id),
                name,
                code: customer.code ?? customer.customer_code ?? null,
            };
        }

        function registerCustomers(customers) {
            if (!Array.isArray(customers)) {
                return;
            }

            customers.forEach((customer) => {
                const normalized = normalizeCustomer(customer);
                if (!normalized) {
                    return;
                }
                knownCustomers.set(normalized.id, normalized);
            });
        }

        function refreshCustomerSelectors() {
            const sorted = Array.from(knownCustomers.values()).sort((a, b) =>
                (a.name || "").localeCompare(b.name || "")
            );

            if (customerSelect) {
                const previousValue = customerSelect.value;
                customerSelect.innerHTML = "";
                const defaultOption = document.createElement("option");
                defaultOption.value = "";
                defaultOption.textContent = "All customers";
                customerSelect.appendChild(defaultOption);

                sorted.forEach((customer) => {
                    const option = document.createElement("option");
                    option.value = customer.id;
                    option.textContent = formatCustomerLabel(customer);
                    customerSelect.appendChild(option);
                });

                if (previousValue && customerSelect.querySelector(`option[value="${previousValue}"]`)) {
                    customerSelect.value = previousValue;
                }
            }

            if (entryCustomerSelect) {
                const previousValue =
                    entryCustomerSelect.value && entryCustomerSelect.value !== addCustomerOptionValue
                        ? entryCustomerSelect.value
                        : "";
                entryCustomerSelect.innerHTML = "";

                const placeholderOption = document.createElement("option");
                placeholderOption.value = "";
                placeholderOption.textContent = "Select a customer";
                entryCustomerSelect.appendChild(placeholderOption);

                const createOption = document.createElement("option");
                createOption.value = addCustomerOptionValue;
                createOption.textContent = " Add new customer";
                entryCustomerSelect.appendChild(createOption);

                sorted.forEach((customer) => {
                    const option = document.createElement("option");
                    option.value = customer.id;
                    option.textContent = formatCustomerLabel(customer);
                    entryCustomerSelect.appendChild(option);
                });

                if (previousValue && entryCustomerSelect.querySelector(`option[value="${previousValue}"]`)) {
                    entryCustomerSelect.value = previousValue;
                } else {
                    entryCustomerSelect.value = "";
                }
            }
        }

        function updateCustomerOptions(customers) {
            registerCustomers(customers);
            refreshCustomerSelectors();
        }

        function updateEntryTotal() {
            if (!entryTotalOutput) {
                return;
            }

            const unit = Number.parseFloat(entryUnitPriceInput?.value ?? "0");
            const quantity = Number.parseFloat(entryQuantityInput?.value ?? "0");
            const safeUnit = Number.isFinite(unit) ? unit : 0;
            const safeQuantity = Number.isFinite(quantity) ? quantity : 0;
            const total = safeUnit * safeQuantity;
            entryTotalOutput.textContent = formatCurrencyNumber(total || 0);
        }

        function updateLoaderFieldState() {
            const isActualSale = (entryTypeSelect?.value || "") === "actual";
            const relatedFields = [
                entryDeliveryNoteInput,
                entryWeighSlipInput,
                ...loaderSelects,
            ];

            relatedFields.forEach((field) => {
                if (!field) {
                    return;
                }

                field.disabled = !isActualSale;
                if (field.disabled) {
                    field.setAttribute("aria-disabled", "true");
                    if (typeof field.value === "string") {
                        field.value = "";
                    }
                } else {
                    field.removeAttribute("aria-disabled");
                }
            });

            if (entryDeliveryNoteInput) {
                entryDeliveryNoteInput.required = isActualSale;
            }
            if (entryLoader1Select) {
                entryLoader1Select.required = isActualSale;
            }
        }

        function normalizeLoaderMember(member) {
            if (!member || typeof member !== "object") {
                return null;
            }

            const rawId =
                member.id ?? member.teamMemberId ?? member.team_member_id ?? member.memberId;
            const parsedId = Number.parseInt(rawId, 10);
            if (!Number.isFinite(parsedId)) {
                return null;
            }

            const regNumber = String(member.regNumber ?? member.reg_number ?? "").trim();
            const name = String(member.name ?? "").trim();
            const label = regNumber && name
                ? `${regNumber}  ${name}`
                : name || regNumber || String(parsedId);

            return {
                id: String(parsedId),
                regNumber,
                name,
                label,
            };
        }

        function refreshLoaderSelectors() {
            loaderSelects.forEach((select) => {
                if (!select) {
                    return;
                }

                const previousValue = select.value;
                select.innerHTML = "";

                const placeholder = document.createElement("option");
                placeholder.value = "";
                placeholder.textContent = "Select loader";
                select.appendChild(placeholder);

                loaderOptions.forEach((option) => {
                    const optionEl = document.createElement("option");
                    optionEl.value = option.id;
                    optionEl.textContent = option.label;
                    select.appendChild(optionEl);
                });

                if (previousValue) {
                    const hasPrevious = loaderOptions.some((option) => option.id === previousValue);
                    select.value = hasPrevious ? previousValue : "";
                } else {
                    select.value = "";
                }
            });

            updateLoaderFieldState();
        }

        async function loadLoaderOptions() {
            if (!token) {
                loaderOptions = [];
                refreshLoaderSelectors();
                return;
            }

            try {
                const response = await fetch("/api/team/members", {
                    headers: {
                        Authorization: `Bearer ${token}`,
                        Accept: "application/json",
                    },
                });

                if (response.status === 401) {
                    handleUnauthorized();
                    return;
                }

                if (!response.ok) {
                    throw new Error("Unable to load loader details");
                }

                const data = await response.json().catch(() => []);
                const members = Array.isArray(data) ? data : [];
                loaderOptions = members
                    .map((member) => normalizeLoaderMember(member))
                    .filter(Boolean)
                    .sort((a, b) => a.label.localeCompare(b.label));
            } catch (error) {
                console.error(error);
                loaderOptions = [];
            } finally {
                refreshLoaderSelectors();
            }
        }

        function collectSalesEntryData() {
            const saleType = entryTypeSelect?.value || "";
            const isActualSale = saleType === "actual";

            const readTextValue = (input) => {
                if (!input || typeof input.value !== "string") {
                    return "";
                }
                return input.value.trim();
            };

            const readLoaderValue = (select) => {
                if (!select) {
                    return null;
                }
                const value = select.value;
                return value ? value : null;
            };

            const payload = {
                date: entryDateInput?.value || "",
                customer_id: entryCustomerSelect?.value || "",
                sale_type: saleType,
                unit_price: entryUnitPriceInput?.value || "",
                quantity_tons: entryQuantityInput?.value || "",
                delivery_note_number: isActualSale ? readTextValue(entryDeliveryNoteInput) : null,
                weigh_slip_number: isActualSale ? readTextValue(entryWeighSlipInput) : null,
                loader1_id: isActualSale ? readLoaderValue(entryLoader1Select) : null,
                loader2_id: isActualSale ? readLoaderValue(entryLoader2Select) : null,
                loader3_id: isActualSale ? readLoaderValue(entryLoader3Select) : null,
            };

            if (currentEditingEntry?.sale_type) {
                payload.sale_type = currentEditingEntry.sale_type;
            }

            return payload;
        }

        function resetSalesEntryForm(options = {}) {
            const { preserveSelection = false } = options;
            const preservedSelection = preserveSelection
                ? {
                      date: entryDateInput?.value || "",
                      customer: entryCustomerSelect?.value || "",
                      saleType: entryTypeSelect?.value || "",
                  }
                : null;

            entryForm?.reset();
            clearSalesEntryValues();

            if (preservedSelection) {
                if (entryCustomerSelect) {
                    entryCustomerSelect.value = preservedSelection.customer;
                }
                if (entryDateInput) {
                    entryDateInput.value = preservedSelection.date;
                }
                if (entryTypeSelect) {
                    entryTypeSelect.value = preservedSelection.saleType;
                }
            } else if (entryCustomerSelect) {
                entryCustomerSelect.value = "";
            }

            setEditingState(null);
            updateLoaderFieldState();
        }

        async function createCustomer(customerData) {
            if (!token) {
                return null;
            }

            const response = await fetch("/api/market/customers", {
                method: "POST",
                headers: {
                    Authorization: `Bearer ${token}`,
                    "Content-Type": "application/json",
                    Accept: "application/json",
                },
                body: JSON.stringify(customerData),
            });

            if (response.status === 401) {
                handleUnauthorized();
                return null;
            }

            const data = await response.json().catch(() => ({}));
            if (!response.ok) {
                if (response.status === 409 && data.customer) {
                    return { customer: data.customer, alreadyExists: true };
                }
                throw new Error(data.msg || "Unable to create customer.");
            }

            return { customer: data.customer, alreadyExists: false };
        }

        async function loadCustomers() {
            if (!token) {
                refreshCustomerSelectors();
                return;
            }

            try {
                const response = await fetch("/api/market/customers", {
                    headers: {
                        Authorization: `Bearer ${token}`,
                        Accept: "application/json",
                    },
                });

                if (response.status === 401) {
                    handleUnauthorized();
                    return;
                }

                if (!response.ok) {
                    throw new Error("Unable to load customers");
                }

                const data = await response.json();
                registerCustomers(data.customers || []);
            } catch (error) {
                console.error(error);
            } finally {
                refreshCustomerSelectors();
            }
        }

        function setSalesSummaryStatus(message, variant = "info") {
            if (!summaryContainer || !summaryStatusEl) {
                return;
            }

            summaryStatusEl.textContent = message || "";
            summaryContainer.classList.remove(
                "sales-summary--loading",
                "sales-summary--error",
                "sales-summary--success",
            );

            if (variant === "loading") {
                summaryContainer.classList.add("sales-summary--loading");
            } else if (variant === "error") {
                summaryContainer.classList.add("sales-summary--error");
            } else if (variant === "success") {
                summaryContainer.classList.add("sales-summary--success");
            }
        }

        function buildSparklinePoints(series) {
            if (!Array.isArray(series) || series.length === 0) {
                return { line: "", fill: "" };
            }

            const width = 100;
            const height = 36;
            const padding = 4;
            const bottom = height - padding;
            const maxValue = Math.max(...series, 0);
            const safeMax = maxValue > 0 ? maxValue : 1;
            const count = series.length;
            const step = count > 1 ? width / (count - 1) : 0;

            const points = series.map((value, index) => {
                const safeValue = Math.max(0, Number(value) || 0);
                const ratio = safeValue / safeMax;
                const x = count > 1 ? step * index : width / 2;
                const y = bottom - ratio * (height - padding * 2);
                return `${x.toFixed(2)},${y.toFixed(2)}`;
            });

            const firstX = count > 1 ? 0 : width / 2;
            const lastX = count > 1 ? width : width / 2;
            const fillPoints = `${firstX.toFixed(2)},${bottom.toFixed(2)} ${points.join(" ")} ${lastX.toFixed(2)},${bottom.toFixed(2)}`;

            return {
                line: points.join(" "),
                fill: fillPoints,
            };
        }

        function renderSparkline(lineEl, fillEl, series) {
            if (!lineEl || !fillEl) {
                return;
            }

            if (!Array.isArray(series) || series.length === 0) {
                lineEl.setAttribute("points", "");
                fillEl.setAttribute("points", "");
                return;
            }

            const { line, fill } = buildSparklinePoints(series);
            lineEl.setAttribute("points", line);
            fillEl.setAttribute("points", fill);
        }

        function applySalesSummary(data) {
            if (!data) {
                return;
            }

            const ytdQuantity = data?.year_to_date?.quantity_tons ?? 0;
            if (summaryElements.ytdQuantity.valueEl) {
                summaryElements.ytdQuantity.valueEl.textContent = formatTons(ytdQuantity);
            }
            renderSparkline(
                summaryElements.ytdQuantity.lineEl,
                summaryElements.ytdQuantity.fillEl,
                data?.year_to_date?.monthly_quantities || [],
            );

            const ytdValue = data?.year_to_date?.sales_value ?? 0;
            if (summaryElements.ytdValue.valueEl) {
                summaryElements.ytdValue.valueEl.textContent = formatCurrency(ytdValue);
            }
            renderSparkline(
                summaryElements.ytdValue.lineEl,
                summaryElements.ytdValue.fillEl,
                data?.year_to_date?.monthly_values || [],
            );

            const monthToDateValue = data?.month_to_date?.sales_value ?? 0;
            const monthToDateQuantity = data?.month_to_date?.quantity_tons ?? 0;
            if (summaryElements.mtdSales.valueEl) {
                summaryElements.mtdSales.valueEl.textContent = formatCurrency(monthToDateValue);
            }
            if (summaryElements.mtdSales.quantityEl) {
                summaryElements.mtdSales.quantityEl.textContent = `Qty: ${formatTons(monthToDateQuantity)}`;
            }
            renderSparkline(
                summaryElements.mtdSales.lineEl,
                summaryElements.mtdSales.fillEl,
                data?.month_to_date?.daily_values || [],
            );

            if (summaryElements.averagePrice.valueEl) {
                summaryElements.averagePrice.valueEl.innerHTML = formatUnitPrice(
                    data?.monthly_average_unit_price ?? 0,
                );
            }

            const topCustomer = data?.top_customer;
            if (topCustomer) {
                if (summaryElements.topCustomer.nameEl) {
                    const displayName =
                        extractFirstName(topCustomer.name) || `Customer ${topCustomer.id}`;
                    summaryElements.topCustomer.nameEl.textContent = displayName;
                }
                if (summaryElements.topCustomer.valueEl) {
                    summaryElements.topCustomer.valueEl.textContent = `Value: ${formatCurrency(
                        topCustomer.sales_value || 0,
                    )}`;
                }
                if (summaryElements.topCustomer.quantityEl) {
                    summaryElements.topCustomer.quantityEl.textContent = `Qty: ${formatTons(
                        topCustomer.quantity_tons || 0,
                    )}`;
                }
            } else {
                if (summaryElements.topCustomer.nameEl) {
                    summaryElements.topCustomer.nameEl.textContent = "No sales recorded";
                }
                if (summaryElements.topCustomer.valueEl) {
                    summaryElements.topCustomer.valueEl.textContent = "Value: --";
                }
                if (summaryElements.topCustomer.quantityEl) {
                    summaryElements.topCustomer.quantityEl.textContent = "Qty: --";
                }
            }
        }

        async function loadSalesSummary() {
            if (!token || !summaryContainer) {
                return;
            }

            setSalesSummaryStatus("Loading sales snapshot", "loading");

            try {
                const response = await fetch("/api/reports/sales-summary", {
                    headers: {
                        Authorization: `Bearer ${token}`,
                        Accept: "application/json",
                    },
                });

                if (response.status === 401) {
                    handleUnauthorized();
                    return;
                }

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ msg: "Unable to load sales summary." }));
                    throw new Error(errorData.msg || "Unable to load sales summary.");
                }

                const data = await response.json();
                applySalesSummary(data);

                const monthIndex = (Number(data?.month) || 1) - 1;
                const monthName = monthNames[monthIndex] || "";
                const periodLabel = monthName ? `${monthName} ${data?.year ?? ""}`.trim() : "the current period";
                setSalesSummaryStatus(`Updated for ${periodLabel}.`, "success");
            } catch (error) {
                console.error(error);
                setSalesSummaryStatus(error?.message || "Unable to load sales summary.", "error");
            }
        }

        function closeCustomerDialog() {
            if (!customerDialog) {
                return;
            }
            if (dialogSupported && typeof customerDialog.close === "function") {
                customerDialog.close();
                document.body.classList.remove("modal-polyfill-active");
            } else {
                customerDialog.removeAttribute("data-polyfill-open");
                customerDialog.setAttribute("hidden", "");
                customerDialog.removeAttribute("open");
                document.body.classList.remove("modal-polyfill-active");
                customerDialog.dispatchEvent(new Event("close"));
            }
            if (entryCustomerSelect && entryCustomerSelect.value === addCustomerOptionValue) {
                entryCustomerSelect.value = "";
            }
        }

        function resetCustomerForm() {
            if (customerForm) {
                customerForm.reset();
            }
            setCustomerFormFeedback("");
        }

        function setCustomerFormFeedback(message, variant = "error") {
            if (!customerFormFeedback) {
                return;
            }
            customerFormFeedback.textContent = message || "";
            customerFormFeedback.classList.remove(
                "modal__feedback--visible",
                "modal__feedback--error",
                "modal__feedback--success",
            );

            if (!message) {
                return;
            }

            if (variant === "success") {
                customerFormFeedback.classList.add("modal__feedback--success");
            } else {
                customerFormFeedback.classList.add("modal__feedback--error");
            }
            customerFormFeedback.classList.add("modal__feedback--visible");
        }

        function openCustomerDialog() {
            resetCustomerForm();
            populateCustomerFormOptions();
            if (customerDialog) {
                if (dialogSupported && typeof customerDialog.showModal === "function") {
                    customerDialog.showModal();
                } else {
                    customerDialog.setAttribute("data-polyfill-open", "true");
                    customerDialog.removeAttribute("hidden");
                    customerDialog.setAttribute("open", "");
                    document.body.classList.add("modal-polyfill-active");
                }
            }
            customerNameInput?.focus();
        }

        if (customerDialog) {
            if (dialogSupported) {
                customerDialog.addEventListener("cancel", (event) => {
                    event.preventDefault();
                    closeCustomerDialog();
                    resetCustomerForm();
                });
            }
            customerDialog.addEventListener("close", () => {
                document.body.classList.remove("modal-polyfill-active");
                if (!dialogSupported) {
                    customerDialog.removeAttribute("data-polyfill-open");
                    customerDialog.setAttribute("hidden", "");
                }
                if (entryCustomerSelect && entryCustomerSelect.value === addCustomerOptionValue) {
                    entryCustomerSelect.value = "";
                }
            });
            if (!dialogSupported) {
                document.addEventListener("keydown", (event) => {
                    if (event.key === "Escape" && customerDialog.hasAttribute("data-polyfill-open")) {
                        event.preventDefault();
                        closeCustomerDialog();
                        resetCustomerForm();
                    }
                });
            }
        }

        if (entryCustomerSelect) {
            entryCustomerSelect.addEventListener("change", (event) => {
                if (event.target.value === addCustomerOptionValue) {
                    event.target.value = "";
                    openCustomerDialog();
                    return;
                }
                handleEntrySelectionChange(event);
            });
        }

        if (entryDateInput) {
            entryDateInput.addEventListener("change", (event) => {
                handleEntrySelectionChange(event);
            });
        }

        if (entryUnitPriceInput) {
            entryUnitPriceInput.addEventListener("input", () => {
                updateEntryTotal();
            });
        }

        if (entryQuantityInput) {
            entryQuantityInput.addEventListener("input", () => {
                updateEntryTotal();
            });
        }

        if (entryTypeSelect) {
            entryTypeSelect.addEventListener("change", (event) => {
                updateLoaderFieldState();
                handleEntrySelectionChange(event);
            });
        }

        if (entryForm) {
            entryForm.addEventListener("submit", async (event) => {
                event.preventDefault();

                if (!token) {
                    handleUnauthorized();
                    return;
                }

                if (!entryForm.checkValidity()) {
                    entryForm.reportValidity();
                    return;
                }

                const payload = collectSalesEntryData();
                const isEditing = Boolean(currentEditingEntry?.id);

                if (!payload.customer_id || payload.customer_id === addCustomerOptionValue) {
                    setEntryFeedback("Please select a customer before saving the entry.", "error");
                    return;
                }

                setEntryFeedback("");

                if (entrySubmitButton) {
                    entrySubmitButton.disabled = true;
                }

                try {
                    const endpoint = isEditing
                        ? `/api/market/sales/${currentEditingEntry.id}`
                        : "/api/market/sales";
                    const method = isEditing ? "PUT" : "POST";
                    const response = await fetch(endpoint, {
                        method,
                        headers: {
                            Authorization: `Bearer ${token}`,
                            "Content-Type": "application/json",
                            Accept: "application/json",
                        },
                        body: JSON.stringify(payload),
                    });

                    if (response.status === 401) {
                        handleUnauthorized();
                        return;
                    }

                    const data = await response.json().catch(() => ({}));

                    if (!response.ok) {
                        throw new Error(data.msg || "Unable to save sales entry.");
                    }

                    const normalizedSaleType = payload.sale_type === "forecast" ? "forecast" : "actual";

                    if (isEditing) {
                        const successMessage =
                            normalizedSaleType === "forecast"
                                ? "Forecast sales entry updated successfully."
                                : "Actual sales entry updated successfully.";
                        setEntryFeedback(successMessage, "success");

                        if (data.entry) {
                            populateSalesEntryForm(data.entry, normalizedSaleType);
                            setEditingState(data.entry, normalizedSaleType);
                        } else if (currentEditingEntry) {
                            currentEditingEntry.date = payload.date || currentEditingEntry.date;
                            currentEditingEntry.customer_id = payload.customer_id || currentEditingEntry.customer_id;
                            currentEditingEntry.sale_type = normalizedSaleType;
                            renderEditingState();
                        }
                    } else {
                        resetSalesEntryForm();
                        const successMessage =
                            normalizedSaleType === "forecast"
                                ? "Forecast sales entry saved successfully."
                                : "Actual sales entry saved successfully.";
                        setEntryFeedback(successMessage, "success");
                    }

                    if (typeof loadReport === "function") {
                        loadReport();
                    }
                    if (typeof loadSalesSummary === "function") {
                        loadSalesSummary();
                    }
                } catch (error) {
                    console.error(error);
                    setEntryFeedback(error?.message || "Unable to save sales entry.", "error");
                } finally {
                    if (entrySubmitButton) {
                        entrySubmitButton.disabled = false;
                    }
                }
            });
        }

        renderEditingState();
        updateEntryTotal();

        if (entryAddCustomerButton) {
            entryAddCustomerButton.addEventListener("click", () => {
                openCustomerDialog();
            });
        }

        if (customerFormCancel) {
            customerFormCancel.addEventListener("click", (event) => {
                event.preventDefault();
                closeCustomerDialog();
                resetCustomerForm();
                if (entryCustomerSelect && entryCustomerSelect.value === addCustomerOptionValue) {
                    entryCustomerSelect.value = "";
                }
            });
        }

        function collectCustomerFormData() {
            const payload = {
                name: customerNameInput?.value?.trim() || "",
                category: customerCategorySelect?.value || "",
                credit_term: customerCreditTermSelect?.value || "",
                transport_mode: customerTransportSelect?.value || "",
                customer_type: customerTypeSelect?.value || "",
                sales_coordinator_name: customerSalesCoordinatorName?.value?.trim() || "",
                sales_coordinator_phone: customerSalesCoordinatorPhone?.value?.trim() || "",
                store_keeper_name: customerStoreKeeperName?.value?.trim() || "",
                store_keeper_phone: customerStoreKeeperPhone?.value?.trim() || "",
                payment_coordinator_name: customerPaymentCoordinatorName?.value?.trim() || "",
                payment_coordinator_phone: customerPaymentCoordinatorPhone?.value?.trim() || "",
                special_note: customerSpecialNote?.value?.trim() || "",
            };

            return payload;
        }

        if (customerForm) {
            customerForm.addEventListener("submit", async (event) => {
                event.preventDefault();
                if (!customerForm.checkValidity()) {
                    customerForm.reportValidity();
                    return;
                }

                const payload = collectCustomerFormData();
                const values = Object.values(payload);
                if (values.some((value) => value === "")) {
                    setCustomerFormFeedback("All fields are required.", "error");
                    return;
                }

                setCustomerFormFeedback("");
                if (customerFormSubmit) {
                    customerFormSubmit.disabled = true;
                }

                try {
                    const result = await createCustomer(payload);
                    if (!result || !result.customer) {
                        throw new Error("Unable to create customer.");
                    }

                    const { customer, alreadyExists } = result;
                    registerCustomers([customer]);
                    refreshCustomerSelectors();
                    closeCustomerDialog();
                    resetCustomerForm();

                    const customerIdValue = customer.id ?? customer.customer_id;
                    if (entryCustomerSelect && customerIdValue) {
                        entryCustomerSelect.value = String(customerIdValue);
                    }

                    const code = customer.code ?? customer.customer_code ?? customerIdValue;
                    const message = alreadyExists
                        ? `Customer "${customer.name}" already exists and is ready to use.`
                        : `Customer "${customer.name}" (ID ${code}) created successfully.`;
                    setEntryFeedback(message, "success");
                } catch (error) {
                    console.error(error);
                    setCustomerFormFeedback(error?.message || "Unable to create customer.");
                } finally {
                    if (customerFormSubmit) {
                        customerFormSubmit.disabled = false;
                    }
                }
            });
        }

        updateLoaderFieldState();
        populateCustomerFormOptions();
        refreshCustomerSelectors();
        refreshLoaderSelectors();
        loadCustomers();
        loadLoaderOptions();
        loadSalesSummary();

        function beginEditingEntry(customerId, dateValue, saleType, options = {}) {
            if (!entryForm) {
                return;
            }

            const normalizedType = saleType === "forecast" ? "forecast" : "actual";
            const normalizedCustomerId =
                customerId !== undefined && customerId !== null ? String(customerId) : "";
            const normalizedDate = dateValue || "";
            const { loadExistingEntry = true } = options;

            if (entryCustomerSelect) {
                entryCustomerSelect.value = normalizedCustomerId;
            }
            if (entryTypeSelect) {
                entryTypeSelect.value = normalizedType;
            }
            if (entryDateInput) {
                entryDateInput.value = normalizedDate;
            }

            updateLoaderFieldState();

            if (loadExistingEntry) {
                loadExistingEntryForSelection();
            } else {
                setEditingState(null);
                clearSalesEntryValues();
                renderEditingState();
                setEntryFeedback("");
            }

            if (typeof entryForm.scrollIntoView === "function") {
                entryForm.scrollIntoView({ behavior: "smooth", block: "start" });
            }

            if (entryDateInput && typeof entryDateInput.focus === "function") {
                window.setTimeout(() => {
                    try {
                        entryDateInput.focus({ preventScroll: true });
                    } catch (_) {
                        entryDateInput.focus();
                    }
                }, 180);
            }
        }

        function createSalesActionButton({
            label,
            saleType,
            customerId,
            date,
            hasEntry,
        }) {
            const button = document.createElement("button");
            button.type = "button";
            button.className = "button button--ghost button--small sales-report__action-button";
            button.textContent = label;
            const saleTypeLabel = saleType === "forecast" ? "forecast" : "actual";
            button.setAttribute(
                "aria-label",
                `${label} entry for ${formatFriendlyDate(date) || date} (${saleTypeLabel})`,
            );
            button.addEventListener("click", () => {
                beginEditingEntry(customerId, date, saleType, {
                    loadExistingEntry: Boolean(hasEntry),
                });
            });
            return button;
        }

        function renderCustomer(customer) {
            const card = document.createElement("article");
            card.className = "sales-report__customer";

            const header = document.createElement("div");
            header.className = "sales-report__customer-header";

            const headingWrapper = document.createElement("div");
            const nameEl = document.createElement("h3");
            nameEl.className = "sales-report__customer-name";
            nameEl.textContent = customer.customer_name;
            headingWrapper.appendChild(nameEl);

            const summaryEl = document.createElement("p");
            summaryEl.className = "sales-report__customer-summary";
            summaryEl.textContent = "Daily comparison of forecasted and actual sales.";
            headingWrapper.appendChild(summaryEl);

            const totals = document.createElement("dl");
            totals.className = "sales-report__totals";

            const forecastQuantity = customer.monthly_forecast_quantity_tons || 0;
            const actualQuantity = customer.monthly_actual_quantity_tons || 0;
            const variance = actualQuantity - forecastQuantity;
            const averageUnitPrice = customer.monthly_average_unit_price || 0;
            const totalSales =
                customer.monthly_total_sales_amount ?? customer.monthly_actual_total ?? 0;
            const totalsConfig = [
                { label: "Month Forecast Total (Qty)", value: forecastQuantity, formatter: formatNumber },
                { label: "Month Actual Total (Qty)", value: actualQuantity, formatter: formatNumber },
                { label: "Variance qty (tons)", value: variance, formatter: formatNumber },
                {
                    label: "Month Average Unit Price (Rs.)",
                    value: averageUnitPrice,
                    formatter: formatCurrencyNumber,
                },
                {
                    label: "Month Total Sales (Rs.)",
                    value: totalSales,
                    formatter: formatCurrencyNumber,
                },
            ];

            totalsConfig.forEach(({ label, value, formatter = formatNumber }) => {
                const group = document.createElement("div");
                group.className = "sales-report__totals-item";
                const dt = document.createElement("dt");
                dt.textContent = label;
                const dd = document.createElement("dd");
                dd.textContent = formatter(value);
                dd.className = "sales-report__totals-value";
                if (label.toLowerCase().includes("variance")) {
                    if (value > 0) {
                        dd.classList.add("sales-report__variance--positive");
                    } else if (value < 0) {
                        dd.classList.add("sales-report__variance--negative");
                    }
                }
                group.appendChild(dt);
                group.appendChild(dd);
                totals.appendChild(group);
            });

            header.appendChild(headingWrapper);
            header.appendChild(totals);
            card.appendChild(header);

            const table = document.createElement("table");
            table.className = "sales-report__table";

            const thead = document.createElement("thead");
            const headRow = document.createElement("tr");
            const tableColumns = [
                { label: "Date" },
                { label: "Forecast qty (tons)", className: "sales-report__cell--numeric" },
                { label: "Actual qty (tons)", className: "sales-report__cell--numeric" },
                { label: "Variance qty (tons)", className: "sales-report__cell--numeric" },
                { label: "Actions", className: "sales-report__cell--actions" },
            ];
            tableColumns.forEach(({ label, className }) => {
                const th = document.createElement("th");
                th.textContent = label;
                if (className) {
                    th.className = className;
                }
                headRow.appendChild(th);
            });
            thead.appendChild(headRow);
            table.appendChild(thead);

            const tbody = document.createElement("tbody");
            const customerId = customer.customer_id ?? customer.id ?? null;

            if (!customer.dates.length) {
                const row = document.createElement("tr");
                const cell = document.createElement("td");
                cell.colSpan = tableColumns.length;
                cell.className = "sales-report__empty-row";
                cell.textContent = "No sales recorded for this customer.";
                row.appendChild(cell);
                tbody.appendChild(row);
            } else {
                customer.dates.forEach((entry) => {
                    const row = document.createElement("tr");

                    const dateCell = document.createElement("td");
                    dateCell.textContent = entry.date;
                    row.appendChild(dateCell);

                    const forecastCell = document.createElement("td");
                    forecastCell.textContent = formatNumber(entry.forecast_quantity_tons);
                    forecastCell.className = "sales-report__cell--numeric";
                    row.appendChild(forecastCell);

                    const actualCell = document.createElement("td");
                    actualCell.textContent = formatNumber(entry.actual_quantity_tons);
                    actualCell.className = "sales-report__cell--numeric";
                    row.appendChild(actualCell);

                    const varianceValue =
                        (entry.actual_quantity_tons || 0) - (entry.forecast_quantity_tons || 0);
                    const varianceCell = document.createElement("td");
                    varianceCell.textContent = formatNumber(varianceValue);
                    varianceCell.className = "sales-report__cell--numeric";
                    if (varianceValue > 0) {
                        varianceCell.classList.add("sales-report__variance--positive");
                    } else if (varianceValue < 0) {
                        varianceCell.classList.add("sales-report__variance--negative");
                    }
                    row.appendChild(varianceCell);

                    const actionsCell = document.createElement("td");
                    actionsCell.className = "sales-report__cell--actions";
                    const actionsWrapper = document.createElement("div");
                    actionsWrapper.className = "sales-report__actions";

                    const hasForecastEntry = Boolean(entry.has_forecast_entry);
                    const hasActualEntry = Boolean(entry.has_actual_entry);

                    if (hasForecastEntry && customerId !== null) {
                        actionsWrapper.appendChild(
                            createSalesActionButton({
                                label: "Edit forecast",
                                saleType: "forecast",
                                customerId,
                                date: entry.date,
                                hasEntry: true,
                            }),
                        );
                    }

                    if (hasActualEntry && customerId !== null) {
                        actionsWrapper.appendChild(
                            createSalesActionButton({
                                label: "Edit actual",
                                saleType: "actual",
                                customerId,
                                date: entry.date,
                                hasEntry: true,
                            }),
                        );
                    }

                    if (actionsWrapper.children.length === 0) {
                        const placeholder = document.createElement("span");
                        placeholder.className = "sales-report__actions-placeholder";
                        placeholder.textContent = "No entries";
                        actionsWrapper.appendChild(placeholder);
                    }

                    actionsCell.appendChild(actionsWrapper);
                    row.appendChild(actionsCell);

                    tbody.appendChild(row);
                });
            }

            table.appendChild(tbody);
            card.appendChild(table);
            return card;
        }

        function renderReport(data) {
            if (!resultsEl) {
                return;
            }

            clearOverview();
            resultsEl.innerHTML = "";
            if (!data || !Array.isArray(data.customers) || data.customers.length === 0) {
                const empty = document.createElement("p");
                empty.className = "sales-report__empty";
                empty.textContent = "No sales data available for the selected period.";
                resultsEl.appendChild(empty);
                return;
            }

            renderOverview(data.customers);
            const container = document.createElement("div");
            container.className = "sales-report__customers";

            data.customers.forEach((customer) => {
                container.appendChild(renderCustomer(customer));
            });

            resultsEl.appendChild(container);
        }

        function populateSelectors() {
            if (!monthSelect || !yearSelect) {
                return;
            }

            const now = new Date();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();

            monthNames.forEach((name, index) => {
                const option = document.createElement("option");
                option.value = String(index + 1);
                option.textContent = name;
                monthSelect.appendChild(option);
            });

            const startYear = currentYear - 2;
            const endYear = currentYear + 1;
            for (let year = endYear; year >= startYear; year -= 1) {
                const option = document.createElement("option");
                option.value = String(year);
                option.textContent = String(year);
                yearSelect.appendChild(option);
            }

            monthSelect.value = String(currentMonth);
            yearSelect.value = String(currentYear);
            updateSubtitle(currentYear, currentMonth);
        }

        async function loadReport() {
            if (!token) {
                return;
            }

            const year = yearSelect.value;
            const month = monthSelect.value;

            updateSubtitle(year, month);
            setFeedback("Loading customer sales", "info");
            clearOverview();
            resultsEl.innerHTML = '<p class="sales-report__loading">Loading report</p>';

            submitButton.disabled = true;

            try {
                const params = new URLSearchParams({
                    year: String(year),
                    month: String(month),
                });
                if (customerSelect && customerSelect.value) {
                    params.append("customer_id", customerSelect.value);
                }

                const response = await fetch(`/api/reports/customer-sales?${params.toString()}`, {
                    headers: {
                        Authorization: `Bearer ${token}`,
                        Accept: "application/json",
                    },
                });

                if (response.status === 401) {
                    localStorage.removeItem("samprox_token");
                    localStorage.removeItem("samprox_user");
                    window.location.href = "/";
                    return;
                }

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ msg: "Unable to load report" }));
                    throw new Error(errorData.msg || "Unable to load report");
                }

                const data = await response.json();
                updateCustomerOptions(data.customers || []);
                renderReport(data);

                if (data.customers && data.customers.length > 0) {
                    const totalCustomers = data.customers.length;
                    setFeedback(
                        `Showing sales data for ${totalCustomers} ${totalCustomers === 1 ? "customer" : "customers"}.`,
                        "success",
                    );
                } else {
                    setFeedback("No sales data recorded for the selected period.", "info");
                }
            } catch (error) {
                console.error(error);
                resultsEl.innerHTML = "";
                clearOverview();
                const errorMessage = error?.message || "Unable to load report.";
                setFeedback(errorMessage, "error");
            } finally {
                submitButton.disabled = false;
            }
        }

        if (reportForm) {
            populateSelectors();
            reportForm.addEventListener("submit", (event) => {
                event.preventDefault();
                loadReport();
            });
            loadReport();
        }
    </script>
</body>
</html>
