<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Machines | SAMPROX ERP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/machines.css') }}" />
</head>
<body>
    <div class="page">
        <header class="topbar">
            <div class="brand">
                <div class="brand__logo">S</div>
                <div class="brand__details">
                    <p class="brand__name">SAMPROX ERP</p>
                    <p class="brand__section">Machine Centre</p>
                </div>
            </div>
            <div class="topbar__actions">
                <a class="button button--ghost" href="{{ url_for('ui.mind_page') }}">Mind</a>
                <div class="user-summary">
                    <span class="user-summary__name" id="user-name"></span>
                    <span class="user-summary__role" id="user-role"></span>
                </div>
                <button type="button" class="button button--secondary" id="logout">Sign out</button>
            </div>
        </header>
        <nav class="subnav" aria-label="7M navigation">
            <a class="subnav__link" href="{{ url_for('ui.mind_page') }}">Mind</a>
            <a class="subnav__link" href="{{ url_for('ui.man_page') }}">Man</a>
            <a class="subnav__link subnav__link--active" href="{{ url_for('ui.machines_page') }}">Machine</a>
            <a class="subnav__link" href="{{ url_for('ui.material_page') }}">Material</a>
            <a class="subnav__link" href="{{ url_for('ui.market_page') }}">Market</a>
            <a class="subnav__link" href="{{ url_for('ui.manufacturing_page') }}">Manufacturing</a>
            <a class="subnav__link" href="{{ url_for('ui.money_page') }}">Money</a>
        </nav>
        <main class="machine-layout">
            <div class="machine-tabs" role="tablist" aria-label="Machine subsections">
                <button type="button" id="tab-button-assets" class="machine-tab is-active" role="tab" aria-selected="true" aria-controls="tab-assets" data-tab-target="assets">Assets Register</button>
                <button type="button" id="tab-button-maintenance" class="machine-tab" role="tab" aria-selected="false" aria-controls="tab-maintenance" data-tab-target="maintenance">Maintenance Management</button>
                <button type="button" id="tab-button-idle" class="machine-tab" role="tab" aria-selected="false" aria-controls="tab-idle" data-tab-target="idle">Idle Time Monitoring</button>
                <button type="button" id="tab-button-suppliers" class="machine-tab" role="tab" aria-selected="false" aria-controls="tab-suppliers" data-tab-target="suppliers">Service Supplier Register</button>
            </div>
            <div class="machine-panels">
                                <section id="tab-assets" class="tab-panel is-active" role="tabpanel" aria-labelledby="tab-button-assets" data-tab-panel="assets">
                    <section id="machine-inputs" class="panel-group">
                        <header class="panel-group__header">
                            <h2>Inputs</h2>
                            <p>Capture the latest machine information for your records.</p>
                        </header>
                        <div class="panel-grid">
                            <section class="panel panel--menu">
                                <header class="panel__header">
                                    <div>
                                        <h3>Input actions</h3>
                                        <p class="panel__subtitle">Choose an action to open it in a popup without leaving the page.</p>
                                    </div>
                                </header>
                                <div class="panel__body">
                                    <nav class="input-menu" data-input-menu>
                                        <button type="button" class="input-menu__toggle" data-menu-toggle aria-expanded="false">
                                            <span>Inputs</span>
                                            <span class="input-menu__chevron" aria-hidden="true"></span>
                                        </button>
                                        <ul class="input-menu__list" data-menu-list>
                                            <li class="input-menu__item">
                                                <button type="button" class="input-menu__link" data-modal-open="asset-modal">Add new asset</button>
                                            </li>
                                            <li class="input-menu__item">
                                                <button type="button" class="input-menu__link" data-modal-open="ckd-modal">Add CKD part to machine</button>
                                            </li>
                                            <li class="input-menu__item">
                                                <button type="button" class="input-menu__link" data-modal-open="maintenance-modal">Request maintenance job</button>
                                            </li>
                                        </ul>
                                    </nav>
                                </div>
                            </section>
                        </div>
                    </section>
                    <section id="machine-outputs" class="panel-group">
                        <header class="panel-group__header">
                            <h2>Outputs</h2>
                            <p>Review the current state of the machine fleet and its parts.</p>
                        </header>
                        <div class="panel-grid">
                            <section class="panel panel--list">
                                <header class="panel__header">
                                    <div>
                                        <h3>Assets register</h3>
                                        <p class="panel__subtitle">All assets with quick access to CKD part lists.</p>
                                    </div>
                                    <div class="panel__header-actions">
                                        <button type="button" class="button button--ghost" id="refresh-assets">Refresh</button>
                                    </div>
                                </header>
                                <div class="panel__body">
                                    <div class="alert alert--error" id="asset-error" hidden></div>
                                    <div class="empty-state" id="assets-empty" hidden>
                                        <p>No assets have been registered yet.</p>
                                    </div>
                                    <div class="table-wrapper">
                                        <table class="data-table" aria-describedby="assets-empty">
                                            <thead>
                                                <tr>
                                                    <th scope="col">Code</th>
                                                    <th scope="col">Name</th>
                                                    <th scope="col">Location</th>
                                                    <th scope="col">Status</th>
                                                    <th scope="col">Parts</th>
                                                    <th scope="col">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="assets-table-body"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </section>
                        </div>
                        <section class="panel panel--detail" id="asset-detail" hidden>
                            <header class="panel__header">
                                <div>
                                    <h2 id="asset-detail-title"></h2>
                                    <p class="panel__subtitle" id="asset-detail-meta"></p>
                                </div>
                                <button type="button" class="button button--ghost" id="close-asset-detail">Close</button>
                            </header>
                            <div class="panel__body asset-detail__body">
                                <div class="asset-detail__column">
                                    <h3>Asset information</h3>
                                    <dl class="asset-detail__facts" id="asset-detail-facts"></dl>
                                </div>
                                <div class="asset-detail__column asset-detail__column--wide">
                                    <section class="asset-parts">
                                        <header class="asset-parts__header">
                                            <h3>Complete knock down (CKD) parts</h3>
                                            <div class="asset-parts__search">
                                                <label class="visually-hidden" for="asset-part-search">Search CKD parts</label>
                                                <input
                                                    id="asset-part-search"
                                                    class="asset-parts__search-input"
                                                    type="search"
                                                    name="asset-part-search"
                                                    placeholder="Search parts"
                                                    autocomplete="off"
                                                    spellcheck="false"
                                                />
                                            </div>
                                        </header>
                                        <div class="alert alert--error" id="asset-part-error" hidden></div>
                                        <div class="alert alert--success" id="asset-part-success" hidden>Part added successfully.</div>
                                        <form class="form asset-part-form" id="asset-part-form" novalidate>
                                            <div class="form-grid">
                                                <div class="input-group">
                                                    <label for="part-name">Part name <span class="required">*</span></label>
                                                    <input id="part-name" name="name" type="text" placeholder="Hydraulic pump" required />
                                                </div>
                                                <div class="input-group">
                                                    <label for="part-number">Part number <span class="required">*</span></label>
                                                    <input id="part-number" name="part_number" type="text" placeholder="P-009" required readonly />
                                                </div>
                                                <div class="input-group">
                                                    <label for="part-life">Expected life (hrs)</label>
                                                    <input id="part-life" name="expected_life_hours" type="number" min="0" step="1" />
                                                </div>
                                            </div>
                                            <div class="input-group">
                                                <label for="part-description">Description</label>
                                                <textarea id="part-description" name="description" rows="2" placeholder="Reference or specification"></textarea>
                                            </div>
                                            <div class="input-group">
                                                <label for="part-notes">Notes</label>
                                                <textarea id="part-notes" name="notes" rows="2" placeholder="Storage, supplier, etc."></textarea>
                                            </div>
                                            <div class="form__footer">
                                                <button type="submit" class="button">Add part</button>
                                            </div>
                                        </form>
                                        <div class="asset-parts__list" id="asset-parts-list"></div>
                                        <div class="empty-state" id="asset-parts-empty" hidden>
                                            <p>No parts have been registered for this asset yet.</p>
                                        </div>
                                    </section>
                                </div>
                            </div>
                        </section>
                    </section>
                <section id="tab-maintenance" class="tab-panel" role="tabpanel" aria-labelledby="tab-button-maintenance" data-tab-panel="maintenance" hidden>
                    <div class="panel-grid">
                        <section class="panel panel--form">
                            <header class="panel__header">
                                <div>
                                    <h2>Create a maintenance job</h2>
                                    <p class="panel__subtitle">Log new work orders for the maintenance team.</p>
                                </div>
                            </header>
                            <div class="panel__body">
                                <div class="alert alert--info" id="creation-notice" hidden></div>
                                <div class="alert alert--success" id="creation-success" hidden>Job created successfully.</div>
                                <div class="alert alert--error" id="creation-error" hidden></div>
                                <form class="form" id="job-form" novalidate>
                                    <div class="form-grid">
                                        <div class="input-group">
                                            <label for="code">Job code <span class="required">*</span></label>
                                            <input id="code" name="code" type="text" placeholder="JOB-001" required />
                                        </div>
                                        <div class="input-group">
                                            <label for="title">Title <span class="required">*</span></label>
                                            <input id="title" name="title" type="text" placeholder="Routine maintenance" required />
                                        </div>
                                        <div class="input-group">
                                            <label for="priority">Priority</label>
                                            <select id="priority" name="priority">
                                                <option value="Normal" selected>Normal</option>
                                                <option value="High">High</option>
                                                <option value="Low">Low</option>
                                            </select>
                                        </div>
                                        <div class="input-group">
                                            <label for="location">Location</label>
                                            <input id="location" name="location" type="text" placeholder="Plant 1" />
                                        </div>
                                        <div class="input-group">
                                            <label for="expected_completion_date">Expected completion</label>
                                            <input id="expected_completion_date" name="expected_completion_date" type="date" />
                                        </div>
                                    </div>
                                    <div class="input-group">
                                        <label for="description">Description</label>
                                        <textarea id="description" name="description" rows="4" placeholder="Provide any additional details"></textarea>
                                    </div>
                                    <div class="form__footer">
                                        <button type="submit" class="button">Create job</button>
                                    </div>
                                </form>
                            </div>
                        </section>
                        <section class="panel panel--list">
                            <header class="panel__header">
                                <div>
                                    <h2>Maintenance jobs</h2>
                                    <p class="panel__subtitle">Latest jobs ordered by creation date.</p>
                                </div>
                                <button type="button" class="button button--ghost" id="refresh-jobs">Refresh</button>
                            </header>
                            <div class="panel__body">
                                <div class="alert alert--error" id="jobs-error" hidden></div>
                                <div class="empty-state" id="jobs-empty" hidden>
                                    <p>No jobs have been created yet.</p>
                                </div>
                                <div class="table-wrapper">
                                    <table class="jobs-table" aria-describedby="jobs-empty">
                                        <thead>
                                            <tr>
                                                <th scope="col">Code</th>
                                                <th scope="col">Title</th>
                                                <th scope="col">Status</th>
                                                <th scope="col">Priority</th>
                                                <th scope="col">Assigned</th>
                                                <th scope="col">Expected completion</th>
                                                <th scope="col">Created</th>
                                            </tr>
                                        </thead>
                                        <tbody id="jobs-table-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </section>
                    </div>
                </section>
                <section id="tab-idle" class="tab-panel" role="tabpanel" aria-labelledby="tab-button-idle" data-tab-panel="idle" hidden>
                    <section class="idle-hero">
                        <div class="idle-hero__content">
                            <p class="idle-hero__eyebrow">Intelligent downtime radar</p>
                            <h2>Daily machine utilisation pulse</h2>
                            <p>Capture hour meter readings, quantify idle time instantly and surface the reason behind every lull.</p>
                        </div>
                        <div class="idle-hero__controls">
                            <label for="idle-date">Analysis date</label>
                            <input id="idle-date" type="date" name="analysis_date" />
                        </div>
                        <div class="idle-hero__stats">
                            <div class="idle-stat">
                                <span class="idle-stat__label">Total runtime</span>
                                <span class="idle-stat__value" data-total-runtime>0 h</span>
                                <span class="idle-stat__hint">Including overtime</span>
                            </div>
                            <div class="idle-stat">
                                <span class="idle-stat__label">Idle within shift</span>
                                <span class="idle-stat__value" data-total-idle>0 h</span>
                                <span class="idle-stat__hint">07:00 &ndash; 19:00 window</span>
                            </div>
                            <div class="idle-stat">
                                <span class="idle-stat__label">Captured overtime</span>
                                <span class="idle-stat__value" data-total-extended>0 h</span>
                                <span class="idle-stat__hint">Beyond 19:00</span>
                            </div>
                        </div>
                    </section>
                    <div class="panel-grid idle-grid">
                        <section class="panel idle-panel idle-panel--form">
                            <header class="panel__header">
                                <div>
                                    <h2>Log downtime window</h2>
                                    <p class="panel__subtitle">Capture when the machine stopped, why it happened and any recovery notes.</p>
                                </div>
                            </header>
                            <div class="panel__body">
                                <div class="alert alert--info" id="idle-entry-notice" hidden></div>
                                <div class="alert alert--success" id="idle-entry-success" hidden></div>
                                <div class="alert alert--error" id="idle-entry-error" hidden></div>
                                <form class="form idle-form" id="idle-entry-form" novalidate>
                                    <div class="idle-form__grid">
                                        <div class="input-group">
                                            <label for="idle-machine">Machine <span class="required">*</span></label>
                                            <select id="idle-machine" name="machine" required>
                                                <option value="MCH-0001">MCH-0001 — Cutting Cell</option>
                                                <option value="MCH-0002">MCH-0002 — Precision Lathe</option>
                                                <option value="MCH-0003">MCH-0003 — Finishing Line</option>
                                            </select>
                                        </div>
                                        <div class="input-group">
                                            <label for="idle-start-time">Idle started <span class="required">*</span></label>
                                            <input id="idle-start-time" name="start_time" type="time" step="300" required />
                                            <span class="input-hint">Local plant time (e.g. 07:15)</span>
                                        </div>
                                        <div class="input-group">
                                            <label for="idle-end-time">Idle cleared</label>
                                            <input id="idle-end-time" name="end_time" type="time" step="300" />
                                            <span class="input-hint">Leave blank if the stoppage is still ongoing.</span>
                                        </div>
                                        <div class="input-group">
                                            <label for="idle-reason">Primary idle reason</label>
                                            <select id="idle-reason" name="reason">
                                                <option value="">No idle &mdash; full run</option>
                                                <option value="Machine break down">Machine break down</option>
                                                <option value="No Labor Force">No Labor Force</option>
                                                <option value="No Material">No Material</option>
                                                <option value="Planned maintenance">Planned maintenance</option>
                                                <option value="Changeover / setup">Changeover / setup</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="input-group">
                                        <label for="idle-notes">Notes</label>
                                        <textarea id="idle-notes" name="notes" rows="2" placeholder="Add context, corrective action or follow-up"></textarea>
                                    </div>
                                    <div class="form__footer">
                                        <button type="submit" class="button">Save idle record</button>
                                    </div>
                                </form>
                            </div>
                        </section>
                        <section class="panel idle-panel idle-panel--chart">
                            <header class="panel__header">
                                <div>
                                    <h2>Running vs idle hours</h2>
                                    <p class="panel__subtitle">Stacked comparison for the 07:00 &ndash; 19:00 shift plus captured overtime.</p>
                                </div>
                            </header>
                            <div class="panel__body idle-chart-wrapper">
                                <canvas id="idle-chart" role="img" aria-label="Machine running, idle and overtime hours"></canvas>
                                <p class="idle-chart__legend-hint">Standard shift = 11 productive hours (60 minutes paused for lunch).</p>
                            </div>
                        </section>
                    </div>
                    <section class="panel idle-machines">
                        <header class="idle-machines__header">
                            <div>
                                <h2>Machine spotlight</h2>
                                <p class="panel__subtitle">Realtime utilisation pulse with reason-led idle windows.</p>
                            </div>
                        </header>
                        <div class="idle-machine-grid">
                            <article class="machine-glance" data-machine-card="MCH-0001">
                                <header class="machine-glance__header">
                                    <div>
                                        <p class="machine-glance__code">MCH-0001</p>
                                        <h3 class="machine-glance__title">Cutting Cell</h3>
                                    </div>
                                    <span class="status-pill" data-machine-status>Awaiting data</span>
                                </header>
                                <p class="machine-glance__runtime"><span data-machine-runtime>—</span> <small>runtime</small></p>
                                <div class="machine-glance__progress" aria-hidden="true">
                                    <div class="machine-glance__progress-bar" data-machine-progress></div>
                                </div>
                                <dl class="machine-glance__metrics">
                                    <div>
                                        <dt>Idle</dt>
                                        <dd data-machine-idle>—</dd>
                                    </div>
                                    <div>
                                        <dt>Overtime</dt>
                                        <dd data-machine-extended>—</dd>
                                    </div>
                                    <div>
                                        <dt>Utilisation</dt>
                                        <dd data-machine-utilisation>—</dd>
                                    </div>
                                </dl>
                                <div class="machine-glance__reason" data-machine-reason>Idle reason insights will appear here.</div>
                                <p class="machine-glance__note" data-machine-note></p>
                            </article>
                            <article class="machine-glance" data-machine-card="MCH-0002">
                                <header class="machine-glance__header">
                                    <div>
                                        <p class="machine-glance__code">MCH-0002</p>
                                        <h3 class="machine-glance__title">Precision Lathe</h3>
                                    </div>
                                    <span class="status-pill" data-machine-status>Awaiting data</span>
                                </header>
                                <p class="machine-glance__runtime"><span data-machine-runtime>—</span> <small>runtime</small></p>
                                <div class="machine-glance__progress" aria-hidden="true">
                                    <div class="machine-glance__progress-bar" data-machine-progress></div>
                                </div>
                                <dl class="machine-glance__metrics">
                                    <div>
                                        <dt>Idle</dt>
                                        <dd data-machine-idle>—</dd>
                                    </div>
                                    <div>
                                        <dt>Overtime</dt>
                                        <dd data-machine-extended>—</dd>
                                    </div>
                                    <div>
                                        <dt>Utilisation</dt>
                                        <dd data-machine-utilisation>—</dd>
                                    </div>
                                </dl>
                                <div class="machine-glance__reason" data-machine-reason>Idle reason insights will appear here.</div>
                                <p class="machine-glance__note" data-machine-note></p>
                            </article>
                            <article class="machine-glance" data-machine-card="MCH-0003">
                                <header class="machine-glance__header">
                                    <div>
                                        <p class="machine-glance__code">MCH-0003</p>
                                        <h3 class="machine-glance__title">Finishing Line</h3>
                                    </div>
                                    <span class="status-pill" data-machine-status>Awaiting data</span>
                                </header>
                                <p class="machine-glance__runtime"><span data-machine-runtime>—</span> <small>runtime</small></p>
                                <div class="machine-glance__progress" aria-hidden="true">
                                    <div class="machine-glance__progress-bar" data-machine-progress></div>
                                </div>
                                <dl class="machine-glance__metrics">
                                    <div>
                                        <dt>Idle</dt>
                                        <dd data-machine-idle>—</dd>
                                    </div>
                                    <div>
                                        <dt>Overtime</dt>
                                        <dd data-machine-extended>—</dd>
                                    </div>
                                    <div>
                                        <dt>Utilisation</dt>
                                        <dd data-machine-utilisation>—</dd>
                                    </div>
                                </dl>
                                <div class="machine-glance__reason" data-machine-reason>Idle reason insights will appear here.</div>
                                <p class="machine-glance__note" data-machine-note></p>
                            </article>
                        </div>
                    </section>
                    <section class="panel idle-insights">
                        <header class="idle-insights__header">
                            <div>
                                <h2>Actionable insights</h2>
                                <p class="panel__subtitle">Reasons with the biggest impact and suggested focus areas.</p>
                            </div>
                        </header>
                        <div class="idle-insights__body">
                            <ul class="insight-list" id="idle-insights"></ul>
                            <div class="idle-reasons" id="idle-reason-pills"></div>
                        </div>
                    </section>
                </section>
                <section id="tab-suppliers" class="tab-panel" role="tabpanel" aria-labelledby="tab-button-suppliers" data-tab-panel="suppliers" hidden>
                    <div class="panel-grid">
                        <section class="panel panel--form">
                            <header class="panel__header">
                                <div>
                                    <h2>Add service supplier</h2>
                                    <p class="panel__subtitle">Maintain a directory of trusted maintenance partners.</p>
                                </div>
                            </header>
                            <div class="panel__body">
                                <div class="alert alert--info" id="supplier-form-notice" hidden></div>
                                <div class="alert alert--success" id="supplier-form-success" hidden>Supplier added successfully.</div>
                                <div class="alert alert--error" id="supplier-form-error" hidden></div>
                                <form class="form" id="supplier-form" novalidate>
                                    <div class="form-grid">
                                        <div class="input-group">
                                            <label for="supplier-name">Supplier name <span class="required">*</span></label>
                                            <input id="supplier-name" name="name" type="text" placeholder="ABC Engineering" required />
                                        </div>
                                        <div class="input-group">
                                            <label for="supplier-contact">Contact person</label>
                                            <input id="supplier-contact" name="contact_person" type="text" placeholder="Ms. Perera" />
                                        </div>
                                        <div class="input-group">
                                            <label for="supplier-phone">Phone</label>
                                            <input id="supplier-phone" name="phone" type="tel" placeholder="011 123 4567" />
                                        </div>
                                        <div class="input-group">
                                            <label for="supplier-email">Email</label>
                                            <input id="supplier-email" name="email" type="email" placeholder="service@example.com" />
                                        </div>
                                    </div>
                                    <div class="input-group">
                                        <label for="supplier-services">Services offered</label>
                                        <textarea id="supplier-services" name="services_offered" rows="2" placeholder="Calibration, emergency repairs"></textarea>
                                    </div>
                                    <div class="input-group">
                                        <label for="supplier-assets">Preferred assets</label>
                                        <textarea id="supplier-assets" name="preferred_assets" rows="2" placeholder="List of assets or categories"></textarea>
                                    </div>
                                    <div class="input-group">
                                        <label for="supplier-notes">Notes</label>
                                        <textarea id="supplier-notes" name="notes" rows="2" placeholder="Payment terms, service hours, etc."></textarea>
                                    </div>
                                    <div class="form__footer">
                                        <button type="submit" class="button">Add supplier</button>
                                    </div>
                                </form>
                            </div>
                        </section>
                        <section class="panel panel--list">
                            <header class="panel__header">
                                <div>
                                    <h2>Service suppliers</h2>
                                    <p class="panel__subtitle">Reference contact and service information when needed.</p>
                                </div>
                                <button type="button" class="button button--ghost" id="refresh-suppliers">Refresh</button>
                            </header>
                            <div class="panel__body">
                                <div class="alert alert--error" id="supplier-error" hidden></div>
                                <div class="empty-state" id="suppliers-empty" hidden>
                                    <p>No service suppliers registered yet.</p>
                                </div>
                                <div class="table-wrapper">
                                    <table class="data-table" aria-describedby="suppliers-empty">
                                        <thead>
                                            <tr>
                                                <th scope="col">Name</th>
                                                <th scope="col">Contact</th>
                                                <th scope="col">Phone</th>
                                                <th scope="col">Email</th>
                                                <th scope="col">Services</th>
                                            </tr>
                                        </thead>
                                        <tbody id="suppliers-table-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </section>
                    </div>
                </section>
            </div>
        </main>
        <div class="modal" id="asset-modal" role="dialog" aria-modal="true" aria-labelledby="asset-modal-title" data-modal hidden>
            <div class="modal__backdrop" data-modal-close></div>
            <div class="modal__window" role="document">
                <header class="modal__header" data-modal-handle>
                    <h2 class="modal__title" id="asset-modal-title">Register a new asset</h2>
                    <button type="button" class="modal__close" data-modal-close aria-label="Close">&times;</button>
                </header>
                <div class="modal__body">
                    <p class="modal__subtitle">Maintain an up-to-date registry of every machine on site.</p>
                    <div class="alert alert--info" id="asset-form-notice" hidden></div>
                    <div class="alert alert--success" id="asset-form-success" hidden>Asset added successfully.</div>
                    <div class="alert alert--error" id="asset-form-error" hidden></div>
                    <form class="form" id="asset-form" novalidate>
                        <div class="form-grid">
                            <div class="input-group">
                                <label for="asset-code">Asset code <span class="required">*</span></label>
                                <input id="asset-code" name="code" type="text" placeholder="Select a category" required readonly />
                            </div>
                            <div class="input-group">
                                <label for="asset-name">Name <span class="required">*</span></label>
                                <input id="asset-name" name="name" type="text" placeholder="Hydraulic press" required />
                            </div>
                            <div class="input-group">
                                <label for="asset-category">Category</label>
                                <select id="asset-category" name="category">
                                    <option value="" selected hidden>Select a category</option>
                                    <option value="Land &amp; Building">Land &amp; Building</option>
                                    <option value="Plant &amp; Machines">Plant &amp; Machines</option>
                                    <option value="Vehicles">Vehicles</option>
                                    <option value="Furniture &amp; Fixtures">Furniture &amp; Fixtures</option>
                                    <option value="Tools &amp; Equipment">Tools &amp; Equipment</option>
                                    <option value="Computers">Computers</option>
                                    <option value="Electronic Equipments">Electronic Equipments</option>
                                    <option value="Phones">Phones</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="asset-location">Location</label>
                                <input id="asset-location" name="location" type="text" placeholder="Plant 1" />
                            </div>
                            <div class="input-group">
                                <label for="asset-manufacturer">Manufacturer</label>
                                <input id="asset-manufacturer" name="manufacturer" type="text" placeholder="OEM" />
                            </div>
                            <div class="input-group">
                                <label for="asset-model">Model number</label>
                                <input id="asset-model" name="model_number" type="text" placeholder="HP-300" />
                            </div>
                            <div class="input-group">
                                <label for="asset-serial">Serial number</label>
                                <input id="asset-serial" name="serial_number" type="text" placeholder="SN12345" />
                            </div>
                            <div class="input-group">
                                <label for="asset-installed">Installed on</label>
                                <input id="asset-installed" name="installed_on" type="date" />
                            </div>
                            <div class="input-group">
                                <label for="asset-status">Status</label>
                                <input id="asset-status" name="status" type="text" placeholder="Operational" />
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="asset-notes">Notes</label>
                            <textarea id="asset-notes" name="notes" rows="3" placeholder="Any supporting notes"></textarea>
                        </div>
                        <div class="form__footer">
                            <button type="submit" class="button">Add asset</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="modal" id="ckd-modal" role="dialog" aria-modal="true" aria-labelledby="ckd-modal-title" data-modal hidden>
            <div class="modal__backdrop" data-modal-close></div>
            <div class="modal__window" role="document">
                <header class="modal__header" data-modal-handle>
                    <h2 class="modal__title" id="ckd-modal-title">Add CKD part to machine</h2>
                    <button type="button" class="modal__close" data-modal-close aria-label="Close">&times;</button>
                </header>
                <div class="modal__body">
                    <p class="modal__subtitle">Quickly register CKD parts for a selected machine.</p>
                    <ol class="modal__list">
                        <li>Open an asset from the register to view its CKD parts.</li>
                        <li>Use the part form to add details such as part number, life and notes.</li>
                        <li>Save the part to keep the machine register up to date.</li>
                    </ol>
                    <p class="modal__hint">Need to jump there now?</p>
                    <div class="modal__actions">
                        <button type="button" class="button" data-scroll-target="#machine-outputs" data-modal-close-after>Go to assets register</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal" id="maintenance-modal" role="dialog" aria-modal="true" aria-labelledby="maintenance-modal-title" data-modal hidden>
            <div class="modal__backdrop" data-modal-close></div>
            <div class="modal__window" role="document">
                <header class="modal__header" data-modal-handle>
                    <h2 class="modal__title" id="maintenance-modal-title">Request maintenance job</h2>
                    <button type="button" class="modal__close" data-modal-close aria-label="Close">&times;</button>
                </header>
                <div class="modal__body">
                    <p class="modal__subtitle">Create a work order for the maintenance team without leaving this page.</p>
                    <p>Switch to the maintenance tab to fill in the job form, track priorities and review job status.</p>
                    <div class="modal__actions">
                        <button type="button" class="button" data-activate-tab="maintenance" data-modal-close-after>Open maintenance management</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" integrity="sha384-e6nUZLBkQ86NJ6TVVKAeSaK8jWa3NhkYWZFomE39AvDbQWeie9PlQqM3pmYW5d1g" crossorigin="anonymous"></script>
    <script>
        const token = localStorage.getItem("samprox_token");
        const userRaw = localStorage.getItem("samprox_user");
        let user;

        try {
            user = userRaw ? JSON.parse(userRaw) : null;
        } catch (_) {
            user = null;
        }

        if (!token || !user) {
            window.location.href = "/";
        }

        const roleLabels = {
            admin: "Admin",
            production_manager: "Production Manager",
            maintenance_manager: "Maintenance Manager",
            technician: "Technician",
        };

        const userNameEl = document.getElementById("user-name");
        const userRoleEl = document.getElementById("user-role");
        const logoutButton = document.getElementById("logout");

        userNameEl.textContent = user?.name || "Unknown";
        userRoleEl.textContent = roleLabels[user?.role] || "";

        logoutButton.addEventListener("click", () => {
            localStorage.removeItem("samprox_token");
            localStorage.removeItem("samprox_user");
            window.location.href = "/";
        });

        const inputMenu = document.querySelector("[data-input-menu]");
        const inputMenuToggle = inputMenu?.querySelector("[data-menu-toggle]");
        let inputMenuCloseTimeout = null;

        function setInputMenuState(open) {
            if (!inputMenu) return;
            if (open) {
                inputMenu.classList.add("is-open");
            } else {
                inputMenu.classList.remove("is-open");
            }
            if (inputMenuToggle) {
                inputMenuToggle.setAttribute("aria-expanded", open ? "true" : "false");
            }
        }

        if (inputMenu && inputMenuToggle) {
            const handleOpen = () => {
                if (inputMenuCloseTimeout) {
                    clearTimeout(inputMenuCloseTimeout);
                }
                setInputMenuState(true);
            };

            const handleClose = () => {
                if (inputMenuCloseTimeout) {
                    clearTimeout(inputMenuCloseTimeout);
                }
                inputMenuCloseTimeout = setTimeout(() => setInputMenuState(false), 120);
            };

            inputMenuToggle.addEventListener("click", (event) => {
                event.preventDefault();
                event.stopPropagation();
                setInputMenuState(!inputMenu.classList.contains("is-open"));
            });

            inputMenu.addEventListener("mouseenter", handleOpen);
            inputMenu.addEventListener("mouseleave", handleClose);
            inputMenu.addEventListener("focusin", handleOpen);
            inputMenu.addEventListener("focusout", (event) => {
                if (!inputMenu.contains(event.relatedTarget)) {
                    handleClose();
                }
            });

            document.addEventListener("click", (event) => {
                if (!inputMenu.contains(event.target)) {
                    setInputMenuState(false);
                }
            });
        }

        const modalStack = [];
        const modalFocusMemory = new Map();

        function resetModalPosition(modal) {
            const windowEl = modal?.querySelector?.(".modal__window");
            if (!windowEl) return;
            windowEl.dataset.offsetX = "0";
            windowEl.dataset.offsetY = "0";
            windowEl.style.transform = "translate(-50%, -50%)";
            windowEl.classList.remove("is-dragging");
        }

        function enableModalDrag(modal) {
            const windowEl = modal?.querySelector?.(".modal__window");
            const handle = modal?.querySelector?.("[data-modal-handle]");
            if (!windowEl || !handle) return;

            windowEl.dataset.offsetX = windowEl.dataset.offsetX || "0";
            windowEl.dataset.offsetY = windowEl.dataset.offsetY || "0";

            let pointerId = null;
            let startX = 0;
            let startY = 0;
            let offsetX = 0;
            let offsetY = 0;

            const onPointerDown = (event) => {
                if (event.button !== 0) return;
                pointerId = event.pointerId;
                startX = event.clientX;
                startY = event.clientY;
                offsetX = parseFloat(windowEl.dataset.offsetX || "0");
                offsetY = parseFloat(windowEl.dataset.offsetY || "0");
                windowEl.classList.add("is-dragging");
                handle.setPointerCapture(pointerId);
                event.preventDefault();
            };

            const onPointerMove = (event) => {
                if (pointerId !== event.pointerId) return;
                const deltaX = event.clientX - startX;
                const deltaY = event.clientY - startY;
                const nextX = offsetX + deltaX;
                const nextY = offsetY + deltaY;
                windowEl.style.transform = `translate(calc(-50% + ${nextX}px), calc(-50% + ${nextY}px))`;
                windowEl.dataset.currentX = String(nextX);
                windowEl.dataset.currentY = String(nextY);
            };

            const onPointerUp = (event) => {
                if (pointerId !== event.pointerId) return;
                handle.releasePointerCapture(pointerId);
                pointerId = null;
                windowEl.classList.remove("is-dragging");
                windowEl.dataset.offsetX = windowEl.dataset.currentX || windowEl.dataset.offsetX || "0";
                windowEl.dataset.offsetY = windowEl.dataset.currentY || windowEl.dataset.offsetY || "0";
                delete windowEl.dataset.currentX;
                delete windowEl.dataset.currentY;
            };

            handle.addEventListener("pointerdown", onPointerDown);
            handle.addEventListener("pointermove", onPointerMove);
            handle.addEventListener("pointerup", onPointerUp);
            handle.addEventListener("pointercancel", onPointerUp);
        }

        function openModal(id) {
            const modal = document.getElementById(id);
            if (!modal || modalStack.includes(modal)) return;
            resetModalPosition(modal);
            modal.hidden = false;
            requestAnimationFrame(() => {
                modal.classList.add("is-open");
            });
            modalStack.push(modal);
            modalFocusMemory.set(modal, document.activeElement instanceof HTMLElement ? document.activeElement : null);
            document.body.classList.add("has-open-modal");
            const focusTarget = modal.querySelector(
                'button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'
            );
            if (focusTarget instanceof HTMLElement) {
                focusTarget.focus({ preventScroll: true });
            }
        }

        function closeModal(modal) {
            if (!modal) return;
            modal.classList.remove("is-open");
            const index = modalStack.indexOf(modal);
            if (index !== -1) {
                modalStack.splice(index, 1);
            }
            if (modalStack.length === 0) {
                document.body.classList.remove("has-open-modal");
            }
            const previousFocus = modalFocusMemory.get(modal);
            modalFocusMemory.delete(modal);
            setTimeout(() => {
                if (!modal.classList.contains("is-open")) {
                    modal.hidden = true;
                }
            }, 200);
            if (previousFocus instanceof HTMLElement) {
                previousFocus.focus({ preventScroll: true });
            }
        }

        const modalElements = document.querySelectorAll("[data-modal]");

        modalElements.forEach((modal) => {
            enableModalDrag(modal);
            modal.addEventListener("click", (event) => {
                const closeTrigger = event.target.closest("[data-modal-close]");
                if (closeTrigger) {
                    event.preventDefault();
                    closeModal(modal);
                }
            });
            const windowEl = modal.querySelector(".modal__window");
            if (windowEl) {
                windowEl.addEventListener("click", (event) => event.stopPropagation());
            }
        });

        document.querySelectorAll("[data-modal-open]").forEach((trigger) => {
            trigger.addEventListener("click", (event) => {
                event.preventDefault();
                const targetId = trigger.dataset.modalOpen;
                if (targetId) {
                    openModal(targetId);
                    setInputMenuState(false);
                }
            });
        });

        document.addEventListener("keydown", (event) => {
            if (event.key === "Escape" && modalStack.length > 0) {
                const lastModal = modalStack[modalStack.length - 1];
                closeModal(lastModal);
            }
        });

        document.querySelectorAll("[data-scroll-target]").forEach((element) => {
            element.addEventListener("click", (event) => {
                const targetSelector = element.dataset.scrollTarget;
                if (!targetSelector) return;
                const target = document.querySelector(targetSelector);
                if (target) {
                    target.scrollIntoView({ behavior: "smooth", block: "start" });
                }
            });
        });

        document.querySelectorAll("[data-activate-tab]").forEach((element) => {
            element.addEventListener("click", (event) => {
                const tabTarget = element.dataset.activateTab;
                if (!tabTarget) return;
                activateTab(tabTarget);
            });
        });

        document.querySelectorAll("[data-modal-close-after]").forEach((element) => {
            element.addEventListener("click", () => {
                const modal = element.closest("[data-modal]");
                if (modal) {
                    closeModal(modal);
                }
            });
        });

        const canManageAssets = ["production_manager", "admin"].includes(user?.role);
        const canManageParts = canManageAssets || ["maintenance_manager"].includes(user?.role);
        const canCreateJobs = ["production_manager", "admin"].includes(user?.role);
        const canLogIdle = ["production_manager", "maintenance_manager", "admin"].includes(user?.role);
        const canAddSuppliers = ["production_manager", "admin"].includes(user?.role);

        const addAssetTrigger = document.querySelector('[data-modal-open="asset-modal"]');
        if (addAssetTrigger && !canManageAssets) {
            addAssetTrigger.disabled = true;
            addAssetTrigger.setAttribute("aria-disabled", "true");
            addAssetTrigger.title = "Only Production Managers or Admins can add assets.";
        }

        const maintenanceTrigger = document.querySelector('[data-modal-open="maintenance-modal"]');
        if (maintenanceTrigger && !canCreateJobs) {
            maintenanceTrigger.disabled = true;
            maintenanceTrigger.setAttribute("aria-disabled", "true");
            maintenanceTrigger.title = "Only Production Managers or Admins can request maintenance jobs.";
        }

        const tabs = document.querySelectorAll(".machine-tab");
        const panels = document.querySelectorAll(".tab-panel");
        const loadedTabs = new Set();

        function activateTab(target) {
            if (!target) return;

            tabs.forEach((tab) => {
                const isActive = tab.dataset.tabTarget === target;
                tab.classList.toggle("is-active", isActive);
                tab.setAttribute("aria-selected", isActive ? "true" : "false");
            });
            panels.forEach((panel) => {
                const isActive = panel.dataset.tabPanel === target;
                panel.classList.toggle("is-active", isActive);
                if (typeof panel.toggleAttribute === "function") {
                    panel.toggleAttribute("hidden", !isActive);
                } else if (isActive) {
                    panel.removeAttribute("hidden");
                } else {
                    panel.setAttribute("hidden", "");
                }
            });

            if (!loadedTabs.has(target)) {
                loadedTabs.add(target);
                if (target === "assets") {
                    loadAssets();
                } else if (target === "maintenance") {
                    loadJobs();
                } else if (target === "idle") {
                    Promise.resolve(initializeIdleAnalytics()).catch(() => {});
                } else if (target === "suppliers") {
                    loadSuppliers();
                }
            } else if (target === "assets") {
                populateAssetSelects();
            } else if (target === "idle") {
                Promise.resolve(refreshIdleAnalytics()).catch(() => {});
            }
        }

        if (tabs.length > 0) {
            tabs.forEach((tab) => {
                tab.addEventListener("click", () => activateTab(tab.dataset.tabTarget));
            });
        }

        const assetsTableBody = document.getElementById("assets-table-body");
        const assetsEmpty = document.getElementById("assets-empty");
        const assetError = document.getElementById("asset-error");
        const refreshAssetsButton = document.getElementById("refresh-assets");
        const assetForm = document.getElementById("asset-form");
        const assetFormNotice = document.getElementById("asset-form-notice");
        const assetFormSuccess = document.getElementById("asset-form-success");
        const assetFormError = document.getElementById("asset-form-error");
        const assetDetail = document.getElementById("asset-detail");
        const assetDetailTitle = document.getElementById("asset-detail-title");
        const assetDetailMeta = document.getElementById("asset-detail-meta");
        const assetDetailFacts = document.getElementById("asset-detail-facts");
        const assetPartForm = document.getElementById("asset-part-form");
        const assetPartError = document.getElementById("asset-part-error");
        const assetPartSuccess = document.getElementById("asset-part-success");
        const assetPartsList = document.getElementById("asset-parts-list");
        const assetPartsEmpty = document.getElementById("asset-parts-empty");
        const assetPartSearchInput = document.getElementById("asset-part-search");
        const assetPartsEmptyMessage = document.querySelector("#asset-parts-empty p");
        const partNumberInput = document.getElementById("part-number");
        const closeAssetDetail = document.getElementById("close-asset-detail");
        const assetCodeInput = document.getElementById("asset-code");
        const assetCategorySelect = document.getElementById("asset-category");

        const jobForm = document.getElementById("job-form");
        const creationNotice = document.getElementById("creation-notice");
        const creationSuccess = document.getElementById("creation-success");
        const creationError = document.getElementById("creation-error");
        const jobsError = document.getElementById("jobs-error");
        const jobsEmpty = document.getElementById("jobs-empty");
        const jobsTableBody = document.getElementById("jobs-table-body");
        const refreshJobsButton = document.getElementById("refresh-jobs");

        const idleEntryForm = document.getElementById("idle-entry-form");
        const idleEntryNotice = document.getElementById("idle-entry-notice");
        const idleEntrySuccess = document.getElementById("idle-entry-success");
        const idleEntryError = document.getElementById("idle-entry-error");
        const idleDateInput = document.getElementById("idle-date");
        const idleMachineSelect = document.getElementById("idle-machine");
        const idleStartTimeInput = document.getElementById("idle-start-time");
        const idleEndTimeInput = document.getElementById("idle-end-time");
        const idleReasonSelect = document.getElementById("idle-reason");
        const idleNotesInput = document.getElementById("idle-notes");
        const idleChartCanvas = document.getElementById("idle-chart");
        const idleStatRuntime = document.querySelector("[data-total-runtime]");
        const idleStatIdle = document.querySelector("[data-total-idle]");
        const idleStatExtended = document.querySelector("[data-total-extended]");
        const idleInsightsList = document.getElementById("idle-insights");
        const idleReasonPills = document.getElementById("idle-reason-pills");
        const machineCards = Array.from(document.querySelectorAll("[data-machine-card]"));

        const supplierForm = document.getElementById("supplier-form");
        const supplierFormNotice = document.getElementById("supplier-form-notice");
        const supplierFormSuccess = document.getElementById("supplier-form-success");
        const supplierFormError = document.getElementById("supplier-form-error");
        const supplierError = document.getElementById("supplier-error");
        const suppliersEmpty = document.getElementById("suppliers-empty");
        const suppliersTableBody = document.getElementById("suppliers-table-body");
        const refreshSuppliersButton = document.getElementById("refresh-suppliers");

        let assets = [];
        let currentAssetId = null;
        let currentParts = [];
        let latestCodeRequest = 0;

        const SHIFT_DURATION_HOURS = 11;
        const machineMetadata = new Map([
            ["MCH-0001", { title: "Cutting Cell" }],
            ["MCH-0002", { title: "Precision Lathe" }],
            ["MCH-0003", { title: "Finishing Line" }],
        ]);

        const today = new Date();
        const todayDateString = today.toISOString().slice(0, 10);

        let idleChartInstance = null;
        let idleInitialized = false;
        let idleEvents = [];
        const idleSummaryCache = new Map();

        const IDLE_SHIFT_START = "07:00";

        const DEFAULT_PARTS_EMPTY_MESSAGE = assetPartsEmptyMessage?.textContent?.trim() ||
            "No parts have been registered for this asset yet.";
        const FILTERED_PARTS_EMPTY_MESSAGE = "No parts match your search.";

        if (!canManageAssets) {
            if (assetFormNotice) {
                assetFormNotice.textContent = "Only Production Managers or Admins can add assets.";
                assetFormNotice.hidden = false;
            }
            if (assetForm) {
                assetForm.querySelectorAll("input, textarea, button").forEach((element) => {
                    element.disabled = true;
                });
            }
        }

        if (!canManageParts) {
            if (assetPartForm) {
                assetPartForm.querySelectorAll("input, textarea, button").forEach((element) => {
                    element.disabled = true;
                });
            }
            if (assetPartError) {
                assetPartError.textContent = "Only authorised maintenance roles can add parts or log replacements.";
                assetPartError.hidden = false;
            }
        }

        if (assetPartSearchInput) {
            assetPartSearchInput.addEventListener("input", () => {
                renderFilteredParts();
            });
            assetPartSearchInput.addEventListener("search", () => {
                renderFilteredParts();
            });
        }

        if (!canCreateJobs) {
            if (creationNotice) {
                creationNotice.textContent = "Only Production Managers can create jobs. You can still view existing jobs.";
                creationNotice.hidden = false;
            }
            if (jobForm) {
                jobForm.querySelectorAll("input, textarea, select, button").forEach((element) => {
                    element.disabled = true;
                });
            }
        }

        if (!canLogIdle && idleEntryForm) {
            if (idleEntryNotice) {
                idleEntryNotice.textContent = "Only Production, Maintenance Managers or Admins can log hour meter readings.";
                idleEntryNotice.hidden = false;
            }
            idleEntryForm.querySelectorAll("input, textarea, select, button").forEach((element) => {
                element.disabled = true;
            });
        }

        if (!canAddSuppliers) {
            if (supplierFormNotice) {
                supplierFormNotice.textContent = "Only Production Managers or Admins can add suppliers.";
                supplierFormNotice.hidden = false;
            }
            if (supplierForm) {
                supplierForm.querySelectorAll("input, textarea, button").forEach((element) => {
                    element.disabled = true;
                });
            }
        }

        function formatDate(value, withTime = false) {
            if (!value) return "—";
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return value;
            return withTime ? date.toLocaleString() : date.toLocaleDateString();
        }

        function formatDuration(minutes) {
            if (minutes == null) return "—";
            if (minutes < 60) return `${minutes} min`;
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            if (!mins) return `${hours} hr`;
            return `${hours} hr ${mins} min`;
        }

        async function fetchJson(url, options = {}) {
            const headers = {
                Accept: "application/json",
                Authorization: `Bearer ${token}`,
                ...(options.headers || {}),
            };

            if (options.body && !headers["Content-Type"] && !headers["content-type"]) {
                headers["Content-Type"] = "application/json";
            }

            const response = await fetch(url, {
                ...options,
                headers,
            });

            if (!response.ok) {
                let message = `Request failed (${response.status})`;
                try {
                    const data = await response.json();
                    if (data?.msg) message = data.msg;
                } catch (_) {
                    // ignore
                }
                const error = new Error(message);
                error.status = response.status;
                throw error;
            }

            if (response.status === 204) {
                return null;
            }

            return response.json();
        }

        async function refreshAssetCodePreview() {
            if (!canManageAssets || !assetCodeInput || !assetCategorySelect) return;

            const category = assetCategorySelect.value?.trim();

            if (!category) {
                assetCodeInput.value = "";
                assetCodeInput.placeholder = "Select a category";
                return;
            }

            const requestId = ++latestCodeRequest;
            assetCodeInput.value = "";
            assetCodeInput.placeholder = "Generating code…";

            try {
                const data = await fetchJson(
                    `/api/machines/assets/code?category=${encodeURIComponent(category)}`
                );
                if (latestCodeRequest !== requestId) return;
                assetCodeInput.value = data.code || "";
                assetCodeInput.placeholder = data.code ? data.code : "Select a category";
            } catch (error) {
                if (latestCodeRequest !== requestId) return;
                assetCodeInput.value = "";
                assetCodeInput.placeholder = "Unable to generate";
                assetFormError.textContent = error.message || "Unable to generate asset code.";
                assetFormError.hidden = false;
            }
        }

        function renderAssets() {
            if (!assetsTableBody) return;

            assetsTableBody.innerHTML = "";

            if (!Array.isArray(assets) || assets.length === 0) {
                if (assetsEmpty) assetsEmpty.hidden = false;
                return;
            }

            if (assetsEmpty) assetsEmpty.hidden = true;

            assets.forEach((asset) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td data-label="Code">${asset.code}</td>
                    <td data-label="Name">${asset.name}</td>
                    <td data-label="Location">${asset.location || "—"}</td>
                    <td data-label="Status">${asset.status || "—"}</td>
                    <td data-label="Parts">${asset.part_count || 0}</td>
                    <td data-label="Actions"><button type="button" class="button button--ghost button--small" data-action="ckd" data-asset-id="${asset.id}">CKD</button></td>
                `;
                assetsTableBody.appendChild(row);
            });
        }

        function populateAssetSelects() {
            if (!idleMachineSelect) return;
            const currentValue = idleMachineSelect.value;
            const existingValues = new Set(Array.from(idleMachineSelect.options).map((option) => option.value));
            assets.forEach((asset) => {
                if (!asset?.code || existingValues.has(asset.code)) return;
                const option = document.createElement("option");
                option.value = asset.code;
                option.textContent = `${asset.code} — ${asset.name || "Machine"}`;
                idleMachineSelect.appendChild(option);
                if (!machineMetadata.has(asset.code)) {
                    machineMetadata.set(asset.code, { title: asset.name || asset.code });
                }
            });
            if (!currentValue && idleMachineSelect.options.length > 0) {
                idleMachineSelect.value = idleMachineSelect.options[0].value;
            }
        }

        async function loadAssets() {
            if (assetError) {
                assetError.hidden = true;
                assetError.textContent = "";
            }
            try {
                assets = await fetchJson("/api/machines/assets");
                renderAssets();
                populateAssetSelects();
            } catch (error) {
                if (assetError) {
                    assetError.textContent = error.message || "Unable to load assets";
                    assetError.hidden = false;
                }
                assets = [];
                renderAssets();
                populateAssetSelects();
            }
        }

        async function loadAssetParts(assetId) {
            if (assetPartError) assetPartError.hidden = true;
            if (assetPartSuccess) assetPartSuccess.hidden = true;
            try {
                const parts = await fetchJson(`/api/machines/assets/${assetId}/parts`);
                currentParts = Array.isArray(parts) ? parts : [];
                updatePartNumberField(currentParts);
                renderFilteredParts();
            } catch (error) {
                if (assetPartError) {
                    assetPartError.textContent = error.message || "Unable to load parts";
                    assetPartError.hidden = false;
                }
                currentParts = [];
                updatePartNumberField(currentParts);
                renderFilteredParts();
            }
        }

        function computeNextPartNumber(parts) {
            if (!Array.isArray(parts) || parts.length === 0) {
                return "P-001";
            }
            let maxNumber = 0;
            parts.forEach((part) => {
                if (!part || typeof part.part_number !== "string") return;
                const match = part.part_number.trim().match(/^P-(\d+)$/i);
                if (!match) return;
                const numeric = Number.parseInt(match[1], 10);
                if (!Number.isNaN(numeric)) {
                    maxNumber = Math.max(maxNumber, numeric);
                }
            });
            return `P-${String(maxNumber + 1).padStart(3, "0")}`;
        }

        function updatePartNumberField(parts) {
            if (!canManageParts || !partNumberInput) return;
            const nextNumber = computeNextPartNumber(parts);
            partNumberInput.value = nextNumber;
        }

        function partMatchesQuery(part, query) {
            if (!query) return true;
            const terms = query.split(/\s+/).filter(Boolean);
            if (!terms.length) return true;
            const partNumber = typeof part.part_number === "string" ? part.part_number : "";
            const normalizedPartNumber = partNumber.replace(/[^a-z0-9]/gi, "");
            const haystack = [
                part.name,
                partNumber,
                normalizedPartNumber,
                part.description,
                part.notes,
                part.expected_life_hours != null ? String(part.expected_life_hours) : "",
                Array.isArray(part.replacement_history)
                    ? part.replacement_history
                          .map((replacement) =>
                              [
                                  replacement.replaced_on,
                                  replacement.replaced_by,
                                  replacement.reason,
                                  replacement.notes,
                              ]
                                  .filter(Boolean)
                                  .join(" ")
                          )
                          .join(" ")
                    : "",
            ]
                .filter(Boolean)
                .join(" ")
                .toLowerCase();
            return terms.every((term) => haystack.includes(term));
        }

        function renderPartsList(parts, { filtered = false } = {}) {
            assetPartsList.innerHTML = "";
            if (!Array.isArray(parts) || parts.length === 0) {
                assetPartsEmpty.hidden = false;
                if (assetPartsEmptyMessage) {
                    assetPartsEmptyMessage.textContent = filtered
                        ? FILTERED_PARTS_EMPTY_MESSAGE
                        : DEFAULT_PARTS_EMPTY_MESSAGE;
                }
                return;
            }
            assetPartsEmpty.hidden = true;
            if (assetPartsEmptyMessage) {
                assetPartsEmptyMessage.textContent = DEFAULT_PARTS_EMPTY_MESSAGE;
            }

            parts.forEach((part) => {
                const card = document.createElement("article");
                card.className = "part-card";
                const lastReplacement = part.replacement_history?.[0];
                const historyCount = part.replacement_history?.length || 0;
                card.innerHTML = `
                    <header class="part-card__header">
                        <div>
                            <h4 class="part-card__title">${part.name}</h4>
                            <p class="part-card__meta">
                                ${part.part_number ? `Part #${part.part_number}` : "No part number"}
                                ${part.expected_life_hours ? ` • ${part.expected_life_hours} hrs expected life` : ""}
                            </p>
                            ${lastReplacement ? `<p class="part-card__meta">Last replaced on ${formatDate(lastReplacement.replaced_on)}</p>` : ""}
                        </div>
                        <div class="part-card__actions">
                            <button type="button" class="button button--ghost button--small" data-action="toggle-history">History (${historyCount})</button>
                            <button type="button" class="button button--ghost button--small" data-action="log-replacement">Log replacement</button>
                        </div>
                    </header>
                    ${part.description ? `<p class="part-card__description">${part.description}</p>` : ""}
                    ${part.notes ? `<p class="part-card__notes">${part.notes}</p>` : ""}
                    <details class="part-card__history" ${historyCount ? "" : "open"}>
                        <summary>Replacement history (${historyCount})</summary>
                        <ul class="part-card__history-list">
                            ${historyCount ? part.replacement_history.map((replacement) => `
                                <li>
                                    <div>
                                        <strong>${formatDate(replacement.replaced_on)}</strong>
                                        ${replacement.reason ? ` – ${replacement.reason}` : ""}
                                    </div>
                                    ${replacement.replaced_by ? `<div>By: ${replacement.replaced_by}</div>` : ""}
                                    ${replacement.notes ? `<div>${replacement.notes}</div>` : ""}
                                </li>
                            `).join("") : "<li>No replacements logged yet.</li>"}
                        </ul>
                    </details>
                    <form class="part-card__form" data-part-id="${part.id}" hidden>
                        <div class="form-grid">
                            <div class="input-group">
                                <label>Replaced on</label>
                                <input name="replaced_on" type="date" />
                            </div>
                            <div class="input-group">
                                <label>Replaced by</label>
                                <input name="replaced_by" type="text" placeholder="Technician" />
                            </div>
                            <div class="input-group">
                                <label>Reason</label>
                                <input name="reason" type="text" placeholder="Wear, upgrade, etc." />
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Notes</label>
                            <textarea name="notes" rows="2" placeholder="Optional remarks"></textarea>
                        </div>
                        <div class="form__footer">
                            <button type="submit" class="button">Save replacement</button>
                        </div>
                    </form>
                `;

                const historyToggle = card.querySelector('[data-action="toggle-history"]');
                const historyDetails = card.querySelector(".part-card__history");
                if (historyToggle) {
                    historyToggle.addEventListener("click", () => {
                        historyDetails.open = !historyDetails.open;
                    });
                }

                const form = card.querySelector(".part-card__form");
                const logButton = card.querySelector('[data-action="log-replacement"]');
                if (!canManageParts) {
                    if (logButton) logButton.disabled = true;
                    if (form) {
                        form.querySelectorAll("input, textarea, button").forEach((element) => {
                            element.disabled = true;
                        });
                    }
                } else if (logButton && form) {
                    logButton.addEventListener("click", () => {
                        form.hidden = !form.hidden;
                    });
                    form.addEventListener("submit", async (event) => {
                        event.preventDefault();
                        const submitButton = form.querySelector('button[type="submit"]');
                        submitButton.disabled = true;
                        const formData = new FormData(form);
                        const payload = {
                            replaced_on: formData.get("replaced_on") || null,
                            replaced_by: formData.get("replaced_by")?.trim() || null,
                            reason: formData.get("reason")?.trim() || null,
                            notes: formData.get("notes")?.trim() || null,
                        };
                        try {
                            await fetchJson(`/api/machines/parts/${part.id}/replacements`, {
                                method: "POST",
                                body: JSON.stringify(payload),
                            });
                            form.reset();
                            form.hidden = true;
                            await loadAssetParts(currentAssetId);
                        } catch (error) {
                            alert(error.message || "Unable to log replacement");
                        } finally {
                            submitButton.disabled = false;
                        }
                    });
                }

                assetPartsList.appendChild(card);
            });
        }

        function renderFilteredParts() {
            const query = assetPartSearchInput?.value?.trim().toLowerCase() || "";
            const partsToRender = query
                ? currentParts.filter((part) => partMatchesQuery(part, query))
                : currentParts.slice();
            const isFiltered = Boolean(query) && currentParts.length > 0;
            renderPartsList(partsToRender, { filtered: isFiltered });
        }

        assetsTableBody?.addEventListener("click", (event) => {
            const button = event.target.closest("[data-action='ckd']");
            if (!button) return;
            const assetId = Number(button.dataset.assetId);
            const asset = assets.find((item) => item.id === assetId);
            if (!asset) return;
            currentAssetId = asset.id;
            if (assetPartSearchInput) {
                assetPartSearchInput.value = "";
            }
            if (assetPartsEmptyMessage) {
                assetPartsEmptyMessage.textContent = DEFAULT_PARTS_EMPTY_MESSAGE;
            }
            if (assetDetailTitle) assetDetailTitle.textContent = `${asset.name} (${asset.code})`;
            const metaParts = asset.part_count === 1 ? "1 part" : `${asset.part_count || 0} parts`;
            const metaLocation = asset.location ? ` • ${asset.location}` : "";
            if (assetDetailMeta) assetDetailMeta.textContent = `${metaParts}${metaLocation}`;
            const facts = [];
            if (asset.manufacturer) facts.push(["Manufacturer", asset.manufacturer]);
            if (asset.model_number) facts.push(["Model", asset.model_number]);
            if (asset.serial_number) facts.push(["Serial", asset.serial_number]);
            if (asset.installed_on) facts.push(["Installed", formatDate(asset.installed_on)]);
            if (asset.status) facts.push(["Status", asset.status]);
            if (asset.category) facts.push(["Category", asset.category]);
            if (asset.notes) facts.push(["Notes", asset.notes]);
            if (assetDetailFacts) {
                assetDetailFacts.innerHTML = facts.length
                ? facts.map(([label, value]) => `<div><dt>${label}</dt><dd>${value}</dd></div>`).join("")
                : "<p>No additional details provided.</p>";
            }
            if (assetDetail) assetDetail.hidden = false;
            loadAssetParts(asset.id);
        });

        closeAssetDetail?.addEventListener("click", () => {
            if (assetDetail) assetDetail.hidden = true;
            currentAssetId = null;
            currentParts = [];
            if (assetPartsList) assetPartsList.innerHTML = "";
            if (assetPartsEmpty) assetPartsEmpty.hidden = true;
            if (assetPartSearchInput) {
                assetPartSearchInput.value = "";
            }
            if (assetPartsEmptyMessage) {
                assetPartsEmptyMessage.textContent = DEFAULT_PARTS_EMPTY_MESSAGE;
            }
            updatePartNumberField(currentParts);
        });

        refreshAssetsButton?.addEventListener("click", loadAssets);

        if (canManageAssets && assetCategorySelect) {
            assetCategorySelect.addEventListener("change", () => {
                if (assetFormError) assetFormError.hidden = true;
                if (assetFormSuccess) assetFormSuccess.hidden = true;
                refreshAssetCodePreview();
            });
        }

        if (canManageAssets && assetForm) {
            assetForm.addEventListener("submit", async (event) => {
                event.preventDefault();
                if (assetFormSuccess) assetFormSuccess.hidden = true;
                if (assetFormError) assetFormError.hidden = true;
                const formData = new FormData(assetForm);
                const payload = {
                    name: formData.get("name")?.trim() || "",
                    category: formData.get("category")?.trim() || null,
                    location: formData.get("location")?.trim() || null,
                    manufacturer: formData.get("manufacturer")?.trim() || null,
                    model_number: formData.get("model_number")?.trim() || null,
                    serial_number: formData.get("serial_number")?.trim() || null,
                    installed_on: formData.get("installed_on") || null,
                    status: formData.get("status")?.trim() || null,
                    notes: formData.get("notes")?.trim() || null,
                };

                if (!payload.name && assetFormError) {
                    assetFormError.textContent = "Name is required.";
                    assetFormError.hidden = false;
                    return;
                }

                if (!payload.category && assetFormError) {
                    assetFormError.textContent = "Select a category to generate an asset code.";
                    assetFormError.hidden = false;
                    return;
                }

                const submitButton = assetForm.querySelector('button[type="submit"]');
                submitButton.disabled = true;

                try {
                    await fetchJson("/api/machines/assets", {
                        method: "POST",
                        body: JSON.stringify(payload),
                    });
                    const selectedCategory = assetCategorySelect?.value || null;
                    assetForm.reset();
                    if (assetFormSuccess) assetFormSuccess.hidden = false;
                    if (assetCategorySelect && selectedCategory) {
                        assetCategorySelect.value = selectedCategory;
                        await refreshAssetCodePreview();
                    }
                    await loadAssets();
                } catch (error) {
                    if (assetFormError) {
                        assetFormError.textContent = error.message || "Unable to add asset";
                        assetFormError.hidden = false;
                    }
                } finally {
                    submitButton.disabled = false;
                }
            });
        }

        if (canManageAssets && assetCategorySelect) {
            refreshAssetCodePreview();
        }

        if (canManageParts && assetPartForm) {
            assetPartForm.addEventListener("submit", async (event) => {
                event.preventDefault();
                if (!currentAssetId) return;
                if (assetPartError) assetPartError.hidden = true;
                if (assetPartSuccess) assetPartSuccess.hidden = true;
                const formData = new FormData(assetPartForm);
                const payload = {
                    name: formData.get("name")?.trim(),
                    part_number: formData.get("part_number")?.trim(),
                    expected_life_hours: formData.get("expected_life_hours") || null,
                    description: formData.get("description")?.trim() || null,
                    notes: formData.get("notes")?.trim() || null,
                };
                if (!payload.name && assetPartError) {
                    assetPartError.textContent = "Part name is required.";
                    assetPartError.hidden = false;
                    return;
                }
                if (!payload.part_number && assetPartError) {
                    assetPartError.textContent = "Part number is required.";
                    assetPartError.hidden = false;
                    return;
                }
                if (payload.expected_life_hours) {
                    payload.expected_life_hours = Number(payload.expected_life_hours);
                    if (Number.isNaN(payload.expected_life_hours)) {
                        payload.expected_life_hours = null;
                    }
                }

                const submitButton = assetPartForm.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                try {
                    await fetchJson(`/api/machines/assets/${currentAssetId}/parts`, {
                        method: "POST",
                        body: JSON.stringify(payload),
                    });
                    assetPartForm.reset();
                    if (assetPartSuccess) assetPartSuccess.hidden = false;
                    await loadAssets();
                    await loadAssetParts(currentAssetId);
                } catch (error) {
                    if (assetPartError) {
                        assetPartError.textContent = error.message || "Unable to add part";
                        assetPartError.hidden = false;
                    }
                } finally {
                    submitButton.disabled = false;
                }
            });
        }

        async function loadJobs() {
            if (jobsError) {
                jobsError.hidden = true;
                jobsError.textContent = "";
            }

            try {
                const jobs = await fetchJson("/api/jobs");
                renderJobs(jobs);
            } catch (error) {
                if (jobsError) {
                    jobsError.textContent = error.message || "Unable to load jobs";
                    jobsError.hidden = false;
                }
                renderJobs([]);
            }
        }

        function renderJobs(jobs) {
            if (!jobsTableBody) return;

            jobsTableBody.innerHTML = "";

            if (!Array.isArray(jobs) || jobs.length === 0) {
                if (jobsEmpty) jobsEmpty.hidden = false;
                return;
            }

            if (jobsEmpty) jobsEmpty.hidden = true;

            jobs.forEach((job) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td data-label="Code">${job.code}</td>
                    <td data-label="Title">${job.title}</td>
                    <td data-label="Status">${job.status}</td>
                    <td data-label="Priority">${job.priority}</td>
                    <td data-label="Assigned">${job.assigned_to ? job.assigned_to.name : "—"}</td>
                    <td data-label="Expected">${formatDate(job.expected_completion_date)}</td>
                    <td data-label="Created">${formatDate(job.created_at, true)}</td>
                `;
                jobsTableBody.appendChild(row);
            });
        }

        refreshJobsButton?.addEventListener("click", loadJobs);

        if (canCreateJobs && jobForm) {
            jobForm.addEventListener("submit", async (event) => {
                event.preventDefault();
                if (creationSuccess) creationSuccess.hidden = true;
                if (creationError) creationError.hidden = true;
                const formData = new FormData(jobForm);
                const payload = {
                    code: formData.get("code")?.trim(),
                    title: formData.get("title")?.trim(),
                    priority: formData.get("priority") || "Normal",
                    location: formData.get("location")?.trim() || null,
                    description: formData.get("description")?.trim() || null,
                    expected_completion_date: formData.get("expected_completion_date") || null,
                };

                if ((!payload.code || !payload.title) && creationError) {
                    creationError.textContent = "Code and Title are required.";
                    creationError.hidden = false;
                    return;
                }

                const submitButton = jobForm.querySelector('button[type="submit"]');
                submitButton.disabled = true;

                try {
                    await fetchJson("/api/jobs", {
                        method: "POST",
                        body: JSON.stringify(payload),
                    });
                    jobForm.reset();
                    if (creationSuccess) creationSuccess.hidden = false;
                    await loadJobs();
                } catch (error) {
                    if (creationError) {
                        creationError.textContent = error.message || "Unable to create job";
                        creationError.hidden = false;
                    }
                } finally {
                    submitButton.disabled = false;
                }
            });
        }


        function hideIdleMessages() {
            if (idleEntrySuccess) idleEntrySuccess.hidden = true;
            if (idleEntryError) idleEntryError.hidden = true;
        }

        function normalizeMachineCodes(values) {
            const normalized = [];
            const seen = new Set();
            if (!Array.isArray(values)) return normalized;
            values.forEach((value) => {
                if (typeof value !== "string") return;
                const trimmed = value.trim();
                if (!trimmed) return;
                const key = trimmed.toUpperCase();
                if (seen.has(key)) return;
                seen.add(key);
                normalized.push(trimmed);
            });
            return normalized;
        }

        function getTrackedMachineCodes() {
            const codes = new Set();
            machineCards.forEach((card) => {
                const code = card.dataset.machineCard;
                if (code) codes.add(code);
            });
            assets.forEach((asset) => {
                if (asset?.code) codes.add(asset.code);
            });
            return normalizeMachineCodes(Array.from(codes));
        }

        function getEventDurationMinutes(event) {
            if (!event) return 0;
            if (typeof event.duration_minutes === "number" && !Number.isNaN(event.duration_minutes)) {
                return Math.max(event.duration_minutes, 0);
            }
            const start = event?.started_at ? new Date(event.started_at) : null;
            const end = event?.ended_at ? new Date(event.ended_at) : new Date();
            if (!start || Number.isNaN(start.getTime()) || !end || Number.isNaN(end.getTime())) {
                return 0;
            }
            const diff = (end.getTime() - start.getTime()) / 60000;
            return diff > 0 ? diff : 0;
        }

        function toTimeInputValue(value) {
            if (!value) return "";
            if (value instanceof Date) {
                return value.toISOString().slice(11, 16);
            }
            const stringValue = String(value);
            const parts = stringValue.split("T");
            if (parts.length < 2) return "";
            const timePart = parts[1];
            return timePart.slice(0, 5);
        }

        function addDaysToDateString(dateString, days) {
            if (!dateString) return dateString;
            const base = new Date(`${dateString}T00:00:00`);
            if (Number.isNaN(base.getTime())) return dateString;
            base.setDate(base.getDate() + days);
            return base.toISOString().slice(0, 10);
        }

        async function initializeIdleAnalytics() {
            if (!idleEntryForm) return;

            if (idleInitialized) {
                await refreshIdleAnalytics();
                return;
            }

            idleInitialized = true;

            if (idleDateInput && !idleDateInput.value) {
                idleDateInput.value = todayDateString;
            }

            if (idleMachineSelect && !idleMachineSelect.value && idleMachineSelect.options.length > 0) {
                idleMachineSelect.value = idleMachineSelect.options[0].value;
            }

            if (idleEntryForm && canLogIdle) {
                idleEntryForm.addEventListener("submit", handleIdleFormSubmit);
            }

            if (idleMachineSelect) {
                idleMachineSelect.addEventListener("change", () => {
                    hideIdleMessages();
                    prefillIdleForm();
                });
            }

            if (idleDateInput) {
                idleDateInput.addEventListener("change", () => {
                    hideIdleMessages();
                    refreshIdleAnalytics();
                });
            }

            if (idleEntryForm) {
                idleEntryForm.addEventListener("reset", () => {
                    setTimeout(() => {
                        prefillIdleForm();
                        refreshIdleAnalytics();
                    }, 0);
                });
            }

            if (idleChartCanvas && window.Chart && !idleChartInstance) {
                const context = idleChartCanvas.getContext("2d");
                idleChartInstance = new Chart(context, {
                    type: "bar",
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: "Active (07:00 – 19:00)",
                                data: [],
                                backgroundColor: "rgba(37, 99, 235, 0.85)",
                                borderRadius: 14,
                                borderSkipped: false,
                                stack: "shift",
                            },
                            {
                                label: "Idle (07:00 – 19:00)",
                                data: [],
                                backgroundColor: "rgba(148, 163, 184, 0.55)",
                                borderRadius: 14,
                                borderSkipped: false,
                                stack: "shift",
                            },
                            {
                                label: "Extended runtime",
                                data: [],
                                backgroundColor: "rgba(16, 185, 129, 0.8)",
                                borderRadius: 14,
                                borderSkipped: false,
                                stack: "shift",
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: true,
                                ticks: {
                                    color: "#0f172a",
                                    font: { weight: 600 },
                                },
                                grid: { display: false },
                            },
                            y: {
                                stacked: true,
                                title: { display: true, text: "Hours" },
                                ticks: {
                                    callback: (value) => `${value} h`,
                                },
                                grid: { color: "rgba(148, 163, 184, 0.25)" },
                            },
                        },
                        plugins: {
                            legend: {
                                position: "bottom",
                                labels: { usePointStyle: true },
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `${context.dataset.label}: ${context.parsed.y.toFixed(2)} h`,
                                },
                            },
                        },
                    },
                });
            }

            await refreshIdleAnalytics();
        }

        function prefillIdleForm() {
            if (!idleEntryForm) return;
            const machineCode = idleMachineSelect?.value || "";
            const dateValue = idleDateInput?.value || todayDateString;
            const relevantEvents = idleEvents
                .filter((event) => {
                    const code = event?.asset?.code;
                    if (!code) return false;
                    const normalizedCode = code.toUpperCase();
                    const targetCode = machineCode.toUpperCase();
                    if (normalizedCode !== targetCode) return false;
                    const startDate = event.started_at ? String(event.started_at).slice(0, 10) : null;
                    const endDate = event.ended_at ? String(event.ended_at).slice(0, 10) : startDate;
                    return startDate === dateValue || endDate === dateValue;
                })
                .sort((a, b) => {
                    const first = a?.started_at ? new Date(a.started_at).getTime() : 0;
                    const second = b?.started_at ? new Date(b.started_at).getTime() : 0;
                    return second - first;
                });

            const latest = relevantEvents[0];

            if (idleStartTimeInput) {
                idleStartTimeInput.value = latest ? toTimeInputValue(latest.started_at) : IDLE_SHIFT_START;
            }
            if (idleEndTimeInput) {
                idleEndTimeInput.value = latest?.ended_at ? toTimeInputValue(latest.ended_at) : "";
            }
            if (idleReasonSelect) {
                idleReasonSelect.value = latest?.reason ?? "";
            }
            if (idleNotesInput) {
                idleNotesInput.value = latest?.notes ?? "";
            }

            if (idleEntryNotice) {
                if (relevantEvents.length > 1) {
                    idleEntryNotice.textContent = `Already logged ${relevantEvents.length} idle events for ${machineCode} on ${formatDate(dateValue)}. Submitting the form will add another event.`;
                    idleEntryNotice.hidden = false;
                } else if (latest) {
                    const startTime = toTimeInputValue(latest.started_at) || "?";
                    const endTime = latest.ended_at ? toTimeInputValue(latest.ended_at) : "ongoing";
                    idleEntryNotice.textContent = `Latest record spans ${startTime} to ${endTime}.`;
                    idleEntryNotice.hidden = false;
                } else {
                    idleEntryNotice.hidden = true;
                    idleEntryNotice.textContent = "";
                }
            }
        }

        async function refreshIdleAnalytics() {
            if (!idleEntryForm) return;
            const dateValue = idleDateInput?.value || todayDateString;
            const machineCodes = getTrackedMachineCodes();

            try {
                const [summary, events] = await Promise.all([
                    fetchIdleSummary(dateValue, machineCodes),
                    fetchIdleEventsForDate(dateValue, machineCodes),
                ]);
                idleEvents = Array.isArray(events) ? events : [];
                applyIdleAnalytics(summary, idleEvents, dateValue, machineCodes);
                prefillIdleForm();
            } catch (error) {
                if (idleEntryError) {
                    idleEntryError.textContent = error.message || "Unable to load idle analytics.";
                    idleEntryError.hidden = false;
                }
            }
        }

        async function fetchIdleSummary(dateValue, machineCodes) {
            const monthKey = (dateValue || "").slice(0, 7);
            if (!monthKey) {
                return null;
            }
            const cacheKey = `${monthKey}|${machineCodes.slice().sort().join(",")}`;
            if (idleSummaryCache.has(cacheKey)) {
                return idleSummaryCache.get(cacheKey);
            }

            const params = new URLSearchParams({ period: monthKey });
            if (machineCodes.length > 0) {
                params.set("machine_codes", machineCodes.join(","));
            }
            const summary = await fetchJson(`/api/production/monthly/idle-summary?${params.toString()}`);
            idleSummaryCache.set(cacheKey, summary);
            return summary;
        }

        async function fetchIdleEventsForDate(dateValue, machineCodes) {
            const params = new URLSearchParams({ start_date: dateValue, end_date: dateValue });
            if (machineCodes.length > 0) {
                params.set("machine_codes", machineCodes.join(","));
            }
            return fetchJson(`/api/machines/idle-events?${params.toString()}`);
        }

        function applyIdleAnalytics(summary, events, dateValue, machineCodes) {
            const requestedCodes = normalizeMachineCodes(machineCodes);
            const summaryCodes = normalizeMachineCodes(summary?.machine_codes || []);
            const cardCodes = normalizeMachineCodes(
                machineCards.map((card) => card.dataset.machineCard)
            );
            const trackedCodes =
                requestedCodes.length > 0
                    ? requestedCodes
                    : summaryCodes.length > 0
                    ? summaryCodes
                    : cardCodes;

            const labels = [];
            const runtimeData = [];
            const idleData = [];
            const extendedData = [];
            const metricsByMachine = new Map();
            const reasonStats = new Map();
            const eventsByMachine = new Map();
            let totalRuntime = 0;
            let totalIdle = 0;
            let totalExtended = 0;

            if (summary?.machines) {
                summary.machines.forEach((meta) => {
                    if (meta?.code && meta?.name) {
                        if (!machineMetadata.has(meta.code)) {
                            machineMetadata.set(meta.code, { title: meta.name });
                        }
                    }
                });
            }

            const dayEntry = summary?.day_entries?.find((entry) => entry.date === dateValue);

            events.forEach((event) => {
                const code = event?.asset?.code;
                if (!code) return;
                const normalizedCode = code.toUpperCase();
                const eventList = eventsByMachine.get(normalizedCode) || [];
                eventList.push(event);
                eventsByMachine.set(normalizedCode, eventList);

                const reason = (event.reason || "").trim();
                if (reason) {
                    const durationHours = getEventDurationMinutes(event) / 60;
                    const stat = reasonStats.get(reason) || { hours: 0, count: 0 };
                    stat.hours += durationHours;
                    stat.count += 1;
                    reasonStats.set(reason, stat);
                }
            });

            const machineCardMap = new Map();
            machineCards.forEach((card) => {
                const code = card.dataset.machineCard;
                if (code) machineCardMap.set(code.toUpperCase(), card);
            });

            trackedCodes.forEach((code) => {
                const normalizedCode = code.toUpperCase();
                const machineEntry = dayEntry?.machines?.[code] || {};
                const runtimeHours = Number(machineEntry.runtime_hours) || 0;
                const idleHours = Number(machineEntry.idle_hours) || 0;
                const extendedHours = Math.max(0, runtimeHours - SHIFT_DURATION_HOURS);
                const machineEvents = eventsByMachine.get(normalizedCode) || [];
                const prominentEvent = machineEvents
                    .slice()
                    .sort((a, b) => getEventDurationMinutes(b) - getEventDurationMinutes(a))[0];

                const metrics = {
                    shiftRuntime: runtimeHours,
                    idleTime: idleHours,
                    extendedRuntime: extendedHours,
                    totalRuntime: runtimeHours + extendedHours,
                    utilisation: SHIFT_DURATION_HOURS ? Math.min(runtimeHours / SHIFT_DURATION_HOURS, 1) : 0,
                    reason: prominentEvent?.reason || "",
                    notes: prominentEvent?.notes || "",
                    hasEntry:
                        runtimeHours > 0 || idleHours > 0 || machineEvents.length > 0,
                    events: machineEvents,
                };

                metricsByMachine.set(normalizedCode, metrics);
                labels.push(code);
                runtimeData.push(Number(metrics.shiftRuntime.toFixed(2)));
                idleData.push(Number(metrics.idleTime.toFixed(2)));
                extendedData.push(Number(metrics.extendedRuntime.toFixed(2)));
                totalRuntime += metrics.shiftRuntime;
                totalIdle += metrics.idleTime;
                totalExtended += metrics.extendedRuntime;

                const card = machineCardMap.get(normalizedCode);
                if (card) {
                    updateMachineCard(card, code, metrics, machineEvents);
                }
            });

            if (idleChartInstance) {
                idleChartInstance.data.labels = labels;
                idleChartInstance.data.datasets[0].data = runtimeData;
                idleChartInstance.data.datasets[1].data = idleData;
                idleChartInstance.data.datasets[2].data = extendedData;
                idleChartInstance.update();
            }

            if (idleStatRuntime) {
                idleStatRuntime.textContent = formatHours(totalRuntime);
            }
            if (idleStatIdle) {
                idleStatIdle.textContent = formatHours(totalIdle);
            }
            if (idleStatExtended) {
                idleStatExtended.textContent = formatHours(totalExtended);
            }

            updateIdleInsights(
                metricsByMachine,
                reasonStats,
                totalIdle,
                totalExtended,
                trackedCodes
            );
        }

        function updateMachineCard(card, machineCode, metrics, machineEvents) {
            const runtimeEl = card.querySelector("[data-machine-runtime]");
            const idleEl = card.querySelector("[data-machine-idle]");
            const extendedEl = card.querySelector("[data-machine-extended]");
            const utilisationEl = card.querySelector("[data-machine-utilisation]");
            const reasonEl = card.querySelector("[data-machine-reason]");
            const noteEl = card.querySelector("[data-machine-note]");
            const statusEl = card.querySelector("[data-machine-status]");
            const progressEl = card.querySelector("[data-machine-progress]");

            if (runtimeEl) runtimeEl.textContent = formatHours(metrics.totalRuntime);
            if (idleEl) idleEl.textContent = formatHours(metrics.idleTime);
            if (extendedEl) extendedEl.textContent = formatHours(metrics.extendedRuntime);
            if (utilisationEl) utilisationEl.textContent = `${Math.round(metrics.utilisation * 100)}%`;

            const status = determineStatus(metrics.utilisation, metrics.idleTime, metrics.hasEntry);
            if (statusEl) {
                statusEl.textContent = status.label;
                statusEl.dataset.statusLevel = status.level;
            }

            if (progressEl) {
                progressEl.style.width = `${Math.min(100, Math.round(metrics.utilisation * 100))}%`;
            }

            if (reasonEl) {
                if (!metrics.hasEntry) {
                    reasonEl.textContent = "Awaiting downtime capture for this date.";
                } else if (metrics.idleTime <= 0.05) {
                    reasonEl.textContent = "Fully utilised within the 11-hour shift window.";
                } else if (metrics.reason) {
                    const prominentEvent = machineEvents?.find((event) => (event?.reason || "").trim() === metrics.reason);
                    const durationHours = prominentEvent ? getEventDurationMinutes(prominentEvent) / 60 : metrics.idleTime;
                    reasonEl.textContent = `${metrics.reason} caused ${formatHours(durationHours)} of idle time.`;
                } else {
                    reasonEl.textContent = `Idle time of ${formatHours(metrics.idleTime)} recorded without a reason.`;
                }
            }

            if (noteEl) {
                const prominentEvent = machineEvents?.find((event) => event?.notes);
                noteEl.textContent = metrics.hasEntry ? prominentEvent?.notes || metrics.notes || "" : "";
            }

            if (machineCode && !machineMetadata.has(machineCode)) {
                machineMetadata.set(machineCode, { title: machineCode });
            }
        }

        function determineStatus(utilisation, idleTime, hasEntry) {
            if (!hasEntry) {
                return { label: "Awaiting data", level: "neutral" };
            }
            if (utilisation >= 0.9) {
                return { label: "On target", level: "positive" };
            }
            if (utilisation >= 0.75) {
                return { label: "Monitor", level: "warning" };
            }
            if (idleTime > 0) {
                return { label: "Idle risk", level: "alert" };
            }
            return { label: "Awaiting data", level: "neutral" };
        }

        function updateIdleInsights(metricsByMachine, reasonStats, totalIdle, totalExtended, machineCodes) {
            if (idleInsightsList) {
                idleInsightsList.innerHTML = "";
            }
            if (idleReasonPills) {
                idleReasonPills.innerHTML = "";
            }

            const insights = [];
            const metricsEntries = Array.from(metricsByMachine.entries());
            const recorded = metricsEntries.filter(([, metrics]) => metrics.hasEntry);
            const missingCount = machineCodes.length - recorded.length;
            const topMachine = recorded
                .slice()
                .sort((a, b) => b[1].idleTime - a[1].idleTime)[0];

            if (topMachine && topMachine[1].idleTime > 0.05) {
                const machineLabel = machineMetadata.get(topMachine[0])?.title || topMachine[0];
                const reasonText = topMachine[1].reason ? ` (${topMachine[1].reason})` : "";
                insights.push(`${machineLabel} lost ${formatHours(topMachine[1].idleTime)}${reasonText}. Align maintenance and materials to recover capacity.`);
            } else if (recorded.length) {
                insights.push("All tracked machines achieved the planned 11-hour shift runtime.");
            } else {
                insights.push("No idle records captured for this date. Log downtime to surface trends.");
            }

            if (missingCount > 0) {
                insights.push(`${missingCount} machine${missingCount > 1 ? "s" : ""} awaiting downtime capture.`);
            }

            if (totalExtended > 0.1) {
                insights.push(`Overtime delivered ${formatHours(totalExtended)} of additional output. Confirm labour and energy plans.`);
            }

            if (reasonStats.size > 0) {
                const reasonLeaders = Array.from(reasonStats.entries()).sort((a, b) => b[1].hours - a[1].hours);
                const [topReason, topStats] = reasonLeaders[0];
                insights.push(`${topReason} drove ${formatHours(topStats.hours)} across ${topStats.count} event${topStats.count > 1 ? "s" : ""}.`);
                reasonLeaders.forEach(([reason, stats]) => {
                    const chip = document.createElement("span");
                    chip.className = "reason-chip";
                    chip.textContent = `${reason} · ${formatHours(stats.hours)}`;
                    idleReasonPills?.appendChild(chip);
                });
            } else {
                const chip = document.createElement("span");
                chip.className = "reason-chip reason-chip--muted";
                chip.textContent = "No idle reasons captured";
                idleReasonPills?.appendChild(chip);
            }

            insights.slice(0, 3).forEach((message) => {
                if (!idleInsightsList) return;
                const item = document.createElement("li");
                item.textContent = message;
                idleInsightsList.appendChild(item);
            });
        }

        async function handleIdleFormSubmit(event) {
            event.preventDefault();
            hideIdleMessages();

            if (!canLogIdle) {
                return;
            }

            const machineCode = idleMachineSelect?.value || "";
            const dateValue = idleDateInput?.value || todayDateString;
            const startTime = idleStartTimeInput?.value || "";
            const endTime = idleEndTimeInput?.value || "";
            const reason = idleReasonSelect?.value || "";
            const notes = idleNotesInput?.value?.trim() || "";

            if (!machineCode) {
                if (idleEntryError) {
                    idleEntryError.textContent = "Select a machine to continue.";
                    idleEntryError.hidden = false;
                }
                return;
            }

            if (!startTime) {
                if (idleEntryError) {
                    idleEntryError.textContent = "Provide the idle start time.";
                    idleEntryError.hidden = false;
                }
                return;
            }

            const asset = assets.find(
                (item) => item?.code && item.code.toUpperCase() === machineCode.toUpperCase()
            );

            if (!asset) {
                if (idleEntryError) {
                    idleEntryError.textContent = "Select a machine from the registered assets before logging idle time.";
                    idleEntryError.hidden = false;
                }
                return;
            }

            const startDateTime = `${dateValue}T${startTime}`;
            let endDateTime = null;
            if (endTime) {
                let endDate = dateValue;
                const [startHour, startMinute] = startTime.split(":").map((value) => Number.parseInt(value, 10));
                const [endHour, endMinute] = endTime.split(":").map((value) => Number.parseInt(value, 10));
                if (
                    Number.isFinite(startHour) &&
                    Number.isFinite(startMinute) &&
                    Number.isFinite(endHour) &&
                    Number.isFinite(endMinute) &&
                    (endHour < startHour || (endHour === startHour && endMinute < startMinute))
                ) {
                    endDate = addDaysToDateString(dateValue, 1);
                }
                endDateTime = `${endDate}T${endTime}`;
            }

            const payload = {
                asset_id: asset.id,
                started_at: startDateTime,
                ended_at: endDateTime,
                reason: reason || null,
                notes: notes || null,
            };

            try {
                await fetchJson("/api/machines/idle-events", {
                    method: "POST",
                    body: JSON.stringify(payload),
                });
                if (idleEntrySuccess) {
                    const startLabel = startTime;
                    const endLabel = endTime || "ongoing";
                    idleEntrySuccess.textContent = `Recorded idle window ${startLabel} – ${endLabel} for ${machineCode}.`;
                    idleEntrySuccess.hidden = false;
                }
                await refreshIdleAnalytics();
            } catch (error) {
                if (idleEntryError) {
                    idleEntryError.textContent = error.message || "Unable to save idle record.";
                    idleEntryError.hidden = false;
                }
            }
        }

        function formatHours(value) {
            if (value == null || Number.isNaN(value)) return "0.0 h";
            const rounded = Math.round(value * 10) / 10;
            return `${rounded.toFixed(1)} h`;
        }

        function renderSuppliers(suppliers) {
            if (!suppliersTableBody) return;

            suppliersTableBody.innerHTML = "";
            if (!Array.isArray(suppliers) || suppliers.length === 0) {
                if (suppliersEmpty) suppliersEmpty.hidden = false;
                return;
            }
            if (suppliersEmpty) suppliersEmpty.hidden = true;
            suppliers.forEach((supplier) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td data-label="Name">${supplier.name}</td>
                    <td data-label="Contact">${supplier.contact_person || "—"}</td>
                    <td data-label="Phone">${supplier.phone || "—"}</td>
                    <td data-label="Email">${supplier.email || "—"}</td>
                    <td data-label="Services">${supplier.services_offered || "—"}</td>
                `;
                suppliersTableBody.appendChild(row);
            });
        }

        async function loadSuppliers() {
            if (supplierError) {
                supplierError.hidden = true;
                supplierError.textContent = "";
            }
            try {
                const suppliers = await fetchJson("/api/machines/service-suppliers");
                renderSuppliers(suppliers);
            } catch (error) {
                if (supplierError) {
                    supplierError.textContent = error.message || "Unable to load suppliers";
                    supplierError.hidden = false;
                }
                renderSuppliers([]);
            }
        }

        refreshSuppliersButton?.addEventListener("click", loadSuppliers);

        if (canAddSuppliers && supplierForm) {
            supplierForm.addEventListener("submit", async (event) => {
                event.preventDefault();
                if (supplierFormSuccess) supplierFormSuccess.hidden = true;
                if (supplierFormError) supplierFormError.hidden = true;
                const formData = new FormData(supplierForm);
                const payload = {
                    name: formData.get("name")?.trim(),
                    contact_person: formData.get("contact_person")?.trim() || null,
                    phone: formData.get("phone")?.trim() || null,
                    email: formData.get("email")?.trim() || null,
                    services_offered: formData.get("services_offered")?.trim() || null,
                    preferred_assets: formData.get("preferred_assets")?.trim() || null,
                    notes: formData.get("notes")?.trim() || null,
                };
                if (!payload.name && supplierFormError) {
                    supplierFormError.textContent = "Supplier name is required.";
                    supplierFormError.hidden = false;
                    return;
                }
                const submitButton = supplierForm.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                try {
                    await fetchJson("/api/machines/service-suppliers", {
                        method: "POST",
                        body: JSON.stringify(payload),
                    });
                    supplierForm.reset();
                    if (supplierFormSuccess) supplierFormSuccess.hidden = false;
                    await loadSuppliers();
                } catch (error) {
                    if (supplierFormError) {
                        supplierFormError.textContent = error.message || "Unable to add supplier";
                        supplierFormError.hidden = false;
                    }
                } finally {
                    submitButton.disabled = false;
                }
            });
        }

        activateTab("assets");
        loadedTabs.add("assets");
        loadAssets();
    </script>
</body>
</html>
