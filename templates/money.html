<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Money | SAMPROX ERP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" />
</head>
<body data-active-tab="{{ active_tab or 'overview' }}">
    <div class="page">
        <header class="topbar">
            <div class="brand">
                <div class="brand__logo">S</div>
                <div class="brand__details">
                    <p class="brand__name">SAMPROX ERP</p>
                    <p class="brand__section">Money Overview</p>
                </div>
            </div>
            <div class="topbar__actions">
                <a class="button button--ghost" href="{{ url_for('ui.mind_page') }}">Mind</a>
                <a class="button button--ghost" id="sales-visits-link" href="{{ url_for('ui.sales_visits_page') }}" hidden>Sales Visits</a>
                <div class="user-summary">
                    <span class="user-summary__name" id="user-name"></span>
                    <span class="user-summary__role" id="user-role"></span>
                </div>
                <button type="button" class="button button--secondary" id="logout">Sign out</button>
            </div>
        </header>
        <nav class="subnav" aria-label="7M navigation">
            <a class="subnav__link" href="{{ url_for('ui.mind_page') }}">Mind</a>
            <a class="subnav__link" href="{{ url_for('ui.man_page') }}">Man</a>
            <a class="subnav__link" href="{{ url_for('ui.machines_page') }}">Machine</a>
            <a class="subnav__link" href="{{ url_for('ui.material_page') }}">Material</a>
            <a class="subnav__link" href="{{ url_for('ui.market_page') }}">Market</a>
            <a class="subnav__link" href="{{ url_for('ui.manufacturing_page') }}">Manufacturing</a>
            <a class="subnav__link" href="{{ url_for('ui.movers_page') }}">Movers</a>
            <a class="subnav__link subnav__link--active" href="{{ url_for('ui.money_page') }}">Money</a>
            <a
                class="subnav__link"
                href="{{ url_for('ui.mechanism_page') }}"
                id="mechanism-link"
                hidden
            >Mechanism</a>
        </nav>
        <section class="section">
            {% set is_sales = is_sales or false %}
            {% set petty_only = petty_only or false %}
            {% set current_tab = active_tab or 'overview' %}
            <div class="tab-switcher" role="tablist" aria-label="Money sections">
                {% if not petty_only %}
                    <button
                        class="tab-switcher__button {% if current_tab == 'overview' %}tab-switcher__button--active{% endif %}"
                        data-tab="overview"
                        role="tab"
                        aria-selected="{{ 'true' if current_tab == 'overview' else 'false' }}"
                    >
                        Overview
                    </button>
                {% endif %}
                <button
                    class="tab-switcher__button {% if current_tab == 'petty-cash' %}tab-switcher__button--active{% endif %}"
                    data-tab="petty-cash"
                    role="tab"
                    aria-selected="{{ 'true' if current_tab == 'petty-cash' else 'false' }}"
                >
                    Petty Cash
                </button>
                {% if not petty_only %}
                    <button
                        class="tab-switcher__button {% if current_tab == 'financials' %}tab-switcher__button--active{% endif %}"
                        data-tab="financials"
                        role="tab"
                        aria-selected="{{ 'true' if current_tab == 'financials' else 'false' }}"
                    >
                        Financials
                    </button>
                {% endif %}
            </div>
            {% if not petty_only %}
                <div class="tab-panel {% if current_tab == 'overview' %}tab-panel--active{% endif %}" id="tab-overview" role="tabpanel" aria-label="Financial overview">
                    <header class="section__header">
                        <h1>Financial performance snapshot</h1>
                    </header>
                    <p class="section__description">
                        Connect operations with finance by monitoring budgets, spending, and cash flow. Use the
                        insights here to control costs and prioritize high-value work.
                    </p>
                    <div class="section__grid">
                        <article class="tile">
                            <h2 class="tile__title">Budget vs. actual</h2>
                            <p class="tile__description">
                                Compare planned spending against actuals across departments and job types.
                            </p>
                        </article>
                        <article class="tile">
                            <h2 class="tile__title">Job costing</h2>
                            <p class="tile__description">
                                Track labour, material, and machine time consumption to understand job margins.
                            </p>
                        </article>
                        <article class="tile">
                            <h2 class="tile__title">Cash flow outlook</h2>
                            <p class="tile__description">
                                Review upcoming receivables and payables to plan funding and investments.
                            </p>
                        </article>
                        <article class="tile">
                            <h2 class="tile__title">Capital planning</h2>
                            <p class="tile__description">
                                Highlight equipment upgrades and large purchases to align with financial targets.
                            </p>
                        </article>
                    </div>
                </div>
            {% endif %}

            <div class="tab-panel {% if current_tab == 'petty-cash' %}tab-panel--active{% endif %}" id="tab-petty-cash" role="tabpanel" aria-label="Petty cash weekly travel claims">
                <header class="section__header">
                    <div>
                        <p class="eyebrow">New</p>
                        <h1>Petty Cash – Weekly Travel Claims</h1>
                        <p class="section__description">
                            Capture weekly travel expenses directly inside the table. Edit each weekday cell inline and keep totals in sync automatically.
                        </p>
                    </div>
                    <div class="status-pill" id="petty-status">Draft</div>
                </header>

                <div class="petty-review" id="petty-review" hidden>
                    <div class="petty-review__filters">
                        <label class="form-field">
                            <span>Week starting</span>
                            <input id="petty-filter-week" type="date" required />
                        </label>
                        <label class="form-field">
                            <span>Status</span>
                            <select id="petty-filter-status">
                                <option value="ALL">All</option>
                                <option value="Submitted">Submitted</option>
                                <option value="Approved">Approved</option>
                                <option value="Paid">Paid</option>
                                <option value="Rejected">Rejected</option>
                            </select>
                        </label>
                        {% if not petty_only %}
                            <label class="form-field">
                                <span>Employee (optional)</span>
                                <select id="petty-filter-employee">
                                    <option value="">All employees</option>
                                </select>
                            </label>
                        {% endif %}
                    </div>

                    <div class="petty-review__list w-full">
                        <table class="petty-table petty-table--compact w-full">
                            <thead>
                                <tr>
                                    <th>Sheet</th>
                                    <th>Employee</th>
                                    <th>Status</th>
                                    <th>Total</th>
                                    <th>Submitted</th>
                                    <th>Updated</th>
                                </tr>
                            </thead>
                            <tbody id="petty-claims-rows"></tbody>
                        </table>
                        <p class="helper-text" id="petty-claims-empty">Select a week to load claims.</p>
                    </div>
                </div>

                <div id="petty-card-inline-host"></div>

                <div id="weekly-claim-modal" class="fixed inset-0 hidden items-center justify-center z-40">
                    <div class="absolute inset-0 bg-black/40" data-modal-close></div>

                    <div class="relative max-h-[90vh] w-full max-w-4xl overflow-y-auto rounded-xl bg-white p-6 shadow-xl">
                        <button
                            type="button"
                            class="absolute top-3 right-3 text-gray-400 hover:text-gray-600"
                            data-modal-close
                        >&times;</button>

                        <div class="modal-body space-y-4" id="petty-card-modal-host">
                            <div class="petty-card" id="petty-card">
                                <div class="form-grid">
                                    <label class="form-field">
                                        <span>Company</span>
                                        <select id="petty-company"></select>
                                    </label>
                                    <label class="form-field">
                                        <span>Employee</span>
                                        <select id="petty-employee"></select>
                                    </label>
                                    <label class="form-field">
                                        <span>Week starting</span>
                                        <input id="petty-week-start" type="date" />
                                    </label>
                                    <label class="form-field">
                                        <span>Week ending</span>
                                        <input id="petty-week-end" type="date" readonly />
                                    </label>
                                    <label class="form-field">
                                        <span>Monday Morning ODO</span>
                                        <input
                                            id="petty-monday-odo"
                                            name="monday_morning_odo"
                                            type="number"
                                            step="0.01"
                                            placeholder="Enter Monday ODO"
                                        />
                                    </label>
                                    <label class="form-field">
                                        <span>Friday Evening ODO</span>
                                        <input
                                            id="petty-friday-odo"
                                            name="friday_evening_odo"
                                            type="number"
                                            step="0.01"
                                            placeholder="Enter Friday ODO"
                                        />
                                    </label>
                                    <label class="form-field">
                                        <span>Sheet No</span>
                                        <input id="petty-sheet" type="text" readonly />
                                    </label>
                                    <label class="form-field">
                                        <span>Vehicle No</span>
                                        <select id="petty-vehicle"></select>
                                    </label>
                                    <label class="form-field form-field--wide">
                                        <span>Area visited</span>
                                        <textarea id="petty-area" rows="2" placeholder="Enter locations covered"></textarea>
                                    </label>
                                </div>

                                <div class="petty-table-wrapper">
                                    <table class="petty-table">
                                        <thead>
                                            <tr>
                                                <th>No</th>
                                                <th>Expense Type</th>
                                                <th>MON</th>
                                                <th>TUE</th>
                                                <th>WED</th>
                                                <th>THU</th>
                                                <th>FRI</th>
                                                <th>SAT</th>
                                                <th>SUN</th>
                                                <th>TOTAL</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody id="petty-lines"></tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="9" class="total-label">TOTAL EXPENSES</td>
                                                <td colspan="2" class="total-value" id="petty-total">0.00</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>

                                <div class="petty-toolbar">
                                    <div class="petty-actions">
                                        <button class="button button--secondary" id="petty-save">Save Draft</button>
                                        <button class="button" id="petty-submit">Submit for Approval</button>
                                        <button class="button" id="petty-approve">Approve</button>
                                        <button class="button button--danger" id="petty-reject">Reject</button>
                                        <button class="button" id="petty-paid">Mark as Paid</button>
                                    </div>
                                </div>
                                <p class="helper-text" id="petty-helper">
                                    Click any weekday cell to enter an amount. Empty cells are treated as 0.
                                </p>
                                <p class="helper-text helper-text--error" id="petty-error" hidden></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% if not petty_only %}
                <div class="tab-panel {% if current_tab == 'financials' %}tab-panel--active{% endif %}" id="tab-financials" role="tabpanel" aria-label="Financial statements capture">
                <header class="section__header">
                    <div>
                        <p class="eyebrow">New</p>
                        <h1>Financial Statements</h1>
                        <p class="section__description">
                            Capture IFRS-format financial statements for each company or view the consolidated group.
                            Enter monthly amounts for the April–March financial year.
                        </p>
                    </div>
                </header>

                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        <div class="alert-stack">
                            {% for category, message in messages %}
                                <div class="alert alert--{{ category }}">{{ message }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endwith %}

                <form class="financials-filter" method="get" action="{{ url_for('ui.financials_page') }}">
                    <label class="form-field">
                        <span>Company</span>
                        <select name="company_id" id="financial-company">
                            <option value="group" {% if is_group %}selected{% endif %}>Group (All Companies)</option>
                            {% for company in companies %}
                                <option value="{{ company.id }}" {% if not is_group and company.id == selected_company_id %}selected{% endif %}>
                                    {{ company.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </label>
                    <label class="form-field">
                        <span>Statement</span>
                        <select name="statement_type" id="financial-statement">
                            <option value="income" {% if statement_type == 'income' %}selected{% endif %}>Income Statement</option>
                            <option value="sofp" {% if statement_type == 'sofp' %}selected{% endif %}>Statement of Financial Position</option>
                            <option value="cashflow" {% if statement_type == 'cashflow' %}selected{% endif %}>Cash Flow Statement</option>
                            <option value="equity" {% if statement_type == 'equity' %}selected{% endif %}>Statement of Changes in Equity</option>
                            <option value="trial_balance" {% if statement_type == 'trial_balance' %}selected{% endif %}>Trial Balance</option>
                        </select>
                    </label>
                    <label class="form-field">
                        <span>Financial Year</span>
                        <select name="financial_year" id="financial-year">
                            {% for year_option in financial_year_options %}
                                <option value="{{ year_option }}" {% if financial_year == year_option %}selected{% endif %}>
                                    {{ year_option }}–{{ year_option + 1 }}
                                </option>
                            {% endfor %}
                        </select>
                    </label>
                    <div class="financials-filter__actions">
                        <button class="button" type="submit">Load</button>
                    </div>
                </form>

                {% if is_trial_balance %}
                    <div
                        class="trial-balance-card"
                        id="trial-balance-card"
                        data-company="{{ 'group' if is_group else selected_company_id or '' }}"
                        data-year="{{ financial_year }}"
                        data-group="{{ 'true' if is_group else 'false' }}"
                    >
                        <div class="trial-balance__toolbar">
                            <p class="helper-text">Capture monthly debit/credit balances for the April–March year.</p>
                            <div class="trial-balance__actions">
                                <button class="button button--ghost" type="button" id="trial-balance-add-row">+ Add Row</button>
                                <button class="button" type="button" id="trial-balance-save" {% if is_group %}disabled{% endif %}>Save</button>
                            </div>
                        </div>
                        <div id="trial-balance-grid" class="trial-balance-grid" aria-live="polite"></div>
                        <div class="helper-text" id="trial-balance-status"></div>
                    </div>
                    <div id="trial-balance-categories" data-categories='{{ trial_balance_categories | tojson }}' hidden></div>
                {% elif financial_lines %}
                    <form class="financials-card" method="post" action="{{ url_for('ui.save_financials') }}">
                        <input type="hidden" name="company_id" value="{{ 'group' if is_group else selected_company_id or '' }}" />
                        <input type="hidden" name="statement_type" value="{{ statement_type }}" />
                        <input type="hidden" name="financial_year" value="{{ financial_year }}" />

                        <div class="financials-table-wrapper">
                            <table class="financials-table">
                                <thead>
                                    <tr>
                                        <th class="financials-label-column">Line Item</th>
                                        {% for month in financial_months %}
                                            <th class="financials-month-column">{{ month.label }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for line in financial_lines %}
                                        {% set row_classes = [] %}
                                        {% if line.is_section %}
                                            {% set _ = row_classes.append('financials-row--section') %}
                                        {% endif %}
                                        {% if line.is_subtotal %}
                                            {% set _ = row_classes.append('financials-row--subtotal') %}
                                        {% endif %}
                                        <tr class="financials-row {{ ' '.join(row_classes) }}">
                                            <th class="financials-label" style="padding-left: {{ (line.level or 0) * 16 }}px">
                                                {{ line.label }}
                                            </th>
                                            {% for month in financial_months %}
                                                {% set existing_value = (financial_values_map or {}).get((month.year, month.month, line.line_key)) %}
                                                {% set display_value = '' if existing_value is none else '%.2f' % existing_value %}
                                                <td class="financials-cell">
                                                    {% if line.is_section %}
                                                        <span class="financials-section-spacer">—</span>
                                                    {% else %}
                                                        <input
                                                            type="number"
                                                            step="0.01"
                                                            inputmode="decimal"
                                                            class="financial-cell"
                                                            name="values[{{ month.year }}][{{ month.month }}][{{ line.line_key }}]"
                                                            value="{{ display_value }}"
                                                            data-year="{{ month.year }}"
                                                            data-month="{{ month.month }}"
                                                            data-line-key="{{ line.line_key }}"
                                                            {% if line.is_calculated %}readonly{% endif %}
                                                        />
                                                    {% endif %}
                                                </td>
                                            {% endfor %}
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <div class="financials-actions">
                            {% if is_group %}
                                <p class="helper-text">Select a company (not Group) to save financials.</p>
                            {% endif %}
                            <button class="button" type="submit" {% if is_group %}disabled{% endif %}>Save</button>
                        </div>
                    </form>
                {% else %}
                    <p class="helper-text">No statement lines found. Add a report line to begin capturing data.</p>
                {% endif %}

                <div class="financials-new-line">
                    <button class="button button--ghost" type="button" id="financials-new-line-toggle">Create New Report Line</button>
                    <form class="financials-new-line__form" id="financials-new-line-form" method="post" action="{{ url_for('ui.create_financial_line') }}" hidden>
                        <input type="hidden" name="company_id" value="{{ 'group' if is_group else selected_company_id or '' }}" />
                        <input type="hidden" name="financial_year" value="{{ financial_year }}" />

                        <div class="financials-new-line__grid">
                            <label class="form-field">
                                <span>Statement</span>
                                <select name="statement_type" id="new-line-statement">
                                    <option value="income" {% if statement_type == 'income' %}selected{% endif %}>Income Statement</option>
                                    <option value="sofp" {% if statement_type == 'sofp' %}selected{% endif %}>Statement of Financial Position</option>
                                    <option value="cashflow" {% if statement_type == 'cashflow' %}selected{% endif %}>Cash Flow Statement</option>
                                    <option value="equity" {% if statement_type == 'equity' %}selected{% endif %}>Statement of Changes in Equity</option>
                                    <option value="trial_balance" {% if statement_type == 'trial_balance' %}selected{% endif %}>Trial Balance</option>
                                </select>
                            </label>
                            <label class="form-field">
                                <span>Label</span>
                                <input name="label" id="new-line-label" type="text" placeholder="e.g. Revenue" required />
                            </label>
                            <label class="form-field">
                                <span>Line Key</span>
                                <input name="line_key" id="new-line-key" type="text" placeholder="e.g. revenue" />
                            </label>
                            <label class="form-field">
                                <span>Level</span>
                                <input name="level" type="number" min="0" step="1" value="0" />
                            </label>
                            <label class="form-field">
                                <span>Display Order</span>
                                <input name="display_order" type="number" step="1" min="0" />
                            </label>
                            <label class="form-field form-field--checkbox">
                                <span class="form-field__checkbox">
                                    <input type="checkbox" name="is_section" />
                                    <span>Section Header</span>
                                </span>
                            </label>
                            <label class="form-field form-field--checkbox">
                                <span class="form-field__checkbox">
                                    <input type="checkbox" name="is_subtotal" />
                                    <span>Subtotal</span>
                                </span>
                            </label>
                        </div>
                        <div class="financials-new-line__actions">
                            <button class="button button--secondary" type="submit">Add Line</button>
                        </div>
                    </form>
                </div>
            </div>
            {% endif %}
        </section>
    </div>
    <script>
        const token = localStorage.getItem("samprox_token");
        const userRaw = localStorage.getItem("samprox_user");
        let user;

        try {
            user = userRaw ? JSON.parse(userRaw) : null;
        } catch (_) {
            user = null;
        }

        if (!token || !user) {
            window.location.href = "/";
        }

        const normalizedRole = (user?.role || "").toLowerCase();

        const allowedOutsidePaths = new Set(["/responsibility_portal", "/money"]);
        if (normalizedRole === "outside_manager" && !allowedOutsidePaths.has(window.location.pathname)) {
            window.location.replace("/responsibility_portal");
        }

        if (normalizedRole === "maintenance_manager" && window.location.pathname !== "/machines") {
            window.location.replace("/machines");
        }

        if (normalizedRole === "sales" && window.location.pathname !== "/money") {
            window.location.replace("/money");
        }

        const roleLabels = {
            admin: "Admin",
            production_manager: "Production Manager",
            maintenance_manager: "Maintenance Manager",
            finance_manager: "Finance Manager",
            technician: "Technician",
            outside_manager: "Member Of Rainbow Group",
            sales: "Sales",
        };

        const pettyOnlyRoles = ["sales", "outside_manager"];
        const isSales = normalizedRole === "sales";
        const isPettyOnly = pettyOnlyRoles.includes(normalizedRole);

        const userNameEl = document.getElementById("user-name");
        const userRoleEl = document.getElementById("user-role");
        const logoutButton = document.getElementById("logout");
        const mechanismLink = document.getElementById("mechanism-link");
        const primaryNavLink = document.querySelector(".topbar__actions .button--ghost");
        const salesVisitsLink = document.getElementById("sales-visits-link");
        const subnavLinks = document.querySelectorAll(".subnav__link");

        userNameEl.textContent = user?.name || "Unknown";
        userRoleEl.textContent = roleLabels[normalizedRole] || "";
        if (mechanismLink) {
            if (user?.role === "admin") {
                mechanismLink.hidden = false;
            } else {
                mechanismLink.remove();
            }
        }
        if (salesVisitsLink && ["sales", "outside_manager", "admin"].includes(normalizedRole)) {
            salesVisitsLink.hidden = false;
        }

        if (isPettyOnly) {
            if (primaryNavLink) {
                if (isSales) {
                    primaryNavLink.textContent = "Money";
                    primaryNavLink.href = "/money";
                } else if (normalizedRole === "outside_manager") {
                    primaryNavLink.textContent = "Responsibilities";
                    primaryNavLink.href = "/responsibility_portal";
                }
            }

            subnavLinks.forEach((link) => {
                if (!link.getAttribute("href")?.startsWith("/money")) {
                    link.remove();
                }
            });

            document.body.dataset.activeTab = "petty-cash";

            document.querySelectorAll(".tab-switcher__button").forEach((btn) => {
                if (btn.dataset.tab !== "petty-cash") {
                    btn.remove();
                }
            });

            document.querySelectorAll(".tab-panel").forEach((panel) => {
                if (panel.id !== "tab-petty-cash") {
                    panel.remove();
                }
            });
        }

        logoutButton.addEventListener("click", async () => {
            try {
                await fetch("/api/auth/logout", { method: "POST", credentials: "include" });
            } catch (error) {
                console.error("Failed to log out", error);
            } finally {
                localStorage.removeItem("samprox_token");
                localStorage.removeItem("samprox_user");
                window.location.href = "/";
            }
        });

        const tabButtons = document.querySelectorAll(".tab-switcher__button");
        const tabPanels = document.querySelectorAll(".tab-panel");
        const initialTab = document.body.dataset.activeTab || "overview";

        function activateTab(target) {
            tabButtons.forEach((btn) => {
                const isTarget = btn.dataset.tab === target;
                btn.classList.toggle("tab-switcher__button--active", isTarget);
                btn.setAttribute("aria-selected", isTarget);
            });
            tabPanels.forEach((panel) => {
                panel.classList.toggle("tab-panel--active", panel.id === `tab-${target}`);
            });
        }

        activateTab(initialTab);

        tabButtons.forEach((button) => {
            button.addEventListener("click", () => {
                activateTab(button.dataset.tab);
            });
        });

        const vehicleOptions = [
            "CHW-0766",
            "KY-6871",
            "BJV-8357",
            "BJY-8912",
            "KW-3141",
            "LO-5608",
            "KN-0967",
            "BJV-7747",
            "BJV-7645",
            "PI-6537",
            "KI-7135",
            "LO-2324",
            "LO-6639",
        ];

        const pettyState = {
            claim: null,
            employees: [],
            companies: [],
            claims: [],
            readOnly: false,
            filters: {
                weekStart: "",
                status: "Submitted",
                employeeId: "",
            },
        };

        const pettyEls = {
            company: document.getElementById("petty-company"),
            employee: document.getElementById("petty-employee"),
            weekStart: document.getElementById("petty-week-start"),
            weekEnd: document.getElementById("petty-week-end"),
            sheet: document.getElementById("petty-sheet"),
            vehicle: document.getElementById("petty-vehicle"),
            area: document.getElementById("petty-area"),
            mondayOdo: document.getElementById("petty-monday-odo"),
            fridayOdo: document.getElementById("petty-friday-odo"),
            linesBody: document.getElementById("petty-lines"),
            total: document.getElementById("petty-total"),
            status: document.getElementById("petty-status"),
            helper: document.getElementById("petty-helper"),
            error: document.getElementById("petty-error"),
            save: document.getElementById("petty-save"),
            submit: document.getElementById("petty-submit"),
            approve: document.getElementById("petty-approve"),
            reject: document.getElementById("petty-reject"),
            paid: document.getElementById("petty-paid"),
            review: document.getElementById("petty-review"),
            card: document.getElementById("petty-card"),
            inlineCardHost: document.getElementById("petty-card-inline-host"),
            modalHost: document.getElementById("petty-card-modal-host"),
            modal: document.getElementById("weekly-claim-modal"),
            filterWeek: document.getElementById("petty-filter-week"),
            filterStatus: document.getElementById("petty-filter-status"),
            filterEmployee: document.getElementById("petty-filter-employee"),
            claimsRows: document.getElementById("petty-claims-rows"),
            claimsEmpty: document.getElementById("petty-claims-empty"),
        };

        const managerRoles = ["admin", "finance_manager", "production_manager", "maintenance_manager"];

        function startOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(d.setDate(diff));
            monday.setHours(0, 0, 0, 0);
            return monday;
        }

        function formatDateInput(date) {
            if (!date) return "";
            const year = date.getFullYear();
            const month = `${date.getMonth() + 1}`.padStart(2, "0");
            const day = `${date.getDate()}`.padStart(2, "0");
            return `${year}-${month}-${day}`;
        }

        const pettyWeekdayFields = [
            "mon_amount",
            "tue_amount",
            "wed_amount",
            "thu_amount",
            "fri_amount",
            "sat_amount",
            "sun_amount",
        ];

        function formatAmount(value) {
            const num = Number(value || 0);
            if (Number.isNaN(num)) return "0.00";
            return num.toFixed(2);
        }

        function calculateLineTotal(line) {
            return pettyWeekdayFields.reduce((sum, field) => {
                const value = Number(line[field]);
                return sum + (Number.isFinite(value) ? value : 0);
            }, 0);
        }

        function calculateClaimTotal(claim) {
            if (!claim?.lines?.length) return 0;
            return claim.lines.reduce((sum, line) => sum + calculateLineTotal(line), 0);
        }

        function handleInlineAmountChange(line, field, newValue, totalCell) {
            const parsed = Number(newValue);
            line[field] = Number.isFinite(parsed) ? parsed : 0;
            line.row_total = calculateLineTotal(line);
            if (totalCell) {
                totalCell.textContent = formatAmount(line.row_total);
            }

            pettyState.claim.total_expenses = calculateClaimTotal(pettyState.claim);
            if (pettyEls.total) {
                pettyEls.total.textContent = formatAmount(pettyState.claim.total_expenses);
            }
        }

        function showError(message) {
            pettyEls.error.textContent = message || "";
            pettyEls.error.hidden = !message;
        }

        function openModal() {
            if (!pettyEls.modal) return;
            pettyEls.modal.classList.remove("hidden");
            pettyEls.modal.classList.add("flex");
            if (pettyEls.card && pettyEls.modalHost?.contains(pettyEls.card)) {
                pettyEls.card.hidden = false;
            }
        }

        function closeModal() {
            if (!pettyEls.modal) return;
            pettyEls.modal.classList.add("hidden");
            pettyEls.modal.classList.remove("flex");
            if (pettyEls.card && pettyEls.modalHost?.contains(pettyEls.card)) {
                pettyEls.card.hidden = true;
            }
        }

        function setReadOnlyMode(readOnly) {
            pettyState.readOnly = readOnly;
            if (pettyEls.save) pettyEls.save.hidden = readOnly;
            if (pettyEls.submit) pettyEls.submit.hidden = readOnly;
            [pettyEls.approve, pettyEls.reject, pettyEls.paid].forEach((btn) => {
                if (!btn) return;
                const isManager = managerRoles.includes(user?.role);
                btn.disabled = !isManager;
                btn.title = isManager ? "" : "Only managers/finance can approve or mark as paid";
            });
        }

        function authHeaders() {
            return {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
            };
        }

        async function fetchJson(url, options = {}) {
            const response = await fetch(url, {
                ...options,
                headers: { ...authHeaders(), ...(options.headers || {}) },
            });

            if (response.status === 401) {
                localStorage.removeItem("samprox_token");
                localStorage.removeItem("samprox_user");
                window.location.replace("/");
                return { ok: false, data: {} };
            }

            let data;
            try {
                data = await response.json();
            } catch (error) {
                data = {};
            }
            return { ok: response.ok, data };
        }

        function moveCardToModal() {
            if (!pettyEls.card || !pettyEls.modalHost) return;
            if (!pettyEls.modalHost.contains(pettyEls.card)) {
                pettyEls.modalHost.appendChild(pettyEls.card);
            }
        }

        function moveCardInline() {
            if (!pettyEls.card || !pettyEls.inlineCardHost) return;
            if (!pettyEls.inlineCardHost.contains(pettyEls.card)) {
                pettyEls.inlineCardHost.appendChild(pettyEls.card);
            }
            pettyEls.card.hidden = false;
        }

        function hideDetailsPanel() {
            closeModal();
        }

        function showDetailsPanel() {
            openModal();
        }

        const modalCloseEls = pettyEls.modal ? pettyEls.modal.querySelectorAll("[data-modal-close]") : [];
        modalCloseEls.forEach((el) => el.addEventListener("click", closeModal));

        document.addEventListener("keydown", (event) => {
            if (event.key === "Escape") closeModal();
        });

        function renderClaimsTable() {
            if (!pettyEls.claimsRows || !pettyEls.claimsEmpty) return;
            pettyEls.claimsRows.innerHTML = "";
            if (!pettyState.claims.length) {
                pettyEls.claimsEmpty.textContent = "No claims found for the selected filters.";
                pettyEls.claimsEmpty.hidden = false;
                return;
            }
            pettyEls.claimsEmpty.hidden = true;

            const dateString = (value) => {
                if (!value) return "";
                const dt = new Date(value);
                return `${dt.toLocaleDateString()} ${dt.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}`;
            };

            pettyState.claims.forEach((claim) => {
                const row = document.createElement("tr");
                row.dataset.sheetId = claim.id;
                row.className = "cursor-pointer hover:bg-gray-50";
                row.addEventListener("click", () => selectClaim(claim.id));

                [
                    claim.sheet_no || claim.id,
                    claim.employee_name,
                    claim.status,
                    formatAmount(claim.total_amount),
                    dateString(claim.submitted_at),
                    dateString(claim.updated_at),
                ].forEach((text) => {
                    const cell = document.createElement("td");
                    cell.textContent = text || "";
                    row.appendChild(cell);
                });

                pettyEls.claimsRows.appendChild(row);
            });
        }

        function updateStatusBadge(status) {
            pettyEls.status.textContent = status || "Draft";
        }

        function renderHeader() {
            const claim = pettyState.claim;
            if (!claim) return;

            const selectedCompany = claim.company?.key;
            pettyEls.company.innerHTML = "";
            pettyState.companies.forEach((company) => {
                const option = document.createElement("option");
                option.value = company.key;
                option.textContent = company.name;
                if (company.key === selectedCompany) {
                    option.selected = true;
                }
                pettyEls.company.appendChild(option);
            });

            if (!pettyEls.company.options.length && claim.company?.name) {
                const fallback = document.createElement("option");
                fallback.value = selectedCompany || "";
                fallback.textContent = claim.company.name;
                fallback.selected = true;
                pettyEls.company.appendChild(fallback);
            }

            pettyEls.sheet.value = claim.sheet_no || "";
            pettyEls.weekStart.value = claim.week_start_date;
            pettyEls.weekEnd.value = claim.week_end_date;
            pettyEls.area.value = claim.area_visited || "";
            pettyEls.mondayOdo.value = claim.monday_morning_odo ?? "";
            pettyEls.fridayOdo.value = claim.friday_evening_odo ?? "";
            renderVehicleOptions(claim.vehicle_no || "");
            updateStatusBadge(claim.status);

            const employees = [...pettyState.employees];
            const hasCurrent = employees.some((emp) => emp.id === claim.employee.id);
            if (!hasCurrent && claim.employee?.id) {
                employees.unshift(claim.employee);
            }

            pettyEls.employee.innerHTML = "";
            employees.forEach((emp) => {
                const option = document.createElement("option");
                option.value = emp.id;
                option.textContent = emp.name;
                if (emp.id === claim.employee.id) {
                    option.selected = true;
                }
                pettyEls.employee.appendChild(option);
            });

            const locked = pettyState.readOnly || ["Approved", "Paid"].includes(claim.status);
            pettyEls.employee.disabled = locked || isSales;
            if (pettyEls.weekStart) {
                pettyEls.weekStart.disabled = locked && !isSales;
            }
            [
                pettyEls.vehicle,
                pettyEls.area,
                pettyEls.company,
                pettyEls.mondayOdo,
                pettyEls.fridayOdo,
            ].forEach((field) => {
                field.disabled = locked;
            });
        }

        function renderVehicleOptions(selectedValue) {
            if (!pettyEls.vehicle) return;
            pettyEls.vehicle.innerHTML = "";

            const placeholder = document.createElement("option");
            placeholder.value = "";
            placeholder.textContent = "Select Vehicle";
            placeholder.disabled = true;
            placeholder.selected = !selectedValue;
            pettyEls.vehicle.appendChild(placeholder);

            vehicleOptions.forEach((value) => {
                const option = document.createElement("option");
                option.value = value;
                option.textContent = value;
                if (value === selectedValue) {
                    option.selected = true;
                    placeholder.selected = false;
                }
                pettyEls.vehicle.appendChild(option);
            });

            if (selectedValue && !vehicleOptions.includes(selectedValue)) {
                const fallback = document.createElement("option");
                fallback.value = selectedValue;
                fallback.textContent = selectedValue;
                fallback.selected = true;
                placeholder.selected = false;
                pettyEls.vehicle.appendChild(fallback);
            }
        }

        function lineKey(line) {
            if (!line._inputKey) {
                const randomSuffix = Math.random().toString(36).slice(2, 8);
                line._inputKey = line.id ? `line-${line.id}` : `line-temp-${randomSuffix}`;
            }
            return line._inputKey;
        }

        function buildAmountInput(line, field, locked, onInput) {
            const inputId = `${lineKey(line)}-${field}`;
            const input = document.createElement("input");
            input.type = "number";
            input.step = "0.01";
            input.inputMode = "decimal";
            input.value = formatAmount(line[field]);
            input.className = "cell-input";
            input.disabled = locked;
            input.id = inputId;
            input.name = inputId;
            input.addEventListener("input", () => {
                if (typeof onInput === "function") {
                    onInput(input.value);
                }
            });
            input.addEventListener("keydown", (event) => {
                if (event.key === "Enter") {
                    event.preventDefault();
                    persistLineUpdate(line.id, { [field]: input.value });
                }
            });
            input.addEventListener("blur", () => {
                persistLineUpdate(line.id, { [field]: input.value });
            });
            return input;
        }

        function buildTextInput(line, locked) {
            const inputId = `${lineKey(line)}-expense`;
            const input = document.createElement("input");
            input.type = "text";
            input.value = line.expense_type || "";
            input.className = "cell-input cell-input--text";
            input.disabled = locked;
            input.id = inputId;
            input.name = inputId;
            input.addEventListener("blur", () => {
                persistLineUpdate(line.id, { expense_type: input.value });
            });
            input.addEventListener("keydown", (event) => {
                if (event.key === "Enter") {
                    event.preventDefault();
                    input.blur();
                }
            });
            return input;
        }

        function renderLines() {
            const claim = pettyState.claim;
            if (!claim) return;
            pettyEls.linesBody.innerHTML = "";
            const locked = pettyState.readOnly || ["Approved", "Paid"].includes(claim.status);

            (claim.lines || []).forEach((line, index) => {
                const row = document.createElement("tr");

                const numberCell = document.createElement("td");
                numberCell.textContent = index + 1;
                row.appendChild(numberCell);

                const expenseCell = document.createElement("td");
                expenseCell.appendChild(buildTextInput(line, locked));
                row.appendChild(expenseCell);

                const totalCell = document.createElement("td");
                totalCell.className = "total-cell";

                pettyWeekdayFields.forEach((field) => {
                    const cell = document.createElement("td");
                    cell.appendChild(
                        buildAmountInput(line, field, locked, (value) =>
                            handleInlineAmountChange(line, field, value, totalCell)
                        )
                    );
                    row.appendChild(cell);
                });

                totalCell.textContent = formatAmount(line.row_total);
                row.appendChild(totalCell);

                const deleteCell = document.createElement("td");
                if (!locked) {
                    const deleteButton = document.createElement("button");
                    deleteButton.type = "button";
                    deleteButton.className = "icon-button";
                    deleteButton.textContent = "✕";
                    deleteButton.title = "Delete row";
                    deleteButton.addEventListener("click", () => deleteLine(line.id));
                    deleteCell.appendChild(deleteButton);
                }
                row.appendChild(deleteCell);

                pettyEls.linesBody.appendChild(row);
            });

            pettyEls.total.textContent = formatAmount(claim.total_expenses);
            pettyEls.helper.textContent = locked
                ? "This claim is locked because it has been approved or paid."
                : "Click any weekday cell to enter an amount. Empty cells are treated as 0.";
        }

        function applyClaim(claim) {
            pettyState.claim = claim;
            renderHeader();
            renderLines();
        }

        async function selectClaim(claimId) {
            if (!managerRoles.includes(user?.role)) return;
            const { ok, data } = await fetchJson(`/api/petty-cash/weekly-claims/${claimId}`);
            if (!ok || !data.claim) {
                showError(data.msg || "Unable to load claim.");
                return;
            }

            moveCardToModal();
            setReadOnlyMode(true);
            applyClaim(data.claim);
            showDetailsPanel();
            showError("");
        }

        async function loadEmployees(companyKey) {
            const query = companyKey ? `?company=${encodeURIComponent(companyKey)}` : "";
            const { ok, data } = await fetchJson(`/api/petty-cash/employees${query}`);
            if (ok && Array.isArray(data)) {
                pettyState.employees = data;
                if (pettyState.claim) {
                    renderHeader();
                }
                if (pettyEls.filterEmployee) {
                    pettyEls.filterEmployee.innerHTML = "<option value=\"\">All employees</option>";
                    pettyState.employees.forEach((emp) => {
                        const option = document.createElement("option");
                        option.value = emp.id;
                        option.textContent = emp.name;
                        if (String(emp.id) === String(pettyState.filters.employeeId)) {
                            option.selected = true;
                        }
                        pettyEls.filterEmployee.appendChild(option);
                    });
                }
            }
        }

        async function loadCompanies() {
            const { ok, data } = await fetchJson("/api/petty-cash/companies");
            if (ok && Array.isArray(data)) {
                pettyState.companies = data;
            }
        }

        async function loadClaimsList() {
            if (!pettyEls.filterWeek) return;
            const weekValue = pettyEls.filterWeek.value;
            if (!weekValue) {
                pettyState.claims = [];
                renderClaimsTable();
                return;
            }

            const params = new URLSearchParams({
                week_start: weekValue,
                status: pettyEls.filterStatus?.value || "ALL",
            });
            if (!isSales && pettyEls.filterEmployee?.value) {
                params.append("employee_id", pettyEls.filterEmployee.value);
            }

            const { ok, data } = await fetchJson(`/api/petty-cash/weekly-claims?${params.toString()}`);
            if (!ok || !data.claims) {
                showError(data.msg || "Unable to load weekly claims.");
                return;
            }
            pettyState.claims = data.claims;
            renderClaimsTable();
        }

        async function loadClaimForWeek(weekStartValue) {
            const params = new URLSearchParams();
            if (weekStartValue) {
                params.append("week_start", weekStartValue);
            }

            const queryString = params.toString();
            const url = queryString
                ? `/api/petty-cash/weekly-claims/init?${queryString}`
                : "/api/petty-cash/weekly-claims/init";

            const { ok, data } = await fetchJson(url);
            if (!ok || !data.claim) {
                showError(data.msg || "Unable to load petty cash claim.");
                return;
            }

            setReadOnlyMode(false);
            applyClaim(data.claim);
            await loadEmployees(data.claim.company?.key);
            showError("");
        }

        async function initPettyCash() {
            await loadCompanies();
            await loadEmployees();

            const isManagerView = managerRoles.includes(user?.role) && !isSales;
            if (isManagerView && pettyEls.review) {
                pettyEls.review.hidden = false;
                moveCardToModal();
                closeModal();
                const monday = startOfWeek(new Date());
                pettyState.filters.weekStart = formatDateInput(monday);
                if (pettyEls.filterWeek) pettyEls.filterWeek.value = pettyState.filters.weekStart;
                if (pettyEls.filterStatus) pettyEls.filterStatus.value = pettyState.filters.status;
                setReadOnlyMode(true);
                await loadClaimsList();
                return;
            }

            moveCardInline();
            closeModal();
            await loadClaimForWeek();
        }

        async function persistLineUpdate(lineId, payload) {
            if (pettyState.readOnly) return;
            if (!pettyState.claim) return;
            const claimId = pettyState.claim.id;
            const { ok, data } = await fetchJson(
                `/api/petty-cash/weekly-claims/${claimId}/lines/${lineId}`,
                { method: "PUT", body: JSON.stringify(payload) }
            );
            if (!ok || !data.claim) {
                showError(data.msg || "Unable to save line update.");
                return;
            }
            applyClaim(data.claim);
            if (pettyEls.card) {
                pettyEls.card.hidden = false;
            }
            showError("");
        }

        async function deleteLine(lineId) {
            if (pettyState.readOnly) return;
            if (!pettyState.claim) return;
            const claimId = pettyState.claim.id;
            const { ok, data } = await fetchJson(
                `/api/petty-cash/weekly-claims/${claimId}/lines/${lineId}`,
                { method: "DELETE" }
            );
            if (!ok || !data.claim) {
                showError(data.msg || "Unable to delete row.");
                return;
            }
            applyClaim(data.claim);
            showError("");
        }

        async function updateHeader(payload) {
            if (pettyState.readOnly) return;
            if (!pettyState.claim) return;
            const { ok, data } = await fetchJson(
                `/api/petty-cash/weekly-claims/${pettyState.claim.id}`,
                { method: "PUT", body: JSON.stringify(payload) }
            );
            if (!ok || !data.claim) {
                showError(data.msg || "Unable to update claim header.");
                return;
            }
            applyClaim(data.claim);
            showError("");
        }

        async function updateStatus(newStatus) {
            if (!pettyState.claim) return;
            const { ok, data } = await fetchJson(
                `/api/petty-cash/weekly-claims/${pettyState.claim.id}/status`,
                { method: "POST", body: JSON.stringify({ status: newStatus }) }
            );
            if (!ok || !data.claim) {
                showError(data.msg || "Unable to update status.");
                return;
            }
            applyClaim(data.claim);
            if (pettyState.readOnly) {
                await loadClaimsList();
            }
            showError("");
        }

        pettyEls.employee.addEventListener("change", (event) => {
            if (isSales) return;
            updateHeader({ employee_id: Number(event.target.value) });
        });

        pettyEls.company.addEventListener("change", (event) => {
            const companyKey = event.target.value;
            updateHeader({ company_id: companyKey });
            loadEmployees(companyKey);
        });

        pettyEls.weekStart.addEventListener("change", (event) => {
            const newWeek = event.target.value;
            const locked = pettyState.claim
                ? pettyState.readOnly || ["Approved", "Paid"].includes(pettyState.claim.status)
                : false;

            if (isSales) {
                loadClaimForWeek(newWeek);
                return;
            }

            updateHeader({ week_start_date: newWeek });
        });

        pettyEls.vehicle.addEventListener("change", (event) => {
            updateHeader({ vehicle_no: event.target.value });
        });

        pettyEls.area.addEventListener("blur", (event) => {
            updateHeader({ area_visited: event.target.value });
        });

        pettyEls.mondayOdo.addEventListener("change", (event) => {
            const value = event.target.value;
            updateHeader({ monday_morning_odo: value === "" ? null : value });
        });

        pettyEls.fridayOdo.addEventListener("change", (event) => {
            const value = event.target.value;
            updateHeader({ friday_evening_odo: value === "" ? null : value });
        });

        if (pettyEls.filterWeek) {
            pettyEls.filterWeek.addEventListener("change", () => {
                pettyState.filters.weekStart = pettyEls.filterWeek.value;
                pettyState.claim = null;
                hideDetailsPanel();
                loadClaimsList();
            });
        }

        if (pettyEls.filterStatus) {
            pettyEls.filterStatus.addEventListener("change", () => {
                pettyState.filters.status = pettyEls.filterStatus.value;
                pettyState.claim = null;
                hideDetailsPanel();
                loadClaimsList();
            });
        }

        if (pettyEls.filterEmployee) {
            pettyEls.filterEmployee.addEventListener("change", () => {
                pettyState.filters.employeeId = pettyEls.filterEmployee.value;
                pettyState.claim = null;
                hideDetailsPanel();
                loadClaimsList();
            });
        }

        pettyEls.save.addEventListener("click", () => updateStatus("Draft"));
        pettyEls.submit.addEventListener("click", () => updateStatus("Submitted"));
        pettyEls.approve.addEventListener("click", () => updateStatus("Approved"));
        pettyEls.reject.addEventListener("click", () => updateStatus("Rejected"));
        pettyEls.paid.addEventListener("click", () => updateStatus("Paid"));

        const financialsNewLineToggle = document.getElementById("financials-new-line-toggle");
        const financialsNewLineForm = document.getElementById("financials-new-line-form");
        const financialsLineLabel = document.getElementById("new-line-label");
        const financialsLineKey = document.getElementById("new-line-key");
        let lineKeyTouched = false;

        function slugify(value) {
            return (value || "")
                .toString()
                .trim()
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, "_")
                .replace(/^_+|_+$/g, "");
        }

        if (financialsNewLineToggle && financialsNewLineForm) {
            financialsNewLineToggle.addEventListener("click", () => {
                financialsNewLineForm.hidden = !financialsNewLineForm.hidden;
            });
        }

        if (financialsLineKey) {
            financialsLineKey.addEventListener("input", () => {
                lineKeyTouched = true;
            });
        }

        if (financialsLineLabel && financialsLineKey) {
            financialsLineLabel.addEventListener("input", () => {
                if (!lineKeyTouched) {
                    financialsLineKey.value = slugify(financialsLineLabel.value);
                }
            });
        }


        const trialBalanceCard = document.getElementById("trial-balance-card");
        const trialBalanceGrid = document.getElementById("trial-balance-grid");
        const trialBalanceSave = document.getElementById("trial-balance-save");
        const trialBalanceAddRow = document.getElementById("trial-balance-add-row");
        const trialBalanceCategoriesEl = document.getElementById("trial-balance-categories");
        const trialBalanceStatus = document.getElementById("trial-balance-status");
        const trialAccountCache = new Map();

        const trialState = {
            months: [],
            lines: [],
            totals: {},
            categories: trialBalanceCategoriesEl
                ? JSON.parse(trialBalanceCategoriesEl.dataset.categories || "{}")
                : {},
        };

        function trialBalanceYearLabel() {
            if (!trialBalanceCard) return "";
            const startYear = Number(trialBalanceCard.dataset.year || 0);
            return startYear ? `${startYear}-${startYear + 1}` : "";
        }

        function resetTrialStatus(message = "") {
            if (trialBalanceStatus) {
                trialBalanceStatus.textContent = message;
            }
        }

        function trialNumber(value) {
            const num = Number(value);
            return Number.isFinite(num) ? num : 0;
        }

        function escapeHtml(value) {
            return (value || "").replace(/[&<>"]/g, (char) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;" }[char] || char));
        }

        function trialEmptyMonths() {
            const months = {};
            for (let i = 1; i <= 12; i += 1) {
                months[i] = { debit: 0, credit: 0 };
            }
            return months;
        }

        function calculateTrialTotals() {
            const totals = {};
            for (let i = 1; i <= 12; i += 1) {
                totals[i] = { debit: 0, credit: 0 };
            }
            trialState.lines.forEach((line) => {
                Object.entries(line.months || {}).forEach(([idx, values]) => {
                    const monthIdx = Number(idx);
                    const debit = trialNumber(values.debit);
                    const credit = trialNumber(values.credit);
                    totals[monthIdx].debit += debit;
                    totals[monthIdx].credit += credit;
                });
            });
            trialState.totals = totals;
        }

        function updateTrialTotalsDisplay() {
            if (!trialBalanceGrid) return;

            trialState.months.forEach((month) => {
                const totals = trialState.totals[month.month_index] || { debit: 0, credit: 0 };
                const debitCell = trialBalanceGrid.querySelector(
                    `[data-total-month="${month.month_index}"][data-total-field="debit"]`
                );
                const creditCell = trialBalanceGrid.querySelector(
                    `[data-total-month="${month.month_index}"][data-total-field="credit"]`
                );
                const differenceCell = trialBalanceGrid.querySelector(
                    `[data-difference-month="${month.month_index}"]`
                );

                if (debitCell) debitCell.textContent = trialNumber(totals.debit).toFixed(2);
                if (creditCell) creditCell.textContent = trialNumber(totals.credit).toFixed(2);

                if (differenceCell) {
                    const difference = trialNumber(totals.debit) - trialNumber(totals.credit);
                    const balanced = Math.abs(difference) < 0.005;
                    differenceCell.textContent = `Diff: ${difference.toFixed(2)}`;
                    differenceCell.title = balanced ? "" : "Debits and credits do not balance for this month.";
                    differenceCell.classList.toggle("trial-balance__total--warn", !balanced);
                }
            });
        }

        function accountCacheKey(query = "") {
            const companyKey = trialBalanceCard?.dataset.company || "";
            return `${companyKey.toLowerCase()}::${(query || "").toLowerCase()}`;
        }

        function cacheAccounts(query, accounts) {
            trialAccountCache.set(accountCacheKey(query), accounts);
        }

        function cachedAccounts(query = "") {
            return trialAccountCache.get(accountCacheKey(query));
        }

        function findAccountInCache(predicate) {
            for (const accounts of trialAccountCache.values()) {
                const match = accounts.find(predicate);
                if (match) return match;
            }
            return null;
        }

        async function fetchAccounts(query = "") {
            const cached = cachedAccounts(query);
            if (cached) return cached;

            const params = new URLSearchParams();
            if (query) params.set("query", query);
            const companyParam = trialBalanceCard?.dataset.company;
            if (companyParam && companyParam !== "group") params.set("company_id", companyParam);

            const { ok, data } = await fetchJson(`/api/chart-of-accounts?${params.toString()}`);
            if (ok && Array.isArray(data)) {
                cacheAccounts(query, data);
                return data;
            }
            return [];
        }

        async function primeAccountCache() {
            await fetchAccounts("");
        }

        function accountLabel(account) {
            return `${account.account_code} – ${account.account_name} (${account.ifrs_category} / ${account.ifrs_subcategory})`;
        }

        function renderAccountOptions(datalist, accounts, kind) {
            if (!datalist) return;
            datalist.innerHTML = accounts
                .map((account) => {
                    const value = kind === "name" ? account.account_name : account.account_code;
                    return `<option value="${escapeHtml(value)}" label="${escapeHtml(accountLabel(account))}"></option>`;
                })
                .join("");
        }

        async function populateAccountOptions(datalist, query, kind) {
            const accounts = await fetchAccounts(query || "");
            renderAccountOptions(datalist, accounts, kind);
        }

        function applyAccountToLine(index, account) {
            const line = trialState.lines[index];
            if (!line) return;
            line.account_id = account.id;
            line.account_code = account.account_code;
            line.account_name = account.account_name;
            line.ifrs_category = account.ifrs_category;
            line.ifrs_subcategory = account.ifrs_subcategory;
            line.error = "";
        }

        function flagInvalidAccount(index, message) {
            const line = trialState.lines[index];
            if (!line) return;
            line.account_id = null;
            line.ifrs_category = "";
            line.ifrs_subcategory = "";
            line.error = message;
        }

        function reconcileTrialLinesWithAccounts() {
            trialState.lines.forEach((line, index) => {
                const account =
                    (line.account_id && findAccountInCache((acct) => acct.id === line.account_id)) ||
                    (line.account_code &&
                        findAccountInCache((acct) => acct.account_code === line.account_code));

                if (account) {
                    applyAccountToLine(index, account);
                } else if (line.account_code) {
                    flagInvalidAccount(index, "Account code not found in Chart of Accounts.");
                }
            });
        }

        function lineHasAmounts(line) {
            return Object.values(line.months || {}).some(
                (vals) => trialNumber(vals.debit) !== 0 || trialNumber(vals.credit) !== 0
            );
        }

        async function resolveAccountFromInput(value, kind) {
            const searchValue = (value || "").trim();
            if (!searchValue) return null;
            const cached = findAccountInCache((acct) =>
                (kind === "name" ? acct.account_name : acct.account_code).toLowerCase() === searchValue.toLowerCase()
            );
            if (cached) return cached;

            const accounts = await fetchAccounts(searchValue);
            return (
                accounts.find(
                    (acct) =>
                        (kind === "name" ? acct.account_name : acct.account_code).toLowerCase() ===
                        searchValue.toLowerCase()
                ) || null
            );
        }

        async function applyAccountFromInput(index, value, kind) {
            const line = trialState.lines[index];
            if (!line) return;

            const account = await resolveAccountFromInput(value, kind);
            if (!account) {
                if (kind === "code") {
                    line.account_code = value;
                    line.account_name = "";
                } else {
                    line.account_name = value;
                    line.account_code = "";
                }
                flagInvalidAccount(index, value ? "Account code not found in Chart of Accounts." : "");
                renderTrialBalance();
                return;
            }

            applyAccountToLine(index, account);
            renderTrialBalance();
        }

        function renderTrialBalance() {
            if (!trialBalanceGrid) return;
            calculateTrialTotals();

            const monthHeaders = trialState.months
                .map(
                    (month) =>
                        `<th class="trial-balance__month" colspan="2" title="As at ${month.label}">${month.label}</th>`
                )
                .join("");

            const monthSubHeaders = trialState.months
                .map(
                    () =>
                        `<th class="trial-balance__subhead trial-balance__subhead--debit">Debit</th><th class="trial-balance__subhead trial-balance__subhead--credit">Credit</th>`
                )
                .join("");

            const bodyRows = trialState.lines
                .map((line, index) => {
                    const monthCells = trialState.months
                        .map((month) => {
                            const mIdx = month.month_index;
                            const monthValues = line.months?.[mIdx] || { debit: 0, credit: 0 };
                            const debitValue = trialNumber(monthValues.debit).toFixed(2);
                            const creditValue = trialNumber(monthValues.credit).toFixed(2);
                            return `
                                <td class="trial-balance__cell">
                                    <input type="number" class="trial-input trial-input--debit" data-index="${index}" data-month="${mIdx}" data-field="debit" value="${debitValue}" step="0.01" />
                                </td>
                                <td class="trial-balance__cell">
                                    <input type="number" class="trial-input trial-input--credit" data-index="${index}" data-month="${mIdx}" data-field="credit" value="${creditValue}" step="0.01" />
                                </td>
                            `;
                        })
                        .join("");

                    const accountCodeListId = `coa-code-${index}`;
                    const accountNameListId = `coa-name-${index}`;
                    const errorMessage = line.error
                        ? `<div class="trial-balance__error">${escapeHtml(line.error)}</div>`
                        : "";

                    return `
                        <tr class="trial-balance__row">
                            <td class="trial-balance__sticky">${index + 1}</td>
                            <td class="trial-balance__sticky">
                                <div class="trial-balance__field">
                                    <input
                                        class="trial-text trial-account-code"
                                        list="${accountCodeListId}"
                                        data-index="${index}"
                                        placeholder="Search account code"
                                        value="${escapeHtml(line.account_code || "")}">
                                    <datalist id="${accountCodeListId}" class="trial-account-datalist" data-kind="code"></datalist>
                                    ${errorMessage}
                                </div>
                            </td>
                            <td class="trial-balance__sticky">
                                <div class="trial-balance__field">
                                    <input
                                        class="trial-text trial-account-name"
                                        list="${accountNameListId}"
                                        data-index="${index}"
                                        placeholder="Search account name"
                                        value="${escapeHtml(line.account_name || "")}">
                                    <datalist id="${accountNameListId}" class="trial-account-datalist" data-kind="name"></datalist>
                                </div>
                            </td>
                            <td class="trial-balance__sticky">
                                <input class="trial-text trial-text--readonly" value="${escapeHtml(line.ifrs_category || "")}" readonly />
                            </td>
                            <td class="trial-balance__sticky">
                                <input class="trial-text trial-text--readonly" value="${escapeHtml(line.ifrs_subcategory || "")}" readonly />
                            </td>
                            ${monthCells}
                            <td class="trial-balance__action">
                                <button class="button button--ghost" type="button" data-action="delete-row" data-index="${index}">Delete</button>
                            </td>
                        </tr>
                    `;
                })
                .join("");

            const totalsRow = trialState.months
                .map((month) => {
                    const t = trialState.totals[month.month_index] || { debit: 0, credit: 0 };
                    return `
                        <td class="trial-balance__total" data-total-month="${month.month_index}" data-total-field="debit">${trialNumber(
                            t.debit
                        ).toFixed(2)}</td>
                        <td class="trial-balance__total" data-total-month="${month.month_index}" data-total-field="credit">${trialNumber(
                            t.credit
                        ).toFixed(2)}</td>
                    `;
                })
                .join("");

            const diffRow = trialState.months
                .map((month) => {
                    const t = trialState.totals[month.month_index] || { debit: 0, credit: 0 };
                    const difference = trialNumber(t.debit) - trialNumber(t.credit);
                    const balanced = Math.abs(difference) < 0.005;
                    const className = balanced
                        ? "trial-balance__difference"
                        : "trial-balance__difference trial-balance__total--warn";
                    const warning = balanced ? "" : "Debits and credits do not balance for this month.";
                    return `<td colspan="2" class="${className}" data-difference-month="${month.month_index}" title="${warning}">Diff: ${difference.toFixed(2)}</td>`;
                })
                .join("");

            trialBalanceGrid.innerHTML = `
                <div class="trial-balance__scroller">
                    <table class="trial-balance__table">
                        <thead>
                            <tr>
                                <th rowspan="2" class="trial-balance__sticky">Line</th>
                                <th rowspan="2" class="trial-balance__sticky">Account Code</th>
                                <th rowspan="2" class="trial-balance__sticky">Account Name</th>
                                <th rowspan="2" class="trial-balance__sticky">IFRS Category</th>
                                <th rowspan="2" class="trial-balance__sticky">IFRS Sub-category</th>
                                ${monthHeaders}
                                <th rowspan="2" class="trial-balance__action">Actions</th>
                            </tr>
                            <tr>${monthSubHeaders}</tr>
                        </thead>
                        <tbody>
                            ${bodyRows || '<tr><td colspan="40" class="trial-balance__empty">Add a row to begin capturing balances.</td></tr>'}
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="5" class="trial-balance__totals-label">Monthly Totals</th>
                                ${totalsRow}
                                <th class="trial-balance__action"></th>
                            </tr>
                            <tr>
                                <th colspan="5" class="trial-balance__totals-label">Difference</th>
                                ${diffRow}
                                <th class="trial-balance__action"></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;

            trialBalanceGrid.querySelectorAll(".trial-account-datalist").forEach((datalist) => {
                const kind = datalist.dataset.kind || "code";
                populateAccountOptions(datalist, "", kind);
            });

            trialBalanceGrid.querySelectorAll(".trial-input").forEach((input) => {
                input.addEventListener("input", (event) => {
                    const target = event.target;
                    const idx = Number(target.dataset.index);
                    const monthIdx = Number(target.dataset.month);
                    const field = target.dataset.field;
                    if (!Number.isInteger(idx) || !Number.isInteger(monthIdx)) return;
                    const value = trialNumber(target.value);
                    trialState.lines[idx].months[monthIdx] = trialState.lines[idx].months[monthIdx] || { debit: 0, credit: 0 };
                    trialState.lines[idx].months[monthIdx][field] = value;
                    calculateTrialTotals();
                    updateTrialTotalsDisplay();
                });
            });

            trialBalanceGrid.querySelectorAll(".trial-account-code").forEach((input) => {
                input.addEventListener("input", () => {
                    const idx = Number(input.dataset.index);
                    const datalist = input.getAttribute("list") ? document.getElementById(input.getAttribute("list")) : null;
                    if (datalist) {
                        populateAccountOptions(datalist, input.value, "code");
                    }
                    const line = trialState.lines[idx];
                    if (!line) return;
                    line.account_code = input.value;
                    line.account_id = null;
                    line.ifrs_category = "";
                    line.ifrs_subcategory = "";
                    line.error = "";
                });

                input.addEventListener("change", () => {
                    const idx = Number(input.dataset.index);
                    if (!Number.isInteger(idx)) return;
                    applyAccountFromInput(idx, input.value, "code");
                });
            });

            trialBalanceGrid.querySelectorAll(".trial-account-name").forEach((input) => {
                input.addEventListener("input", () => {
                    const idx = Number(input.dataset.index);
                    const datalist = input.getAttribute("list") ? document.getElementById(input.getAttribute("list")) : null;
                    if (datalist) {
                        populateAccountOptions(datalist, input.value, "name");
                    }
                    const line = trialState.lines[idx];
                    if (!line) return;
                    line.account_name = input.value;
                    line.account_id = null;
                    line.account_code = line.account_code || "";
                    line.ifrs_category = "";
                    line.ifrs_subcategory = "";
                    line.error = "";
                });

                input.addEventListener("change", () => {
                    const idx = Number(input.dataset.index);
                    if (!Number.isInteger(idx)) return;
                    applyAccountFromInput(idx, input.value, "name");
                });
            });

            trialBalanceGrid.querySelectorAll("[data-action='delete-row']").forEach((button) => {
                button.addEventListener("click", () => {
                    const idx = Number(button.dataset.index);
                    if (!Number.isInteger(idx)) return;
                    if (!confirm("Delete this trial balance row?")) return;
                    trialState.lines.splice(idx, 1);
                    renderTrialBalance();
                });
            });
        }

        async function loadTrialBalance() {
            if (!trialBalanceCard) return;
            resetTrialStatus("Loading trial balance…");
            const companyId = trialBalanceCard.dataset.company;
            const yearLabel = trialBalanceYearLabel();
            const params = new URLSearchParams({ company_id: companyId || "", financial_year: yearLabel });
            const { ok, data } = await fetchJson(`/api/financial-statements/trial-balance?${params.toString()}`);
            if (!ok) {
                resetTrialStatus(data.error || "Unable to load trial balance.");
                return;
            }

            await primeAccountCache();

            trialState.months = data.months || [];
            trialState.lines = (data.lines || []).map((line) => ({
                ...line,
                account_id: line.account_id || null,
                error: "",
                months: Object.fromEntries(
                    Object.entries(line.months || {}).map(([idx, vals]) => [Number(idx), { debit: trialNumber(vals.debit), credit: trialNumber(vals.credit) }])
                ),
            }));
            trialState.categories = data.ifrs_categories || trialState.categories;
            reconcileTrialLinesWithAccounts();
            calculateTrialTotals();
            renderTrialBalance();
            resetTrialStatus("");
        }

        async function ensureResolvedAccounts() {
            const invalidLines = [];
            for (let i = 0; i < trialState.lines.length; i += 1) {
                const line = trialState.lines[i];
                if (!line) continue;
                const hasCode = (line.account_code || "").trim().length > 0;
                const hasName = (line.account_name || "").trim().length > 0;
                if (line.account_id || (!hasCode && !hasName && !lineHasAmounts(line))) continue;

                const account = await resolveAccountFromInput(
                    hasCode ? line.account_code : line.account_name,
                    hasCode ? "code" : "name"
                );

                if (account) {
                    applyAccountToLine(i, account);
                } else {
                    flagInvalidAccount(i, "Account code not found in Chart of Accounts.");
                    invalidLines.push(i);
                }
            }

            if (invalidLines.length) {
                renderTrialBalance();
                return false;
            }

            return true;
        }

        async function saveTrialBalance() {
            if (!trialBalanceCard || !trialBalanceSave) return;
            const companyId = trialBalanceCard.dataset.company;
            const isGroup = trialBalanceCard.dataset.group === "true";
            if (isGroup) {
                resetTrialStatus("Select a specific company to save trial balance.");
                return;
            }

            const accountsResolved = await ensureResolvedAccounts();
            if (!accountsResolved) {
                resetTrialStatus("Account code not found in Chart of Accounts.");
                return;
            }

            const payload = {
                company_id: companyId,
                financial_year: trialBalanceYearLabel(),
                lines: trialState.lines.map((line) => ({
                    account_id: line.account_id || null,
                    account_code: line.account_code || "",
                    account_name: line.account_name || "",
                    ifrs_category: line.ifrs_category || "",
                    ifrs_subcategory: line.ifrs_subcategory || "",
                    months: Object.fromEntries(
                        Object.entries(line.months || {}).map(([idx, vals]) => [idx, { debit: trialNumber(vals.debit), credit: trialNumber(vals.credit) }])
                    ),
                })),
            };

            resetTrialStatus("Saving trial balance…");
            const { ok, data } = await fetchJson("/api/financial-statements/trial-balance", {
                method: "POST",
                body: JSON.stringify(payload),
            });
            if (!ok) {
                resetTrialStatus(data.error || "Failed to save trial balance.");
                return;
            }
            resetTrialStatus("Trial balance saved.");
        }

        function addTrialRow() {
            trialState.lines.push({
                account_id: null,
                account_code: "",
                account_name: "",
                ifrs_category: "",
                ifrs_subcategory: "",
                error: "",
                months: trialEmptyMonths(),
            });
            renderTrialBalance();
        }

        if (trialBalanceCard) {
            loadTrialBalance();
            if (trialBalanceSave) {
                trialBalanceSave.addEventListener("click", saveTrialBalance);
            }
            if (trialBalanceAddRow) {
                trialBalanceAddRow.addEventListener("click", addTrialRow);
            }
        }
        function toggleManagerActions() {
            const isManager = managerRoles.includes(user?.role);
            [pettyEls.approve, pettyEls.reject, pettyEls.paid].forEach((btn) => {
                if (!btn) return;
                btn.disabled = !isManager;
                btn.title = isManager ? "" : "Only managers/finance can approve or mark as paid";
            });
        }

        toggleManagerActions();
        initPettyCash();
    </script>
</body>
</html>
