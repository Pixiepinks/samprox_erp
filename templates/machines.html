<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Machines | SAMPROX ERP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/machines.css') }}" />
</head>
<body>
    <div class="page">
        <header class="topbar">
            <div class="brand">
                <div class="brand__logo">S</div>
                <div class="brand__details">
                    <p class="brand__name">SAMPROX ERP</p>
                    <p class="brand__section">Machine Centre</p>
                </div>
            </div>
            <div class="topbar__actions">
                <a class="button button--ghost" href="{{ url_for('ui.dashboard') }}">Dashboard</a>
                <div class="user-summary">
                    <span class="user-summary__name" id="user-name"></span>
                    <span class="user-summary__role" id="user-role"></span>
                </div>
                <button type="button" class="button button--secondary" id="logout">Sign out</button>
            </div>
        </header>
        <nav class="subnav" aria-label="5M navigation">
            <a class="subnav__link" href="{{ url_for('ui.man_page') }}">Man</a>
            <a class="subnav__link subnav__link--active" href="{{ url_for('ui.machines_page') }}">Machine</a>
            <a class="subnav__link" href="{{ url_for('ui.material_page') }}">Material</a>
            <a class="subnav__link" href="{{ url_for('ui.market_page') }}">Market</a>
            <a class="subnav__link" href="{{ url_for('ui.money_page') }}">Money</a>
        </nav>
        <main class="machine-layout">
            <div class="machine-tabs" role="tablist" aria-label="Machine subsections">
                <button type="button" id="tab-button-assets" class="machine-tab is-active" role="tab" aria-selected="true" aria-controls="tab-assets" data-tab-target="assets">Assets Register</button>
                <button type="button" id="tab-button-maintenance" class="machine-tab" role="tab" aria-selected="false" aria-controls="tab-maintenance" data-tab-target="maintenance">Maintenance Management</button>
                <button type="button" id="tab-button-idle" class="machine-tab" role="tab" aria-selected="false" aria-controls="tab-idle" data-tab-target="idle">Idle Time Monitoring</button>
                <button type="button" id="tab-button-suppliers" class="machine-tab" role="tab" aria-selected="false" aria-controls="tab-suppliers" data-tab-target="suppliers">Service Supplier Register</button>
            </div>
            <div class="machine-panels">
                <section id="tab-assets" class="tab-panel is-active" role="tabpanel" aria-labelledby="tab-button-assets" data-tab-panel="assets">
                    <div class="panel-grid">
                        <section class="panel panel--form">
                            <header class="panel__header">
                                <div>
                                    <h2>Register a new asset</h2>
                                    <p class="panel__subtitle">Maintain an up-to-date registry of every machine on site.</p>
                                </div>
                            </header>
                            <div class="panel__body">
                                <div class="alert alert--info" id="asset-form-notice" hidden></div>
                                <div class="alert alert--success" id="asset-form-success" hidden>Asset added successfully.</div>
                                <div class="alert alert--error" id="asset-form-error" hidden></div>
                                <form class="form" id="asset-form" novalidate>
                                    <div class="form-grid">
                                        <div class="input-group">
                                            <label for="asset-code">Asset code <span class="required">*</span></label>
                                            <input id="asset-code" name="code" type="text" placeholder="MCH-001" required />
                                        </div>
                                        <div class="input-group">
                                            <label for="asset-name">Name <span class="required">*</span></label>
                                            <input id="asset-name" name="name" type="text" placeholder="Hydraulic press" required />
                                        </div>
                                        <div class="input-group">
                                            <label for="asset-category">Category</label>
                                            <select id="asset-category" name="category">
                                                <option value="" selected hidden>Select a category</option>
                                                <option value="Land &amp; Building">Land &amp; Building</option>
                                                <option value="Plant &amp; Machines">Plant &amp; Machines</option>
                                                <option value="Vehicles">Vehicles</option>
                                                <option value="Furniture &amp; Fixtures">Furniture &amp; Fixtures</option>
                                                <option value="Tools &amp; Equipment">Tools &amp; Equipment</option>
                                                <option value="Computers">Computers</option>
                                                <option value="Electronic Equipments">Electronic Equipments</option>
                                                <option value="Phones">Phones</option>
                                            </select>
                                        </div>
                                        <div class="input-group">
                                            <label for="asset-location">Location</label>
                                            <input id="asset-location" name="location" type="text" placeholder="Plant 1" />
                                        </div>
                                        <div class="input-group">
                                            <label for="asset-manufacturer">Manufacturer</label>
                                            <input id="asset-manufacturer" name="manufacturer" type="text" placeholder="OEM" />
                                        </div>
                                        <div class="input-group">
                                            <label for="asset-model">Model number</label>
                                            <input id="asset-model" name="model_number" type="text" placeholder="HP-300" />
                                        </div>
                                        <div class="input-group">
                                            <label for="asset-serial">Serial number</label>
                                            <input id="asset-serial" name="serial_number" type="text" placeholder="SN12345" />
                                        </div>
                                        <div class="input-group">
                                            <label for="asset-installed">Installed on</label>
                                            <input id="asset-installed" name="installed_on" type="date" />
                                        </div>
                                        <div class="input-group">
                                            <label for="asset-status">Status</label>
                                            <input id="asset-status" name="status" type="text" placeholder="Operational" />
                                        </div>
                                    </div>
                                    <div class="input-group">
                                        <label for="asset-notes">Notes</label>
                                        <textarea id="asset-notes" name="notes" rows="3" placeholder="Any supporting notes"></textarea>
                                    </div>
                                    <div class="form__footer">
                                        <button type="submit" class="button">Add asset</button>
                                    </div>
                                </form>
                            </div>
                        </section>
                        <section class="panel panel--list">
                            <header class="panel__header">
                                <div>
                                    <h2>Assets register</h2>
                                    <p class="panel__subtitle">All assets with quick access to CKD part lists.</p>
                                </div>
                                <div class="panel__header-actions">
                                    <button type="button" class="button button--ghost" id="refresh-assets">Refresh</button>
                                </div>
                            </header>
                            <div class="panel__body">
                                <div class="alert alert--error" id="asset-error" hidden></div>
                                <div class="empty-state" id="assets-empty" hidden>
                                    <p>No assets have been registered yet.</p>
                                </div>
                                <div class="table-wrapper">
                                    <table class="data-table" aria-describedby="assets-empty">
                                        <thead>
                                            <tr>
                                                <th scope="col">Code</th>
                                                <th scope="col">Name</th>
                                                <th scope="col">Location</th>
                                                <th scope="col">Status</th>
                                                <th scope="col">Parts</th>
                                                <th scope="col">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="assets-table-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </section>
                    </div>
                    <section class="panel panel--detail" id="asset-detail" hidden>
                        <header class="panel__header">
                            <div>
                                <h2 id="asset-detail-title"></h2>
                                <p class="panel__subtitle" id="asset-detail-meta"></p>
                            </div>
                            <button type="button" class="button button--ghost" id="close-asset-detail">Close</button>
                        </header>
                        <div class="panel__body asset-detail__body">
                            <div class="asset-detail__column">
                                <h3>Asset information</h3>
                                <dl class="asset-detail__facts" id="asset-detail-facts"></dl>
                            </div>
                            <div class="asset-detail__column asset-detail__column--wide">
                                <section class="asset-parts">
                                    <header class="asset-parts__header">
                                        <h3>Complete knock down (CKD) parts</h3>
                                    </header>
                                    <div class="alert alert--error" id="asset-part-error" hidden></div>
                                    <div class="alert alert--success" id="asset-part-success" hidden>Part added successfully.</div>
                                    <form class="form asset-part-form" id="asset-part-form" novalidate>
                                        <div class="form-grid">
                                            <div class="input-group">
                                                <label for="part-name">Part name <span class="required">*</span></label>
                                                <input id="part-name" name="name" type="text" placeholder="Hydraulic pump" required />
                                            </div>
                                            <div class="input-group">
                                                <label for="part-number">Part number</label>
                                                <input id="part-number" name="part_number" type="text" placeholder="P-009" />
                                            </div>
                                            <div class="input-group">
                                                <label for="part-life">Expected life (hrs)</label>
                                                <input id="part-life" name="expected_life_hours" type="number" min="0" step="1" />
                                            </div>
                                        </div>
                                        <div class="input-group">
                                            <label for="part-description">Description</label>
                                            <textarea id="part-description" name="description" rows="2" placeholder="Reference or specification"></textarea>
                                        </div>
                                        <div class="input-group">
                                            <label for="part-notes">Notes</label>
                                            <textarea id="part-notes" name="notes" rows="2" placeholder="Storage, supplier, etc."></textarea>
                                        </div>
                                        <div class="form__footer">
                                            <button type="submit" class="button">Add part</button>
                                        </div>
                                    </form>
                                    <div class="asset-parts__list" id="asset-parts-list"></div>
                                    <div class="empty-state" id="asset-parts-empty" hidden>
                                        <p>No parts have been registered for this asset yet.</p>
                                    </div>
                                </section>
                            </div>
                        </div>
                    </section>
                </section>
                <section id="tab-maintenance" class="tab-panel" role="tabpanel" aria-labelledby="tab-button-maintenance" data-tab-panel="maintenance" hidden>
                    <div class="panel-grid">
                        <section class="panel panel--form">
                            <header class="panel__header">
                                <div>
                                    <h2>Create a maintenance job</h2>
                                    <p class="panel__subtitle">Log new work orders for the maintenance team.</p>
                                </div>
                            </header>
                            <div class="panel__body">
                                <div class="alert alert--info" id="creation-notice" hidden></div>
                                <div class="alert alert--success" id="creation-success" hidden>Job created successfully.</div>
                                <div class="alert alert--error" id="creation-error" hidden></div>
                                <form class="form" id="job-form" novalidate>
                                    <div class="form-grid">
                                        <div class="input-group">
                                            <label for="code">Job code <span class="required">*</span></label>
                                            <input id="code" name="code" type="text" placeholder="JOB-001" required />
                                        </div>
                                        <div class="input-group">
                                            <label for="title">Title <span class="required">*</span></label>
                                            <input id="title" name="title" type="text" placeholder="Routine maintenance" required />
                                        </div>
                                        <div class="input-group">
                                            <label for="priority">Priority</label>
                                            <select id="priority" name="priority">
                                                <option value="Normal" selected>Normal</option>
                                                <option value="High">High</option>
                                                <option value="Low">Low</option>
                                            </select>
                                        </div>
                                        <div class="input-group">
                                            <label for="location">Location</label>
                                            <input id="location" name="location" type="text" placeholder="Plant 1" />
                                        </div>
                                        <div class="input-group">
                                            <label for="expected_completion_date">Expected completion</label>
                                            <input id="expected_completion_date" name="expected_completion_date" type="date" />
                                        </div>
                                    </div>
                                    <div class="input-group">
                                        <label for="description">Description</label>
                                        <textarea id="description" name="description" rows="4" placeholder="Provide any additional details"></textarea>
                                    </div>
                                    <div class="form__footer">
                                        <button type="submit" class="button">Create job</button>
                                    </div>
                                </form>
                            </div>
                        </section>
                        <section class="panel panel--list">
                            <header class="panel__header">
                                <div>
                                    <h2>Maintenance jobs</h2>
                                    <p class="panel__subtitle">Latest jobs ordered by creation date.</p>
                                </div>
                                <button type="button" class="button button--ghost" id="refresh-jobs">Refresh</button>
                            </header>
                            <div class="panel__body">
                                <div class="alert alert--error" id="jobs-error" hidden></div>
                                <div class="empty-state" id="jobs-empty" hidden>
                                    <p>No jobs have been created yet.</p>
                                </div>
                                <div class="table-wrapper">
                                    <table class="jobs-table" aria-describedby="jobs-empty">
                                        <thead>
                                            <tr>
                                                <th scope="col">Code</th>
                                                <th scope="col">Title</th>
                                                <th scope="col">Status</th>
                                                <th scope="col">Priority</th>
                                                <th scope="col">Assigned</th>
                                                <th scope="col">Expected completion</th>
                                                <th scope="col">Created</th>
                                            </tr>
                                        </thead>
                                        <tbody id="jobs-table-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </section>
                    </div>
                </section>
                <section id="tab-idle" class="tab-panel" role="tabpanel" aria-labelledby="tab-button-idle" data-tab-panel="idle" hidden>
                    <div class="panel-grid">
                        <section class="panel panel--form">
                            <header class="panel__header">
                                <div>
                                    <h2>Log idle time</h2>
                                    <p class="panel__subtitle">Track unplanned downtime for visibility and analysis.</p>
                                </div>
                            </header>
                            <div class="panel__body">
                                <div class="alert alert--info" id="idle-form-notice" hidden></div>
                                <div class="alert alert--success" id="idle-form-success" hidden>Idle time recorded.</div>
                                <div class="alert alert--error" id="idle-form-error" hidden></div>
                                <form class="form" id="idle-form" novalidate>
                                    <div class="form-grid">
                                        <div class="input-group">
                                            <label for="idle-asset">Asset <span class="required">*</span></label>
                                            <select id="idle-asset" name="asset_id" required></select>
                                        </div>
                                        <div class="input-group">
                                            <label for="idle-started">Start <span class="required">*</span></label>
                                            <input id="idle-started" name="started_at" type="datetime-local" required />
                                        </div>
                                        <div class="input-group">
                                            <label for="idle-ended">End</label>
                                            <input id="idle-ended" name="ended_at" type="datetime-local" />
                                        </div>
                                    </div>
                                    <div class="input-group">
                                        <label for="idle-reason">Reason</label>
                                        <input id="idle-reason" name="reason" type="text" placeholder="Breakdown, inspection, etc." />
                                    </div>
                                    <div class="input-group">
                                        <label for="idle-notes">Notes</label>
                                        <textarea id="idle-notes" name="notes" rows="3" placeholder="Optional details"></textarea>
                                    </div>
                                    <div class="form__footer">
                                        <button type="submit" class="button">Log idle time</button>
                                    </div>
                                </form>
                            </div>
                        </section>
                        <section class="panel panel--list">
                            <header class="panel__header">
                                <div>
                                    <h2>Idle time log</h2>
                                    <p class="panel__subtitle">Most recent idle events first.</p>
                                </div>
                                <button type="button" class="button button--ghost" id="refresh-idle">Refresh</button>
                            </header>
                            <div class="panel__body">
                                <div class="alert alert--error" id="idle-error" hidden></div>
                                <div class="empty-state" id="idle-empty" hidden>
                                    <p>No idle time has been recorded yet.</p>
                                </div>
                                <div class="table-wrapper">
                                    <table class="data-table" aria-describedby="idle-empty">
                                        <thead>
                                            <tr>
                                                <th scope="col">Asset</th>
                                                <th scope="col">Start</th>
                                                <th scope="col">End</th>
                                                <th scope="col">Duration (min)</th>
                                                <th scope="col">Reason</th>
                                            </tr>
                                        </thead>
                                        <tbody id="idle-table-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </section>
                    </div>
                </section>
                <section id="tab-suppliers" class="tab-panel" role="tabpanel" aria-labelledby="tab-button-suppliers" data-tab-panel="suppliers" hidden>
                    <div class="panel-grid">
                        <section class="panel panel--form">
                            <header class="panel__header">
                                <div>
                                    <h2>Add service supplier</h2>
                                    <p class="panel__subtitle">Maintain a directory of trusted maintenance partners.</p>
                                </div>
                            </header>
                            <div class="panel__body">
                                <div class="alert alert--info" id="supplier-form-notice" hidden></div>
                                <div class="alert alert--success" id="supplier-form-success" hidden>Supplier added successfully.</div>
                                <div class="alert alert--error" id="supplier-form-error" hidden></div>
                                <form class="form" id="supplier-form" novalidate>
                                    <div class="form-grid">
                                        <div class="input-group">
                                            <label for="supplier-name">Supplier name <span class="required">*</span></label>
                                            <input id="supplier-name" name="name" type="text" placeholder="ABC Engineering" required />
                                        </div>
                                        <div class="input-group">
                                            <label for="supplier-contact">Contact person</label>
                                            <input id="supplier-contact" name="contact_person" type="text" placeholder="Ms. Perera" />
                                        </div>
                                        <div class="input-group">
                                            <label for="supplier-phone">Phone</label>
                                            <input id="supplier-phone" name="phone" type="tel" placeholder="011 123 4567" />
                                        </div>
                                        <div class="input-group">
                                            <label for="supplier-email">Email</label>
                                            <input id="supplier-email" name="email" type="email" placeholder="service@example.com" />
                                        </div>
                                    </div>
                                    <div class="input-group">
                                        <label for="supplier-services">Services offered</label>
                                        <textarea id="supplier-services" name="services_offered" rows="2" placeholder="Calibration, emergency repairs"></textarea>
                                    </div>
                                    <div class="input-group">
                                        <label for="supplier-assets">Preferred assets</label>
                                        <textarea id="supplier-assets" name="preferred_assets" rows="2" placeholder="List of assets or categories"></textarea>
                                    </div>
                                    <div class="input-group">
                                        <label for="supplier-notes">Notes</label>
                                        <textarea id="supplier-notes" name="notes" rows="2" placeholder="Payment terms, service hours, etc."></textarea>
                                    </div>
                                    <div class="form__footer">
                                        <button type="submit" class="button">Add supplier</button>
                                    </div>
                                </form>
                            </div>
                        </section>
                        <section class="panel panel--list">
                            <header class="panel__header">
                                <div>
                                    <h2>Service suppliers</h2>
                                    <p class="panel__subtitle">Reference contact and service information when needed.</p>
                                </div>
                                <button type="button" class="button button--ghost" id="refresh-suppliers">Refresh</button>
                            </header>
                            <div class="panel__body">
                                <div class="alert alert--error" id="supplier-error" hidden></div>
                                <div class="empty-state" id="suppliers-empty" hidden>
                                    <p>No service suppliers registered yet.</p>
                                </div>
                                <div class="table-wrapper">
                                    <table class="data-table" aria-describedby="suppliers-empty">
                                        <thead>
                                            <tr>
                                                <th scope="col">Name</th>
                                                <th scope="col">Contact</th>
                                                <th scope="col">Phone</th>
                                                <th scope="col">Email</th>
                                                <th scope="col">Services</th>
                                            </tr>
                                        </thead>
                                        <tbody id="suppliers-table-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </section>
                    </div>
                </section>
            </div>
        </main>
    </div>
    <script>
        const token = localStorage.getItem("samprox_token");
        const userRaw = localStorage.getItem("samprox_user");
        let user;

        try {
            user = userRaw ? JSON.parse(userRaw) : null;
        } catch (_) {
            user = null;
        }

        if (!token || !user) {
            window.location.href = "/";
        }

        const roleLabels = {
            admin: "Admin",
            production_manager: "Production Manager",
            maintenance_manager: "Maintenance Manager",
            technician: "Technician",
        };

        const userNameEl = document.getElementById("user-name");
        const userRoleEl = document.getElementById("user-role");
        const logoutButton = document.getElementById("logout");

        userNameEl.textContent = user?.name || "Unknown";
        userRoleEl.textContent = roleLabels[user?.role] || "";

        logoutButton.addEventListener("click", () => {
            localStorage.removeItem("samprox_token");
            localStorage.removeItem("samprox_user");
            window.location.href = "/";
        });

        const canManageAssets = ["production_manager", "admin"].includes(user?.role);
        const canManageParts = canManageAssets || ["maintenance_manager"].includes(user?.role);
        const canCreateJobs = ["production_manager", "admin"].includes(user?.role);
        const canLogIdle = ["production_manager", "maintenance_manager", "admin"].includes(user?.role);
        const canAddSuppliers = ["production_manager", "admin"].includes(user?.role);

        const tabs = document.querySelectorAll(".machine-tab");
        const panels = document.querySelectorAll(".tab-panel");
        const loadedTabs = new Set();

        function activateTab(target) {
            tabs.forEach((tab) => {
                const isActive = tab.dataset.tabTarget === target;
                tab.classList.toggle("is-active", isActive);
                tab.setAttribute("aria-selected", isActive ? "true" : "false");
            });
            panels.forEach((panel) => {
                const isActive = panel.dataset.tabPanel === target;
                panel.classList.toggle("is-active", isActive);
                panel.hidden = !isActive;
            });
            if (!loadedTabs.has(target)) {
                loadedTabs.add(target);
                if (target === "assets") {
                    loadAssets();
                } else if (target === "maintenance") {
                    loadJobs();
                } else if (target === "idle") {
                    loadIdleEvents();
                } else if (target === "suppliers") {
                    loadSuppliers();
                }
            } else if (target === "assets") {
                populateAssetSelects();
            }
        }

        tabs.forEach((tab) => {
            tab.addEventListener("click", () => activateTab(tab.dataset.tabTarget));
        });

        const assetsTableBody = document.getElementById("assets-table-body");
        const assetsEmpty = document.getElementById("assets-empty");
        const assetError = document.getElementById("asset-error");
        const refreshAssetsButton = document.getElementById("refresh-assets");
        const assetForm = document.getElementById("asset-form");
        const assetFormNotice = document.getElementById("asset-form-notice");
        const assetFormSuccess = document.getElementById("asset-form-success");
        const assetFormError = document.getElementById("asset-form-error");
        const assetDetail = document.getElementById("asset-detail");
        const assetDetailTitle = document.getElementById("asset-detail-title");
        const assetDetailMeta = document.getElementById("asset-detail-meta");
        const assetDetailFacts = document.getElementById("asset-detail-facts");
        const assetPartForm = document.getElementById("asset-part-form");
        const assetPartError = document.getElementById("asset-part-error");
        const assetPartSuccess = document.getElementById("asset-part-success");
        const assetPartsList = document.getElementById("asset-parts-list");
        const assetPartsEmpty = document.getElementById("asset-parts-empty");
        const closeAssetDetail = document.getElementById("close-asset-detail");

        const jobForm = document.getElementById("job-form");
        const creationNotice = document.getElementById("creation-notice");
        const creationSuccess = document.getElementById("creation-success");
        const creationError = document.getElementById("creation-error");
        const jobsError = document.getElementById("jobs-error");
        const jobsEmpty = document.getElementById("jobs-empty");
        const jobsTableBody = document.getElementById("jobs-table-body");
        const refreshJobsButton = document.getElementById("refresh-jobs");

        const idleForm = document.getElementById("idle-form");
        const idleFormNotice = document.getElementById("idle-form-notice");
        const idleFormSuccess = document.getElementById("idle-form-success");
        const idleFormError = document.getElementById("idle-form-error");
        const idleAssetSelect = document.getElementById("idle-asset");
        const idleError = document.getElementById("idle-error");
        const idleEmpty = document.getElementById("idle-empty");
        const idleTableBody = document.getElementById("idle-table-body");
        const refreshIdleButton = document.getElementById("refresh-idle");

        const supplierForm = document.getElementById("supplier-form");
        const supplierFormNotice = document.getElementById("supplier-form-notice");
        const supplierFormSuccess = document.getElementById("supplier-form-success");
        const supplierFormError = document.getElementById("supplier-form-error");
        const supplierError = document.getElementById("supplier-error");
        const suppliersEmpty = document.getElementById("suppliers-empty");
        const suppliersTableBody = document.getElementById("suppliers-table-body");
        const refreshSuppliersButton = document.getElementById("refresh-suppliers");

        let assets = [];
        let currentAssetId = null;

        if (!canManageAssets) {
            assetFormNotice.textContent = "Only Production Managers or Admins can add assets.";
            assetFormNotice.hidden = false;
            assetForm.querySelectorAll("input, textarea, button").forEach((element) => {
                element.disabled = true;
            });
        }

        if (!canManageParts) {
            assetPartForm.querySelectorAll("input, textarea, button").forEach((element) => {
                element.disabled = true;
            });
            assetPartError.textContent = "Only authorised maintenance roles can add parts or log replacements.";
            assetPartError.hidden = false;
        }

        if (!canCreateJobs) {
            creationNotice.textContent = "Only Production Managers can create jobs. You can still view existing jobs.";
            creationNotice.hidden = false;
            jobForm.querySelectorAll("input, textarea, select, button").forEach((element) => {
                element.disabled = true;
            });
        }

        if (!canLogIdle) {
            idleFormNotice.textContent = "Only authorised maintenance roles can log idle time.";
            idleFormNotice.hidden = false;
            idleForm.querySelectorAll("input, textarea, select, button").forEach((element) => {
                element.disabled = true;
            });
        }

        if (!canAddSuppliers) {
            supplierFormNotice.textContent = "Only Production Managers or Admins can add suppliers.";
            supplierFormNotice.hidden = false;
            supplierForm.querySelectorAll("input, textarea, button").forEach((element) => {
                element.disabled = true;
            });
        }

        function formatDate(value, withTime = false) {
            if (!value) return "—";
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return value;
            return withTime ? date.toLocaleString() : date.toLocaleDateString();
        }

        function formatDuration(minutes) {
            if (minutes == null) return "—";
            if (minutes < 60) return `${minutes} min`;
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            if (!mins) return `${hours} hr`;
            return `${hours} hr ${mins} min`;
        }

        async function fetchJson(url, options = {}) {
            const headers = {
                Accept: "application/json",
                Authorization: `Bearer ${token}`,
                ...(options.headers || {}),
            };

            if (options.body && !headers["Content-Type"] && !headers["content-type"]) {
                headers["Content-Type"] = "application/json";
            }

            const response = await fetch(url, {
                ...options,
                headers,
            });

            if (!response.ok) {
                let message = `Request failed (${response.status})`;
                try {
                    const data = await response.json();
                    if (data?.msg) message = data.msg;
                } catch (_) {
                    // ignore
                }
                const error = new Error(message);
                error.status = response.status;
                throw error;
            }

            if (response.status === 204) {
                return null;
            }

            return response.json();
        }

        function renderAssets() {
            assetsTableBody.innerHTML = "";

            if (!Array.isArray(assets) || assets.length === 0) {
                assetsEmpty.hidden = false;
                return;
            }

            assetsEmpty.hidden = true;

            assets.forEach((asset) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td data-label="Code">${asset.code}</td>
                    <td data-label="Name">${asset.name}</td>
                    <td data-label="Location">${asset.location || "—"}</td>
                    <td data-label="Status">${asset.status || "—"}</td>
                    <td data-label="Parts">${asset.part_count || 0}</td>
                    <td data-label="Actions"><button type="button" class="button button--ghost button--small" data-action="ckd" data-asset-id="${asset.id}">CKD</button></td>
                `;
                assetsTableBody.appendChild(row);
            });
        }

        function populateAssetSelects() {
            if (!idleAssetSelect) return;
            const currentValue = idleAssetSelect.value;
            idleAssetSelect.innerHTML = "";
            if (!assets.length) {
                const option = document.createElement("option");
                option.value = "";
                option.textContent = "No assets available";
                idleAssetSelect.appendChild(option);
                idleAssetSelect.disabled = true;
                return;
            }
            idleAssetSelect.disabled = false;
            const placeholder = document.createElement("option");
            placeholder.value = "";
            placeholder.textContent = "Select an asset";
            idleAssetSelect.appendChild(placeholder);
            assets.forEach((asset) => {
                const option = document.createElement("option");
                option.value = asset.id;
                option.textContent = `${asset.code} — ${asset.name}`;
                if (currentAssetId && asset.id === currentAssetId) {
                    option.selected = true;
                } else if (currentValue && String(asset.id) === currentValue) {
                    option.selected = true;
                }
                idleAssetSelect.appendChild(option);
            });
        }

        async function loadAssets() {
            assetError.hidden = true;
            assetError.textContent = "";
            try {
                assets = await fetchJson("/api/machines/assets");
                renderAssets();
                populateAssetSelects();
            } catch (error) {
                assetError.textContent = error.message || "Unable to load assets";
                assetError.hidden = false;
                assets = [];
                renderAssets();
                populateAssetSelects();
            }
        }

        async function loadAssetParts(assetId) {
            assetPartError.hidden = true;
            assetPartSuccess.hidden = true;
            try {
                const parts = await fetchJson(`/api/machines/assets/${assetId}/parts`);
                renderParts(parts);
            } catch (error) {
                assetPartError.textContent = error.message || "Unable to load parts";
                assetPartError.hidden = false;
                renderParts([]);
            }
        }

        function renderParts(parts) {
            assetPartsList.innerHTML = "";
            if (!Array.isArray(parts) || parts.length === 0) {
                assetPartsEmpty.hidden = false;
                return;
            }
            assetPartsEmpty.hidden = true;

            parts.forEach((part) => {
                const card = document.createElement("article");
                card.className = "part-card";
                const lastReplacement = part.replacement_history?.[0];
                const historyCount = part.replacement_history?.length || 0;
                card.innerHTML = `
                    <header class="part-card__header">
                        <div>
                            <h4 class="part-card__title">${part.name}</h4>
                            <p class="part-card__meta">
                                ${part.part_number ? `Part #${part.part_number}` : "No part number"}
                                ${part.expected_life_hours ? ` • ${part.expected_life_hours} hrs expected life` : ""}
                            </p>
                            ${lastReplacement ? `<p class="part-card__meta">Last replaced on ${formatDate(lastReplacement.replaced_on)}</p>` : ""}
                        </div>
                        <div class="part-card__actions">
                            <button type="button" class="button button--ghost button--small" data-action="toggle-history">History (${historyCount})</button>
                            <button type="button" class="button button--ghost button--small" data-action="log-replacement">Log replacement</button>
                        </div>
                    </header>
                    ${part.description ? `<p class="part-card__description">${part.description}</p>` : ""}
                    ${part.notes ? `<p class="part-card__notes">${part.notes}</p>` : ""}
                    <details class="part-card__history" ${historyCount ? "" : "open"}>
                        <summary>Replacement history (${historyCount})</summary>
                        <ul class="part-card__history-list">
                            ${historyCount ? part.replacement_history.map((replacement) => `
                                <li>
                                    <div>
                                        <strong>${formatDate(replacement.replaced_on)}</strong>
                                        ${replacement.reason ? ` – ${replacement.reason}` : ""}
                                    </div>
                                    ${replacement.replaced_by ? `<div>By: ${replacement.replaced_by}</div>` : ""}
                                    ${replacement.notes ? `<div>${replacement.notes}</div>` : ""}
                                </li>
                            `).join("") : "<li>No replacements logged yet.</li>"}
                        </ul>
                    </details>
                    <form class="part-card__form" data-part-id="${part.id}" hidden>
                        <div class="form-grid">
                            <div class="input-group">
                                <label>Replaced on</label>
                                <input name="replaced_on" type="date" />
                            </div>
                            <div class="input-group">
                                <label>Replaced by</label>
                                <input name="replaced_by" type="text" placeholder="Technician" />
                            </div>
                            <div class="input-group">
                                <label>Reason</label>
                                <input name="reason" type="text" placeholder="Wear, upgrade, etc." />
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Notes</label>
                            <textarea name="notes" rows="2" placeholder="Optional remarks"></textarea>
                        </div>
                        <div class="form__footer">
                            <button type="submit" class="button">Save replacement</button>
                        </div>
                    </form>
                `;

                const historyToggle = card.querySelector('[data-action="toggle-history"]');
                const historyDetails = card.querySelector(".part-card__history");
                if (historyToggle) {
                    historyToggle.addEventListener("click", () => {
                        historyDetails.open = !historyDetails.open;
                    });
                }

                const form = card.querySelector(".part-card__form");
                const logButton = card.querySelector('[data-action="log-replacement"]');
                if (!canManageParts) {
                    if (logButton) logButton.disabled = true;
                    if (form) {
                        form.querySelectorAll("input, textarea, button").forEach((element) => {
                            element.disabled = true;
                        });
                    }
                } else if (logButton && form) {
                    logButton.addEventListener("click", () => {
                        form.hidden = !form.hidden;
                    });
                    form.addEventListener("submit", async (event) => {
                        event.preventDefault();
                        const submitButton = form.querySelector('button[type="submit"]');
                        submitButton.disabled = true;
                        const formData = new FormData(form);
                        const payload = {
                            replaced_on: formData.get("replaced_on") || null,
                            replaced_by: formData.get("replaced_by")?.trim() || null,
                            reason: formData.get("reason")?.trim() || null,
                            notes: formData.get("notes")?.trim() || null,
                        };
                        try {
                            await fetchJson(`/api/machines/parts/${part.id}/replacements`, {
                                method: "POST",
                                body: JSON.stringify(payload),
                            });
                            form.reset();
                            form.hidden = true;
                            await loadAssetParts(currentAssetId);
                        } catch (error) {
                            alert(error.message || "Unable to log replacement");
                        } finally {
                            submitButton.disabled = false;
                        }
                    });
                }

                assetPartsList.appendChild(card);
            });
        }

        assetsTableBody.addEventListener("click", (event) => {
            const button = event.target.closest("[data-action='ckd']");
            if (!button) return;
            const assetId = Number(button.dataset.assetId);
            const asset = assets.find((item) => item.id === assetId);
            if (!asset) return;
            currentAssetId = asset.id;
            assetDetailTitle.textContent = `${asset.name} (${asset.code})`;
            const metaParts = asset.part_count === 1 ? "1 part" : `${asset.part_count || 0} parts`;
            const metaLocation = asset.location ? ` • ${asset.location}` : "";
            assetDetailMeta.textContent = `${metaParts}${metaLocation}`;
            const facts = [];
            if (asset.manufacturer) facts.push(["Manufacturer", asset.manufacturer]);
            if (asset.model_number) facts.push(["Model", asset.model_number]);
            if (asset.serial_number) facts.push(["Serial", asset.serial_number]);
            if (asset.installed_on) facts.push(["Installed", formatDate(asset.installed_on)]);
            if (asset.status) facts.push(["Status", asset.status]);
            if (asset.category) facts.push(["Category", asset.category]);
            if (asset.notes) facts.push(["Notes", asset.notes]);
            assetDetailFacts.innerHTML = facts.length
                ? facts.map(([label, value]) => `<div><dt>${label}</dt><dd>${value}</dd></div>`).join("")
                : "<p>No additional details provided.</p>";
            assetDetail.hidden = false;
            loadAssetParts(asset.id);
        });

        closeAssetDetail.addEventListener("click", () => {
            assetDetail.hidden = true;
            currentAssetId = null;
            assetPartsList.innerHTML = "";
            assetPartsEmpty.hidden = true;
        });

        refreshAssetsButton.addEventListener("click", loadAssets);

        if (canManageAssets) {
            assetForm.addEventListener("submit", async (event) => {
                event.preventDefault();
                assetFormSuccess.hidden = true;
                assetFormError.hidden = true;
                const formData = new FormData(assetForm);
                const payload = Object.fromEntries(formData.entries());
                payload.code = payload.code?.trim();
                payload.name = payload.name?.trim();
                payload.category = payload.category?.trim() || null;
                payload.location = payload.location?.trim() || null;
                payload.manufacturer = payload.manufacturer?.trim() || null;
                payload.model_number = payload.model_number?.trim() || null;
                payload.serial_number = payload.serial_number?.trim() || null;
                payload.installed_on = payload.installed_on || null;
                payload.status = payload.status?.trim() || null;
                payload.notes = payload.notes?.trim() || null;

                if (!payload.code || !payload.name) {
                    assetFormError.textContent = "Code and name are required.";
                    assetFormError.hidden = false;
                    return;
                }

                const submitButton = assetForm.querySelector('button[type="submit"]');
                submitButton.disabled = true;

                try {
                    await fetchJson("/api/machines/assets", {
                        method: "POST",
                        body: JSON.stringify(payload),
                    });
                    assetForm.reset();
                    assetFormSuccess.hidden = false;
                    await loadAssets();
                } catch (error) {
                    assetFormError.textContent = error.message || "Unable to add asset";
                    assetFormError.hidden = false;
                } finally {
                    submitButton.disabled = false;
                }
            });
        }

        if (canManageParts) {
            assetPartForm.addEventListener("submit", async (event) => {
                event.preventDefault();
                if (!currentAssetId) return;
                assetPartError.hidden = true;
                assetPartSuccess.hidden = true;
                const formData = new FormData(assetPartForm);
                const payload = {
                    name: formData.get("name")?.trim(),
                    part_number: formData.get("part_number")?.trim() || null,
                    expected_life_hours: formData.get("expected_life_hours") || null,
                    description: formData.get("description")?.trim() || null,
                    notes: formData.get("notes")?.trim() || null,
                };
                if (!payload.name) {
                    assetPartError.textContent = "Part name is required.";
                    assetPartError.hidden = false;
                    return;
                }
                if (payload.expected_life_hours) {
                    payload.expected_life_hours = Number(payload.expected_life_hours);
                    if (Number.isNaN(payload.expected_life_hours)) {
                        payload.expected_life_hours = null;
                    }
                }

                const submitButton = assetPartForm.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                try {
                    await fetchJson(`/api/machines/assets/${currentAssetId}/parts`, {
                        method: "POST",
                        body: JSON.stringify(payload),
                    });
                    assetPartForm.reset();
                    assetPartSuccess.hidden = false;
                    await loadAssets();
                    await loadAssetParts(currentAssetId);
                } catch (error) {
                    assetPartError.textContent = error.message || "Unable to add part";
                    assetPartError.hidden = false;
                } finally {
                    submitButton.disabled = false;
                }
            });
        }

        async function loadJobs() {
            jobsError.hidden = true;
            jobsError.textContent = "";

            try {
                const jobs = await fetchJson("/api/jobs");
                renderJobs(jobs);
            } catch (error) {
                jobsError.textContent = error.message || "Unable to load jobs";
                jobsError.hidden = false;
                renderJobs([]);
            }
        }

        function renderJobs(jobs) {
            jobsTableBody.innerHTML = "";

            if (!Array.isArray(jobs) || jobs.length === 0) {
                jobsEmpty.hidden = false;
                return;
            }

            jobsEmpty.hidden = true;

            jobs.forEach((job) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td data-label="Code">${job.code}</td>
                    <td data-label="Title">${job.title}</td>
                    <td data-label="Status">${job.status}</td>
                    <td data-label="Priority">${job.priority}</td>
                    <td data-label="Assigned">${job.assigned_to ? job.assigned_to.name : "—"}</td>
                    <td data-label="Expected">${formatDate(job.expected_completion_date)}</td>
                    <td data-label="Created">${formatDate(job.created_at, true)}</td>
                `;
                jobsTableBody.appendChild(row);
            });
        }

        refreshJobsButton.addEventListener("click", loadJobs);

        if (canCreateJobs) {
            jobForm.addEventListener("submit", async (event) => {
                event.preventDefault();
                creationSuccess.hidden = true;
                creationError.hidden = true;
                const formData = new FormData(jobForm);
                const payload = {
                    code: formData.get("code")?.trim(),
                    title: formData.get("title")?.trim(),
                    priority: formData.get("priority") || "Normal",
                    location: formData.get("location")?.trim() || null,
                    description: formData.get("description")?.trim() || null,
                    expected_completion_date: formData.get("expected_completion_date") || null,
                };

                if (!payload.code || !payload.title) {
                    creationError.textContent = "Code and Title are required.";
                    creationError.hidden = false;
                    return;
                }

                const submitButton = jobForm.querySelector('button[type="submit"]');
                submitButton.disabled = true;

                try {
                    await fetchJson("/api/jobs", {
                        method: "POST",
                        body: JSON.stringify(payload),
                    });
                    jobForm.reset();
                    creationSuccess.hidden = false;
                    await loadJobs();
                } catch (error) {
                    creationError.textContent = error.message || "Unable to create job";
                    creationError.hidden = false;
                } finally {
                    submitButton.disabled = false;
                }
            });
        }

        function renderIdleEvents(events) {
            idleTableBody.innerHTML = "";
            if (!Array.isArray(events) || events.length === 0) {
                idleEmpty.hidden = false;
                return;
            }
            idleEmpty.hidden = true;
            events.forEach((event) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td data-label="Asset">${event.asset ? `${event.asset.code} — ${event.asset.name}` : event.asset_id}</td>
                    <td data-label="Start">${formatDate(event.started_at, true)}</td>
                    <td data-label="End">${formatDate(event.ended_at, true)}</td>
                    <td data-label="Duration">${formatDuration(event.duration_minutes)}</td>
                    <td data-label="Reason">${event.reason || "—"}</td>
                `;
                idleTableBody.appendChild(row);
            });
        }

        async function loadIdleEvents() {
            idleError.hidden = true;
            idleError.textContent = "";
            try {
                const events = await fetchJson("/api/machines/idle-events");
                renderIdleEvents(events);
            } catch (error) {
                idleError.textContent = error.message || "Unable to load idle events";
                idleError.hidden = false;
                renderIdleEvents([]);
            }
        }

        refreshIdleButton.addEventListener("click", loadIdleEvents);

        if (canLogIdle) {
            idleForm.addEventListener("submit", async (event) => {
                event.preventDefault();
                idleFormSuccess.hidden = true;
                idleFormError.hidden = true;
                const formData = new FormData(idleForm);
                const payload = {
                    asset_id: formData.get("asset_id"),
                    started_at: formData.get("started_at"),
                    ended_at: formData.get("ended_at") || null,
                    reason: formData.get("reason")?.trim() || null,
                    notes: formData.get("notes")?.trim() || null,
                };
                if (!payload.asset_id || !payload.started_at) {
                    idleFormError.textContent = "Asset and start time are required.";
                    idleFormError.hidden = false;
                    return;
                }
                const submitButton = idleForm.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                try {
                    await fetchJson("/api/machines/idle-events", {
                        method: "POST",
                        body: JSON.stringify(payload),
                    });
                    idleForm.reset();
                    idleFormSuccess.hidden = false;
                    await loadIdleEvents();
                } catch (error) {
                    idleFormError.textContent = error.message || "Unable to record idle time";
                    idleFormError.hidden = false;
                } finally {
                    submitButton.disabled = false;
                }
            });
        }

        function renderSuppliers(suppliers) {
            suppliersTableBody.innerHTML = "";
            if (!Array.isArray(suppliers) || suppliers.length === 0) {
                suppliersEmpty.hidden = false;
                return;
            }
            suppliersEmpty.hidden = true;
            suppliers.forEach((supplier) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td data-label="Name">${supplier.name}</td>
                    <td data-label="Contact">${supplier.contact_person || "—"}</td>
                    <td data-label="Phone">${supplier.phone || "—"}</td>
                    <td data-label="Email">${supplier.email || "—"}</td>
                    <td data-label="Services">${supplier.services_offered || "—"}</td>
                `;
                suppliersTableBody.appendChild(row);
            });
        }

        async function loadSuppliers() {
            supplierError.hidden = true;
            supplierError.textContent = "";
            try {
                const suppliers = await fetchJson("/api/machines/service-suppliers");
                renderSuppliers(suppliers);
            } catch (error) {
                supplierError.textContent = error.message || "Unable to load suppliers";
                supplierError.hidden = false;
                renderSuppliers([]);
            }
        }

        refreshSuppliersButton.addEventListener("click", loadSuppliers);

        if (canAddSuppliers) {
            supplierForm.addEventListener("submit", async (event) => {
                event.preventDefault();
                supplierFormSuccess.hidden = true;
                supplierFormError.hidden = true;
                const formData = new FormData(supplierForm);
                const payload = {
                    name: formData.get("name")?.trim(),
                    contact_person: formData.get("contact_person")?.trim() || null,
                    phone: formData.get("phone")?.trim() || null,
                    email: formData.get("email")?.trim() || null,
                    services_offered: formData.get("services_offered")?.trim() || null,
                    preferred_assets: formData.get("preferred_assets")?.trim() || null,
                    notes: formData.get("notes")?.trim() || null,
                };
                if (!payload.name) {
                    supplierFormError.textContent = "Supplier name is required.";
                    supplierFormError.hidden = false;
                    return;
                }
                const submitButton = supplierForm.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                try {
                    await fetchJson("/api/machines/service-suppliers", {
                        method: "POST",
                        body: JSON.stringify(payload),
                    });
                    supplierForm.reset();
                    supplierFormSuccess.hidden = false;
                    await loadSuppliers();
                } catch (error) {
                    supplierFormError.textContent = error.message || "Unable to add supplier";
                    supplierFormError.hidden = false;
                } finally {
                    submitButton.disabled = false;
                }
            });
        }

        activateTab("assets");
        loadedTabs.add("assets");
        loadAssets();
    </script>
</body>
</html>
