<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Man | SAMPROX ERP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" />
</head>
<body>
    <div class="page">
        <header class="topbar">
            <div class="brand">
                <div class="brand__logo">S</div>
                <div class="brand__details">
                    <p class="brand__name">SAMPROX ERP</p>
                    <p class="brand__section">Man Resource Planning</p>
                </div>
            </div>
            <div class="topbar__actions">
                <a class="button button--ghost" href="{{ url_for('ui.mind_page') }}">Mind</a>
                <div class="user-summary">
                    <span class="user-summary__name" id="user-name"></span>
                    <span class="user-summary__role" id="user-role"></span>
                </div>
                <button type="button" class="button button--secondary" id="logout">Sign out</button>
            </div>
        </header>
        <nav class="subnav" aria-label="7M navigation">
            <a class="subnav__link" href="{{ url_for('ui.mind_page') }}">Mind</a>
            <a class="subnav__link subnav__link--active" href="{{ url_for('ui.man_page') }}">Man</a>
            <a class="subnav__link" href="{{ url_for('ui.machines_page') }}">Machine</a>
            <a class="subnav__link" href="{{ url_for('ui.material_page') }}">Material</a>
            <a class="subnav__link" href="{{ url_for('ui.market_page') }}">Market</a>
            <a class="subnav__link" href="{{ url_for('ui.manufacturing_page') }}">Manufacturing</a>
            <a class="subnav__link" href="{{ url_for('ui.money_page') }}">Money</a>
        </nav>
        <section class="section">
            <header class="section__header">
                <h1>People & capability overview</h1>
            </header>
            <p class="section__description">
                Manage the workforce pipeline by tracking available skills, upcoming shifts, and
                training requirements. Use this page to ensure the right technicians are ready for
                each maintenance job and production order.
            </p>
            <div class="section__grid">
                <article class="tile">
                    <h2 class="tile__title">Team roster</h2>
                    <p class="tile__description">
                        View key team members, their roles, and certification status. Identify coverage
                        gaps before they impact production schedules.
                    </p>
                </article>
                <article class="tile">
                    <h2 class="tile__title">Training tracker</h2>
                    <p class="tile__description">
                        Monitor mandatory trainings, license renewals, and development plans to keep the
                        workforce compliant and skilled.
                    </p>
                </article>
                <article class="tile">
                    <h2 class="tile__title">Shift planning</h2>
                    <p class="tile__description">
                        Align technician shifts with maintenance demand and active work orders. Balance
                        workloads to prevent burnout.
                    </p>
                </article>
                <article class="tile">
                    <h2 class="tile__title">Safety briefings</h2>
                    <p class="tile__description">
                        Document toolbox talks and safety observations. Share recurring hazards with the
                        wider team to improve awareness.
                    </p>
                </article>
            </div>
            <section class="team-directory" aria-labelledby="team-directory-heading">
                <h2 class="team-directory__title" id="team-directory-heading">Team members</h2>
                <div class="table-container">
                    <table class="team-table team-table--simple">
                        <thead>
                            <tr>
                                <th scope="col">Reg No</th>
                                <th scope="col">Name</th>
                                <th scope="col">Position</th>
                                <th scope="col">Status</th>
                                <th scope="col">Join date</th>
                            </tr>
                        </thead>
                        <tbody id="team-table-body"></tbody>
                    </table>
                </div>
                <p class="team-directory__empty" id="team-empty-state" hidden>
                    No team members available yet.
                </p>
                <section class="team-form" id="team-form-section">
                    <h3 class="team-form__title">Register a team member</h3>
                    <p class="team-form__description">
                        Keep the roster current by logging new colleagues as soon as they join the team.
                    </p>
                    <div class="team-form__feedback">
                        <p class="alert alert--error" id="team-form-error" hidden></p>
                        <p class="alert alert--success" id="team-form-success" hidden></p>
                    </div>
                    <form class="edit-form" id="team-form">
                        <div class="edit-form__grid">
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-reg-number">
                                    Registration number <span class="required">*</span>
                                </label>
                                <input
                                    class="edit-form__input"
                                    id="team-reg-number"
                                    name="regNumber"
                                    type="text"
                                    autocomplete="off"
                                    required
                                />
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-name">
                                    Name <span class="required">*</span>
                                </label>
                                <input
                                    class="edit-form__input"
                                    id="team-name"
                                    name="name"
                                    type="text"
                                    autocomplete="name"
                                    required
                                />
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-nickname">Nickname</label>
                                <input
                                    class="edit-form__input"
                                    id="team-nickname"
                                    name="nickname"
                                    type="text"
                                    autocomplete="off"
                                />
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-epf">EPF number</label>
                                <input
                                    class="edit-form__input"
                                    id="team-epf"
                                    name="epf"
                                    type="text"
                                    autocomplete="off"
                                />
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-position">Position</label>
                                <input
                                    class="edit-form__input"
                                    id="team-position"
                                    name="position"
                                    type="text"
                                    autocomplete="organization-title"
                                />
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-join-date">Date of join</label>
                                <input
                                    class="edit-form__input"
                                    id="team-join-date"
                                    name="joinDate"
                                    type="date"
                                />
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-status">Status</label>
                                <select class="edit-form__input" id="team-status" name="status">
                                    <option value="Active" selected>Active</option>
                                    <option value="On Leave">On Leave</option>
                                    <option value="Inactive">Inactive</option>
                                </select>
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-image">Profile image URL</label>
                                <input
                                    class="edit-form__input"
                                    id="team-image"
                                    name="image"
                                    type="url"
                                    inputmode="url"
                                    placeholder="https://example.com/profile.jpg"
                                />
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-personal-detail">Personal detail</label>
                                <textarea
                                    class="edit-form__input"
                                    id="team-personal-detail"
                                    name="personalDetail"
                                    rows="3"
                                ></textarea>
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-assignments">Assignments</label>
                                <textarea
                                    class="edit-form__input"
                                    id="team-assignments"
                                    name="assignments"
                                    rows="3"
                                ></textarea>
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-training">Training records</label>
                                <textarea
                                    class="edit-form__input"
                                    id="team-training"
                                    name="trainingRecords"
                                    rows="3"
                                ></textarea>
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-employment-log">Employment log</label>
                                <textarea
                                    class="edit-form__input"
                                    id="team-employment-log"
                                    name="employmentLog"
                                    rows="3"
                                ></textarea>
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-files">Files</label>
                                <textarea
                                    class="edit-form__input"
                                    id="team-files"
                                    name="files"
                                    rows="3"
                                ></textarea>
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-assets">Controlled assets</label>
                                <textarea
                                    class="edit-form__input"
                                    id="team-assets"
                                    name="assets"
                                    rows="3"
                                ></textarea>
                            </div>
                        </div>
                        <div class="edit-form__actions">
                            <button type="submit" class="button button--primary">Save member</button>
                        </div>
                    </form>
                </section>
            </section>
        </section>
    </div>
    <script>
        const token = localStorage.getItem("samprox_token");
        const userRaw = localStorage.getItem("samprox_user");
        let user;

        try {
            user = userRaw ? JSON.parse(userRaw) : null;
        } catch (_) {
            user = null;
        }

        if (!token || !user) {
            window.location.href = "/";
        }

        const roleLabels = {
            admin: "Admin",
            production_manager: "Production Manager",
            maintenance_manager: "Maintenance Manager",
            technician: "Technician",
        };

        const userNameEl = document.getElementById("user-name");
        const userRoleEl = document.getElementById("user-role");
        const logoutButton = document.getElementById("logout");

        userNameEl.textContent = user?.name || "Unknown";
        userRoleEl.textContent = roleLabels[user?.role] || "";

        logoutButton.addEventListener("click", () => {
            localStorage.removeItem("samprox_token");
            localStorage.removeItem("samprox_user");
            window.location.href = "/";
        });

        const authHeaders = {
            Accept: "application/json",
            ...(token ? { Authorization: `Bearer ${token}` } : {}),
        };

        // =====================
        // Helpers: normalize date & status for API
        // =====================
        function toYyyyMmDd(input) {
            if (!input) return null;
            const d = new Date(input);
            if (!isNaN(d.getTime())) return d.toISOString().slice(0, 10);
            const mdy = /^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/.exec(String(input).trim());
            if (mdy) {
                const [, m, dd, y] = mdy;
                return `${y}-${String(m).padStart(2, "0")}-${String(dd).padStart(2, "0")}`;
            }
            const ymd = /^(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})$/.exec(String(input).trim());
            if (ymd) {
                const [, y, m, dd] = ymd;
                return `${y}-${String(m).padStart(2, "0")}-${String(dd).padStart(2, "0")}`;
            }
            return null;
        }

        function normalizeStatus(value) {
            if (!value) return "Active";
            const map = {
                "active": "Active",
                "inactive": "Inactive",
                "on leave": "On Leave",
                "on_leave": "On Leave",
                "on-leave": "On Leave",
            };
            return map[String(value).trim().toLowerCase()] ?? "Active";
        }

        const tableBody = document.getElementById("team-table-body");
        const emptyState = document.getElementById("team-empty-state");
        const formSection = document.getElementById("team-form-section");
        const teamForm = document.getElementById("team-form");
        const teamFormError = document.getElementById("team-form-error");
        const teamFormSuccess = document.getElementById("team-form-success");

        const canManageMembers = ["admin", "production_manager"].includes(user?.role);

        if (!canManageMembers && formSection) {
            formSection.hidden = true;
        }

        const sanitizeText = (value, fallback = "—") => {
            if (typeof value === "string") {
                const trimmed = value.trim();
                return trimmed || fallback;
            }

            if (value == null) {
                return fallback;
            }

            const stringValue = String(value).trim();
            return stringValue || fallback;
        };

        const formatJoinDate = (value) => {
            if (!value) {
                return "—";
            }

            try {
                const parsed = new Date(value);
                if (Number.isNaN(parsed.getTime())) {
                    return sanitizeText(value);
                }

                return parsed.toLocaleDateString(undefined, {
                    year: "numeric",
                    month: "short",
                    day: "numeric",
                });
            } catch (error) {
                console.warn("Unable to format join date", error);
                return sanitizeText(value);
            }
        };

        const renderEmptyState = (message) => {
            if (!emptyState) {
                return;
            }

            if (typeof message === "string") {
                emptyState.textContent = message;
            }

            emptyState.hidden = false;
        };

        const hideEmptyState = () => {
            if (emptyState) {
                emptyState.hidden = true;
            }
        };

        const createCell = (label, value) => {
            const cell = document.createElement("td");
            cell.setAttribute("data-label", label);
            cell.textContent = value;
            return cell;
        };

        const renderMembers = (members) => {
            if (!tableBody) {
                return;
            }

            tableBody.innerHTML = "";

            if (!Array.isArray(members) || members.length === 0) {
                renderEmptyState();
                return;
            }

            hideEmptyState();

            members.forEach((member) => {
                const row = document.createElement("tr");
                const regNo = sanitizeText(member?.regNumber);
                const name = sanitizeText(member?.name);
                const position = sanitizeText(member?.position);
                const status = sanitizeText(member?.status);
                const joinDate = formatJoinDate(member?.joinDate);

                row.appendChild(createCell("Reg No", regNo));
                row.appendChild(createCell("Name", name));
                row.appendChild(createCell("Position", position));
                row.appendChild(createCell("Status", status));
                row.appendChild(createCell("Join date", joinDate));
                tableBody.appendChild(row);
            });
        };

        const loadTeamMembers = async () => {
            if (!tableBody) {
                return;
            }

            try {
                const response = await fetch("/api/team/members", {
                    headers: authHeaders,
                });

                if (response.status === 401) {
                    logoutButton.click();
                    return;
                }

                if (!response.ok) {
                    throw new Error(`Request failed with status ${response.status}`);
                }

                const data = await response.json();
                renderMembers(data);
            } catch (error) {
                console.error("Failed to load team members", error);
                if (tableBody) {
                    tableBody.innerHTML = "";
                }
                renderEmptyState("Unable to load team members.");
            }
        };

        const resetFormFeedback = () => {
            if (teamFormError) {
                teamFormError.hidden = true;
                teamFormError.textContent = "";
            }
            if (teamFormSuccess) {
                teamFormSuccess.hidden = true;
                teamFormSuccess.textContent = "";
            }
        };

        const showFormError = (message) => {
            if (!teamFormError) {
                return;
            }
            teamFormError.textContent = message;
            teamFormError.hidden = false;
            if (teamFormSuccess) {
                teamFormSuccess.hidden = true;
                teamFormSuccess.textContent = "";
            }
        };

        const showFormSuccess = (message) => {
            if (!teamFormSuccess) {
                return;
            }
            teamFormSuccess.textContent = message;
            teamFormSuccess.hidden = false;
            if (teamFormError) {
                teamFormError.hidden = true;
                teamFormError.textContent = "";
            }
        };

        const setFormDisabled = (disabled) => {
            if (!teamForm) {
                return;
            }
            Array.from(teamForm.elements || []).forEach((element) => {
                element.disabled = disabled;
            });
        };

        if (teamForm && canManageMembers) {
            teamForm.addEventListener("submit", async (event) => {
                event.preventDefault();

                if (!teamForm.checkValidity()) {
                    teamForm.reportValidity();
                    return;
                }

                resetFormFeedback();

                const formData = new FormData(teamForm);
                const payload = {};

                const requiredFields = ["regNumber", "name"];
                for (const field of requiredFields) {
                    const rawValue = formData.get(field);
                    const value = typeof rawValue === "string" ? rawValue.trim() : "";
                    if (!value) {
                        showFormError("Registration number and name are required.");
                        return;
                    }
                    payload[field] = value;
                }

                // Normalize joinDate and status
                const joinDateRaw = formData.get("joinDate");
                const normalizedDate = toYyyyMmDd(joinDateRaw);
                if (joinDateRaw && !normalizedDate) {
                    showFormError("Invalid date for join date. Please use YYYY-MM-DD.");
                    return;
                }
               if (normalizedDate) {
                  payload.joindate = normalizedDate; // backend expects snake_case
               }

                const statusRaw = formData.get("status");
                if (statusRaw) payload.status = normalizeStatus(statusRaw);

                const optionalFields = [
                    "nickname",
                    "epf",
                    "position",
                    "image",
                    "personalDetail",
                    "assignments",
                    "trainingRecords",
                    "employmentLog",
                    "files",
                    "assets",
                ];

                optionalFields.forEach((field) => {
                    const rawValue = formData.get(field);
                    if (typeof rawValue === "string") {
                        const trimmed = rawValue.trim();
                        if (trimmed) {
                            payload[field] = trimmed;
                        }
                    }
                });

                setFormDisabled(true);

                try {
                    const response = await fetch("/api/team/members", {
                        method: "POST",
                        headers: {
                            ...authHeaders,
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(payload),
                    });

                    if (response.status === 401) {
                        logoutButton.click();
                        return;
                    }

                    const body = await response.json().catch(() => ({}));

                    if (!response.ok) {
                        const message = body?.msg || "Unable to register team member.";
                        showFormError(message);
                        return;
                    }

                    showFormSuccess("Team member registered successfully.");
                    teamForm.reset();
                    await loadTeamMembers();
                } catch (error) {
                    showFormError(error.message || "Unable to register team member.");
                } finally {
                    setFormDisabled(false);
                }
            });

            teamForm.addEventListener("input", () => {
                if (teamFormError && !teamFormError.hidden) {
                    teamFormError.hidden = true;
                    teamFormError.textContent = "";
                }
                if (teamFormSuccess && !teamFormSuccess.hidden) {
                    teamFormSuccess.hidden = true;
                    teamFormSuccess.textContent = "";
                }
            });
        }

        loadTeamMembers();
    </script>
</body>
</html>

