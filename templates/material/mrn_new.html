<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Material Receipt Note | SAMPROX ERP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" />
    <style>
        .content-card {
            background: #ffffff;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 40px rgba(15, 23, 42, 0.08);
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px 20px;
        }
        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .field label {
            font-weight: 600;
            color: #1f2937;
        }
        .field input,
        .field select,
        .field textarea {
            border: 1px solid #d1d5db;
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 0.95rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .field input:focus,
        .field select:focus,
        .field textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        .field input[readonly] {
            background-color: #f3f4f6;
            cursor: not-allowed;
        }
        .helper {
            font-size: 0.8rem;
            color: #6b7280;
        }
        .text-red {
            color: #dc2626;
        }
        .error-text {
            font-size: 0.8rem;
            color: #dc2626;
        }
        .actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }
        .button-primary {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: #fff;
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .button-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .button-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 12px 24px rgba(37, 99, 235, 0.2);
        }
        .button-secondary {
            background: transparent;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease, border-color 0.2s ease;
        }
        .button-secondary:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }
        .supplier-dropdown {
            position: relative;
        }
        .supplier-menu {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            width: 100%;
            background: #fff;
            border-radius: 12px;
            border: 1px solid rgba(15, 23, 42, 0.1);
            box-shadow: 0 15px 35px rgba(15, 23, 42, 0.15);
            max-height: 240px;
            overflow-y: auto;
            z-index: 30;
            display: none;
        }
        .supplier-menu.active {
            display: block;
        }
        .supplier-option {
            width: 100%;
            background: transparent;
            border: none;
            text-align: left;
            padding: 10px 14px;
            cursor: pointer;
            font-size: 0.95rem;
        }
        .supplier-option:hover,
        .supplier-option:focus {
            background: #eef2ff;
            outline: none;
        }
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 40;
        }
        .modal-backdrop.active {
            display: flex;
        }
        .modal-card {
            background: #fff;
            border-radius: 16px;
            padding: 24px;
            width: min(760px, 95vw);
            display: flex;
            flex-direction: column;
            gap: 16px;
            box-shadow: 0 20px 40px rgba(15, 23, 42, 0.3);
        }
        .modal-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px 20px;
        }
        .field--full {
            grid-column: 1 / -1;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-close {
            background: transparent;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #6b7280;
        }
        .alert {
            background: rgba(220, 38, 38, 0.08);
            border: 1px solid rgba(220, 38, 38, 0.4);
            color: #b91c1c;
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="page">
        <header class="topbar">
            <div class="brand">
                <div class="brand__logo">S</div>
                <div class="brand__details">
                    <p class="brand__name">SAMPROX ERP</p>
                    <p class="brand__section">Material Control</p>
                </div>
            </div>
            <div class="topbar__actions">
                <a class="button button--ghost" href="{{ url_for('ui.mind_page') }}">Mind</a>
                <div class="user-summary">
                    <span class="user-summary__name" id="user-name"></span>
                    <span class="user-summary__role" id="user-role"></span>
                </div>
                <button type="button" class="button button--secondary" id="logout">Sign out</button>
            </div>
        </header>
        <nav class="subnav" aria-label="7M navigation">
            <a class="subnav__link" href="{{ url_for('ui.mind_page') }}">Mind</a>
            <a class="subnav__link" href="{{ url_for('ui.man_page') }}">Man</a>
            <a class="subnav__link" href="{{ url_for('ui.machines_page') }}">Machine</a>
            <a class="subnav__link subnav__link--active" href="{{ url_for('ui.material_page') }}">Material</a>
            <a class="subnav__link" href="{{ url_for('ui.market_page') }}">Market</a>
            <a class="subnav__link" href="{{ url_for('ui.manufacturing_page') }}">Manufacturing</a>
            <a class="subnav__link" href="{{ url_for('ui.money_page') }}">Money</a>
        </nav>
        <section class="section">
            <header class="section__header">
                <h1>Material Receipt Note (MRN)</h1>
                <p class="section__description">Capture an incoming load and automatically compute approved rates.</p>
            </header>
            <div class="content-card">
                <form id="mrn-form" novalidate>
                    <div id="form-alert" class="alert" style="display: none;"></div>
                    <div class="form-grid">
                        <div class="field">
                            <label for="mrn-date">Date<span class="text-red"> *</span></label>
                            <input id="mrn-date" name="date" type="date" required />
                            <p class="error-text" data-error-for="date"></p>
                        </div>
                        <div class="field">
                            <label for="mrn-no">MRN No<span class="text-red"> *</span></label>
                            <input id="mrn-no" name="mrn_no" type="text" placeholder="Enter MRN reference" required />
                            <p class="error-text" data-error-for="mrn_no"></p>
                        </div>
                        <div class="field supplier-dropdown">
                            <label for="supplier-search">Supplier<span class="text-red"> *</span></label>
                            <input id="supplier-search" type="text" placeholder="Search suppliers" autocomplete="off" />
                            <input id="supplier-id" type="hidden" name="supplier_id" />
                            <div id="supplier-menu" class="supplier-menu"></div>
                            <p class="helper">Start typing to search existing suppliers or create a new one.</p>
                            <p class="error-text" data-error-for="supplier_id"></p>
                        </div>
                        <div class="field">
                            <label for="supplier-name-free">Supplier name (ad-hoc)</label>
                            <input id="supplier-name-free" type="text" placeholder="If supplier isn't in the list" />
                            <p class="error-text" data-error-for="supplier_name_free"></p>
                        </div>
                        <div class="field">
                            <label for="item-select">Item Name<span class="text-red"> *</span></label>
                            <select id="item-select" name="item_id" required>
                                <option value="__create__">➕ Create new item…</option>
                                {% for item in items %}
                                <option value="{{ item.id }}">{{ item.name }}</option>
                                {% endfor %}
                            </select>
                            <p class="helper">Choose an existing item or create a new one.</p>
                            <p class="error-text" data-error-for="item_id"></p>
                        </div>
                        <div class="field">
                            <label for="weigh-in-weight">In Weight (Kg)<span class="text-red"> *</span></label>
                            <input id="weigh-in-weight" name="weigh_in_weight_kg" type="number" min="0" step="0.001" placeholder="0.000" required />
                            <p class="error-text" data-error-for="weigh_in_weight_kg"></p>
                        </div>
                        <div class="field">
                            <label for="weigh-out-weight">Out Weight (Kg)<span class="text-red"> *</span></label>
                            <input id="weigh-out-weight" name="weigh_out_weight_kg" type="number" min="0" step="0.001" placeholder="0.000" required />
                            <p class="error-text" data-error-for="weigh_out_weight_kg"></p>
                        </div>
                        <div class="field">
                            <label for="qty-ton">Qty (Ton)<span class="text-red"> *</span></label>
                            <input id="qty-ton" name="qty_ton" type="number" min="0" step="0.001" placeholder="0.000" readonly required />
                            <p class="helper">Automatically calculated from Out Weight − In Weight.</p>
                            <p class="error-text" data-error-for="qty_ton"></p>
                        </div>
                        <div class="field">
                            <label for="unit-price">Unit Price<span class="text-red"> *</span></label>
                            <input id="unit-price" name="unit_price" type="number" min="0" step="0.01" placeholder="0.00" required />
                            <p class="error-text" data-error-for="unit_price"></p>
                        </div>
                        <div class="field">
                            <label for="wet-factor">Wet Factor</label>
                            <input id="wet-factor" name="wet_factor" type="number" min="0" step="0.001" value="1.000" />
                            <p class="error-text" data-error-for="wet_factor"></p>
                        </div>
                        <div class="field">
                            <label for="approved-unit-price">Approved Unit Price</label>
                            <input id="approved-unit-price" type="text" value="0.00" readonly />
                            <p class="helper">Calculated as Unit Price × Wet Factor.</p>
                        </div>
                        <div class="field">
                            <label for="amount">Amount</label>
                            <input id="amount" type="text" value="0.00" readonly />
                            <p class="helper">Calculated as Qty × Approved Unit Price.</p>
                        </div>
                        <div class="field">
                            <label for="weighing-slip">Weighing Slip No<span class="text-red"> *</span></label>
                            <input id="weighing-slip" name="weighing_slip_no" type="text" placeholder="Enter slip number" required />
                            <p class="error-text" data-error-for="weighing_slip_no"></p>
                        </div>
                        <div class="field">
                            <label for="weigh-in">Weigh Bridge In-time<span class="text-red"> *</span></label>
                            <input id="weigh-in" name="weigh_in_time" type="datetime-local" required />
                            <p class="error-text" data-error-for="weigh_in_time"></p>
                        </div>
                        <div class="field">
                            <label for="weigh-out">Weigh Bridge Out-time<span class="text-red"> *</span></label>
                            <input id="weigh-out" name="weigh_out_time" type="datetime-local" required />
                            <p class="error-text" data-error-for="weigh_out_time"></p>
                        </div>
                        <div class="field">
                            <label for="security-officer">Security Officer Name<span class="text-red"> *</span></label>
                            <input id="security-officer" name="security_officer_name" type="text" required />
                            <p class="error-text" data-error-for="security_officer_name"></p>
                        </div>
                        <div class="field">
                            <label for="authorized-person">Authorized Person Name<span class="text-red"> *</span></label>
                            <input id="authorized-person" name="authorized_person_name" type="text" required />
                            <p class="error-text" data-error-for="authorized_person_name"></p>
                        </div>
                    </div>
                    <div class="actions">
                        <button type="button" class="button-secondary" id="reset-form">Reset</button>
                        <button type="submit" class="button-primary" id="submit-btn">Save MRN</button>
                    </div>
                </form>
            </div>
        </section>
    </div>

    <div id="supplier-modal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="supplier-modal-title">
        <div class="modal-card">
            <div class="modal-header">
                <h2 id="supplier-modal-title">Create new supplier</h2>
                <button type="button" class="modal-close" id="close-supplier-modal" aria-label="Close">×</button>
            </div>
            <form id="supplier-form" novalidate>
                <div class="modal-form-grid">
                    <div class="field field--full">
                        <label for="supplier-name">Supplier Name<span class="text-red"> *</span></label>
                        <input id="supplier-name" name="name" type="text" required />
                        <p class="error-text" data-error-for="modal_name"></p>
                    </div>
                    <div class="field">
                        <label for="supplier-registration">Supplier Registration No</label>
                        <input id="supplier-registration" type="text" name="supplier_reg_no" readonly />
                    </div>
                    <div class="field">
                        <label for="supplier-id-no">Supplier ID No<span class="text-red"> *</span></label>
                        <input id="supplier-id-no" name="supplier_id_no" type="text" required />
                        <p class="error-text" data-error-for="modal_supplier_id_no"></p>
                    </div>
                    <div class="field">
                        <label for="supplier-category">Category<span class="text-red"> *</span></label>
                        <select id="supplier-category" name="category" required>
                            <option value="" hidden>Select category</option>
                            <option value="Raw Material">Raw Material</option>
                            <option value="Packing Material">Packing Material</option>
                            <option value="Repair Material">Repair Material</option>
                            <option value="Maintenance Material">Maintenance Material</option>
                        </select>
                        <p class="error-text" data-error-for="modal_category"></p>
                    </div>
                    <div class="field">
                        <label for="supplier-primary-phone">Primary Phone<span class="text-red"> *</span></label>
                        <input id="supplier-primary-phone" name="primary_phone" type="text" required />
                        <p class="error-text" data-error-for="modal_primary_phone"></p>
                    </div>
                    <div class="field">
                        <label for="supplier-secondary-phone">Secondary Phone</label>
                        <input id="supplier-secondary-phone" name="secondary_phone" type="text" />
                    </div>
                    <div class="field">
                        <label for="supplier-vehicle-1">Vehicle No 1</label>
                        <input id="supplier-vehicle-1" name="vehicle_no_1" type="text" />
                        <p class="helper" id="vehicle-no-1-helper" hidden>Required for Raw Material suppliers.</p>
                        <p class="error-text" data-error-for="modal_vehicle_no_1"></p>
                    </div>
                    <div class="field">
                        <label for="supplier-vehicle-2">Vehicle No 2</label>
                        <input id="supplier-vehicle-2" name="vehicle_no_2" type="text" />
                    </div>
                    <div class="field">
                        <label for="supplier-vehicle-3">Vehicle No 3</label>
                        <input id="supplier-vehicle-3" name="vehicle_no_3" type="text" />
                    </div>
                    <div class="field">
                        <label for="supplier-credit-period">Credit Period<span class="text-red"> *</span></label>
                        <select id="supplier-credit-period" name="credit_period" required>
                            <option value="" hidden>Select credit period</option>
                            <option value="Cash">Cash</option>
                            <option value="3 Days">3 Days</option>
                            <option value="7 Days">7 Days</option>
                            <option value="1 Month">1 Month</option>
                        </select>
                        <p class="error-text" data-error-for="modal_credit_period"></p>
                    </div>
                    <div class="field">
                        <label for="supplier-email">Email</label>
                        <input id="supplier-email" name="email" type="email" />
                    </div>
                    <div class="field field--full">
                        <label for="supplier-address">Address</label>
                        <textarea id="supplier-address" name="address" rows="2"></textarea>
                    </div>
                    <div class="field">
                        <label for="supplier-tax">Tax ID</label>
                        <input id="supplier-tax" name="tax_id" type="text" />
                    </div>
                </div>
                <div id="supplier-modal-alert" class="alert" style="display: none;"></div>
                <div class="actions">
                    <button type="button" class="button-secondary" id="cancel-supplier">Cancel</button>
                    <button type="submit" class="button-primary" id="save-supplier" disabled>Save Supplier</button>
                </div>
            </form>
        </div>
    </div>

    <div id="item-modal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="item-modal-title">
        <div class="modal-card">
            <div class="modal-header">
                <h2 id="item-modal-title">Create new item</h2>
                <button type="button" class="modal-close" id="close-item-modal" aria-label="Close">×</button>
            </div>
            <form id="item-form" novalidate>
                <div class="field">
                    <label for="item-name">Item Name<span class="text-red"> *</span></label>
                    <input id="item-name" name="name" type="text" required />
                    <p class="error-text" data-error-for="modal_item_name"></p>
                </div>
                <div id="item-modal-alert" class="alert" style="display: none;"></div>
                <div class="actions">
                    <button type="button" class="button-secondary" id="cancel-item">Cancel</button>
                    <button type="submit" class="button-primary" id="save-item">Save Item</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const token = localStorage.getItem("samprox_token");
        const userRaw = localStorage.getItem("samprox_user");
        let user;

        try {
            user = userRaw ? JSON.parse(userRaw) : null;
        } catch (_) {
            user = null;
        }

        if (!token || !user) {
            window.location.href = "/";
        }

        const roleLabels = {
            admin: "Admin",
            production_manager: "Production Manager",
            maintenance_manager: "Maintenance Manager",
            technician: "Technician",
        };

        const userNameEl = document.getElementById("user-name");
        const userRoleEl = document.getElementById("user-role");
        const logoutButton = document.getElementById("logout");

        userNameEl.textContent = user?.name || "Unknown";
        userRoleEl.textContent = roleLabels[user?.role] || "";

        logoutButton.addEventListener("click", () => {
            localStorage.removeItem("samprox_token");
            localStorage.removeItem("samprox_user");
            window.location.href = "/";
        });

        const supplierInput = document.getElementById("supplier-search");
        const supplierIdInput = document.getElementById("supplier-id");
        const supplierMenu = document.getElementById("supplier-menu");
        const supplierNameFreeInput = document.getElementById("supplier-name-free");
        const mrnForm = document.getElementById("mrn-form");
        const submitBtn = document.getElementById("submit-btn");
        const formAlert = document.getElementById("form-alert");
        const resetBtn = document.getElementById("reset-form");
        const unitPriceInput = document.getElementById("unit-price");
        const wetFactorInput = document.getElementById("wet-factor");
        const approvedUnitPriceInput = document.getElementById("approved-unit-price");
        const weighInWeightInput = document.getElementById("weigh-in-weight");
        const weighOutWeightInput = document.getElementById("weigh-out-weight");
        const qtyInput = document.getElementById("qty-ton");
        const amountInput = document.getElementById("amount");
        const itemSelect = document.getElementById("item-select");
        let lastValidItemValue = "";

        const supplierModal = document.getElementById("supplier-modal");
        const supplierModalAlert = document.getElementById("supplier-modal-alert");
        const supplierModalClose = document.getElementById("close-supplier-modal");
        const supplierModalCancel = document.getElementById("cancel-supplier");
        const supplierModalForm = document.getElementById("supplier-form");
        const supplierModalSaveButton = document.getElementById("save-supplier");
        const supplierRegistrationInput = document.getElementById("supplier-registration");
        const supplierFieldElements = {
            name: document.getElementById("supplier-name"),
            supplier_id_no: document.getElementById("supplier-id-no"),
            category: document.getElementById("supplier-category"),
            primary_phone: document.getElementById("supplier-primary-phone"),
            secondary_phone: document.getElementById("supplier-secondary-phone"),
            vehicle_no_1: document.getElementById("supplier-vehicle-1"),
            vehicle_no_2: document.getElementById("supplier-vehicle-2"),
            vehicle_no_3: document.getElementById("supplier-vehicle-3"),
            credit_period: document.getElementById("supplier-credit-period"),
            email: document.getElementById("supplier-email"),
            address: document.getElementById("supplier-address"),
            tax_id: document.getElementById("supplier-tax"),
        };
        const vehicleRequirementHelper = document.getElementById("vehicle-no-1-helper");
        const supplierTouchedFields = new Set();
        let supplierServerErrors = {};
        const supplierCategories = new Set([
            "Raw Material",
            "Packing Material",
            "Repair Material",
            "Maintenance Material",
        ]);
        const supplierCreditPeriods = new Set(["Cash", "3 Days", "7 Days", "1 Month"]);

        const itemModal = document.getElementById("item-modal");
        const itemModalAlert = document.getElementById("item-modal-alert");
        const itemModalClose = document.getElementById("close-item-modal");
        const itemModalCancel = document.getElementById("cancel-item");
        const itemModalForm = document.getElementById("item-form");

        function clearErrors() {
            formAlert.style.display = "none";
            formAlert.textContent = "";
            document.querySelectorAll("[data-error-for]").forEach((node) => {
                node.textContent = "";
            });
        }

        function setError(field, message) {
            const target = document.querySelector(`[data-error-for="${field}"]`);
            if (target) {
                target.textContent = message;
            } else {
                formAlert.style.display = "block";
                formAlert.textContent = message;
            }
        }

        function setModalError(message) {
            if (!message) {
                supplierModalAlert.style.display = "none";
                supplierModalAlert.textContent = "";
                return;
            }
            supplierModalAlert.style.display = "block";
            supplierModalAlert.textContent = message;
        }

        function clearSupplierErrors() {
            supplierModalForm.querySelectorAll(".error-text").forEach((node) => {
                if (node.dataset.errorFor && node.dataset.errorFor.startsWith("modal_")) {
                    node.textContent = "";
                }
            });
        }

        function getSupplierFormValues() {
            return {
                name: (supplierFieldElements.name?.value || "").trim(),
                supplier_id_no: (supplierFieldElements.supplier_id_no?.value || "").trim(),
                category: supplierFieldElements.category?.value || "",
                primary_phone: (supplierFieldElements.primary_phone?.value || "").trim(),
                secondary_phone: (supplierFieldElements.secondary_phone?.value || "").trim(),
                vehicle_no_1: (supplierFieldElements.vehicle_no_1?.value || "").trim(),
                vehicle_no_2: (supplierFieldElements.vehicle_no_2?.value || "").trim(),
                vehicle_no_3: (supplierFieldElements.vehicle_no_3?.value || "").trim(),
                credit_period: supplierFieldElements.credit_period?.value || "",
                email: (supplierFieldElements.email?.value || "").trim(),
                address: (supplierFieldElements.address?.value || "").trim(),
                tax_id: (supplierFieldElements.tax_id?.value || "").trim(),
            };
        }

        function validateSupplierFormValues(values) {
            const errors = {};
            if (!values.name) {
                errors.name = "Supplier name is required.";
            }
            if (!values.primary_phone) {
                errors.primary_phone = "Primary phone is required.";
            }
            if (!values.category) {
                errors.category = "Category is required.";
            } else if (!supplierCategories.has(values.category)) {
                errors.category = "Select a valid category.";
            }
            if (!values.supplier_id_no) {
                errors.supplier_id_no = "Supplier ID number is required.";
            }
            if (!values.credit_period) {
                errors.credit_period = "Credit period is required.";
            } else if (!supplierCreditPeriods.has(values.credit_period)) {
                errors.credit_period = "Select a valid credit period.";
            }
            if (values.category === "Raw Material" && !values.vehicle_no_1) {
                errors.vehicle_no_1 = "Vehicle number is required for Raw Material suppliers.";
            }
            return errors;
        }

        function updateSupplierFieldErrors(errors, { force = false } = {}) {
            const mapping = {
                name: "modal_name",
                primary_phone: "modal_primary_phone",
                category: "modal_category",
                supplier_id_no: "modal_supplier_id_no",
                credit_period: "modal_credit_period",
                vehicle_no_1: "modal_vehicle_no_1",
            };

            Object.entries(mapping).forEach(([field, key]) => {
                const node = supplierModalForm.querySelector(`[data-error-for='${key}']`);
                if (!node) {
                    return;
                }
                const message = errors[field];
                if (message && (force || supplierTouchedFields.has(field))) {
                    node.textContent = message;
                } else if (!message) {
                    node.textContent = "";
                } else if (!force) {
                    node.textContent = "";
                }
            });
        }

        function updateSupplierSaveButton(errors) {
            if (!supplierModalSaveButton) {
                return;
            }
            supplierModalSaveButton.disabled = Object.keys(errors).length > 0;
        }

        function updateVehicleRequirement(categoryValue) {
            const isRaw = categoryValue === "Raw Material";
            const vehicleField = supplierFieldElements.vehicle_no_1;
            if (vehicleField) {
                if (isRaw) {
                    vehicleField.setAttribute("required", "required");
                } else {
                    vehicleField.removeAttribute("required");
                }
            }
            if (vehicleRequirementHelper) {
                if (isRaw) {
                    vehicleRequirementHelper.removeAttribute("hidden");
                } else {
                    vehicleRequirementHelper.setAttribute("hidden", "");
                }
            }
        }

        function evaluateSupplierForm({ force = false } = {}) {
            const values = getSupplierFormValues();
            const clientErrors = validateSupplierFormValues(values);
            const combinedErrors = { ...clientErrors, ...supplierServerErrors };
            updateSupplierFieldErrors(combinedErrors, { force });
            updateSupplierSaveButton(combinedErrors);
            return { values, errors: combinedErrors, clientErrors };
        }

        async function prepareSupplierRegistrationNumber() {
            if (!supplierRegistrationInput) {
                return;
            }
            supplierRegistrationInput.value = "Loading…";
            supplierRegistrationInput.placeholder = "Will be generated on save";
            try {
                const response = await fetch("/api/material/suppliers/next-registration-number");
                if (!response.ok) {
                    throw new Error("Failed to load registration number");
                }
                const data = await response.json();
                supplierRegistrationInput.value = data?.registration_no || "";
            } catch (error) {
                supplierRegistrationInput.value = "";
            }
        }

        function setItemModalError(message) {
            if (!message) {
                itemModalAlert.style.display = "none";
                itemModalAlert.textContent = "";
                return;
            }
            itemModalAlert.style.display = "block";
            itemModalAlert.textContent = message;
        }

        function toFixed(value, precision) {
            const factor = Math.pow(10, precision);
            return (Math.round(value * factor) / factor).toFixed(precision);
        }

        function updateApprovedUnitPrice() {
            const unit = parseFloat(unitPriceInput.value) || 0;
            const wet = parseFloat(wetFactorInput.value) || 0;
            const approved = toFixed(unit * wet, 2);
            approvedUnitPriceInput.value = approved;
            updateAmount();
        }

        function updateAmount() {
            const qty = parseFloat(qtyInput.value) || 0;
            const approved = parseFloat(approvedUnitPriceInput.value) || 0;
            amountInput.value = toFixed(qty * approved, 2);
        }

        function updateQuantityFromWeights() {
            if (!weighInWeightInput || !weighOutWeightInput || !qtyInput) {
                return;
            }
            const inWeight = parseFloat(weighInWeightInput.value);
            const outWeight = parseFloat(weighOutWeightInput.value);
            if (!Number.isFinite(inWeight) || !Number.isFinite(outWeight)) {
                qtyInput.value = "";
                updateAmount();
                return;
            }
            const netKg = outWeight - inWeight;
            if (netKg <= 0) {
                qtyInput.value = "";
                updateAmount();
                return;
            }
            const netTon = netKg / 1000;
            qtyInput.value = toFixed(netTon, 3);
            updateAmount();
        }

        unitPriceInput.addEventListener("input", updateApprovedUnitPrice);
        wetFactorInput.addEventListener("input", updateApprovedUnitPrice);
        qtyInput.addEventListener("input", updateAmount);
        if (weighInWeightInput) {
            weighInWeightInput.addEventListener("input", updateQuantityFromWeights);
        }
        if (weighOutWeightInput) {
            weighOutWeightInput.addEventListener("input", updateQuantityFromWeights);
        }
        updateQuantityFromWeights();

        function toggleSupplierMenu(show) {
            if (show) {
                supplierMenu.classList.add("active");
            } else {
                supplierMenu.classList.remove("active");
            }
        }

        async function loadSuppliers(query = "") {
            const url = new URL("/api/material/suppliers", window.location.origin);
            if (query) {
                url.searchParams.set("search", query);
            }
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error("Failed to load suppliers");
            }
            return await response.json();
        }

        async function fetchSuppliers(query = "") {
            try {
                const suppliers = await loadSuppliers(query);
                renderSupplierMenu(suppliers);
            } catch (error) {
                renderSupplierMenu([]);
                formAlert.style.display = "block";
                formAlert.textContent = "Unable to load suppliers. Please try again.";
            }
        }

        function renderSupplierMenu(suppliers) {
            supplierMenu.innerHTML = "";
            const createBtn = document.createElement("button");
            createBtn.type = "button";
            createBtn.className = "supplier-option";
            createBtn.textContent = "➕ Create new supplier…";
            createBtn.addEventListener("click", () => {
                toggleSupplierMenu(false);
                openSupplierModal();
            });
            supplierMenu.appendChild(createBtn);

            if (suppliers.length === 0) {
                const empty = document.createElement("div");
                empty.className = "supplier-option";
                empty.textContent = "No suppliers found";
                empty.setAttribute("aria-disabled", "true");
                empty.style.cursor = "default";
                supplierMenu.appendChild(empty);
                return;
            }

            suppliers.forEach((supplier) => {
                const option = document.createElement("button");
                option.type = "button";
                option.className = "supplier-option";
                option.textContent = supplier.name;
                option.dataset.id = supplier.id;
                option.addEventListener("click", () => {
                    supplierInput.value = supplier.name;
                    supplierIdInput.value = supplier.id;
                    supplierNameFreeInput.value = "";
                    toggleSupplierMenu(false);
                });
                supplierMenu.appendChild(option);
            });
        }

        supplierInput.addEventListener("focus", () => {
            fetchSuppliers("");
            toggleSupplierMenu(true);
        });

        supplierInput.addEventListener("input", (event) => {
            const value = event.target.value;
            supplierIdInput.value = "";
            fetchSuppliers(value);
        });

        document.addEventListener("click", (event) => {
            if (!supplierMenu.contains(event.target) && event.target !== supplierInput) {
                toggleSupplierMenu(false);
            }
        });

        supplierNameFreeInput.addEventListener("input", () => {
            if (supplierNameFreeInput.value.trim()) {
                supplierIdInput.value = "";
                supplierInput.value = "";
            }
        });

        function openSupplierModal() {
            supplierModal.classList.add("active");
            setModalError("");
            supplierTouchedFields.clear();
            supplierServerErrors = {};
            supplierModalForm.reset();
            clearSupplierErrors();
            if (supplierFieldElements.category) {
                supplierFieldElements.category.value = "";
            }
            if (supplierFieldElements.credit_period) {
                supplierFieldElements.credit_period.value = "";
            }
            updateVehicleRequirement("");
            if (supplierRegistrationInput) {
                supplierRegistrationInput.value = "";
            }
            evaluateSupplierForm();
            prepareSupplierRegistrationNumber();
            supplierFieldElements.name?.focus();
        }

        function closeSupplierModal() {
            supplierModal.classList.remove("active");
        }

        supplierModalClose.addEventListener("click", closeSupplierModal);
        supplierModalCancel.addEventListener("click", closeSupplierModal);

        supplierModal.addEventListener("click", (event) => {
            if (event.target === supplierModal) {
                closeSupplierModal();
            }
        });

        Object.entries(supplierFieldElements).forEach(([field, element]) => {
            if (!element) {
                return;
            }
            const handler = () => {
                supplierTouchedFields.add(field);
                if (field in supplierServerErrors) {
                    delete supplierServerErrors[field];
                }
                if (field === "category") {
                    updateVehicleRequirement(element.value);
                }
                evaluateSupplierForm();
            };
            const eventName = element.tagName === "SELECT" ? "change" : "input";
            element.addEventListener(eventName, handler);
            element.addEventListener("blur", handler);
        });

        supplierModalForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            setModalError("");
            supplierServerErrors = {};
            supplierTouchedFields.add("name");
            supplierTouchedFields.add("supplier_id_no");
            supplierTouchedFields.add("category");
            supplierTouchedFields.add("primary_phone");
            supplierTouchedFields.add("credit_period");
            supplierTouchedFields.add("vehicle_no_1");

            const { values, clientErrors } = evaluateSupplierForm({ force: true });
            if (Object.keys(clientErrors).length > 0) {
                return;
            }

            supplierModalSaveButton.disabled = true;
            try {
                const payload = {
                    name: values.name,
                    supplier_id_no: values.supplier_id_no,
                    category: values.category,
                    primary_phone: values.primary_phone,
                    credit_period: values.credit_period,
                };

                if (values.secondary_phone) {
                    payload.secondary_phone = values.secondary_phone;
                }
                if (values.vehicle_no_1) {
                    payload.vehicle_no_1 = values.vehicle_no_1;
                }
                if (values.vehicle_no_2) {
                    payload.vehicle_no_2 = values.vehicle_no_2;
                }
                if (values.vehicle_no_3) {
                    payload.vehicle_no_3 = values.vehicle_no_3;
                }
                if (values.email) {
                    payload.email = values.email;
                }
                if (values.address) {
                    payload.address = values.address;
                }
                if (values.tax_id) {
                    payload.tax_id = values.tax_id;
                }

                const response = await fetch("/api/material/suppliers", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                });
                const responseText = await response.text();
                let data = null;
                if (responseText) {
                    try {
                        data = JSON.parse(responseText);
                    } catch (parseError) {
                        console.error("Failed to parse supplier response", parseError, responseText);
                    }
                }
                if (!response.ok) {
                    const fieldErrors = data?.errors || {};
                    supplierServerErrors = { ...fieldErrors };
                    Object.keys(fieldErrors).forEach((field) => {
                        supplierTouchedFields.add(field);
                    });
                    evaluateSupplierForm({ force: true });
                    const nonFieldMessage = Object.keys(fieldErrors).length === 0 ? "Unable to save supplier." : "";
                    if (nonFieldMessage) {
                        setModalError(nonFieldMessage);
                    } else if (fieldErrors.supplier_reg_no) {
                        setModalError(fieldErrors.supplier_reg_no);
                    }
                    return;
                }
                let supplierRecord =
                    data && typeof data === "object" && !Array.isArray(data) ? data : null;
                if (!supplierRecord) {
                    try {
                        const nameToFind = (values.name || "").trim().toLowerCase();
                        if (nameToFind) {
                            const matches = await loadSuppliers(values.name || "");
                            supplierRecord = matches.find((supplier) => {
                                const supplierName = (supplier.name || "").trim().toLowerCase();
                                return supplierName === nameToFind;
                            }) || null;
                        }
                    } catch (loadError) {
                        console.error("Supplier created but lookup failed", loadError);
                    }
                }
                if (!supplierRecord) {
                    setModalError(
                        "Supplier was saved but we couldn't load it. Please refresh the page to continue.",
                    );
                    return;
                }
                supplierInput.value = supplierRecord.name || values.name;
                supplierIdInput.value = supplierRecord.id || "";
                supplierNameFreeInput.value = "";
                fetchSuppliers(supplierRecord.name || "");
                closeSupplierModal();
            } catch (error) {
                setModalError("Network error. Please try again.");
            } finally {
                evaluateSupplierForm();
            }
        });

        function openItemModal() {
            itemModal.classList.add("active");
            setItemModalError("");
            itemModalForm.reset();
            document.querySelector("[data-error-for='modal_item_name']").textContent = "";
            itemModal.querySelector("#item-name").focus();
        }

        function closeItemModal() {
            itemModal.classList.remove("active");
        }

        itemModalClose.addEventListener("click", closeItemModal);
        itemModalCancel.addEventListener("click", closeItemModal);

        itemModal.addEventListener("click", (event) => {
            if (event.target === itemModal) {
                closeItemModal();
            }
        });

        itemModalForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            setItemModalError("");
            document.querySelector("[data-error-for='modal_item_name']").textContent = "";

            const formData = new FormData(itemModalForm);
            const payload = Object.fromEntries(formData.entries());
            payload.name = (payload.name || "").trim();
            if (!payload.name) {
                document.querySelector("[data-error-for='modal_item_name']").textContent = "Item name is required.";
                return;
            }

            const saveButton = itemModalForm.querySelector("#save-item");
            saveButton.disabled = true;
            try {
                const response = await fetch("/api/material/items", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                });
                const data = await response.json();
                if (!response.ok) {
                    const message = data?.errors?.name || "Unable to save item.";
                    setItemModalError(message);
                    return;
                }

                const option = document.createElement("option");
                option.value = data.id;
                option.textContent = data.name;
                itemSelect.appendChild(option);
                itemSelect.value = data.id;
                lastValidItemValue = data.id;
                closeItemModal();
            } catch (error) {
                setItemModalError("Network error. Please try again.");
            } finally {
                saveButton.disabled = false;
            }
        });

        if (itemSelect) {
            itemSelect.selectedIndex = -1;
            itemSelect.addEventListener("change", (event) => {
                const value = event.target.value;
                if (value === "__create__") {
                    if (lastValidItemValue) {
                        event.target.value = lastValidItemValue;
                    } else {
                        event.target.selectedIndex = -1;
                    }
                    openItemModal();
                    return;
                }
                lastValidItemValue = value;
            });
        }

        resetBtn.addEventListener("click", () => {
            mrnForm.reset();
            supplierInput.value = "";
            supplierIdInput.value = "";
            supplierNameFreeInput.value = "";
            approvedUnitPriceInput.value = "0.00";
            amountInput.value = "0.00";
            if (weighInWeightInput) {
                weighInWeightInput.value = "";
            }
            if (weighOutWeightInput) {
                weighOutWeightInput.value = "";
            }
            if (qtyInput) {
                qtyInput.value = "";
            }
            if (itemSelect) {
                itemSelect.selectedIndex = -1;
            }
            lastValidItemValue = "";
            clearErrors();
            updateQuantityFromWeights();
        });

        function validateForm() {
            const errors = {};
            const formData = new FormData(mrnForm);
            const qtyValue = parseFloat(formData.get("qty_ton"));
            const unitValue = parseFloat(formData.get("unit_price"));
            const wetValue = parseFloat(formData.get("wet_factor"));
            const weighInWeightValue = parseFloat(formData.get("weigh_in_weight_kg"));
            const weighOutWeightValue = parseFloat(formData.get("weigh_out_weight_kg"));

            ["date", "mrn_no", "weighing_slip_no", "weigh_in_time", "weigh_out_time", "security_officer_name", "authorized_person_name", "item_id"].forEach((field) => {
                if (!(formData.get(field) || "").trim()) {
                    errors[field] = "This field is required.";
                }
            });

            ["weigh_in_weight_kg", "weigh_out_weight_kg"].forEach((field) => {
                const raw = formData.get(field);
                if ((raw || "").trim() === "") {
                    errors[field] = "This field is required.";
                }
            });

            if ((formData.get("item_id") || "") === "__create__") {
                errors["item_id"] = "Select an item.";
            }

            if (!supplierIdInput.value && !(supplierNameFreeInput.value || "").trim()) {
                errors["supplier_id"] = "Select a supplier or enter a name.";
            }

            if (!Number.isFinite(weighInWeightValue) || weighInWeightValue < 0) {
                errors["weigh_in_weight_kg"] = "Enter a valid non-negative weight.";
            }
            if (!Number.isFinite(weighOutWeightValue) || weighOutWeightValue < 0) {
                errors["weigh_out_weight_kg"] = "Enter a valid non-negative weight.";
            }
            if (
                Number.isFinite(weighInWeightValue) &&
                Number.isFinite(weighOutWeightValue) &&
                weighOutWeightValue <= weighInWeightValue
            ) {
                errors["weigh_out_weight_kg"] = "Out weight must be greater than in weight.";
            }

            if (Number.isNaN(qtyValue) || qtyValue <= 0) {
                errors["qty_ton"] = "Quantity must be greater than 0.";
            }
            if (Number.isNaN(unitValue) || unitValue < 0) {
                errors["unit_price"] = "Unit price must be zero or greater.";
            }
            if (wetValue < 0 || Number.isNaN(wetValue)) {
                errors["wet_factor"] = "Wet factor must be zero or greater.";
            }

            const weighIn = formData.get("weigh_in_time");
            const weighOut = formData.get("weigh_out_time");
            if (weighIn && weighOut) {
                const inDate = new Date(weighIn);
                const outDate = new Date(weighOut);
                if (inDate > outDate) {
                    errors["weigh_out_time"] = "Out-time must be after in-time.";
                }
            }

            return errors;
        }

        mrnForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            clearErrors();
            submitBtn.disabled = true;

            const errors = validateForm();
            if (Object.keys(errors).length > 0) {
                Object.entries(errors).forEach(([field, message]) => setError(field, message));
                submitBtn.disabled = false;
                return;
            }

            const formData = new FormData(mrnForm);
            const payload = Object.fromEntries(formData.entries());
            const weighInWeightValue = parseFloat(payload.weigh_in_weight_kg);
            const weighOutWeightValue = parseFloat(payload.weigh_out_weight_kg);
            const qtyTonValue = parseFloat(payload.qty_ton);
            payload.weigh_in_weight_kg = Number.isNaN(weighInWeightValue) ? undefined : weighInWeightValue;
            payload.weigh_out_weight_kg = Number.isNaN(weighOutWeightValue) ? undefined : weighOutWeightValue;
            payload.qty_ton = Number.isNaN(qtyTonValue) ? undefined : qtyTonValue;
            payload.unit_price = parseFloat(payload.unit_price);
            payload.wet_factor = payload.wet_factor ? parseFloat(payload.wet_factor) : 1;
            payload.weigh_in_time = new Date(payload.weigh_in_time).toISOString();
            payload.weigh_out_time = new Date(payload.weigh_out_time).toISOString();
            payload.supplier_id = supplierIdInput.value || undefined;
            payload.supplier_name_free = (supplierNameFreeInput.value || "").trim() || undefined;
            if (payload.item_id === "__create__") {
                payload.item_id = undefined;
            }

            try {
                const response = await fetch("/api/material/mrn", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                });
                const data = await response.json();
                if (!response.ok) {
                    const serverErrors = data?.errors || {};
                    Object.entries(serverErrors).forEach(([field, message]) => setError(field, message));
                    if (Object.keys(serverErrors).length === 0) {
                        formAlert.style.display = "block";
                        formAlert.textContent = "Unable to save MRN. Please review your inputs.";
                    }
                    return;
                }
                window.location.href = `/material/mrn/${data.id}`;
            } catch (error) {
                formAlert.style.display = "block";
                formAlert.textContent = "Network error. Please try again.";
            } finally {
                submitBtn.disabled = false;
            }
        });

    </script>
</body>
</html>
