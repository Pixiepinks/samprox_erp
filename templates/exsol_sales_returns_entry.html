{% extends "sales_base.html" %}
{% set active_tab = "data-entry" %}
{% block page_title %}Record Sales Return (Exsol) | SAMPROX ERP{% endblock %}
{% block content %}
<section class="section">
    <header class="section__header">
        <div>
            <p class="eyebrow">Exsol Engineering</p>
            <h1>Record Sales Return</h1>
            <p class="section__description">
                Capture returned water pumps against invoices and update stock automatically.
            </p>
        </div>
    </header>

    <div class="card">
        <form id="sales-return-form">
            <div class="form-grid">
                <label class="form-field form-field--wide">
                    <span>Invoice</span>
                    <input
                        type="text"
                        id="return-invoice-search"
                        name="return-invoice-search"
                        list="return-invoice-options"
                        placeholder="Search invoice no or customer"
                        autocomplete="off"
                        required
                    />
                    <input type="hidden" id="return-invoice-id" name="return-invoice-id" />
                    <datalist id="return-invoice-options"></datalist>
                </label>
                <label class="form-field">
                    <span>Return date</span>
                    <input type="date" id="return-date" name="return-date" required />
                </label>
                <label class="form-field form-field--wide">
                    <span>Reason</span>
                    <input type="text" id="return-reason" name="return-reason" placeholder="Optional reason" />
                </label>
            </div>

            <div class="return-summary" id="return-summary" hidden>
                <div>
                    <span>Invoice No</span>
                    <strong id="summary-invoice-no">-</strong>
                </div>
                <div>
                    <span>Invoice Date</span>
                    <strong id="summary-invoice-date">-</strong>
                </div>
                <div>
                    <span>Customer</span>
                    <strong id="summary-customer">-</strong>
                </div>
            </div>

            <p class="empty-state" id="return-empty">Select an invoice to view returnable lines.</p>
            <div class="table-wrapper" id="return-lines-wrapper" hidden>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Item Code</th>
                            <th>Item Name</th>
                            <th>Qty Sold</th>
                            <th>Return Qty</th>
                            <th>Serialized</th>
                            <th>Select Serials</th>
                        </tr>
                    </thead>
                    <tbody id="return-lines-body"></tbody>
                </table>
            </div>

            <div class="alert" id="return-error" hidden></div>
            <div class="alert alert--success" id="return-success" hidden></div>

            <div class="card__actions">
                <button type="submit" class="button button--primary" id="submit-return">Submit Return</button>
                <button type="button" class="button button--ghost" id="reset-return">Reset</button>
            </div>
        </form>
    </div>
</section>

<div class="modal modal--app" id="serial-modal" hidden aria-hidden="true">
    <div class="modal__overlay" data-serial-close></div>
    <div class="modal__content" role="dialog" aria-modal="true" aria-labelledby="serial-modal-title">
        <header class="modal__header modal__header--with-actions">
            <div>
                <h2 class="modal__title" id="serial-modal-title">Select Serials</h2>
                <p class="modal__subtitle">Only serials sold on this invoice are eligible.</p>
            </div>
            <button type="button" class="modal__close" data-serial-close aria-label="Close serial selection">
                &times;
            </button>
        </header>
        <div class="modal__body serial-modal__body">
            <div class="serial-modal__toolbar">
                <label class="serial-modal__search">
                    <span class="sr-only">Search serials</span>
                    <input type="search" id="serial-search" placeholder="Search serial number" />
                </label>
                <div class="serial-modal__buttons">
                    <button type="button" class="button button--ghost button--small" id="serial-select-all">
                        Select All
                    </button>
                    <button type="button" class="button button--ghost button--small" id="serial-clear">
                        Clear
                    </button>
                </div>
            </div>
            <div class="table-wrapper modal-table">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Select</th>
                            <th>Serial No</th>
                            <th>Condition</th>
                            <th>Restock Status</th>
                        </tr>
                    </thead>
                    <tbody id="serial-modal-body"></tbody>
                </table>
            </div>
            <p class="modal__hint" id="serial-modal-empty" hidden>No returnable serials found.</p>
            <div class="modal__actions">
                <button type="button" class="button button--ghost" data-serial-close>Cancel</button>
                <button type="button" class="button button--primary" id="serial-apply">Confirm</button>
            </div>
        </div>
    </div>
</div>

<style>
    .return-summary {
        margin-top: 1.5rem;
        padding: 1rem;
        border-radius: 0.75rem;
        background: #f8fafc;
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        font-weight: 600;
        color: #0f172a;
    }

    .return-summary span {
        display: block;
        font-size: 0.75rem;
        text-transform: uppercase;
        color: #64748b;
        letter-spacing: 0.08em;
        margin-bottom: 0.25rem;
        font-weight: 700;
    }

    .table-wrapper {
        margin-top: 1.5rem;
    }

    .return-serials {
        display: inline-flex;
        flex-direction: column;
        gap: 0.35rem;
    }

    .return-serials__count {
        font-size: 0.85rem;
        color: #475569;
    }

    .return-line-error {
        font-size: 0.8rem;
        color: #b91c1c;
        font-weight: 600;
    }

    .toast-container {
        position: fixed;
        top: 1.5rem;
        right: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        z-index: 3000;
    }

    .toast {
        min-width: 240px;
        max-width: 360px;
        padding: 0.75rem 1rem;
        border-radius: 0.75rem;
        background: #fee2e2;
        color: #991b1b;
        box-shadow: 0 16px 30px rgba(15, 23, 42, 0.15);
        font-weight: 600;
    }

    .modal--app {
        position: fixed;
        inset: 0;
        overflow-y: auto;
        z-index: 2000;
    }

    .modal-table {
        max-height: 320px;
        overflow: auto;
    }

    .serial-modal__body {
        max-height: calc(100vh - 220px);
        overflow-y: auto;
    }

    .serial-modal__toolbar {
        display: flex;
        gap: 1rem;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .serial-modal__search input {
        min-width: 220px;
    }

    .serial-inputs select:disabled {
        opacity: 0.6;
    }
</style>

<script>
    (function () {
        const token = localStorage.getItem("samprox_token");
        const invoiceInput = document.getElementById("return-invoice-search");
        const invoiceOptions = document.getElementById("return-invoice-options");
        const invoiceIdInput = document.getElementById("return-invoice-id");
        const returnDateInput = document.getElementById("return-date");
        const reasonInput = document.getElementById("return-reason");
        const summaryCard = document.getElementById("return-summary");
        const summaryInvoiceNo = document.getElementById("summary-invoice-no");
        const summaryInvoiceDate = document.getElementById("summary-invoice-date");
        const summaryCustomer = document.getElementById("summary-customer");
        const linesWrapper = document.getElementById("return-lines-wrapper");
        const linesBody = document.getElementById("return-lines-body");
        const emptyState = document.getElementById("return-empty");
        const errorBox = document.getElementById("return-error");
        const successBox = document.getElementById("return-success");
        const resetButton = document.getElementById("reset-return");

        const modal = document.getElementById("serial-modal");
        const modalBody = document.getElementById("serial-modal-body");
        const modalEmpty = document.getElementById("serial-modal-empty");
        const modalTitle = document.getElementById("serial-modal-title");
        const modalApply = document.getElementById("serial-apply");
        const modalSearch = document.getElementById("serial-search");
        const modalSelectAll = document.getElementById("serial-select-all");
        const modalClear = document.getElementById("serial-clear");

        const toastContainer = document.createElement("div");
        toastContainer.className = "toast-container";
        document.body.appendChild(toastContainer);

        const invoiceLookupMap = new Map();
        const returnLines = new Map();
        let returnableData = null;
        let activeLineId = null;
        let activeSelection = new Map();
        let lookupTimer = null;

        const today = new Date();
        returnDateInput.value = today.toISOString().split("T")[0];

        const fetchJson = async (url, options = {}) => {
            const response = await fetch(url, {
                ...options,
                credentials: "include",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: token ? `Bearer ${token}` : "",
                    ...(options.headers || {}),
                },
            });
            if (!response.ok) {
                let errorPayload = {};
                try {
                    errorPayload = await response.json();
                } catch (err) {
                    errorPayload = { error: response.statusText };
                }
                const message = errorPayload.error || errorPayload.msg || "Request failed.";
                throw new Error(message);
            }
            return response.json();
        };

        const setFeedback = (box, message) => {
            if (!box) return;
            if (message) {
                box.textContent = message;
                box.hidden = false;
            } else {
                box.textContent = "";
                box.hidden = true;
            }
        };

        const showToast = (message) => {
            if (!message) return;
            const toast = document.createElement("div");
            toast.className = "toast";
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 5000);
        };

        const resetForm = () => {
            invoiceInput.value = "";
            invoiceIdInput.value = "";
            reasonInput.value = "";
            summaryCard.hidden = true;
            summaryInvoiceNo.textContent = "-";
            summaryInvoiceDate.textContent = "-";
            summaryCustomer.textContent = "-";
            linesBody.innerHTML = "";
            linesWrapper.hidden = true;
            emptyState.textContent = "Select an invoice to view returnable lines.";
            emptyState.hidden = false;
            returnLines.clear();
            returnableData = null;
            setFeedback(errorBox, "");
            setFeedback(successBox, "");
        };

        const renderInvoiceOptions = (items) => {
            invoiceOptions.innerHTML = "";
            invoiceLookupMap.clear();
            items.forEach((item) => {
                const label = `${item.invoice_no} • ${item.customer_name}`;
                invoiceLookupMap.set(label, item);
                const option = document.createElement("option");
                option.value = label;
                invoiceOptions.appendChild(option);
            });
        };

        const lookupInvoices = async (query) => {
            if (!query) {
                renderInvoiceOptions([]);
                return;
            }
            const response = await fetchJson(`/api/exsol/sales/invoices/lookup?q=${encodeURIComponent(query)}`);
            renderInvoiceOptions(response || []);
        };

        const renderLines = (payload) => {
            linesBody.innerHTML = "";
            returnLines.clear();
            if (!payload?.lines?.length) {
                linesWrapper.hidden = true;
                emptyState.textContent = "No returnable lines available.";
                emptyState.hidden = false;
                return;
            }
            emptyState.hidden = true;
            linesWrapper.hidden = false;

            payload.lines.forEach((line, index) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${line.item_code}</td>
                    <td>${line.item_name}</td>
                    <td>${line.qty_sold}</td>
                    <td>
                        <input type="number" min="0" class="return-qty" data-line-id="${line.line_id}" />
                    </td>
                    <td>${line.is_serialized ? "Yes" : "No"}</td>
                    <td>
                        <div class="return-serials">
                            <button
                                type="button"
                                class="button button--ghost button--small select-serials-link"
                                data-action="select-serials"
                                data-line-id="${line.line_id}"
                                data-item-code="${line.item_code}"
                                data-row-index="${index + 1}"
                                ${line.is_serialized ? "" : "disabled"}
                            >
                                Select Serials
                            </button>
                            <span class="return-serials__count" data-serial-count="${line.line_id}">
                                Selected: 0
                            </span>
                            <span class="return-line-error" data-line-error="${line.line_id}" hidden></span>
                        </div>
                    </td>
                `;
                linesBody.appendChild(row);

                const qtyInput = row.querySelector(".return-qty");
                const serialCount = row.querySelector(`[data-serial-count="${line.line_id}"]`);
                const availableSerials = (line.sold_serials || []).filter(
                    (serial) => !(line.already_returned_serials || []).includes(serial)
                );
                const lineError = row.querySelector(`[data-line-error="${line.line_id}"]`);
                qtyInput.addEventListener("input", () => validateLine(line.line_id));

                returnLines.set(line.line_id, {
                    line,
                    qtyInput,
                    serialCount,
                    lineError,
                    availableSerials,
                    selectedSerials: new Map(),
                });
            });
        };

        const loadReturnable = async (invoiceId) => {
            if (!invoiceId) {
                resetForm();
                return;
            }
            setFeedback(errorBox, "");
            setFeedback(successBox, "");
            linesBody.innerHTML = "";
            emptyState.textContent = "Loading invoice details...";
            emptyState.hidden = false;
            linesWrapper.hidden = true;

            const payload = await fetchJson(`/api/exsol/sales/invoices/${invoiceId}/returnable`);
            returnableData = payload;
            window.returnableData = payload;
            summaryInvoiceNo.textContent = payload.invoice.invoice_no || "-";
            summaryInvoiceDate.textContent = payload.invoice.invoice_date || "-";
            summaryCustomer.textContent = payload.invoice.customer_name || "-";
            summaryCard.hidden = false;
            renderLines(payload);
        };

        const renderModalRows = (lineEntry, serials) => {
            const query = modalSearch.value.trim().toLowerCase();
            const filteredSerials = serials.filter((serial) => serial.toLowerCase().includes(query));

            modalBody.innerHTML = "";
            modalEmpty.hidden = filteredSerials.length > 0;

            filteredSerials.forEach((serial) => {
                const existing = activeSelection.get(serial);
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="serial-select" data-serial="${serial}" ${
                            existing ? "checked" : ""
                        } />
                    </td>
                    <td>${serial}</td>
                    <td class="serial-inputs">
                        <select class="serial-condition" ${existing ? "" : "disabled"}>
                            <option value="GOOD" ${existing?.condition === "GOOD" ? "selected" : ""}>GOOD</option>
                            <option value="DAMAGED" ${existing?.condition === "DAMAGED" ? "selected" : ""}>DAMAGED</option>
                        </select>
                    </td>
                    <td class="serial-inputs">
                        <select class="serial-restock" ${existing ? "" : "disabled"}>
                            <option value="STORED" ${existing?.restock_status === "STORED" ? "selected" : ""}>
                                STORED
                            </option>
                            <option value="SERVICE" ${existing?.restock_status === "SERVICE" ? "selected" : ""}>
                                SERVICE
                            </option>
                            <option value="SCRAP" ${existing?.restock_status === "SCRAP" ? "selected" : ""}>SCRAP</option>
                        </select>
                    </td>
                `;
                modalBody.appendChild(row);
                const checkbox = row.querySelector(".serial-select");
                const conditionSelect = row.querySelector(".serial-condition");
                const restockSelect = row.querySelector(".serial-restock");

                const syncSelection = () => {
                    if (checkbox.checked) {
                        activeSelection.set(serial, {
                            serial_number: serial,
                            condition: conditionSelect.value,
                            restock_status: restockSelect.value,
                        });
                    } else {
                        activeSelection.delete(serial);
                    }
                };

                checkbox.addEventListener("change", () => {
                    const enabled = checkbox.checked;
                    conditionSelect.disabled = !enabled;
                    restockSelect.disabled = !enabled;
                    syncSelection();
                });

                conditionSelect.addEventListener("change", syncSelection);
                restockSelect.addEventListener("change", syncSelection);
            });
        };

        const openModal = (lineId, context = {}) => {
            const lineEntry = returnLines.get(lineId);
            if (!lineEntry) return;
            activeLineId = lineId;
            activeSelection = new Map(lineEntry.selectedSerials);

            modalBody.innerHTML = "";
            const invoiceLabel = context.invoiceNo ? ` • Invoice ${context.invoiceNo}` : "";
            const lineLabel = context.rowIndex ? `Line ${context.rowIndex}` : "Line";
            const itemCodeLabel = context.itemCode || lineEntry.line.item_code;
            modalTitle.textContent = `Select Serials (${lineLabel}: ${itemCodeLabel}${invoiceLabel})`;
            modalEmpty.textContent = "Loading serials...";
            modalEmpty.hidden = false;
            modalSearch.value = "";

            modal.hidden = false;
            modal.setAttribute("aria-hidden", "false");
            document.body.classList.add("modal-open");

            if (!returnableData?.lines?.length) {
                modalEmpty.textContent = "Select an invoice to load serials.";
                return;
            }

            const updatedLine =
                returnableData.lines.find((line) => String(line.line_id) === String(lineId)) ||
                returnableData.lines.find((line) => line.item_code === context.itemCode);

            if (!updatedLine) {
                modalBody.innerHTML = "";
                modalEmpty.textContent = "Unable to locate serials for this line.";
                modalEmpty.hidden = false;
                return;
            }

            const available = (updatedLine.sold_serials || []).filter(
                (serial) => !(updatedLine.already_returned_serials || []).includes(serial)
            );
            lineEntry.availableSerials = available;
            modalEmpty.textContent = "No serials available for this line.";
            renderModalRows(lineEntry, available);
        };

        const closeModal = () => {
            modal.hidden = true;
            modal.setAttribute("aria-hidden", "true");
            document.body.classList.remove("modal-open");
            activeLineId = null;
            activeSelection = new Map();
        };

        const applySerialSelection = () => {
            if (!activeLineId) {
                closeModal();
                return;
            }
            const lineEntry = returnLines.get(activeLineId);
            if (!lineEntry) {
                closeModal();
                return;
            }
            lineEntry.selectedSerials = new Map(activeSelection);
            lineEntry.serialCount.textContent = `Selected: ${activeSelection.size}`;
            if (!lineEntry.qtyInput.value || Number(lineEntry.qtyInput.value) === 0) {
                lineEntry.qtyInput.value = activeSelection.size;
            }
            validateLine(activeLineId);
            closeModal();
        };

        const validateLine = (lineId) => {
            const entry = returnLines.get(lineId);
            if (!entry || !entry.lineError) return;
            const qty = Number(entry.qtyInput.value || 0);
            let message = "";
            if (entry.line.is_serialized && qty > 0 && entry.selectedSerials.size !== qty) {
                message = "Selected serial count must match return qty.";
            }
            if (message) {
                entry.lineError.textContent = message;
                entry.lineError.hidden = false;
            } else {
                entry.lineError.textContent = "";
                entry.lineError.hidden = true;
            }
        };

        const handleSubmit = async (event) => {
            event.preventDefault();
            setFeedback(errorBox, "");
            setFeedback(successBox, "");

            const invoiceId = invoiceIdInput.value;
            if (!invoiceId) {
                setFeedback(errorBox, "Please select a valid invoice.");
                return;
            }

            const lines = [];
            const errors = [];

            returnLines.forEach((entry, lineId) => {
                const qty = Number(entry.qtyInput.value || 0);
                if (!qty || qty <= 0) {
                    validateLine(lineId);
                    return;
                }
                if (entry.line.is_serialized) {
                    if (entry.selectedSerials.size !== qty) {
                        errors.push(`Line ${entry.line.item_code}: selected serial count must match return qty.`);
                    }
                }
                validateLine(lineId);
                lines.push({
                    line_id: lineId,
                    item_code: entry.line.item_code,
                    item_name: entry.line.item_name,
                    qty,
                    is_serialized: entry.line.is_serialized,
                    serials: Array.from(entry.selectedSerials.values()),
                });
            });

            if (!lines.length) {
                setFeedback(errorBox, "Enter at least one return quantity.");
                return;
            }
            if (errors.length) {
                setFeedback(errorBox, errors.join(" "));
                return;
            }

            const payload = {
                invoice_id: invoiceId,
                return_date: returnDateInput.value,
                reason: reasonInput.value,
                lines,
            };

            try {
                const response = await fetchJson("/api/exsol/sales/returns", {
                    method: "POST",
                    body: JSON.stringify(payload),
                });
                setFeedback(successBox, `Return ${response.return_no} recorded successfully.`);
                resetForm();
            } catch (err) {
                setFeedback(errorBox, err.message || "Unable to submit return.");
            }
        };

        if (modal.parentElement !== document.body) {
            document.body.appendChild(modal);
        }

        invoiceInput.addEventListener("input", () => {
            const value = invoiceInput.value.trim();
            clearTimeout(lookupTimer);
            lookupTimer = setTimeout(() => {
                lookupInvoices(value).catch((err) => setFeedback(errorBox, err.message));
            }, 300);
        });

        invoiceInput.addEventListener("change", () => {
            const selected = invoiceLookupMap.get(invoiceInput.value.trim());
            if (!selected) {
                invoiceIdInput.value = "";
                setFeedback(errorBox, "Select an invoice from the list.");
                return;
            }
            invoiceIdInput.value = selected.id;
            loadReturnable(selected.id).catch((err) => {
                const message = err?.message || "Unable to load returnable invoice data.";
                setFeedback(errorBox, message);
                showToast(message);
                console.error("Unable to load returnable invoice data", err);
            });
        });

        document.addEventListener("click", (event) => {
            const trigger = event.target.closest(".select-serials-link");
            if (!trigger) return;
            event.preventDefault();
            event.stopPropagation();
            const lineId = trigger.dataset.lineId;
            if (!lineId) return;
            const invoiceNo = summaryInvoiceNo.textContent?.trim();
            const itemCode = trigger.dataset.itemCode || "";
            const rowIndex = trigger.dataset.rowIndex;
            openModal(lineId, { invoiceNo, itemCode, rowIndex });
        });

        modalSearch.addEventListener("input", () => {
            if (!activeLineId) return;
            const lineEntry = returnLines.get(activeLineId);
            if (!lineEntry) return;
            renderModalRows(lineEntry, lineEntry.availableSerials || []);
        });

        modalSelectAll.addEventListener("click", () => {
            modalBody.querySelectorAll(".serial-select").forEach((checkbox) => {
                if (checkbox.checked) return;
                checkbox.checked = true;
                checkbox.dispatchEvent(new Event("change"));
            });
        });

        modalClear.addEventListener("click", () => {
            modalBody.querySelectorAll(".serial-select").forEach((checkbox) => {
                if (!checkbox.checked) return;
                checkbox.checked = false;
                checkbox.dispatchEvent(new Event("change"));
            });
        });

        modalApply.addEventListener("click", applySerialSelection);
        modal.addEventListener("click", (event) => {
            if (event.target?.matches("[data-serial-close]")) {
                closeModal();
            }
        });

        document.getElementById("sales-return-form").addEventListener("submit", handleSubmit);
        resetButton.addEventListener("click", resetForm);
    })();
</script>
{% endblock %}
