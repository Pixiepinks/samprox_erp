<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manufacturing | SAMPROX ERP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" />
</head>
<body>
    <div class="page">
        <header class="topbar">
            <div class="brand">
                <div class="brand__logo">S</div>
                <div class="brand__details">
                    <p class="brand__name">SAMPROX ERP</p>
                    <p class="brand__section">Manufacturing Operations</p>
                </div>
            </div>
            <div class="topbar__actions">
                <a class="button button--ghost" href="{{ url_for('ui.mind_page') }}">Mind</a>
                <div class="user-summary">
                    <span class="user-summary__name" id="user-name"></span>
                    <span class="user-summary__role" id="user-role"></span>
                </div>
                <button type="button" class="button button--secondary" id="logout">Sign out</button>
            </div>
        </header>
        <nav class="subnav" aria-label="7M navigation">
            <a class="subnav__link" href="{{ url_for('ui.mind_page') }}">Mind</a>
            <a class="subnav__link" href="{{ url_for('ui.man_page') }}">Man</a>
            <a class="subnav__link" href="{{ url_for('ui.machines_page') }}">Machine</a>
            <a class="subnav__link" href="{{ url_for('ui.material_page') }}">Material</a>
            <a class="subnav__link" href="{{ url_for('ui.market_page') }}">Market</a>
            <a class="subnav__link subnav__link--active" href="{{ url_for('ui.manufacturing_page') }}">Manufacturing</a>
            <a class="subnav__link" href="{{ url_for('ui.money_page') }}">Money</a>
        </nav>
        <section class="section">
            <header class="section__header">
                <h1>Production flow coordination</h1>
            </header>
            <p class="section__description">
                Oversee the end-to-end production process, from work order release to final quality
                checks. Align capacity, resources, and schedules so every shift meets delivery
                commitments without sacrificing quality.
            </p>
            <div class="section__grid">
                <article class="tile">
                    <h2 class="tile__title">Work order control</h2>
                    <p class="tile__description">
                        Track live work orders, their routing steps, and current status to remove
                        bottlenecks before they impact throughput.
                    </p>
                </article>
                <article class="tile">
                    <h2 class="tile__title">Capacity planning</h2>
                    <p class="tile__description">
                        Balance machine availability and staffing across shifts to keep utilization high
                        while maintaining buffer for urgent jobs.
                    </p>
                </article>
                <article class="tile">
                    <h2 class="tile__title">Quality checkpoints</h2>
                    <p class="tile__description">
                        Coordinate in-process inspections, capture deviations, and escalate corrective
                        actions to protect outgoing quality.
                    </p>
                </article>
                <article class="tile">
                    <h2 class="tile__title">Production analytics</h2>
                    <p class="tile__description">
                        Analyze yield, cycle times, and first-pass success to drive continuous
                        improvement initiatives across lines.
                    </p>
                </article>
            </div>
            <div class="production-card" aria-live="polite">
                <header class="production-card__header">
                    <div>
                        <h2>Daily production sheet</h2>
                        <p>Capture hourly output in tons for each manufacturing asset.</p>
                    </div>
                    <div class="production-summary">
                        <span class="production-summary__label">Total (tons)</span>
                        <span class="production-summary__value" id="production-total">0.00</span>
                    </div>
                </header>
                <div class="production-card__body">
                    <div class="production-totals" aria-live="polite">
                        <div class="production-totals__row">
                            <span class="production-totals__title">Today</span>
                            <div class="production-totals__metrics">
                                <div class="production-totals__metric">
                                    <span class="production-totals__metric-label">Total MCH-0001 (tons)</span>
                                    <span
                                        class="production-totals__metric-value"
                                        id="production-today-mch-0001"
                                    >0.00</span>
                                </div>
                                <div class="production-totals__metric">
                                    <span class="production-totals__metric-label">Total MCH-0002 (tons)</span>
                                    <span
                                        class="production-totals__metric-value"
                                        id="production-today-mch-0002"
                                    >0.00</span>
                                </div>
                                <div class="production-totals__metric">
                                    <span class="production-totals__metric-label">Total (tons)</span>
                                    <span
                                        class="production-totals__metric-value"
                                        id="production-today-total"
                                    >0.00</span>
                                </div>
                            </div>
                        </div>
                        <div class="production-totals__row">
                            <span class="production-totals__title">Month to Date</span>
                            <div class="production-totals__metrics">
                                <div class="production-totals__metric">
                                    <span class="production-totals__metric-label">MTD MCH-0001 (tons)</span>
                                    <span
                                        class="production-totals__metric-value"
                                        id="production-mtd-mch-0001"
                                    >0.00</span>
                                </div>
                                <div class="production-totals__metric">
                                    <span class="production-totals__metric-label">MTD MCH-0002 (tons)</span>
                                    <span
                                        class="production-totals__metric-value"
                                        id="production-mtd-mch-0002"
                                    >0.00</span>
                                </div>
                                <div class="production-totals__metric">
                                    <span class="production-totals__metric-label">MTD Total (tons)</span>
                                    <span
                                        class="production-totals__metric-value"
                                        id="production-mtd-total"
                                    >0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <form class="production-form" id="production-form" novalidate>
                        <div class="production-form__grid">
                            <div class="production-input">
                                <label for="production-date">Date <span class="required">*</span></label>
                                <input id="production-date" name="date" type="date" required />
                            </div>
                            <div class="production-input">
                                <label for="production-machine">Machine ID <span class="required">*</span></label>
                                <select id="production-machine" name="machine_code" required>
                                    <option value="" disabled selected>Select machine</option>
                                </select>
                            </div>
                            <div class="production-input">
                                <label for="production-hour">Hour no. <span class="required">*</span></label>
                                <select id="production-hour" name="hour_no" required>
                                    {% for hour in range(1, 25) %}
                                    <option value="{{ hour }}">{{ "%02d" % hour }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="production-input">
                                <label for="production-qty">Production qty (tons) <span class="required">*</span></label>
                                <input
                                    id="production-qty"
                                    name="quantity_tons"
                                    type="number"
                                    min="0"
                                    step="0.01"
                                    placeholder="0.00"
                                    required
                                />
                            </div>
                        </div>
                        <div class="production-actions">
                            <button type="submit" class="button" id="production-submit">Save hour</button>
                        </div>
                        <p class="production-feedback production-feedback--success" id="production-success" hidden>
                            Production updated successfully.
                        </p>
                        <p class="production-feedback production-feedback--error" id="production-error" hidden></p>
                    </form>
                    <div class="production-table-wrapper">
                        <table class="production-table">
                            <thead>
                                <tr>
                                    <th scope="col">Hour</th>
                                    <th scope="col">MCH-0001 (tons)</th>
                                    <th scope="col">MCH-0002 (tons)</th>
                                    <th scope="col">Hour total (tons)</th>
                                    <th scope="col">Last updated</th>
                                </tr>
                            </thead>
                            <tbody id="production-table-body">
                                <tr id="production-empty-row">
                                    <td colspan="5" class="production-table__empty">
                                        No production records are available for this date.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </div>
    <script>
        const token = localStorage.getItem("samprox_token");
        const userRaw = localStorage.getItem("samprox_user");
        let user;

        try {
            user = userRaw ? JSON.parse(userRaw) : null;
        } catch (_) {
            user = null;
        }

        if (!token || !user) {
            window.location.href = "/";
        }

        const roleLabels = {
            admin: "Admin",
            production_manager: "Production Manager",
            maintenance_manager: "Maintenance Manager",
            technician: "Technician",
        };

        const userNameEl = document.getElementById("user-name");
        const userRoleEl = document.getElementById("user-role");
        const logoutButton = document.getElementById("logout");

        userNameEl.textContent = user?.name || "Unknown";
        userRoleEl.textContent = roleLabels[user?.role] || "";

        logoutButton.addEventListener("click", () => {
            localStorage.removeItem("samprox_token");
            localStorage.removeItem("samprox_user");
            window.location.href = "/";
        });

        const machineSelect = document.getElementById("production-machine");
        const dateInput = document.getElementById("production-date");
        const hourSelect = document.getElementById("production-hour");
        const quantityInput = document.getElementById("production-qty");
        const productionForm = document.getElementById("production-form");
        const productionSuccess = document.getElementById("production-success");
        const productionError = document.getElementById("production-error");
        const productionTableBody = document.getElementById("production-table-body");
        const productionEmptyRow = document.getElementById("production-empty-row");
        const productionTotal = document.getElementById("production-total");
        const productionSubmit = document.getElementById("production-submit");

        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, "0");
        const dd = String(today.getDate()).padStart(2, "0");
        dateInput.value = `${yyyy}-${mm}-${dd}`;

        const authHeaders = {
            Authorization: `Bearer ${token}`,
        };

        function showMessage(element, message = "") {
            if (!element) return;
            if (message) {
                element.textContent = message;
                element.hidden = false;
            } else {
                element.hidden = true;
            }
        }

        function clearFeedback() {
            showMessage(productionSuccess);
            showMessage(productionError);
        }

        function setFormDisabled(disabled) {
            productionSubmit.disabled = disabled;
            dateInput.disabled = disabled;
            machineSelect.disabled = disabled;
            hourSelect.disabled = disabled;
            quantityInput.disabled = disabled;
        }

        const SUMMARY_MACHINE_CODES = ["MCH-0001", "MCH-0002"];
        const totalsTodayTotal = document.getElementById("production-today-total");
        const totalsMtdTotal = document.getElementById("production-mtd-total");
        const totalsTodayMachineElements = {};
        const totalsMtdMachineElements = {};

        SUMMARY_MACHINE_CODES.forEach((code) => {
            const normalized = code.toLowerCase();
            totalsTodayMachineElements[code] = document.getElementById(
                `production-today-${normalized}`,
            );
            totalsMtdMachineElements[code] = document.getElementById(
                `production-mtd-${normalized}`,
            );
        });

        let latestSummary = null;

        function formatQuantity(value) {
            const number = Number(value);
            return Number.isFinite(number) ? number.toFixed(2) : "0.00";
        }

        function updateTotalElement(element, value) {
            if (!element) return;
            const number = Number(value ?? 0);
            element.textContent = formatQuantity(number);
        }

        function renderTotals(data) {
            const totals = data?.totals || {};
            const todayTotals = totals.today || {};
            const mtdTotals = totals.mtd || {};
            const todayMachines = todayTotals.machines || {};
            const mtdMachines = mtdTotals.machines || {};

            SUMMARY_MACHINE_CODES.forEach((code) => {
                updateTotalElement(
                    totalsTodayMachineElements[code],
                    todayMachines[code],
                );
                updateTotalElement(
                    totalsMtdMachineElements[code],
                    mtdMachines[code],
                );
            });

            const fallbackTodayTotal =
                todayTotals.total ?? data?.total_quantity_tons ?? 0;
            updateTotalElement(totalsTodayTotal, fallbackTodayTotal);
            updateTotalElement(totalsMtdTotal, mtdTotals.total);
        }

        function renderSummary(data) {
            productionTableBody.innerHTML = "";
            productionEmptyRow.hidden = true;
            const emptyCell = productionEmptyRow.querySelector("td");
            if (emptyCell) {
                emptyCell.textContent = "No production records are available for this date.";
            }

            const hoursMap = new Map();
            if (data && Array.isArray(data.hours)) {
                data.hours.forEach((hour) => {
                    const hourNumber = Number(hour?.hour_no);
                    if (Number.isFinite(hourNumber)) {
                        hoursMap.set(hourNumber, hour);
                    }
                });
            }

            for (let hour = 1; hour <= 24; hour += 1) {
                const hourData = hoursMap.get(hour) || {};
                const machinesMap = hourData.machines || {};

                const tr = document.createElement("tr");
                tr.dataset.hour = String(hour);

                const hourCell = document.createElement("th");
                hourCell.scope = "row";
                hourCell.textContent = String(hour).padStart(2, "0");
                tr.appendChild(hourCell);

                SUMMARY_MACHINE_CODES.forEach((code) => {
                    const machineCell = document.createElement("td");
                    machineCell.dataset.machineCode = code;
                    const machineData = machinesMap[code];
                    const quantity = Number(machineData?.quantity_tons ?? 0);
                    machineCell.textContent = formatQuantity(quantity);
                    machineCell.dataset.quantity = Number.isFinite(quantity) ? quantity : 0;
                    tr.appendChild(machineCell);
                });

                const totalCell = document.createElement("td");
                const hourTotal = Number(hourData.hour_total_tons ?? 0);
                totalCell.textContent = formatQuantity(hourTotal);
                tr.appendChild(totalCell);

                const updatedCell = document.createElement("td");
                const updatedValue = hourData.last_updated;
                if (updatedValue) {
                    const updatedDate = new Date(updatedValue);
                    if (!Number.isNaN(updatedDate.valueOf())) {
                        updatedCell.textContent = updatedDate.toLocaleString(undefined, {
                            hour: "2-digit",
                            minute: "2-digit",
                        });
                    } else {
                        updatedCell.textContent = "—";
                    }
                } else {
                    updatedCell.textContent = "—";
                }
                tr.appendChild(updatedCell);

                productionTableBody.appendChild(tr);
            }

            const total = Number(
                data?.totals?.today?.total ?? data?.total_quantity_tons ?? 0,
            );
            productionTotal.textContent = formatQuantity(total);
            renderTotals(data);
        }

        function updateQuantityFieldFromSummary() {
            const machineCode = machineSelect.value;
            const hourValue = Number(hourSelect.value);

            if (!machineCode || !Number.isFinite(hourValue)) {
                quantityInput.value = "";
                return;
            }

            if (!latestSummary || !Array.isArray(latestSummary.hours)) {
                quantityInput.value = formatQuantity(0);
                return;
            }

            const hourData = latestSummary.hours.find(
                (hour) => Number(hour?.hour_no) === hourValue,
            );
            const machineData = hourData?.machines?.[machineCode];
            const quantity = Number(machineData?.quantity_tons ?? 0);
            quantityInput.value = formatQuantity(quantity);
        }

        async function loadProductionSummary() {
            showMessage(productionError);

            const params = new URLSearchParams();
            if (dateInput.value) {
                params.set("date", dateInput.value);
            }
            if (SUMMARY_MACHINE_CODES.length > 0) {
                params.set("machine_codes", SUMMARY_MACHINE_CODES.join(","));
            }

            try {
                const response = await fetch(`/api/production/daily/summary?${params.toString()}`, {
                    headers: authHeaders,
                });
                if (response.status === 401) {
                    logoutButton.click();
                    return;
                }
                if (!response.ok) {
                    throw new Error("Failed to load production summary.");
                }

                const data = await response.json();
                latestSummary = data;
                renderSummary(data);
                updateQuantityFieldFromSummary();
            } catch (error) {
                latestSummary = null;
                productionTotal.textContent = "0.00";
                productionTableBody.innerHTML = "";
                productionEmptyRow.hidden = false;
                const emptyCell = productionEmptyRow.querySelector("td");
                if (emptyCell) {
                    emptyCell.textContent = "Unable to load production summary.";
                }
                productionTableBody.appendChild(productionEmptyRow);
                renderTotals(null);
                showMessage(
                    productionError,
                    error.message || "Unable to load production summary.",
                );
            }
        }

        async function fetchMachines() {
            try {
                const response = await fetch("/api/machines/assets", { headers: authHeaders });
                if (response.status === 401) {
                    logoutButton.click();
                    return;
                }
                if (!response.ok) {
                    throw new Error("Failed to load machines");
                }

                const machines = await response.json();
                machineSelect.innerHTML = "";
                if (!Array.isArray(machines) || machines.length === 0) {
                    const option = document.createElement("option");
                    option.textContent = "No machines available";
                    option.value = "";
                    machineSelect.appendChild(option);
                    machineSelect.disabled = true;
                } else {
                    machines.forEach((machine, index) => {
                        const option = document.createElement("option");
                        option.value = machine.code;
                        option.textContent = `${machine.code} — ${machine.name}`;
                        if (index === 0) {
                            option.selected = true;
                        }
                        machineSelect.appendChild(option);
                    });
                    machineSelect.disabled = false;
                }

                await loadProductionSummary();
            } catch (error) {
                renderTotals(null);
                showMessage(productionError, error.message || "Unable to load machines");
            }
        }

        productionForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            clearFeedback();

            const machineCode = machineSelect.value;
            const dateValue = dateInput.value;
            const hourValue = hourSelect.value;
            const quantityValue = quantityInput.value;

            if (!machineCode || !dateValue || !hourValue) {
                showMessage(productionError, "Please complete all required fields.");
                return;
            }

            setFormDisabled(true);

            try {
                const response = await fetch("/api/production/daily", {
                    method: "POST",
                    headers: {
                        ...authHeaders,
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        machine_code: machineCode,
                        date: dateValue,
                        hour_no: Number(hourValue),
                        quantity_tons: quantityValue ? Number(quantityValue) : 0,
                    }),
                });

                if (response.status === 401) {
                    logoutButton.click();
                    return;
                }

                const payload = await response.json().catch(() => ({}));

                if (!response.ok) {
                    const message = payload?.msg || "Unable to save production.";
                    showMessage(productionError, message);
                    return;
                }

                showMessage(productionSuccess, "Production updated successfully.");
                await loadProductionSummary();
            } catch (error) {
                showMessage(productionError, error.message || "Unable to save production.");
            } finally {
                setFormDisabled(false);
            }
        });

        machineSelect.addEventListener("change", () => {
            clearFeedback();
            updateQuantityFieldFromSummary();
        });

        hourSelect.addEventListener("change", () => {
            clearFeedback();
            updateQuantityFieldFromSummary();
        });

        dateInput.addEventListener("change", () => {
            clearFeedback();
            loadProductionSummary();
        });

        productionTableBody.addEventListener("click", (event) => {
            const machineCell = event.target.closest("td[data-machine-code]");
            if (machineCell) {
                const row = machineCell.closest("tr[data-hour]");
                if (row?.dataset.hour) {
                    hourSelect.value = String(Number(row.dataset.hour));
                }

                const machineCode = machineCell.dataset.machineCode;
                const option = Array.from(machineSelect.options).find(
                    (opt) => opt.value === machineCode,
                );
                if (option) {
                    machineSelect.value = machineCode;
                }

                const qty = Number(machineCell.dataset.quantity ?? 0);
                quantityInput.value = formatQuantity(qty);
                clearFeedback();
                return;
            }

            const row = event.target.closest("tr[data-hour]");
            if (!row || !row.dataset.hour) {
                return;
            }

            hourSelect.value = String(Number(row.dataset.hour));
            updateQuantityFieldFromSummary();
            clearFeedback();
        });

        fetchMachines();
    </script>
</body>
</html>
