<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Man | SAMPROX ERP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" />
</head>
<body>
    <div class="page">
        <header class="topbar">
            <div class="brand">
                <div class="brand__logo">S</div>
                <div class="brand__details">
                    <p class="brand__name">SAMPROX ERP</p>
                    <p class="brand__section">Man Resource Planning</p>
                </div>
            </div>
            <div class="topbar__actions">
                <a class="button button--ghost" href="{{ url_for('ui.mind_page') }}">Mind</a>
                <div class="user-summary">
                    <span class="user-summary__name" id="user-name"></span>
                    <span class="user-summary__role" id="user-role"></span>
                </div>
                <button type="button" class="button button--secondary" id="logout">Sign out</button>
            </div>
        </header>
        <nav class="subnav" aria-label="7M navigation">
            <a class="subnav__link" href="{{ url_for('ui.mind_page') }}">Mind</a>
            <a class="subnav__link subnav__link--active" href="{{ url_for('ui.man_page') }}">Man</a>
            <a class="subnav__link" href="{{ url_for('ui.machines_page') }}">Machine</a>
            <a class="subnav__link" href="{{ url_for('ui.material_page') }}">Material</a>
            <a class="subnav__link" href="{{ url_for('ui.market_page') }}">Market</a>
            <a class="subnav__link" href="{{ url_for('ui.manufacturing_page') }}">Manufacturing</a>
            <a class="subnav__link" href="{{ url_for('ui.money_page') }}">Money</a>
        </nav>
        <section class="section">
            <header class="section__header">
                <h1>People & capability overview</h1>
            </header>
            <p class="section__description">
                Manage the workforce pipeline by tracking available skills, upcoming shifts, and
                training requirements. Use this page to ensure the right technicians are ready for
                each maintenance job and production order.
            </p>
            <div class="section__grid">
                <article class="tile">
                    <h2 class="tile__title">Team roster</h2>
                    <p class="tile__description">
                        View key team members, their roles, and certification status. Identify coverage
                        gaps before they impact production schedules.
                    </p>
                </article>
                <article class="tile">
                    <h2 class="tile__title">Training tracker</h2>
                    <p class="tile__description">
                        Monitor mandatory trainings, license renewals, and development plans to keep the
                        workforce compliant and skilled.
                    </p>
                </article>
                <article class="tile">
                    <h2 class="tile__title">Shift planning</h2>
                    <p class="tile__description">
                        Align technician shifts with maintenance demand and active work orders. Balance
                        workloads to prevent burnout.
                    </p>
                </article>
                <article class="tile">
                    <h2 class="tile__title">Safety briefings</h2>
                    <p class="tile__description">
                        Document toolbox talks and safety observations. Share recurring hazards with the
                        wider team to improve awareness.
                    </p>
                </article>
            </div>
            <section class="team-directory" aria-labelledby="team-directory-heading">
                <h2 class="team-directory__title" id="team-directory-heading">Team members</h2>
                <div class="table-container">
                    <table class="team-table team-table--simple">
                        <thead>
                            <tr>
                                <th scope="col">ID</th>
                                <th scope="col">Reg No</th>
                                <th scope="col">Image</th>
                                <th scope="col">Name</th>
                                <th scope="col">Nickname</th>
                                <th scope="col">EPF</th>
                                <th scope="col">Position</th>
                                <th scope="col">Pay category</th>
                                <th scope="col">Join date</th>
                                <th scope="col">Status</th>
                                <th scope="col">Created at</th>
                                <th scope="col">Updated at</th>
                                <th scope="col">Personal detail</th>
                                <th scope="col">Assignments</th>
                                <th scope="col">Training records</th>
                                <th scope="col">Employment log</th>
                                <th scope="col">Files</th>
                                <th scope="col">Assets</th>
                            </tr>
                        </thead>
                        <tbody id="team-table-body"></tbody>
                    </table>
                </div>
                <p class="team-directory__empty" id="team-empty-state" hidden>
                    No team members available yet.
                </p>
                <section class="team-form" id="team-form-section">
                    <h3 class="team-form__title">Register a team member</h3>
                    <p class="team-form__description">
                        Keep the roster current by logging new colleagues as soon as they join the team.
                    </p>
                    <div class="team-form__feedback">
                        <p class="alert alert--error" id="team-form-error" hidden></p>
                        <p class="alert alert--success" id="team-form-success" hidden></p>
                    </div>
                    <form class="edit-form" id="team-form">
                        <div class="edit-form__grid">
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-reg-number">
                                    Registration number <span class="required">*</span>
                                </label>
                                <input
                                    class="edit-form__input"
                                    id="team-reg-number"
                                    name="regNumber"
                                    type="text"
                                    autocomplete="off"
                                    required
                                />
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-name">
                                    Name <span class="required">*</span>
                                </label>
                                <input
                                    class="edit-form__input"
                                    id="team-name"
                                    name="name"
                                    type="text"
                                    autocomplete="name"
                                    required
                                />
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-nickname">Nickname</label>
                                <input
                                    class="edit-form__input"
                                    id="team-nickname"
                                    name="nickname"
                                    type="text"
                                    autocomplete="off"
                                />
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-epf">EPF number</label>
                                <input
                                    class="edit-form__input"
                                    id="team-epf"
                                    name="epf"
                                    type="text"
                                    autocomplete="off"
                                />
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-position">Position</label>
                                <input
                                    class="edit-form__input"
                                    id="team-position"
                                    name="position"
                                    type="text"
                                    autocomplete="organization-title"
                                />
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-pay-category">Pay category</label>
                                <select class="edit-form__input" id="team-pay-category" name="payCategory">
                                    <option value="Office" selected>Office</option>
                                    <option value="Factory">Factory</option>
                                    <option value="Casual">Casual</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-join-date">Date of join</label>
                                <input
                                    class="edit-form__input"
                                    id="team-join-date"
                                    name="joinDate"
                                    type="date"
                                />
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-status">Status</label>
                                <select class="edit-form__input" id="team-status" name="status">
                                    <option value="Active" selected>Active</option>
                                    <option value="On Leave">On Leave</option>
                                    <option value="Inactive">Inactive</option>
                                </select>
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-image">Profile image URL</label>
                                <input
                                    class="edit-form__input"
                                    id="team-image"
                                    name="image"
                                    type="url"
                                    inputmode="url"
                                    placeholder="https://example.com/profile.jpg"
                                />
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-personal-detail">Personal detail</label>
                                <textarea
                                    class="edit-form__input"
                                    id="team-personal-detail"
                                    name="personalDetail"
                                    rows="3"
                                ></textarea>
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-assignments">Assignments</label>
                                <textarea
                                    class="edit-form__input"
                                    id="team-assignments"
                                    name="assignments"
                                    rows="3"
                                ></textarea>
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-training">Training records</label>
                                <textarea
                                    class="edit-form__input"
                                    id="team-training"
                                    name="trainingRecords"
                                    rows="3"
                                ></textarea>
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-employment-log">Employment log</label>
                                <textarea
                                    class="edit-form__input"
                                    id="team-employment-log"
                                    name="employmentLog"
                                    rows="3"
                                ></textarea>
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-files">Files</label>
                                <textarea
                                    class="edit-form__input"
                                    id="team-files"
                                    name="files"
                                    rows="3"
                                ></textarea>
                            </div>
                            <div class="edit-form__field">
                                <label class="edit-form__label" for="team-assets">Controlled assets</label>
                                <textarea
                                    class="edit-form__input"
                                    id="team-assets"
                                    name="assets"
                                    rows="3"
                                ></textarea>
                            </div>
                        </div>
                        <div class="edit-form__actions">
                            <button type="submit" class="button button--primary">Save member</button>
                        </div>
                    </form>
                </section>
                <section class="salary-section" aria-labelledby="salary-section-heading">
                    <div class="salary-section__header">
                        <h3 class="salary-section__title" id="salary-section-heading">Salary sheet</h3>
                        <p class="salary-section__description">
                            Record and review the monthly salary breakdown for every active employee.
                        </p>
                    </div>
                    <div class="salary-section__controls">
                        <label class="salary-section__month" for="salary-month-selector">
                            Salary month
                            <input
                                class="salary-section__month-input edit-form__input"
                                type="month"
                                id="salary-month-selector"
                                name="salaryMonth"
                            />
                        </label>
                    </div>
                    <div class="table-container">
                        <table class="team-table salary-table">
                            <thead>
                                <tr>
                                    <th scope="col">Reg No</th>
                                    <th scope="col">Name</th>
                                    <th scope="col">Basic Salary</th>
                                    <th scope="col">General Allowance</th>
                                    <th scope="col">Transport Allowance</th>
                                    <th scope="col">Attendance Allowance</th>
                                    <th scope="col">Special Allowance</th>
                                    <th scope="col">Performance Bonus</th>
                                    <th scope="col">Production</th>
                                    <th scope="col">Target Allowance</th>
                                    <th scope="col">Overtime</th>
                                    <th scope="col">Gross Salary</th>
                                    <th scope="col">Provident Fund</th>
                                    <th scope="col">Other Deduction</th>
                                    <th scope="col">Salary Advance</th>
                                    <th scope="col">No Pay</th>
                                    <th scope="col">Total Deduction</th>
                                    <th scope="col">Net Pay</th>
                                    <th scope="col">Record Attendance</th>
                                    <th scope="col">Manage Salary</th>
                                </tr>
                            </thead>
                            <tbody id="salary-table-body"></tbody>
                        </table>
                    </div>
                    <p class="salary-section__empty" id="salary-empty-state" hidden>
                        No active team members available for the selected month.
                    </p>
                </section>
            </section>
        </section>
    </div>
    <div class="modal" id="attendance-modal" hidden aria-hidden="true">
        <div class="modal__overlay" data-modal-dismiss></div>
        <div
            class="modal__content"
            role="dialog"
            aria-modal="true"
            aria-labelledby="attendance-modal-title"
        >
            <header class="modal__header">
                <h2 class="modal__title" id="attendance-modal-title">Record attendance</h2>
                <button
                    type="button"
                    class="modal__close"
                    id="attendance-modal-close"
                    aria-label="Close attendance form"
                >
                    &times;
                </button>
            </header>
            <div class="modal__body">
                <form class="attendance-form" id="attendance-form">
                    <div class="attendance-form__summary salary-form__summary">
                        <p class="attendance-form__summary-item salary-form__summary-item">
                            <span class="attendance-form__summary-label salary-form__summary-label">Employee</span>
                            <span
                                class="attendance-form__summary-value salary-form__summary-value"
                                id="attendance-form-member-name"
                            >
                                —
                            </span>
                        </p>
                        <p class="attendance-form__summary-item salary-form__summary-item">
                            <span class="attendance-form__summary-label salary-form__summary-label">Reg No</span>
                            <span
                                class="attendance-form__summary-value salary-form__summary-value"
                                id="attendance-form-regno"
                            >
                                —
                            </span>
                        </p>
                        <p class="attendance-form__summary-item salary-form__summary-item">
                            <span class="attendance-form__summary-label salary-form__summary-label">Month</span>
                            <span
                                class="attendance-form__summary-value salary-form__summary-value"
                                id="attendance-summary-month"
                            >
                                —
                            </span>
                        </p>
                    </div>
                    <div class="table-container attendance-table-container">
                        <table class="team-table attendance-table">
                            <thead>
                                <tr>
                                    <th scope="col">Date</th>
                                    <th scope="col">On time</th>
                                    <th scope="col">Off time</th>
                                </tr>
                            </thead>
                            <tbody id="attendance-table-body"></tbody>
                        </table>
                    </div>
                    <div class="modal__actions">
                        <button
                            type="button"
                            class="button button--ghost"
                            id="attendance-modal-cancel"
                        >
                            Cancel
                        </button>
                        <button type="submit" class="button button--primary">Save attendance</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal" id="salary-modal" hidden aria-hidden="true">
        <div class="modal__overlay" data-modal-dismiss></div>
        <div class="modal__content" role="dialog" aria-modal="true" aria-labelledby="salary-modal-title">
            <header class="modal__header">
                <h2 class="modal__title" id="salary-modal-title">Update salary</h2>
                <button type="button" class="modal__close" id="salary-modal-close" aria-label="Close salary form">
                    &times;
                </button>
            </header>
            <div class="modal__body">
                <form class="edit-form salary-form" id="salary-form">
                    <div class="salary-form__summary">
                        <p class="salary-form__summary-item">
                            <span class="salary-form__summary-label">Employee</span>
                            <span class="salary-form__summary-value" id="salary-form-member-name">—</span>
                        </p>
                        <p class="salary-form__summary-item">
                            <span class="salary-form__summary-label">Reg No</span>
                            <span class="salary-form__summary-value" id="salary-form-regno">—</span>
                        </p>
                    </div>
                    <div class="edit-form__grid salary-form__grid">
                        <div class="edit-form__field edit-form__field--full">
                            <label class="edit-form__label" for="salary-form-month">Salary month</label>
                            <input
                                class="edit-form__input"
                                type="month"
                                id="salary-form-month"
                                name="salaryMonth"
                                required
                            />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-basic-salary">Basic salary</label>
                            <input class="edit-form__input" type="number" step="0.01" id="salary-basic-salary" name="basicSalary" />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-general-allowance">General allowance</label>
                            <input
                                class="edit-form__input"
                                type="number"
                                step="0.01"
                                id="salary-general-allowance"
                                name="generalAllowance"
                            />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-transport-allowance">Transport allowance</label>
                            <input
                                class="edit-form__input"
                                type="number"
                                step="0.01"
                                id="salary-transport-allowance"
                                name="transportAllowance"
                            />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-attendance-allowance">Attendance allowance</label>
                            <input
                                class="edit-form__input"
                                type="number"
                                step="0.01"
                                id="salary-attendance-allowance"
                                name="attendanceAllowance"
                            />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-special-allowance">Special allowance</label>
                            <input
                                class="edit-form__input"
                                type="number"
                                step="0.01"
                                id="salary-special-allowance"
                                name="specialAllowance"
                            />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-performance-bonus">Performance bonus</label>
                            <input
                                class="edit-form__input"
                                type="number"
                                step="0.01"
                                id="salary-performance-bonus"
                                name="performanceBonus"
                            />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-production">Production</label>
                            <input class="edit-form__input" type="number" step="0.01" id="salary-production" name="production" />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-target-allowance">Target allowance</label>
                            <input
                                class="edit-form__input"
                                type="number"
                                step="0.01"
                                id="salary-target-allowance"
                                name="targetAllowance"
                            />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-overtime">Overtime</label>
                            <input class="edit-form__input" type="number" step="0.01" id="salary-overtime" name="overtime" />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-gross-salary">Gross salary</label>
                            <input class="edit-form__input" type="number" step="0.01" id="salary-gross-salary" name="grossSalary" />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-provident-fund">Provident fund</label>
                            <input
                                class="edit-form__input"
                                type="number"
                                step="0.01"
                                id="salary-provident-fund"
                                name="providentFund"
                            />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-other-deduction">Other deduction</label>
                            <input
                                class="edit-form__input"
                                type="number"
                                step="0.01"
                                id="salary-other-deduction"
                                name="otherDeduction"
                            />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-salary-advance">Salary advance</label>
                            <input
                                class="edit-form__input"
                                type="number"
                                step="0.01"
                                id="salary-salary-advance"
                                name="salaryAdvance"
                            />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-no-pay">No pay</label>
                            <input class="edit-form__input" type="number" step="0.01" id="salary-no-pay" name="noPay" />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-total-deduction">Total deduction</label>
                            <input
                                class="edit-form__input"
                                type="number"
                                step="0.01"
                                id="salary-total-deduction"
                                name="totalDeduction"
                            />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="salary-net-pay">Net pay</label>
                            <input class="edit-form__input" type="number" step="0.01" id="salary-net-pay" name="netPay" />
                        </div>
                    </div>
                    <div class="salary-form__divider" aria-hidden="true"></div>
                    <section
                        class="salary-attendance"
                        id="salary-attendance-section"
                        aria-labelledby="salary-attendance-title"
                    >
                        <header class="salary-attendance__header">
                            <h3 class="salary-attendance__title" id="salary-attendance-title">
                                Previous attendance
                            </h3>
                            <p class="salary-attendance__description">
                                Review the on and off times recorded for this salary month.
                            </p>
                        </header>
                        <div
                            class="table-container salary-attendance__table-container"
                            id="salary-attendance-container"
                            hidden
                        >
                            <table class="team-table salary-attendance__table">
                                <thead>
                                    <tr>
                                        <th scope="col">Date</th>
                                        <th scope="col">On time</th>
                                        <th scope="col">Off time</th>
                                    </tr>
                                </thead>
                                <tbody id="salary-attendance-body"></tbody>
                            </table>
                        </div>
                        <p class="salary-attendance__empty" id="salary-attendance-empty" hidden>
                            Attendance has not been recorded for this month yet.
                        </p>
                    </section>
                    <div class="modal__actions">
                        <button type="button" class="button button--ghost" id="salary-modal-cancel">Cancel</button>
                        <button type="submit" class="button button--primary">Save salary</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        const token = localStorage.getItem("samprox_token");
        const userRaw = localStorage.getItem("samprox_user");
        let user;

        try {
            user = userRaw ? JSON.parse(userRaw) : null;
        } catch (_) {
            user = null;
        }

        if (!token || !user) {
            window.location.href = "/";
        }

        const roleLabels = {
            admin: "Admin",
            production_manager: "Production Manager",
            maintenance_manager: "Maintenance Manager",
            technician: "Technician",
        };

        const userNameEl = document.getElementById("user-name");
        const userRoleEl = document.getElementById("user-role");
        const logoutButton = document.getElementById("logout");

        userNameEl.textContent = user?.name || "Unknown";
        userRoleEl.textContent = roleLabels[user?.role] || "";

        logoutButton.addEventListener("click", () => {
            localStorage.removeItem("samprox_token");
            localStorage.removeItem("samprox_user");
            window.location.href = "/";
        });

        const authHeaders = {
            Accept: "application/json",
            ...(token ? { Authorization: `Bearer ${token}` } : {}),
        };

        // =====================
        // Helpers: normalize date & status for API
        // =====================
        function toYyyyMmDd(input) {
            if (!input) return null;
            const d = new Date(input);
            if (!isNaN(d.getTime())) return d.toISOString().slice(0, 10);
            const mdy = /^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/.exec(String(input).trim());
            if (mdy) {
                const [, m, dd, y] = mdy;
                return `${y}-${String(m).padStart(2, "0")}-${String(dd).padStart(2, "0")}`;
            }
            const ymd = /^(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})$/.exec(String(input).trim());
            if (ymd) {
                const [, y, m, dd] = ymd;
                return `${y}-${String(m).padStart(2, "0")}-${String(dd).padStart(2, "0")}`;
            }
            return null;
        }

        function normalizeStatus(value) {
            if (!value) return "Active";
            const map = {
                "active": "Active",
                "inactive": "Inactive",
                "on leave": "On Leave",
                "on_leave": "On Leave",
                "on-leave": "On Leave",
            };
            return map[String(value).trim().toLowerCase()] ?? "Active";
        }

        const tableBody = document.getElementById("team-table-body");
        const emptyState = document.getElementById("team-empty-state");
        const formSection = document.getElementById("team-form-section");
        const teamForm = document.getElementById("team-form");
        const teamFormError = document.getElementById("team-form-error");
        const teamFormSuccess = document.getElementById("team-form-success");
        const salaryTableBody = document.getElementById("salary-table-body");
        const salaryEmptyState = document.getElementById("salary-empty-state");
        const salaryMonthSelector = document.getElementById("salary-month-selector");
        const attendanceModal = document.getElementById("attendance-modal");
        const attendanceModalClose = document.getElementById("attendance-modal-close");
        const attendanceModalCancel = document.getElementById("attendance-modal-cancel");
        const attendanceForm = document.getElementById("attendance-form");
        const attendanceTableBody = document.getElementById("attendance-table-body");
        const attendanceFormMemberName = document.getElementById("attendance-form-member-name");
        const attendanceFormRegno = document.getElementById("attendance-form-regno");
        const attendanceSummaryMonth = document.getElementById("attendance-summary-month");
        const salaryModal = document.getElementById("salary-modal");
        const salaryModalTitle = document.getElementById("salary-modal-title");
        const salaryModalClose = document.getElementById("salary-modal-close");
        const salaryModalCancel = document.getElementById("salary-modal-cancel");
        const salaryForm = document.getElementById("salary-form");
        const salaryFormMonth = document.getElementById("salary-form-month");
        const salaryFormMemberName = document.getElementById("salary-form-member-name");
        const salaryFormRegno = document.getElementById("salary-form-regno");
        const salaryAttendanceContainer = document.getElementById("salary-attendance-container");
        const salaryAttendanceBody = document.getElementById("salary-attendance-body");
        const salaryAttendanceEmpty = document.getElementById("salary-attendance-empty");
        const salaryAttendanceMessages = {
            unavailable: "Attendance data is unavailable.",
            empty: "Attendance has not been recorded for this month yet.",
        };

        const canManageMembers = ["admin", "production_manager"].includes(user?.role);

        if (!canManageMembers && formSection) {
            formSection.hidden = true;
        }

        const salaryFieldDefinitions = [
            { name: "basicSalary", label: "Basic Salary" },
            { name: "generalAllowance", label: "General Allowance" },
            { name: "transportAllowance", label: "Transport Allowance" },
            { name: "attendanceAllowance", label: "Attendance Allowance" },
            { name: "specialAllowance", label: "Special Allowance" },
            { name: "performanceBonus", label: "Performance Bonus" },
            { name: "production", label: "Production" },
            { name: "targetAllowance", label: "Target Allowance" },
            { name: "overtime", label: "Overtime" },
            { name: "grossSalary", label: "Gross Salary" },
            { name: "providentFund", label: "Provident Fund" },
            { name: "otherDeduction", label: "Other Deduction" },
            { name: "salaryAdvance", label: "Salary Advance" },
            { name: "noPay", label: "No Pay" },
            { name: "totalDeduction", label: "Total Deduction" },
            { name: "netPay", label: "Net Pay" },
        ];

        const salaryDataStore = Object.create(null);
        const attendanceDataStore = Object.create(null);
        const memberKeyById = new Map();
        let activeMembers = [];
        let salaryModalContext = null;
        let attendanceModalContext = null;

        const numberFormatter = new Intl.NumberFormat(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
        });
        const attendanceDateFormatter = new Intl.DateTimeFormat(undefined, {
            year: "numeric",
            month: "short",
            day: "2-digit",
        });
        const attendanceMonthFormatter = new Intl.DateTimeFormat(undefined, {
            year: "numeric",
            month: "long",
        });

        const getInitialSalaryMonth = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, "0");
            return `${year}-${month}`;
        };

        const normalizeMonthValue = (value) => {
            if (typeof value !== "string") {
                return "";
            }
            const trimmed = value.trim();
            const match = /^(\d{4})-(\d{2})$/.exec(trimmed);
            if (!match) {
                return "";
            }
            const month = Number(match[2]);
            if (Number.isNaN(month) || month < 1 || month > 12) {
                return "";
            }
            return `${match[1]}-${String(month).padStart(2, "0")}`;
        };

        const parseMemberId = (value) => {
            if (typeof value === "number" && Number.isFinite(value)) {
                return value;
            }
            if (typeof value === "string") {
                const trimmed = value.trim();
                if (trimmed) {
                    const parsed = Number.parseInt(trimmed, 10);
                    if (Number.isFinite(parsed)) {
                        return parsed;
                    }
                }
            }
            return null;
        };

        const fetchAttendanceRecords = async (month) => {
            const normalized = normalizeMonthValue(month);
            if (!normalized) {
                return;
            }

            try {
                const response = await fetch(`/api/team/attendance?month=${encodeURIComponent(normalized)}`, {
                    headers: authHeaders,
                });

                if (response.status === 401) {
                    logoutButton.click();
                    return;
                }

                if (!response.ok) {
                    throw new Error(`Request failed with status ${response.status}`);
                }

                const body = await response.json().catch(() => ({}));
                const records = Array.isArray(body?.records) ? body.records : [];
                const monthStore = Object.create(null);

                records.forEach((record) => {
                    const memberId = parseMemberId(record?.memberId);
                    if (memberId == null) {
                        return;
                    }
                    const storeKey = memberKeyById.get(memberId);
                    if (!storeKey) {
                        return;
                    }
                    const entries = record?.entries;
                    if (
                        entries &&
                        typeof entries === "object" &&
                        Object.keys(entries).length > 0
                    ) {
                        monthStore[storeKey] = entries;
                    }
                });

                attendanceDataStore[normalized] = monthStore;
            } catch (error) {
                console.error("Failed to load attendance records", error);
            }
        };

        const fetchSalaryRecords = async (month) => {
            const normalized = normalizeMonthValue(month);
            if (!normalized) {
                return;
            }

            try {
                const response = await fetch(`/api/team/salary?month=${encodeURIComponent(normalized)}`, {
                    headers: authHeaders,
                });

                if (response.status === 401) {
                    logoutButton.click();
                    return;
                }

                if (!response.ok) {
                    throw new Error(`Request failed with status ${response.status}`);
                }

                const body = await response.json().catch(() => ({}));
                const records = Array.isArray(body?.records) ? body.records : [];
                const monthStore = Object.create(null);

                records.forEach((record) => {
                    const memberId = parseMemberId(record?.memberId);
                    if (memberId == null) {
                        return;
                    }
                    const storeKey = memberKeyById.get(memberId);
                    if (!storeKey) {
                        return;
                    }
                    const components = record?.components;
                    if (
                        components &&
                        typeof components === "object" &&
                        Object.keys(components).length > 0
                    ) {
                        monthStore[storeKey] = components;
                    }
                });

                salaryDataStore[normalized] = monthStore;
            } catch (error) {
                console.error("Failed to load salary records", error);
            }
        };

        const refreshMonthData = async (month = currentSalaryMonth) => {
            const normalized = normalizeMonthValue(month);
            if (!normalized) {
                return;
            }

            await Promise.all([
                fetchAttendanceRecords(normalized),
                fetchSalaryRecords(normalized),
            ]);

            renderSalarySheet();
            refreshAttendanceModalContents();
            if (salaryModalContext?.memberKey) {
                renderSalaryAttendanceHistory(salaryModalContext.memberKey);
            }
        };

        const getMonthDateEntries = (month) => {
            const normalized = normalizeMonthValue(month);
            if (!normalized) {
                return [];
            }

            const [yearStr, monthStr] = normalized.split("-");
            const year = Number(yearStr);
            const monthIndex = Number(monthStr) - 1;

            if (!Number.isFinite(year) || !Number.isFinite(monthIndex)) {
                return [];
            }

            if (monthIndex < 0 || monthIndex > 11) {
                return [];
            }

            const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
            const entries = [];

            for (let day = 1; day <= daysInMonth; day += 1) {
                const iso = `${year}-${String(monthIndex + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
                const display = attendanceDateFormatter.format(
                    new Date(year, monthIndex, day)
                );
                entries.push({ iso, display });
            }

            return entries;
        };

        const formatAttendanceMonthLabel = (month) => {
            const normalized = normalizeMonthValue(month);
            if (!normalized) {
                return "—";
            }

            const [yearStr, monthStr] = normalized.split("-");
            const year = Number(yearStr);
            const monthIndex = Number(monthStr) - 1;
            if (!Number.isFinite(year) || !Number.isFinite(monthIndex)) {
                return "—";
            }

            const date = new Date(year, monthIndex, 1);
            if (Number.isNaN(date.getTime())) {
                return "—";
            }

            return attendanceMonthFormatter.format(date);
        };

        function renderSalaryAttendanceHistory(memberKey, month = null) {
            if (!salaryAttendanceBody || !salaryAttendanceContainer || !salaryAttendanceEmpty) {
                return;
            }

            salaryAttendanceBody.innerHTML = "";

            const selectedMonth =
                month ?? normalizeMonthValue(salaryFormMonth?.value || "") || currentSalaryMonth;
            const normalizedMonth = normalizeMonthValue(selectedMonth) || selectedMonth;

            if (!memberKey || !normalizedMonth) {
                salaryAttendanceContainer.hidden = true;
                salaryAttendanceEmpty.hidden = false;
                salaryAttendanceEmpty.textContent = salaryAttendanceMessages.unavailable;
                return;
            }

            const record = getAttendanceRecord(normalizedMonth, memberKey);
            const entries =
                record && typeof record === "object"
                    ? Object.entries(record).filter(([, value]) => value && (value.onTime || value.offTime))
                    : [];

            if (entries.length === 0) {
                salaryAttendanceContainer.hidden = true;
                salaryAttendanceEmpty.hidden = false;
                salaryAttendanceEmpty.textContent = salaryAttendanceMessages.empty;
                return;
            }

            const displayMap = new Map(
                getMonthDateEntries(normalizedMonth).map(({ iso, display }) => [iso, display])
            );

            entries
                .sort(([a], [b]) => a.localeCompare(b))
                .forEach(([iso, value]) => {
                    const row = document.createElement("tr");
                    row.appendChild(createCell("Date", displayMap.get(iso) || iso));
                    row.appendChild(createCell("On time", formatTimeDisplay(value?.onTime)));
                    row.appendChild(createCell("Off time", formatTimeDisplay(value?.offTime)));
                    salaryAttendanceBody.appendChild(row);
                });

            salaryAttendanceContainer.hidden = false;
            salaryAttendanceEmpty.hidden = true;
        }

        const formatSalaryValue = (value) => {
            if (value == null) {
                return "—";
            }
            const stringValue = String(value).trim();
            if (!stringValue) {
                return "—";
            }
            const numeric = Number(stringValue);
            if (Number.isFinite(numeric)) {
                return numberFormatter.format(numeric);
            }
            return stringValue;
        };

        const computeMemberKey = (member, fallbackIndex = null) => {
            if (!member || typeof member !== "object") {
                return fallbackIndex != null ? `idx:${fallbackIndex}` : null;
            }
            if (member.id != null) {
                return `id:${member.id}`;
            }
            if (member.regNumber != null) {
                return `reg:${member.regNumber}`;
            }
            if (member.name) {
                return `name:${member.name}`;
            }
            return fallbackIndex != null ? `idx:${fallbackIndex}` : null;
        };

        let currentSalaryMonth = getInitialSalaryMonth();

        if (salaryMonthSelector) {
            const normalizedExisting = normalizeMonthValue(salaryMonthSelector.value);
            if (normalizedExisting) {
                currentSalaryMonth = normalizedExisting;
            } else {
                salaryMonthSelector.value = currentSalaryMonth;
            }

            salaryMonthSelector.addEventListener("change", async (event) => {
                const nextValue = normalizeMonthValue(event.target.value);
                if (!nextValue) {
                    event.target.value = currentSalaryMonth;
                    return;
                }
                currentSalaryMonth = nextValue;
                try {
                    await refreshMonthData(currentSalaryMonth);
                } catch (error) {
                    console.error("Failed to refresh monthly data", error);
                }
            });
        }

        const sanitizeText = (value, fallback = "—") => {
            if (typeof value === "string") {
                const trimmed = value.trim();
                return trimmed || fallback;
            }

            if (value == null) {
                return fallback;
            }

            const stringValue = String(value).trim();
            return stringValue || fallback;
        };

        const resolveImageUrl = (value) => {
            if (typeof value !== "string") {
                return "";
            }

            const trimmed = value.trim();
            if (!trimmed) {
                return "";
            }

            if (/^https?:\/\//i.test(trimmed)) {
                try {
                    const parsed = new URL(trimmed);
                    if (parsed.hostname === "github.com") {
                        const segments = parsed.pathname.split("/").filter(Boolean);
                        const pivotIndex = segments.findIndex((segment) =>
                            ["blob", "raw"].includes(segment.toLowerCase())
                        );
                        if (pivotIndex !== -1 && pivotIndex + 1 < segments.length) {
                            const rawSegments = [
                                ...segments.slice(0, pivotIndex),
                                ...segments.slice(pivotIndex + 1),
                            ];
                            return `https://raw.githubusercontent.com/${rawSegments.join("/")}`;
                        }
                    }

                    return parsed.toString();
                } catch (_error) {
                    return trimmed;
                }
            }

            return trimmed;
        };

        const formatJoinDate = (value) => {
            if (!value) {
                return "—";
            }

            try {
                const parsed = new Date(value);
                if (Number.isNaN(parsed.getTime())) {
                    return sanitizeText(value);
                }

                return parsed.toLocaleDateString(undefined, {
                    year: "numeric",
                    month: "short",
                    day: "numeric",
                });
            } catch (error) {
                console.warn("Unable to format join date", error);
                return sanitizeText(value);
            }
        };

        const formatDateTime = (value) => {
            if (!value) {
                return "—";
            }

            try {
                const parsed = new Date(value);
                if (Number.isNaN(parsed.getTime())) {
                    return sanitizeText(value);
                }

                return parsed.toLocaleString(undefined, {
                    year: "numeric",
                    month: "short",
                    day: "numeric",
                    hour: "2-digit",
                    minute: "2-digit",
                });
            } catch (error) {
                console.warn("Unable to format date/time", error);
                return sanitizeText(value);
            }
        };

        const renderEmptyState = (message) => {
            if (!emptyState) {
                return;
            }

            if (typeof message === "string") {
                emptyState.textContent = message;
            }

            emptyState.hidden = false;
        };

        const hideEmptyState = () => {
            if (emptyState) {
                emptyState.hidden = true;
            }
        };

        const createCell = (label, value) => {
            const cell = document.createElement("td");
            cell.setAttribute("data-label", label);

            if (value instanceof Node) {
                cell.appendChild(value);
            } else {
                cell.textContent = value;
            }

            return cell;
        };

        const formatTimeDisplay = (value) => {
            if (typeof value !== "string") {
                return "—";
            }

            const trimmed = value.trim();
            return trimmed || "—";
        };

        const getMemberDisplayName = (member) => {
            const candidates = [member?.name, member?.nickname, member?.regNumber];

            for (const candidate of candidates) {
                if (typeof candidate === "string") {
                    const trimmed = candidate.trim();
                    if (trimmed) {
                        return trimmed;
                    }
                }
            }

            return "Team member";
        };

        const createAvatarElement = (member) => {
            const wrapper = document.createElement("div");
            wrapper.className = "team-table__avatar";

            const displayName = getMemberDisplayName(member);
            const imageUrl = resolveImageUrl(
                typeof member?.image === "string" ? member.image : ""
            );

            const setPlaceholder = () => {
                wrapper.innerHTML = "";
                wrapper.setAttribute("role", "img");
                wrapper.setAttribute(
                    "aria-label",
                    `${displayName} profile placeholder`
                );

                const placeholder = document.createElement("div");
                placeholder.className = "team-table__avatar-placeholder";
                const [firstChar] = Array.from(displayName);
                placeholder.textContent = firstChar
                    ? firstChar.toUpperCase()
                    : "?";
                placeholder.setAttribute("aria-hidden", "true");
                wrapper.appendChild(placeholder);
            };

            if (imageUrl) {
                const img = document.createElement("img");
                img.src = imageUrl;
                img.alt = `${displayName} profile photo`;
                img.loading = "lazy";
                img.decoding = "async";
                img.referrerPolicy = "no-referrer";
                img.addEventListener("error", () => {
                    setPlaceholder();
                });
                wrapper.appendChild(img);
            } else {
                setPlaceholder();
            }

            wrapper.title = `${displayName}'s profile`;

            return wrapper;
        };

        const getAttendanceRecord = (month, memberKey) => {
            if (!month || !memberKey) {
                return null;
            }
            return attendanceDataStore[month]?.[memberKey] || null;
        };

        const setAttendanceRecord = (month, memberKey, record) => {
            if (!month || !memberKey) {
                return;
            }
            if (!attendanceDataStore[month]) {
                attendanceDataStore[month] = {};
            }
            attendanceDataStore[month][memberKey] = record;

            const normalizedMonth = normalizeMonthValue(month) || month;
            const activeSalaryMonth =
                normalizeMonthValue(salaryFormMonth?.value || "") || currentSalaryMonth;

            if (
                salaryModal &&
                !salaryModal.hasAttribute("hidden") &&
                salaryModalContext?.memberKey === memberKey &&
                normalizedMonth &&
                normalizedMonth === activeSalaryMonth
            ) {
                renderSalaryAttendanceHistory(memberKey, normalizedMonth);
            }
        };

        const removeAttendanceRecord = (month, memberKey) => {
            if (!month || !memberKey || !attendanceDataStore[month]) {
                return;
            }
            delete attendanceDataStore[month][memberKey];
            if (Object.keys(attendanceDataStore[month]).length === 0) {
                delete attendanceDataStore[month];
            }

            const normalizedMonth = normalizeMonthValue(month) || month;
            const activeSalaryMonth =
                normalizeMonthValue(salaryFormMonth?.value || "") || currentSalaryMonth;

            if (
                salaryModal &&
                !salaryModal.hasAttribute("hidden") &&
                salaryModalContext?.memberKey === memberKey &&
                normalizedMonth &&
                normalizedMonth === activeSalaryMonth
            ) {
                renderSalaryAttendanceHistory(memberKey, normalizedMonth);
            }
        };

        const getSalaryRecord = (month, memberKey) => {
            if (!month || !memberKey) {
                return null;
            }
            return salaryDataStore[month]?.[memberKey] || null;
        };

        const setSalaryRecord = (month, memberKey, record) => {
            if (!month || !memberKey) {
                return;
            }
            if (!salaryDataStore[month]) {
                salaryDataStore[month] = {};
            }
            salaryDataStore[month][memberKey] = record;
        };

        const removeSalaryRecord = (month, memberKey) => {
            if (!month || !memberKey || !salaryDataStore[month]) {
                return;
            }
            delete salaryDataStore[month][memberKey];
            if (Object.keys(salaryDataStore[month]).length === 0) {
                delete salaryDataStore[month];
            }
        };

        const updateAttendanceSummary = (member) => {
            if (attendanceFormMemberName) {
                attendanceFormMemberName.textContent = getMemberDisplayName(member);
            }
            if (attendanceFormRegno) {
                attendanceFormRegno.textContent = sanitizeText(member?.regNumber);
            }
            if (attendanceSummaryMonth) {
                attendanceSummaryMonth.textContent = formatAttendanceMonthLabel(
                    currentSalaryMonth
                );
            }
        };

        const renderAttendanceTableRows = () => {
            if (!attendanceTableBody) {
                return;
            }

            attendanceTableBody.innerHTML = "";

            const memberKey = attendanceModalContext?.memberKey;
            if (!memberKey) {
                return;
            }

            const entries = getMonthDateEntries(currentSalaryMonth);
            const record = getAttendanceRecord(currentSalaryMonth, memberKey) || {};

            if (entries.length === 0) {
                const row = document.createElement("tr");
                const cell = document.createElement("td");
                cell.colSpan = 3;
                cell.textContent = "No calendar days available for the selected month.";
                row.appendChild(cell);
                attendanceTableBody.appendChild(row);
                return;
            }

            entries.forEach(({ iso, display }) => {
                const row = document.createElement("tr");
                row.dataset.date = iso;

                row.appendChild(createCell("Date", display));

                const onInput = document.createElement("input");
                onInput.type = "time";
                onInput.name = `on-${iso}`;
                onInput.className = "attendance-table__time-input edit-form__input";
                if (record?.[iso]?.onTime) {
                    onInput.value = record[iso].onTime;
                }

                const offInput = document.createElement("input");
                offInput.type = "time";
                offInput.name = `off-${iso}`;
                offInput.className = "attendance-table__time-input edit-form__input";
                if (record?.[iso]?.offTime) {
                    offInput.value = record[iso].offTime;
                }

                row.appendChild(createCell("On time", onInput));
                row.appendChild(createCell("Off time", offInput));

                attendanceTableBody.appendChild(row);
            });
        };

        const refreshAttendanceModalContents = () => {
            if (!attendanceModal || attendanceModal.hasAttribute("hidden")) {
                return;
            }

            if (!attendanceModalContext?.member) {
                return;
            }

            updateAttendanceSummary(attendanceModalContext.member);
            renderAttendanceTableRows();
        };

        const closeAttendanceModal = () => {
            if (!attendanceModal) {
                return;
            }

            attendanceModal.classList.remove("modal--open");
            attendanceModal.setAttribute("hidden", "");
            attendanceModal.setAttribute("aria-hidden", "true");
            document.body.classList.remove("modal-open");
            if (attendanceForm) {
                attendanceForm.reset();
            }
            if (attendanceTableBody) {
                attendanceTableBody.innerHTML = "";
            }
            if (attendanceFormMemberName) {
                attendanceFormMemberName.textContent = "—";
            }
            if (attendanceFormRegno) {
                attendanceFormRegno.textContent = "—";
            }
            if (attendanceSummaryMonth) {
                attendanceSummaryMonth.textContent = "—";
            }
            attendanceModalContext = null;
            if (attendanceModal?.dataset) {
                delete attendanceModal.dataset.memberKey;
            }
        };

        const openAttendanceModal = (member, providedKey) => {
            if (!attendanceModal || !attendanceForm) {
                return;
            }

            if (salaryModal && !salaryModal.hasAttribute("hidden")) {
                closeSalaryModal();
            }

            const memberKey = providedKey ?? computeMemberKey(member);
            if (!memberKey) {
                return;
            }

            const memberId = parseMemberId(member?.id);
            attendanceModalContext = { member, memberKey, memberId };
            attendanceModal.removeAttribute("hidden");
            attendanceModal.setAttribute("aria-hidden", "false");
            attendanceModal.classList.add("modal--open");
            attendanceModal.dataset.memberKey = memberKey;
            document.body.classList.add("modal-open");

            attendanceForm.reset();
            updateAttendanceSummary(member);
            renderAttendanceTableRows();

            window.requestAnimationFrame(() => {
                const firstField = attendanceTableBody?.querySelector("input[type='time']");
                if (firstField) {
                    firstField.focus();
                }
            });
        };

        const renderSalarySheet = () => {
            if (!salaryTableBody) {
                return;
            }

            salaryTableBody.innerHTML = "";

            if (!Array.isArray(activeMembers) || activeMembers.length === 0) {
                if (salaryEmptyState) {
                    salaryEmptyState.hidden = false;
                }
                return;
            }

            if (salaryEmptyState) {
                salaryEmptyState.hidden = true;
            }

            const monthStore = salaryDataStore[currentSalaryMonth] || {};

            activeMembers.forEach((member, index) => {
                const memberKey = computeMemberKey(member, index);
                const record = memberKey ? monthStore[memberKey] || {} : {};
                const row = document.createElement("tr");

                row.appendChild(createCell("Reg No", sanitizeText(member?.regNumber)));

                const nameButton = document.createElement("button");
                nameButton.type = "button";
                nameButton.className = "salary-table__name-button";
                nameButton.textContent = getMemberDisplayName(member);
                nameButton.addEventListener("click", () => {
                    openSalaryModal(member, memberKey);
                });
                row.appendChild(createCell("Name", nameButton));

                salaryFieldDefinitions.forEach(({ label, name }) => {
                    row.appendChild(createCell(label, formatSalaryValue(record?.[name])));
                });

                const attendanceButton = document.createElement("button");
                attendanceButton.type = "button";
                attendanceButton.className = "salary-table__action-button";
                attendanceButton.textContent = "Record attendance";
                attendanceButton.addEventListener("click", () => {
                    openAttendanceModal(member, memberKey);
                });
                row.appendChild(createCell("Record Attendance", attendanceButton));

                const salaryButton = document.createElement("button");
                salaryButton.type = "button";
                salaryButton.className = "salary-table__action-button";
                salaryButton.textContent = "Update salary";
                salaryButton.addEventListener("click", () => {
                    openSalaryModal(member, memberKey);
                });
                row.appendChild(createCell("Manage Salary", salaryButton));

                salaryTableBody.appendChild(row);
            });
        };

        const setActiveMembers = (members) => {
            if (!Array.isArray(members)) {
                activeMembers = [];
                memberKeyById.clear();
                renderSalarySheet();
                return;
            }

            activeMembers = members.filter(
                (member) => normalizeStatus(member?.status) === "Active"
            );

            memberKeyById.clear();
            activeMembers.forEach((member, index) => {
                const key = computeMemberKey(member, index);
                const memberId = parseMemberId(member?.id);
                if (key && memberId != null) {
                    memberKeyById.set(memberId, key);
                }
            });
            renderSalarySheet();
        };

        const populateSalaryFormFields = (record) => {
            if (!salaryForm) {
                return;
            }

            salaryFieldDefinitions.forEach(({ name }) => {
                const input = salaryForm.elements[name];
                if (input) {
                    input.value = record?.[name] ?? "";
                }
            });
        };

        const closeSalaryModal = () => {
            if (!salaryModal) {
                return;
            }
            salaryModal.setAttribute("hidden", "");
            salaryModal.setAttribute("aria-hidden", "true");
            salaryModal.classList.remove("modal--open");
            document.body.classList.remove("modal-open");
            if (salaryForm) {
                salaryForm.reset();
            }
            if (salaryFormMonth) {
                salaryFormMonth.value = currentSalaryMonth;
            }
            if (salaryAttendanceBody) {
                salaryAttendanceBody.innerHTML = "";
            }
            if (salaryAttendanceContainer) {
                salaryAttendanceContainer.hidden = true;
            }
            if (salaryAttendanceEmpty) {
                salaryAttendanceEmpty.hidden = false;
                salaryAttendanceEmpty.textContent = salaryAttendanceMessages.empty;
            }
            salaryModalContext = null;
            if (salaryModal?.dataset) {
                delete salaryModal.dataset.memberKey;
            }
        };

        const openSalaryModal = (member, providedKey) => {
            if (!salaryModal || !salaryForm) {
                return;
            }

            if (attendanceModal && !attendanceModal.hasAttribute("hidden")) {
                closeAttendanceModal();
            }

            const memberKey = providedKey ?? computeMemberKey(member);
            if (!memberKey) {
                return;
            }

            const memberId = parseMemberId(member?.id);
            salaryModalContext = { member, memberKey, memberId };
            salaryModal.removeAttribute("hidden");
            salaryModal.setAttribute("aria-hidden", "false");
            salaryModal.classList.add("modal--open");
            salaryModal.dataset.memberKey = memberKey;
            document.body.classList.add("modal-open");

            const displayName = getMemberDisplayName(member);
            if (salaryModalTitle) {
                salaryModalTitle.textContent = `Update salary for ${displayName}`;
            }
            if (salaryFormMemberName) {
                salaryFormMemberName.textContent = displayName;
            }
            if (salaryFormRegno) {
                salaryFormRegno.textContent = sanitizeText(member?.regNumber);
            }
            if (salaryFormMonth) {
                salaryFormMonth.value = currentSalaryMonth;
            }

            populateSalaryFormFields(getSalaryRecord(currentSalaryMonth, memberKey));
            renderSalaryAttendanceHistory(memberKey);

            window.requestAnimationFrame(() => {
                const firstEditableField = salaryForm.querySelector(
                    "input[name='basicSalary']"
                );
                if (firstEditableField) {
                    firstEditableField.focus();
                }
            });
        };

        if (attendanceModalClose) {
            attendanceModalClose.addEventListener("click", () => {
                closeAttendanceModal();
            });
        }

        if (attendanceModalCancel) {
            attendanceModalCancel.addEventListener("click", () => {
                closeAttendanceModal();
            });
        }

        if (attendanceModal) {
            attendanceModal.addEventListener("click", (event) => {
                if (event.target?.dataset?.modalDismiss !== undefined) {
                    closeAttendanceModal();
                }
            });
        }

        if (salaryModalClose) {
            salaryModalClose.addEventListener("click", () => {
                closeSalaryModal();
            });
        }

        if (salaryModalCancel) {
            salaryModalCancel.addEventListener("click", () => {
                closeSalaryModal();
            });
        }

        if (salaryModal) {
            salaryModal.addEventListener("click", (event) => {
                if (event.target?.dataset?.modalDismiss !== undefined) {
                    closeSalaryModal();
                }
            });
        }

        document.addEventListener("keydown", (event) => {
            if (event.key !== "Escape") {
                return;
            }

            if (attendanceModal && !attendanceModal.hasAttribute("hidden")) {
                closeAttendanceModal();
                return;
            }

            if (salaryModal && !salaryModal.hasAttribute("hidden")) {
                closeSalaryModal();
            }
        });

        if (attendanceForm) {
            attendanceForm.addEventListener("submit", async (event) => {
                event.preventDefault();

                if (!attendanceModalContext?.memberKey) {
                    closeAttendanceModal();
                    return;
                }

                const normalizedMonth = normalizeMonthValue(currentSalaryMonth) || currentSalaryMonth;
                if (!normalizedMonth) {
                    window.alert("Select a valid month before saving attendance.");
                    return;
                }

                const formData = new FormData(attendanceForm);
                const entries = getMonthDateEntries(normalizedMonth);
                const record = {};

                entries.forEach(({ iso }) => {
                    const onValueRaw = formData.get(`on-${iso}`);
                    const offValueRaw = formData.get(`off-${iso}`);
                    const onValue = typeof onValueRaw === "string" ? onValueRaw.trim() : "";
                    const offValue = typeof offValueRaw === "string" ? offValueRaw.trim() : "";

                    if (onValue || offValue) {
                        record[iso] = {
                            onTime: onValue,
                            offTime: offValue,
                        };
                    }
                });

                const { memberId, memberKey } = attendanceModalContext;
                let responseData = null;

                if (memberId != null) {
                    try {
                        const response = await fetch(`/api/team/attendance/${memberId}`, {
                            method: "PUT",
                            headers: {
                                ...authHeaders,
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({ month: normalizedMonth, entries: record }),
                        });

                        if (response.status === 401) {
                            logoutButton.click();
                            return;
                        }

                        responseData = await response.json().catch(() => ({}));

                        if (!response.ok) {
                            const message = responseData?.msg || "Unable to save attendance.";
                            window.alert(message);
                            return;
                        }
                    } catch (error) {
                        console.error("Failed to save attendance", error);
                        window.alert("Unable to save attendance. Please try again.");
                        return;
                    }
                }

                if (Object.keys(record).length > 0) {
                    const payload =
                        responseData?.entries && typeof responseData.entries === "object"
                            ? responseData.entries
                            : record;
                    setAttendanceRecord(normalizedMonth, memberKey, payload);
                } else {
                    removeAttendanceRecord(normalizedMonth, memberKey);
                }

                closeAttendanceModal();
            });
        }

        if (salaryFormMonth) {
            salaryFormMonth.addEventListener("change", async (event) => {
                const normalized = normalizeMonthValue(event.target.value);
                if (!normalized) {
                    event.target.value = currentSalaryMonth;
                    return;
                }

                const memberKey = salaryModalContext?.memberKey;
                if (!memberKey) {
                    return;
                }

                await Promise.all([
                    fetchSalaryRecords(normalized),
                    fetchAttendanceRecords(normalized),
                ]);

                populateSalaryFormFields(getSalaryRecord(normalized, memberKey));
                renderSalaryAttendanceHistory(memberKey, normalized);
            });
        }

        if (salaryForm) {
            salaryForm.addEventListener("submit", async (event) => {
                event.preventDefault();

                if (!salaryModalContext?.memberKey) {
                    closeSalaryModal();
                    return;
                }

                const formData = new FormData(salaryForm);
                const monthRaw = formData.get("salaryMonth");
                const normalizedMonth = normalizeMonthValue(monthRaw) || currentSalaryMonth;
                const record = {};

                salaryFieldDefinitions.forEach(({ name }) => {
                    const rawValue = formData.get(name);
                    if (typeof rawValue === "string") {
                        const trimmed = rawValue.trim();
                        if (trimmed) {
                            record[name] = trimmed;
                        }
                    }
                });

                const { memberId, memberKey } = salaryModalContext;
                let responseData = null;

                if (memberId != null) {
                    try {
                        const response = await fetch(`/api/team/salary/${memberId}`, {
                            method: "PUT",
                            headers: {
                                ...authHeaders,
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({ month: normalizedMonth, components: record }),
                        });

                        if (response.status === 401) {
                            logoutButton.click();
                            return;
                        }

                        responseData = await response.json().catch(() => ({}));

                        if (!response.ok) {
                            const message = responseData?.msg || "Unable to save salary details.";
                            window.alert(message);
                            return;
                        }
                    } catch (error) {
                        console.error("Failed to save salary record", error);
                        window.alert("Unable to save salary. Please try again.");
                        return;
                    }
                }

                if (Object.keys(record).length > 0) {
                    const payload =
                        responseData?.components && typeof responseData.components === "object"
                            ? responseData.components
                            : record;
                    setSalaryRecord(normalizedMonth, memberKey, payload);
                } else {
                    removeSalaryRecord(normalizedMonth, memberKey);
                }

                currentSalaryMonth = normalizedMonth;
                if (salaryMonthSelector) {
                    salaryMonthSelector.value = currentSalaryMonth;
                }

                closeSalaryModal();

                try {
                    await refreshMonthData(currentSalaryMonth);
                } catch (error) {
                    console.error("Failed to refresh monthly data after salary update", error);
                    renderSalarySheet();
                }
            });
        }

        const renderMembers = (members) => {
            if (!tableBody) {
                return;
            }

            tableBody.innerHTML = "";

            if (!Array.isArray(members) || members.length === 0) {
                renderEmptyState();
                return;
            }

            hideEmptyState();

            members.forEach((member) => {
                const row = document.createElement("tr");

                const avatarElement = createAvatarElement(member);

                const cells = [
                    ["ID", sanitizeText(member?.id)],
                    ["Reg No", sanitizeText(member?.regNumber)],
                    ["Image", avatarElement],
                    ["Name", sanitizeText(member?.name)],
                    ["Nickname", sanitizeText(member?.nickname)],
                    ["EPF", sanitizeText(member?.epf)],
                    ["Position", sanitizeText(member?.position)],
                    ["Pay category", sanitizeText(member?.payCategory)],
                    ["Join date", formatJoinDate(member?.joinDate)],
                    ["Status", sanitizeText(member?.status)],
                    ["Created at", formatDateTime(member?.createdAt)],
                    ["Updated at", formatDateTime(member?.updatedAt)],
                    ["Personal detail", sanitizeText(member?.personalDetail)],
                    ["Assignments", sanitizeText(member?.assignments)],
                    ["Training records", sanitizeText(member?.trainingRecords)],
                    ["Employment log", sanitizeText(member?.employmentLog)],
                    ["Files", sanitizeText(member?.files)],
                    ["Assets", sanitizeText(member?.assets)],
                ];

                cells.forEach(([label, value]) => {
                    const cell = createCell(label, value);

                    if (label === "Image") {
                        cell.classList.add("team-table__cell--avatar");
                    }

                    row.appendChild(cell);
                });

                tableBody.appendChild(row);
            });
        };

        const loadTeamMembers = async () => {
            if (!tableBody) {
                return;
            }

            try {
                const response = await fetch("/api/team/members", {
                    headers: authHeaders,
                });

                if (response.status === 401) {
                    logoutButton.click();
                    return;
                }

                if (!response.ok) {
                    throw new Error(`Request failed with status ${response.status}`);
                }

                const data = await response.json();
                renderMembers(data);
                setActiveMembers(data);
                await refreshMonthData(currentSalaryMonth);
            } catch (error) {
                console.error("Failed to load team members", error);
                if (tableBody) {
                    tableBody.innerHTML = "";
                }
                renderEmptyState("Unable to load team members.");
                setActiveMembers([]);
            }
        };

        const resetFormFeedback = () => {
            if (teamFormError) {
                teamFormError.hidden = true;
                teamFormError.textContent = "";
            }
            if (teamFormSuccess) {
                teamFormSuccess.hidden = true;
                teamFormSuccess.textContent = "";
            }
        };

        const showFormError = (message) => {
            if (!teamFormError) {
                return;
            }
            teamFormError.textContent = message;
            teamFormError.hidden = false;
            if (teamFormSuccess) {
                teamFormSuccess.hidden = true;
                teamFormSuccess.textContent = "";
            }
        };

        const showFormSuccess = (message) => {
            if (!teamFormSuccess) {
                return;
            }
            teamFormSuccess.textContent = message;
            teamFormSuccess.hidden = false;
            if (teamFormError) {
                teamFormError.hidden = true;
                teamFormError.textContent = "";
            }
        };

        const setFormDisabled = (disabled) => {
            if (!teamForm) {
                return;
            }
            Array.from(teamForm.elements || []).forEach((element) => {
                element.disabled = disabled;
            });
        };

        if (teamForm && canManageMembers) {
            teamForm.addEventListener("submit", async (event) => {
                event.preventDefault();

                if (!teamForm.checkValidity()) {
                    teamForm.reportValidity();
                    return;
                }

                resetFormFeedback();

                const formData = new FormData(teamForm);
                const payload = {};

                const requiredFields = ["regNumber", "name"];
                for (const field of requiredFields) {
                    const rawValue = formData.get(field);
                    const value = typeof rawValue === "string" ? rawValue.trim() : "";
                    if (!value) {
                        showFormError("Registration number and name are required.");
                        return;
                    }
                    payload[field] = value;
                }

                // Normalize joinDate and status
                  const joinDateRaw = formData.get("joinDate");
                  const normalizedDate = toYyyyMmDd(joinDateRaw);

                    if (joinDateRaw && !normalizedDate) {
              showFormError("Invalid date for join date. Please use YYYY-MM-DD.");
                  return;
                    }

                if (normalizedDate) {
              payload.joinDate = normalizedDate; // ✅ correct for your backend schema
                    }

                const statusRaw = formData.get("status");
                if (statusRaw) payload.status = normalizeStatus(statusRaw);

                const optionalFields = [
                    "nickname",
                    "epf",
                    "position",
                    "payCategory",
                    "image",
                    "personalDetail",
                    "assignments",
                    "trainingRecords",
                    "employmentLog",
                    "files",
                    "assets",
                ];

                optionalFields.forEach((field) => {
                    const rawValue = formData.get(field);
                    if (typeof rawValue === "string") {
                        const trimmed = rawValue.trim();
                        if (trimmed) {
                            payload[field] = trimmed;
                        }
                    }
                });

                setFormDisabled(true);

                try {
                    const response = await fetch("/api/team/members", {
                        method: "POST",
                        headers: {
                            ...authHeaders,
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(payload),
                    });

                    if (response.status === 401) {
                        logoutButton.click();
                        return;
                    }

                    const body = await response.json().catch(() => ({}));

                    if (!response.ok) {
                        const message = body?.msg || "Unable to register team member.";
                        showFormError(message);
                        return;
                    }

                    showFormSuccess("Team member registered successfully.");
                    teamForm.reset();
                    await loadTeamMembers();
                } catch (error) {
                    showFormError(error.message || "Unable to register team member.");
                } finally {
                    setFormDisabled(false);
                }
            });

            teamForm.addEventListener("input", () => {
                if (teamFormError && !teamFormError.hidden) {
                    teamFormError.hidden = true;
                    teamFormError.textContent = "";
                }
                if (teamFormSuccess && !teamFormSuccess.hidden) {
                    teamFormSuccess.hidden = true;
                    teamFormSuccess.textContent = "";
                }
            });
        }

        loadTeamMembers();
    </script>
</body>
</html>

