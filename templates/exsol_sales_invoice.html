{% extends "sales_base.html" %}
{% set active_tab = "data-entry" %}
{% block page_title %}Create Invoice (Exsol) | SAMPROX ERP{% endblock %}
{% block content %}
<section class="section">
    <header class="section__header">
        <div>
            <p class="eyebrow">Exsol Engineering</p>
            <h1>Create Invoice</h1>
            <p class="section__description">
                Capture Exsol Engineering (Pvt) Ltd sales invoices with Exsol-only items and serials.
            </p>
        </div>
    </header>

    <div class="card">
        <form id="invoice-form">
            <div class="form-grid">
                <label class="form-field">
                    <span>Invoice No</span>
                    <input type="text" id="invoice-no" name="invoice-no" required />
                </label>
                <label class="form-field">
                    <span>Date</span>
                    <input type="date" id="invoice-date" name="invoice-date" required />
                </label>
                <label class="form-field">
                    <span>Customer Name</span>
                    <input
                        type="text"
                        id="customer-name"
                        name="customer-name"
                        list="customer-options"
                        autocomplete="off"
                        required
                    />
                    <input type="hidden" id="customer-id" name="customer-id" />
                    <datalist id="customer-options"></datalist>
                </label>
                <label class="form-field">
                    <span>City</span>
                    <input type="text" id="customer-city" name="customer-city" />
                </label>
                <label class="form-field">
                    <span>District</span>
                    <input type="text" id="customer-district" name="customer-district" />
                </label>
                <label class="form-field">
                    <span>Province</span>
                    <input type="text" id="customer-province" name="customer-province" />
                </label>
                <label class="form-field form-field--wide">
                    <span>Sales Representative</span>
                    <input type="text" id="sales-rep" name="sales-rep" readonly />
                </label>
            </div>
            <div class="invoice-lines">
                <div class="invoice-lines__header">
                    <h2>Invoice Items</h2>
                    <button type="button" class="button button--ghost" id="add-line">+ Add Item</button>
                </div>
                <div id="line-items"></div>
            </div>
            <div class="invoice-totals">
                <div>
                    <span>Total Qty</span>
                    <strong id="total-qty">0</strong>
                </div>
                <div>
                    <span>Subtotal</span>
                    <strong id="subtotal">0.00</strong>
                </div>
                <div>
                    <span>Total Discount</span>
                    <strong id="total-discount">0.00</strong>
                </div>
                <div>
                    <span>Grand Total</span>
                    <strong id="grand-total">0.00</strong>
                </div>
            </div>
            <div class="card__actions">
                <button type="submit" class="button button--primary" id="save-invoice">Save</button>
            </div>
            <div class="alert" id="invoice-error" hidden></div>
            <div class="alert alert--success" id="invoice-success" hidden></div>
        </form>
    </div>
</section>

<template id="line-item-template">
    <div class="line-item card">
        <div class="line-item__grid">
            <label class="form-field">
                <span>Item</span>
                <select data-field="item_id" required></select>
            </label>
            <label class="form-field">
                <span>Qty</span>
                <input type="number" min="1" data-field="qty" required />
            </label>
            <label class="form-field">
                <span>MRP</span>
                <input type="number" min="0" step="0.01" data-field="mrp" required />
            </label>
            <div class="form-field">
                <span>Trade Discount</span>
                <div class="discount-options" data-field="discount_rate">
                    <label class="discount-option">
                        <input type="radio" value="0.26" />
                        26%
                    </label>
                    <label class="discount-option">
                        <input type="radio" value="0.31" />
                        31%
                    </label>
                </div>
            </div>
            <label class="form-field">
                <span>Discount Value</span>
                <input type="number" data-field="discount_value" readonly />
            </label>
            <label class="form-field">
                <span>Dealer Price</span>
                <input type="number" data-field="dealer_price" readonly />
            </label>
            <label class="form-field">
                <span>Line Total</span>
                <input type="number" data-field="line_total" readonly />
            </label>
            <label class="form-field form-field--wide">
                <span>Serial Numbers</span>
                <select data-field="serial_numbers" multiple size="4" disabled></select>
                <small class="helper" data-field="serial_count">Serial count: 0</small>
            </label>
        </div>
        <div class="line-item__footer">
            <button type="button" class="button button--danger" data-action="remove-line">Remove</button>
            <div class="line-item__error" data-field="line_error" hidden></div>
        </div>
    </div>
</template>

<style>
    .discount-options {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
    }

    .discount-option {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-weight: 600;
        color: #0f172a;
    }

    .invoice-lines {
        margin-top: 2rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .invoice-lines__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
    }

    .line-item {
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .line-item__grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
    }

    .line-item__footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
    }

    .line-item__error {
        color: #b91c1c;
        font-weight: 600;
    }

    .invoice-totals {
        margin-top: 1.5rem;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.75rem;
        background: #f8fafc;
        padding: 1rem 1.25rem;
        border-radius: 0.75rem;
        font-weight: 600;
    }

    .invoice-totals span {
        display: block;
        font-size: 0.85rem;
        color: #64748b;
        margin-bottom: 0.25rem;
    }
</style>

<script>
    const token = localStorage.getItem("samprox_token");
    const user = JSON.parse(localStorage.getItem("samprox_user") || "null");

    if (!token || !user) {
        window.location.href = "/";
    }

    const allowedRoles = new Set(["sales_manager", "sales_executive"]);
    const normalizedRole = (user?.role || "").toLowerCase();
    if (!allowedRoles.has(normalizedRole)) {
        window.location.replace("/sales/data-entry");
    }

    const invoiceForm = document.getElementById("invoice-form");
    const invoiceError = document.getElementById("invoice-error");
    const invoiceSuccess = document.getElementById("invoice-success");
    const invoiceNoInput = document.getElementById("invoice-no");
    const invoiceDateInput = document.getElementById("invoice-date");
    const customerNameInput = document.getElementById("customer-name");
    const customerIdInput = document.getElementById("customer-id");
    const customerCityInput = document.getElementById("customer-city");
    const customerDistrictInput = document.getElementById("customer-district");
    const customerProvinceInput = document.getElementById("customer-province");
    const salesRepInput = document.getElementById("sales-rep");
    const lineItemsContainer = document.getElementById("line-items");
    const addLineButton = document.getElementById("add-line");
    const lineTemplate = document.getElementById("line-item-template");
    const totalQtyEl = document.getElementById("total-qty");
    const subtotalEl = document.getElementById("subtotal");
    const totalDiscountEl = document.getElementById("total-discount");
    const grandTotalEl = document.getElementById("grand-total");

    let itemOptions = [];
    let customerOptions = [];
    const customerLookup = new Map();
    let lineCounter = 0;

    salesRepInput.value = user?.name || "";
    invoiceDateInput.valueAsDate = new Date();

    const setError = (message) => {
        invoiceError.textContent = message;
        invoiceError.hidden = !message;
    };

    const setSuccess = (message) => {
        invoiceSuccess.textContent = message;
        invoiceSuccess.hidden = !message;
    };

    const formatMoney = (value) => {
        if (Number.isNaN(value) || value === null) {
            return "";
        }
        return value.toFixed(2);
    };

    const buildCustomerLabel = (customer) => {
        return customer.city ? `${customer.name} (${customer.city})` : customer.name;
    };

    const setCustomerLocationReadOnly = (isReadOnly) => {
        customerCityInput.readOnly = isReadOnly;
        customerDistrictInput.readOnly = isReadOnly;
        customerProvinceInput.readOnly = isReadOnly;
    };

    const clearCustomerSelection = () => {
        customerIdInput.value = "";
        customerCityInput.value = "";
        customerDistrictInput.value = "";
        customerProvinceInput.value = "";
        setCustomerLocationReadOnly(false);
    };

    const applyCustomerSelection = (customer) => {
        customerIdInput.value = customer.id;
        customerCityInput.value = customer.city || "";
        customerDistrictInput.value = customer.district || "";
        customerProvinceInput.value = customer.province || "";
        setCustomerLocationReadOnly(true);
    };

    const resolveCustomer = (value) => {
        if (!value) {
            return null;
        }
        const key = value.toLowerCase();
        if (customerLookup.has(key)) {
            return customerLookup.get(key);
        }
        return customerOptions.find((customer) => customer.name.toLowerCase() === key) || null;
    };

    const updateInvoiceTotals = () => {
        let totalQty = 0;
        let subtotal = 0;
        let totalDiscount = 0;
        let grandTotal = 0;

        lineItemsContainer.querySelectorAll(".line-item").forEach((line) => {
            const qty = Number.parseInt(line.querySelector('[data-field="qty"]').value || "0", 10);
            const mrp = Number.parseFloat(line.querySelector('[data-field="mrp"]').value || "0");
            const discountValue = Number.parseFloat(
                line.querySelector('[data-field="discount_value"]').value || "0",
            );
            const dealerPrice = Number.parseFloat(
                line.querySelector('[data-field="dealer_price"]').value || "0",
            );

            if (qty > 0) {
                totalQty += qty;
                subtotal += mrp * qty;
                totalDiscount += discountValue * qty;
                grandTotal += dealerPrice * qty;
            }
        });

        totalQtyEl.textContent = String(totalQty);
        subtotalEl.textContent = formatMoney(subtotal) || "0.00";
        totalDiscountEl.textContent = formatMoney(totalDiscount) || "0.00";
        grandTotalEl.textContent = formatMoney(grandTotal) || "0.00";
    };

    const getLineDiscountRate = (line) => {
        const selected = line.querySelector('[data-field="discount_rate"] input:checked');
        return selected ? Number.parseFloat(selected.value) : 0.26;
    };

    const updateLineTotals = (line) => {
        const mrpValue = Number.parseFloat(line.querySelector('[data-field="mrp"]').value || "0");
        const qtyValue = Number.parseInt(line.querySelector('[data-field="qty"]').value || "0", 10);
        const discountRate = getLineDiscountRate(line);
        const discountValueInput = line.querySelector('[data-field="discount_value"]');
        const dealerPriceInput = line.querySelector('[data-field="dealer_price"]');
        const lineTotalInput = line.querySelector('[data-field="line_total"]');

        if (!mrpValue) {
            discountValueInput.value = "";
            dealerPriceInput.value = "";
            lineTotalInput.value = "";
            updateInvoiceTotals();
            return;
        }

        const discountValue = mrpValue * discountRate;
        const dealerPrice = mrpValue - discountValue;
        discountValueInput.value = formatMoney(discountValue);
        dealerPriceInput.value = formatMoney(dealerPrice);
        if (qtyValue > 0) {
            lineTotalInput.value = formatMoney(dealerPrice * qtyValue);
        } else {
            lineTotalInput.value = "";
        }
        updateInvoiceTotals();
    };

    const getSelectedSerials = (line) => {
        const select = line.querySelector('[data-field="serial_numbers"]');
        const serials = Array.from(select.selectedOptions)
            .map((option) => option.value.trim())
            .filter((value) => value.length > 0);
        return Array.from(new Set(serials));
    };

    const updateSerialHelper = (line, serials = null) => {
        const qty = Number.parseInt(line.querySelector('[data-field="qty"]').value || "0", 10);
        const currentSerials = serials ?? getSelectedSerials(line);
        const helper = line.querySelector('[data-field="serial_count"]');
        let message = `Serial count: ${currentSerials.length}`;

        if (qty > 0) {
            if (currentSerials.length < qty) {
                message += ` — Need ${qty - currentSerials.length} more serials.`;
            } else if (currentSerials.length > qty) {
                message += ` — Remove ${currentSerials.length - qty} serials.`;
            }
        }

        helper.textContent = message;
    };

    const setSerialFieldState = (line, enabled) => {
        const serialSelect = line.querySelector('[data-field="serial_numbers"]');
        serialSelect.disabled = !enabled;
        if (!enabled) {
            serialSelect.innerHTML = "";
            updateSerialHelper(line, []);
        }
    };

    const syncSerialSelections = (line) => {
        const qty = Number.parseInt(line.querySelector('[data-field="qty"]').value || "0", 10);
        const serialSelect = line.querySelector('[data-field="serial_numbers"]');
        let serials = getSelectedSerials(line);

        if (qty > 0 && serials.length > qty) {
            serials.slice(qty).forEach((extra) => {
                const option = Array.from(serialSelect.options).find((entry) => entry.value === extra);
                if (option) {
                    option.selected = false;
                }
            });
            serials = getSelectedSerials(line);
        }

        updateSerialHelper(line, serials);
    };

    const populateItemOptions = (select, selectedValue = "") => {
        select.innerHTML = '<option value="">Select item</option>';
        itemOptions.forEach((item) => {
            const option = document.createElement("option");
            option.value = item.id;
            option.textContent = item.item_name;
            if (selectedValue && selectedValue === item.id) {
                option.selected = true;
            }
            select.appendChild(option);
        });
    };

    const addLineItem = (data = {}) => {
        const clone = lineTemplate.content.cloneNode(true);
        const line = clone.querySelector(".line-item");
        const lineId = `line-${Date.now()}-${lineCounter++}`;
        const itemSelect = line.querySelector('[data-field="item_id"]');
        const qtyInput = line.querySelector('[data-field="qty"]');
        const mrpInput = line.querySelector('[data-field="mrp"]');
        const serialsInput = line.querySelector('[data-field="serial_numbers"]');
        const discountInputs = line.querySelectorAll('[data-field="discount_rate"] input');
        const lineError = line.querySelector('[data-field="line_error"]');

        populateItemOptions(itemSelect, data.item_id || "");
        qtyInput.value = data.qty || "";
        mrpInput.value = data.mrp || "";
        discountInputs.forEach((input) => {
            input.name = `discount-rate-${lineId}`;
            if (data.trade_discount_rate) {
                input.checked = Number.parseFloat(input.value) === Number.parseFloat(data.trade_discount_rate);
            }
        });
        if (![...discountInputs].some((input) => input.checked)) {
            discountInputs[0].checked = true;
        }

        line.querySelector('[data-action="remove-line"]').addEventListener("click", () => {
            if (lineItemsContainer.querySelectorAll(".line-item").length <= 1) {
                setError("At least one invoice line is required.");
                return;
            }
            line.remove();
            updateInvoiceTotals();
        });

        itemSelect.addEventListener("change", () => {
            serialsInput.innerHTML = "";
            serialsInput.disabled = true;
            delete serialsInput.dataset.itemId;
            updateSerialHelper(line, []);
            updateLineTotals(line);
            refreshSerialAvailability(line);
        });

        [qtyInput, mrpInput].forEach((input) => {
            input.addEventListener("input", () => updateLineTotals(line));
        });
        discountInputs.forEach((input) => {
            input.addEventListener("change", () => updateLineTotals(line));
        });
        qtyInput.addEventListener("input", () => {
            refreshSerialAvailability(line);
            syncSerialSelections(line);
        });
        serialsInput.addEventListener("change", () => {
            syncSerialSelections(line);
        });

        lineError.hidden = true;
        setSerialFieldState(line, false);
        lineItemsContainer.appendChild(clone);
        updateLineTotals(line);
        updateSerialHelper(line, []);
    };

    const loadCustomers = async () => {
        try {
            const response = await fetch("/api/exsol/customers", {
                headers: { Authorization: `Bearer ${token}` },
            });
            if (!response.ok) {
                throw new Error("Unable to load customers.");
            }
            const customers = await response.json();
            customerOptions = (customers || []).map((customer) => ({
                id: String(customer.id),
                name: customer.name || customer.customer_name || "",
                city: customer.city || "",
                district: customer.district || "",
                province: customer.province || "",
            }));

            const datalist = document.getElementById("customer-options");
            datalist.innerHTML = "";
            customerLookup.clear();
            customerOptions.forEach((customer) => {
                const label = buildCustomerLabel(customer);
                const option = document.createElement("option");
                option.value = label;
                datalist.appendChild(option);
                customerLookup.set(label.toLowerCase(), customer);
                if (!customerLookup.has(customer.name.toLowerCase())) {
                    customerLookup.set(customer.name.toLowerCase(), customer);
                }
            });
        } catch (error) {
            setError(error.message || "Unable to load customers.");
        }
    };

    const loadItems = async () => {
        try {
            const response = await fetch("/api/exsol/sales/items", {
                headers: { Authorization: `Bearer ${token}` },
            });
            if (!response.ok) {
                throw new Error("Unable to load Exsol items.");
            }
            const items = await response.json();
            itemOptions = items || [];
            lineItemsContainer.querySelectorAll('[data-field="item_id"]').forEach((select) => {
                populateItemOptions(select, select.value);
            });
        } catch (error) {
            setError(error.message || "Unable to load items.");
        }
    };

    const refreshSerialAvailability = async (line) => {
        const itemId = line.querySelector('[data-field="item_id"]').value;
        const qty = Number.parseInt(line.querySelector('[data-field="qty"]').value || "0", 10);
        const serialSelect = line.querySelector('[data-field="serial_numbers"]');

        if (!itemId || qty <= 0) {
            setSerialFieldState(line, false);
            delete serialSelect.dataset.itemId;
            return;
        }

        setSerialFieldState(line, true);

        if (serialSelect.dataset.itemId === itemId && serialSelect.options.length) {
            syncSerialSelections(line);
            return;
        }

        try {
            const response = await fetch(`/api/exsol/serials/available?item_id=${encodeURIComponent(itemId)}`, {
                headers: { Authorization: `Bearer ${token}` },
            });
            if (!response.ok) {
                throw new Error("Unable to load serials.");
            }
            const data = await response.json();
            const serials = data?.serials || [];
            serialSelect.innerHTML = "";
            serials.forEach((serial) => {
                const option = document.createElement("option");
                option.value = serial;
                option.textContent = serial;
                serialSelect.appendChild(option);
            });
            serialSelect.dataset.itemId = itemId;
            syncSerialSelections(line);
        } catch (error) {
            setError(error.message || "Unable to load serials.");
            setSerialFieldState(line, false);
        }
    };

    addLineButton.addEventListener("click", () => {
        addLineItem();
    });

    customerNameInput.addEventListener("input", () => {
        const value = customerNameInput.value.trim();
        if (!value) {
            clearCustomerSelection();
            return;
        }
        const customer = resolveCustomer(value);
        if (customer) {
            customerNameInput.value = buildCustomerLabel(customer);
            applyCustomerSelection(customer);
        } else {
            clearCustomerSelection();
        }
    });

    customerNameInput.addEventListener("change", () => {
        const value = customerNameInput.value.trim();
        if (!value) {
            clearCustomerSelection();
            return;
        }
        const customer = resolveCustomer(value);
        if (customer) {
            customerNameInput.value = buildCustomerLabel(customer);
            applyCustomerSelection(customer);
        } else {
            clearCustomerSelection();
        }
    });

    invoiceForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        setError("");
        setSuccess("");

        const headerErrors = [];
        if (!invoiceNoInput.value.trim()) {
            headerErrors.push("Invoice No is required.");
        }
        if (!invoiceDateInput.value) {
            headerErrors.push("Invoice Date is required.");
        }
        if (!customerIdInput.value) {
            headerErrors.push("Customer is required.");
        }

        const lines = [];
        const lineErrors = [];
        const serialTracker = new Set();

        const lineItems = Array.from(lineItemsContainer.querySelectorAll(".line-item"));
        if (!lineItems.length) {
            headerErrors.push("Add at least one invoice line.");
        }

        lineItems.forEach((line) => {
            const errorMessages = [];
            const lineError = line.querySelector('[data-field="line_error"]');
            const itemId = line.querySelector('[data-field="item_id"]').value;
            const qty = Number.parseInt(line.querySelector('[data-field="qty"]').value || "0", 10);
            const mrp = Number.parseFloat(line.querySelector('[data-field="mrp"]').value || "0");
            const discountRate = getLineDiscountRate(line);
            const discountValue = Number.parseFloat(
                line.querySelector('[data-field="discount_value"]').value || "0",
            );
            const dealerPrice = Number.parseFloat(
                line.querySelector('[data-field="dealer_price"]').value || "0",
            );
            const serials = getSelectedSerials(line);

            if (!itemId) {
                errorMessages.push("Select an item.");
            }
            if (!qty || qty <= 0) {
                errorMessages.push("Quantity must be greater than zero.");
            }
            if (!serials.length) {
                errorMessages.push("Enter serial numbers.");
            } else if (qty && serials.length !== qty) {
                errorMessages.push("Serial count must match quantity.");
            }

            serials.forEach((serial) => {
                if (serialTracker.has(serial)) {
                    errorMessages.push("Duplicate serial numbers found across lines.");
                }
                serialTracker.add(serial);
            });

            if (!mrp) {
                errorMessages.push("MRP is required.");
            }

            lineError.textContent = errorMessages.join(" ");
            lineError.hidden = errorMessages.length === 0;
            lineErrors.push(errorMessages);

            lines.push({
                item_id: itemId,
                qty,
                mrp,
                trade_discount_rate: discountRate,
                discount_value: discountValue,
                dealer_price: dealerPrice,
                serial_numbers: serials,
            });
        });

        if (headerErrors.length || lineErrors.some((entry) => entry.length)) {
            const summaryError =
                headerErrors.join(" ") || "Please fix the highlighted invoice line errors.";
            setError(summaryError);
            return;
        }

        const payload = {
            invoice_no: invoiceNoInput.value.trim(),
            invoice_date: invoiceDateInput.value,
            customer_id: customerIdInput.value,
            lines,
        };

        try {
            const response = await fetch("/api/exsol/sales-invoices", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify(payload),
            });

            const data = await response.json().catch(() => ({}));
            if (!response.ok) {
                const errorText =
                    data?.errors?.invoice_no ||
                    data?.errors?.serial_numbers ||
                    data?.errors?.lines ||
                    data?.error ||
                    "Unable to save invoice.";
                throw new Error(errorText);
            }

            setSuccess("Invoice saved successfully.");
            invoiceForm.reset();
            salesRepInput.value = user?.name || "";
            invoiceDateInput.valueAsDate = new Date();
            clearCustomerSelection();
            lineItemsContainer.innerHTML = "";
            addLineItem();
            updateInvoiceTotals();
        } catch (error) {
            setError(error.message || "Unable to save invoice.");
        }
    });

    loadCustomers();
    loadItems();
    addLineItem();
    updateInvoiceTotals();
</script>
{% endblock %}
