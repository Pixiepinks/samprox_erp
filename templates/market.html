<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Market | SAMPROX ERP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" />
</head>
<body>
    <div class="page">
        <header class="topbar">
            <div class="brand">
                <div class="brand__logo">S</div>
                <div class="brand__details">
                    <p class="brand__name">SAMPROX ERP</p>
                    <p class="brand__section">Market Insights</p>
                </div>
            </div>
            <div class="topbar__actions">
                <a class="button button--ghost" href="{{ url_for('ui.mind_page') }}">Mind</a>
                <div class="user-summary">
                    <span class="user-summary__name" id="user-name"></span>
                    <span class="user-summary__role" id="user-role"></span>
                </div>
                <button type="button" class="button button--secondary" id="logout">Sign out</button>
            </div>
        </header>
        <nav class="subnav" aria-label="7M navigation">
            <a class="subnav__link" href="{{ url_for('ui.mind_page') }}">Mind</a>
            <a class="subnav__link" href="{{ url_for('ui.man_page') }}">Man</a>
            <a class="subnav__link" href="{{ url_for('ui.machines_page') }}">Machine</a>
            <a class="subnav__link" href="{{ url_for('ui.material_page') }}">Material</a>
            <a class="subnav__link subnav__link--active" href="{{ url_for('ui.market_page') }}">Market</a>
            <a class="subnav__link" href="{{ url_for('ui.manufacturing_page') }}">Manufacturing</a>
            <a class="subnav__link" href="{{ url_for('ui.money_page') }}">Money</a>
        </nav>
        <section class="section">
            <header class="section__header">
                <h1>Demand & customer alignment</h1>
            </header>
            <p class="section__description">
                Keep production aligned with market demand by reviewing orders, forecasts, and customer
                feedback. Use this page to coordinate priorities across sales, production, and service.
            </p>
            <div class="section__grid">
                <article class="tile">
                    <h2 class="tile__title">Sales pipeline</h2>
                    <p class="tile__description">
                        Track upcoming orders and opportunities to plan capacity and inventory.
                    </p>
                </article>
                <article class="tile">
                    <h2 class="tile__title">Customer feedback</h2>
                    <p class="tile__description">
                        Collect insights from support tickets and surveys to improve service quality.
                    </p>
                </article>
                <article class="tile">
                    <h2 class="tile__title">Competitor watch</h2>
                    <p class="tile__description">
                        Highlight market trends and competitor moves that influence pricing or demand.
                    </p>
                </article>
                <article class="tile">
                    <h2 class="tile__title">Promotion calendar</h2>
                    <p class="tile__description">
                        Coordinate marketing campaigns with production capabilities to avoid bottlenecks.
                    </p>
                </article>
            </div>
            <article class="production-card sales-entry" aria-labelledby="sales-entry-title">
                <div>
                    <h2 id="sales-entry-title">Record sales entry</h2>
                    <p class="sales-entry__subtitle">
                        Capture forecasted or actual sales to instantly refresh the performance report below.
                    </p>
                </div>
                <form id="sales-entry-form" class="sales-entry__form" aria-label="Record sales entry">
                    <label class="sales-entry__field" for="sales-entry-date">
                        <span class="sales-entry__label">Date</span>
                        <input type="date" id="sales-entry-date" name="date" class="sales-entry__input" required />
                    </label>
                    <div class="sales-entry__field sales-entry__field--customer">
                        <label class="sales-entry__label" for="sales-entry-customer">Customer</label>
                        <div class="sales-entry__customer-controls">
                            <select
                                id="sales-entry-customer"
                                name="customer_id"
                                class="sales-entry__select"
                                required
                            ></select>
                            <button
                                type="button"
                                class="button button--ghost sales-entry__add-customer"
                                id="sales-entry-add-customer"
                            >
                                Add new customer
                            </button>
                        </div>
                    </div>
                    <label class="sales-entry__field" for="sales-entry-type">
                        <span class="sales-entry__label">Entry type</span>
                        <select id="sales-entry-type" name="sale_type" class="sales-entry__select" required>
                            <option value="actual">Actual sale</option>
                            <option value="forecast">Forecast sale</option>
                        </select>
                    </label>
                    <label class="sales-entry__field" for="sales-entry-unit-price">
                        <span class="sales-entry__label">Unit price (Rs/Ton)</span>
                        <input
                            type="number"
                            id="sales-entry-unit-price"
                            name="unit_price"
                            class="sales-entry__input"
                            inputmode="decimal"
                            step="0.01"
                            min="0"
                            placeholder="0.00"
                            required
                        />
                    </label>
                    <label class="sales-entry__field" for="sales-entry-quantity">
                        <span class="sales-entry__label">Quantity (Tons)</span>
                        <input
                            type="number"
                            id="sales-entry-quantity"
                            name="quantity_tons"
                            class="sales-entry__input"
                            inputmode="decimal"
                            step="0.01"
                            min="0"
                            placeholder="0.00"
                            required
                        />
                    </label>
                    <div class="sales-entry__field">
                        <span class="sales-entry__label">Sales value (Rs)</span>
                        <output id="sales-entry-total" class="sales-entry__total" aria-live="polite">0.00</output>
                    </div>
                    <div class="sales-entry__actions">
                        <button type="submit" class="button" id="sales-entry-submit">Save entry</button>
                    </div>
                </form>
                <p id="sales-entry-feedback" class="sales-entry__feedback" role="status" aria-live="polite"></p>
            </article>
            <dialog id="customer-dialog" class="modal" aria-labelledby="customer-dialog-title">
                <form id="customer-form" class="modal__form">
                    <header class="modal__header">
                        <h2 id="customer-dialog-title" class="modal__title">Add new customer</h2>
                        <p class="modal__subtitle">Customer ID will be assigned automatically (e.g. 00001).</p>
                    </header>
                    <div class="modal__grid">
                        <label class="modal__field" for="customer-name">
                            <span class="modal__label">Customer name</span>
                            <input id="customer-name" name="name" type="text" class="modal__input" required />
                        </label>
                        <label class="modal__field" for="customer-category">
                            <span class="modal__label">Category</span>
                            <select id="customer-category" name="category" class="modal__select" required></select>
                        </label>
                        <label class="modal__field" for="customer-credit-term">
                            <span class="modal__label">Credit term</span>
                            <select id="customer-credit-term" name="credit_term" class="modal__select" required></select>
                        </label>
                        <label class="modal__field" for="customer-transport-mode">
                            <span class="modal__label">Transport mode</span>
                            <select id="customer-transport-mode" name="transport_mode" class="modal__select" required></select>
                        </label>
                        <label class="modal__field" for="customer-type">
                            <span class="modal__label">Type</span>
                            <select id="customer-type" name="customer_type" class="modal__select" required></select>
                        </label>
                        <label class="modal__field" for="customer-sales-coordinator-name">
                            <span class="modal__label">Sales coordinator name</span>
                            <input
                                id="customer-sales-coordinator-name"
                                name="sales_coordinator_name"
                                type="text"
                                class="modal__input"
                                required
                            />
                        </label>
                        <label class="modal__field" for="customer-sales-coordinator-phone">
                            <span class="modal__label">Sales coordinator telephone</span>
                            <input
                                id="customer-sales-coordinator-phone"
                                name="sales_coordinator_phone"
                                type="tel"
                                class="modal__input"
                                required
                            />
                        </label>
                        <label class="modal__field" for="customer-store-keeper-name">
                            <span class="modal__label">Store keeper name</span>
                            <input
                                id="customer-store-keeper-name"
                                name="store_keeper_name"
                                type="text"
                                class="modal__input"
                                required
                            />
                        </label>
                        <label class="modal__field" for="customer-store-keeper-phone">
                            <span class="modal__label">Store keeper telephone</span>
                            <input
                                id="customer-store-keeper-phone"
                                name="store_keeper_phone"
                                type="tel"
                                class="modal__input"
                                required
                            />
                        </label>
                        <label class="modal__field" for="customer-payment-coordinator-name">
                            <span class="modal__label">Payment coordinator name</span>
                            <input
                                id="customer-payment-coordinator-name"
                                name="payment_coordinator_name"
                                type="text"
                                class="modal__input"
                                required
                            />
                        </label>
                        <label class="modal__field" for="customer-payment-coordinator-phone">
                            <span class="modal__label">Payment coordinator telephone</span>
                            <input
                                id="customer-payment-coordinator-phone"
                                name="payment_coordinator_phone"
                                type="tel"
                                class="modal__input"
                                required
                            />
                        </label>
                        <label class="modal__field modal__field--full" for="customer-special-note">
                            <span class="modal__label">Special note</span>
                            <textarea
                                id="customer-special-note"
                                name="special_note"
                                class="modal__textarea"
                                rows="3"
                                required
                            ></textarea>
                        </label>
                    </div>
                    <p id="customer-form-feedback" class="modal__feedback" role="status" aria-live="polite"></p>
                    <div class="modal__actions">
                        <button type="button" class="button button--secondary" id="customer-form-cancel">Cancel</button>
                        <button type="submit" class="button" id="customer-form-submit">Save customer</button>
                    </div>
                </form>
            </dialog>
            <article class="production-card sales-report" aria-labelledby="sales-report-title">
                <div class="production-card__header">
                    <div>
                        <h2 id="sales-report-title">Customer sales performance</h2>
                        <p id="sales-report-subtitle" class="sales-report__subtitle">
                            Select a month and year to compare forecasted versus actual sales by customer.
                        </p>
                    </div>
                    <form id="sales-report-form" class="sales-report__controls" aria-label="Customer sales filters">
                        <label class="sales-report__field" for="sales-report-month">
                            <span class="sales-report__label">Month</span>
                            <select id="sales-report-month" name="month" class="sales-report__input" required></select>
                        </label>
                        <label class="sales-report__field" for="sales-report-year">
                            <span class="sales-report__label">Year</span>
                            <select id="sales-report-year" name="year" class="sales-report__input" required></select>
                        </label>
                        <label class="sales-report__field" for="sales-report-customer">
                            <span class="sales-report__label">Customer</span>
                            <select id="sales-report-customer" name="customer_id" class="sales-report__input">
                                <option value="">All customers</option>
                            </select>
                        </label>
                        <button type="submit" class="button" id="sales-report-submit">Load report</button>
                    </form>
                </div>
                <p id="sales-report-feedback" class="sales-report__feedback" role="status" aria-live="polite"></p>
                <div id="sales-report-results" class="sales-report__results" aria-live="polite"></div>
            </article>
        </section>
    </div>
    <script>
        const token = localStorage.getItem("samprox_token");
        const userRaw = localStorage.getItem("samprox_user");
        let user;

        try {
            user = userRaw ? JSON.parse(userRaw) : null;
        } catch (_) {
            user = null;
        }

        if (!token || !user) {
            window.location.href = "/";
        }

        const roleLabels = {
            admin: "Admin",
            production_manager: "Production Manager",
            maintenance_manager: "Maintenance Manager",
            technician: "Technician",
        };

        const userNameEl = document.getElementById("user-name");
        const userRoleEl = document.getElementById("user-role");
        const logoutButton = document.getElementById("logout");
        const entryForm = document.getElementById("sales-entry-form");
        const entryDateInput = document.getElementById("sales-entry-date");
        const entryCustomerSelect = document.getElementById("sales-entry-customer");
        const entryAddCustomerButton = document.getElementById("sales-entry-add-customer");
        const entryTypeSelect = document.getElementById("sales-entry-type");
        const entryUnitPriceInput = document.getElementById("sales-entry-unit-price");
        const entryQuantityInput = document.getElementById("sales-entry-quantity");
        const entryTotalOutput = document.getElementById("sales-entry-total");
        const entryFeedbackEl = document.getElementById("sales-entry-feedback");
        const entrySubmitButton = document.getElementById("sales-entry-submit");
        const customerDialog = document.getElementById("customer-dialog");
        const customerForm = document.getElementById("customer-form");
        const customerFormSubmit = document.getElementById("customer-form-submit");
        const customerFormCancel = document.getElementById("customer-form-cancel");
        const customerFormFeedback = document.getElementById("customer-form-feedback");
        const customerCategorySelect = document.getElementById("customer-category");
        const customerCreditTermSelect = document.getElementById("customer-credit-term");
        const customerTransportSelect = document.getElementById("customer-transport-mode");
        const customerTypeSelect = document.getElementById("customer-type");
        const customerNameInput = document.getElementById("customer-name");
        const customerSalesCoordinatorName = document.getElementById("customer-sales-coordinator-name");
        const customerSalesCoordinatorPhone = document.getElementById("customer-sales-coordinator-phone");
        const customerStoreKeeperName = document.getElementById("customer-store-keeper-name");
        const customerStoreKeeperPhone = document.getElementById("customer-store-keeper-phone");
        const customerPaymentCoordinatorName = document.getElementById("customer-payment-coordinator-name");
        const customerPaymentCoordinatorPhone = document.getElementById("customer-payment-coordinator-phone");
        const customerSpecialNote = document.getElementById("customer-special-note");
        const addCustomerOptionValue = "__create__";

        function handleUnauthorized() {
            localStorage.removeItem("samprox_token");
            localStorage.removeItem("samprox_user");
            window.location.href = "/";
        }

        userNameEl.textContent = user?.name || "Unknown";
        userRoleEl.textContent = roleLabels[user?.role] || "";

        logoutButton.addEventListener("click", () => {
            handleUnauthorized();
        });

        const monthNames = [
            "January",
            "February",
            "March",
            "April",
            "May",
            "June",
            "July",
            "August",
            "September",
            "October",
            "November",
            "December",
        ];

        const reportForm = document.getElementById("sales-report-form");
        const monthSelect = document.getElementById("sales-report-month");
        const yearSelect = document.getElementById("sales-report-year");
        const customerSelect = document.getElementById("sales-report-customer");
        const submitButton = document.getElementById("sales-report-submit");
        const feedbackEl = document.getElementById("sales-report-feedback");
        const resultsEl = document.getElementById("sales-report-results");
        const subtitleEl = document.getElementById("sales-report-subtitle");

        const customerCategoryOptions = [
            { value: "plantation", label: "Plantation" },
            { value: "industrial", label: "Industrial" },
        ];
        const customerCreditTermOptions = [
            { value: "cash", label: "Cash" },
            { value: "14_days", label: "14 Days" },
            { value: "30_days", label: "30 Days" },
            { value: "45_days", label: "45 Days" },
            { value: "60_days", label: "60 Days" },
        ];
        const customerTransportOptions = [
            { value: "samprox_lorry", label: "Samprox lorry" },
            { value: "customer_lorry", label: "Customer lorry" },
        ];
        const customerTypeOptions = [
            { value: "regular", label: "Regular" },
            { value: "seasonal", label: "Seasonal" },
        ];

        const knownCustomers = new Map();
        const numberFormatter = new Intl.NumberFormat(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
        });

        function populateSelectOptions(select, options) {
            if (!select) {
                return;
            }
            select.innerHTML = "";
            options.forEach((option) => {
                const el = document.createElement("option");
                el.value = option.value;
                el.textContent = option.label;
                select.appendChild(el);
            });
        }

        function populateCustomerFormOptions() {
            populateSelectOptions(customerCategorySelect, customerCategoryOptions);
            populateSelectOptions(customerCreditTermSelect, customerCreditTermOptions);
            populateSelectOptions(customerTransportSelect, customerTransportOptions);
            populateSelectOptions(customerTypeSelect, customerTypeOptions);
        }

        function formatAmount(value) {
            return numberFormatter.format(value || 0);
        }

        function updateSubtitle(year, month) {
            if (!subtitleEl) {
                return;
            }
            if (!year || !month) {
                subtitleEl.textContent =
                    "Select a month and year to compare forecasted versus actual sales by customer.";
                return;
            }
            const monthIndex = Math.max(1, Math.min(12, Number(month))) - 1;
            const monthName = monthNames[monthIndex] || "";
            subtitleEl.textContent = `${monthName} ${year}`.trim();
        }

        function setFeedback(message, variant = "info") {
            if (!feedbackEl) {
                return;
            }

            const variants = ["sales-report__feedback--error", "sales-report__feedback--success", "sales-report__feedback--info"];
            feedbackEl.classList.remove("sales-report__feedback--visible", ...variants);

            if (!message) {
                feedbackEl.textContent = "";
                return;
            }

            feedbackEl.textContent = message;
            if (variant === "error") {
                feedbackEl.classList.add("sales-report__feedback--error");
            } else if (variant === "success") {
                feedbackEl.classList.add("sales-report__feedback--success");
            } else {
                feedbackEl.classList.add("sales-report__feedback--info");
            }
            feedbackEl.classList.add("sales-report__feedback--visible");
        }

        function setEntryFeedback(message, variant = "info") {
            if (!entryFeedbackEl) {
                return;
            }

            const variants = ["sales-entry__feedback--error", "sales-entry__feedback--success"];
            entryFeedbackEl.classList.remove("sales-entry__feedback--visible", ...variants);

            if (!message) {
                entryFeedbackEl.textContent = "";
                return;
            }

            entryFeedbackEl.textContent = message;
            if (variant === "error") {
                entryFeedbackEl.classList.add("sales-entry__feedback--error");
            } else if (variant === "success") {
                entryFeedbackEl.classList.add("sales-entry__feedback--success");
            }
            entryFeedbackEl.classList.add("sales-entry__feedback--visible");
        }

        function formatCustomerLabel(customer) {
            if (!customer) {
                return "";
            }
            return customer.code ? `${customer.code} — ${customer.name}` : customer.name;
        }

        function normalizeCustomer(customer) {
            if (!customer) {
                return null;
            }

            const id = customer.id ?? customer.customer_id;
            const name = customer.name ?? customer.customer_name;
            if (!id || !name) {
                return null;
            }

            return {
                ...customer,
                id: String(id),
                name,
                code: customer.code ?? customer.customer_code ?? null,
            };
        }

        function registerCustomers(customers) {
            if (!Array.isArray(customers)) {
                return;
            }

            let hasUpdates = false;
            customers.forEach((customer) => {
                const normalized = normalizeCustomer(customer);
                if (!normalized) {
                    return;
                }
                knownCustomers.set(normalized.id, normalized);
            });
        }

        function refreshCustomerSelectors() {
            const sorted = Array.from(knownCustomers.values()).sort((a, b) =>
                (a.name || "").localeCompare(b.name || "")
            );

            if (customerSelect) {
                const previousValue = customerSelect.value;
                customerSelect.innerHTML = "";
                const defaultOption = document.createElement("option");
                defaultOption.value = "";
                defaultOption.textContent = "All customers";
                customerSelect.appendChild(defaultOption);

                sorted.forEach((customer) => {
                    const option = document.createElement("option");
                    option.value = customer.id;
                    option.textContent = formatCustomerLabel(customer);
                    customerSelect.appendChild(option);
                });

                if (previousValue && customerSelect.querySelector(`option[value="${previousValue}"]`)) {
                    customerSelect.value = previousValue;
                }
            }

            if (entryCustomerSelect) {
                const previousValue =
                    entryCustomerSelect.value && entryCustomerSelect.value !== addCustomerOptionValue
                        ? entryCustomerSelect.value
                        : "";
                entryCustomerSelect.innerHTML = "";

                const placeholderOption = document.createElement("option");
                placeholderOption.value = "";
                placeholderOption.textContent = "Select a customer";
                entryCustomerSelect.appendChild(placeholderOption);

                const createOption = document.createElement("option");
                createOption.value = addCustomerOptionValue;
                createOption.textContent = "➕ Add new customer";
                entryCustomerSelect.appendChild(createOption);

                sorted.forEach((customer) => {
                    const option = document.createElement("option");
                    option.value = customer.id;
                    option.textContent = formatCustomerLabel(customer);
                    entryCustomerSelect.appendChild(option);
                });

                if (previousValue && entryCustomerSelect.querySelector(`option[value="${previousValue}"]`)) {
                    entryCustomerSelect.value = previousValue;
                } else {
                    entryCustomerSelect.value = "";
                }
            }
        }

        function updateCustomerOptions(customers) {
            registerCustomers(customers);
            refreshCustomerSelectors();
        }

            if (!hasUpdates && customerSelect.options.length > 0) {
                return;
            }

            const unit = Number.parseFloat(entryUnitPriceInput?.value ?? "0");
            const quantity = Number.parseFloat(entryQuantityInput?.value ?? "0");
            const safeUnit = Number.isFinite(unit) ? unit : 0;
            const safeQuantity = Number.isFinite(quantity) ? quantity : 0;
            const total = safeUnit * safeQuantity;
            entryTotalOutput.textContent = numberFormatter.format(total || 0);
        }

        async function createCustomer(customerData) {
            if (!token) {
                return null;
            }

            const response = await fetch("/api/market/customers", {
                method: "POST",
                headers: {
                    Authorization: `Bearer ${token}`,
                    "Content-Type": "application/json",
                    Accept: "application/json",
                },
                body: JSON.stringify(customerData),
            });

            if (response.status === 401) {
                handleUnauthorized();
                return null;
            }

            const data = await response.json().catch(() => ({}));
            if (!response.ok) {
                if (response.status === 409 && data.customer) {
                    return { customer: data.customer, alreadyExists: true };
                }
                throw new Error(data.msg || "Unable to create customer.");
            }

            return { customer: data.customer, alreadyExists: false };
        }

        async function loadCustomers() {
            if (!token) {
                refreshCustomerSelectors();
                return;
            }

            try {
                const response = await fetch("/api/market/customers", {
                    headers: {
                        Authorization: `Bearer ${token}`,
                        Accept: "application/json",
                    },
                });

                if (response.status === 401) {
                    handleUnauthorized();
                    return;
                }

                if (!response.ok) {
                    throw new Error("Unable to load customers");
                }

                const data = await response.json();
                registerCustomers(data.customers || []);
            } catch (error) {
                console.error(error);
            } finally {
                refreshCustomerSelectors();
            }
        }

        function closeCustomerDialog() {
            if (!customerDialog) {
                return;
            }
            if (typeof customerDialog.close === "function") {
                customerDialog.close();
            } else {
                customerDialog.removeAttribute("open");
            }
        }

        function resetCustomerForm() {
            if (customerForm) {
                customerForm.reset();
            }
            setCustomerFormFeedback("");
        }

        function setCustomerFormFeedback(message, variant = "error") {
            if (!customerFormFeedback) {
                return;
            }
            customerFormFeedback.textContent = message || "";
            customerFormFeedback.classList.remove(
                "modal__feedback--visible",
                "modal__feedback--error",
                "modal__feedback--success",
            );

            if (!message) {
                return;
            }

            if (variant === "success") {
                customerFormFeedback.classList.add("modal__feedback--success");
            } else {
                customerFormFeedback.classList.add("modal__feedback--error");
            }
            customerFormFeedback.classList.add("modal__feedback--visible");
        }

        function openCustomerDialog() {
            resetCustomerForm();
            populateCustomerFormOptions();
            if (customerDialog) {
                if (typeof customerDialog.showModal === "function") {
                    customerDialog.showModal();
                } else {
                    customerDialog.setAttribute("open", "");
                }
            }
            customerNameInput?.focus();
        }

        if (customerDialog) {
            customerDialog.addEventListener("cancel", (event) => {
                event.preventDefault();
                closeCustomerDialog();
                resetCustomerForm();
                if (entryCustomerSelect && entryCustomerSelect.value === addCustomerOptionValue) {
                    entryCustomerSelect.value = "";
                }
            });
            customerDialog.addEventListener("close", () => {
                if (entryCustomerSelect && entryCustomerSelect.value === addCustomerOptionValue) {
                    entryCustomerSelect.value = "";
                }
            });
        }

        if (entryCustomerSelect) {
            entryCustomerSelect.addEventListener("change", (event) => {
                if (event.target.value !== addCustomerOptionValue) {
                    return;
                }
                event.target.value = "";
                openCustomerDialog();
            });
        }

        if (entryAddCustomerButton) {
            entryAddCustomerButton.addEventListener("click", () => {
                openCustomerDialog();
            });
        }

        if (customerFormCancel) {
            customerFormCancel.addEventListener("click", (event) => {
                event.preventDefault();
                closeCustomerDialog();
                resetCustomerForm();
                if (entryCustomerSelect && entryCustomerSelect.value === addCustomerOptionValue) {
                    entryCustomerSelect.value = "";
                }
            });
        }

        function collectCustomerFormData() {
            const payload = {
                name: customerNameInput?.value?.trim() || "",
                category: customerCategorySelect?.value || "",
                credit_term: customerCreditTermSelect?.value || "",
                transport_mode: customerTransportSelect?.value || "",
                customer_type: customerTypeSelect?.value || "",
                sales_coordinator_name: customerSalesCoordinatorName?.value?.trim() || "",
                sales_coordinator_phone: customerSalesCoordinatorPhone?.value?.trim() || "",
                store_keeper_name: customerStoreKeeperName?.value?.trim() || "",
                store_keeper_phone: customerStoreKeeperPhone?.value?.trim() || "",
                payment_coordinator_name: customerPaymentCoordinatorName?.value?.trim() || "",
                payment_coordinator_phone: customerPaymentCoordinatorPhone?.value?.trim() || "",
                special_note: customerSpecialNote?.value?.trim() || "",
            };

            return payload;
        }

        if (customerForm) {
            customerForm.addEventListener("submit", async (event) => {
                event.preventDefault();
                if (!customerForm.checkValidity()) {
                    customerForm.reportValidity();
                    return;
                }

                const payload = collectCustomerFormData();
                const values = Object.values(payload);
                if (values.some((value) => value === "")) {
                    setCustomerFormFeedback("All fields are required.", "error");
                    return;
                }

                setCustomerFormFeedback("");
                if (customerFormSubmit) {
                    customerFormSubmit.disabled = true;
                }

                try {
                    const result = await createCustomer(payload);
                    if (!result || !result.customer) {
                        throw new Error("Unable to create customer.");
                    }

                    const { customer, alreadyExists } = result;
                    registerCustomers([customer]);
                    refreshCustomerSelectors();
                    closeCustomerDialog();
                    resetCustomerForm();

                    const customerIdValue = customer.id ?? customer.customer_id;
                    if (entryCustomerSelect && customerIdValue) {
                        entryCustomerSelect.value = String(customerIdValue);
                    }

                    const code = customer.code ?? customer.customer_code ?? customerIdValue;
                    const message = alreadyExists
                        ? `Customer "${customer.name}" already exists and is ready to use.`
                        : `Customer "${customer.name}" (ID ${code}) created successfully.`;
                    setEntryFeedback(message, "success");
                } catch (error) {
                    console.error(error);
                    setCustomerFormFeedback(error?.message || "Unable to create customer.");
                } finally {
                    if (customerFormSubmit) {
                        customerFormSubmit.disabled = false;
                    }
                }
            });
        }

        function setCustomerFormFeedback(message, variant = "error") {
            if (!customerFormFeedback) {
                return;
            }
            customerFormFeedback.textContent = message || "";
            customerFormFeedback.classList.remove(
                "modal__feedback--visible",
                "modal__feedback--error",
                "modal__feedback--success",
            );

            if (!message) {
                return;
            }

            if (variant === "success") {
                customerFormFeedback.classList.add("modal__feedback--success");
            } else {
                customerFormFeedback.classList.add("modal__feedback--error");
            }
            customerFormFeedback.classList.add("modal__feedback--visible");
        }

        function openCustomerDialog() {
            resetCustomerForm();
            populateCustomerFormOptions();
            if (customerDialog) {
                if (typeof customerDialog.showModal === "function") {
                    customerDialog.showModal();
                } else {
                    customerDialog.setAttribute("open", "");
                }
            }
            customerNameInput?.focus();
        }

        if (customerDialog) {
            customerDialog.addEventListener("cancel", (event) => {
                event.preventDefault();
                closeCustomerDialog();
                resetCustomerForm();
                if (entryCustomerSelect && entryCustomerSelect.value === addCustomerOptionValue) {
                    entryCustomerSelect.value = "";
                }
            });
            customerDialog.addEventListener("close", () => {
                if (entryCustomerSelect && entryCustomerSelect.value === addCustomerOptionValue) {
                    entryCustomerSelect.value = "";
                }
            });
        }

        if (entryCustomerSelect) {
            entryCustomerSelect.addEventListener("change", (event) => {
                if (event.target.value !== addCustomerOptionValue) {
                    return;
                }
                event.target.value = "";
                openCustomerDialog();
            });
        }

        if (customerFormCancel) {
            customerFormCancel.addEventListener("click", (event) => {
                event.preventDefault();
                closeCustomerDialog();
                resetCustomerForm();
                if (entryCustomerSelect && entryCustomerSelect.value === addCustomerOptionValue) {
                    entryCustomerSelect.value = "";
                }
            });
        }

        function collectCustomerFormData() {
            const payload = {
                name: customerNameInput?.value?.trim() || "",
                category: customerCategorySelect?.value || "",
                credit_term: customerCreditTermSelect?.value || "",
                transport_mode: customerTransportSelect?.value || "",
                customer_type: customerTypeSelect?.value || "",
                sales_coordinator_name: customerSalesCoordinatorName?.value?.trim() || "",
                sales_coordinator_phone: customerSalesCoordinatorPhone?.value?.trim() || "",
                store_keeper_name: customerStoreKeeperName?.value?.trim() || "",
                store_keeper_phone: customerStoreKeeperPhone?.value?.trim() || "",
                payment_coordinator_name: customerPaymentCoordinatorName?.value?.trim() || "",
                payment_coordinator_phone: customerPaymentCoordinatorPhone?.value?.trim() || "",
                special_note: customerSpecialNote?.value?.trim() || "",
            };

            return payload;
        }

        if (customerForm) {
            customerForm.addEventListener("submit", async (event) => {
                event.preventDefault();
                if (!customerForm.checkValidity()) {
                    customerForm.reportValidity();
                    return;
                }

                const payload = collectCustomerFormData();
                const values = Object.values(payload);
                if (values.some((value) => value === "")) {
                    setCustomerFormFeedback("All fields are required.", "error");
                    return;
                }

                setCustomerFormFeedback("");
                if (customerFormSubmit) {
                    customerFormSubmit.disabled = true;
                }

                try {
                    const result = await createCustomer(payload);
                    if (!result || !result.customer) {
                        throw new Error("Unable to create customer.");
                    }

                    const { customer, alreadyExists } = result;
                    registerCustomers([customer]);
                    refreshCustomerSelectors();
                    closeCustomerDialog();
                    resetCustomerForm();

                    const customerIdValue = customer.id ?? customer.customer_id;
                    if (entryCustomerSelect && customerIdValue) {
                        entryCustomerSelect.value = String(customerIdValue);
                    }

                    const code = customer.code ?? customer.customer_code ?? customerIdValue;
                    const message = alreadyExists
                        ? `Customer "${customer.name}" already exists and is ready to use.`
                        : `Customer "${customer.name}" (ID ${code}) created successfully.`;
                    setEntryFeedback(message, "success");
                } catch (error) {
                    console.error(error);
                    setCustomerFormFeedback(error?.message || "Unable to create customer.");
                } finally {
                    if (customerFormSubmit) {
                        customerFormSubmit.disabled = false;
                    }
                }
            });

            if (currentValue && knownCustomers.has(Number(currentValue))) {
                customerSelect.value = currentValue;
            }
        }

        populateCustomerFormOptions();
        refreshCustomerSelectors();
        loadCustomers();

        function renderCustomer(customer) {
            const card = document.createElement("article");
            card.className = "sales-report__customer";

            const header = document.createElement("div");
            header.className = "sales-report__customer-header";

            const headingWrapper = document.createElement("div");
            const nameEl = document.createElement("h3");
            nameEl.className = "sales-report__customer-name";
            nameEl.textContent = customer.customer_name;
            headingWrapper.appendChild(nameEl);

            const summaryEl = document.createElement("p");
            summaryEl.className = "sales-report__customer-summary";
            summaryEl.textContent = "Daily comparison of forecasted and actual sales.";
            headingWrapper.appendChild(summaryEl);

            const totals = document.createElement("dl");
            totals.className = "sales-report__totals";

            const variance = customer.monthly_actual_total - customer.monthly_forecast_total;
            const totalsConfig = [
                { label: "Forecast", value: customer.monthly_forecast_total },
                { label: "Actual", value: customer.monthly_actual_total },
                { label: "Variance", value: variance },
            ];

            totalsConfig.forEach(({ label, value }) => {
                const group = document.createElement("div");
                group.className = "sales-report__totals-item";
                const dt = document.createElement("dt");
                dt.textContent = label;
                const dd = document.createElement("dd");
                dd.textContent = formatAmount(value);
                dd.className = "sales-report__totals-value";
                if (label === "Variance") {
                    if (value > 0) {
                        dd.classList.add("sales-report__variance--positive");
                    } else if (value < 0) {
                        dd.classList.add("sales-report__variance--negative");
                    }
                }
                group.appendChild(dt);
                group.appendChild(dd);
                totals.appendChild(group);
            });

            header.appendChild(headingWrapper);
            header.appendChild(totals);
            card.appendChild(header);

            const table = document.createElement("table");
            table.className = "sales-report__table";

            const thead = document.createElement("thead");
            const headRow = document.createElement("tr");
            ["Date", "Forecast", "Actual", "Variance"].forEach((label, index) => {
                const th = document.createElement("th");
                th.textContent = label;
                if (index > 0) {
                    th.className = "sales-report__cell--numeric";
                }
                headRow.appendChild(th);
            });
            thead.appendChild(headRow);
            table.appendChild(thead);

            const tbody = document.createElement("tbody");

            if (!customer.dates.length) {
                const row = document.createElement("tr");
                const cell = document.createElement("td");
                cell.colSpan = 4;
                cell.className = "sales-report__empty-row";
                cell.textContent = "No sales recorded for this customer.";
                row.appendChild(cell);
                tbody.appendChild(row);
            } else {
                customer.dates.forEach((entry) => {
                    const row = document.createElement("tr");

                    const dateCell = document.createElement("td");
                    dateCell.textContent = entry.date;
                    row.appendChild(dateCell);

                    const forecastCell = document.createElement("td");
                    forecastCell.textContent = formatAmount(entry.forecast_amount);
                    forecastCell.className = "sales-report__cell--numeric";
                    row.appendChild(forecastCell);

                    const actualCell = document.createElement("td");
                    actualCell.textContent = formatAmount(entry.actual_amount);
                    actualCell.className = "sales-report__cell--numeric";
                    row.appendChild(actualCell);

                    const varianceValue = entry.actual_amount - entry.forecast_amount;
                    const varianceCell = document.createElement("td");
                    varianceCell.textContent = formatAmount(varianceValue);
                    varianceCell.className = "sales-report__cell--numeric";
                    if (varianceValue > 0) {
                        varianceCell.classList.add("sales-report__variance--positive");
                    } else if (varianceValue < 0) {
                        varianceCell.classList.add("sales-report__variance--negative");
                    }
                    row.appendChild(varianceCell);

                    tbody.appendChild(row);
                });
            }

            table.appendChild(tbody);
            card.appendChild(table);
            return card;
        }

        function renderReport(data) {
            if (!resultsEl) {
                return;
            }

            resultsEl.innerHTML = "";
            if (!data || !Array.isArray(data.customers) || data.customers.length === 0) {
                const empty = document.createElement("p");
                empty.className = "sales-report__empty";
                empty.textContent = "No sales data available for the selected period.";
                resultsEl.appendChild(empty);
                return;
            }

            const container = document.createElement("div");
            container.className = "sales-report__customers";

            data.customers.forEach((customer) => {
                container.appendChild(renderCustomer(customer));
            });

            resultsEl.appendChild(container);
        }

        function populateSelectors() {
            if (!monthSelect || !yearSelect) {
                return;
            }

            const now = new Date();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();

            monthNames.forEach((name, index) => {
                const option = document.createElement("option");
                option.value = String(index + 1);
                option.textContent = name;
                monthSelect.appendChild(option);
            });

            const startYear = currentYear - 2;
            const endYear = currentYear + 1;
            for (let year = endYear; year >= startYear; year -= 1) {
                const option = document.createElement("option");
                option.value = String(year);
                option.textContent = String(year);
                yearSelect.appendChild(option);
            }

            monthSelect.value = String(currentMonth);
            yearSelect.value = String(currentYear);
            updateSubtitle(currentYear, currentMonth);
        }

        async function loadReport() {
            if (!token) {
                return;
            }

            const year = yearSelect.value;
            const month = monthSelect.value;

            updateSubtitle(year, month);
            setFeedback("Loading customer sales…", "info");
            resultsEl.innerHTML = '<p class="sales-report__loading">Loading report…</p>';

            submitButton.disabled = true;

            try {
                const params = new URLSearchParams({
                    year: String(year),
                    month: String(month),
                });
                if (customerSelect && customerSelect.value) {
                    params.append("customer_id", customerSelect.value);
                }

                const response = await fetch(`/api/reports/customer-sales?${params.toString()}`, {
                    headers: {
                        Authorization: `Bearer ${token}`,
                        Accept: "application/json",
                    },
                });

                if (response.status === 401) {
                    localStorage.removeItem("samprox_token");
                    localStorage.removeItem("samprox_user");
                    window.location.href = "/";
                    return;
                }

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ msg: "Unable to load report" }));
                    throw new Error(errorData.msg || "Unable to load report");
                }

                const data = await response.json();
                updateCustomerOptions(data.customers || []);
                renderReport(data);

                if (data.customers && data.customers.length > 0) {
                    const totalCustomers = data.customers.length;
                    setFeedback(
                        `Showing sales data for ${totalCustomers} ${totalCustomers === 1 ? "customer" : "customers"}.`,
                        "success",
                    );
                } else {
                    setFeedback("No sales data recorded for the selected period.", "info");
                }
            } catch (error) {
                console.error(error);
                resultsEl.innerHTML = "";
                const errorMessage = error?.message || "Unable to load report.";
                setFeedback(errorMessage, "error");
            } finally {
                submitButton.disabled = false;
            }
        }

        if (reportForm) {
            populateSelectors();
            reportForm.addEventListener("submit", (event) => {
                event.preventDefault();
                loadReport();
            });
            loadReport();
        }
    </script>
</body>
</html>
