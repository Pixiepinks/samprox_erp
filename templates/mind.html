<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mind | SAMPROX ERP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" />
</head>
<body>
    <div class="page">
        <header class="topbar">
            <div class="brand">
                <div class="brand__logo">S</div>
                <div class="brand__details">
                    <p class="brand__name">SAMPROX ERP</p>
                    <p class="brand__section">7M Operations Overview</p>
                </div>
            </div>
            <div class="topbar__actions">
                <div class="user-summary">
                    <span class="user-summary__name" id="user-name"></span>
                    <span class="user-summary__role" id="user-role"></span>
                </div>
                <button type="button" class="button button--secondary" id="logout">Sign out</button>
            </div>
        </header>
        <nav class="subnav" aria-label="7M navigation">
            <a class="subnav__link subnav__link--active" href="{{ url_for('ui.mind_page') }}">Mind</a>
            <a class="subnav__link" href="{{ url_for('ui.man_page') }}">Man</a>
            <a class="subnav__link" href="{{ url_for('ui.machines_page') }}">Machine</a>
            <a class="subnav__link" href="{{ url_for('ui.material_page') }}">Material</a>
            <a class="subnav__link" href="{{ url_for('ui.market_page') }}">Market</a>
            <a class="subnav__link" href="{{ url_for('ui.manufacturing_page') }}">Manufacturing</a>
            <a class="subnav__link" href="{{ url_for('ui.money_page') }}">Money</a>
        </nav>
        <section class="section">
            <section class="production-chart" aria-labelledby="production-chart-title">
                <header class="production-chart__header">
                    <div>
                        <h2 id="production-chart-title">Monthly production</h2>
                        <p>Review day-by-day output and spot trends instantly.</p>
                    </div>
                    <div class="production-chart__controls">
                        <label class="production-chart__select">
                            <span>Year</span>
                            <select id="production-year"></select>
                        </label>
                        <label class="production-chart__select">
                            <span>Month</span>
                            <select id="production-month"></select>
                        </label>
                        <button type="button" class="button button--ghost" id="production-compare-toggle" aria-pressed="false">
                            Compare with previous month
                        </button>
                    </div>
                </header>
                <div class="production-chart__body">
                    <div class="production-chart__summary" id="production-summary" aria-live="polite"></div>
                    <div class="production-chart__canvas">
                        <canvas id="production-chart" height="320" aria-label="Daily production bar chart" role="img"></canvas>
                    </div>
                </div>
            </section>
            <section class="production-chart" aria-labelledby="pulse-chart-title">
                <header class="production-chart__header">
                    <div>
                        <h2 id="pulse-chart-title">Machine running pulse</h2>
                        <p>Track hourly tons for each critical machine across the month.</p>
                    </div>
                </header>
                <div class="production-chart__body">
                    <div class="production-chart__summary" id="production-pulse-summary" aria-live="polite"></div>
                    <div class="production-chart__canvas">
                        <canvas
                            id="production-pulse-chart"
                            height="320"
                            aria-label="Hourly machine production line chart"
                            role="img"
                        ></canvas>
                    </div>
                </div>
            </section>
            <section class="production-chart" aria-labelledby="sales-chart-title">
                <header class="production-chart__header">
                    <div>
                        <h2 id="sales-chart-title">Monthly sales</h2>
                        <p>Stacked daily sales for the selected month, grouped by customer.</p>
                    </div>
                </header>
                <div class="production-chart__body">
                    <div class="production-chart__summary" id="sales-summary" aria-live="polite"></div>
                    <div class="production-chart__canvas">
                        <canvas
                            id="sales-chart"
                            height="320"
                            aria-label="Daily sales stacked bar chart"
                            role="img"
                        ></canvas>
                    </div>
                </div>
            </section>
        </section>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script>
        const token = localStorage.getItem("samprox_token");
        const userRaw = localStorage.getItem("samprox_user");
        let user;

        try {
            user = userRaw ? JSON.parse(userRaw) : null;
        } catch (_) {
            user = null;
        }

        if (!token || !user) {
            window.location.href = "/";
        }

        const roleLabels = {
            admin: "Admin",
            production_manager: "Production Manager",
            maintenance_manager: "Maintenance Manager",
            technician: "Technician",
        };

        const userNameEl = document.getElementById("user-name");
        const userRoleEl = document.getElementById("user-role");
        const logoutButton = document.getElementById("logout");

        userNameEl.textContent = user?.name || "Unknown";
        userRoleEl.textContent = roleLabels[user?.role] || "";

        logoutButton.addEventListener("click", () => {
            localStorage.removeItem("samprox_token");
            localStorage.removeItem("samprox_user");
            window.location.href = "/";
        });

        const yearSelect = document.getElementById("production-year");
        const monthSelect = document.getElementById("production-month");
        const compareToggle = document.getElementById("production-compare-toggle");
        const productionSummaryContainer = document.getElementById("production-summary");
        const productionChartCanvas = document.getElementById("production-chart");
        const productionPulseSummaryContainer = document.getElementById("production-pulse-summary");
        const productionPulseChartCanvas = document.getElementById("production-pulse-chart");
        const salesSummaryContainer = document.getElementById("sales-summary");
        const salesChartCanvas = document.getElementById("sales-chart");

        const authHeaders = {
            Authorization: `Bearer ${token}`,
        };

        const numberFormatter = new Intl.NumberFormat(undefined, {
            minimumFractionDigits: 0,
            maximumFractionDigits: 2,
        });
        const percentFormatter = new Intl.NumberFormat(undefined, {
            minimumFractionDigits: 0,
            maximumFractionDigits: 1,
        });
        const currencyFormatter = new Intl.NumberFormat(undefined, {
            minimumFractionDigits: 0,
            maximumFractionDigits: 2,
        });

        const MACHINE_SERIES = [
            {
                field: "MCH1",
                label: "MCH-0001",
                backgroundColor: "rgba(37, 99, 235, 0.75)",
                borderColor: "rgb(37, 99, 235)",
            },
            {
                field: "MCH2",
                label: "MCH-0002",
                backgroundColor: "rgba(96, 165, 250, 0.75)",
                borderColor: "rgb(96, 165, 250)",
            },
        ];

        const PULSE_MACHINE_SERIES = [
            {
                field: "MCH1",
                label: "MCH-0001",
                borderColor: "rgb(37, 99, 235)",
                backgroundColor: "rgba(37, 99, 235, 0.25)",
            },
            {
                field: "MCH2",
                label: "MCH-0002",
                borderColor: "rgb(59, 130, 246)",
                backgroundColor: "rgba(59, 130, 246, 0.25)",
            },
            {
                field: "MCH3",
                label: "MCH-0003",
                borderColor: "rgb(56, 189, 248)",
                backgroundColor: "rgba(56, 189, 248, 0.25)",
            },
        ];

        const SALES_DATASET_COLORS = [
            { background: "rgba(14, 165, 233, 0.75)", border: "rgb(14, 165, 233)" },
            { background: "rgba(99, 102, 241, 0.75)", border: "rgb(99, 102, 241)" },
            { background: "rgba(16, 185, 129, 0.75)", border: "rgb(16, 185, 129)" },
            { background: "rgba(234, 179, 8, 0.75)", border: "rgb(234, 179, 8)" },
            { background: "rgba(236, 72, 153, 0.75)", border: "rgb(236, 72, 153)" },
            { background: "rgba(148, 163, 184, 0.65)", border: "rgb(148, 163, 184)" },
        ];

        const MONTH_OPTIONS = Array.from({ length: 12 }, (_, index) => {
            const value = String(index + 1).padStart(2, "0");
            const label = new Date(2000, index, 1).toLocaleString(undefined, {
                month: "long",
            });
            return { value, label };
        });
        const MIN_YEAR = 1900;
        const MAX_YEAR = 2100;

        const populateYearOptions = (selectedYear) => {
            yearSelect.innerHTML = "";
            const parsedYear = Number(selectedYear);
            const startYear = Number.isFinite(parsedYear)
                ? Math.min(MIN_YEAR, parsedYear)
                : MIN_YEAR;
            const endYear = Number.isFinite(parsedYear)
                ? Math.max(MAX_YEAR, parsedYear)
                : MAX_YEAR;

            for (let year = endYear; year >= startYear; year -= 1) {
                const option = document.createElement("option");
                option.value = String(year);
                option.textContent = year;
                if (String(year) === String(selectedYear)) {
                    option.selected = true;
                }
                yearSelect.append(option);
            }
            yearSelect.disabled = yearSelect.options.length === 0;
        };

        const populateMonthOptions = (year, selectedPeriod = null) => {
            monthSelect.innerHTML = "";
            const targetMonth = selectedPeriod ? selectedPeriod.split("-")[1] : null;

            MONTH_OPTIONS.forEach(({ value, label }) => {
                const option = document.createElement("option");
                option.value = `${year}-${value}`;
                option.textContent = label;
                if (targetMonth ? targetMonth === value : false) {
                    option.selected = true;
                }
                monthSelect.append(option);
            });

            if (!monthSelect.value && monthSelect.options.length > 0) {
                const today = new Date();
                const currentMonth = String(today.getMonth() + 1).padStart(2, "0");
                const fallbackValue = `${year}-${currentMonth}`;
                const fallbackOption = Array.from(monthSelect.options).find(
                    (option) => option.value === fallbackValue,
                );
                if (fallbackOption) {
                    fallbackOption.selected = true;
                } else {
                    monthSelect.options[0].selected = true;
                }
            }

            monthSelect.disabled = monthSelect.options.length === 0;
        };

        const initializePeriodSelectors = () => {
            const today = new Date();
            const initialYear = String(today.getFullYear());
            const initialPeriod = `${initialYear}-${String(today.getMonth() + 1).padStart(2, "0")}`;

            populateYearOptions(initialYear);
            if (yearSelect.disabled) {
                showProductionSummaryError("No production periods available.");
                showSalesSummaryError("No sales periods available.");
                return false;
            }

            populateMonthOptions(initialYear, initialPeriod);
            return true;
        };

        const getSelectedPeriodKey = () => {
            const periodKey = monthSelect.value;
            return periodKey ? periodKey : null;
        };

        const productionPeriodCache = new Map();
        const productionPulsePeriodCache = new Map();
        const salesPeriodCache = new Map();

        const formatTons = (value) => {
            const number = Number(value);
            if (!Number.isFinite(number)) {
                return "0";
            }
            return numberFormatter.format(number);
        };

        const formatPercent = (value) => {
            const number = Number(value);
            if (!Number.isFinite(number)) {
                return "0";
            }
            return percentFormatter.format(number);
        };

        const formatCurrency = (value) => {
            const number = Number(value);
            if (!Number.isFinite(number)) {
                return "Rs 0";
            }
            return `Rs ${currencyFormatter.format(number)}`;
        };

        const renderProductionSummary = (periodData, comparisonData = null) => {
            const total = Number(periodData?.total_production ?? 0);
            const average = Number(periodData?.average_day_production ?? 0);
            const peakDay = periodData?.peak?.day ?? null;
            const peakValue = Number(periodData?.peak?.total_tons ?? 0);

            const summaryMetrics = [
                {
                    label: "Total Production",
                    value: formatTons(total),
                },
                {
                    label: "Average Day Production",
                    value: formatTons(average),
                },
                {
                    label: "Peak day",
                    value:
                        peakDay !== null
                            ? `Day ${peakDay} – ${formatTons(peakValue)} tons`
                            : "—",
                },
            ];

            if (comparisonData) {
                const compareTotal = Number(comparisonData.total_production ?? 0);
                const delta = total - compareTotal;
                const deltaSign = delta >= 0 ? "+" : "−";
                const deltaAbsolute = formatTons(Math.abs(delta));
                let changeText = `${deltaSign}${deltaAbsolute} tons`;

                if (compareTotal > 0) {
                    const percentValue = (delta / compareTotal) * 100;
                    const percentSign = percentValue >= 0 ? "+" : "−";
                    const percentAbsolute = formatPercent(Math.abs(percentValue));
                    changeText = `${deltaSign}${deltaAbsolute} tons (${percentSign}${percentAbsolute}%)`;
                }

                summaryMetrics.push({
                    label: "Change vs. prior month",
                    value: changeText,
                });
            }

            productionSummaryContainer.innerHTML = summaryMetrics
                .map(
                    (metric) => `
                        <div class="production-chart__metric">
                            <span class="production-chart__metric-label">${metric.label}</span>
                            <span class="production-chart__metric-value">${metric.value}</span>
                        </div>
                    `,
                )
                .join("");
        };

        const showProductionSummaryError = (message) => {
            productionSummaryContainer.innerHTML = `
                <div class="production-chart__metric">
                    <span class="production-chart__metric-label">Production data</span>
                    <span class="production-chart__metric-value">${message}</span>
                </div>
            `;
        };

        const renderProductionPulseSummary = (periodData) => {
            if (!productionPulseSummaryContainer) {
                return;
            }

            const total = Number(periodData?.total_production ?? 0);
            const average = Number(periodData?.average_hour_production ?? 0);
            const peakLabel = periodData?.peak?.label ?? null;
            const peakValue = Number(periodData?.peak?.total_tons ?? 0);

            const summaryMetrics = [
                {
                    label: "Total Production",
                    value: `${formatTons(total)} tons`,
                },
                {
                    label: "Average Tons per Hour",
                    value: `${formatTons(average)} tons`,
                },
                {
                    label: "Peak hour",
                    value: peakLabel ? `${peakLabel} – ${formatTons(peakValue)} tons` : "—",
                },
            ];

            productionPulseSummaryContainer.innerHTML = summaryMetrics
                .map(
                    (metric) => `
                        <div class="production-chart__metric">
                            <span class="production-chart__metric-label">${metric.label}</span>
                            <span class="production-chart__metric-value">${metric.value}</span>
                        </div>
                    `,
                )
                .join("");
        };

        const showProductionPulseSummaryError = (message) => {
            if (!productionPulseSummaryContainer) {
                return;
            }
            productionPulseSummaryContainer.innerHTML = `
                <div class="production-chart__metric">
                    <span class="production-chart__metric-label">Machine pulse</span>
                    <span class="production-chart__metric-value">${message}</span>
                </div>
            `;
        };

        const getPreviousPeriodKey = (periodKey) => {
            if (!periodKey) {
                return null;
            }
            const [yearStr, monthStr] = periodKey.split("-");
            const year = Number(yearStr);
            const month = Number(monthStr);
            if (!Number.isFinite(year) || !Number.isFinite(month)) {
                return null;
            }
            const date = new Date(year, month - 1, 1);
            date.setMonth(date.getMonth() - 1);
            const previousYear = date.getFullYear();
            const previousMonth = String(date.getMonth() + 1).padStart(2, "0");
            return `${previousYear}-${previousMonth}`;
        };

        const fetchProductionMonthlySummary = async (periodKey) => {
            if (!periodKey) {
                return null;
            }

            if (productionPeriodCache.has(periodKey)) {
                return productionPeriodCache.get(periodKey);
            }

            const params = new URLSearchParams({ period: periodKey });

            const response = await fetch(`/api/production/monthly/summary?${params.toString()}`, {
                headers: authHeaders,
            });

            if (response.status === 401) {
                logoutButton.click();
                return null;
            }

            if (!response.ok) {
                throw new Error("Failed to load production data.");
            }

            const data = await response.json();
            productionPeriodCache.set(periodKey, data);
            return data;
        };

        const buildProductionDataset = async (periodKey, includePrevious = false) => {
            const periodData = await fetchProductionMonthlySummary(periodKey);
            if (!periodData) {
                return null;
            }

            const labels = periodData.daily_totals.map((item) => item.day);
            const datasets = MACHINE_SERIES.map((series, index, array) => {
                const data = periodData.daily_totals.map((item) => {
                    const value = Number(item?.[series.field] ?? 0);
                    return Number.isFinite(value) ? value : 0;
                });

                const isFirst = index === 0;
                const isLast = index === array.length - 1;

                return {
                    label: series.label,
                    data,
                    backgroundColor: series.backgroundColor,
                    borderColor: series.borderColor,
                    borderWidth: 1,
                    stack: "current",
                    maxBarThickness: 18,
                    borderSkipped: false,
                    borderRadius: {
                        topLeft: isLast ? 6 : 0,
                        topRight: isLast ? 6 : 0,
                        bottomLeft: isFirst ? 6 : 0,
                        bottomRight: isFirst ? 6 : 0,
                    },
                    order: 1,
                };
            });

            let comparisonData = null;

            if (includePrevious) {
                const previousKey = getPreviousPeriodKey(periodKey);
                if (previousKey) {
                    const previousPeriod = await fetchProductionMonthlySummary(previousKey);
                    if (previousPeriod) {
                        comparisonData = previousPeriod;
                        const totalsByDay = new Map(
                            previousPeriod.daily_totals.map((item) => [item.day, item.total_tons]),
                        );
                        const comparisonValues = labels.map((day) => {
                            return totalsByDay.has(day) ? totalsByDay.get(day) : null;
                        });
                        datasets.push({
                            label: `${previousPeriod.label} total`,
                            data: comparisonValues,
                            type: "line",
                            borderColor: "rgba(148, 163, 184, 0.9)",
                            backgroundColor: "rgba(148, 163, 184, 0.35)",
                            borderWidth: 2,
                            tension: 0.3,
                            spanGaps: true,
                            fill: false,
                            pointRadius: 0,
                            showInLegend: false,
                            order: 99,
                        });
                    }
                }
            }

            renderProductionSummary(periodData, comparisonData);
            return { labels, datasets };
        };

        const fetchProductionPulseSummary = async (periodKey) => {
            if (!periodKey) {
                return null;
            }

            if (productionPulsePeriodCache.has(periodKey)) {
                return productionPulsePeriodCache.get(periodKey);
            }

            const params = new URLSearchParams({ period: periodKey });
            const response = await fetch(`/api/production/monthly/hourly-pulse?${params.toString()}`, {
                headers: authHeaders,
            });

            if (response.status === 401) {
                logoutButton.click();
                return null;
            }

            if (!response.ok) {
                throw new Error("Failed to load machine pulse data.");
            }

            const data = await response.json();
            productionPulsePeriodCache.set(periodKey, data);
            return data;
        };

        const buildProductionPulseDataset = async (periodKey) => {
            const periodData = await fetchProductionPulseSummary(periodKey);
            if (!periodData) {
                return null;
            }

            const hourlyTotals = Array.isArray(periodData.hourly_totals)
                ? periodData.hourly_totals
                : [];

            const labels = hourlyTotals.map((item) => {
                if (item.label) {
                    return item.label;
                }
                const day = String(item.day ?? "").padStart(2, "0");
                const hour = String(item.hour ?? "").padStart(2, "0");
                return `Day ${day} – ${hour}:00`;
            });

            const datasets = PULSE_MACHINE_SERIES.map((series) => {
                const values = hourlyTotals.map((item) => {
                    const value = Number(item?.[series.field] ?? 0);
                    return Number.isFinite(value) ? value : 0;
                });

                return {
                    label: series.label,
                    data: values,
                    borderColor: series.borderColor,
                    backgroundColor: series.backgroundColor,
                    borderWidth: 2,
                    pointRadius: 0,
                    pointHoverRadius: 3,
                    tension: 0.25,
                    fill: false,
                };
            });

            renderProductionPulseSummary(periodData);

            return { labels, datasets, hourlyTotals };
        };

        const buildProductionPulseChart = async () => {
            if (!productionPulseSummaryContainer || !productionPulseChartCanvas) {
                return;
            }

            productionPulseSummaryContainer.innerHTML = `
                <div class="production-chart__metric">
                    <span class="production-chart__metric-label">Loading</span>
                    <span class="production-chart__metric-value">…</span>
                </div>
            `;

            try {
                const periodKey = getSelectedPeriodKey();
                const dataset = await buildProductionPulseDataset(periodKey);
                if (!dataset) {
                    showProductionPulseSummaryError("No pulse data available.");
                    return;
                }

                if (window.productionPulseChartInstance) {
                    window.productionPulseChartInstance.data.labels = dataset.labels;
                    window.productionPulseChartInstance.data.datasets = dataset.datasets;
                    window.productionPulseChartInstance.$hourlyTotals = dataset.hourlyTotals;
                    window.productionPulseChartInstance.update();
                    return;
                }

                window.productionPulseChartInstance = new Chart(productionPulseChartCanvas, {
                    type: "line",
                    data: {
                        labels: dataset.labels,
                        datasets: dataset.datasets,
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: "Hour of month",
                                },
                                grid: {
                                    display: false,
                                },
                                ticks: {
                                    autoSkip: true,
                                    maxTicksLimit: 31,
                                },
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: "Tons per hour",
                                },
                                ticks: {
                                    callback: (value) => formatTons(value),
                                },
                            },
                        },
                        interaction: {
                            mode: "index",
                            intersect: false,
                        },
                        elements: {
                            point: {
                                radius: 0,
                                hoverRadius: 3,
                            },
                        },
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    usePointStyle: true,
                                },
                            },
                            tooltip: {
                                callbacks: {
                                    title: (contexts) => {
                                        if (!Array.isArray(contexts) || contexts.length === 0) {
                                            return "";
                                        }
                                        return contexts[0].label || "";
                                    },
                                    label: (context) => {
                                        const label = context.dataset.label || "";
                                        const value = Number(context.parsed.y ?? 0);
                                        return `${label}: ${formatTons(value)} tons`;
                                    },
                                    footer: (contexts) => {
                                        if (!Array.isArray(contexts) || contexts.length === 0) {
                                            return "";
                                        }
                                        const chart = contexts[0]?.chart;
                                        const index = contexts[0]?.dataIndex ?? null;
                                        const totals = chart?.$hourlyTotals;
                                        if (!Array.isArray(totals) || index === null) {
                                            return "";
                                        }
                                        const entry = totals[index];
                                        if (!entry) {
                                            return "";
                                        }
                                        const totalValue = Number(entry?.total_tons ?? 0);
                                        return `Total: ${formatTons(totalValue)} tons`;
                                    },
                                },
                            },
                        },
                    },
                });
                window.productionPulseChartInstance.$hourlyTotals = dataset.hourlyTotals;
            } catch (error) {
                console.error(error);
                showProductionPulseSummaryError("Unable to load machine pulse data.");
            }
        };

        const buildProductionChart = async () => {
            productionSummaryContainer.innerHTML = `
                <div class="production-chart__metric">
                    <span class="production-chart__metric-label">Loading</span>
                    <span class="production-chart__metric-value">…</span>
                </div>
            `;

            try {
                const periodKey = getSelectedPeriodKey();
                const includePrevious = compareToggle.getAttribute("aria-pressed") === "true";
                const dataset = await buildProductionDataset(periodKey, includePrevious);
                if (!dataset) {
                    showProductionSummaryError("No production data available.");
                    return;
                }

                if (window.productionChartInstance) {
                    window.productionChartInstance.data.labels = dataset.labels;
                    window.productionChartInstance.data.datasets = dataset.datasets;
                    window.productionChartInstance.update();
                    return;
                }

                window.productionChartInstance = new Chart(productionChartCanvas, {
                    type: "bar",
                    data: dataset,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: true,
                                title: {
                                    display: true,
                                    text: "Day of month",
                                },
                                grid: {
                                    display: false,
                                },
                                ticks: {
                                    maxRotation: 0,
                                    autoSkip: true,
                                    maxTicksLimit: 15,
                                },
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: "Tons produced",
                                },
                                ticks: {
                                    callback: (value) => formatTons(value),
                                },
                            },
                        },
                        interaction: {
                            mode: "index",
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    usePointStyle: true,
                                    filter: (legendItem, chart) => {
                                        const dataset = chart?.data?.datasets?.[legendItem.datasetIndex];
                                        if (dataset && Object.prototype.hasOwnProperty.call(dataset, "showInLegend")) {
                                            return dataset.showInLegend !== false;
                                        }
                                        return true;
                                    },
                                },
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const label = context.dataset.label || "";
                                        const value = Number(context.parsed.y ?? 0);
                                        return `${label}: ${formatTons(value)} tons`;
                                    },
                                    footer: (contexts) => {
                                        if (!Array.isArray(contexts) || contexts.length === 0) {
                                            return "";
                                        }
                                        const stackContexts = contexts.filter(
                                            (item) => item.dataset?.stack === "current",
                                        );
                                        if (stackContexts.length === 0) {
                                            return "";
                                        }
                                        const total = stackContexts.reduce(
                                            (sum, item) => sum + Number(item.parsed.y ?? 0),
                                            0,
                                        );
                                        return `Total: ${formatTons(total)} tons`;
                                    },
                                },
                            },
                        },
                    },
                });
            } catch (error) {
                console.error(error);
                showProductionSummaryError("Unable to load production data.");
            }
        };

        const renderSalesSummary = (periodData) => {
            if (!salesSummaryContainer) {
                return;
            }

            const total = Number(periodData?.total_sales ?? 0);
            const average = Number(periodData?.average_day_sales ?? 0);
            const peakDay = periodData?.peak?.day ?? null;
            const peakValue = Number(periodData?.peak?.total_value ?? 0);
            const topCustomerName = periodData?.top_customer?.name ?? null;
            const topCustomerValue = Number(periodData?.top_customer?.sales_value ?? 0);

            const summaryMetrics = [
                {
                    label: "Total Sales",
                    value: formatCurrency(total),
                },
                {
                    label: "Average Daily Sales",
                    value: formatCurrency(average),
                },
                {
                    label: "Peak day",
                    value:
                        peakDay !== null
                            ? `Day ${peakDay} – ${formatCurrency(peakValue)}`
                            : "—",
                },
            ];

            if (topCustomerName) {
                summaryMetrics.push({
                    label: "Top customer",
                    value: `${topCustomerName} (${formatCurrency(topCustomerValue)})`,
                });
            }

            salesSummaryContainer.innerHTML = summaryMetrics
                .map(
                    (metric) => `
                        <div class="production-chart__metric">
                            <span class="production-chart__metric-label">${metric.label}</span>
                            <span class="production-chart__metric-value">${metric.value}</span>
                        </div>
                    `,
                )
                .join("");
        };

        const showSalesSummaryError = (message) => {
            if (!salesSummaryContainer) {
                return;
            }
            salesSummaryContainer.innerHTML = `
                <div class="production-chart__metric">
                    <span class="production-chart__metric-label">Sales data</span>
                    <span class="production-chart__metric-value">${message}</span>
                </div>
            `;
        };

        const fetchSalesMonthlySummary = async (periodKey) => {
            if (!periodKey) {
                return null;
            }

            if (salesPeriodCache.has(periodKey)) {
                return salesPeriodCache.get(periodKey);
            }

            const params = new URLSearchParams({ period: periodKey });
            const response = await fetch(`/api/reports/sales/monthly-summary?${params.toString()}`, {
                headers: authHeaders,
            });

            if (response.status === 401) {
                logoutButton.click();
                return null;
            }

            if (!response.ok) {
                throw new Error("Failed to load sales data.");
            }

            const data = await response.json();
            salesPeriodCache.set(periodKey, data);
            return data;
        };

        const buildSalesDataset = async (periodKey) => {
            const periodData = await fetchSalesMonthlySummary(periodKey);
            if (!periodData) {
                return null;
            }

            const labels = periodData.daily_totals.map((item) => item.day);
            const customers = Array.isArray(periodData.customers) ? periodData.customers : [];

            const datasets = customers.map((customer, index, array) => {
                const fieldName = customer.field;
                const values = periodData.daily_totals.map((item) => {
                    const value = Number(item?.[fieldName] ?? 0);
                    return Number.isFinite(value) ? value : 0;
                });

                const colors = SALES_DATASET_COLORS[index % SALES_DATASET_COLORS.length];
                const isFirst = index === 0;
                const isLast = index === array.length - 1;

                return {
                    label: customer.name,
                    data: values,
                    backgroundColor: colors.background,
                    borderColor: colors.border,
                    borderWidth: 1,
                    stack: "sales",
                    maxBarThickness: 18,
                    borderSkipped: false,
                    borderRadius: {
                        topLeft: isLast ? 6 : 0,
                        topRight: isLast ? 6 : 0,
                        bottomLeft: isFirst ? 6 : 0,
                        bottomRight: isFirst ? 6 : 0,
                    },
                    order: 1,
                };
            });

            renderSalesSummary(periodData);
            return { labels, datasets };
        };

        const buildSalesChart = async () => {
            if (!salesSummaryContainer || !salesChartCanvas) {
                return;
            }

            salesSummaryContainer.innerHTML = `
                <div class="production-chart__metric">
                    <span class="production-chart__metric-label">Loading</span>
                    <span class="production-chart__metric-value">…</span>
                </div>
            `;

            try {
                const periodKey = getSelectedPeriodKey();
                const dataset = await buildSalesDataset(periodKey);
                if (!dataset) {
                    showSalesSummaryError("No sales data available.");
                    return;
                }

                if (window.salesChartInstance) {
                    window.salesChartInstance.data.labels = dataset.labels;
                    window.salesChartInstance.data.datasets = dataset.datasets;
                    window.salesChartInstance.update();
                    return;
                }

                window.salesChartInstance = new Chart(salesChartCanvas, {
                    type: "bar",
                    data: dataset,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: true,
                                title: {
                                    display: true,
                                    text: "Day of month",
                                },
                                grid: {
                                    display: false,
                                },
                                ticks: {
                                    maxRotation: 0,
                                    autoSkip: true,
                                    maxTicksLimit: 15,
                                },
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: "Sales value (Rs)",
                                },
                                ticks: {
                                    callback: (value) => formatCurrency(value),
                                },
                            },
                        },
                        interaction: {
                            mode: "index",
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    usePointStyle: true,
                                },
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const label = context.dataset.label || "";
                                        const value = Number(context.parsed.y ?? 0);
                                        return `${label}: ${formatCurrency(value)}`;
                                    },
                                    footer: (contexts) => {
                                        if (!Array.isArray(contexts) || contexts.length === 0) {
                                            return "";
                                        }
                                        const stackContexts = contexts.filter(
                                            (item) => item.dataset?.stack === "sales",
                                        );
                                        if (stackContexts.length === 0) {
                                            return "";
                                        }
                                        const total = stackContexts.reduce(
                                            (sum, item) => sum + Number(item.parsed.y ?? 0),
                                            0,
                                        );
                                        return `Total: ${formatCurrency(total)}`;
                                    },
                                },
                            },
                        },
                    },
                });
            } catch (error) {
                console.error(error);
                showSalesSummaryError("Unable to load sales data.");
            }
        };

        const refreshProductionChart = () => {
            buildProductionChart().catch((error) => {
                console.error(error);
                showProductionSummaryError("Unable to load production data.");
            });
        };

        const refreshProductionPulseChart = () => {
            buildProductionPulseChart().catch((error) => {
                console.error(error);
                showProductionPulseSummaryError("Unable to load machine pulse data.");
            });
        };

        const refreshSalesChart = () => {
            buildSalesChart().catch((error) => {
                console.error(error);
                showSalesSummaryError("Unable to load sales data.");
            });
        };

        const refreshCharts = () => {
            refreshProductionChart();
            refreshProductionPulseChart();
            refreshSalesChart();
        };

        const selectorsInitialized = initializePeriodSelectors();

        yearSelect.addEventListener("change", () => {
            const previousSelection = getSelectedPeriodKey();
            populateMonthOptions(yearSelect.value, previousSelection);
            refreshCharts();
        });

        monthSelect.addEventListener("change", () => {
            refreshCharts();
        });

        compareToggle.addEventListener("click", () => {
            const isActive = compareToggle.getAttribute("aria-pressed") === "true";
            compareToggle.setAttribute("aria-pressed", String(!isActive));
            compareToggle.classList.toggle("button--active", !isActive);
            refreshCharts();
        });

        if (selectorsInitialized) {
            refreshCharts();
        }
    </script>
</body>
</html>
