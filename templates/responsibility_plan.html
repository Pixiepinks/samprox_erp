<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Responsibility Plan | SAMPROX ERP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" />
</head>
<body>
    <div class="page">
        <header class="topbar">
            <div class="brand">
                <div class="brand__logo">S</div>
                <div class="brand__details">
                    <p class="brand__name">SAMPROX ERP</p>
                    <p class="brand__section">Responsibility Portal</p>
                </div>
            </div>
            <div class="topbar__actions">
                <div class="user-summary">
                    <span class="user-summary__name" id="user-name"></span>
                    <span class="user-summary__role" id="user-role"></span>
                </div>
                <button type="button" class="button button--secondary" id="logout">Sign out</button>
            </div>
        </header>
        <main class="section">
            <section class="responsibility-plan" aria-labelledby="responsibility-plan-heading">
                <div class="responsibility-plan__header">
                    <div>
                        <h2 class="responsibility-plan__title" id="responsibility-plan-heading">Responsibility plan</h2>
                        <p class="responsibility-plan__description">
                            Assign and monitor managerial responsibilities, plan recurring tasks, and keep everyone informed.
                        </p>
                    </div>
                    <div class="responsibility-plan__header-actions">
                        <button type="button" class="button button--primary" id="responsibility-create-button">
                            New responsibility
                        </button>
                    </div>
                </div>
                <div class="responsibility-plan__utilities">
                    <form class="responsibility-weekly-form" id="responsibility-weekly-form" novalidate>
                        <div class="responsibility-weekly-form__fields">
                            <label class="responsibility-weekly-form__label" for="responsibility-weekly-start">
                                Week starting
                                <input class="responsibility-weekly-form__input" id="responsibility-weekly-start" name="startDate" type="date" />
                            </label>
                            <label class="responsibility-weekly-form__label" for="responsibility-weekly-email">
                                Recipient email
                                <input
                                    class="responsibility-weekly-form__input"
                                    id="responsibility-weekly-email"
                                    name="recipientEmail"
                                    type="email"
                                    placeholder="name@example.com"
                                    required
                                />
                            </label>
                        </div>
                        <button type="submit" class="button button--secondary" id="responsibility-weekly-send">
                            Email Monday–Sunday plan
                        </button>
                    </form>
                    <p class="responsibility-plan__message" id="responsibility-weekly-message" hidden></p>
                </div>
                <div class="responsibility-plan__controls" id="responsibility-table-controls">
                    <div class="responsibility-plan__control-group">
                        <label class="responsibility-plan__control-label" for="responsibility-period-start">
                            Period start
                            <input
                                class="responsibility-plan__control-input"
                                id="responsibility-period-start"
                                name="periodStart"
                                type="date"
                            />
                        </label>
                        <label class="responsibility-plan__control-label" for="responsibility-period-end">
                            Period end
                            <input
                                class="responsibility-plan__control-input"
                                id="responsibility-period-end"
                                name="periodEnd"
                                type="date"
                            />
                        </label>
                        <button type="button" class="button button--ghost button--small" id="responsibility-period-clear">
                            Clear period
                        </button>
                    </div>
                    <div class="responsibility-plan__control-group">
                        <label class="responsibility-plan__control-label" for="responsibility-filter-column">
                            Filter column
                            <select
                                class="responsibility-plan__control-input"
                                id="responsibility-filter-column"
                                name="filterColumn"
                            ></select>
                        </label>
                        <label class="responsibility-plan__control-label" for="responsibility-filter-value">
                            Filter value
                            <input
                                class="responsibility-plan__control-input"
                                id="responsibility-filter-value"
                                name="filterValue"
                                type="text"
                                placeholder="Search responsibilities"
                                autocomplete="off"
                            />
                        </label>
                        <button type="button" class="button button--ghost button--small" id="responsibility-filter-clear">
                            Clear filter
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="team-table responsibility-table">
                        <thead>
                            <tr>
                                <th scope="col" aria-sort="none">
                                    <button type="button" class="responsibility-table__sort-button" data-sort-key="number">
                                        <span>Responsibility No</span>
                                        <span class="responsibility-table__sort-icon" aria-hidden="true">⇅</span>
                                    </button>
                                </th>
                                <th scope="col" aria-sort="none">
                                    <button type="button" class="responsibility-table__sort-button" data-sort-key="title">
                                        <span>Title</span>
                                        <span class="responsibility-table__sort-icon" aria-hidden="true">⇅</span>
                                    </button>
                                </th>
                                <th scope="col" aria-sort="none">
                                    <button type="button" class="responsibility-table__sort-button" data-sort-key="progress">
                                        <span>Progress</span>
                                        <span class="responsibility-table__sort-icon" aria-hidden="true">⇅</span>
                                    </button>
                                </th>
                                <th scope="col" aria-sort="none">
                                    <button type="button" class="responsibility-table__sort-button" data-sort-key="assigner">
                                        <span>Assigned by</span>
                                        <span class="responsibility-table__sort-icon" aria-hidden="true">⇅</span>
                                    </button>
                                </th>
                                <th scope="col" aria-sort="none">
                                    <button type="button" class="responsibility-table__sort-button" data-sort-key="assignee">
                                        <span>Assigned to</span>
                                        <span class="responsibility-table__sort-icon" aria-hidden="true">⇅</span>
                                    </button>
                                </th>
                                <th scope="col" aria-sort="none">
                                    <button type="button" class="responsibility-table__sort-button" data-sort-key="delegatedTo">
                                        <span>Delegated to</span>
                                        <span class="responsibility-table__sort-icon" aria-hidden="true">⇅</span>
                                    </button>
                                </th>
                                <th scope="col" aria-sort="none">
                                    <button type="button" class="responsibility-table__sort-button" data-sort-key="performanceUnit">
                                        <span>Unit of Measure</span>
                                        <span class="responsibility-table__sort-icon" aria-hidden="true">⇅</span>
                                    </button>
                                </th>
                                <th scope="col" aria-sort="none">
                                    <button
                                        type="button"
                                        class="responsibility-table__sort-button"
                                        data-sort-key="performanceResponsible"
                                    >
                                        <span>Responsible</span>
                                        <span class="responsibility-table__sort-icon" aria-hidden="true">⇅</span>
                                    </button>
                                </th>
                                <th scope="col" aria-sort="none">
                                    <button
                                        type="button"
                                        class="responsibility-table__sort-button"
                                        data-sort-key="performanceActual"
                                    >
                                        <span>Actual</span>
                                        <span class="responsibility-table__sort-icon" aria-hidden="true">⇅</span>
                                    </button>
                                </th>
                                <th scope="col" aria-sort="none">
                                    <button
                                        type="button"
                                        class="responsibility-table__sort-button"
                                        data-sort-key="performanceMetric"
                                    >
                                        <span>Performance Metric</span>
                                        <span class="responsibility-table__sort-icon" aria-hidden="true">⇅</span>
                                    </button>
                                </th>
                                <th scope="col" aria-sort="none">
                                    <button type="button" class="responsibility-table__sort-button" data-sort-key="detail">
                                        <span>Detail</span>
                                        <span class="responsibility-table__sort-icon" aria-hidden="true">⇅</span>
                                    </button>
                                </th>
                                <th scope="col" aria-sort="none">
                                    <button
                                        type="button"
                                        class="responsibility-table__sort-button"
                                        data-sort-key="scheduledFor"
                                    >
                                        <span>Scheduled for</span>
                                        <span class="responsibility-table__sort-icon" aria-hidden="true">⇅</span>
                                    </button>
                                </th>
                                <th scope="col" aria-sort="none">
                                    <button type="button" class="responsibility-table__sort-button" data-sort-key="action">
                                        <span>5D Action</span>
                                        <span class="responsibility-table__sort-icon" aria-hidden="true">⇅</span>
                                    </button>
                                </th>
                                <th scope="col" aria-sort="none">
                                    <button type="button" class="responsibility-table__sort-button" data-sort-key="createdAt">
                                        <span>Created</span>
                                        <span class="responsibility-table__sort-icon" aria-hidden="true">⇅</span>
                                    </button>
                                </th>
                                <th scope="col">Update</th>
                            </tr>
                        </thead>
                        <tbody id="responsibility-table-body"></tbody>
                    </table>
                </div>
                <p class="responsibility-plan__empty" id="responsibility-empty" hidden>
                    No responsibilities have been added yet.
                </p>
                <p class="responsibility-plan__message" id="responsibility-message" hidden></p>
            </section>
            <section class="responsibility-report" aria-labelledby="responsibility-report-heading">
                <div class="responsibility-report__header">
                    <div>
                        <h2 class="responsibility-report__title" id="responsibility-report-heading">Responsibilities by team member</h2>
                        <p class="responsibility-report__description">
                            Review the responsibilities assigned to each team member within your chosen date range and export the overview instantly.
                        </p>
                    </div>
                    <div class="responsibility-report__downloads" role="group" aria-label="Download responsibility report">
                        <button type="button" class="button button--ghost button--small" data-report-download="excel" disabled>
                            Download Excel
                        </button>
                        <button type="button" class="button button--ghost button--small" data-report-download="pdf" disabled>
                            Download PDF
                        </button>
                        <button type="button" class="button button--ghost button--small" data-report-download="png" disabled>
                            Download PNG
                        </button>
                    </div>
                </div>
                <form class="responsibility-report__filters" id="responsibility-report-form" novalidate>
                    <div class="responsibility-report__field">
                        <label for="responsibility-report-start">Start date</label>
                        <input class="responsibility-report__input" type="date" id="responsibility-report-start" name="startDate" required />
                    </div>
                    <div class="responsibility-report__field">
                        <label for="responsibility-report-end">End date</label>
                        <input class="responsibility-report__input" type="date" id="responsibility-report-end" name="endDate" required />
                    </div>
                    <div class="responsibility-report__field">
                        <label for="responsibility-report-member">Team member</label>
                        <select class="responsibility-report__select" id="responsibility-report-member" name="teamMemberId" required>
                            <option value="all">All team members</option>
                        </select>
                    </div>
                </form>
                <div class="responsibility-report__body">
                    <div class="responsibility-report__chart-container">
                        <canvas id="responsibility-report-chart" role="img" aria-label="Responsibilities per team member"></canvas>
                    </div>
                    <div class="responsibility-report__table-wrapper">
                        <table class="responsibility-report__table" aria-describedby="responsibility-report-heading">
                            <thead>
                                <tr>
                                    <th scope="col">Team member</th>
                                    <th scope="col">Occurrences</th>
                                    <th scope="col">Unique responsibilities</th>
                                </tr>
                            </thead>
                            <tbody id="responsibility-report-tbody"></tbody>
                        </table>
                        <p class="responsibility-report__empty" id="responsibility-report-empty" hidden>
                            No responsibilities recorded for the selected filters.
                        </p>
                    </div>
                </div>
                <p class="responsibility-report__summary" id="responsibility-report-summary"></p>
                <p class="responsibility-report__message" id="responsibility-report-message" hidden></p>
            </section>
        </main>
    </div>
    <div class="modal" id="responsibility-modal" hidden aria-hidden="true">
        <div class="modal__overlay" data-modal-dismiss></div>
        <div class="modal__content" role="dialog" aria-modal="true" aria-labelledby="responsibility-modal-title">
            <header class="modal__header">
                <h2 class="modal__title" id="responsibility-modal-title">New responsibility</h2>
                <button type="button" class="modal__close" id="responsibility-modal-close" aria-label="Close responsibility form">
                    <span aria-hidden="true">&times;</span>
                </button>
            </header>
            <div class="modal__body">
                <p class="modal__hint">Define the responsibility, choose the recurrence, and notify the appropriate manager.</p>
                <p class="alert alert--error" id="responsibility-form-error" hidden></p>
                <form class="edit-form" id="responsibility-form" novalidate>
                    <div class="edit-form__grid">
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="responsibility-title">Title <span class="required">*</span></label>
                            <input class="edit-form__input" id="responsibility-title" name="title" type="text" required />
                        </div>
                        <div class="edit-form__field edit-form__field--full">
                            <label class="edit-form__label" for="responsibility-description">Description</label>
                            <textarea class="edit-form__input" id="responsibility-description" name="description" rows="3"></textarea>
                        </div>
                        <div class="edit-form__field edit-form__field--full">
                            <label class="edit-form__label" for="responsibility-detail">Detail</label>
                            <textarea class="edit-form__input" id="responsibility-detail" name="detail" rows="3"></textarea>
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="responsibility-date">First scheduled date <span class="required">*</span></label>
                            <input class="edit-form__input" id="responsibility-date" name="scheduledFor" type="date" required />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="responsibility-recurrence">Recurrence <span class="required">*</span></label>
                            <select class="edit-form__input" id="responsibility-recurrence" name="recurrence" required>
                                <option value="does_not_repeat">Does not repeat</option>
                                <option value="monday_to_friday">Monday to Friday</option>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly on (Today)</option>
                                <option value="monthly">Monthly on (Today)</option>
                                <option value="annually">Annually on (Today)</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <fieldset class="edit-form__field edit-form__field--full" id="responsibility-custom-days" hidden>
                            <legend class="edit-form__label">Custom weekdays <span class="required">*</span></legend>
                            <div class="responsibility-custom-weekdays" id="responsibility-custom-weekdays">
                                <label class="responsibility-custom-weekdays__option">
                                    <input type="checkbox" value="0" name="customWeekdays" />
                                    <span>Monday</span>
                                </label>
                                <label class="responsibility-custom-weekdays__option">
                                    <input type="checkbox" value="1" name="customWeekdays" />
                                    <span>Tuesday</span>
                                </label>
                                <label class="responsibility-custom-weekdays__option">
                                    <input type="checkbox" value="2" name="customWeekdays" />
                                    <span>Wednesday</span>
                                </label>
                                <label class="responsibility-custom-weekdays__option">
                                    <input type="checkbox" value="3" name="customWeekdays" />
                                    <span>Thursday</span>
                                </label>
                                <label class="responsibility-custom-weekdays__option">
                                    <input type="checkbox" value="4" name="customWeekdays" />
                                    <span>Friday</span>
                                </label>
                                <label class="responsibility-custom-weekdays__option">
                                    <input type="checkbox" value="5" name="customWeekdays" />
                                    <span>Saturday</span>
                                </label>
                                <label class="responsibility-custom-weekdays__option">
                                    <input type="checkbox" value="6" name="customWeekdays" />
                                    <span>Sunday</span>
                                </label>
                            </div>
                        </fieldset>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="responsibility-assignee">Assign to <span class="required">*</span></label>
                            <select class="edit-form__input" id="responsibility-assignee" name="assigneeId" required>
                                <option value="">Select a team member</option>
                            </select>
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="responsibility-action">5D Action <span class="required">*</span></label>
                            <select class="edit-form__input" id="responsibility-action" name="action" required>
                                <option value="">Select</option>
                                <option value="done">Done</option>
                                <option value="delegated">Delegated</option>
                                <option value="deferred">Deferred</option>
                                <option value="discussed">Discussed</option>
                                <option value="deleted">Deleted</option>
                            </select>
                        </div>
                        <div class="edit-form__field" id="responsibility-delegated-field" hidden>
                            <label class="edit-form__label" for="responsibility-delegations-list">Delegated team members <span class="required">*</span></label>
                            <div class="responsibility-delegations" id="responsibility-delegations">
                                <div class="responsibility-delegations__list" id="responsibility-delegations-list"></div>
                                <button
                                    type="button"
                                    class="button button--secondary button--small responsibility-delegations__add"
                                    id="responsibility-add-delegation"
                                >Add delegated team member</button>
                                <p class="edit-form__hint">Split the responsibility target among the team members below.</p>
                            </div>
                        </div>
                        <template id="responsibility-delegation-template">
                            <div class="responsibility-delegations__row">
                                <select class="edit-form__input responsibility-delegations__select" name="delegationManager"></select>
                                <input
                                    type="text"
                                    class="edit-form__input responsibility-delegations__value"
                                    name="delegationValue"
                                    inputmode="decimal"
                                    placeholder="Allocated value"
                                />
                                <button
                                    type="button"
                                    class="button button--ghost button--small responsibility-delegations__remove"
                                    aria-label="Remove delegated team member"
                                >Remove</button>
                            </div>
                        </template>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="responsibility-progress">Progress (%)</label>
                            <input
                                class="edit-form__input"
                                id="responsibility-progress"
                                name="progress"
                                type="number"
                                min="0"
                                max="100"
                                step="1"
                                inputmode="numeric"
                                value="0"
                            />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="responsibility-performance-unit">Unit of measure <span class="required">*</span></label>
                            <select
                                class="edit-form__input"
                                id="responsibility-performance-unit"
                                name="performanceUnit"
                                required
                            ></select>
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="responsibility-performance-responsible">Responsible <span class="required">*</span></label>
                            <input
                                class="edit-form__input"
                                id="responsibility-performance-responsible"
                                name="performanceResponsible"
                                required
                            />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="responsibility-performance-actual">Actual</label>
                            <input
                                class="edit-form__input"
                                id="responsibility-performance-actual"
                                name="performanceActual"
                            />
                        </div>
                        <div class="edit-form__field">
                            <label class="edit-form__label" for="responsibility-performance-metric">Performance metric</label>
                            <input
                                class="edit-form__input"
                                id="responsibility-performance-metric"
                                type="text"
                                readonly
                                tabindex="-1"
                            />
                        </div>
                        <div class="edit-form__field edit-form__field--full">
                            <span class="edit-form__label">Email notifications</span>
                            <div class="edit-form__group edit-form__group--columns">
                                <div class="edit-form__subfield">
                                    <label class="edit-form__label--sub" for="responsibility-recipient">To <span class="required">*</span></label>
                                    <input
                                        class="edit-form__input"
                                        id="responsibility-recipient"
                                        name="recipientEmail"
                                        type="email"
                                        inputmode="email"
                                        required
                                        autocomplete="email"
                                    />
                                </div>
                                <div class="edit-form__subfield">
                                    <label class="edit-form__label--sub" for="responsibility-cc">CC</label>
                                    <input
                                        class="edit-form__input"
                                        id="responsibility-cc"
                                        name="ccEmail"
                                        type="email"
                                        inputmode="email"
                                        autocomplete="email"
                                        placeholder="name@example.com"
                                    />
                                </div>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="responsibility-action-notes" name="actionNotes" />
                    <div class="modal__actions">
                        <button type="button" class="button button--ghost" id="responsibility-cancel">Cancel</button>
                        <button type="submit" class="button button--primary" id="responsibility-submit">Save responsibility</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal" id="responsibility-action-notes-modal" hidden aria-hidden="true">
        <div class="modal__overlay" data-modal-dismiss></div>
        <div class="modal__content" role="dialog" aria-modal="true" aria-labelledby="responsibility-action-notes-title">
            <header class="modal__header">
                <h2 class="modal__title" id="responsibility-action-notes-title">Discussion details</h2>
                <button type="button" class="modal__close" id="responsibility-action-notes-close" aria-label="Close notes editor">
                    <span aria-hidden="true">&times;</span>
                </button>
            </header>
            <div class="modal__body">
                <p class="modal__hint">Record discussion points or reasons for the selected 5D action.</p>
                <p class="alert alert--error" id="responsibility-action-notes-error" hidden></p>
                <div class="edit-form__field edit-form__field--full">
                    <label class="edit-form__label" for="responsibility-action-notes-text">Notes <span class="required">*</span></label>
                    <textarea class="edit-form__input" id="responsibility-action-notes-text" rows="4"></textarea>
                </div>
                <div class="modal__actions">
                    <button type="button" class="button button--ghost" id="responsibility-action-notes-cancel">Cancel</button>
                    <button type="button" class="button button--primary" id="responsibility-action-notes-save">Save notes</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js" integrity="sha384-8FmKpVzVfU6Ly3OJUokHknsE+Fjr12JOP5tBxOBE31AyGdSzZsv/CrKHr2TRVsyG" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js" crossorigin="anonymous"></script>
    <script src="{{ url_for('static', filename='js/responsibility-report.js') }}"></script>
    <script>
        const token = localStorage.getItem("samprox_token");
        const userRaw = localStorage.getItem("samprox_user");
        let user;

        try {
            user = userRaw ? JSON.parse(userRaw) : null;
        } catch (_) {
            user = null;
        }

        if (!token || !user) {
            window.location.href = "/";
        }

        if (user?.role !== "outside_manager") {
            window.location.replace("/mind");
        }

        const roleLabels = {
            admin: "Admin",
            production_manager: "Production Manager",
            maintenance_manager: "Maintenance Manager",
            finance_manager: "Finance Manager",
            technician: "Technician",
            outside_manager: "Member Of Rainbow Group",
        };

        const userNameEl = document.getElementById("user-name");
        const userRoleEl = document.getElementById("user-role");
        const logoutButton = document.getElementById("logout");

        userNameEl.textContent = user?.name || "Unknown";
        userRoleEl.textContent = roleLabels[user?.role] || "";

        logoutButton.addEventListener("click", async () => {
            try {
                await fetch("/api/auth/logout", { method: "POST", credentials: "include" });
            } catch (error) {
                console.error("Failed to log out", error);
            } finally {
                localStorage.removeItem("samprox_token");
                localStorage.removeItem("samprox_user");
                window.location.href = "/";
            }
        });

        const authHeaders = {
            Accept: "application/json",
            ...(token ? { Authorization: `Bearer ${token}` } : {}),
        };

        const responsibilityTableBody = document.getElementById("responsibility-table-body");
        const responsibilityEmptyState = document.getElementById("responsibility-empty");
        const responsibilityMessage = document.getElementById("responsibility-message");
        const responsibilityPeriodStartInput = document.getElementById("responsibility-period-start");
        const responsibilityPeriodEndInput = document.getElementById("responsibility-period-end");
        const responsibilityPeriodClearButton = document.getElementById("responsibility-period-clear");
        const responsibilityFilterColumnSelect = document.getElementById("responsibility-filter-column");
        const responsibilityFilterValueInput = document.getElementById("responsibility-filter-value");
        const responsibilityFilterClearButton = document.getElementById("responsibility-filter-clear");
        const responsibilitySortButtons = document.querySelectorAll(".responsibility-table__sort-button");
        const responsibilityReportForm = document.getElementById("responsibility-report-form");
        const responsibilityReportStart = document.getElementById("responsibility-report-start");
        const responsibilityReportEnd = document.getElementById("responsibility-report-end");
        const responsibilityReportMember = document.getElementById("responsibility-report-member");
        const responsibilityReportSummary = document.getElementById("responsibility-report-summary");
        const responsibilityReportMessage = document.getElementById("responsibility-report-message");
        const responsibilityReportTableBody = document.getElementById("responsibility-report-tbody");
        const responsibilityReportEmpty = document.getElementById("responsibility-report-empty");
        const responsibilityReportChart = document.getElementById("responsibility-report-chart");
        const responsibilityReportDownloads = document.querySelectorAll(
            ".responsibility-report [data-report-download]"
        );
        const responsibilityWeeklyForm = document.getElementById("responsibility-weekly-form");
        const responsibilityWeeklyMessage = document.getElementById("responsibility-weekly-message");
        const responsibilityWeeklyStartInput = document.getElementById("responsibility-weekly-start");
        const responsibilityWeeklyEmailInput = document.getElementById("responsibility-weekly-email");
        const responsibilityWeeklySendButton = document.getElementById("responsibility-weekly-send");
        const responsibilityCreateButton = document.getElementById("responsibility-create-button");
        const responsibilityModal = document.getElementById("responsibility-modal");
        const responsibilityModalTitle = document.getElementById("responsibility-modal-title");
        const responsibilityModalClose = document.getElementById("responsibility-modal-close");
        const responsibilityCancelButton = document.getElementById("responsibility-cancel");
        const responsibilityForm = document.getElementById("responsibility-form");
        const responsibilityFormError = document.getElementById("responsibility-form-error");
        const responsibilityTitleInput = document.getElementById("responsibility-title");
        const responsibilityDescriptionInput = document.getElementById("responsibility-description");
        const responsibilityDateInput = document.getElementById("responsibility-date");
        const responsibilityRecurrenceSelect = document.getElementById("responsibility-recurrence");
        const responsibilityCustomDays = document.getElementById("responsibility-custom-days");
        const responsibilityCustomWeekdays = document.getElementById("responsibility-custom-weekdays");
        const responsibilityAssigneeSelect = document.getElementById("responsibility-assignee");
        const responsibilityDetailInput = document.getElementById("responsibility-detail");
        const responsibilityActionSelect = document.getElementById("responsibility-action");
        const responsibilityDelegatedField = document.getElementById("responsibility-delegated-field");
        const responsibilityDelegationsContainer = document.getElementById("responsibility-delegations");
        const responsibilityDelegationsList = document.getElementById("responsibility-delegations-list");
        const responsibilityAddDelegationButton = document.getElementById("responsibility-add-delegation");
        const responsibilityDelegationTemplate = document.getElementById("responsibility-delegation-template");
        const responsibilityProgressInput = document.getElementById("responsibility-progress");
        const responsibilityPerformanceUnitSelect = document.getElementById("responsibility-performance-unit");
        const responsibilityPerformanceResponsibleInput = document.getElementById(
            "responsibility-performance-responsible",
        );
        const responsibilityPerformanceActualInput = document.getElementById(
            "responsibility-performance-actual",
        );
        const responsibilityPerformanceMetricInput = document.getElementById("responsibility-performance-metric");
        const responsibilityRecipientInput = document.getElementById("responsibility-recipient");
        const responsibilityCcInput = document.getElementById("responsibility-cc");
        const responsibilityActionNotesInput = document.getElementById("responsibility-action-notes");
        const responsibilitySubmitButton = document.getElementById("responsibility-submit");
        const responsibilityModalOverlay = responsibilityModal?.querySelector("[data-modal-dismiss]");
        const responsibilityActionNotesModal = document.getElementById("responsibility-action-notes-modal");
        const responsibilityActionNotesClose = document.getElementById("responsibility-action-notes-close");
        const responsibilityActionNotesTextarea = document.getElementById("responsibility-action-notes-text");
        const responsibilityActionNotesError = document.getElementById("responsibility-action-notes-error");
        const responsibilityActionNotesSave = document.getElementById("responsibility-action-notes-save");
        const responsibilityActionNotesCancel = document.getElementById("responsibility-action-notes-cancel");
        const responsibilityActionNotesOverlay = responsibilityActionNotesModal?.querySelector("[data-modal-dismiss]");
        const responsibilityModalDefaultTitle =
            responsibilityModalTitle?.textContent?.trim() || "New responsibility";
        const responsibilitySubmitDefaultText =
            responsibilitySubmitButton?.textContent?.trim() || "Save responsibility";
        const responsibilityTeamMembers = new Map();
        let responsibilityTasks = [];
        let responsibilityAssignees = [];
        let responsibilityEditingTaskId = null;
        let responsibilityEditingTask = null;
        let responsibilitySortKey = null;
        let responsibilitySortDirection = "ascending";
        let responsibilityFilterColumn = "all";
        let responsibilityFilterQuery = "";
        let responsibilityPeriodStart = "";
        let responsibilityPeriodEnd = "";
        const responsibilityEmptyDefaultText = responsibilityEmptyState?.textContent?.trim() || "";
        const responsibilityEmptyFilteredText = "No responsibilities match the selected filters.";

        const preferNonEmptyString = (...values) => {
            for (const value of values) {
                if (typeof value !== "string") {
                    continue;
                }

                const trimmed = value.trim();
                if (trimmed) {
                    return trimmed;
                }
            }

            return "";
        };

        const normalizeDisplayValue = (value) => {
            if (typeof value !== "string") {
                return value;
            }

            const trimmed = value.trim();
            if (!trimmed || trimmed === "—") {
                return "";
            }

            return trimmed;
        };

        const assignerNameFallback = (user) =>
            preferNonEmptyString(
                user?.nickname,
                user?.name,
                user?.regNumber,
                user?.reg_number,
                user?.email,
            );

        const resolveTeamMemberName = (id) => getStoredTeamMemberName(id) || "";

        const getMemberDisplayName = (member) => {
            const candidates = [member?.nickname, member?.name, member?.regNumber];

            for (const candidate of candidates) {
                if (typeof candidate === "string") {
                    const trimmed = candidate.trim();
                    if (trimmed) {
                        return trimmed;
                    }
                }
            }

            return "Team member";
        };

        const populateDelegationSelectOptions = (selectElement, selectedValue = "") => {
            if (!selectElement) {
                return;
            }

            const previousSelection = selectElement.value || selectedValue;
            const previousLabel = selectElement.selectedOptions?.[0]?.textContent || "";

            selectElement.innerHTML = "";

            const placeholder = document.createElement("option");
            placeholder.value = "";
            placeholder.textContent = "Select a team member";
            selectElement.appendChild(placeholder);

            responsibilityAssignees.forEach((assignee) => {
                if (!assignee?.id) {
                    return;
                }

                const option = document.createElement("option");
                option.value = String(assignee.id);
                option.textContent = assignerNameFallback(assignee) || option.value;
                if (previousSelection && option.value === String(previousSelection)) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            });

            if (previousSelection && !selectElement.value) {
                const fallback = document.createElement("option");
                fallback.value = String(previousSelection);
                fallback.textContent = previousLabel || String(previousSelection);
                fallback.selected = true;
                selectElement.appendChild(fallback);
            }
        };

        const clearResponsibilityDelegations = () => {
            if (responsibilityDelegationsList) {
                responsibilityDelegationsList.innerHTML = "";
            }
        };

        const createDelegationRow = (initialData = {}) => {
            if (!responsibilityDelegationsList) {
                return null;
            }

            let row = null;
            if (responsibilityDelegationTemplate?.content) {
                const clone = responsibilityDelegationTemplate.content.cloneNode(true);
                row = clone.querySelector(".responsibility-delegations__row");
            }

            if (!row) {
                row = document.createElement("div");
                row.className = "responsibility-delegations__row";

                const select = document.createElement("select");
                select.className = "edit-form__input responsibility-delegations__select";
                row.appendChild(select);

                const input = document.createElement("input");
                input.type = "text";
                input.className = "edit-form__input responsibility-delegations__value";
                input.setAttribute("inputmode", "decimal");
                input.placeholder = "Allocated value";
                row.appendChild(input);

                const removeButton = document.createElement("button");
                removeButton.type = "button";
                removeButton.className = "button button--ghost button--small responsibility-delegations__remove";
                removeButton.textContent = "Remove";
                row.appendChild(removeButton);
            }

            const select = row.querySelector(".responsibility-delegations__select");
            const valueInput = row.querySelector(".responsibility-delegations__value");
            const removeButton = row.querySelector(".responsibility-delegations__remove");

            const delegateId =
                initialData?.delegateId ??
                initialData?.delegate_id ??
                initialData?.delegateMemberId ??
                initialData?.delegate_member_id ??
                initialData?.delegate?.id ??
                initialData?.delegate_member?.id ??
                "";

            populateDelegationSelectOptions(select, delegateId);

            if (delegateId && select && select.value !== String(delegateId)) {
                const fallback = document.createElement("option");
                fallback.value = String(delegateId);
                fallback.textContent =
                    assignerNameFallback(initialData?.delegate) ||
                    assignerNameFallback(initialData?.delegate_member) ||
                    String(delegateId);
                select.appendChild(fallback);
                select.value = String(delegateId);
            }

            if (valueInput) {
                const allocation =
                    initialData?.allocatedValue ??
                    initialData?.allocated_value ??
                    initialData?.allocation ??
                    "";
                valueInput.value = allocation !== null && allocation !== undefined ? String(allocation) : "";
            }

            if (removeButton) {
                removeButton.addEventListener("click", () => {
                    row.remove();
                });
            }

            responsibilityDelegationsList.appendChild(row);
            return row;
        };

        const ensureDelegationRow = () => {
            if (responsibilityDelegationsList?.childElementCount === 0) {
                createDelegationRow();
            }
        };

        const updateDelegationSelectOptions = () => {
            if (!responsibilityDelegationsList) {
                return;
            }

            responsibilityDelegationsList
                .querySelectorAll(".responsibility-delegations__select")
                .forEach((select) => populateDelegationSelectOptions(select));
        };

        const RESPONSIBILITY_WEEKDAY_NAMES = [
            "Monday",
            "Tuesday",
            "Wednesday",
            "Thursday",
            "Friday",
            "Saturday",
            "Sunday",
        ];

        const RESPONSIBILITY_RECURRENCE_LABELS = {
            does_not_repeat: "Does not repeat",
            monday_to_friday: "Monday to Friday",
            daily: "Daily",
            weekly: "Weekly on (Today)",
            monthly: "Monthly on (Today)",
            annually: "Annually on (Today)",
            custom: "Custom",
        };

        const RESPONSIBILITY_STATUS_LABELS = {
            planned: "Planned",
            in_progress: "In progress",
            completed: "Completed",
            cancelled: "Cancelled",
        };

        const RESPONSIBILITY_ACTION_LABELS = {
            done: "Done",
            delegated: "Delegated",
            deferred: "Deferred",
            discussed: "Discussed",
            deleted: "Deleted",
        };

        const ACTIONS_REQUIRING_NOTES = new Set(["delegated", "deferred", "discussed", "deleted"]);

        const PERFORMANCE_DEFAULT_UNIT = "percentage_pct";
        const PERFORMANCE_UNIT_VALUES = [
            "date",
            "time",
            "hours",
            "minutes",
            "days",
            "weeks",
            "months",
            "years",
            "quantity_based",
            "qty",
            "units",
            "pieces",
            "batches",
            "items",
            "parcels",
            "orders",
            "amount_lkr",
            "revenue",
            "cost",
            "expense",
            "profit",
            "savings",
            "margin_pct",
            "number",
            "count",
            "score",
            "frequency",
            "rate",
            "index",
            "kg",
            "tonnes",
            "litres",
            "meters",
            "kwh",
            "rpm",
            "quality_metric",
            "percentage_pct",
            "error_rate_pct",
            "success_rate_pct",
            "defects_per_unit",
            "accuracy_pct",
            "compliance_pct",
            "time_per_unit",
            "units_per_hour",
            "cycle_time",
            "lead_time",
            "customer_count",
            "leads",
            "conversion_pct",
            "tickets_resolved",
            "response_time",
            "milestones",
            "stages",
            "completion_pct",
            "tasks_completed",
            "sla_pct",
        ];

        const PERFORMANCE_LABEL_OVERRIDES = {
            quantity_based: "Quantity-based",
            qty: "Quantity (Qty)",
            amount_lkr: "Amount (LKR)",
            kg: "Kilograms (kg)",
            kwh: "kWh",
            rpm: "RPM",
            quality_metric: "Quality Metrics",
            percentage_pct: "Percentage (%)",
            margin_pct: "Margin (%)",
            error_rate_pct: "Error Rate (%)",
            success_rate_pct: "Success Rate (%)",
            accuracy_pct: "Accuracy (%)",
            compliance_pct: "Compliance (%)",
            conversion_pct: "Conversion (%)",
            completion_pct: "Completion (%)",
            sla_pct: "SLA (%)",
            time_per_unit: "Time per Unit",
            units_per_hour: "Units per Hour",
            cycle_time: "Cycle Time",
            lead_time: "Lead Time",
            response_time: "Response Time (Minutes/Hours)",
            customer_count: "Customer Count",
            tickets_resolved: "Tickets Resolved",
            tasks_completed: "Tasks Completed",
        };

        const PERFORMANCE_INTEGER_UNITS = new Set([
            "quantity_based",
            "qty",
            "units",
            "pieces",
            "batches",
            "items",
            "parcels",
            "orders",
            "number",
            "count",
            "score",
            "frequency",
            "rate",
            "index",
            "customer_count",
            "leads",
            "tickets_resolved",
            "milestones",
            "stages",
            "tasks_completed",
        ]);

        const PERFORMANCE_PERCENT_UNITS = new Set([
            "margin_pct",
            "percentage_pct",
            "error_rate_pct",
            "success_rate_pct",
            "accuracy_pct",
            "compliance_pct",
            "conversion_pct",
            "completion_pct",
            "sla_pct",
        ]);

        const PERFORMANCE_CURRENCY_UNITS = new Set([
            "amount_lkr",
            "revenue",
            "cost",
            "expense",
            "profit",
            "savings",
        ]);

        const PERFORMANCE_DATE_UNITS = new Set(["date"]);
        const PERFORMANCE_TIME_UNITS = new Set(["time"]);
        const PERFORMANCE_DURATION_UNITS = new Set([
            "hours",
            "minutes",
            "days",
            "weeks",
            "months",
            "years",
            "time_per_unit",
            "units_per_hour",
            "cycle_time",
            "lead_time",
            "response_time",
        ]);

        const PERFORMANCE_DECIMAL_STEP_UNITS = new Set([
            "kg",
            "tonnes",
            "litres",
            "meters",
            "kwh",
            "rpm",
            "quality_metric",
            "defects_per_unit",
        ]);

        const PERFORMANCE_CURRENCY_FORMATTER = new Intl.NumberFormat(undefined, {
            style: "currency",
            currency: "LKR",
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
        });

        const PERFORMANCE_NUMBER_FORMATTERS = new Map();
        const PERFORMANCE_EPOCH_MS = Date.UTC(1970, 0, 1);

        const getNumberFormatter = (decimals = 2) => {
            const key = Number(decimals);
            if (!PERFORMANCE_NUMBER_FORMATTERS.has(key)) {
                PERFORMANCE_NUMBER_FORMATTERS.set(
                    key,
                    new Intl.NumberFormat(undefined, {
                        minimumFractionDigits: Math.max(0, decimals),
                        maximumFractionDigits: Math.max(0, decimals),
                    }),
                );
            }
            return PERFORMANCE_NUMBER_FORMATTERS.get(key);
        };

        const toTitleCase = (value) =>
            String(value || "")
                .replace(/_/g, " ")
                .replace(/\b\w/g, (letter) => letter.toUpperCase());

        const getPerformanceConfig = (unitValue) => {
            const normalized = (unitValue || PERFORMANCE_DEFAULT_UNIT).toString().trim() || PERFORMANCE_DEFAULT_UNIT;
            const label = PERFORMANCE_LABEL_OVERRIDES[normalized] || toTitleCase(normalized);
            const config = {
                value: normalized,
                label,
                input: "number",
                format: "decimal",
                step: "0.1",
                decimals: 2,
                metricDecimals: 1,
            };

            if (PERFORMANCE_DATE_UNITS.has(normalized)) {
                config.input = "date";
                config.format = "date";
                config.decimals = 0;
                config.metricDecimals = 0;
            } else if (PERFORMANCE_TIME_UNITS.has(normalized)) {
                config.input = "time";
                config.format = "time";
                config.decimals = 0;
                config.metricDecimals = 0;
            } else if (PERFORMANCE_PERCENT_UNITS.has(normalized)) {
                config.format = "percentage";
                config.step = "0.1";
                config.decimals = 1;
                config.metricDecimals = 1;
            } else if (PERFORMANCE_CURRENCY_UNITS.has(normalized)) {
                config.format = "currency";
                config.step = "0.01";
                config.decimals = 2;
                config.metricDecimals = 2;
            } else if (PERFORMANCE_INTEGER_UNITS.has(normalized)) {
                config.format = "integer";
                config.step = "1";
                config.decimals = 0;
                config.metricDecimals = 0;
            } else if (PERFORMANCE_DURATION_UNITS.has(normalized)) {
                config.step = "0.1";
                config.decimals = 2;
                config.metricDecimals = 1;
            } else if (PERFORMANCE_DECIMAL_STEP_UNITS.has(normalized)) {
                config.step = "0.01";
                config.decimals = 2;
                config.metricDecimals = 2;
            }

            return config;
        };

        const roundHalfAwayFromZero = (value, decimals = 0) => {
            if (!Number.isFinite(value)) {
                return value;
            }
            const factor = 10 ** decimals;
            if (value >= 0) {
                return Math.round(value * factor) / factor;
            }
            return -Math.round(Math.abs(value) * factor) / factor;
        };

        const parsePerformanceInputValue = (rawValue, unitValue, config) => {
            const value = rawValue == null ? "" : rawValue.toString().trim();
            if (!value) {
                return { numeric: null, isBlank: true, isValid: true };
            }

            if (config.format === "date") {
                const parsed = new Date(`${value}T00:00:00Z`);
                if (Number.isNaN(parsed.getTime())) {
                    return { numeric: null, isBlank: false, isValid: false };
                }
                const days = Math.floor((parsed.getTime() - PERFORMANCE_EPOCH_MS) / 86_400_000);
                return { numeric: days, isBlank: false, isValid: true };
            }

            if (config.format === "time") {
                const parts = value.split(":");
                if (parts.length < 2) {
                    return { numeric: null, isBlank: false, isValid: false };
                }
                const hours = Number.parseInt(parts[0], 10);
                const minutes = Number.parseInt(parts[1], 10);
                if (!Number.isFinite(hours) || Number.isNaN(minutes)) {
                    return { numeric: null, isBlank: false, isValid: false };
                }
                return { numeric: hours * 60 + minutes, isBlank: false, isValid: true };
            }

            const numeric = Number.parseFloat(value);
            if (!Number.isFinite(numeric)) {
                return { numeric: null, isBlank: false, isValid: false };
            }
            return { numeric, isBlank: false, isValid: true };
        };

        const formatNumberWithDecimals = (value, decimals = 2) => {
            if (!Number.isFinite(value)) {
                return String(value ?? "");
            }
            return getNumberFormatter(decimals).format(value);
        };

        const formatPerformanceValueDisplay = (rawValue, unitValue, config) => {
            if (rawValue === null || rawValue === undefined || rawValue === "") {
                return "—";
            }
            if (config.format === "date" || config.format === "time") {
                return rawValue;
            }
            const numeric = Number.parseFloat(rawValue);
            if (!Number.isFinite(numeric)) {
                return rawValue;
            }
            if (config.format === "currency") {
                return PERFORMANCE_CURRENCY_FORMATTER.format(numeric);
            }
            if (config.format === "percentage") {
                return `${formatNumberWithDecimals(numeric, config.decimals ?? 1)}%`;
            }
            const decimals = config.format === "integer" ? 0 : config.decimals ?? 2;
            return formatNumberWithDecimals(numeric, decimals);
        };

        const formatResponsibilityDelegations = (task, unitValue, performanceConfig) => {
            // If the backend has already decorated a human-friendly delegate name,
            // always prefer that instead of trying to reconstruct it or falling
            // back to numeric IDs.
            const primaryName = normalizeDisplayValue(task?.delegatedToName);
            if (primaryName) {
                return primaryName;
            }
            const delegations = Array.isArray(task?.delegations) ? task.delegations : [];

            if (delegations.length === 0) {
                const fallback = preferNonEmptyString(
                    task?.delegatedTo?.name,
                    task?.delegatedToName,
                    getResponsibilityTeamMemberDisplay(task, "delegatedTo"),
                    assignerNameFallback(task?.delegatedTo),
                    task?.delegatedTo?.email,
                );
                return fallback || "—";
            }

            const parts = delegations
                .map((entry) => {
                    if (!entry) {
                        return null;
                    }

                    const delegateName = preferNonEmptyString(
                        entry?.delegateName,
                        resolveTeamMemberName(entry?.delegateId),
                        assignerNameFallback(entry?.delegate),
                        entry?.delegate?.email,
                    );

                    const rawValue =
                        entry?.allocatedValue ??
                        entry?.allocated_value ??
                        entry?.value ??
                        "";

                    let formattedValue = rawValue;
                    if (rawValue !== null && rawValue !== undefined && rawValue !== "") {
                        formattedValue = formatPerformanceValueDisplay(
                            rawValue,
                            unitValue,
                            performanceConfig,
                        );
                    }

                    if (delegateName && formattedValue && formattedValue !== "—") {
                        return `${delegateName} (${formattedValue})`;
                    }

                    return delegateName || null;
                })
                .filter(Boolean);

            return parts.length > 0 ? parts.join(", ") : "—";
        };

        const formatTimeDifference = (minutes) => {
            if (!Number.isFinite(minutes)) {
                return "—";
            }
            if (minutes === 0) {
                return "0m";
            }
            const prefix = minutes > 0 ? "+" : "-";
            const absolute = Math.abs(Math.trunc(minutes));
            const hours = Math.floor(absolute / 60);
            const mins = absolute % 60;
            const parts = [];
            if (hours > 0) {
                parts.push(`${hours}h`);
            }
            if (mins > 0 || hours === 0) {
                parts.push(`${mins}m`);
            }
            return `${prefix}${parts.join(" ")}`;
        };

        const formatPerformanceMetricDisplay = (rawMetric, unitValue, config) => {
            if (rawMetric === null || rawMetric === undefined || rawMetric === "") {
                return "—";
            }
            const metric = Number.parseFloat(rawMetric);
            if (!Number.isFinite(metric)) {
                return "—";
            }
            if (config.format === "date") {
                if (metric === 0) {
                    return "0 days";
                }
                const suffix = Math.abs(metric) === 1 ? "day" : "days";
                return `${metric > 0 ? "+" : ""}${metric} ${suffix}`;
            }
            if (config.format === "time") {
                return formatTimeDifference(metric);
            }
            if (config.format === "currency") {
                const formatted = PERFORMANCE_CURRENCY_FORMATTER.format(metric);
                return metric > 0 ? `+${formatted}` : formatted;
            }
            if (config.format === "percentage") {
                const absolute = Math.abs(metric);
                const formatted = formatNumberWithDecimals(absolute, config.metricDecimals ?? 1);
                if (metric === 0) {
                    return `${formatted}%`;
                }
                return `${metric > 0 ? "+" : "-"}${formatted}%`;
            }
            const decimals = config.format === "integer" ? 0 : config.metricDecimals ?? 1;
            const formatted = formatNumberWithDecimals(Math.abs(metric), decimals);
            if (metric === 0) {
                return formatted;
            }
            return `${metric > 0 ? "+" : "-"}${formatted}`;
        };

        const calculatePerformanceMetricNumeric = (unitValue, responsibleNumeric, actualNumeric, config) => {
            if (!Number.isFinite(responsibleNumeric) || !Number.isFinite(actualNumeric)) {
                return null;
            }
            if (config.format === "date" || config.format === "time") {
                return actualNumeric - responsibleNumeric;
            }
            return roundHalfAwayFromZero(actualNumeric - responsibleNumeric, config.metricDecimals ?? 1);
        };

        const populatePerformanceUnitOptions = () => {
            if (!responsibilityPerformanceUnitSelect) {
                return;
            }
            responsibilityPerformanceUnitSelect.innerHTML = "";
            PERFORMANCE_UNIT_VALUES.forEach((unit) => {
                const config = getPerformanceConfig(unit);
                const option = document.createElement("option");
                option.value = unit;
                option.textContent = config.label;
                responsibilityPerformanceUnitSelect.appendChild(option);
            });
        };

        const getSelectedPerformanceConfig = () => {
            const unitValue = responsibilityPerformanceUnitSelect?.value || PERFORMANCE_DEFAULT_UNIT;
            return getPerformanceConfig(unitValue);
        };

        const applyPerformanceInputAttributes = (input, config) => {
            if (!input) {
                return;
            }
            if (config.input === "date") {
                input.type = "date";
                input.removeAttribute("step");
                input.removeAttribute("min");
                input.removeAttribute("max");
                input.removeAttribute("inputmode");
            } else if (config.input === "time") {
                input.type = "time";
                input.step = "60";
                input.removeAttribute("min");
                input.removeAttribute("max");
                input.removeAttribute("inputmode");
            } else {
                input.type = "number";
                if (config.step) {
                    input.step = config.step;
                } else {
                    input.removeAttribute("step");
                }
                if (config.min !== undefined) {
                    input.min = String(config.min);
                } else {
                    input.removeAttribute("min");
                }
                if (config.max !== undefined) {
                    input.max = String(config.max);
                } else {
                    input.removeAttribute("max");
                }
                input.inputMode = config.format === "integer" ? "numeric" : "decimal";
            }
        };

        const updatePerformanceUnitState = () => {
            const config = getSelectedPerformanceConfig();
            applyPerformanceInputAttributes(responsibilityPerformanceResponsibleInput, config);
            applyPerformanceInputAttributes(responsibilityPerformanceActualInput, config);
        };

        const updatePerformanceMetricDisplay = () => {
            if (!responsibilityPerformanceMetricInput) {
                return;
            }
            const config = getSelectedPerformanceConfig();
            const unitValue = config.value;
            const responsibleState = parsePerformanceInputValue(
                responsibilityPerformanceResponsibleInput?.value,
                unitValue,
                config,
            );
            const actualState = parsePerformanceInputValue(
                responsibilityPerformanceActualInput?.value,
                unitValue,
                config,
            );

            if (!responsibleState.isValid) {
                responsibilityPerformanceMetricInput.value = "—";
                return;
            }

            if (actualState.isBlank || !actualState.isValid) {
                responsibilityPerformanceMetricInput.value = "—";
                return;
            }

            const metricNumeric = calculatePerformanceMetricNumeric(
                unitValue,
                responsibleState.numeric,
                actualState.numeric,
                config,
            );
            responsibilityPerformanceMetricInput.value = formatPerformanceMetricDisplay(
                metricNumeric,
                unitValue,
                config,
            );
        };

        const PROGRESS_COLOR_RED = [217, 45, 32];
        const PROGRESS_COLOR_YELLOW = [254, 200, 75];
        const PROGRESS_COLOR_GREEN = [18, 183, 106];
        const PROGRESS_COLOR_GRAY = [152, 162, 179];

        const clampProgressValue = (value) => {
            if (value === null || value === undefined || value === "") {
                return 0;
            }
            const parsed = Number.parseFloat(value);
            if (Number.isNaN(parsed)) {
                return 0;
            }
            const rounded = Math.round(parsed);
            return Math.min(100, Math.max(0, rounded));
        };

        const interpolateProgressColor = (start, end, ratio) => {
            return start.map((component, index) => component + (end[index] - component) * ratio);
        };

        const toRgbString = (components) => {
            const [r, g, b] = components.map((component) => Math.round(component));
            return `rgb(${r}, ${g}, ${b})`;
        };

        const resolveProgressColor = (value, action) => {
            if (action === "deleted") {
                return toRgbString(PROGRESS_COLOR_GRAY);
            }
            if (value <= 0) {
                return toRgbString(PROGRESS_COLOR_RED);
            }
            if (value >= 100) {
                return toRgbString(PROGRESS_COLOR_GREEN);
            }
            if (value <= 50) {
                const ratio = value / 50;
                const color = interpolateProgressColor(PROGRESS_COLOR_RED, PROGRESS_COLOR_YELLOW, ratio);
                return toRgbString(color);
            }
            const ratio = (value - 50) / 50;
            const color = interpolateProgressColor(PROGRESS_COLOR_YELLOW, PROGRESS_COLOR_GREEN, ratio);
            return toRgbString(color);
        };

        const resolveProgressTextColor = (value, action) => {
            if (action === "deleted") {
                return "#1D2939";
            }
            return value >= 45 ? "#FFFFFF" : "#1D2939";
        };

        const renderResponsibilityProgress = (task) => {
            const action = task?.action || "";
            const progressValue = clampProgressValue(task?.progress);
            const statusText = formatResponsibilityStatus(task?.status);
            const displayText = `${progressValue}%`;
            const color = resolveProgressColor(progressValue, action);
            const textColor = resolveProgressTextColor(progressValue, action);
            const ariaText = statusText ? `${displayText} complete – ${statusText}` : `${displayText} complete`;
            const tooltipText = statusText ? `${displayText} complete • ${statusText}` : `${displayText} complete`;

            const container = document.createElement("div");
            container.className = "responsibility-progress";

            const track = document.createElement("div");
            track.className = "responsibility-progress__track";
            track.setAttribute("role", "progressbar");
            track.setAttribute("aria-valuemin", "0");
            track.setAttribute("aria-valuemax", "100");
            track.setAttribute("aria-valuenow", String(progressValue));
            track.setAttribute("aria-valuetext", ariaText);
            track.title = tooltipText;

            const fill = document.createElement("div");
            fill.className = "responsibility-progress__fill";
            fill.style.width = `${progressValue}%`;
            fill.style.backgroundColor = color;
            if (progressValue > 0) {
                fill.style.minWidth = "4px";
            }

            const text = document.createElement("span");
            text.className = "responsibility-progress__text";
            text.textContent = displayText;
            text.style.color = textColor;

            track.append(fill, text);
            container.append(track);

            return container;
        };

        const updateDelegatedVisibility = (actionValue) => {
            if (!responsibilityDelegatedField) {
                return;
            }
            const requiresDelegated = actionValue === "delegated";
            responsibilityDelegatedField.hidden = !requiresDelegated;
            if (requiresDelegated) {
                ensureDelegationRow();
            } else {
                clearResponsibilityDelegations();
            }
        };

        const setPlanMessage = (element, message, variant = "info") => {
            if (!element) {
                return;
            }

            const classes = ["responsibility-plan__message", `responsibility-plan__message--${variant}`];
            element.className = classes.join(" ");
            if (!message) {
                element.hidden = true;
                element.textContent = "";
                return;
            }

            element.hidden = false;
            element.textContent = message;
        };

        const clearResponsibilityFormError = () => {
            if (!responsibilityFormError) {
                return;
            }
            responsibilityFormError.hidden = true;
            responsibilityFormError.textContent = "";
        };

        const showResponsibilityFormError = (message) => {
            if (!responsibilityFormError) {
                return;
            }
            responsibilityFormError.hidden = false;
            responsibilityFormError.textContent = message;
        };

        const formatResponsibilityDate = (iso) => {
            if (!iso) {
                return "—";
            }
            try {
                const date = new Date(iso);
                return date.toLocaleDateString(undefined, {
                    weekday: "short",
                    month: "short",
                    day: "numeric",
                    year: "numeric",
                });
            } catch (_) {
                return "—";
            }
        };

        const formatResponsibilityDateTime = (value) => {
            if (!value) {
                return "—";
            }
            try {
                const date = new Date(value);
                return date.toLocaleString(undefined, {
                    year: "numeric",
                    month: "short",
                    day: "numeric",
                    hour: "2-digit",
                    minute: "2-digit",
                });
            } catch (_) {
                return "—";
            }
        };

        const formatResponsibilityStatus = (status) => {
            if (!status) {
                return "";
            }
            return RESPONSIBILITY_STATUS_LABELS[status] || status;
        };

        const formatResponsibilityAction = (action) => {
            if (!action) {
                return "—";
            }
            return RESPONSIBILITY_ACTION_LABELS[action] || action;
        };

        const resetResponsibilityFormState = () => {
            responsibilityEditingTaskId = null;
            responsibilityEditingTask = null;
            clearResponsibilityFormError();
            if (responsibilityForm) {
                responsibilityForm.reset();
            }
            if (responsibilityCcInput) {
                responsibilityCcInput.value = "";
            }
            if (responsibilityActionNotesInput) {
                responsibilityActionNotesInput.value = "";
            }
            if (responsibilityProgressInput) {
                responsibilityProgressInput.value = "0";
            }
            if (responsibilityPerformanceUnitSelect) {
                responsibilityPerformanceUnitSelect.value = PERFORMANCE_DEFAULT_UNIT;
            }
            if (responsibilityPerformanceResponsibleInput) {
                responsibilityPerformanceResponsibleInput.value = "";
            }
            if (responsibilityPerformanceActualInput) {
                responsibilityPerformanceActualInput.value = "";
            }
            if (responsibilityPerformanceMetricInput) {
                responsibilityPerformanceMetricInput.value = "—";
            }
            updatePerformanceUnitState();
            updatePerformanceMetricDisplay();
            responsibilityActionPreviousValue = "";
            responsibilityActionModalPreviousValue = "";
            responsibilityActionPreviousNotes.clear();
            clearResponsibilityDelegations();
            updateDelegatedVisibility("");
            responsibilityActionNotesTextarea?.setAttribute("aria-invalid", "false");
        };

        const openResponsibilityModal = (task = null) => {
            if (!responsibilityModal) {
                return;
            }

            resetResponsibilityFormState();

            const isEditing = Boolean(task && typeof task === "object");
            responsibilityEditingTaskId = isEditing ? task.id : null;
            responsibilityEditingTask = task;

            if (responsibilityModalTitle) {
                responsibilityModalTitle.textContent = isEditing ? "Update responsibility" : responsibilityModalDefaultTitle;
            }

            if (responsibilitySubmitButton) {
                responsibilitySubmitButton.textContent = isEditing ? "Update responsibility" : responsibilitySubmitDefaultText;
            }

            if (responsibilityForm && task) {
                responsibilityTitleInput.value = task.title || "";
                responsibilityDescriptionInput.value = task.description || "";
                responsibilityDetailInput.value = task.detail || "";
                responsibilityDateInput.value = task.scheduledFor || "";

                const recurrenceValue = task.recurrence || "does_not_repeat";
                responsibilityRecurrenceSelect.value = recurrenceValue;
                toggleCustomWeekdayFieldset();

                const performanceUnit = task.performanceUnit || PERFORMANCE_DEFAULT_UNIT;
                const performanceConfig = getPerformanceConfig(performanceUnit);
                if (responsibilityPerformanceUnitSelect) {
                    responsibilityPerformanceUnitSelect.value = performanceUnit;
                }
                updatePerformanceUnitState();
                if (responsibilityPerformanceResponsibleInput) {
                    responsibilityPerformanceResponsibleInput.value = task.performanceResponsible ?? "";
                }
                if (responsibilityPerformanceActualInput) {
                    responsibilityPerformanceActualInput.value = task.performanceActual ?? "";
                }
                if (responsibilityPerformanceMetricInput) {
                    responsibilityPerformanceMetricInput.value = formatPerformanceMetricDisplay(
                        task.performanceMetric,
                        performanceUnit,
                        performanceConfig,
                    );
                }
                updatePerformanceMetricDisplay();

                if (responsibilityCustomWeekdays) {
                    const selectedWeekdays = new Set(
                        Array.isArray(task.customWeekdays)
                            ? task.customWeekdays.map((value) => Number.parseInt(value, 10))
                            : [],
                    );
                    responsibilityCustomWeekdays.querySelectorAll("input[type='checkbox']").forEach((checkbox) => {
                        const inputValue = Number.parseInt(checkbox.value, 10);
                        checkbox.checked = selectedWeekdays.has(inputValue);
                    });
                }

                responsibilityRecipientInput.value = task.recipientEmail || "";
                if (responsibilityCcInput) {
                    responsibilityCcInput.value = task.ccEmail || "";
                }

                const ensureSelectOption = (select, taskData) => {
                    if (!select || !taskData) {
                        return;
                    }
                    const idCandidates = [taskData.assigneeId, taskData.assignee_id, taskData.assignee?.id];
                    const candidateId = idCandidates.find(
                        (value) => value !== null && value !== undefined && String(value).trim() !== "",
                    );
                    if (candidateId === undefined) {
                        return;
                    }
                    const value = String(candidateId);
                    let option = select.querySelector(`option[value="${value}"]`);
                    const label =
                        assignerNameFallback(taskData?.assignee) ||
                        preferNonEmptyString(taskData?.assigneeNickname, taskData?.assigneeName, taskData?.assigneeEmail);
                    if (!option) {
                        option = document.createElement("option");
                        option.value = value;
                        option.textContent = label ? label.trim() : value;
                        select.appendChild(option);
                    } else if (!option.textContent?.trim()) {
                        option.textContent = label ? label.trim() : value;
                    }
                    responsibilityAssigneeLookup.set(value, {
                        id: value,
                        name: option.textContent,
                        type:
                            taskData?.assigneeType ||
                            (taskData?.assignee && typeof taskData.assignee === "object" ? "user" : undefined),
                    });
                    select.value = value;
                };

                ensureSelectOption(responsibilityAssigneeSelect, task);

                clearResponsibilityDelegations();
                const delegations = Array.isArray(task.delegations) ? task.delegations : [];
                if (delegations.length > 0) {
                    delegations.forEach((delegation) => {
                        createDelegationRow({
                            ...delegation,
                            delegate: delegation?.delegate || delegation?.delegate_member,
                        });
                    });
                } else if (task.delegatedToId || task.delegatedTo) {
                    createDelegationRow({
                        delegateId: task.delegatedToId ?? task.delegatedTo?.id ?? "",
                        delegate: task.delegatedTo,
                        allocatedValue:
                            task.delegatedToAllocation ??
                            task.delegated_to_allocation ??
                            task.delegatedToValue ??
                            task.delegated_to_value ??
                            "",
                    });
                }

                const actionValue = task.action || "done";
                if (responsibilityActionSelect) {
                    responsibilityActionSelect.value = actionValue;
                }
                responsibilityActionPreviousValue = actionValue;
                updateDelegatedVisibility(actionValue);

                if (responsibilityProgressInput) {
                    const progressValue = clampProgressValue(task?.progress);
                    responsibilityProgressInput.value = String(progressValue);
                    if (actionValue === "done" || actionValue === "deleted") {
                        responsibilityProgressInput.readOnly = true;
                        delete responsibilityProgressInput.dataset.progressPrevious;
                    } else {
                        responsibilityProgressInput.readOnly = false;
                        delete responsibilityProgressInput.dataset.progressPrevious;
                    }
                }

                if (responsibilityActionNotesInput) {
                    responsibilityActionNotesInput.value = task.actionNotes || "";
                }
                if (responsibilityActionNotesTextarea) {
                    responsibilityActionNotesTextarea.value = task.actionNotes || "";
                }

                responsibilityActionPreviousNotes.clear();
                if (task.action) {
                    responsibilityActionPreviousNotes.set(task.action, task.actionNotes || "");
                }
            } else if (responsibilityForm) {
                responsibilityRecurrenceSelect.value = "does_not_repeat";
                updateRecurrenceOptionLabels();
                toggleCustomWeekdayFieldset();
                responsibilityCustomWeekdays.querySelectorAll("input[type='checkbox']").forEach((checkbox) => {
                    checkbox.checked = false;
                });
                if (responsibilityPerformanceUnitSelect) {
                    responsibilityPerformanceUnitSelect.value = PERFORMANCE_DEFAULT_UNIT;
                }
                updatePerformanceUnitState();
                if (responsibilityPerformanceResponsibleInput) {
                    responsibilityPerformanceResponsibleInput.value = "";
                }
                if (responsibilityPerformanceActualInput) {
                    responsibilityPerformanceActualInput.value = "";
                }
                if (responsibilityPerformanceMetricInput) {
                    responsibilityPerformanceMetricInput.value = "—";
                }
                updatePerformanceMetricDisplay();
            }

            responsibilityModal.removeAttribute("hidden");
            responsibilityModal.setAttribute("aria-hidden", "false");
            responsibilityModal.classList.add("modal--open");
            responsibilityTitleInput?.focus();
        };

        const closeResponsibilityModal = () => {
            if (!responsibilityModal) {
                return;
            }
            responsibilityModal.classList.remove("modal--open");
            responsibilityModal.setAttribute("hidden", "");
            responsibilityModal.setAttribute("aria-hidden", "true");
            resetResponsibilityFormState();
        };

        const appendCell = (text, options = {}) => {
            const cell = document.createElement("td");
            if (typeof text === "string" || typeof text === "number") {
                cell.textContent = text;
            } else if (text instanceof Node) {
                cell.appendChild(text);
            } else {
                cell.textContent = "—";
            }
            if (options.title) {
                cell.title = options.title;
            }
            return cell;
        };

        const getUserDisplay = (user, fallbacks = []) => {
            const candidates = [];

            if (user && typeof user === "object") {
                candidates.push(
                    user.nickname,
                    user.name,
                    user.regNumber,
                    user.reg_number,
                    user.email,
                );
            }

            if (Array.isArray(fallbacks)) {
                candidates.push(...fallbacks);
            } else if (typeof fallbacks === "string") {
                candidates.push(fallbacks);
            }

            for (const candidate of candidates) {
                if (typeof candidate === "string") {
                    const trimmed = candidate.trim();
                    if (trimmed) {
                        return trimmed;
                    }
                }
            }

            return "—";
        };

        const getResponsibilityTeamMemberDisplay = (task, relationKey) => {
            if (!task) {
                return "—";
            }

            const relation =
                relationKey === "assignee"
                    ? task?.assignee
                    : relationKey === "delegatedTo"
                    ? task?.delegatedTo
                    : null;

            const idCandidates = [
                relation?.id,
                relation?.memberId,
                relation?.member_id,
                task?.[`${relationKey}Id`],
                task?.[`${relationKey}_id`],
            ];

            for (const candidate of idCandidates) {
                const stored = getStoredTeamMemberName(candidate);
                if (stored) {
                    return stored;
                }
            }

            if (relation && typeof relation === "object") {
                const directDisplay = getMemberDisplayName(relation);
                if (directDisplay && directDisplay !== "Team member") {
                    return directDisplay;
                }
            }

            return getUserDisplay(relation, [task?.[`${relationKey}Name`], task?.[`${relationKey}Email`]]);
        };

        const getTaskAssigneeDisplay = (task) => {
            if (!task) {
                return "—";
            }

            const teamMemberDisplay = normalizeDisplayValue(
                getResponsibilityTeamMemberDisplay(task, "assignee"),
            );
            if (teamMemberDisplay) {
                return teamMemberDisplay;
            }

            const fallback = preferNonEmptyString(
                task?.assigneeName,
                assignerNameFallback(task?.assignee),
                task?.assigneeEmail,
            );
            if (fallback) {
                return fallback;
            }

            const idCandidates = [
                task?.assigneeId,
                task?.assignee_id,
                task?.assignee?.id,
                task?.assignee?.memberId,
                task?.assignee?.member_id,
            ];

            for (const candidate of idCandidates) {
                const storedName = getStoredTeamMemberName(candidate);
                if (storedName) {
                    return storedName;
                }
            }

            return getUserDisplay(task?.assignee, [task?.assigneeEmail]);
        };

        const getNormalizedDateString = (value) => {
            if (!value) {
                return "";
            }

            if (value instanceof Date) {
                if (Number.isNaN(value.getTime())) {
                    return "";
                }
                const year = String(value.getFullYear()).padStart(4, "0");
                const month = String(value.getMonth() + 1).padStart(2, "0");
                const day = String(value.getDate()).padStart(2, "0");
                return `${year}-${month}-${day}`;
            }

            if (typeof value === "string") {
                const trimmed = value.trim();
                if (!trimmed) {
                    return "";
                }
                if (/^\d{4}-\d{2}-\d{2}$/.test(trimmed)) {
                    return trimmed;
                }
                const parsed = new Date(trimmed);
                if (Number.isNaN(parsed.getTime())) {
                    return "";
                }
                const year = String(parsed.getFullYear()).padStart(4, "0");
                const month = String(parsed.getMonth() + 1).padStart(2, "0");
                const day = String(parsed.getDate()).padStart(2, "0");
                return `${year}-${month}-${day}`;
            }

            try {
                const parsed = new Date(value);
                if (Number.isNaN(parsed.getTime())) {
                    return "";
                }
                const year = String(parsed.getFullYear()).padStart(4, "0");
                const month = String(parsed.getMonth() + 1).padStart(2, "0");
                const day = String(parsed.getDate()).padStart(2, "0");
                return `${year}-${month}-${day}`;
            } catch (_) {
                return "";
            }
        };

        const sanitizeFilterValue = (value) => {
            if (value === null || value === undefined) {
                return "";
            }

            if (value instanceof Date) {
                return getNormalizedDateString(value);
            }

            if (typeof value === "number") {
                return Number.isFinite(value) ? String(value) : "";
            }

            if (typeof value === "string") {
                const trimmed = value.trim();
                if (!trimmed || trimmed === "—") {
                    return "";
                }
                return trimmed;
            }

            return String(value);
        };

        const getTaskPerformanceContext = (task) => {
            const unitValue = task?.performanceUnit || PERFORMANCE_DEFAULT_UNIT;
            return { unitValue, config: getPerformanceConfig(unitValue) };
        };

        const RESPONSIBILITY_TABLE_COLUMNS = {
            number: {
                label: "Responsibility No",
                type: "text",
                sortable: true,
                filterable: true,
                getValue: (task) => sanitizeFilterValue(preferNonEmptyString(task?.number, task?.id)),
            },
            title: {
                label: "Title",
                type: "text",
                sortable: true,
                filterable: true,
                getValue: (task) => sanitizeFilterValue(task?.title),
            },
            progress: {
                label: "Progress",
                type: "number",
                sortable: true,
                filterable: true,
                getValue: (task) => clampProgressValue(task?.progress),
                getFilterValue: (task) => String(clampProgressValue(task?.progress)),
            },
            assigner: {
                label: "Assigned by",
                type: "text",
                sortable: true,
                filterable: true,
                getValue: (task) =>
                    sanitizeFilterValue(
                        preferNonEmptyString(task?.assignerName, task?.assignerEmail, assignerNameFallback(task?.assigner)),
                    ),
            },
            assignee: {
                label: "Assigned to",
                type: "text",
                sortable: true,
                filterable: true,
                getValue: (task) => sanitizeFilterValue(getTaskAssigneeDisplay(task)),
            },
            delegatedTo: {
                label: "Delegated to",
                type: "text",
                sortable: true,
                filterable: true,
                getValue: (task) => {
                    const { unitValue, config } = getTaskPerformanceContext(task);
                    return sanitizeFilterValue(formatResponsibilityDelegations(task, unitValue, config));
                },
            },
            performanceUnit: {
                label: "Unit of Measure",
                type: "text",
                sortable: true,
                filterable: true,
                getValue: (task) => {
                    const { config } = getTaskPerformanceContext(task);
                    return sanitizeFilterValue(config.label);
                },
            },
            performanceResponsible: {
                label: "Responsible",
                type: "text",
                sortable: true,
                filterable: true,
                getValue: (task) => {
                    const { unitValue, config } = getTaskPerformanceContext(task);
                    return sanitizeFilterValue(
                        formatPerformanceValueDisplay(task?.performanceResponsible, unitValue, config),
                    );
                },
            },
            performanceActual: {
                label: "Actual",
                type: "text",
                sortable: true,
                filterable: true,
                getValue: (task) => {
                    const { unitValue, config } = getTaskPerformanceContext(task);
                    return sanitizeFilterValue(
                        formatPerformanceValueDisplay(task?.performanceActual, unitValue, config),
                    );
                },
            },
            performanceMetric: {
                label: "Performance Metric",
                type: "text",
                sortable: true,
                filterable: true,
                getValue: (task) => {
                    const { unitValue, config } = getTaskPerformanceContext(task);
                    return sanitizeFilterValue(
                        formatPerformanceMetricDisplay(task?.performanceMetric, unitValue, config),
                    );
                },
            },
            detail: {
                label: "Detail",
                type: "text",
                sortable: true,
                filterable: true,
                getValue: (task) => sanitizeFilterValue(task?.detail),
            },
            scheduledFor: {
                label: "Scheduled for",
                type: "date",
                sortable: true,
                filterable: true,
                getValue: (task) => {
                    const dateKey = getNormalizedDateString(task?.scheduledFor);
                    if (!dateKey) {
                        return null;
                    }
                    return new Date(`${dateKey}T00:00:00Z`);
                },
                getFilterValue: (task) => {
                    const normalized = getNormalizedDateString(task?.scheduledFor);
                    const formatted = sanitizeFilterValue(formatResponsibilityDate(task?.scheduledFor));
                    return sanitizeFilterValue([normalized, formatted].filter(Boolean).join(" "));
                },
            },
            action: {
                label: "5D Action",
                type: "text",
                sortable: true,
                filterable: true,
                getValue: (task) => sanitizeFilterValue(formatResponsibilityAction(task?.action)),
            },
            createdAt: {
                label: "Created",
                type: "date",
                sortable: true,
                filterable: true,
                getValue: (task) => {
                    if (!task?.createdAt) {
                        return null;
                    }
                    const parsed = new Date(task.createdAt);
                    return Number.isNaN(parsed.getTime()) ? null : parsed;
                },
                getFilterValue: (task) => {
                    const formatted = sanitizeFilterValue(formatResponsibilityDateTime(task?.createdAt));
                    const normalized = getNormalizedDateString(task?.createdAt);
                    return sanitizeFilterValue([normalized, formatted].filter(Boolean).join(" "));
                },
            },
        };

        const RESPONSIBILITY_FILTERABLE_KEYS = Object.entries(RESPONSIBILITY_TABLE_COLUMNS)
            .filter(([, config]) => config?.filterable)
            .map(([key]) => key);

        const getColumnFilterValue = (task, key) => {
            const definition = RESPONSIBILITY_TABLE_COLUMNS[key];
            if (!definition) {
                return "";
            }
            const rawValue =
                typeof definition.getFilterValue === "function"
                    ? definition.getFilterValue(task)
                    : definition.getValue(task);
            return sanitizeFilterValue(rawValue);
        };

        const getTaskScheduledDateKey = (task) => getNormalizedDateString(task?.scheduledFor);

        const getSortValue = (task, key) => {
            const definition = RESPONSIBILITY_TABLE_COLUMNS[key];
            if (!definition) {
                return { value: null, isEmpty: true };
            }

            const rawValue = definition.getValue(task);
            if (definition.type === "number") {
                const numeric = Number(rawValue);
                if (!Number.isFinite(numeric)) {
                    return { value: 0, isEmpty: true };
                }
                return { value: numeric, isEmpty: false };
            }

            if (definition.type === "date") {
                if (!rawValue) {
                    return { value: 0, isEmpty: true };
                }
                const dateValue = rawValue instanceof Date ? rawValue : new Date(rawValue);
                const timestamp = dateValue.getTime();
                if (!Number.isFinite(timestamp)) {
                    return { value: 0, isEmpty: true };
                }
                return { value: timestamp, isEmpty: false };
            }

            const textValue = sanitizeFilterValue(rawValue).toLowerCase();
            if (!textValue) {
                return { value: "", isEmpty: true };
            }
            return { value: textValue, isEmpty: false };
        };

        const matchesPeriodFilter = (task) => {
            if (!responsibilityPeriodStart && !responsibilityPeriodEnd) {
                return true;
            }
            const scheduledKey = getTaskScheduledDateKey(task);
            if (!scheduledKey) {
                return false;
            }
            if (responsibilityPeriodStart && scheduledKey < responsibilityPeriodStart) {
                return false;
            }
            if (responsibilityPeriodEnd && scheduledKey > responsibilityPeriodEnd) {
                return false;
            }
            return true;
        };

        const matchesFilterQuery = (task) => {
            const query = responsibilityFilterQuery.trim().toLowerCase();
            if (!query) {
                return true;
            }

            if (responsibilityFilterColumn && responsibilityFilterColumn !== "all") {
                const value = getColumnFilterValue(task, responsibilityFilterColumn).toLowerCase();
                return value.includes(query);
            }

            return RESPONSIBILITY_FILTERABLE_KEYS.some((key) =>
                getColumnFilterValue(task, key).toLowerCase().includes(query),
            );
        };

        const getFilteredResponsibilityTasks = () => {
            const tasks = Array.isArray(responsibilityTasks) ? responsibilityTasks : [];
            return tasks.filter((task) => matchesPeriodFilter(task) && matchesFilterQuery(task));
        };

        const sortResponsibilityTasks = (tasks) => {
            if (!responsibilitySortKey) {
                return tasks.slice();
            }

            const definition = RESPONSIBILITY_TABLE_COLUMNS[responsibilitySortKey];
            if (!definition?.sortable) {
                return tasks.slice();
            }

            return tasks.slice().sort((a, b) => {
                const aValue = getSortValue(a, responsibilitySortKey);
                const bValue = getSortValue(b, responsibilitySortKey);

                if (aValue.isEmpty && bValue.isEmpty) {
                    return 0;
                }
                if (aValue.isEmpty) {
                    return responsibilitySortDirection === "ascending" ? 1 : -1;
                }
                if (bValue.isEmpty) {
                    return responsibilitySortDirection === "ascending" ? -1 : 1;
                }

                if (aValue.value < bValue.value) {
                    return responsibilitySortDirection === "ascending" ? -1 : 1;
                }
                if (aValue.value > bValue.value) {
                    return responsibilitySortDirection === "ascending" ? 1 : -1;
                }
                return 0;
            });
        };

        const RESPONSIBILITY_SORT_ICONS = {
            ascending: "▲",
            descending: "▼",
            none: "⇅",
        };

        const updateSortIndicators = () => {
            responsibilitySortButtons.forEach((button) => {
                const key = button.dataset.sortKey;
                const header = button.closest("th");
                const icon = button.querySelector(".responsibility-table__sort-icon");
                const isActive = Boolean(key) && key === responsibilitySortKey;

                if (header) {
                    header.setAttribute(
                        "aria-sort",
                        isActive && responsibilitySortKey
                            ? responsibilitySortDirection === "descending"
                                ? "descending"
                                : "ascending"
                            : "none",
                    );
                }

                if (icon) {
                    if (!isActive || !responsibilitySortKey) {
                        icon.textContent = RESPONSIBILITY_SORT_ICONS.none;
                    } else if (responsibilitySortDirection === "descending") {
                        icon.textContent = RESPONSIBILITY_SORT_ICONS.descending;
                    } else {
                        icon.textContent = RESPONSIBILITY_SORT_ICONS.ascending;
                    }
                }
            });
        };

        const updateFilterPlaceholder = () => {
            if (!responsibilityFilterValueInput) {
                return;
            }

            if (!responsibilityFilterColumn || responsibilityFilterColumn === "all") {
                responsibilityFilterValueInput.placeholder = "Search responsibilities";
                return;
            }

            const definition = RESPONSIBILITY_TABLE_COLUMNS[responsibilityFilterColumn];
            const label = definition?.label || "column";
            responsibilityFilterValueInput.placeholder = `Search ${label.toLowerCase()}`;
        };

        const populateResponsibilityFilterOptions = () => {
            if (!responsibilityFilterColumnSelect) {
                return;
            }

            responsibilityFilterColumnSelect.innerHTML = "";

            const allOption = document.createElement("option");
            allOption.value = "all";
            allOption.textContent = "All columns";
            responsibilityFilterColumnSelect.appendChild(allOption);

            Object.entries(RESPONSIBILITY_TABLE_COLUMNS)
                .filter(([, config]) => config?.filterable)
                .forEach(([key, config]) => {
                    const option = document.createElement("option");
                    option.value = key;
                    option.textContent = config.label;
                    responsibilityFilterColumnSelect.appendChild(option);
                });

            responsibilityFilterColumnSelect.value = responsibilityFilterColumn || "all";
        };

        const renderResponsibilityRow = (task) => {
            const row = document.createElement("tr");
            row.dataset.id = task?.id;

            const openButton = document.createElement("button");
            openButton.type = "button";
            openButton.className = "button button--ghost button--small";
            openButton.textContent = "Update";
            openButton.addEventListener("click", () => {
                openResponsibilityModal(task);
            });

            const progressIndicator = renderResponsibilityProgress(task);

            const createdCell = document.createElement("td");
            createdCell.textContent = formatResponsibilityDateTime(task?.createdAt) ?? "—";

            const updateCell = document.createElement("td");
            updateCell.appendChild(openButton);

            const performanceUnitValue = task?.performanceUnit || PERFORMANCE_DEFAULT_UNIT;
            const performanceConfig = getPerformanceConfig(performanceUnitValue);

            const assignerDisplay = preferNonEmptyString(
                task?.assignerName,
                task?.assignerEmail,
                assignerNameFallback(task?.assigner),
            );

            const assigneeDisplay = getTaskAssigneeDisplay(task);
            const delegatedDisplay = formatResponsibilityDelegations(
                task,
                performanceUnitValue,
                performanceConfig,
            );

            row.append(
                appendCell(task?.number || "—"),
                appendCell(task?.title || "—"),
                appendCell(progressIndicator),
                appendCell(assignerDisplay || "—"),
                appendCell(assigneeDisplay || "—"),
                appendCell(delegatedDisplay || "—"),
                appendCell(performanceConfig.label),
                appendCell(
                    formatPerformanceValueDisplay(
                        task?.performanceResponsible,
                        performanceUnitValue,
                        performanceConfig,
                    ),
                ),
                appendCell(
                    formatPerformanceValueDisplay(
                        task?.performanceActual,
                        performanceUnitValue,
                        performanceConfig,
                    ),
                ),
                appendCell(
                    formatPerformanceMetricDisplay(
                        task?.performanceMetric,
                        performanceUnitValue,
                        performanceConfig,
                    ),
                ),
                appendCell(task?.detail || "—"),
                appendCell(formatResponsibilityDate(task?.scheduledFor)),
                appendCell(formatResponsibilityAction(task?.action), { title: task?.actionNotes }),
                createdCell,
                updateCell,
            );

            return row;
        };

        const renderResponsibilityTable = () => {
            if (!responsibilityTableBody) {
                return;
            }

            const hasPeriodFilter = Boolean(responsibilityPeriodStart || responsibilityPeriodEnd);
            const hasTextFilter = Boolean(responsibilityFilterQuery.trim());
            const hasActiveFilter = hasPeriodFilter || hasTextFilter;

            if (responsibilityEmptyState) {
                const fallbackText = responsibilityEmptyDefaultText || responsibilityEmptyState.textContent || "";
                responsibilityEmptyState.textContent = hasActiveFilter
                    ? responsibilityEmptyFilteredText
                    : fallbackText;
            }

            const filteredTasks = sortResponsibilityTasks(getFilteredResponsibilityTasks());
            responsibilityTableBody.innerHTML = "";

            if (filteredTasks.length === 0) {
                responsibilityEmptyState?.removeAttribute("hidden");
                updateSortIndicators();
                return;
            }

            responsibilityEmptyState?.setAttribute("hidden", "");

            filteredTasks.forEach((task) => {
                const row = renderResponsibilityRow(task);
                responsibilityTableBody.appendChild(row);
            });

            updateSortIndicators();
        };

        const updateResponsibilityTable = (tasks) => {
            responsibilityTasks = Array.isArray(tasks) ? tasks : [];
            renderResponsibilityTable();
        };

        const fetchResponsibilities = async () => {
            if (!token) {
                return;
            }

            try {
                const response = await fetch("/api/responsibilities", {
                    headers: authHeaders,
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    throw new Error(errorData?.msg || "Unable to load responsibilities.");
                }

                const data = await response.json();
                updateResponsibilityTable(data);
            } catch (error) {
                console.error("Failed to load responsibilities", error);
                setPlanMessage(
                    responsibilityMessage,
                    error?.message || "Unable to load responsibility plan.",
                    "error",
                );
            }
        };

        const getStoredTeamMemberName = (id) => {
            if (id === null || id === undefined) {
                return null;
            }

            const normalized = String(id).trim();
            if (!normalized) {
                return null;
            }

            const record = responsibilityTeamMembers.get(normalized);
            if (!record) {
                return null;
            }

            if (typeof record.displayName === "string" && record.displayName.trim()) {
                return record.displayName.trim();
            }

            return getMemberDisplayName(record);
        };

        const populateResponsibilityAssignees = (assignees = []) => {
            if (!responsibilityAssigneeSelect && !responsibilityDelegationsList) {
                return;
            }

            const normalizedAssignees = Array.isArray(assignees) ? assignees : [];
            responsibilityTeamMembers.clear();
            responsibilityAssignees = [];

            normalizedAssignees.forEach((assignee) => {
                if (!assignee || assignee.id === null || assignee.id === undefined) {
                    return;
                }

                const normalizedId = String(assignee.id).trim();
                if (!normalizedId) {
                    return;
                }

                const sourceMember =
                    assignee.member && typeof assignee.member === "object"
                        ? assignee.member
                        : {};

                const displayName =
                    assignee.name ??
                    getMemberDisplayName(sourceMember) ??
                    normalizedId;

                const record = {
                    id: normalizedId,
                    name: displayName,
                    nickname: sourceMember?.nickname ?? assignee.nickname ?? "",
                    regNumber:
                        sourceMember?.regNumber ??
                        sourceMember?.reg_number ??
                        assignee.regNumber ??
                        "",
                    email:
                        typeof assignee.email === "string" && assignee.email.trim()
                            ? assignee.email.trim()
                            : typeof sourceMember?.email === "string" && sourceMember.email.trim()
                            ? sourceMember.email.trim()
                            : undefined,
                    type: assignee.type || "team_member",
                    displayName,
                };

                responsibilityTeamMembers.set(normalizedId, record);
                responsibilityAssignees.push(record);
            });

            responsibilityAssignees.sort((a, b) =>
                a.displayName.localeCompare(b.displayName, undefined, { sensitivity: "base" }),
            );

            if (responsibilityAssigneeSelect) {
                const currentValue = responsibilityAssigneeSelect.value;
                responsibilityAssigneeSelect.innerHTML = "";
                const placeholder = document.createElement("option");
                placeholder.value = "";
                placeholder.textContent = "Select a team member";
                responsibilityAssigneeSelect.appendChild(placeholder);

                responsibilityAssignees.forEach((assignee) => {
                    const option = document.createElement("option");
                    option.value = String(assignee.id);
                    option.textContent = assignerNameFallback(assignee) || option.value;
                    if (currentValue && option.value === currentValue) {
                        option.selected = true;
                    }
                    responsibilityAssigneeSelect.appendChild(option);
                });
            }

            updateDelegationSelectOptions();
        };

        const fetchResponsibilityAssignees = async () => {
            if (!token) {
                return;
            }

            try {
                const response = await fetch("/api/team/members", {
                    headers: authHeaders,
                });

                if (!response.ok) {
                    const data = await response.json().catch(() => null);
                    throw new Error(data?.msg || "Unable to load team members.");
                }

                const data = await response.json();
                const uniqueMembers = new Map();

                (Array.isArray(data) ? data : []).forEach((member) => {
                    if (!member) {
                        return;
                    }

                    const rawId =
                        member?.id ?? member?.memberId ?? member?.regNumber ?? member?.reg_number;
                    if (rawId === null || rawId === undefined) {
                        return;
                    }

                    const parsedId = Number.parseInt(String(rawId).trim(), 10);
                    if (!Number.isFinite(parsedId)) {
                        return;
                    }

                    const normalizedId = String(parsedId);
                    if (uniqueMembers.has(normalizedId)) {
                        return;
                    }

                    const displayName = getMemberDisplayName(member);
                    uniqueMembers.set(normalizedId, {
                        id: normalizedId,
                        name: displayName,
                        nickname: typeof member?.nickname === "string" ? member.nickname : undefined,
                        regNumber:
                            typeof member?.regNumber === "string"
                                ? member.regNumber
                                : typeof member?.reg_number === "string"
                                ? member.reg_number
                                : undefined,
                        email:
                            typeof member?.email === "string" && member.email.trim()
                                ? member.email.trim()
                                : undefined,
                        type: "team_member",
                        member,
                    });
                });

                const assignees = Array.from(uniqueMembers.values()).sort((a, b) =>
                    a.name.localeCompare(b.name, undefined, { sensitivity: "base" }),
                );

                populateResponsibilityAssignees(assignees);
            } catch (error) {
                console.error("Failed to load responsibility team members", error);
            }
        };

        const toIsoDateString = (date) => {
            if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
                return "";
            }
            const offset = date.getTimezoneOffset();
            const normalized = new Date(date.getTime() - offset * 60000);
            return normalized.toISOString().split("T")[0];
        };

        const updateRecurrenceOptionLabels = () => {
            if (!responsibilityRecurrenceSelect) {
                return;
            }

            const today = new Date();
            const weekday = today.toLocaleDateString(undefined, { weekday: "long" });
            const dayOfMonth = today.getDate();
            const monthName = today.toLocaleDateString(undefined, { month: "long" });

            Array.from(responsibilityRecurrenceSelect.options).forEach((option) => {
                const baseLabel = RESPONSIBILITY_RECURRENCE_LABELS[option.value] || option.textContent;
                if (!baseLabel) {
                    return;
                }
                if (option.value === "weekly") {
                    option.textContent = baseLabel.replace("(Today)", weekday);
                } else if (option.value === "monthly") {
                    option.textContent = baseLabel.replace("(Today)", `${dayOfMonth}${getOrdinalSuffix(dayOfMonth)}`);
                } else if (option.value === "annually") {
                    option.textContent = baseLabel.replace("(Today)", `${monthName} ${dayOfMonth}`);
                } else {
                    option.textContent = baseLabel;
                }
            });
        };

        const getOrdinalSuffix = (day) => {
            if (![11, 12, 13].includes(day % 100)) {
                switch (day % 10) {
                    case 1:
                        return "st";
                    case 2:
                        return "nd";
                    case 3:
                        return "rd";
                }
            }
            return "th";
        };

        const toggleCustomWeekdayFieldset = () => {
            if (!responsibilityCustomDays || !responsibilityRecurrenceSelect) {
                return;
            }
            const isCustom = responsibilityRecurrenceSelect.value === "custom";
            if (isCustom) {
                responsibilityCustomDays.removeAttribute("hidden");
                responsibilityCustomWeekdays.querySelectorAll("input[type='checkbox']").forEach((checkbox) => {
                    checkbox.required = true;
                });
            } else {
                responsibilityCustomDays.setAttribute("hidden", "");
                responsibilityCustomWeekdays.querySelectorAll("input[type='checkbox']").forEach((checkbox) => {
                    checkbox.checked = false;
                    checkbox.required = false;
                });
            }
        };

        const responsibilityActionPreviousNotes = new Map();
        let responsibilityActionPreviousValue = "";
        let responsibilityActionModalPreviousValue = "";

        const setResponsibilityActionNotesError = (message = "") => {
            if (!responsibilityActionNotesError) {
                return;
            }

            const text = typeof message === "string" ? message.trim() : "";
            if (!text) {
                responsibilityActionNotesError.hidden = true;
                responsibilityActionNotesError.textContent = "";
                return;
            }

            responsibilityActionNotesError.hidden = false;
            responsibilityActionNotesError.textContent = text;
        };

        const openResponsibilityActionNotesModal = (previousActionValue = "") => {
            if (!responsibilityActionNotesModal) {
                return;
            }

            responsibilityActionModalPreviousValue =
                previousActionValue ?? responsibilityActionSelect?.value ?? "";

            setResponsibilityActionNotesError();
            responsibilityActionNotesModal.removeAttribute("hidden");
            responsibilityActionNotesModal.setAttribute("aria-hidden", "false");
            responsibilityActionNotesModal.classList.add("modal--open");

            if (responsibilityActionNotesTextarea) {
                requestAnimationFrame(() => {
                    responsibilityActionNotesTextarea.focus();
                    const length = responsibilityActionNotesTextarea.value.length;
                    responsibilityActionNotesTextarea.setSelectionRange(length, length);
                });
            }
        };

        const closeResponsibilityActionNotesModal = (restorePreviousSelection = false) => {
            if (!responsibilityActionNotesModal) {
                return;
            }

            responsibilityActionNotesModal.classList.remove("modal--open");
            responsibilityActionNotesModal.setAttribute("hidden", "");
            responsibilityActionNotesModal.setAttribute("aria-hidden", "true");

            if (restorePreviousSelection) {
                const previousAction = responsibilityActionModalPreviousValue || "";
                if (responsibilityActionSelect) {
                    responsibilityActionSelect.value = previousAction;
                }
                responsibilityActionPreviousValue = previousAction;

                const restoredNotes =
                    responsibilityActionPreviousNotes.get(previousAction) ||
                    (previousAction ? responsibilityActionNotesInput?.value || "" : "");

                if (responsibilityActionNotesInput) {
                    responsibilityActionNotesInput.value = restoredNotes;
                }
                if (responsibilityActionNotesTextarea) {
                    responsibilityActionNotesTextarea.value = restoredNotes;
                    const requiresNotes = ACTIONS_REQUIRING_NOTES.has(previousAction);
                    responsibilityActionNotesTextarea.setAttribute(
                        "aria-invalid",
                        requiresNotes && !restoredNotes ? "true" : "false",
                    );
                }
                updateDelegatedVisibility(previousAction);
            }

            responsibilityActionModalPreviousValue = "";
            setResponsibilityActionNotesError();
            responsibilityActionNotesTextarea?.setAttribute("aria-invalid", "false");
            responsibilityActionSelect?.focus();
        };

        const handleResponsibilityActionChange = (event) => {
            if (!event?.target) {
                return;
            }

            const actionValue = event.target.value;
            updateDelegatedVisibility(actionValue);
            if (ACTIONS_REQUIRING_NOTES.has(actionValue)) {
                const previousNotes = responsibilityActionPreviousNotes.get(actionValue) || "";
                if (responsibilityActionNotesTextarea) {
                    responsibilityActionNotesTextarea.value = previousNotes;
                }
                openResponsibilityActionNotesModal(responsibilityActionPreviousValue);
            } else {
                responsibilityActionNotesInput.value = "";
            }
            responsibilityActionPreviousValue = actionValue;
        };

        const responsibilityActionNotesTextareaInput = (event) => {
            if (!responsibilityActionNotesTextarea) {
                return;
            }
            responsibilityActionNotesTextarea.setAttribute("aria-invalid", event.target.value.trim().length === 0);
        };

        const responsibilityActionNotesSaveHandler = () => {
            const notes = responsibilityActionNotesTextarea.value.trim();
            if (!notes) {
                setResponsibilityActionNotesError("Notes are required for this action.");
                responsibilityActionNotesTextarea.setAttribute("aria-invalid", "true");
                responsibilityActionNotesTextarea.focus();
                return;
            }
            setResponsibilityActionNotesError();
            responsibilityActionNotesTextarea.setAttribute("aria-invalid", "false");
            responsibilityActionNotesInput.value = notes;
            responsibilityActionPreviousNotes.set(responsibilityActionPreviousValue, notes);
            closeResponsibilityActionNotesModal();
        };

        const responsibilityActionNotesCancelHandler = () => {
            setResponsibilityActionNotesError();
            responsibilityActionNotesTextarea.setAttribute("aria-invalid", "false");
            closeResponsibilityActionNotesModal(true);
        };

        const responsibilityActionNotesOverlayHandler = () => {
            setResponsibilityActionNotesError();
            closeResponsibilityActionNotesModal(true);
        };

        const responsibilityActionNotesCloseHandler = () => {
            setResponsibilityActionNotesError();
            closeResponsibilityActionNotesModal(true);
        };

        const submitResponsibilityForm = async (event) => {
            event.preventDefault();
            if (!responsibilityForm) {
                return;
            }

            const formData = new FormData(responsibilityForm);
            const payload = Object.fromEntries(formData.entries());
            if (typeof payload.recipientEmail === "string") {
                payload.recipientEmail = payload.recipientEmail.trim();
            }
            if (typeof payload.ccEmail === "string") {
                const trimmedCc = payload.ccEmail.trim();
                payload.ccEmail = trimmedCc || null;
            }
            const isEditingResponsibility = responsibilityEditingTaskId !== null;

            const performanceUnitValue = responsibilityPerformanceUnitSelect?.value?.toString().trim();
            if (!performanceUnitValue) {
                showResponsibilityFormError("Select a unit of measure.");
                responsibilityPerformanceUnitSelect?.focus();
                return;
            }
            const performanceConfig = getPerformanceConfig(performanceUnitValue);
            payload.performanceUnit = performanceUnitValue;

            const responsibleRaw = responsibilityPerformanceResponsibleInput?.value?.toString().trim() ?? "";
            const responsibleState = parsePerformanceInputValue(
                responsibleRaw,
                performanceUnitValue,
                performanceConfig,
            );
            if (!responsibleRaw) {
                showResponsibilityFormError("Enter the responsible target value.");
                responsibilityPerformanceResponsibleInput?.focus();
                return;
            }
            if (!responsibleState.isValid) {
                showResponsibilityFormError("Enter a valid responsible value for the selected unit.");
                responsibilityPerformanceResponsibleInput?.focus();
                return;
            }
            payload.performanceResponsible = responsibleRaw;

            const actualRaw = responsibilityPerformanceActualInput?.value?.toString().trim() ?? "";
            const actualState = parsePerformanceInputValue(actualRaw, performanceUnitValue, performanceConfig);
            if (actualRaw && !actualState.isValid) {
                showResponsibilityFormError("Enter a valid actual value for the selected unit.");
                responsibilityPerformanceActualInput?.focus();
                return;
            }
            if (!actualState.isBlank) {
                payload.performanceActual = actualRaw;
            } else {
                payload.performanceActual = null;
            }

            if (!payload.title) {
                showResponsibilityFormError("Title is required.");
                return;
            }

            if (!payload.scheduledFor) {
                showResponsibilityFormError("Select a scheduled date.");
                return;
            }

            if (!payload.recurrence) {
                showResponsibilityFormError("Select a recurrence option.");
                return;
            }

            if (payload.recurrence === "custom") {
                const selected = responsibilityCustomWeekdays
                    ? Array.from(responsibilityCustomWeekdays.querySelectorAll("input[type='checkbox']"))
                          .filter((checkbox) => checkbox.checked)
                          .map((checkbox) => Number.parseInt(checkbox.value, 10))
                    : [];
                if (selected.length === 0) {
                    showResponsibilityFormError("Select at least one weekday for the custom schedule.");
                    return;
                }
                payload.customWeekdays = selected;
            }

            const assigneeRaw = responsibilityAssigneeSelect?.value?.toString().trim() ?? "";
            if (!assigneeRaw) {
                showResponsibilityFormError("Select a team member to assign this responsibility.");
                responsibilityAssigneeSelect?.focus();
                return;
            }
            const assigneeValue = Number.parseInt(assigneeRaw, 10);
            if (!Number.isFinite(assigneeValue)) {
                showResponsibilityFormError("Select a valid team member for the assignment.");
                responsibilityAssigneeSelect?.focus();
                return;
            }
            payload.assigneeId = assigneeValue;

            if (!payload.action) {
                showResponsibilityFormError("Select a 5D action.");
                return;
            }

            if (ACTIONS_REQUIRING_NOTES.has(payload.action)) {
                if (!payload.actionNotes) {
                    showResponsibilityFormError("Enter discussion points or reasons for the selected action.");
                    openResponsibilityActionNotesModal(payload.action);
                    setResponsibilityActionNotesError("Notes are required for this action.");
                    return;
                }
            }

            if (!payload.recipientEmail) {
                showResponsibilityFormError("Enter a notification email address.");
                return;
            }

            if (payload.progress && (payload.progress < 0 || payload.progress > 100)) {
                showResponsibilityFormError("Progress must be between 0 and 100.");
                return;
            }

            if (payload.progress) {
                payload.progress = clampProgressValue(payload.progress);
            }

            const isDelegatedAction = payload.action === "delegated";
            const delegationRows = Array.from(
                responsibilityDelegationsList?.querySelectorAll(".responsibility-delegations__row") ?? [],
            );
            const delegationsPayload = [];

            for (const row of delegationRows) {
                const selectElement = row.querySelector(".responsibility-delegations__select");
                const valueInput = row.querySelector(".responsibility-delegations__value");
                const delegateRaw = selectElement?.value?.toString().trim() ?? "";

                if (!delegateRaw) {
                    if (isDelegatedAction) {
                        showResponsibilityFormError("Select a team member for each delegated allocation.");
                        selectElement?.focus();
                        return;
                    }
                    continue;
                }

                const parsedDelegate = Number.parseInt(delegateRaw, 10);
                if (!Number.isFinite(parsedDelegate)) {
                    showResponsibilityFormError("Select a valid delegated team member.");
                    selectElement?.focus();
                    return;
                }

                const allocationRaw = valueInput?.value?.toString().trim() ?? "";
                const delegateRecord = responsibilityTeamMembers.get(String(parsedDelegate));
                const delegateType = delegateRecord?.type || "team_member";

                delegationsPayload.push({
                    delegateId: parsedDelegate,
                    delegateType,
                    allocatedValue: allocationRaw || null,
                });
            }

            if (isDelegatedAction && delegationsPayload.length === 0) {
                showResponsibilityFormError(
                    "Add at least one delegated team member when the action is Delegated.",
                );
                ensureDelegationRow();
                responsibilityDelegationsList
                    ?.querySelector(".responsibility-delegations__select")
                    ?.focus();
                return;
            }

            if (delegationsPayload.length > 0) {
                payload.delegations = delegationsPayload;
            }

            const resolveAssignmentType = (value) => {
                if (value === null || value === undefined) {
                    return undefined;
                }
                const normalized = String(value).trim();
                if (!normalized) {
                    return undefined;
                }
                const record = responsibilityTeamMembers.get(normalized);
                if (!record) {
                    return "user";
                }
                return record.type || "team_member";
            };

            const assigneeType = resolveAssignmentType(payload.assigneeId);
            if (assigneeType) {
                payload.assigneeType = assigneeType;
            }

            const requestUrl = isEditingResponsibility
                ? `/api/responsibilities/${responsibilityEditingTaskId}`
                : "/api/responsibilities";
            const requestMethod = isEditingResponsibility ? "PUT" : "POST";

            clearResponsibilityFormError();
            if (responsibilitySubmitButton) {
                responsibilitySubmitButton.disabled = true;
                responsibilitySubmitButton.textContent = isEditingResponsibility
                    ? "Updating responsibility…"
                    : "Saving responsibility…";
            }

            try {
                const response = await fetch(requestUrl, {
                    method: requestMethod,
                    headers: {
                        ...authHeaders,
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) {
                    const data = await response.json().catch(() => ({}));
                    if (data?.errors) {
                        const messages = Object.values(data.errors)
                            .flat()
                            .filter(Boolean)
                            .join(" ");
                        throw new Error(messages || "Unable to save responsibility.");
                    }
                    throw new Error(data?.msg || "Unable to save responsibility.");
                }

                await fetchResponsibilities();
                closeResponsibilityModal();
                const successMessage = isEditingResponsibility
                    ? "Responsibility updated."
                    : "Responsibility saved and notification sent.";
                setPlanMessage(responsibilityMessage, successMessage, "success");
            } catch (error) {
                console.error("Failed to submit responsibility", error);
                showResponsibilityFormError(error?.message || "Unable to save responsibility.");
            } finally {
                if (responsibilitySubmitButton) {
                    responsibilitySubmitButton.disabled = false;
                    responsibilitySubmitButton.textContent = responsibilitySubmitDefaultText;
                }
            }
        };

        const responsibilityModalOverlayHandler = (event) => {
            if (event.target !== responsibilityModalOverlay) {
                return;
            }
            closeResponsibilityModal();
        };

        const deleteResponsibility = async (taskId) => {
            if (!taskId) {
                return;
            }

            try {
                const response = await fetch(`/api/responsibilities/${taskId}`, {
                    method: "DELETE",
                    headers: authHeaders,
                });

                if (!response.ok) {
                    const data = await response.json().catch(() => null);
                    throw new Error(data?.msg || "Unable to delete responsibility.");
                }

                await fetchResponsibilities();
                setPlanMessage(responsibilityMessage, "Responsibility deleted.", "success");
            } catch (error) {
                console.error("Failed to delete responsibility", error);
                setPlanMessage(
                    responsibilityMessage,
                    error?.message || "Unable to delete responsibility.",
                    "error",
                );
            }
        };

        const handleResponsibilityRowAction = (event) => {
            const trigger = event.target.closest("[data-responsibility-action]");
            if (!trigger) {
                return;
            }

            const row = trigger.closest("tr[data-id]");
            if (!row) {
                return;
            }

            const taskId = Number.parseInt(row.dataset.id, 10);
            if (Number.isNaN(taskId)) {
                return;
            }

            const action = trigger.dataset.responsibilityAction;
            if (action === "delete") {
                deleteResponsibility(taskId);
            }
        };

        populatePerformanceUnitOptions();
        if (responsibilityPerformanceUnitSelect && !responsibilityPerformanceUnitSelect.value) {
            responsibilityPerformanceUnitSelect.value = PERFORMANCE_DEFAULT_UNIT;
        }
        updatePerformanceUnitState();
        if (responsibilityPerformanceMetricInput) {
            responsibilityPerformanceMetricInput.value = "—";
        }
        updatePerformanceMetricDisplay();

        responsibilityPerformanceUnitSelect?.addEventListener("change", () => {
            updatePerformanceUnitState();
            updatePerformanceMetricDisplay();
        });
        responsibilityPerformanceResponsibleInput?.addEventListener(
            "input",
            updatePerformanceMetricDisplay,
        );
        responsibilityPerformanceActualInput?.addEventListener(
            "input",
            updatePerformanceMetricDisplay,
        );

        const responsibilityTable = responsibilityTableBody?.closest("table");
        responsibilityTable?.addEventListener("click", handleResponsibilityRowAction);

        responsibilityCreateButton?.addEventListener("click", () => openResponsibilityModal());
        responsibilityModalClose?.addEventListener("click", closeResponsibilityModal);
        responsibilityCancelButton?.addEventListener("click", closeResponsibilityModal);
        responsibilityAddDelegationButton?.addEventListener("click", () => {
            createDelegationRow();
        });
        responsibilityModalOverlay?.addEventListener("click", responsibilityModalOverlayHandler);
        responsibilityForm?.addEventListener("submit", submitResponsibilityForm);
        responsibilityActionSelect?.addEventListener("change", handleResponsibilityActionChange);
        responsibilityActionNotesTextarea?.addEventListener("input", responsibilityActionNotesTextareaInput);
        responsibilityActionNotesSave?.addEventListener("click", responsibilityActionNotesSaveHandler);
        responsibilityActionNotesCancel?.addEventListener("click", responsibilityActionNotesCancelHandler);
        responsibilityActionNotesOverlay?.addEventListener("click", responsibilityActionNotesOverlayHandler);
        responsibilityActionNotesClose?.addEventListener("click", responsibilityActionNotesCloseHandler);

        populateResponsibilityFilterOptions();
        updateFilterPlaceholder();
        updateSortIndicators();

        const applyPeriodFilters = () => {
            responsibilityPeriodStart = getNormalizedDateString(responsibilityPeriodStartInput?.value);
            responsibilityPeriodEnd = getNormalizedDateString(responsibilityPeriodEndInput?.value);
            renderResponsibilityTable();
        };

        responsibilityPeriodStartInput?.addEventListener("change", applyPeriodFilters);
        responsibilityPeriodEndInput?.addEventListener("change", applyPeriodFilters);

        responsibilityPeriodClearButton?.addEventListener("click", () => {
            if (responsibilityPeriodStartInput) {
                responsibilityPeriodStartInput.value = "";
            }
            if (responsibilityPeriodEndInput) {
                responsibilityPeriodEndInput.value = "";
            }
            responsibilityPeriodStart = "";
            responsibilityPeriodEnd = "";
            renderResponsibilityTable();
        });

        responsibilityFilterColumnSelect?.addEventListener("change", (event) => {
            const selected = event.target?.value || "all";
            responsibilityFilterColumn = selected;
            updateFilterPlaceholder();
            renderResponsibilityTable();
        });

        responsibilityFilterValueInput?.addEventListener("input", (event) => {
            responsibilityFilterQuery = event.target?.value || "";
            renderResponsibilityTable();
        });

        responsibilityFilterClearButton?.addEventListener("click", () => {
            responsibilityFilterColumn = "all";
            responsibilityFilterQuery = "";
            if (responsibilityFilterColumnSelect) {
                responsibilityFilterColumnSelect.value = "all";
            }
            if (responsibilityFilterValueInput) {
                responsibilityFilterValueInput.value = "";
            }
            updateFilterPlaceholder();
            renderResponsibilityTable();
        });

        responsibilitySortButtons.forEach((button) => {
            button.addEventListener("click", () => {
                const key = button.dataset.sortKey;
                if (!key || !RESPONSIBILITY_TABLE_COLUMNS[key]?.sortable) {
                    return;
                }

                if (responsibilitySortKey === key) {
                    if (responsibilitySortDirection === "ascending") {
                        responsibilitySortDirection = "descending";
                    } else if (responsibilitySortDirection === "descending") {
                        responsibilitySortKey = null;
                        responsibilitySortDirection = "ascending";
                    } else {
                        responsibilitySortDirection = "ascending";
                    }
                } else {
                    responsibilitySortKey = key;
                    responsibilitySortDirection = "ascending";
                }

                renderResponsibilityTable();
            });
        });

        const sendWeeklyPlan = async (event) => {
            event.preventDefault();
            if (!responsibilityWeeklyForm) {
                return;
            }

            responsibilityWeeklySendButton.disabled = true;
            setPlanMessage(responsibilityWeeklyMessage, "Sending weekly plan…", "info");

            const formData = new FormData(responsibilityWeeklyForm);
            const payload = Object.fromEntries(formData.entries());

            try {
                const response = await fetch("/api/responsibilities/send-weekly", {
                    method: "POST",
                    headers: {
                        ...authHeaders,
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) {
                    const data = await response.json().catch(() => null);
                    throw new Error(data?.msg || "Unable to send weekly plan.");
                }

                const data = await response.json();
                const rangeText = `${formatResponsibilityDate(data?.startDate)} – ${formatResponsibilityDate(
                    data?.endDate,
                )}`;
                setPlanMessage(
                    responsibilityWeeklyMessage,
                    `Weekly plan sent for ${rangeText}.`,
                    "success",
                );
            } catch (error) {
                console.error("Failed to send weekly plan", error);
                setPlanMessage(
                    responsibilityWeeklyMessage,
                    error?.message || "Unable to send weekly plan.",
                    "error",
                );
            } finally {
                responsibilityWeeklySendButton.disabled = false;
            }
        };

        responsibilityWeeklyForm?.addEventListener("submit", sendWeeklyPlan);

        if (typeof window.initResponsibilityReport === "function") {
            window.initResponsibilityReport({
                form: responsibilityReportForm,
                startInput: responsibilityReportStart,
                endInput: responsibilityReportEnd,
                memberSelect: responsibilityReportMember,
                summaryElement: responsibilityReportSummary,
                messageElement: responsibilityReportMessage,
                tableBody: responsibilityReportTableBody,
                emptyState: responsibilityReportEmpty,
                chartCanvas: responsibilityReportChart,
                downloadButtons: Array.from(responsibilityReportDownloads || []),
                authHeaders,
            });
        }

        const initializeResponsibilityWeeklyStart = () => {
            if (!responsibilityWeeklyStartInput) {
                return;
            }
            const today = new Date();
            const day = today.getDay();
            const offset = day === 0 ? -6 : 1 - day;
            const monday = new Date(today);
            monday.setDate(today.getDate() + offset);
            responsibilityWeeklyStartInput.value = toIsoDateString(monday);
        };

        initializeResponsibilityWeeklyStart();
        toggleCustomWeekdayFieldset();
        updateRecurrenceOptionLabels();
        fetchResponsibilityAssignees().finally(() => {
            fetchResponsibilities();
        });
    </script>
</body>
</html>
