<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Material | SAMPROX ERP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" />
    <link rel="stylesheet" href="https://cdn.syncfusion.com/ej2/26.1.35/material.css" />
</head>
<body>
    <div class="page">
        <header class="topbar">
            <div class="brand">
                <div class="brand__logo">S</div>
                <div class="brand__details">
                    <p class="brand__name">SAMPROX ERP</p>
                    <p class="brand__section">Material Control</p>
                </div>
            </div>
            <div class="topbar__actions">
                <a class="button button--ghost" href="{{ url_for('ui.mind_page') }}">Mind</a>
                <div class="user-summary">
                    <span class="user-summary__name" id="user-name"></span>
                    <span class="user-summary__role" id="user-role"></span>
                </div>
                <button type="button" class="button button--secondary" id="logout">Sign out</button>
            </div>
        </header>
        <nav class="subnav" aria-label="7M navigation">
            <a class="subnav__link" href="{{ url_for('ui.mind_page') }}">Mind</a>
            <a class="subnav__link" href="{{ url_for('ui.man_page') }}">Man</a>
            <a class="subnav__link" href="{{ url_for('ui.machines_page') }}">Machine</a>
            <a class="subnav__link subnav__link--active" href="{{ url_for('ui.material_page') }}">Material</a>
            <a class="subnav__link" href="{{ url_for('ui.market_page') }}">Market</a>
            <a class="subnav__link" href="{{ url_for('ui.manufacturing_page') }}">Manufacturing</a>
            <a class="subnav__link" href="{{ url_for('ui.movers_page') }}">Movers</a>
            <a class="subnav__link" href="{{ url_for('ui.money_page') }}">Money</a>
            <a
                class="subnav__link"
                href="{{ url_for('ui.mechanism_page') }}"
                id="mechanism-link"
                hidden
            >Mechanism</a>
        </nav>
        <section class="section">
            <header class="section__header">
                <h1>Inventory & supply visibility</h1>
            </header>
            <p class="section__description">
                Keep production running by tracking raw materials, spare parts, and consumables. Review
                what is on hand, what is reserved for jobs, and what needs to be ordered next.
            </p>
            <div class="section__grid">
                <article class="tile">
                    <h2 class="tile__title">Stock snapshot</h2>
                    <p class="tile__description">
                        Monitor inventory aging and reorder thresholds to prevent stock-outs.
                    </p>
                </article>
                <article class="tile">
                    <h2 class="tile__title">Supplier performance</h2>
                    <p class="tile__description">
                        Review supplier lead times and delivery quality to guide purchasing decisions.
                    </p>
                </article>
                <article class="tile">
                    <h2 class="tile__title">Consumption trends</h2>
                    <p class="tile__description">
                        Analyze how materials are consumed across jobs to forecast future demand.
                    </p>
                </article>
                <article class="tile">
                    <h2 class="tile__title">Pending requisitions</h2>
                    <p class="tile__description">
                        Follow up on open purchase requests and approvals so critical parts arrive on
                        time.
                    </p>
                </article>
            </div>
            <div class="material-receipts-card stock-status-card">
                <div class="material-receipts-card__header stock-status-card__header">
                    <div>
                        <h2 class="material-receipts-card__title">Stock Status</h2>
                        <p class="material-receipts-card__meta">
                            Review closing balances for each material as at the selected date.
                        </p>
                    </div>
                    <div class="stock-status-card__controls">
                        <label class="stock-status-card__label" for="stock-status-date">
                            Closing stock as at
                        </label>
                        <input
                            class="stock-status-card__input"
                            type="date"
                            id="stock-status-date"
                            name="stock-status-date"
                        />
                    </div>
                </div>
                <div class="stock-status-card__chart" id="stock-status-chart-container" hidden>
                    <canvas id="stock-status-chart" role="img" aria-label="Stock movement chart"></canvas>
                </div>
                <p class="empty-state" id="stock-status-empty">Loading stock status…</p>
                <div class="table-wrapper" id="stock-status-table-wrapper" hidden>
                    <table class="data-table" id="stock-status-table">
                        <thead>
                            <tr>
                                <th scope="col">Item Name</th>
                                <th scope="col">Qty (Ton)</th>
                                <th scope="col">Unit Cost (Rs./Ton)</th>
                                <th scope="col">Value (Rs.)</th>
                            </tr>
                        </thead>
                        <tbody id="stock-status-table-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="material-receipts-card supplier-registry-card">
                <div class="material-receipts-card__header">
                    <div>
                        <h2 class="material-receipts-card__title">Supplier registry</h2>
                        <p class="material-receipts-card__meta">
                            Review registered suppliers and keep their contact details at your fingertips.
                        </p>
                    </div>
                    <button type="button" class="button" id="register-supplier-button">Register supplier</button>
                </div>
                <form class="material-receipts-card__search" id="supplier-search-form">
                    <label class="sr-only" for="supplier-search-input">Search suppliers</label>
                    <input
                        id="supplier-search-input"
                        type="search"
                        name="q"
                        placeholder="Search by supplier name, registration, or contact"
                        autocomplete="off"
                    />
                    <div class="material-receipts-card__actions">
                        <button type="submit" class="button button--secondary">Search</button>
                        <button type="button" class="button button--ghost" id="supplier-clear-button">Clear</button>
                    </div>
                </form>
                <p class="empty-state" id="supplier-empty-state">Loading suppliers…</p>
                <div class="table-wrapper" id="supplier-table-wrapper" hidden>
                    <table class="data-table" id="supplier-table">
                        <thead>
                            <tr>
                                <th scope="col">Supplier</th>
                                <th scope="col">Registration no.</th>
                                <th scope="col">Category</th>
                                <th scope="col">Primary phone</th>
                                <th scope="col">Vehicle No 1</th>
                                <th scope="col">Credit period</th>
                                <th scope="col" id="supplier-actions-header" hidden>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="supplier-table-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="material-receipts-card">
                <div class="material-receipts-card__header">
                    <div>
                        <h2 class="material-receipts-card__title">Material receipts</h2>
                        <p class="material-receipts-card__meta">
                            Review the latest material receipt notes recorded by your team.
                        </p>
                    </div>
                    <a class="button" href="{{ url_for('ui.material_mrn_new_page') }}">Record material receipt</a>
                </div>
                <form class="material-receipts-card__search" id="mrn-search-form">
                    <div class="material-receipts-card__filters">
                        <label class="material-receipts-card__filter">
                            <span class="material-receipts-card__filter-label">Start date</span>
                            <input id="mrn-start-date" name="start-date" type="date" />
                        </label>
                        <label class="material-receipts-card__filter">
                            <span class="material-receipts-card__filter-label">End date</span>
                            <input id="mrn-end-date" name="end-date" type="date" />
                        </label>
                    </div>
                    <label class="sr-only" for="mrn-search-input">Search material receipts</label>
                    <input
                        id="mrn-search-input"
                        type="search"
                        name="q"
                        placeholder="Search by MRN number, supplier, or material"
                        autocomplete="off"
                    />
                    <div class="material-receipts-card__actions">
                        <button type="submit" class="button button--secondary">Search</button>
                        <button type="button" class="button button--ghost" id="mrn-clear-button">Clear</button>
                    </div>
                </form>
                <p class="empty-state" id="mrn-empty-state">Loading material receipts…</p>
                <div class="table-wrapper table-wrapper--mrn-scroll" id="mrn-table-wrapper" hidden>
                    <table class="data-table" id="mrn-table">
                        <thead>
                            <tr>
                                <th scope="col">MRN number</th>
                                <th scope="col">Date</th>
                                <th scope="col">Supplier</th>
                                <th scope="col">Sourcing Type</th>
                                <th scope="col">Material</th>
                                <th scope="col">Qty (Ton)</th>
                                <th scope="col">Amount</th>
                                <th scope="col" class="mrn-table__actions-heading">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="mrn-table-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="material-receipts-card" id="briquette-production-card">
                <div class="material-receipts-card__header">
                    <div>
                        <h2 class="material-receipts-card__title">Production Entry – Briquette Production</h2>
                        <p class="material-receipts-card__meta">
                            Monitor briquette output alongside the daily material mix and FIFO cost.
                        </p>
                    </div>
                </div>
                <p class="empty-state" id="briquette-production-empty">Loading briquette production…</p>
                <div class="table-wrapper" id="briquette-production-table-wrapper" hidden>
                    <table class="data-table" id="briquette-production-table">
                        <thead>
                            <tr>
                                <th scope="col" rowspan="2">Date</th>
                                <th scope="col" rowspan="2">Briquette Production (Ton)</th>
                                <th scope="col" colspan="5">Material Consumed (Ton)</th>
                                <th scope="col" rowspan="2">Unit Cost of Briquette (Kg)</th>
                                <th scope="col" rowspan="2">Total Material Cost</th>
                                <th scope="col" rowspan="2">Update Mix</th>
                            </tr>
                            <tr id="briquette-material-headings">
                                <th scope="col">Sawdust</th>
                                <th scope="col">Wood Shaving</th>
                                <th scope="col">Wood Powder</th>
                                <th scope="col">Peanut Husk</th>
                                <th scope="col">Fire Cut</th>
                            </tr>
                        </thead>
                        <tbody id="briquette-production-table-body"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>
    <div class="modal" id="briquette-mix-modal" hidden aria-hidden="true">
        <div class="modal__overlay" data-modal-dismiss></div>
        <div class="modal__content" role="dialog" aria-modal="true" aria-labelledby="briquette-mix-title">
            <header class="modal__header modal__header--with-actions">
                <div>
                    <h2 class="modal__title" id="briquette-mix-title">Update mix</h2>
                    <p class="modal__subtitle" id="briquette-mix-subtitle">
                        Adjust material usage and let the system recalculate FIFO costs automatically.
                    </p>
                </div>
                <button type="button" class="modal__close" id="briquette-mix-close" aria-label="Close mix editor">
                    &times;
                </button>
            </header>
            <div class="modal__body">
                <form class="modal__form" id="briquette-mix-form">
                    <div class="modal__grid">
                        <label class="modal__field">
                            <span class="modal__label">Date</span>
                            <input id="briquette-mix-date" type="text" class="modal__input" readonly />
                        </label>
                        <label class="modal__field">
                            <span class="modal__label">Dry factor</span>
                            <input
                                id="briquette-dry-factor"
                                name="dry_factor"
                                type="number"
                                step="0.0001"
                                min="0"
                                class="modal__input"
                                autocomplete="off"
                            />
                        </label>
                        <label class="modal__field">
                            <span class="modal__label">Sawdust (Ton)</span>
                            <input id="briquette-sawdust" type="number" class="modal__input" readonly />
                        </label>
                        <label class="modal__field">
                            <span class="modal__label">Wood Shaving (Ton)</span>
                            <input
                                id="briquette-wood-shaving"
                                name="wood_shaving_ton"
                                type="number"
                                step="0.001"
                                min="0"
                                class="modal__input"
                                autocomplete="off"
                                readonly
                            />
                        </label>
                        <label class="modal__field">
                            <span class="modal__label">Wood Powder (Ton)</span>
                            <input
                                id="briquette-wood-powder"
                                name="wood_powder_ton"
                                type="number"
                                step="0.001"
                                min="0"
                                class="modal__input"
                                autocomplete="off"
                            />
                        </label>
                        <label class="modal__field">
                            <span class="modal__label">Peanut Husk (Ton)</span>
                            <input
                                id="briquette-peanut-husk"
                                name="peanut_husk_ton"
                                type="number"
                                step="0.001"
                                min="0"
                                class="modal__input"
                                autocomplete="off"
                            />
                        </label>
                        <label class="modal__field">
                            <span class="modal__label">Fire Cut (Ton)</span>
                            <input
                                id="briquette-fire-cut"
                                name="fire_cut_ton"
                                type="number"
                                step="0.001"
                                min="0"
                                class="modal__input"
                                autocomplete="off"
                            />
                        </label>
                        <label class="modal__field">
                            <span class="modal__label">Dry Material (Ton)</span>
                            <input
                                id="briquette-dry-material"
                                type="number"
                                step="0.001"
                                class="modal__input"
                                readonly
                            />
                        </label>
                        <label class="modal__field">
                            <span class="modal__label">Dryer Actual Running Hours</span>
                            <input
                                id="briquette-dryer-actual-hours"
                                type="number"
                                step="0.1"
                                class="modal__input"
                                readonly
                            />
                        </label>
                    </div>
                    <div class="modal__field modal__field--full">
                        <span class="modal__label">Total briquette output</span>
                        <p class="modal__hint"><span id="briquette-output-kg">0.00</span> kg</p>
                    </div>
                    <div class="table-wrapper">
                        <table class="data-table data-table--compact" id="briquette-cost-table">
                            <thead>
                                <tr>
                                    <th scope="col">Material</th>
                                    <th scope="col">Qty (Kg)</th>
                                    <th scope="col">Qty (Ton)</th>
                                    <th scope="col">Purchase Price (Rs/Kg)</th>
                                    <th scope="col">Total Cost (Rs)</th>
                                </tr>
                            </thead>
                            <tbody id="briquette-cost-table-body"></tbody>
                        </table>
                    </div>
                    <div class="modal__field modal__field--full">
                        <p class="modal__label">Total material cost</p>
                        <p class="modal__hint" id="briquette-total-cost">Rs 0.00</p>
                    </div>
                    <div class="modal__field modal__field--full">
                        <p class="modal__label">Unit cost of briquette (per Kg)</p>
                        <p class="modal__hint" id="briquette-unit-cost">Rs 0.0000</p>
                    </div>
                <p class="modal__feedback" id="briquette-mix-feedback" hidden></p>
                <p class="modal__feedback modal__feedback--error" id="briquette-mix-error" hidden></p>
                <div class="modal__actions">
                    <button type="button" class="button button--ghost" id="briquette-mix-cancel">Cancel</button>
                    <button type="submit" class="button" id="briquette-mix-save">Save mix</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="supplier-modal" hidden aria-hidden="true">
        <div class="modal__overlay" data-modal-dismiss></div>
        <div class="modal__content" role="dialog" aria-modal="true" aria-labelledby="supplier-modal-title">
            <header class="modal__header modal__header--with-actions">
                <div>
                    <h2 class="modal__title" id="supplier-modal-title">Edit supplier</h2>
                    <p class="modal__subtitle">Update supplier contact, category, and billing details.</p>
                </div>
                <button type="button" class="modal__close" id="close-supplier-modal" aria-label="Close">
                    &times;
                </button>
            </header>
            <form class="modal__form" id="supplier-form" novalidate>
                <input type="hidden" id="supplier-id" name="supplier_id" />
                <div class="modal__grid">
                    <label class="modal__field modal__field--full">
                        <span class="modal__label">Supplier Name<span class="text-red"> *</span></span>
                        <input class="modal__input" id="supplier-name" name="name" type="text" required />
                        <p class="modal__feedback modal__feedback--error" data-error-for="modal_name"></p>
                    </label>
                    <label class="modal__field">
                        <span class="modal__label">Supplier Registration No</span>
                        <input class="modal__input" id="supplier-registration" type="text" name="supplier_reg_no" readonly />
                    </label>
                    <label class="modal__field">
                        <span class="modal__label">Supplier ID No<span class="text-red"> *</span></span>
                        <input class="modal__input" id="supplier-id-no" name="supplier_id_no" type="text" required />
                        <p class="modal__feedback modal__feedback--error" data-error-for="modal_supplier_id_no"></p>
                    </label>
                    <label class="modal__field">
                        <span class="modal__label">Category<span class="text-red"> *</span></span>
                        <select class="modal__select" id="supplier-category" name="category" required>
                            <option value="" hidden>Select category</option>
                            <option value="Raw Material">Raw Material</option>
                            <option value="Packing Material">Packing Material</option>
                            <option value="Repair Material">Repair Material</option>
                            <option value="Maintenance Material">Maintenance Material</option>
                        </select>
                        <p class="modal__feedback modal__feedback--error" data-error-for="modal_category"></p>
                    </label>
                    <label class="modal__field">
                        <span class="modal__label">Primary Phone<span class="text-red"> *</span></span>
                        <input class="modal__input" id="supplier-primary-phone" name="primary_phone" type="text" required />
                        <p class="modal__feedback modal__feedback--error" data-error-for="modal_primary_phone"></p>
                    </label>
                    <label class="modal__field">
                        <span class="modal__label">Secondary Phone</span>
                        <input class="modal__input" id="supplier-secondary-phone" name="secondary_phone" type="text" />
                        <p class="modal__feedback modal__feedback--error" data-error-for="modal_secondary_phone"></p>
                    </label>
                    <label class="modal__field">
                        <span class="modal__label">Vehicle No 1</span>
                        <input class="modal__input" id="supplier-vehicle-1" name="vehicle_no_1" type="text" />
                        <p class="helper" id="vehicle-no-1-helper" hidden>Required for Raw Material suppliers.</p>
                        <p class="modal__feedback modal__feedback--error" data-error-for="modal_vehicle_no_1"></p>
                    </label>
                    <label class="modal__field">
                        <span class="modal__label">Vehicle No 2</span>
                        <input class="modal__input" id="supplier-vehicle-2" name="vehicle_no_2" type="text" />
                    </label>
                    <label class="modal__field">
                        <span class="modal__label">Vehicle No 3</span>
                        <input class="modal__input" id="supplier-vehicle-3" name="vehicle_no_3" type="text" />
                    </label>
                    <label class="modal__field">
                        <span class="modal__label">Credit Period<span class="text-red"> *</span></span>
                        <select class="modal__select" id="supplier-credit-period" name="credit_period" required>
                            <option value="" hidden>Select credit period</option>
                            <option value="Cash">Cash</option>
                            <option value="3 Days">3 Days</option>
                            <option value="7 Days">7 Days</option>
                            <option value="1 Month">1 Month</option>
                        </select>
                        <p class="modal__feedback modal__feedback--error" data-error-for="modal_credit_period"></p>
                    </label>
                    <label class="modal__field">
                        <span class="modal__label">Email</span>
                        <input class="modal__input" id="supplier-email" name="email" type="email" />
                        <p class="modal__feedback modal__feedback--error" data-error-for="modal_email"></p>
                    </label>
                    <label class="modal__field">
                        <span class="modal__label">Address</span>
                        <textarea class="modal__textarea" id="supplier-address" name="address"></textarea>
                        <p class="modal__feedback modal__feedback--error" data-error-for="modal_address"></p>
                    </label>
                    <label class="modal__field">
                        <span class="modal__label">Tax ID</span>
                        <input class="modal__input" id="supplier-tax-id" name="tax_id" type="text" />
                        <p class="modal__feedback modal__feedback--error" data-error-for="modal_tax_id"></p>
                    </label>
                </div>
                <p id="supplier-modal-alert" class="modal__feedback modal__feedback--error" hidden></p>
                <div class="modal__actions">
                    <button type="button" class="button button--ghost" id="cancel-supplier">Cancel</button>
                    <button type="submit" class="button" id="save-supplier">Save supplier</button>
                </div>
            </form>
        </div>
    </div>

    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
    <script>
        const token = localStorage.getItem("samprox_token");
        const userRaw = localStorage.getItem("samprox_user");
        let user;

        try {
            user = userRaw ? JSON.parse(userRaw) : null;
        } catch (_) {
            user = null;
        }

        function normalizeRole(value) {
            if (typeof value === "string") {
                return value.trim().toLowerCase().replace(/\s+/g, "_");
            }
            if (value && typeof value === "object") {
                const candidate = value.name || value.role || value.title;
                if (typeof candidate === "string") {
                    return candidate.trim().toLowerCase().replace(/\s+/g, "_");
                }
            }
            return "";
        }

        const rawRole =
            user?.role ??
            user?.role_name ??
            user?.roleName ??
            user?.user_role ??
            user?.userRole ??
            user?.role?.name;
        const userRole = normalizeRole(rawRole);

        if (!token || !user) {
            window.location.href = "/";
        }

        if (userRole === "outside_manager" && window.location.pathname !== "/responsibility_portal") {
            window.location.replace("/responsibility_portal");
        }

        if (userRole === "maintenance_manager" && window.location.pathname !== "/machines") {
            window.location.replace("/machines");
        }

        const roleLabels = {
            admin: "Admin",
            production_manager: "Production Manager",
            maintenance_manager: "Maintenance Manager",
            finance_manager: "Finance Manager",
            technician: "Technician",
            outside_manager: "Member Of Rainbow Group",
        };

        const DEFAULT_DRY_FACTOR = 0.6;
        const DEFAULT_DRY_FACTOR_DISPLAY = DEFAULT_DRY_FACTOR.toFixed(4);

        const userNameEl = document.getElementById("user-name");
        const userRoleEl = document.getElementById("user-role");
        const logoutButton = document.getElementById("logout");
        const mechanismLink = document.getElementById("mechanism-link");

        userNameEl.textContent = user?.name || "Unknown";
        userRoleEl.textContent = roleLabels[userRole] || "";
        if (mechanismLink) {
            if (userRole === "admin") {
                mechanismLink.hidden = false;
            } else {
                mechanismLink.remove();
            }
        }

        logoutButton.addEventListener("click", async () => {
            try {
                await fetch("/api/auth/logout", { method: "POST", credentials: "include" });
            } catch (error) {
                console.error("Failed to log out", error);
            } finally {
                localStorage.removeItem("samprox_token");
                localStorage.removeItem("samprox_user");
                window.location.href = "/";
            }
        });

        const stockStatusTableBody = document.getElementById("stock-status-table-body");
        const stockStatusTableWrapper = document.getElementById("stock-status-table-wrapper");
        const stockStatusEmptyState = document.getElementById("stock-status-empty");
        const stockStatusDateInput = document.getElementById("stock-status-date");
        const stockStatusChartContainer = document.getElementById("stock-status-chart-container");
        const stockStatusChartElement = document.getElementById("stock-status-chart");
        const supplierTableBody = document.getElementById("supplier-table-body");
        const supplierTableWrapper = document.getElementById("supplier-table-wrapper");
        const supplierEmptyState = document.getElementById("supplier-empty-state");
        const supplierSearchForm = document.getElementById("supplier-search-form");
        const supplierSearchInput = document.getElementById("supplier-search-input");
        const supplierClearButton = document.getElementById("supplier-clear-button");
        const registerSupplierButton = document.getElementById("register-supplier-button");
        const supplierActionsHeader = document.getElementById("supplier-actions-header");
        const supplierModal = document.getElementById("supplier-modal");
        const supplierModalForm = document.getElementById("supplier-form");
        const supplierModalTitle = document.getElementById("supplier-modal-title");
        const supplierModalAlert = document.getElementById("supplier-modal-alert");
        const supplierModalClose = document.getElementById("close-supplier-modal");
        const supplierModalCancel = document.getElementById("cancel-supplier");
        const supplierModalSaveButton = document.getElementById("save-supplier");
        const supplierIdInput = document.getElementById("supplier-id");
        const supplierRegistrationInput = document.getElementById("supplier-registration");
        const supplierFieldElements = {
            name: document.getElementById("supplier-name"),
            supplier_id_no: document.getElementById("supplier-id-no"),
            category: document.getElementById("supplier-category"),
            primary_phone: document.getElementById("supplier-primary-phone"),
            secondary_phone: document.getElementById("supplier-secondary-phone"),
            vehicle_no_1: document.getElementById("supplier-vehicle-1"),
            vehicle_no_2: document.getElementById("supplier-vehicle-2"),
            vehicle_no_3: document.getElementById("supplier-vehicle-3"),
            credit_period: document.getElementById("supplier-credit-period"),
            email: document.getElementById("supplier-email"),
            address: document.getElementById("supplier-address"),
            tax_id: document.getElementById("supplier-tax-id"),
        };
        const vehicleRequirementHelper = document.getElementById("vehicle-no-1-helper");
        const supplierTouchedFields = new Set();
        let supplierServerErrors = {};
        let activeSupplierId = null;
        const supplierCategories = new Set([
            "Raw Material",
            "Packing Material",
            "Repair Material",
            "Maintenance Material",
        ]);
        const supplierCreditPeriods = new Set(["Cash", "3 Days", "7 Days", "1 Month"]);
        const canEditSuppliers = userRole === "admin" || userRole === "production_manager";

        const mrnTableBody = document.getElementById("mrn-table-body");
        const mrnTableWrapper = document.getElementById("mrn-table-wrapper");
        const mrnEmptyState = document.getElementById("mrn-empty-state");
        const mrnSearchForm = document.getElementById("mrn-search-form");
        const mrnSearchInput = document.getElementById("mrn-search-input");
        const mrnClearButton = document.getElementById("mrn-clear-button");
        const mrnStartDateInput = document.getElementById("mrn-start-date");
        const mrnEndDateInput = document.getElementById("mrn-end-date");
        const briquetteTableBody = document.getElementById("briquette-production-table-body");
        const briquetteTableWrapper = document.getElementById("briquette-production-table-wrapper");
        const briquetteEmptyState = document.getElementById("briquette-production-empty");
        const briquetteMaterialHeadings = document.getElementById("briquette-material-headings");
        const briquetteModal = document.getElementById("briquette-mix-modal");
        const briquetteModalForm = document.getElementById("briquette-mix-form");
        const briquetteModalDate = document.getElementById("briquette-mix-date");
        const briquetteDryFactorInput = document.getElementById("briquette-dry-factor");
        const briquetteSawdustInput = document.getElementById("briquette-sawdust");
        const briquetteWoodShavingInput = document.getElementById("briquette-wood-shaving");
        const briquetteWoodPowderInput = document.getElementById("briquette-wood-powder");
        const briquettePeanutHuskInput = document.getElementById("briquette-peanut-husk");
        const briquetteFireCutInput = document.getElementById("briquette-fire-cut");
        const briquetteDryMaterialInput = document.getElementById("briquette-dry-material");
        const briquetteDryerHoursInput = document.getElementById("briquette-dryer-actual-hours");
        const briquetteOutputKg = document.getElementById("briquette-output-kg");
        const briquetteCostTableBody = document.getElementById("briquette-cost-table-body");
        const briquetteTotalCost = document.getElementById("briquette-total-cost");
        const briquetteUnitCost = document.getElementById("briquette-unit-cost");
        const briquetteModalFeedback = document.getElementById("briquette-mix-feedback");
        const briquetteModalError = document.getElementById("briquette-mix-error");
        const briquetteModalClose = document.getElementById("briquette-mix-close");
        const briquetteModalCancel = document.getElementById("briquette-mix-cancel");
        const briquetteSaveButton = document.getElementById("briquette-mix-save");

        let briquetteMaterialOrder = [];
        let briquetteMaterialLabels = {};
        let briquetteModalDateValue = null;
        let briquetteDryerProductionTon = 0;
        let briquetteTotalOutputTon = 0;
        let briquetteComputedWoodShavingTon = 0;
        let briquetteComputedDryMaterialTon = 0;

        function formatNumber(value, fractionDigits) {
            const numeric = Number.parseFloat(value);
            if (Number.isNaN(numeric)) {
                return "—";
            }
            return numeric.toLocaleString(undefined, {
                minimumFractionDigits: fractionDigits,
                maximumFractionDigits: fractionDigits,
            });
        }

        const chartTonFormatter = new Intl.NumberFormat(undefined, {
            minimumFractionDigits: 0,
            maximumFractionDigits: 2,
        });

        const chartCurrencyFormatter = new Intl.NumberFormat(undefined, {
            minimumFractionDigits: 0,
            maximumFractionDigits: 2,
        });

        function formatChartTons(value) {
            const numeric = Number(value);
            if (!Number.isFinite(numeric)) {
                return "0";
            }
            return chartTonFormatter.format(numeric);
        }

        function formatChartCurrency(value) {
            const numeric = Number(value);
            if (!Number.isFinite(numeric)) {
                return null;
            }
            return chartCurrencyFormatter.format(numeric);
        }

        const STOCK_STATUS_CHART_KEYS = [
            "sawdust",
            "wood_shaving",
            "wood_powder",
            "peanut_husk",
            "fire_cut",
            "briquettes",
        ];

        let stockStatusChartInstance = null;
        let stockStatusChartAsOf = null;
        const stackedBarValueLabelPlugin = {
            id: "stackedValueLabels",
            afterDatasetsDraw(chart) {
                const { ctx, data } = chart;
                if (!ctx || !data?.datasets) {
                    return;
                }

                ctx.save();
                ctx.font = "600 11px 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";

                data.datasets.forEach((dataset, datasetIndex) => {
                    const meta = chart.getDatasetMeta(datasetIndex);
                    if (!meta?.data) {
                        return;
                    }

                    meta.data.forEach((element, index) => {
                        const rawValue = dataset.data?.[index];
                        if (!Number.isFinite(rawValue) || rawValue === 0) {
                            return;
                        }

                        const position = element.tooltipPosition();
                        const isNegative = rawValue < 0;
                        const offset = isNegative ? 12 : -12;
                        const label = `${formatChartTons(Math.abs(rawValue))} T`;

                        ctx.fillStyle = dataset.label === "Consumption / Sales" ? "#fee2e2" : "#0f172a";
                        ctx.fillText(label, position.x, position.y + offset);
                    });
                });

                ctx.restore();
            },
        };

        function formatChartAxis(value) {
            const numeric = Number(value);
            if (!Number.isFinite(numeric)) {
                return value;
            }
            return chartCurrencyFormatter.format(numeric);
        }

        function computeAxisInterval(min, max) {
            const range = Math.abs(max - min);
            if (!Number.isFinite(range) || range === 0) {
                return 1;
            }
            const exponent = Math.floor(Math.log10(range));
            const base = 10 ** exponent;
            const multipliers = [1, 2, 5, 10];
            for (const multiplier of multipliers) {
                const candidate = multiplier * base;
                if (range / candidate <= 6) {
                    return candidate;
                }
            }
            return base * 10;
        }

        function computeAxisBounds(points) {
            if (!Array.isArray(points) || points.length === 0) {
                return { min: -1, max: 1, interval: 1 };
            }

            let max = 0;
            let min = 0;
            points.forEach((point) => {
                if (Number.isFinite(point.totalAvailable)) {
                    max = Math.max(max, point.totalAvailable);
                }
                if (Number.isFinite(point.closingBalance)) {
                    max = Math.max(max, point.closingBalance);
                }
                if (Number.isFinite(point.negativeImpact)) {
                    min = Math.min(min, point.negativeImpact);
                }
            });

            if (max === 0 && min === 0) {
                return { min: -1, max: 1, interval: 1 };
            }

            const topBuffer = max > 0 ? max * 0.15 : 1;
            const bottomBuffer = min < 0 ? Math.abs(min) * 0.25 : 1;
            const upper = max > 0 ? max + topBuffer : 1;
            const lower = min < 0 ? min - bottomBuffer : -bottomBuffer;
            const interval = computeAxisInterval(lower, upper) || 1;
            const minimum = Math.floor(lower / interval) * interval;
            const maximum = Math.ceil(upper / interval) * interval;

            return { min: minimum, max: maximum, interval };
        }

        function ensureChartJs() {
            return typeof Chart !== "undefined";
        }

        function buildStockStatusTitle(asOf) {
            if (!asOf) {
                return "Stock Movement & Closing Status as at —";
            }
            const friendly = formatDate(asOf);
            return `Stock Movement & Closing Status as at ${friendly || asOf}`;
        }

        function isoToday() {
            const today = new Date();
            const month = String(today.getMonth() + 1).padStart(2, "0");
            const day = String(today.getDate()).padStart(2, "0");
            return `${today.getFullYear()}-${month}-${day}`;
        }

        function renderStockStatusRows(items) {
            if (!stockStatusTableBody || !stockStatusTableWrapper || !stockStatusEmptyState) {
                return;
            }

            stockStatusTableBody.innerHTML = "";

            if (!Array.isArray(items) || items.length === 0) {
                stockStatusTableWrapper.hidden = true;
                stockStatusEmptyState.hidden = false;
                stockStatusEmptyState.textContent = "No stock data available for the selected date.";
                return;
            }

            items.forEach((item) => {
                const row = document.createElement("tr");
                if (item.key === "opening_total") {
                    row.classList.add("stock-status-table__opening-row");
                }

                const nameCell = document.createElement("td");
                nameCell.textContent = item.label || item.name || item.key || "—";
                row.appendChild(nameCell);

                const qtyCell = document.createElement("td");
                qtyCell.textContent = formatNumber(item.quantity_ton, 3);
                row.appendChild(qtyCell);

                const unitCostCell = document.createElement("td");
                unitCostCell.textContent = formatNumber(item.unit_cost_per_ton, 2);
                row.appendChild(unitCostCell);

                const valueCell = document.createElement("td");
                valueCell.textContent = formatNumber(item.value_rs, 2);
                row.appendChild(valueCell);

                stockStatusTableBody.appendChild(row);
            });

            stockStatusEmptyState.hidden = true;
            stockStatusTableWrapper.hidden = false;
        }


        function renderStockStatusChart(items, asOf) {
            if (!stockStatusChartElement || !ensureChartJs()) {
                return;
            }

            const relevantItems = Array.isArray(items)
                ? items.filter((item) => STOCK_STATUS_CHART_KEYS.includes(item.key))
                : [];

            if (relevantItems.length === 0) {
                if (stockStatusChartInstance) {
                    stockStatusChartInstance.destroy();
                    stockStatusChartInstance = null;
                }
                if (stockStatusChartContainer) {
                    stockStatusChartContainer.hidden = true;
                }
                return;
            }

            const points = relevantItems.map((item) => {
                const metrics = item?.metrics || {};
                const key = item?.key || "";
                const isBriquette = key === "briquettes";
                const opening = Number(metrics.opening_balance ?? 0);
                const purchases = Number(metrics.purchases ?? 0);
                const production = Number(metrics.production ?? 0);
                const closing = Number(metrics.closing_balance ?? item?.quantity_ton ?? 0);
                const consumption = Number(metrics.consumption ?? 0);
                const sales = Number(metrics.sales ?? 0);

                const totalAvailableCandidate = Number(
                    metrics.total_available ?? (isBriquette ? opening + production : opening + purchases),
                );

                const totalAvailable = Number.isFinite(totalAvailableCandidate)
                    ? Math.max(totalAvailableCandidate, 0)
                    : 0;
                const closingBalance = Number.isFinite(closing) ? Math.max(closing, 0) : 0;
                const impactValueRaw = isBriquette ? sales : consumption;
                const impactValue = Number.isFinite(impactValueRaw) ? Math.max(impactValueRaw, 0) : 0;

                return {
                    key,
                    label: item?.label || item?.name || key,
                    totalAvailable,
                    closingBalance,
                    impactValue,
                    negativeImpact: -Math.abs(impactValue),
                    impactLabel: isBriquette ? "Sales (-)" : "Consumption (-)",
                    valueRs: Number(item?.value_rs ?? Number.NaN),
                };
            });

            const bounds = computeAxisBounds(points);
            const title = buildStockStatusTitle(asOf || stockStatusChartAsOf);
            const labels = points.map((point) => point.label);

            const datasets = [
                {
                    label: "Total Available",
                    data: points.map((point) => point.totalAvailable),
                    backgroundColor: "rgba(59, 130, 246, 0.8)",
                    borderColor: "rgba(37, 99, 235, 0.95)",
                    borderWidth: 1,
                    borderRadius: 8,
                    borderSkipped: false,
                    stack: "stock",
                    maxBarThickness: 52,
                },
                {
                    label: "Closing Stock",
                    data: points.map((point) => point.closingBalance),
                    backgroundColor: "rgba(234, 179, 8, 0.85)",
                    borderColor: "rgba(202, 138, 4, 0.95)",
                    borderWidth: 1,
                    borderRadius: 8,
                    borderSkipped: false,
                    stack: "stock",
                    maxBarThickness: 52,
                },
                {
                    label: "Consumption / Sales",
                    data: points.map((point) => point.negativeImpact),
                    backgroundColor: "rgba(239, 68, 68, 0.85)",
                    borderColor: "rgba(185, 28, 28, 0.95)",
                    borderWidth: 1,
                    borderRadius: 8,
                    borderSkipped: false,
                    stack: "stock",
                    maxBarThickness: 52,
                },
            ];

            const options = {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: "index", intersect: false },
                scales: {
                    x: {
                        stacked: true,
                        grid: { color: "rgba(148, 163, 184, 0.18)", drawBorder: false },
                        ticks: {
                            color: "#1e293b",
                            font: {
                                family: "Inter, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif",
                                size: 12,
                                weight: "500",
                            },
                        },
                    },
                    y: {
                        stacked: true,
                        min: bounds.min,
                        max: bounds.max,
                        ticks: {
                            color: "#475569",
                            callback: (value) => `${formatChartAxis(value)} T`,
                            stepSize: bounds.interval,
                            font: {
                                family: "Inter, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif",
                                size: 12,
                                weight: "500",
                            },
                        },
                        grid: {
                            color: "rgba(148, 163, 184, 0.22)",
                            drawBorder: false,
                        },
                    },
                },
                plugins: {
                    legend: {
                        position: "bottom",
                        align: "start",
                        labels: {
                            usePointStyle: true,
                            pointStyle: "rectRounded",
                            color: "#0f172a",
                            font: {
                                family: "Inter, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif",
                                size: 12,
                                weight: "600",
                            },
                        },
                    },
                    title: {
                        display: true,
                        align: "start",
                        text: title,
                        color: "#0f172a",
                        padding: { bottom: 16 },
                        font: {
                            family: "Inter, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif",
                            size: 16,
                            weight: "600",
                        },
                    },
                    tooltip: {
                        backgroundColor: "#0f172a",
                        borderColor: "rgba(148, 163, 184, 0.3)",
                        borderWidth: 1,
                        titleColor: "#f8fafc",
                        bodyColor: "#f8fafc",
                        titleFont: {
                            family: "Inter, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif",
                            weight: "600",
                        },
                        bodyFont: {
                            family: "Inter, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif",
                            weight: "500",
                        },
                        callbacks: {
                            label(context) {
                                const value = Number(context.raw) || 0;
                                const tons = formatChartTons(Math.abs(value));
                                return `${context.dataset.label}: ${tons} T`;
                            },
                        },
                    },
                },
            };

            if (stockStatusChartContainer) {
                stockStatusChartContainer.hidden = false;
            }

            if (stockStatusChartInstance) {
                stockStatusChartInstance.data.labels = labels;
                stockStatusChartInstance.data.datasets.forEach((dataset, index) => {
                    if (datasets[index]) {
                        dataset.data = datasets[index].data;
                        dataset.backgroundColor = datasets[index].backgroundColor;
                        dataset.borderColor = datasets[index].borderColor;
                    }
                });
                stockStatusChartInstance.options.scales.y.min = bounds.min;
                stockStatusChartInstance.options.scales.y.max = bounds.max;
                stockStatusChartInstance.options.scales.y.ticks.stepSize = bounds.interval;
                stockStatusChartInstance.options.plugins.title.text = title;
                stockStatusChartInstance.update();
            } else {
                stockStatusChartInstance = new Chart(stockStatusChartElement, {
                    type: "bar",
                    data: { labels, datasets },
                    options,
                    plugins: [stackedBarValueLabelPlugin],
                });
            }

            stockStatusChartAsOf = asOf || stockStatusChartAsOf || null;
            stockStatusChartInstance?.resize();
        }

        async function loadStockStatus(asOf) {
            if (!stockStatusEmptyState || !stockStatusTableBody) {
                return;
            }

            stockStatusEmptyState.hidden = false;
            stockStatusEmptyState.textContent = "Loading stock status…";
            if (stockStatusTableWrapper) {
                stockStatusTableWrapper.hidden = true;
            }

            try {
                const url = new URL("/api/material/stock-status", window.location.origin);
                if (asOf) {
                    url.searchParams.set("as_of", asOf);
                }
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error("Failed to load stock status");
                }
                const data = await response.json();
                const items = Array.isArray(data.items) ? data.items : [];
                stockStatusChartAsOf = data.as_of || asOf || stockStatusChartAsOf;
                renderStockStatusRows(items);
                renderStockStatusChart(items, stockStatusChartAsOf);
                if (stockStatusDateInput && data.as_of) {
                    stockStatusDateInput.value = data.as_of;
                }
            } catch (error) {
                console.error(error);
                stockStatusEmptyState.hidden = false;
                stockStatusEmptyState.textContent =
                    "Unable to load stock status right now. Please try again.";
                renderStockStatusChart([], asOf || stockStatusChartAsOf);
            }
        }

        if (stockStatusDateInput) {
            const defaultDate = isoToday();
            if (!stockStatusDateInput.value) {
                stockStatusDateInput.value = defaultDate;
            }
            stockStatusDateInput.addEventListener("change", () => {
                const value = stockStatusDateInput.value || defaultDate;
                loadStockStatus(value);
            });
            loadStockStatus(stockStatusDateInput.value);
        } else {
            loadStockStatus(isoToday());
        }

        function renderSupplierRows(items) {
            if (!supplierTableBody || !supplierTableWrapper || !supplierEmptyState) {
                return;
            }

            supplierTableBody.innerHTML = "";

            if (!items || items.length === 0) {
                supplierTableWrapper.hidden = true;
                supplierEmptyState.hidden = false;
                supplierEmptyState.textContent = "No suppliers registered yet.";
                return;
            }

            if (supplierActionsHeader) {
                supplierActionsHeader.hidden = !canEditSuppliers;
            }

            items.forEach((item) => {
                const row = document.createElement("tr");

                if (canEditSuppliers && item.id) {
                    row.addEventListener("click", (event) => {
                        const interactiveTarget = event.target.closest(
                            "button, a, input, select, textarea"
                        );
                        if (interactiveTarget) {
                            return;
                        }
                        openSupplierEditor(item.id, item);
                    });
                }

                const nameCell = document.createElement("td");
                nameCell.textContent = item.name || "—";
                row.appendChild(nameCell);

                const regCell = document.createElement("td");
                regCell.textContent = item.supplierRegNo || "—";
                row.appendChild(regCell);

                const categoryCell = document.createElement("td");
                categoryCell.textContent = item.category || "—";
                row.appendChild(categoryCell);

                const phoneCell = document.createElement("td");
                phoneCell.textContent = item.primaryPhone || item.phone || "—";
                row.appendChild(phoneCell);

                const vehicleCell = document.createElement("td");
                vehicleCell.textContent = item.vehicleNo1 || "—";
                row.appendChild(vehicleCell);

                const creditCell = document.createElement("td");
                creditCell.textContent = item.creditPeriod || "—";
                row.appendChild(creditCell);

                if (canEditSuppliers) {
                    const actionCell = document.createElement("td");
                    if (item.id) {
                        const editButton = document.createElement("button");
                        editButton.type = "button";
                        editButton.className = "button button--secondary supplier-edit-btn";
                        editButton.setAttribute("data-supplier-id", item.id);
                        editButton.textContent = "Edit";
                        editButton.addEventListener("click", () => {
                            openSupplierEditor(item.id, item);
                        });
                        actionCell.appendChild(editButton);
                    } else {
                        actionCell.textContent = "—";
                    }
                    row.appendChild(actionCell);
                }

                supplierTableBody.appendChild(row);
            });

            supplierEmptyState.hidden = true;
            supplierTableWrapper.hidden = false;
        }

        async function loadSuppliers(query = "") {
            if (!supplierTableBody || !supplierEmptyState) {
                return [];
            }

            supplierEmptyState.hidden = false;
            supplierEmptyState.textContent = "Loading suppliers…";
            if (supplierTableWrapper) {
                supplierTableWrapper.hidden = true;
            }

            try {
                const url = new URL("/api/material/suppliers", window.location.origin);
                url.searchParams.set("limit", "15");
                if (query && query.trim()) {
                    url.searchParams.set("search", query.trim());
                }
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error("Failed to load suppliers");
                }
                const data = await response.json();
                if (!Array.isArray(data)) {
                    renderSupplierRows([]);
                    return [];
                }
                renderSupplierRows(data);
                return data;
            } catch (error) {
                console.error(error);
                supplierEmptyState.hidden = false;
                supplierEmptyState.textContent =
                    "Unable to load suppliers right now. Please try again.";
                return [];
            }
        }

        function setSupplierModalError(message) {
            if (!supplierModalAlert) {
                return;
            }
            if (message) {
                supplierModalAlert.hidden = false;
                supplierModalAlert.textContent = message;
            } else {
                supplierModalAlert.hidden = true;
                supplierModalAlert.textContent = "";
            }
        }

        Object.entries(supplierFieldElements).forEach(([field, element]) => {
            if (!element) {
                return;
            }
            const handler = () => {
                supplierTouchedFields.add(field);
                if (field in supplierServerErrors) {
                    delete supplierServerErrors[field];
                }
                if (field === "category") {
                    updateVehicleRequirement(element.value);
                }
                evaluateSupplierForm();
            };
            const eventName = element.tagName === "SELECT" ? "change" : "input";
            element.addEventListener(eventName, handler);
            element.addEventListener("blur", handler);
        });

        if (supplierModalForm) {
            supplierModalForm.addEventListener("submit", async (event) => {
                event.preventDefault();
                setSupplierModalError("");
                supplierTouchedFields.add("name");
                supplierTouchedFields.add("supplier_id_no");
                supplierTouchedFields.add("category");
                supplierTouchedFields.add("primary_phone");
                supplierTouchedFields.add("credit_period");
                supplierTouchedFields.add("vehicle_no_1");

                const { values, clientErrors } = evaluateSupplierForm({ force: true });
                if (Object.keys(clientErrors).length > 0) {
                    return;
                }

                const supplierId = supplierIdInput ? supplierIdInput.value.trim() : "";
                const targetSupplierId = supplierId || activeSupplierId || "";
                const method = targetSupplierId ? "PUT" : "POST";
                const url = targetSupplierId
                    ? `/api/material/suppliers/${targetSupplierId}`
                    : "/api/material/suppliers";

                supplierModalSaveButton.disabled = true;
                const payload = {
                    name: values.name,
                    supplier_id_no: values.supplier_id_no,
                    category: values.category,
                    primary_phone: values.primary_phone,
                    credit_period: values.credit_period,
                    secondary_phone: values.secondary_phone,
                    vehicle_no_1: values.vehicle_no_1,
                    vehicle_no_2: values.vehicle_no_2,
                    vehicle_no_3: values.vehicle_no_3,
                    email: values.email,
                    address: values.address,
                    tax_id: values.tax_id,
                };

                try {
                    const response = await fetch(url, {
                        method,
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: token ? `Bearer ${token}` : undefined,
                        },
                        body: JSON.stringify(payload),
                    });
                    const data = await response.json().catch(() => ({}));
                    if (!response.ok) {
                        const fieldErrors = data?.errors || {};
                        supplierServerErrors = { ...fieldErrors };
                        Object.keys(fieldErrors).forEach((field) => supplierTouchedFields.add(field));
                        evaluateSupplierForm({ force: true });
                        const message =
                            fieldErrors.supplier_reg_no || data?.msg || "Unable to save supplier.";
                        if (message) {
                            setSupplierModalError(message);
                        }
                        return;
                    }

                    const currentQuery = supplierSearchInput ? supplierSearchInput.value : "";
                    await loadSuppliers(currentQuery || "");
                    closeSupplierModal();
                } catch (error) {
                    setSupplierModalError("Network error. Please try again.");
                } finally {
                    evaluateSupplierForm();
                }
            });
        }

        function updateVehicleRequirement(categoryValue) {
            const isRaw = categoryValue === "Raw Material";
            const vehicleField = supplierFieldElements.vehicle_no_1;
            if (vehicleField) {
                if (isRaw) {
                    vehicleField.setAttribute("required", "required");
                } else {
                    vehicleField.removeAttribute("required");
                }
            }
            if (vehicleRequirementHelper) {
                if (isRaw) {
                    vehicleRequirementHelper.removeAttribute("hidden");
                } else {
                    vehicleRequirementHelper.setAttribute("hidden", "");
                }
            }
        }

        function updateSupplierFieldErrors(errors, { force = false } = {}) {
            const mapping = {
                name: "modal_name",
                primary_phone: "modal_primary_phone",
                category: "modal_category",
                supplier_id_no: "modal_supplier_id_no",
                credit_period: "modal_credit_period",
                vehicle_no_1: "modal_vehicle_no_1",
            };

            Object.entries(mapping).forEach(([field, key]) => {
                const node = supplierModalForm?.querySelector(`[data-error-for='${key}']`);
                if (!node) {
                    return;
                }
                const message = errors[field];
                if (message && (force || supplierTouchedFields.has(field))) {
                    node.textContent = message;
                } else {
                    node.textContent = "";
                }
            });
        }

        function updateSupplierSaveButton(errors) {
            if (!supplierModalSaveButton) {
                return;
            }
            supplierModalSaveButton.disabled = Object.keys(errors).length > 0;
        }

        function getSupplierFormValues() {
            return {
                name: (supplierFieldElements.name?.value || "").trim(),
                supplier_id_no: (supplierFieldElements.supplier_id_no?.value || "").trim(),
                category: supplierFieldElements.category?.value || "",
                primary_phone: (supplierFieldElements.primary_phone?.value || "").trim(),
                secondary_phone: (supplierFieldElements.secondary_phone?.value || "").trim(),
                vehicle_no_1: (supplierFieldElements.vehicle_no_1?.value || "").trim(),
                vehicle_no_2: (supplierFieldElements.vehicle_no_2?.value || "").trim(),
                vehicle_no_3: (supplierFieldElements.vehicle_no_3?.value || "").trim(),
                credit_period: supplierFieldElements.credit_period?.value || "",
                email: (supplierFieldElements.email?.value || "").trim(),
                address: (supplierFieldElements.address?.value || "").trim(),
                tax_id: (supplierFieldElements.tax_id?.value || "").trim(),
            };
        }

        function validateSupplierFormValues(values) {
            const errors = {};
            if (!values.name) {
                errors.name = "Supplier name is required.";
            }
            if (!values.primary_phone) {
                errors.primary_phone = "Primary phone is required.";
            }
            if (!values.category) {
                errors.category = "Category is required.";
            } else if (!supplierCategories.has(values.category)) {
                errors.category = "Select a valid category.";
            }
            if (!values.supplier_id_no) {
                errors.supplier_id_no = "Supplier ID number is required.";
            }
            if (!values.credit_period) {
                errors.credit_period = "Credit period is required.";
            } else if (!supplierCreditPeriods.has(values.credit_period)) {
                errors.credit_period = "Select a valid credit period.";
            }
            if (values.category === "Raw Material" && !values.vehicle_no_1) {
                errors.vehicle_no_1 = "Vehicle number is required for Raw Material suppliers.";
            }

            return errors;
        }

        function evaluateSupplierForm({ force = false } = {}) {
            const values = getSupplierFormValues();
            const clientErrors = validateSupplierFormValues(values);
            const combinedErrors = { ...clientErrors, ...supplierServerErrors };
            updateSupplierFieldErrors(combinedErrors, { force });
            updateSupplierSaveButton(combinedErrors);
            return { values, errors: combinedErrors, clientErrors };
        }

        function populateSupplierForm(record) {
            if (supplierIdInput) {
                supplierIdInput.value = record?.id || "";
            }
            supplierFieldElements.name.value = record?.name || "";
            supplierFieldElements.supplier_id_no.value = record?.supplierIdNo || "";
            supplierFieldElements.category.value = record?.category || "";
            supplierFieldElements.primary_phone.value = record?.primaryPhone || record?.phone || "";
            supplierFieldElements.secondary_phone.value = record?.secondaryPhone || "";
            supplierFieldElements.vehicle_no_1.value = record?.vehicleNo1 || "";
            supplierFieldElements.vehicle_no_2.value = record?.vehicleNo2 || "";
            supplierFieldElements.vehicle_no_3.value = record?.vehicleNo3 || "";
            supplierFieldElements.credit_period.value = record?.creditPeriod || "";
            supplierFieldElements.email.value = record?.email || "";
            supplierFieldElements.address.value = record?.address || "";
            supplierFieldElements.tax_id.value = record?.taxId || "";

            if (supplierRegistrationInput) {
                supplierRegistrationInput.value = record?.supplierRegNo || "";
            }

            updateVehicleRequirement(record?.category || "");
            evaluateSupplierForm({ force: true });
        }

        function closeSupplierModal() {
            if (supplierModal) {
                supplierModal.classList.remove("modal--open");
                supplierModal.setAttribute("hidden", "");
                supplierModal.setAttribute("aria-hidden", "true");
            }
            document.body.classList.remove("modal-open");
            activeSupplierId = null;
            if (supplierIdInput) {
                supplierIdInput.value = "";
            }
        }

        function resetSupplierModalState(defaultTitle = "Edit supplier") {
            supplierTouchedFields.clear();
            supplierServerErrors = {};
            setSupplierModalError("");
            if (supplierModalTitle) {
                supplierModalTitle.textContent = defaultTitle;
            }
            if (supplierIdInput) {
                supplierIdInput.value = "";
            }
            updateSupplierFieldErrors({}, { force: true });
        }

        function loadSupplierIntoForm(supplierId) {
            if (!supplierId) {
                setSupplierModalError("Unable to load this supplier.");
                return;
            }

            if (supplierModalSaveButton) {
                supplierModalSaveButton.disabled = true;
            }

            fetch(`/api/material/suppliers/${supplierId}`, {
                headers: {
                    Authorization: token ? `Bearer ${token}` : undefined,
                },
            })
                .then((response) =>
                    response
                        .json()
                        .catch(() => ({}))
                        .then((data) => ({ response, data }))
                )
                .then(({ response, data }) => {
                    if (!response.ok) {
                        const message = data?.errors?.id || data?.msg || "Unable to load supplier.";
                        setSupplierModalError(message);
                        console.error("Failed to load supplier", message);
                        return;
                    }
                    populateSupplierForm(data);
                    if (supplierModalSaveButton) {
                        supplierModalSaveButton.disabled = false;
                    }
                    supplierFieldElements.name?.focus();
                })
                .catch((error) => {
                    console.error("Unexpected error loading supplier", error);
                    setSupplierModalError("Unable to load supplier.");
                });
        }

        function openSupplierEditor(supplierId, record = null) {
            if (!canEditSuppliers || !supplierModal) {
                return;
            }

            // Reset state and basic info
            resetSupplierModalState("Edit supplier");
            activeSupplierId = supplierId || null;
            if (supplierIdInput) {
                supplierIdInput.value = supplierId || "";
            }

            // Open the modal
            supplierModal.classList.add("modal--open");
            supplierModal.removeAttribute("hidden");
            supplierModal.setAttribute("aria-hidden", "false");
            document.body.classList.add("modal-open");

            // If we have the record from the table, use it immediately
            if (record) {
                populateSupplierForm(record);
                if (supplierModalSaveButton) {
                    supplierModalSaveButton.disabled = false;
                }
            } else if (supplierModalSaveButton) {
                supplierModalSaveButton.disabled = true;
            }

            // Always try to refresh from backend in the background
            loadSupplierIntoForm(supplierId);
        }

        function openSupplierCreator() {
            if (!supplierModal) {
                return;
            }
            activeSupplierId = null;
            resetSupplierModalState("Register supplier");
            populateSupplierForm({});
            supplierModal.classList.add("modal--open");
            supplierModal.removeAttribute("hidden");
            supplierModal.setAttribute("aria-hidden", "false");
            document.body.classList.add("modal-open");
            supplierModalSaveButton.disabled = false;
            supplierFieldElements.name?.focus();
        }

        if (supplierModalClose) {
            supplierModalClose.addEventListener("click", closeSupplierModal);
        }

        if (supplierModalCancel) {
            supplierModalCancel.addEventListener("click", closeSupplierModal);
        }

        const supplierModalOverlay = supplierModal?.querySelector("[data-modal-dismiss]");
        if (supplierModalOverlay) {
            supplierModalOverlay.addEventListener("click", closeSupplierModal);
        }

        function formatDate(value) {
            if (!value) {
                return "—";
            }
            const parts = value.split("-");
            if (parts.length !== 3) {
                return value;
            }
            const [year, month, day] = parts.map((part) => Number.parseInt(part, 10));
            if (Number.isNaN(year) || Number.isNaN(month) || Number.isNaN(day)) {
                return value;
            }
            const dateObject = new Date(year, month - 1, day);
            return dateObject.toLocaleDateString(undefined, {
                year: "numeric",
                month: "short",
                day: "numeric",
            });
        }

        function renderBriquetteMaterialHeadings(order, labels) {
            if (!briquetteMaterialHeadings) {
                return;
            }

            const fragment = document.createDocumentFragment();
            if (Array.isArray(order) && order.length) {
                order.forEach((key) => {
                    const th = document.createElement("th");
                    th.scope = "col";
                    th.textContent = labels?.[key] || key;
                    fragment.appendChild(th);
                });
            } else {
                ["Sawdust", "Wood Shaving", "Wood Powder", "Peanut Husk", "Fire Cut"].forEach((label) => {
                    const th = document.createElement("th");
                    th.scope = "col";
                    th.textContent = label;
                    fragment.appendChild(th);
                });
            }

            briquetteMaterialHeadings.innerHTML = "";
            briquetteMaterialHeadings.appendChild(fragment);
        }

        function renderBriquetteCostBreakdown(rows) {
            if (!briquetteCostTableBody) {
                return;
            }

            briquetteCostTableBody.innerHTML = "";
            if (!Array.isArray(rows) || rows.length === 0) {
                const emptyRow = document.createElement("tr");
                const cell = document.createElement("td");
                cell.colSpan = 5;
                cell.textContent = "No cost data available.";
                emptyRow.appendChild(cell);
                briquetteCostTableBody.appendChild(emptyRow);
                return;
            }

            rows.forEach((row) => {
                const tr = document.createElement("tr");
                const materialCell = document.createElement("td");
                materialCell.textContent = row.label || "—";
                tr.appendChild(materialCell);

                const qtyKgCell = document.createElement("td");
                qtyKgCell.textContent = formatNumber(row.quantity_kg, 3);
                tr.appendChild(qtyKgCell);

                const qtyTonCell = document.createElement("td");
                qtyTonCell.textContent = formatNumber(row.quantity_ton, 3);
                tr.appendChild(qtyTonCell);

                const unitPriceCell = document.createElement("td");
                unitPriceCell.textContent = formatNumber(row.unit_price, 4);
                tr.appendChild(unitPriceCell);

                const totalCostCell = document.createElement("td");
                totalCostCell.textContent = formatNumber(row.total_cost, 2);
                tr.appendChild(totalCostCell);

                briquetteCostTableBody.appendChild(tr);
            });
        }

        function clearBriquetteModalFeedback() {
            if (briquetteModalFeedback) {
                briquetteModalFeedback.hidden = true;
                briquetteModalFeedback.textContent = "";
                briquetteModalFeedback.classList.remove("modal__feedback--success");
            }
            if (briquetteModalError) {
                briquetteModalError.hidden = true;
                briquetteModalError.textContent = "";
            }
        }

        function setBriquetteModalFeedback(message, { isError = false } = {}) {
            if (isError) {
                if (briquetteModalError) {
                    briquetteModalError.hidden = false;
                    briquetteModalError.textContent = message;
                }
                if (briquetteModalFeedback) {
                    briquetteModalFeedback.hidden = true;
                    briquetteModalFeedback.textContent = "";
                    briquetteModalFeedback.classList.remove("modal__feedback--success");
                }
                return;
            }

            if (briquetteModalFeedback) {
                briquetteModalFeedback.hidden = false;
                briquetteModalFeedback.textContent = message;
                briquetteModalFeedback.classList.add("modal__feedback--success");
            }
            if (briquetteModalError) {
                briquetteModalError.hidden = true;
                briquetteModalError.textContent = "";
            }
        }

        function closeBriquetteModal() {
            if (!briquetteModal) {
                return;
            }
            briquetteModal.classList.remove("modal--open");
            briquetteModal.setAttribute("hidden", "");
            briquetteModal.setAttribute("aria-hidden", "true");
            document.body.classList.remove("modal-open");
            briquetteModalDateValue = null;
            briquetteDryerProductionTon = 0;
            briquetteTotalOutputTon = 0;
            briquetteComputedWoodShavingTon = 0;
            briquetteComputedDryMaterialTon = 0;
            if (briquetteModalForm) {
                briquetteModalForm.reset();
            }
            clearBriquetteModalFeedback();
        }

        function parseTonInput(input) {
            if (!input) {
                return 0;
            }
            const numeric = Number.parseFloat(input.value);
            return Number.isFinite(numeric) ? numeric : 0;
        }

        function updateDerivedMaterialValues() {
            const woodPowder = parseTonInput(briquetteWoodPowderInput);
            const peanutHusk = parseTonInput(briquettePeanutHuskInput);
            const dryerTons = Number.isFinite(briquetteDryerProductionTon)
                ? briquetteDryerProductionTon
                : 0;
            const totalOutput = Number.isFinite(briquetteTotalOutputTon)
                ? briquetteTotalOutputTon
                : 0;

            const woodShavingRaw = totalOutput - dryerTons - woodPowder - peanutHusk;
            const woodShavingClamped = Math.max(woodShavingRaw, 0);
            if (Number.isFinite(woodShavingClamped)) {
                briquetteComputedWoodShavingTon = Number(woodShavingClamped.toFixed(3));
                if (briquetteWoodShavingInput) {
                    briquetteWoodShavingInput.value = briquetteComputedWoodShavingTon.toFixed(3);
                }
            } else {
                briquetteComputedWoodShavingTon = 0;
                if (briquetteWoodShavingInput) {
                    briquetteWoodShavingInput.value = "0.000";
                }
            }

            const dryMaterialRaw = dryerTons + woodShavingClamped + woodPowder + peanutHusk;
            if (Number.isFinite(dryMaterialRaw)) {
                briquetteComputedDryMaterialTon = Number(dryMaterialRaw.toFixed(3));
                if (briquetteDryMaterialInput) {
                    briquetteDryMaterialInput.value = briquetteComputedDryMaterialTon.toFixed(3);
                }
            } else {
                briquetteComputedDryMaterialTon = 0;
                if (briquetteDryMaterialInput) {
                    briquetteDryMaterialInput.value = "0.000";
                }
            }
        }

        function updateSawdustPreview() {
            if (!briquetteDryFactorInput || !briquetteSawdustInput) {
                return;
            }
            const dryFactor = Number.parseFloat(briquetteDryFactorInput.value || "0");
            if (!Number.isFinite(dryFactor) || dryFactor <= 0) {
                briquetteSawdustInput.value = "0.000";
                return;
            }
            const sawdustTons = Math.max(0, briquetteDryerProductionTon / dryFactor);
            briquetteSawdustInput.value = sawdustTons.toFixed(3);
        }

        function populateBriquetteModal(data) {
            if (!data) {
                return;
            }
            if (briquetteModalDate) {
                briquetteModalDate.value = formatDate(data.date) || data.date || "—";
            }
            if (typeof data.dry_factor === "number" && briquetteDryFactorInput) {
                briquetteDryFactorInput.value = data.dry_factor.toFixed(4);
            } else if (briquetteDryFactorInput) {
                briquetteDryFactorInput.value = DEFAULT_DRY_FACTOR_DISPLAY;
            }
            const dryerValue = Number(data.dryer_production_ton);
            briquetteDryerProductionTon = Number.isFinite(dryerValue) ? dryerValue : 0;

            const totalOutputTon = Number(data.briquette_production_ton);
            briquetteTotalOutputTon = Number.isFinite(totalOutputTon) ? totalOutputTon : 0;

            if (briquetteOutputKg) {
                briquetteOutputKg.textContent = formatNumber(data.briquette_output_kg, 2);
            }

            if (briquetteDryerHoursInput) {
                const hoursValue = Number(data.dryer_actual_running_hours);
                if (Number.isFinite(hoursValue)) {
                    briquetteDryerHoursInput.value = hoursValue.toFixed(1);
                } else {
                    briquetteDryerHoursInput.value = "0.0";
                }
            }

            const materials = data.materials || {};
            if (briquetteWoodShavingInput) {
                const value = Number(data.wood_shaving_ton ?? materials.wood_shaving);
                const numeric = Number.isFinite(value) ? value : 0;
                briquetteWoodShavingInput.value = numeric.toFixed(3);
            }
            if (briquetteWoodPowderInput) {
                const value = Number.parseFloat(materials.wood_powder) || 0;
                briquetteWoodPowderInput.value = value.toFixed(3);
            }
            if (briquettePeanutHuskInput) {
                const value = Number.parseFloat(materials.peanut_husk) || 0;
                briquettePeanutHuskInput.value = value.toFixed(3);
            }
            if (briquetteFireCutInput) {
                const value = Number.parseFloat(materials.fire_cut) || 0;
                briquetteFireCutInput.value = value.toFixed(3);
            }
            if (briquetteDryMaterialInput) {
                const value = Number(data.dry_material_ton);
                const numeric = Number.isFinite(value) ? value : 0;
                briquetteDryMaterialInput.value = numeric.toFixed(3);
            }
            if (briquetteSawdustInput) {
                const sawdustValue = Number.parseFloat(data.sawdust_ton) || 0;
                briquetteSawdustInput.value = sawdustValue.toFixed(3);
            }

            if (briquetteTotalCost) {
                briquetteTotalCost.textContent = `Rs ${formatNumber(data.total_material_cost, 2)}`;
            }
            if (briquetteUnitCost) {
                briquetteUnitCost.textContent = `Rs ${formatNumber(data.unit_cost_per_kg, 4)}`;
            }

            renderBriquetteCostBreakdown(data.cost_breakdown);
        }

        async function fetchBriquetteMix(dateIso) {
            if (!dateIso) {
                return;
            }
            clearBriquetteModalFeedback();
            if (briquetteSaveButton) {
                briquetteSaveButton.disabled = true;
            }
            try {
                const response = await fetch(`/api/material/briquette-production/${dateIso}`);
                if (!response.ok) {
                    throw new Error("Unable to load mix details.");
                }
                const data = await response.json();
                populateBriquetteModal(data);
                if (Array.isArray(data.material_order)) {
                    briquetteMaterialOrder = data.material_order;
                }
                if (data.material_labels) {
                    briquetteMaterialLabels = data.material_labels;
                }
                renderBriquetteMaterialHeadings(briquetteMaterialOrder, briquetteMaterialLabels);
                updateSawdustPreview();
            if (briquetteSaveButton) {
                briquetteSaveButton.disabled = false;
            }
            updateDerivedMaterialValues();
        } catch (error) {
            console.error(error);
            setBriquetteModalFeedback("Unable to load mix details. Please try again.", { isError: true });
                if (briquetteSaveButton) {
                    briquetteSaveButton.disabled = false;
                }
            }
        }

        function openBriquetteModal(dateIso, options = {}) {
            if (!briquetteModal || !dateIso) {
                return;
            }
            const { hasMix = false } = options;
            briquetteModalDateValue = dateIso;
            briquetteModal.removeAttribute("hidden");
            briquetteModal.setAttribute("aria-hidden", "false");
            briquetteModal.classList.add("modal--open");
            document.body.classList.add("modal-open");
            if (briquetteDryFactorInput) {
                briquetteDryFactorInput.value = hasMix ? "" : DEFAULT_DRY_FACTOR_DISPLAY;
            }
            if (briquetteSaveButton) {
                briquetteSaveButton.disabled = true;
            }
            clearBriquetteModalFeedback();
            fetchBriquetteMix(dateIso);
        }

        function renderBriquetteRows(entries) {
            if (!briquetteTableBody || !briquetteTableWrapper || !briquetteEmptyState) {
                return;
            }

            briquetteTableBody.innerHTML = "";

            if (!Array.isArray(entries) || entries.length === 0) {
                briquetteTableWrapper.hidden = true;
                briquetteEmptyState.hidden = false;
                briquetteEmptyState.textContent = "No briquette production entries recorded yet.";
                return;
            }

            entries.forEach((entry) => {
                const tr = document.createElement("tr");
                const dateCell = document.createElement("td");
                dateCell.textContent = formatDate(entry.date) || entry.date || "—";
                tr.appendChild(dateCell);

                const productionCell = document.createElement("td");
                productionCell.textContent = formatNumber(entry.briquette_production_ton, 3);
                tr.appendChild(productionCell);

                if (!Array.isArray(briquetteMaterialOrder) || briquetteMaterialOrder.length === 0) {
                    briquetteMaterialOrder = Object.keys(entry.materials || {});
                }

                briquetteMaterialOrder.forEach((key) => {
                    const cell = document.createElement("td");
                    const value = (entry.materials && entry.materials[key]) || 0;
                    cell.textContent = formatNumber(value, 3);
                    tr.appendChild(cell);
                });

                const unitCostCell = document.createElement("td");
                unitCostCell.textContent = formatNumber(entry.unit_cost_per_kg, 4);
                tr.appendChild(unitCostCell);

                const totalCostCell = document.createElement("td");
                totalCostCell.textContent = formatNumber(entry.total_material_cost, 2);
                tr.appendChild(totalCostCell);

                const actionCell = document.createElement("td");
                const actionButton = document.createElement("button");
                actionButton.type = "button";
                actionButton.className = "button button--secondary";
                actionButton.textContent = entry.has_mix ? "Edit mix" : "Update mix";
                actionButton.dataset.mixDate = entry.date;
                actionButton.dataset.hasMix = entry.has_mix ? "true" : "false";
                actionCell.appendChild(actionButton);
                tr.appendChild(actionCell);

                briquetteTableBody.appendChild(tr);
            });

            briquetteEmptyState.hidden = true;
            briquetteTableWrapper.hidden = false;
        }

        async function loadBriquetteProductionEntries() {
            if (!briquetteEmptyState) {
                return;
            }

            briquetteEmptyState.hidden = false;
            briquetteEmptyState.textContent = "Loading briquette production…";
            if (briquetteTableWrapper) {
                briquetteTableWrapper.hidden = true;
            }

            try {
                const response = await fetch("/api/material/briquette-production");
                if (!response.ok) {
                    throw new Error("Failed to load briquette production entries.");
                }
                const data = await response.json();
                if (Array.isArray(data.material_order)) {
                    briquetteMaterialOrder = data.material_order;
                }
                if (data.material_labels) {
                    briquetteMaterialLabels = data.material_labels;
                }
                renderBriquetteMaterialHeadings(briquetteMaterialOrder, briquetteMaterialLabels);
                renderBriquetteRows(data.entries || []);
            } catch (error) {
                console.error(error);
                if (briquetteEmptyState) {
                    briquetteEmptyState.hidden = false;
                    briquetteEmptyState.textContent = "Unable to load briquette production right now.";
                }
            }
        }

        if (registerSupplierButton && !canEditSuppliers) {
            registerSupplierButton.disabled = true;
            registerSupplierButton.title = "You do not have permission to register suppliers.";
        }

        if (registerSupplierButton && canEditSuppliers) {
            registerSupplierButton.addEventListener("click", (event) => {
                event.preventDefault();
                openSupplierCreator();
            });
        }

        if (supplierTableBody) {
            supplierTableBody.addEventListener("click", (event) => {
                const editButton = event.target.closest(".supplier-edit-btn");
                if (!editButton) {
                    return;
                }

                event.preventDefault();
                const supplierId = editButton.getAttribute("data-supplier-id");
                if (supplierId) {
                    openSupplierEditor(supplierId);
                }
            });
        }

        if (supplierSearchForm) {
            supplierSearchForm.addEventListener("submit", (event) => {
                event.preventDefault();
                const query = supplierSearchInput ? supplierSearchInput.value : "";
                loadSuppliers(query);
            });
        }

        if (supplierClearButton) {
            supplierClearButton.addEventListener("click", () => {
                if (supplierSearchInput) {
                    supplierSearchInput.value = "";
                }
                loadSuppliers("");
            });
        }

        if (supplierSearchInput) {
            supplierSearchInput.addEventListener("input", () => {
                if (supplierSearchInput.value.trim() === "") {
                    loadSuppliers("");
                }
            });
        }

        function renderMrnRows(items) {
            if (!mrnTableBody || !mrnTableWrapper || !mrnEmptyState) {
                return;
            }

            mrnTableBody.innerHTML = "";

            if (!items || items.length === 0) {
                mrnTableWrapper.hidden = true;
                mrnEmptyState.hidden = false;
                mrnEmptyState.textContent = "No material receipts recorded yet.";
                return;
            }

            items.forEach((item) => {
                const row = document.createElement("tr");

                const mrnCell = document.createElement("td");
                const mrnLink = document.createElement("a");
                mrnLink.className = "data-table__link";
                mrnLink.href = `/material/mrn/${item.id}`;
                mrnLink.textContent = item.mrn_no;
                mrnCell.appendChild(mrnLink);
                row.appendChild(mrnCell);

                const dateCell = document.createElement("td");
                dateCell.textContent = formatDate(item.date);
                row.appendChild(dateCell);

                const supplierCell = document.createElement("td");
                supplierCell.textContent =
                    (item.supplier && item.supplier.name) || item.vehicle_no || "—";
                row.appendChild(supplierCell);

                const sourcingCell = document.createElement("td");
                sourcingCell.textContent = item.sourcing_type || "—";
                row.appendChild(sourcingCell);

                const materialCell = document.createElement("td");
                let materialSummary = "—";
                if (Array.isArray(item.items) && item.items.length > 0) {
                    const firstItem = item.items[0];
                    const firstName = (firstItem.item && firstItem.item.name) || firstItem.name || "—";
                    if (item.items.length === 1) {
                        materialSummary = firstName;
                    } else {
                        materialSummary = `${firstName} + ${item.items.length - 1} more`;
                    }
                }
                materialCell.textContent = materialSummary;
                row.appendChild(materialCell);

                const qtyCell = document.createElement("td");
                qtyCell.textContent = formatNumber(item.qty_ton, 3);
                row.appendChild(qtyCell);

                const amountCell = document.createElement("td");
                amountCell.textContent = formatNumber(item.amount, 2);
                row.appendChild(amountCell);

                const actionsCell = document.createElement("td");
                actionsCell.className = "mrn-table__actions";
                const editButton = document.createElement("a");
                editButton.className = "button button--secondary button--small mrn-table__edit-button";
                editButton.href = `/material/mrn/${item.id}/edit`;
                editButton.textContent = "Edit";
                editButton.setAttribute("aria-label", `Edit material receipt ${item.mrn_no}`);
                actionsCell.appendChild(editButton);
                row.appendChild(actionsCell);

                mrnTableBody.appendChild(row);
            });

            mrnEmptyState.hidden = true;
            mrnTableWrapper.hidden = false;
        }

        async function loadMrns(queryOverride) {
            if (!mrnTableBody || !mrnEmptyState) {
                return;
            }

            mrnEmptyState.hidden = false;
            mrnEmptyState.textContent = "Loading material receipts…";
            if (mrnTableWrapper) {
                mrnTableWrapper.hidden = true;
            }

            try {
                const url = new URL("/api/material/mrn", window.location.origin);
                const queryValue =
                    typeof queryOverride === "string"
                        ? queryOverride
                        : mrnSearchInput
                          ? mrnSearchInput.value
                          : "";
                const trimmedQuery = queryValue ? queryValue.trim() : "";
                const startDateValue = mrnStartDateInput ? mrnStartDateInput.value : "";
                const endDateValue = mrnEndDateInput ? mrnEndDateInput.value : "";

                if (trimmedQuery) {
                    url.searchParams.set("q", trimmedQuery);
                }
                if (startDateValue) {
                    url.searchParams.set("start_date", startDateValue);
                }
                if (endDateValue) {
                    url.searchParams.set("end_date", endDateValue);
                }
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error("Failed to load MRNs");
                }
                const data = await response.json();
                if (!Array.isArray(data)) {
                    renderMrnRows([]);
                    return;
                }
                renderMrnRows(data);
            } catch (error) {
                console.error(error);
                mrnEmptyState.hidden = false;
                mrnEmptyState.textContent =
                    "Unable to load material receipts right now. Please try again.";
            }
        }

        if (mrnSearchForm) {
            mrnSearchForm.addEventListener("submit", (event) => {
                event.preventDefault();
                const query = mrnSearchInput ? mrnSearchInput.value : "";
                loadMrns(query);
            });
        }

        if (mrnClearButton) {
            mrnClearButton.addEventListener("click", () => {
                if (mrnSearchInput) {
                    mrnSearchInput.value = "";
                }
                loadMrns("");
            });
        }

        if (mrnSearchInput) {
            mrnSearchInput.addEventListener("input", () => {
                if (mrnSearchInput.value.trim() === "") {
                    loadMrns("");
                }
            });
        }

        if (mrnStartDateInput) {
            mrnStartDateInput.addEventListener("change", () => {
                const currentQuery = mrnSearchInput ? mrnSearchInput.value : "";
                loadMrns(currentQuery);
            });
        }

        if (mrnEndDateInput) {
            mrnEndDateInput.addEventListener("change", () => {
                const currentQuery = mrnSearchInput ? mrnSearchInput.value : "";
                loadMrns(currentQuery);
            });
        }

        if (briquetteTableBody) {
            briquetteTableBody.addEventListener("click", (event) => {
                const button = event.target.closest("button[data-mix-date]");
                if (!button) {
                    return;
                }
                const dateIso = button.dataset.mixDate;
                const hasMix = button.dataset.hasMix === "true";
                openBriquetteModal(dateIso, { hasMix });
            });
        }

        if (briquetteModalClose) {
            briquetteModalClose.addEventListener("click", () => {
                closeBriquetteModal();
            });
        }

        if (briquetteModalCancel) {
            briquetteModalCancel.addEventListener("click", () => {
                closeBriquetteModal();
            });
        }

        if (briquetteModal) {
            briquetteModal.addEventListener("click", (event) => {
                if (event.target && event.target.dataset && "modalDismiss" in event.target.dataset) {
                    closeBriquetteModal();
                }
            });
        }

        document.addEventListener("keydown", (event) => {
            if (event.key === "Escape" && briquetteModal && !briquetteModal.hasAttribute("hidden")) {
                closeBriquetteModal();
            }
        });

        if (briquetteDryFactorInput) {
            briquetteDryFactorInput.addEventListener("input", updateSawdustPreview);
        }

        if (briquetteWoodPowderInput) {
            briquetteWoodPowderInput.addEventListener("input", () => {
                updateDerivedMaterialValues();
            });
        }

        if (briquettePeanutHuskInput) {
            briquettePeanutHuskInput.addEventListener("input", () => {
                updateDerivedMaterialValues();
            });
        }

        if (briquetteFireCutInput) {
            briquetteFireCutInput.addEventListener("input", () => {
                updateDerivedMaterialValues();
            });
        }

        if (briquetteModalForm) {
            briquetteModalForm.addEventListener("submit", async (event) => {
                event.preventDefault();
                if (!briquetteModalDateValue) {
                    setBriquetteModalFeedback("No date selected.", { isError: true });
                    return;
                }

                if (briquetteSaveButton) {
                    briquetteSaveButton.disabled = true;
                }
                clearBriquetteModalFeedback();

                updateDerivedMaterialValues();

                const woodShavingForPayload = Number.isFinite(briquetteComputedWoodShavingTon)
                    ? briquetteComputedWoodShavingTon.toFixed(3)
                    : briquetteWoodShavingInput
                    ? (() => {
                          const fallbackValue = Number.parseFloat(
                              briquetteWoodShavingInput.value || "0",
                          );
                          return Number.isFinite(fallbackValue)
                              ? fallbackValue.toFixed(3)
                              : "0.000";
                      })()
                    : "0.000";

                const payload = {
                    dry_factor: briquetteDryFactorInput ? briquetteDryFactorInput.value : null,
                    wood_shaving_ton: woodShavingForPayload,
                    wood_powder_ton: briquetteWoodPowderInput ? briquetteWoodPowderInput.value : null,
                    peanut_husk_ton: briquettePeanutHuskInput ? briquettePeanutHuskInput.value : null,
                    fire_cut_ton: briquetteFireCutInput ? briquetteFireCutInput.value : null,
                };

                try {
                    const response = await fetch(`/api/material/briquette-production/${briquetteModalDateValue}`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(payload),
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        const message = errorData?.msg || "Unable to save mix details.";
                        throw new Error(message);
                    }

                    const data = await response.json();
                    populateBriquetteModal(data);
                    setBriquetteModalFeedback("Mix updated successfully.");
                    loadBriquetteProductionEntries();
                } catch (error) {
                    console.error(error);
                    setBriquetteModalFeedback(error.message || "Unable to save mix details.", { isError: true });
                } finally {
                    if (briquetteSaveButton) {
                        briquetteSaveButton.disabled = false;
                    }
                }
            });
        }

        loadSuppliers("");
        loadMrns("");
        loadBriquetteProductionEntries();
    </script>
</body>
</html>
