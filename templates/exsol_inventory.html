<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Exsol Inventory | SAMPROX ERP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" />
</head>
<body>
    <div class="page">
        <header class="topbar">
            <div class="brand">
                <div class="brand__logo">S</div>
                <div class="brand__details">
                    <p class="brand__name">SAMPROX ERP</p>
                    <p class="brand__section">Exsol Inventory</p>
                </div>
            </div>
            <div class="topbar__actions">
                <div class="user-summary">
                    <span class="user-summary__name" id="user-name"></span>
                    <span class="user-summary__role" id="user-role"></span>
                </div>
                <button type="button" class="button button--secondary" id="logout">Sign out</button>
            </div>
        </header>
        <nav class="subnav" aria-label="Exsol inventory navigation">
            <a class="subnav__link subnav__link--active" href="{{ url_for('ui.exsol_inventory_page') }}">Stock Items</a>
        </nav>

        <section class="section">
            <header class="section__header">
                <div>
                    <p class="eyebrow">Exsol Engineering</p>
                    <h1>Exsol Stock Items</h1>
                    <p class="section__description">
                        Maintain a dedicated catalog for Exsol Engineering items without touching Samprox inventory or sales data.
                    </p>
                </div>
                <div class="status-pill" id="exsol-status" hidden></div>
            </header>

            <article class="tile">
                <h2 class="tile__title">Isolated by company</h2>
                <p class="tile__description">
                    Exsol inventory items are stored in the same database but isolated by company, so they never appear in Samprox reports or dropdowns.
                </p>
            </article>

            <div class="material-receipts-card stock-status-card">
                <div class="material-receipts-card__header stock-status-card__header">
                    <div>
                        <h2 class="material-receipts-card__title">Stock catalog</h2>
                        <p class="material-receipts-card__meta">
                            Search and review Exsol-only stock items.
                        </p>
                    </div>
                    <div class="stock-status-card__controls">
                        <input type="search" class="stock-status-card__input" id="search-input" placeholder="Search by code or name" />
                        <button type="button" class="button button--ghost" id="refresh-btn">Refresh</button>
                    </div>
                </div>
                <div class="alert" id="exsol-error" hidden></div>
                <p class="empty-state" id="exsol-empty">Loading Exsol items…</p>
                <div class="table-wrapper" id="exsol-table-wrapper" hidden>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th scope="col">Code</th>
                                <th scope="col">Name</th>
                                <th scope="col">UOM</th>
                                <th scope="col">Active</th>
                                <th scope="col">Updated</th>
                            </tr>
                        </thead>
                        <tbody id="exsol-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div class="petty-card" id="exsol-form-card" hidden>
                <div class="material-receipts-card__header">
                    <div>
                        <h2 class="material-receipts-card__title">Add or update item</h2>
                        <p class="material-receipts-card__meta">
                            Only administrators can create or edit Exsol inventory items. Records are upserted by code.
                        </p>
                    </div>
                </div>
                <form id="exsol-form" class="form-grid">
                    <label class="form-field">
                        Item code
                        <input type="text" name="item_code" required />
                    </label>
                    <label class="form-field form-field--wide">
                        Item name
                        <input type="text" name="item_name" required />
                    </label>
                    <label class="form-field">
                        UOM
                        <input type="text" name="uom" value="PCS" />
                    </label>
                    <label class="form-field">
                        Active
                        <select name="is_active">
                            <option value="true" selected>Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </label>
                    <div class="form-field form-field--wide">
                        <button type="submit" class="button">Save item</button>
                    </div>
                </form>
            </div>

            <div class="petty-card" id="exsol-bulk-card" hidden>
                <div class="material-receipts-card__header">
                    <div>
                        <h2 class="material-receipts-card__title">Bulk upload</h2>
                        <p class="material-receipts-card__meta">
                            Upload a CSV with <strong>item_code</strong>, <strong>item_name</strong>, and <strong>uom</strong>.
                        </p>
                    </div>
                    <button type="button" class="button button--ghost" id="bulk-template-btn">Download template</button>
                </div>
                <div class="alert" id="exsol-bulk-error" hidden></div>
                <div class="form-grid">
                    <label class="form-field form-field--wide">
                        CSV file
                        <input type="file" id="bulk-file" accept=".csv" />
                    </label>
                    <div class="form-field form-field--wide">
                        <button type="button" class="button" id="bulk-upload-btn">Upload items</button>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        const token = localStorage.getItem("samprox_token");
        const user = JSON.parse(localStorage.getItem("samprox_user") || "null");
        const userNameEl = document.getElementById("user-name");
        const userRoleEl = document.getElementById("user-role");
        const logoutButton = document.getElementById("logout");
        const errorBox = document.getElementById("exsol-error");
        const emptyState = document.getElementById("exsol-empty");
        const tableWrapper = document.getElementById("exsol-table-wrapper");
        const tableBody = document.getElementById("exsol-table-body");
        const statusPill = document.getElementById("exsol-status");
        const formCard = document.getElementById("exsol-form-card");
        const formEl = document.getElementById("exsol-form");
        const bulkCard = document.getElementById("exsol-bulk-card");
        const bulkFileInput = document.getElementById("bulk-file");
        const bulkUploadButton = document.getElementById("bulk-upload-btn");
        const bulkTemplateButton = document.getElementById("bulk-template-btn");
        const bulkError = document.getElementById("exsol-bulk-error");
        const searchInput = document.getElementById("search-input");
        const refreshBtn = document.getElementById("refresh-btn");

        const normalizedRole = (user?.role || "").toLowerCase();
        const companyKey = (user?.company_key || user?.company || "").toLowerCase();
        const isAdmin = normalizedRole === "admin";
        const isExsolUser = companyKey === "exsol-engineering";

        const roleLabels = {
            admin: "Admin",
            sales_manager: "Sales Manager",
            production_manager: "Production Manager",
            maintenance_manager: "Maintenance Manager",
            finance_manager: "Finance Manager",
            outside_manager: "Member Of Rainbow Group",
            sales: "Sales",
        };

        if (!token || (!isAdmin && !isExsolUser)) {
            window.location.href = "/";
        }

        if (userNameEl) userNameEl.textContent = user?.name || "Unknown";
        if (userRoleEl) userRoleEl.textContent = roleLabels[normalizedRole] || "";

        logoutButton?.addEventListener("click", async () => {
            try {
                await fetch("/api/auth/logout", { method: "POST", credentials: "include" });
            } catch (error) {
                console.error("Failed to log out", error);
            } finally {
                localStorage.removeItem("samprox_token");
                localStorage.removeItem("samprox_user");
                window.location.href = "/";
            }
        });

        function setStatus(message, tone = "info") {
            if (!statusPill) return;
            if (!message) {
                statusPill.hidden = true;
                return;
            }
            statusPill.hidden = false;
            statusPill.textContent = message;
            statusPill.style.background = tone === "error" ? "rgba(239, 68, 68, 0.12)" : "rgba(37, 99, 235, 0.08)";
            statusPill.style.color = tone === "error" ? "#991b1b" : "#1d4ed8";
        }

        function renderItems(items) {
            if (!items || items.length === 0) {
                if (emptyState) emptyState.textContent = "No Exsol items found.";
                emptyState.hidden = false;
                tableWrapper.hidden = true;
                return;
            }

            emptyState.hidden = true;
            tableWrapper.hidden = false;
            tableBody.innerHTML = "";

            items.forEach((item) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${item.item_code || ""}</td>
                    <td>${item.item_name || ""}</td>
                    <td>${item.uom || ""}</td>
                    <td>${item.is_active ? "Yes" : "No"}</td>
                    <td>${item.updated_at ? new Date(item.updated_at).toLocaleString() : ""}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        async function loadItems(query = "") {
            emptyState.hidden = false;
            tableWrapper.hidden = true;
            errorBox.hidden = true;
            emptyState.textContent = "Loading Exsol items…";

            const params = query ? `?q=${encodeURIComponent(query)}` : "";
            try {
                const response = await fetch(`/api/exsol/inventory-items${params}`, {
                    headers: {
                        Authorization: token ? `Bearer ${token}` : undefined,
                    },
                });

                if (!response.ok) {
                    const data = await response.json().catch(() => ({}));
                    const message = data?.error || data?.msg || "Unable to load Exsol items.";
                    errorBox.textContent = message;
                    errorBox.hidden = false;
                    emptyState.textContent = "Exsol inventory is unavailable.";
                    setStatus(message, "error");
                    return;
                }

                const data = await response.json();
                renderItems(data);
                setStatus(`Loaded ${data.length} Exsol items.`);
            } catch (error) {
                console.error(error);
                errorBox.textContent = "Network error. Please try again.";
                errorBox.hidden = false;
                emptyState.textContent = "Exsol inventory is unavailable.";
                setStatus("Network error", "error");
            }
        }

        function formToPayload(form) {
            const formData = new FormData(form);
            return {
                item_code: formData.get("item_code"),
                item_name: formData.get("item_name"),
                uom: formData.get("uom") || "",
                is_active: (formData.get("is_active") || "true") === "true",
            };
        }

        async function submitForm(event) {
            event.preventDefault();
            if (!isAdmin) {
                errorBox.textContent = "Only administrators can add Exsol items.";
                errorBox.hidden = false;
                return;
            }

            const payload = formToPayload(event.target);
            setStatus("Saving item…");
            errorBox.hidden = true;
            try {
                const response = await fetch("/api/exsol/inventory-items", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: token ? `Bearer ${token}` : undefined,
                    },
                    body: JSON.stringify(payload),
                });
                const data = await response.json().catch(() => ({}));
                if (!response.ok) {
                    const message =
                        (data?.errors && Object.values(data.errors)[0]) ||
                        data?.error ||
                        data?.msg ||
                        "Unable to save item.";
                    errorBox.textContent = message;
                    errorBox.hidden = false;
                    setStatus(message, "error");
                    return;
                }
                setStatus(`Saved ${data.item_code || "item"}.`);
                event.target.reset();
                await loadItems(searchInput?.value || "");
            } catch (error) {
                errorBox.textContent = "Network error while saving item.";
                errorBox.hidden = false;
                setStatus("Network error", "error");
            }
        }

        const buildTemplateCsv = () => "item_code,item_name,uom\nEXS-050,EXS 0.50 HP WATER PUMP,PCS\n";

        const downloadTemplate = () => {
            const blob = new Blob([buildTemplateCsv()], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = "exsol_inventory_items_template.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        };

        const parseCsvItems = (text) => {
            const lines = text.split(/\r?\n/).map((line) => line.trim()).filter(Boolean);
            if (!lines.length) return [];
            const [header, ...rows] = lines;
            const hasHeader = header.toLowerCase().includes("item_code");
            const dataRows = hasHeader ? rows : lines;
            return dataRows.map((line) => {
                const [item_code, item_name, uom] = line.split(",").map((part) => part.trim());
                return { item_code, item_name, uom };
            }).filter((item) => item.item_code && item.item_name);
        };

        const uploadBulkItems = async () => {
            if (!isAdmin) return;
            bulkError.hidden = true;
            const file = bulkFileInput?.files?.[0];
            if (!file) {
                bulkError.textContent = "Select a CSV file to upload.";
                bulkError.hidden = false;
                return;
            }
            setStatus("Uploading Exsol items…");
            try {
                const text = await file.text();
                const items = parseCsvItems(text);
                if (!items.length) {
                    bulkError.textContent = "No valid rows found in the CSV file.";
                    bulkError.hidden = false;
                    setStatus("No valid rows", "error");
                    return;
                }
                const response = await fetch("/api/exsol/inventory-items/bulk", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: token ? `Bearer ${token}` : undefined,
                    },
                    body: JSON.stringify({ items }),
                });
                const data = await response.json().catch(() => ({}));
                if (!response.ok) {
                    const message = data?.error || data?.msg || "Unable to upload items.";
                    bulkError.textContent = message;
                    bulkError.hidden = false;
                    setStatus(message, "error");
                    return;
                }
                setStatus(`Uploaded ${data.saved || 0} items.`);
                bulkFileInput.value = "";
                await loadItems(searchInput?.value || "");
            } catch (error) {
                bulkError.textContent = "Network error while uploading items.";
                bulkError.hidden = false;
                setStatus("Network error", "error");
            }
        };

        if (formEl) {
            formEl.addEventListener("submit", submitForm);
        }

        bulkTemplateButton?.addEventListener("click", downloadTemplate);
        bulkUploadButton?.addEventListener("click", uploadBulkItems);

        if (searchInput) {
            searchInput.addEventListener("input", (event) => {
                const value = event.target.value || "";
                loadItems(value);
            });
        }

        refreshBtn?.addEventListener("click", () => loadItems(searchInput?.value || ""));

        if (!isAdmin) {
            if (formCard) formCard.hidden = true;
            if (bulkCard) bulkCard.hidden = true;
        } else {
            if (formCard) formCard.hidden = false;
            if (bulkCard) bulkCard.hidden = false;
        }

        loadItems();
    </script>
</body>
</html>
