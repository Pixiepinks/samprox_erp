<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ 'Edit Material Receipt Note' if is_edit_mode else 'Material Receipt Note' }} | SAMPROX ERP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" />
    <style>
        .content-card {
            background: #ffffff;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 40px rgba(15, 23, 42, 0.08);
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px 20px;
        }
        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .field label {
            font-weight: 600;
            color: #1f2937;
        }
        .field input,
        .field select,
        .field textarea {
            border: 1px solid #d1d5db;
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 0.95rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .field input:focus,
        .field select:focus,
        .field textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        .field input[readonly] {
            background-color: #f3f4f6;
            cursor: not-allowed;
        }
        .helper {
            font-size: 0.8rem;
            color: #6b7280;
        }
        .text-red {
            color: #dc2626;
        }
        .error-text {
            font-size: 0.8rem;
            color: #dc2626;
        }
        .actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }
        .button-primary {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: #fff;
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .button-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .button-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 12px 24px rgba(37, 99, 235, 0.2);
        }
        .button-secondary {
            background: transparent;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease, border-color 0.2s ease;
        }
        .button-secondary:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }
        .supplier-dropdown {
            position: relative;
        }
        .supplier-menu {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            width: 100%;
            background: #fff;
            border-radius: 12px;
            border: 1px solid rgba(15, 23, 42, 0.1);
            box-shadow: 0 15px 35px rgba(15, 23, 42, 0.15);
            max-height: 240px;
            overflow-y: auto;
            z-index: 30;
            display: none;
        }
        .supplier-menu.active {
            display: block;
        }
        .supplier-option {
            width: 100%;
            background: transparent;
            border: none;
            text-align: left;
            padding: 10px 14px;
            cursor: pointer;
            font-size: 0.95rem;
        }
        .supplier-option:hover,
        .supplier-option:focus {
            background: #eef2ff;
            outline: none;
        }
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 40;
        }
        .modal-backdrop.active {
            display: flex;
        }
        .modal-card {
            background: #fff;
            border-radius: 16px;
            padding: 24px;
            width: min(760px, 95vw);
            display: flex;
            flex-direction: column;
            gap: 16px;
            box-shadow: 0 20px 40px rgba(15, 23, 42, 0.3);
        }
        .modal-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px 20px;
        }
        .field--full {
            grid-column: 1 / -1;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-close {
            background: transparent;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #6b7280;
        }
        .alert {
            background: rgba(220, 38, 38, 0.08);
            border: 1px solid rgba(220, 38, 38, 0.4);
            color: #b91c1c;
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 0.9rem;
        }
        .item-section {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .item-section__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .item-section__title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #111827;
        }
        .item-table-wrapper {
            overflow-x: auto;
        }
        .item-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 720px;
        }
        .item-table th,
        .item-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .item-table th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #1f2937;
        }
        .item-table tbody tr:last-child td {
            border-bottom: none;
        }
        .item-actions-header {
            width: 1%;
            white-space: nowrap;
        }
        .table-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .table-field input,
        .table-field select {
            width: 100%;
        }
        .item-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            justify-content: flex-end;
        }
        .item-summary__field {
            display: flex;
            gap: 8px;
            align-items: baseline;
            font-weight: 600;
            color: #1f2937;
        }
        .item-summary__value {
            font-variant-numeric: tabular-nums;
        }
        .item-remove-button {
            background: transparent;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        }
        .item-remove-button:hover {
            background: #fef2f2;
            border-color: #fca5a5;
            color: #b91c1c;
        }
    </style>
</head>
<body>
    <div class="page">
        <header class="topbar">
            <div class="brand">
                <div class="brand__logo">S</div>
                <div class="brand__details">
                    <p class="brand__name">SAMPROX ERP</p>
                    <p class="brand__section">Material Control</p>
                </div>
            </div>
            <div class="topbar__actions">
                <a class="button button--ghost" href="{{ url_for('ui.mind_page') }}">Mind</a>
                <div class="user-summary">
                    <span class="user-summary__name" id="user-name"></span>
                    <span class="user-summary__role" id="user-role"></span>
                </div>
                <button type="button" class="button button--secondary" id="logout">Sign out</button>
            </div>
        </header>
        <nav class="subnav" aria-label="7M navigation">
            <a class="subnav__link" href="{{ url_for('ui.mind_page') }}">Mind</a>
            <a class="subnav__link" href="{{ url_for('ui.man_page') }}">Man</a>
            <a class="subnav__link" href="{{ url_for('ui.machines_page') }}">Machine</a>
            <a class="subnav__link subnav__link--active" href="{{ url_for('ui.material_page') }}">Material</a>
            <a class="subnav__link" href="{{ url_for('ui.market_page') }}">Market</a>
            <a class="subnav__link" href="{{ url_for('ui.manufacturing_page') }}">Manufacturing</a>
            <a class="subnav__link" href="{{ url_for('ui.movers_page') }}">Movers</a>
            <a class="subnav__link" href="{{ url_for('ui.money_page') }}">Money</a>
            <a class="subnav__link" href="{{ url_for('ui.miscellaneous_page') }}">Miscellaneous</a>
            <a
                class="subnav__link"
                href="{{ url_for('ui.mechanism_page') }}"
                id="mechanism-link"
                hidden
            >Mechanism</a>
        </nav>
        <section class="section">
            <header class="section__header">
                <h1>{{ 'Edit Material Receipt Note (MRN)' if is_edit_mode else 'Material Receipt Note (MRN)' }}</h1>
                <p class="section__description">
                    {{ 'Review and update an existing material receipt before saving the latest values.' if is_edit_mode else 'Capture an incoming load and automatically compute approved rates.' }}
                </p>
            </header>
            <div class="content-card">
                <form
                    id="mrn-form"
                    novalidate
                    data-mode="{{ 'edit' if is_edit_mode else 'create' }}"
                    {% if mrn is defined and mrn %}data-mrn-id="{{ mrn.id }}"{% endif %}
                >
                    <div id="form-alert" class="alert" style="display: none;"></div>
                    <div class="form-grid">
                        <div class="field">
                            <label for="mrn-date">Date<span class="text-red"> *</span></label>
                            <input id="mrn-date" name="date" type="date" required />
                            <p class="error-text" data-error-for="date"></p>
                        </div>
                        <div class="field">
                            <label for="mrn-no">MRN No<span class="text-red"> *</span></label>
                            <input id="mrn-no" name="mrn_no" type="text" placeholder="Enter MRN reference" required />
                            <p class="error-text" data-error-for="mrn_no"></p>
                        </div>
                        <div class="field supplier-dropdown">
                            <label for="supplier-search">Supplier<span class="text-red"> *</span></label>
                            <input id="supplier-search" type="text" placeholder="Search suppliers" autocomplete="off" />
                            <input id="supplier-id" type="hidden" name="supplier_id" />
                            <div id="supplier-menu" class="supplier-menu"></div>
                            <p class="helper">Start typing to search existing suppliers or create a new one.</p>
                            <p class="error-text" data-error-for="supplier_id"></p>
                        </div>
                        <div class="field">
                            <label for="sourcing-type">Sourcing Type<span class="text-red"> *</span></label>
                            <select id="sourcing-type" name="sourcing_type" required>
                                <option value="" disabled selected hidden>Select sourcing type</option>
                                <option value="Ownsourcing">Ownsourcing</option>
                                <option value="Outside">Outside</option>
                            </select>
                            <p class="error-text" data-error-for="sourcing_type"></p>
                        </div>
                        <div class="field">
                            <label for="driver-name">Driver Name<span class="text-red"> *</span></label>
                            <select id="driver-name" name="driver_id">
                                <option value="" disabled selected hidden>Select driver</option>
                            </select>
                            <p class="error-text" data-error-for="driver_id"></p>
                        </div>
                        <div class="field">
                            <label for="helper1-name">Helper 1 Name<span class="text-red"> *</span></label>
                            <select id="helper1-name" name="helper1_id">
                                <option value="" disabled selected hidden>Select Helper 1</option>
                            </select>
                            <p class="error-text" data-error-for="helper1_id"></p>
                        </div>
                        <div class="field">
                            <label for="helper2-name">Helper 2 Name</label>
                            <select id="helper2-name" name="helper2_id">
                                <option value="" disabled selected hidden>Select Helper 2</option>
                            </select>
                            <p class="error-text" data-error-for="helper2_id"></p>
                        </div>
                        <div class="field">
                            <label for="vehicle-no">Vehicle No<span class="text-red"> *</span></label>
                            <select id="vehicle-no" name="vehicle_no" required>
                                <option value="" disabled selected hidden>Select vehicle number</option>
                            </select>
                            <p class="error-text" data-error-for="vehicle_no"></p>
                        </div>
                        <div class="field">
                            <label for="weighing-slip">Weighing Slip No<span class="text-red"> *</span></label>
                            <input id="weighing-slip" name="weighing_slip_no" type="text" placeholder="Enter slip number" required />
                            <p class="error-text" data-error-for="weighing_slip_no"></p>
                        </div>
                        <div class="field">
                            <label for="weigh-in">Weigh Bridge In-time<span class="text-red"> *</span></label>
                            <input id="weigh-in" name="weigh_in_time" type="datetime-local" required />
                            <p class="error-text" data-error-for="weigh_in_time"></p>
                        </div>
                        <div class="field">
                            <label for="weigh-out">Weigh Bridge Out-time<span class="text-red"> *</span></label>
                            <input id="weigh-out" name="weigh_out_time" type="datetime-local" required />
                            <p class="error-text" data-error-for="weigh_out_time"></p>
                        </div>
                        <div class="field">
                            <label for="security-officer">Security Officer Name<span class="text-red"> *</span></label>
                            <select id="security-officer" name="security_officer_name" required>
                                <option value="" disabled selected hidden>Select security officer</option>
                                <option value="Premasiri">Premasiri</option>
                                <option value="Ananda">Ananda</option>
                                <option value="Liyanage">Liyanage</option>
                                <option value="Unknown">Unknown</option>
                            </select>
                            <p class="error-text" data-error-for="security_officer_name"></p>
                        </div>
                        <div class="field">
                            <label for="authorized-person">Authorized Person Name<span class="text-red"> *</span></label>
                            <input id="authorized-person" name="authorized_person_name" type="text" required />
                            <p class="error-text" data-error-for="authorized_person_name"></p>
                        </div>
                    </div>
                    <div class="item-section">
                        <div class="item-section__header">
                            <h2 class="item-section__title">Item details</h2>
                            <button type="button" class="button-secondary" id="add-item-row">Add item</button>
                        </div>
                        <div class="item-table-wrapper">
                            <table class="item-table" id="item-lines">
                                <thead>
                                    <tr>
                                        <th scope="col">Item</th>
                                        <th scope="col">First Weight (Kg)</th>
                                        <th scope="col">Second Weight (Kg)</th>
                                        <th scope="col">Qty (Ton)</th>
                                        <th scope="col">Unit Price</th>
                                        <th scope="col">Wet Factor</th>
                                        <th scope="col">Approved Unit Price</th>
                                        <th scope="col">Amount</th>
                                        <th scope="col" class="item-actions-header">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="item-table-body"></tbody>
                            </table>
                        </div>
                        <div class="item-summary">
                            <div class="item-summary__field">
                                <span>Total Qty (Ton):</span>
                                <span class="item-summary__value" id="total-qty-value">0.000</span>
                            </div>
                            <div class="item-summary__field">
                                <span>Total Amount:</span>
                                <span class="item-summary__value" id="total-amount-value">0.00</span>
                            </div>
                        </div>
                        <p class="error-text" data-error-for="items"></p>
                        <p class="error-text" data-error-for="qty_ton"></p>
                    </div>
                    <div class="actions">
                        <button type="button" class="button-secondary" id="reset-form">Reset</button>
                        <button type="submit" class="button-primary" id="submit-btn">{{ 'Update MRN' if is_edit_mode else 'Save MRN' }}</button>
                    </div>
                </form>
            </div>
        </section>
    </div>

    <div id="supplier-modal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="supplier-modal-title">
        <div class="modal-card">
            <div class="modal-header">
                <h2 id="supplier-modal-title">Create new supplier</h2>
                <button type="button" class="modal-close" id="close-supplier-modal" aria-label="Close">×</button>
            </div>
            <form id="supplier-form" novalidate>
                <div class="modal-form-grid">
                    <div class="field field--full">
                        <label for="supplier-name">Supplier Name<span class="text-red"> *</span></label>
                        <input id="supplier-name" name="name" type="text" required />
                        <p class="error-text" data-error-for="modal_name"></p>
                    </div>
                    <div class="field">
                        <label for="supplier-registration">Supplier Registration No</label>
                        <input id="supplier-registration" type="text" name="supplier_reg_no" readonly />
                    </div>
                    <div class="field">
                        <label for="supplier-id-no">Supplier ID No<span class="text-red"> *</span></label>
                        <input id="supplier-id-no" name="supplier_id_no" type="text" required />
                        <p class="error-text" data-error-for="modal_supplier_id_no"></p>
                    </div>
                    <div class="field">
                        <label for="supplier-category">Category<span class="text-red"> *</span></label>
                        <select id="supplier-category" name="category" required>
                            <option value="" hidden>Select category</option>
                            <option value="Raw Material">Raw Material</option>
                            <option value="Packing Material">Packing Material</option>
                            <option value="Repair Material">Repair Material</option>
                            <option value="Maintenance Material">Maintenance Material</option>
                        </select>
                        <p class="error-text" data-error-for="modal_category"></p>
                    </div>
                    <div class="field">
                        <label for="supplier-primary-phone">Primary Phone<span class="text-red"> *</span></label>
                        <input id="supplier-primary-phone" name="primary_phone" type="text" required />
                        <p class="error-text" data-error-for="modal_primary_phone"></p>
                    </div>
                    <div class="field">
                        <label for="supplier-secondary-phone">Secondary Phone</label>
                        <input id="supplier-secondary-phone" name="secondary_phone" type="text" />
                    </div>
                    <div class="field">
                        <label for="supplier-vehicle-1">Vehicle No 1</label>
                        <input id="supplier-vehicle-1" name="vehicle_no_1" type="text" />
                        <p class="helper" id="vehicle-no-1-helper" hidden>Required for Raw Material suppliers.</p>
                        <p class="error-text" data-error-for="modal_vehicle_no_1"></p>
                    </div>
                    <div class="field">
                        <label for="supplier-vehicle-2">Vehicle No 2</label>
                        <input id="supplier-vehicle-2" name="vehicle_no_2" type="text" />
                    </div>
                    <div class="field">
                        <label for="supplier-vehicle-3">Vehicle No 3</label>
                        <input id="supplier-vehicle-3" name="vehicle_no_3" type="text" />
                    </div>
                    <div class="field">
                        <label for="supplier-credit-period">Credit Period<span class="text-red"> *</span></label>
                        <select id="supplier-credit-period" name="credit_period" required>
                            <option value="" hidden>Select credit period</option>
                            <option value="Cash">Cash</option>
                            <option value="3 Days">3 Days</option>
                            <option value="7 Days">7 Days</option>
                            <option value="1 Month">1 Month</option>
                        </select>
                        <p class="error-text" data-error-for="modal_credit_period"></p>
                    </div>
                    <div class="field">
                        <label for="supplier-email">Email</label>
                        <input id="supplier-email" name="email" type="email" />
                    </div>
                    <div class="field field--full">
                        <label for="supplier-address">Address</label>
                        <textarea id="supplier-address" name="address" rows="2"></textarea>
                    </div>
                    <div class="field">
                        <label for="supplier-tax">Tax ID</label>
                        <input id="supplier-tax" name="tax_id" type="text" />
                    </div>
                </div>
                <div id="supplier-modal-alert" class="alert" style="display: none;"></div>
                <div class="actions">
                    <button type="button" class="button-secondary" id="cancel-supplier">Cancel</button>
                    <button type="submit" class="button-primary" id="save-supplier" disabled>Save Supplier</button>
                </div>
            </form>
        </div>
    </div>

    <div id="item-modal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="item-modal-title">
        <div class="modal-card">
            <div class="modal-header">
                <h2 id="item-modal-title">Create new item</h2>
                <button type="button" class="modal-close" id="close-item-modal" aria-label="Close">×</button>
            </div>
            <form id="item-form" novalidate>
                <div class="field">
                    <label for="item-name">Item Name<span class="text-red"> *</span></label>
                    <input id="item-name" name="name" type="text" required />
                    <p class="error-text" data-error-for="modal_item_name"></p>
                </div>
                <div id="item-modal-alert" class="alert" style="display: none;"></div>
                <div class="actions">
                    <button type="button" class="button-secondary" id="cancel-item">Cancel</button>
                    <button type="submit" class="button-primary" id="save-item">Save Item</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const token = localStorage.getItem("samprox_token");
        const userRaw = localStorage.getItem("samprox_user");
        let user;

        try {
            user = userRaw ? JSON.parse(userRaw) : null;
        } catch (_) {
            user = null;
        }

        if (!token || !user) {
            window.location.href = "/";
        }

        if (user?.role === "outside_manager" && window.location.pathname !== "/responsibility_portal") {
            window.location.replace("/responsibility_portal");
        }

        if (user?.role === "maintenance_manager" && window.location.pathname !== "/machines") {
            window.location.replace("/machines");
        }
        if ((user?.role === "sales_manager" || user?.role === "sales_executive") && window.location.pathname !== "/sales/dashboard") {
            window.location.replace("/sales/dashboard");
        }

        const roleLabels = {
            admin: "Admin",
            production_manager: "Production Manager",
            maintenance_manager: "Maintenance Manager",
            finance_manager: "Finance Manager",
            technician: "Technician",
            outside_manager: "Member Of Rainbow Group",
            sales_manager: "Sales Manager",
            sales_executive: "Sales Executive",
        };

        const userNameEl = document.getElementById("user-name");
        const userRoleEl = document.getElementById("user-role");
        const logoutButton = document.getElementById("logout");
        const mechanismLink = document.getElementById("mechanism-link");

        userNameEl.textContent = user?.name || "Unknown";
        userRoleEl.textContent = roleLabels[user?.role] || "";
        if (mechanismLink) {
            if (user?.role === "admin") {
                mechanismLink.hidden = false;
            } else {
                mechanismLink.remove();
            }
        }

        logoutButton.addEventListener("click", async () => {
            try {
                await fetch("/api/auth/logout", { method: "POST", credentials: "include" });
            } catch (error) {
                console.error("Failed to log out", error);
            } finally {
                localStorage.removeItem("samprox_token");
                localStorage.removeItem("samprox_user");
                window.location.href = "/";
            }
        });

        function handleUnauthorized() {
            fetch("/api/auth/logout", { method: "POST", credentials: "include" }).catch((error) => {
                console.error("Failed to log out", error);
            });
            localStorage.removeItem("samprox_token");
            localStorage.removeItem("samprox_user");
            window.location.href = "/";
        }

        const mrnDateInput = document.getElementById("mrn-date");
        const mrnNoInput = document.getElementById("mrn-no");
        const supplierInput = document.getElementById("supplier-search");
        const supplierIdInput = document.getElementById("supplier-id");
        const supplierMenu = document.getElementById("supplier-menu");
        const sourcingTypeSelect = document.getElementById("sourcing-type");
        const vehicleNoSelect = document.getElementById("vehicle-no");
        const driverSelect = document.getElementById("driver-name");
        const helper1Select = document.getElementById("helper1-name");
        const helper2Select = document.getElementById("helper2-name");
        const mrnForm = document.getElementById("mrn-form");
        const submitBtn = document.getElementById("submit-btn");
        const formAlert = document.getElementById("form-alert");
        const resetBtn = document.getElementById("reset-form");
        const itemTableBody = document.getElementById("item-table-body");
        const addItemButton = document.getElementById("add-item-row");
        const totalAmountValueEl = document.getElementById("total-amount-value");
        const totalQtyValueEl = document.getElementById("total-qty-value");
        const weighingSlipInput = document.getElementById("weighing-slip");
        const weighInInput = document.getElementById("weigh-in");
        const weighOutInput = document.getElementById("weigh-out");
        const securityOfficerSelect = document.getElementById("security-officer");
        const authorizedPersonInput = document.getElementById("authorized-person");
        const availableItems = {{ items | tojson }};
        const isEditMode = {{ (is_edit_mode | default(false)) | tojson }};
        const initialMrn = {{ (mrn | default(None)) | tojson }};
        const editingMrnId = isEditMode && initialMrn && initialMrn.id ? initialMrn.id : null;
        const INTERNAL_VEHICLES = ["LI-1795", "LB-3237"];
        const VALID_SOURCING_TYPES = new Set(["Ownsourcing", "Outside"]);
        const supplierCache = new Map();
        let activeItemSelect = null;
        let employeeOptions = [];
        const staffFieldConfigs = [
            { select: driverSelect, placeholder: "Select driver", field: "driver_id", required: true },
            { select: helper1Select, placeholder: "Select Helper 1", field: "helper1_id", required: true },
            { select: helper2Select, placeholder: "Select Helper 2", field: "helper2_id", required: false },
        ];

        function normalizeEmployee(member) {
            if (!member || typeof member !== "object") {
                return null;
            }

            const rawId =
                member.id ?? member.teamMemberId ?? member.team_member_id ?? member.memberId ?? member.employee_id;
            const parsedId = Number.parseInt(rawId, 10);
            if (!Number.isFinite(parsedId)) {
                return null;
            }

            const regNumber = String(member.regNumber ?? member.reg_number ?? "").trim();
            const name = String(member.name ?? member.full_name ?? member.fullName ?? "").trim();
            let statusRaw = member.status;
            if (statusRaw && typeof statusRaw === "object" && "value" in statusRaw) {
                statusRaw = statusRaw.value;
            }
            const statusText = String(statusRaw ?? "").trim().toLowerCase();
            const label = regNumber && name ? `${regNumber} – ${name}` : name || regNumber || String(parsedId);

            return {
                id: String(parsedId),
                regNumber,
                name,
                status: statusText,
                label,
            };
        }

        function refreshEmployeeSelectors({ preserveSelection = true } = {}) {
            const hasEmployees = Array.isArray(employeeOptions) && employeeOptions.length > 0;
            staffFieldConfigs.forEach(({ select, placeholder }) => {
                if (!select) {
                    return;
                }

                const previousValue = preserveSelection ? select.value : "";
                select.innerHTML = "";

                const placeholderOption = document.createElement("option");
                placeholderOption.value = "";
                placeholderOption.disabled = true;
                placeholderOption.hidden = true;
                placeholderOption.textContent = hasEmployees ? placeholder : "No active employees available";
                if (!previousValue) {
                    placeholderOption.selected = true;
                }
                select.appendChild(placeholderOption);

                if (hasEmployees) {
                    employeeOptions.forEach((employee) => {
                        const option = document.createElement("option");
                        option.value = employee.id;
                        option.textContent = employee.label;
                        select.appendChild(option);
                    });
                }

                const initialValue = select.dataset.initialValue || "";
                if (previousValue && select.querySelector(`option[value="${previousValue}"]`)) {
                    select.value = previousValue;
                } else if (initialValue && select.querySelector(`option[value="${initialValue}"]`)) {
                    select.value = initialValue;
                } else {
                    select.value = "";
                    if (!preserveSelection) {
                        select.dataset.initialValue = "";
                    }
                }

                if (select.value) {
                    select.dataset.initialValue = select.value;
                }
            });
        }

        function updateStaffFieldState() {
            const sourcingType = sourcingTypeSelect?.value || "";
            const isOwnsourcing = sourcingType === "Ownsourcing";

            staffFieldConfigs.forEach(({ select, required }) => {
                if (!select) {
                    return;
                }
                if (isOwnsourcing) {
                    select.disabled = false;
                    if (required) {
                        select.required = true;
                    } else {
                        select.required = false;
                    }
                    select.removeAttribute("aria-disabled");
                } else {
                    select.disabled = true;
                    select.required = false;
                    select.value = "";
                    select.setAttribute("aria-disabled", "true");
                }
            });
        }

        async function loadEmployeeOptions() {
            try {
                const response = await fetch("/api/team/members", {
                    headers: {
                        Authorization: `Bearer ${token}`,
                        Accept: "application/json",
                    },
                });

                if (response.status === 401) {
                    handleUnauthorized();
                    return;
                }

                if (!response.ok) {
                    throw new Error(`Unable to load employees: ${response.status}`);
                }

                const data = await response.json().catch(() => []);
                const normalized = Array.isArray(data)
                    ? data
                          .map((member) => normalizeEmployee(member))
                          .filter((member) => member && (!member.status || member.status === "active"))
                          .sort((a, b) => a.label.localeCompare(b.label, undefined, { sensitivity: "base" }))
                    : [];
                employeeOptions = normalized;
            } catch (error) {
                console.error("Failed to load employees", error);
                employeeOptions = [];
            }

            refreshEmployeeSelectors();
            updateStaffFieldState();
        }

        async function populateMrnNumber(force = false) {
            if (!mrnNoInput) {
                return;
            }
            if (mrnNoInput.value && !force) {
                return;
            }
            try {
                const response = await fetch("/api/material/mrn/next-number");
                if (!response.ok) {
                    throw new Error(`Request failed with status ${response.status}`);
                }
                const data = await response.json();
                if (data?.mrn_no && (force || !mrnNoInput.value)) {
                    mrnNoInput.value = data.mrn_no;
                }
            } catch (error) {
                console.error("Failed to fetch next MRN number", error);
            }
        }

        if (!isEditMode) {
            populateMrnNumber();
        }
        refreshVehicleOptions({ preserveSelection: false });
        refreshEmployeeSelectors({ preserveSelection: false });
        updateStaffFieldState();
        loadEmployeeOptions();

        const supplierModal = document.getElementById("supplier-modal");
        const supplierModalAlert = document.getElementById("supplier-modal-alert");
        const supplierModalClose = document.getElementById("close-supplier-modal");
        const supplierModalCancel = document.getElementById("cancel-supplier");
        const supplierModalForm = document.getElementById("supplier-form");
        const supplierModalSaveButton = document.getElementById("save-supplier");
        const supplierRegistrationInput = document.getElementById("supplier-registration");
        const supplierFieldElements = {
            name: document.getElementById("supplier-name"),
            supplier_id_no: document.getElementById("supplier-id-no"),
            category: document.getElementById("supplier-category"),
            primary_phone: document.getElementById("supplier-primary-phone"),
            secondary_phone: document.getElementById("supplier-secondary-phone"),
            vehicle_no_1: document.getElementById("supplier-vehicle-1"),
            vehicle_no_2: document.getElementById("supplier-vehicle-2"),
            vehicle_no_3: document.getElementById("supplier-vehicle-3"),
            credit_period: document.getElementById("supplier-credit-period"),
            email: document.getElementById("supplier-email"),
            address: document.getElementById("supplier-address"),
            tax_id: document.getElementById("supplier-tax"),
        };
        const vehicleRequirementHelper = document.getElementById("vehicle-no-1-helper");
        const supplierTouchedFields = new Set();
        let supplierServerErrors = {};
        const supplierCategories = new Set([
            "Raw Material",
            "Packing Material",
            "Repair Material",
            "Maintenance Material",
        ]);
        const supplierCreditPeriods = new Set(["Cash", "3 Days", "7 Days", "1 Month"]);

        const itemModal = document.getElementById("item-modal");
        const itemModalAlert = document.getElementById("item-modal-alert");
        const itemModalClose = document.getElementById("close-item-modal");
        const itemModalCancel = document.getElementById("cancel-item");
        const itemModalForm = document.getElementById("item-form");

        function clearErrors() {
            formAlert.style.display = "none";
            formAlert.textContent = "";
            document.querySelectorAll("[data-error-for]").forEach((node) => {
                node.textContent = "";
            });
            clearAllItemRowErrors();
        }

        function setError(field, message) {
            if (field && field.startsWith("items.")) {
                const parts = field.split(".");
                const rowIndex = Number.parseInt(parts[1], 10);
                const rowField = parts.slice(2).join(".");
                if (Number.isInteger(rowIndex) && rowField) {
                    const row = itemTableBody?.querySelector(`.item-row[data-index="${rowIndex}"]`);
                    if (row) {
                        setItemRowError(row, rowField, message);
                        return;
                    }
                }
            }
            const target = document.querySelector(`[data-error-for="${field}"]`);
            if (target) {
                target.textContent = message;
            } else {
                formAlert.style.display = "block";
                formAlert.textContent = message;
            }
        }

        function setModalError(message) {
            if (!message) {
                supplierModalAlert.style.display = "none";
                supplierModalAlert.textContent = "";
                return;
            }
            supplierModalAlert.style.display = "block";
            supplierModalAlert.textContent = message;
        }

        function clearSupplierErrors() {
            supplierModalForm.querySelectorAll(".error-text").forEach((node) => {
                if (node.dataset.errorFor && node.dataset.errorFor.startsWith("modal_")) {
                    node.textContent = "";
                }
            });
        }

        function getSupplierFormValues() {
            return {
                name: (supplierFieldElements.name?.value || "").trim(),
                supplier_id_no: (supplierFieldElements.supplier_id_no?.value || "").trim(),
                category: supplierFieldElements.category?.value || "",
                primary_phone: (supplierFieldElements.primary_phone?.value || "").trim(),
                secondary_phone: (supplierFieldElements.secondary_phone?.value || "").trim(),
                vehicle_no_1: (supplierFieldElements.vehicle_no_1?.value || "").trim(),
                vehicle_no_2: (supplierFieldElements.vehicle_no_2?.value || "").trim(),
                vehicle_no_3: (supplierFieldElements.vehicle_no_3?.value || "").trim(),
                credit_period: supplierFieldElements.credit_period?.value || "",
                email: (supplierFieldElements.email?.value || "").trim(),
                address: (supplierFieldElements.address?.value || "").trim(),
                tax_id: (supplierFieldElements.tax_id?.value || "").trim(),
            };
        }

        function validateSupplierFormValues(values) {
            const errors = {};
            if (!values.name) {
                errors.name = "Supplier name is required.";
            }
            if (!values.primary_phone) {
                errors.primary_phone = "Primary phone is required.";
            }
            if (!values.category) {
                errors.category = "Category is required.";
            } else if (!supplierCategories.has(values.category)) {
                errors.category = "Select a valid category.";
            }
            if (!values.supplier_id_no) {
                errors.supplier_id_no = "Supplier ID number is required.";
            }
            if (!values.credit_period) {
                errors.credit_period = "Credit period is required.";
            } else if (!supplierCreditPeriods.has(values.credit_period)) {
                errors.credit_period = "Select a valid credit period.";
            }
            if (values.category === "Raw Material" && !values.vehicle_no_1) {
                errors.vehicle_no_1 = "Vehicle number is required for Raw Material suppliers.";
            }
            return errors;
        }

        function updateSupplierFieldErrors(errors, { force = false } = {}) {
            const mapping = {
                name: "modal_name",
                primary_phone: "modal_primary_phone",
                category: "modal_category",
                supplier_id_no: "modal_supplier_id_no",
                credit_period: "modal_credit_period",
                vehicle_no_1: "modal_vehicle_no_1",
            };

            Object.entries(mapping).forEach(([field, key]) => {
                const node = supplierModalForm.querySelector(`[data-error-for='${key}']`);
                if (!node) {
                    return;
                }
                const message = errors[field];
                if (message && (force || supplierTouchedFields.has(field))) {
                    node.textContent = message;
                } else if (!message) {
                    node.textContent = "";
                } else if (!force) {
                    node.textContent = "";
                }
            });
        }

        function updateSupplierSaveButton(errors) {
            if (!supplierModalSaveButton) {
                return;
            }
            supplierModalSaveButton.disabled = Object.keys(errors).length > 0;
        }

        function updateVehicleRequirement(categoryValue) {
            const isRaw = categoryValue === "Raw Material";
            const vehicleField = supplierFieldElements.vehicle_no_1;
            if (vehicleField) {
                if (isRaw) {
                    vehicleField.setAttribute("required", "required");
                } else {
                    vehicleField.removeAttribute("required");
                }
            }
            if (vehicleRequirementHelper) {
                if (isRaw) {
                    vehicleRequirementHelper.removeAttribute("hidden");
                } else {
                    vehicleRequirementHelper.setAttribute("hidden", "");
                }
            }
        }

        function evaluateSupplierForm({ force = false } = {}) {
            const values = getSupplierFormValues();
            const clientErrors = validateSupplierFormValues(values);
            const combinedErrors = { ...clientErrors, ...supplierServerErrors };
            updateSupplierFieldErrors(combinedErrors, { force });
            updateSupplierSaveButton(combinedErrors);
            return { values, errors: combinedErrors, clientErrors };
        }

        async function prepareSupplierRegistrationNumber() {
            if (!supplierRegistrationInput) {
                return;
            }
            supplierRegistrationInput.value = "Loading…";
            supplierRegistrationInput.placeholder = "Will be generated on save";
            try {
                const response = await fetch("/api/material/suppliers/next-registration-number");
                if (!response.ok) {
                    throw new Error("Failed to load registration number");
                }
                const data = await response.json();
                supplierRegistrationInput.value = data?.registration_no || "";
            } catch (error) {
                supplierRegistrationInput.value = "";
            }
        }

        function setItemModalError(message) {
            if (!message) {
                itemModalAlert.style.display = "none";
                itemModalAlert.textContent = "";
                return;
            }
            itemModalAlert.style.display = "block";
            itemModalAlert.textContent = message;
        }

        function toFixed(value, precision) {
            const factor = Math.pow(10, precision);
            return (Math.round(value * factor) / factor).toFixed(precision);
        }

        function clearItemRowErrors(row) {
            if (!row) {
                return;
            }
            row.querySelectorAll("[data-row-error]").forEach((node) => {
                node.textContent = "";
            });
        }

        function clearAllItemRowErrors() {
            if (!itemTableBody) {
                return;
            }
            itemTableBody.querySelectorAll(".item-row").forEach((row) => clearItemRowErrors(row));
        }

        function setItemRowError(row, field, message) {
            if (!row) {
                return;
            }
            const target = row.querySelector(`[data-row-error="${field}"]`);
            if (target) {
                target.textContent = message;
            }
        }

        function syncRowIndexes() {
            if (!itemTableBody) {
                return;
            }
            Array.from(itemTableBody.querySelectorAll(".item-row")).forEach((row, index) => {
                row.dataset.index = String(index);
            });
        }

        function buildItemSelectOptions(selectedValue = "") {
            const options = [
                `<option value="" ${selectedValue ? "" : "selected"} disabled hidden>Select item</option>`,
                '<option value="__create__">➕ Create new item…</option>',
            ];
            (availableItems || []).forEach((item) => {
                if (!item) {
                    return;
                }
                const selected = item.id === selectedValue ? " selected" : "";
                options.push(`<option value="${item.id}"${selected}>${item.name}</option>`);
            });
            return options.join("");
        }

        function computeRowValues(row) {
            if (!row) {
                return;
            }
            const firstInput = row.querySelector(".first-weight-input");
            const secondInput = row.querySelector(".second-weight-input");
            const qtyInputEl = row.querySelector(".qty-input");
            const unitInput = row.querySelector(".unit-price-input");
            const wetInput = row.querySelector(".wet-factor-input");
            const approvedInput = row.querySelector(".approved-price-input");
            const amountInputEl = row.querySelector(".amount-input");

            const first = parseFloat(firstInput?.value);
            const second = parseFloat(secondInput?.value);
            const unit = parseFloat(unitInput?.value);
            const wet = parseFloat(wetInput?.value);

            let qtyText = "";
            if (Number.isFinite(first) && Number.isFinite(second) && first > second) {
                qtyText = toFixed((first - second) / 1000, 3);
            }
            if (qtyInputEl) {
                qtyInputEl.value = qtyText;
            }

            let approvedText = "0.00";
            if (Number.isFinite(unit) && Number.isFinite(wet)) {
                approvedText = toFixed(unit * wet, 2);
            }
            if (approvedInput) {
                approvedInput.value = approvedText;
            }

            let amountText = "0.00";
            if (qtyText) {
                amountText = toFixed(parseFloat(qtyText) * parseFloat(approvedText), 2);
            }
            if (amountInputEl) {
                amountInputEl.value = amountText;
            }
        }

        function updateTotals() {
            if (!itemTableBody) {
                if (totalAmountValueEl) {
                    totalAmountValueEl.textContent = "0.00";
                }
                if (totalQtyValueEl) {
                    totalQtyValueEl.textContent = "0.000";
                }
                return;
            }
            let totalAmount = 0;
            let totalQty = 0;
            itemTableBody.querySelectorAll(".item-row").forEach((row) => {
                const qty = parseFloat(row.querySelector(".qty-input")?.value);
                const amount = parseFloat(row.querySelector(".amount-input")?.value);
                if (Number.isFinite(qty)) {
                    totalQty += qty;
                }
                if (Number.isFinite(amount)) {
                    totalAmount += amount;
                }
            });
            if (totalQtyValueEl) {
                totalQtyValueEl.textContent = toFixed(totalQty, 3);
            }
            if (totalAmountValueEl) {
                totalAmountValueEl.textContent = toFixed(totalAmount, 2);
            }
        }

        function attachRowEvents(row) {
            if (!row) {
                return;
            }
            const select = row.querySelector(".item-select");
            const firstInput = row.querySelector(".first-weight-input");
            const secondInput = row.querySelector(".second-weight-input");
            const unitInput = row.querySelector(".unit-price-input");
            const wetInput = row.querySelector(".wet-factor-input");
            const removeButton = row.querySelector(".item-remove-button");

            if (select) {
                select.addEventListener("change", (event) => {
                    const value = event.target.value;
                    if (value === "__create__") {
                        activeItemSelect = event.target;
                        event.target.value = event.target.dataset.previousValue || "";
                        openItemModal();
                        return;
                    }
                    event.target.dataset.previousValue = value;
                    setItemRowError(row, "item_id", "");
                });
            }

            [firstInput, secondInput, unitInput, wetInput].forEach((input) => {
                if (!input) {
                    return;
                }
                input.addEventListener("input", () => {
                    computeRowValues(row);
                    updateTotals();
                });
            });

            if (removeButton) {
                removeButton.addEventListener("click", () => removeItemRow(row));
            }
        }

        function createItemRow(initial = {}) {
            const row = document.createElement("tr");
            row.className = "item-row";
            row.innerHTML = `
                <td>
                    <div class="table-field">
                        <select class="item-select"></select>
                        <p class="error-text" data-row-error="item_id"></p>
                    </div>
                </td>
                <td>
                    <div class="table-field">
                        <input type="number" class="first-weight-input" min="0" step="0.001" placeholder="0.000" />
                        <p class="error-text" data-row-error="first_weight_kg"></p>
                    </div>
                </td>
                <td>
                    <div class="table-field">
                        <input type="number" class="second-weight-input" min="0" step="0.001" placeholder="0.000" />
                        <p class="error-text" data-row-error="second_weight_kg"></p>
                    </div>
                </td>
                <td>
                    <div class="table-field">
                        <input type="text" class="qty-input" placeholder="0.000" readonly />
                        <p class="error-text" data-row-error="qty_ton"></p>
                    </div>
                </td>
                <td>
                    <div class="table-field">
                        <input type="number" class="unit-price-input" min="0" step="0.01" placeholder="0.00" />
                        <p class="error-text" data-row-error="unit_price"></p>
                    </div>
                </td>
                <td>
                    <div class="table-field">
                        <input type="number" class="wet-factor-input" min="0" step="0.001" />
                        <p class="error-text" data-row-error="wet_factor"></p>
                    </div>
                </td>
                <td>
                    <div class="table-field">
                        <input type="text" class="approved-price-input" value="0.00" readonly />
                    </div>
                </td>
                <td>
                    <div class="table-field">
                        <input type="text" class="amount-input" value="0.00" readonly />
                    </div>
                </td>
                <td>
                    <button type="button" class="item-remove-button">Remove</button>
                </td>
            `;

            const select = row.querySelector(".item-select");
            if (select) {
                select.innerHTML = buildItemSelectOptions(initial.item_id || "");
                if (initial.item_id) {
                    select.value = initial.item_id;
                }
                select.dataset.previousValue = initial.item_id || "";
            }

            const firstInput = row.querySelector(".first-weight-input");
            const secondInput = row.querySelector(".second-weight-input");
            const unitInput = row.querySelector(".unit-price-input");
            const wetInput = row.querySelector(".wet-factor-input");
            const approvedInput = row.querySelector(".approved-price-input");
            const amountInput = row.querySelector(".amount-input");

            if (firstInput && initial.first_weight_kg !== undefined) {
                firstInput.value = initial.first_weight_kg;
            }
            if (secondInput && initial.second_weight_kg !== undefined) {
                secondInput.value = initial.second_weight_kg;
            }
            if (unitInput && initial.unit_price !== undefined) {
                unitInput.value = initial.unit_price;
            }
            if (wetInput) {
                wetInput.value = initial.wet_factor !== undefined ? initial.wet_factor : "1.000";
            }
            if (approvedInput && initial.approved_unit_price !== undefined) {
                approvedInput.value = initial.approved_unit_price;
            }
            if (amountInput && initial.amount !== undefined) {
                amountInput.value = initial.amount;
            }

            attachRowEvents(row);
            computeRowValues(row);
            return row;
        }

        function removeItemRow(row) {
            if (!row || !itemTableBody) {
                return;
            }
            const rows = itemTableBody.querySelectorAll(".item-row");
            if (rows.length <= 1) {
                clearItemRowErrors(row);
                const select = row.querySelector(".item-select");
                if (select) {
                    select.value = "";
                    select.dataset.previousValue = "";
                }
                row.querySelectorAll("input").forEach((input) => {
                    if (input.classList.contains("wet-factor-input")) {
                        input.value = "1.000";
                    } else if (input.classList.contains("approved-price-input") || input.classList.contains("amount-input")) {
                        input.value = "0.00";
                    } else if (input.classList.contains("qty-input")) {
                        input.value = "";
                    } else {
                        input.value = "";
                    }
                });
                computeRowValues(row);
                updateTotals();
                return;
            }
            row.remove();
            syncRowIndexes();
            updateTotals();
        }

        function addItemRow(initial = {}) {
            if (!itemTableBody) {
                return null;
            }
            const row = createItemRow(initial);
            itemTableBody.appendChild(row);
            syncRowIndexes();
            updateTotals();
            return row;
        }

        function applyInitialMrnState() {
            if (!isEditMode || !initialMrn) {
                return;
            }

            if (mrnForm) {
                mrnForm.dataset.mode = "edit";
                if (editingMrnId) {
                    mrnForm.dataset.mrnId = editingMrnId;
                }
            }

            if (submitBtn) {
                submitBtn.textContent = "Update MRN";
            }

            if (mrnDateInput) {
                const dateValue = formatDateForInput(initialMrn.date);
                mrnDateInput.value = dateValue || "";
            }

            if (mrnNoInput) {
                mrnNoInput.value = initialMrn.mrn_no || "";
            }

            if (weighingSlipInput) {
                weighingSlipInput.value = initialMrn.weighing_slip_no || "";
            }

            if (weighInInput) {
                const value = formatDateTimeLocal(initialMrn.weigh_in_time);
                weighInInput.value = value || "";
            }

            if (weighOutInput) {
                const value = formatDateTimeLocal(initialMrn.weigh_out_time);
                weighOutInput.value = value || "";
            }

            if (securityOfficerSelect) {
                securityOfficerSelect.value = initialMrn.security_officer_name || "";
            }

            if (authorizedPersonInput) {
                authorizedPersonInput.value = initialMrn.authorized_person_name || "";
            }

            if (sourcingTypeSelect && initialMrn.sourcing_type) {
                sourcingTypeSelect.value = initialMrn.sourcing_type;
            }

            const supplierRecord = initialMrn.supplier && typeof initialMrn.supplier === "object"
                ? initialMrn.supplier
                : null;

            if (supplierRecord) {
                rememberSupplier(supplierRecord);
                const supplierName =
                    supplierRecord.name ||
                    supplierRecord.supplier_name ||
                    supplierRecord.supplier_reg_no ||
                    "";
                supplierInput.value = typeof supplierName === "string" ? supplierName.trim() : "";
                const supplierIdValue = supplierRecord.id || initialMrn.supplier_id || "";
                supplierIdInput.value = supplierIdValue ? String(supplierIdValue) : "";
            } else if (initialMrn.supplier_id) {
                supplierIdInput.value = String(initialMrn.supplier_id);
                supplierInput.value = supplierInput.value || "";
            } else {
                supplierIdInput.value = "";
                supplierInput.value = "";
            }

            if (supplierMenu) {
                supplierMenu.innerHTML = "";
                supplierMenu.style.display = "none";
            }

            if (vehicleNoSelect) {
                vehicleNoSelect.dataset.initialValue = initialMrn.vehicle_no || "";
            }

            if (driverSelect) {
                driverSelect.dataset.initialValue =
                    initialMrn.driver_id != null ? String(initialMrn.driver_id) : "";
            }
            if (helper1Select) {
                helper1Select.dataset.initialValue =
                    initialMrn.helper1_id != null ? String(initialMrn.helper1_id) : "";
            }
            if (helper2Select) {
                helper2Select.dataset.initialValue =
                    initialMrn.helper2_id != null ? String(initialMrn.helper2_id) : "";
            }

            if (Array.isArray(initialMrn.items) && initialMrn.items.length > 0 && itemTableBody) {
                itemTableBody.innerHTML = "";
                initialMrn.items.forEach((line) => {
                    if (!line) {
                        return;
                    }
                    const itemId = line.item_id || (line.item && line.item.id) || "";
                    addItemRow({
                        item_id: itemId,
                        first_weight_kg: line.first_weight_kg,
                        second_weight_kg: line.second_weight_kg,
                        unit_price: line.unit_price,
                        wet_factor: line.wet_factor,
                        approved_unit_price: line.approved_unit_price,
                        amount: line.amount,
                    });
                });
            }

            updateTotals();
        }

        function collectItemRows() {
            if (!itemTableBody) {
                return [];
            }
            return Array.from(itemTableBody.querySelectorAll(".item-row")).map((row) => ({
                element: row,
                item_id: row.querySelector(".item-select")?.value || "",
                first_weight_kg: row.querySelector(".first-weight-input")?.value || "",
                second_weight_kg: row.querySelector(".second-weight-input")?.value || "",
                unit_price: row.querySelector(".unit-price-input")?.value || "",
                wet_factor: row.querySelector(".wet-factor-input")?.value || "",
                qty_ton: row.querySelector(".qty-input")?.value || "",
            }));
        }

        function resetItemRows() {
            if (!itemTableBody) {
                return;
            }
            itemTableBody.innerHTML = "";
            addItemRow();
            updateTotals();
        }

        if (addItemButton) {
            addItemButton.addEventListener("click", () => addItemRow());
        }

        addItemRow();
        updateTotals();
        applyInitialMrnState();

        function coerceNumericValue(rawValue, { defaultValue } = {}) {
            if (rawValue === undefined || rawValue === null) {
                return defaultValue ?? "";
            }

            const stringValue = typeof rawValue === "string" ? rawValue.trim() : String(rawValue).trim();
            if (stringValue === "") {
                return defaultValue ?? "";
            }

            const attempts = [stringValue];

            if (stringValue.includes(",") && stringValue.includes(".") && stringValue.indexOf(",") > stringValue.indexOf(".")) {
                attempts.push(stringValue.replace(/\./g, "").replace(",", "."));
            }

            if (stringValue.includes(",") && !stringValue.includes(".")) {
                attempts.push(stringValue.replace(",", "."));
            }

            if (stringValue.includes(",")) {
                attempts.push(stringValue.replace(/,/g, ""));
            }

            attempts.push(stringValue.replace(/\s+/g, ""));

            for (const attempt of attempts) {
                const numeric = Number(attempt);
                if (Number.isFinite(numeric)) {
                    return numeric;
                }
            }

            return stringValue;
        }

        function formatDateForInput(value) {
            if (!value) {
                return "";
            }

            if (typeof value === "string") {
                const trimmed = value.trim();
                if (/^\d{4}-\d{2}-\d{2}$/.test(trimmed)) {
                    return trimmed;
                }
            }

            const parsed = Date.parse(value);
            if (Number.isNaN(parsed)) {
                return "";
            }

            const date = new Date(parsed);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, "0");
            const day = String(date.getDate()).padStart(2, "0");
            return `${year}-${month}-${day}`;
        }

        function formatDateTimeLocal(value) {
            if (!value) {
                return "";
            }

            if (typeof value === "string") {
                const trimmed = value.trim();
                if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(trimmed)) {
                    return trimmed;
                }
            }

            const parsed = Date.parse(value);
            if (Number.isNaN(parsed)) {
                return "";
            }

            const date = new Date(parsed);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, "0");
            const day = String(date.getDate()).padStart(2, "0");
            const hours = String(date.getHours()).padStart(2, "0");
            const minutes = String(date.getMinutes()).padStart(2, "0");
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        function normalizeDateValue(rawValue) {
            if (rawValue === undefined || rawValue === null) {
                return "";
            }

            const stringValue = typeof rawValue === "string" ? rawValue.trim() : String(rawValue).trim();
            if (stringValue === "") {
                return "";
            }

            const parsed = Date.parse(stringValue);
            if (Number.isNaN(parsed)) {
                return stringValue;
            }

            return new Date(parsed).toISOString();
        }

        function normalizeVehicleValue(value) {
            if (typeof value !== "string") {
                return "";
            }
            return value.trim().toLowerCase();
        }

        function extractVehicleNumbers(record) {
            if (!record || typeof record !== "object") {
                return [];
            }
            const keys = ["vehicleNo1", "vehicleNo2", "vehicleNo3", "vehicle_no_1", "vehicle_no_2", "vehicle_no_3"];
            const seen = new Set();
            const vehicles = [];
            keys.forEach((key) => {
                const raw = record[key];
                if (typeof raw !== "string") {
                    return;
                }
                const trimmed = raw.trim();
                if (!trimmed) {
                    return;
                }
                const normalized = normalizeVehicleValue(trimmed);
                if (normalized && !seen.has(normalized)) {
                    seen.add(normalized);
                    vehicles.push(trimmed);
                }
            });
            return vehicles;
        }

        function rememberSupplier(record) {
            if (!record || !record.id) {
                return;
            }
            const cached = { ...record };
            cached.__vehicleNumbers = extractVehicleNumbers(record);
            supplierCache.set(record.id, cached);
        }

        function getSupplierFromCache(id) {
            if (!id) {
                return null;
            }
            return supplierCache.get(id) || null;
        }

        function getSupplierVehicles(supplierId) {
            const record = getSupplierFromCache(supplierId);
            if (!record) {
                return [];
            }
            if (Array.isArray(record.__vehicleNumbers)) {
                return record.__vehicleNumbers.slice();
            }
            const vehicles = extractVehicleNumbers(record);
            record.__vehicleNumbers = vehicles;
            supplierCache.set(supplierId, record);
            return vehicles.slice();
        }

        function getAllowedVehicles(sourcingType, supplierId) {
            if (sourcingType === "Ownsourcing") {
                return [...INTERNAL_VEHICLES];
            }
            if (sourcingType === "Outside") {
                return getSupplierVehicles(supplierId);
            }
            return [];
        }

        function refreshVehicleOptions({ preserveSelection = true } = {}) {
            if (!vehicleNoSelect) {
                return;
            }

            const sourcingType = sourcingTypeSelect?.value || "";
            const supplierIdValue = supplierIdInput.value || "";
            const previousValue = preserveSelection ? vehicleNoSelect.value : "";
            const initialTarget = vehicleNoSelect.dataset.initialValue || "";
            const targetValue = previousValue || initialTarget;

            let allowedVehicles = [];
            let disabled = false;
            let placeholderText = "Select vehicle number";

            if (!sourcingType) {
                disabled = true;
                placeholderText = "Select sourcing type first";
            } else if (sourcingType === "Ownsourcing") {
                allowedVehicles = getAllowedVehicles(sourcingType, supplierIdValue);
            } else if (sourcingType === "Outside") {
                if (!supplierIdValue) {
                    disabled = true;
                    placeholderText = "Select supplier to view vehicles";
                } else {
                    allowedVehicles = getAllowedVehicles(sourcingType, supplierIdValue);
                    if (allowedVehicles.length === 0) {
                        disabled = true;
                        placeholderText = "No vehicles registered for supplier";
                    }
                }
            }

            vehicleNoSelect.innerHTML = "";

            const placeholderOption = document.createElement("option");
            placeholderOption.value = "";
            placeholderOption.textContent = placeholderText;
            placeholderOption.disabled = true;
            placeholderOption.selected = true;
            placeholderOption.hidden = false;
            vehicleNoSelect.appendChild(placeholderOption);

            allowedVehicles.forEach((vehicle) => {
                const option = document.createElement("option");
                option.value = vehicle;
                option.textContent = vehicle;
                vehicleNoSelect.appendChild(option);
            });

            if (disabled) {
                vehicleNoSelect.disabled = true;
                vehicleNoSelect.value = "";
                return;
            }

            vehicleNoSelect.disabled = false;
            const normalizedTarget = normalizeVehicleValue(targetValue);
            const match = allowedVehicles.find((value) => normalizeVehicleValue(value) === normalizedTarget);
            if (match) {
                vehicleNoSelect.value = match;
                vehicleNoSelect.dataset.initialValue = match;
            } else {
                vehicleNoSelect.value = "";
                if (!preserveSelection) {
                    vehicleNoSelect.dataset.initialValue = "";
                }
            }
        }

        function toggleSupplierMenu(show) {
            if (show) {
                supplierMenu.classList.add("active");
            } else {
                supplierMenu.classList.remove("active");
            }
        }

        async function loadSuppliers(query = "") {
            const url = new URL("/api/material/suppliers", window.location.origin);
            if (query) {
                url.searchParams.set("search", query);
            }
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error("Failed to load suppliers");
            }
            return await response.json();
        }

        async function fetchSuppliers(query = "") {
            try {
                const suppliers = await loadSuppliers(query);
                renderSupplierMenu(suppliers);
            } catch (error) {
                renderSupplierMenu([]);
                formAlert.style.display = "block";
                formAlert.textContent = "Unable to load suppliers. Please try again.";
            }
        }

        function renderSupplierMenu(suppliers) {
            supplierMenu.innerHTML = "";
            const createBtn = document.createElement("button");
            createBtn.type = "button";
            createBtn.className = "supplier-option";
            createBtn.textContent = "➕ Create new supplier…";
            createBtn.addEventListener("click", () => {
                toggleSupplierMenu(false);
                openSupplierModal();
            });
            supplierMenu.appendChild(createBtn);

            if (suppliers.length === 0) {
                const empty = document.createElement("div");
                empty.className = "supplier-option";
                empty.textContent = "No suppliers found";
                empty.setAttribute("aria-disabled", "true");
                empty.style.cursor = "default";
                supplierMenu.appendChild(empty);
                return;
            }

            suppliers.forEach((supplier) => {
                rememberSupplier(supplier);
                const option = document.createElement("button");
                option.type = "button";
                option.className = "supplier-option";
                option.textContent = supplier.name;
                option.dataset.id = supplier.id;
                option.addEventListener("click", () => {
                    supplierInput.value = supplier.name;
                    supplierIdInput.value = supplier.id;
                    toggleSupplierMenu(false);
                    refreshVehicleOptions({ preserveSelection: sourcingTypeSelect?.value === "Ownsourcing" });
                });
                supplierMenu.appendChild(option);
            });
        }

        supplierInput.addEventListener("focus", () => {
            fetchSuppliers("");
            toggleSupplierMenu(true);
        });

        supplierInput.addEventListener("input", (event) => {
            const value = event.target.value;
            supplierIdInput.value = "";
            fetchSuppliers(value);
            if (sourcingTypeSelect?.value === "Ownsourcing") {
                refreshVehicleOptions();
            } else {
                refreshVehicleOptions({ preserveSelection: false });
            }
        });

        document.addEventListener("click", (event) => {
            if (!supplierMenu.contains(event.target) && event.target !== supplierInput) {
                toggleSupplierMenu(false);
            }
        });

        if (sourcingTypeSelect) {
            sourcingTypeSelect.addEventListener("change", () => {
                const preserve = sourcingTypeSelect.value === "Ownsourcing";
                refreshVehicleOptions({ preserveSelection: preserve });
                updateStaffFieldState();
            });
        }


        function openSupplierModal() {
            supplierModal.classList.add("active");
            setModalError("");
            supplierTouchedFields.clear();
            supplierServerErrors = {};
            supplierModalForm.reset();
            clearSupplierErrors();
            if (supplierFieldElements.category) {
                supplierFieldElements.category.value = "";
            }
            if (supplierFieldElements.credit_period) {
                supplierFieldElements.credit_period.value = "";
            }
            updateVehicleRequirement("");
            if (supplierRegistrationInput) {
                supplierRegistrationInput.value = "";
            }
            evaluateSupplierForm();
            prepareSupplierRegistrationNumber();
            supplierFieldElements.name?.focus();
        }

        function closeSupplierModal() {
            supplierModal.classList.remove("active");
        }

        supplierModalClose.addEventListener("click", closeSupplierModal);
        supplierModalCancel.addEventListener("click", closeSupplierModal);

        supplierModal.addEventListener("click", (event) => {
            if (event.target === supplierModal) {
                closeSupplierModal();
            }
        });

        Object.entries(supplierFieldElements).forEach(([field, element]) => {
            if (!element) {
                return;
            }
            const handler = () => {
                supplierTouchedFields.add(field);
                if (field in supplierServerErrors) {
                    delete supplierServerErrors[field];
                }
                if (field === "category") {
                    updateVehicleRequirement(element.value);
                }
                evaluateSupplierForm();
            };
            const eventName = element.tagName === "SELECT" ? "change" : "input";
            element.addEventListener(eventName, handler);
            element.addEventListener("blur", handler);
        });

        supplierModalForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            setModalError("");
            supplierServerErrors = {};
            supplierTouchedFields.add("name");
            supplierTouchedFields.add("supplier_id_no");
            supplierTouchedFields.add("category");
            supplierTouchedFields.add("primary_phone");
            supplierTouchedFields.add("credit_period");
            supplierTouchedFields.add("vehicle_no_1");

            const { values, clientErrors } = evaluateSupplierForm({ force: true });
            if (Object.keys(clientErrors).length > 0) {
                return;
            }

            supplierModalSaveButton.disabled = true;
            try {
                const payload = {
                    name: values.name,
                    supplier_id_no: values.supplier_id_no,
                    category: values.category,
                    primary_phone: values.primary_phone,
                    credit_period: values.credit_period,
                };

                if (values.secondary_phone) {
                    payload.secondary_phone = values.secondary_phone;
                }
                if (values.vehicle_no_1) {
                    payload.vehicle_no_1 = values.vehicle_no_1;
                }
                if (values.vehicle_no_2) {
                    payload.vehicle_no_2 = values.vehicle_no_2;
                }
                if (values.vehicle_no_3) {
                    payload.vehicle_no_3 = values.vehicle_no_3;
                }
                if (values.email) {
                    payload.email = values.email;
                }
                if (values.address) {
                    payload.address = values.address;
                }
                if (values.tax_id) {
                    payload.tax_id = values.tax_id;
                }

                const response = await fetch("/api/material/suppliers", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                });
                const responseText = await response.text();
                let data = null;
                if (responseText) {
                    try {
                        data = JSON.parse(responseText);
                    } catch (parseError) {
                        console.error("Failed to parse supplier response", parseError, responseText);
                    }
                }
                if (!response.ok) {
                    const fieldErrors = data?.errors || {};
                    supplierServerErrors = { ...fieldErrors };
                    Object.keys(fieldErrors).forEach((field) => {
                        supplierTouchedFields.add(field);
                    });
                    evaluateSupplierForm({ force: true });
                    const nonFieldMessage = Object.keys(fieldErrors).length === 0 ? "Unable to save supplier." : "";
                    if (nonFieldMessage) {
                        setModalError(nonFieldMessage);
                    } else if (fieldErrors.supplier_reg_no) {
                        setModalError(fieldErrors.supplier_reg_no);
                    }
                    return;
                }
                let supplierRecord =
                    data && typeof data === "object" && !Array.isArray(data) ? data : null;
                if (!supplierRecord) {
                    try {
                        const nameToFind = (values.name || "").trim().toLowerCase();
                        if (nameToFind) {
                            const matches = await loadSuppliers(values.name || "");
                            supplierRecord = matches.find((supplier) => {
                                const supplierName = (supplier.name || "").trim().toLowerCase();
                                return supplierName === nameToFind;
                            }) || null;
                        }
                    } catch (loadError) {
                        console.error("Supplier created but lookup failed", loadError);
                    }
                }
                if (!supplierRecord) {
                    setModalError(
                        "Supplier was saved but we couldn't load it. Please refresh the page to continue.",
                    );
                    return;
                }
                rememberSupplier(supplierRecord);
                supplierInput.value = supplierRecord.name || values.name;
                supplierIdInput.value = supplierRecord.id || "";
                refreshVehicleOptions({ preserveSelection: sourcingTypeSelect?.value === "Ownsourcing" });
                fetchSuppliers(supplierRecord.name || "");
                closeSupplierModal();
            } catch (error) {
                setModalError("Network error. Please try again.");
            } finally {
                evaluateSupplierForm();
            }
        });

        function openItemModal() {
            itemModal.classList.add("active");
            setItemModalError("");
            itemModalForm.reset();
            document.querySelector("[data-error-for='modal_item_name']").textContent = "";
            itemModal.querySelector("#item-name").focus();
        }

        function closeItemModal() {
            itemModal.classList.remove("active");
            activeItemSelect = null;
        }

        itemModalClose.addEventListener("click", closeItemModal);
        itemModalCancel.addEventListener("click", closeItemModal);

        itemModal.addEventListener("click", (event) => {
            if (event.target === itemModal) {
                closeItemModal();
            }
        });

        itemModalForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            setItemModalError("");
            document.querySelector("[data-error-for='modal_item_name']").textContent = "";

            const formData = new FormData(itemModalForm);
            const payload = Object.fromEntries(formData.entries());
            payload.name = (payload.name || "").trim();
            if (!payload.name) {
                document.querySelector("[data-error-for='modal_item_name']").textContent = "Item name is required.";
                return;
            }

            const saveButton = itemModalForm.querySelector("#save-item");
            saveButton.disabled = true;
            try {
                const response = await fetch("/api/material/items", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                });
                const data = await response.json();
                if (!response.ok) {
                    const message = data?.errors?.name || "Unable to save item.";
                    setItemModalError(message);
                    return;
                }

                if (data && data.id && data.name) {
                    availableItems.push({ id: data.id, name: data.name });
                    const selects = itemTableBody?.querySelectorAll(".item-select") || [];
                    selects.forEach((select) => {
                        const currentValue = select === activeItemSelect ? data.id : select.value;
                        select.innerHTML = buildItemSelectOptions(currentValue);
                        select.value = currentValue || "";
                        select.dataset.previousValue = select.value || "";
                    });
                    if (activeItemSelect) {
                        activeItemSelect.value = data.id;
                        activeItemSelect.dataset.previousValue = data.id;
                        const row = activeItemSelect.closest(".item-row");
                        setItemRowError(row, "item_id", "");
                        computeRowValues(row);
                        updateTotals();
                    }
                }
                closeItemModal();
            } catch (error) {
                setItemModalError("Network error. Please try again.");
            } finally {
                saveButton.disabled = false;
            }
        });

        resetBtn.addEventListener("click", () => {
            clearErrors();
            if (isEditMode) {
                applyInitialMrnState();
                refreshVehicleOptions({ preserveSelection: false });
                refreshEmployeeSelectors({ preserveSelection: false });
                updateStaffFieldState();
                updateTotals();
                return;
            }

            mrnForm.reset();
            if (mrnNoInput) {
                mrnNoInput.value = "";
            }
            supplierInput.value = "";
            supplierIdInput.value = "";
            if (sourcingTypeSelect) {
                sourcingTypeSelect.value = "";
            }
            if (vehicleNoSelect) {
                vehicleNoSelect.value = "";
                vehicleNoSelect.dataset.initialValue = "";
            }
            resetItemRows();
            populateMrnNumber(true);
            refreshVehicleOptions({ preserveSelection: false });
            refreshEmployeeSelectors({ preserveSelection: false });
            updateStaffFieldState();
        });

        function validateForm() {
            const errors = {};
            const sanitizedItems = [];
            const rows = collectItemRows();
            if (rows.length === 0) {
                errors["items"] = "Add at least one item.";
            }

            const sourcingTypeValue = sourcingTypeSelect?.value || "";
            const supplierIdValue = supplierIdInput.value || "";
            const vehicleSelection = vehicleNoSelect?.value || "";
            const allowedVehicles = getAllowedVehicles(sourcingTypeValue, supplierIdValue);

            if (!sourcingTypeValue || !VALID_SOURCING_TYPES.has(sourcingTypeValue)) {
                errors["sourcing_type"] = "Select a sourcing type.";
            }

            if (!vehicleSelection) {
                if (sourcingTypeValue === "Outside") {
                    if (!supplierIdValue) {
                        errors["vehicle_no"] = "Select a supplier before choosing a vehicle.";
                    } else if (allowedVehicles.length === 0) {
                        errors["vehicle_no"] = "The selected supplier has no registered vehicles.";
                    } else {
                        errors["vehicle_no"] = "Select a vehicle registered to the supplier.";
                    }
                } else if (sourcingTypeValue === "Ownsourcing") {
                    errors["vehicle_no"] = "Select an internal vehicle.";
                } else {
                    errors["vehicle_no"] = "Select a vehicle number.";
                }
            } else if (sourcingTypeValue === "Ownsourcing") {
                const match = INTERNAL_VEHICLES.find(
                    (value) => normalizeVehicleValue(value) === normalizeVehicleValue(vehicleSelection),
                );
                if (!match) {
                    errors["vehicle_no"] = "Select a valid internal vehicle.";
                }
            } else if (sourcingTypeValue === "Outside") {
                if (!supplierIdValue) {
                    errors["vehicle_no"] = "Select a supplier before choosing a vehicle.";
                } else if (allowedVehicles.length === 0) {
                    errors["vehicle_no"] = "The selected supplier has no registered vehicles.";
                } else if (
                    !allowedVehicles.some(
                        (value) => normalizeVehicleValue(value) === normalizeVehicleValue(vehicleSelection),
                    )
                ) {
                    errors["vehicle_no"] = "Select a vehicle registered to the supplier.";
                }
            }

            const driverValue = driverSelect?.value || "";
            const helper1Value = helper1Select?.value || "";
            const helper2Value = helper2Select?.value || "";
            const hasEmployees = Array.isArray(employeeOptions) && employeeOptions.length > 0;

            if (sourcingTypeValue === "Ownsourcing") {
                if (!hasEmployees) {
                    errors["driver_id"] = "No active employees available.";
                    errors["helper1_id"] = "No active employees available.";
                } else {
                    if (!driverValue) {
                        errors["driver_id"] = "Select a driver.";
                    }
                    if (!helper1Value) {
                        errors["helper1_id"] = "Select Helper 1.";
                    }
                    if (
                        helper2Value &&
                        !employeeOptions.some((employee) => String(employee.id) === String(helper2Value))
                    ) {
                        errors["helper2_id"] = "Select Helper 2.";
                    }
                }
            }

            let totalQty = 0;

            rows.forEach((rowData, index) => {
                const prefix = `items.${index}.`;
                const itemId = (rowData.item_id || "").trim();
                let hasError = false;

                if (!itemId) {
                    errors[`${prefix}item_id`] = "Select an item.";
                    hasError = true;
                }

                const first = Number.parseFloat(rowData.first_weight_kg);
                const second = Number.parseFloat(rowData.second_weight_kg);
                const unit = Number.parseFloat(rowData.unit_price);
                const wet = Number.parseFloat(rowData.wet_factor);

                if (!Number.isFinite(first) || first < 0) {
                    errors[`${prefix}first_weight_kg`] = "Enter a valid non-negative weight.";
                    hasError = true;
                }
                if (!Number.isFinite(second) || second < 0) {
                    errors[`${prefix}second_weight_kg`] = "Enter a valid non-negative weight.";
                    hasError = true;
                }
                if (!Number.isFinite(unit) || unit < 0) {
                    errors[`${prefix}unit_price`] = "Unit price must be zero or greater.";
                    hasError = true;
                }
                if (!Number.isFinite(wet) || wet < 0) {
                    errors[`${prefix}wet_factor`] = "Wet factor must be zero or greater.";
                    hasError = true;
                }
                if (Number.isFinite(first) && Number.isFinite(second) && first <= second) {
                    errors[`${prefix}second_weight_kg`] = "Second weight must be less than first weight.";
                    hasError = true;
                }

                let qty = NaN;
                if (!hasError && Number.isFinite(first) && Number.isFinite(second)) {
                    qty = (first - second) / 1000;
                    if (!(qty > 0)) {
                        errors[`${prefix}qty_ton`] = "Quantity must be greater than 0.";
                        hasError = true;
                    }
                }

                if (!hasError) {
                    sanitizedItems.push({
                        item_id: itemId,
                        first_weight_kg: first,
                        second_weight_kg: second,
                        unit_price: unit,
                        wet_factor: wet,
                    });
                    totalQty += qty;
                }
            });

            const formData = new FormData(mrnForm);
            [
                "date",
                "mrn_no",
                "weighing_slip_no",
                "weigh_in_time",
                "weigh_out_time",
                "security_officer_name",
                "authorized_person_name",
            ].forEach((field) => {
                if (!(formData.get(field) || "").trim()) {
                    errors[field] = "This field is required.";
                }
            });

            if (!supplierIdInput.value) {
                errors["supplier_id"] = "Select a supplier.";
            }

            const weighIn = formData.get("weigh_in_time");
            const weighOut = formData.get("weigh_out_time");
            if (weighIn && weighOut) {
                const inDate = new Date(weighIn);
                const outDate = new Date(weighOut);
                if (inDate > outDate) {
                    errors["weigh_out_time"] = "Out-time must be after in-time.";
                }
            }

            if (sanitizedItems.length === 0 && !errors.items) {
                errors["items"] = "Add at least one valid item.";
            }

            if (sanitizedItems.length > 0 && !(totalQty > 0)) {
                errors["qty_ton"] = "Quantity must be greater than 0.";
            }

            return { errors, sanitizedItems };
        }

        mrnForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            clearErrors();
            submitBtn.disabled = true;

            const { errors, sanitizedItems } = validateForm();
            if (Object.keys(errors).length > 0) {
                Object.entries(errors).forEach(([field, message]) => setError(field, message));
                submitBtn.disabled = false;
                return;
            }

            const formData = new FormData(mrnForm);
            const payload = Object.fromEntries(formData.entries());
            payload.weigh_in_time = normalizeDateValue(payload.weigh_in_time);
            payload.weigh_out_time = normalizeDateValue(payload.weigh_out_time);
            payload.supplier_id = supplierIdInput.value || undefined;
            payload.sourcing_type = sourcingTypeSelect?.value || undefined;
            payload.vehicle_no = vehicleNoSelect?.value || undefined;
            payload.driver_id = driverSelect?.value || undefined;
            payload.helper1_id = helper1Select?.value || undefined;
            payload.helper2_id = helper2Select?.value || undefined;
            payload.items = sanitizedItems.map((item) => ({
                item_id: item.item_id,
                first_weight_kg: coerceNumericValue(item.first_weight_kg),
                second_weight_kg: coerceNumericValue(item.second_weight_kg),
                unit_price: coerceNumericValue(item.unit_price),
                wet_factor: coerceNumericValue(item.wet_factor, { defaultValue: 1 }),
            }));

            Object.keys(payload).forEach((key) => {
                if (payload[key] === undefined || payload[key] === "") {
                    delete payload[key];
                }
            });

            try {
                const endpoint = isEditMode && editingMrnId ? `/api/material/mrn/${editingMrnId}` : "/api/material/mrn";
                const method = isEditMode && editingMrnId ? "PUT" : "POST";
                const response = await fetch(endpoint, {
                    method,
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                });
                const data = await response.json();
                if (!response.ok) {
                    const serverErrors = data?.errors || {};
                    Object.entries(serverErrors).forEach(([field, message]) => setError(field, message));
                    if (Object.keys(serverErrors).length === 0) {
                        formAlert.style.display = "block";
                        formAlert.textContent = "Unable to save MRN. Please review your inputs.";
                    }
                    return;
                }
                window.location.href = `/material/mrn/${data.id}`;
            } catch (error) {
                formAlert.style.display = "block";
                formAlert.textContent = "Network error. Please try again.";
            } finally {
                submitBtn.disabled = false;
            }
        });

    </script>
</body>
</html>
