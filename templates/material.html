<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Material | SAMPROX ERP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" />
</head>
<body>
    <div class="page">
        <header class="topbar">
            <div class="brand">
                <div class="brand__logo">S</div>
                <div class="brand__details">
                    <p class="brand__name">SAMPROX ERP</p>
                    <p class="brand__section">Material Control</p>
                </div>
            </div>
            <div class="topbar__actions">
                <a class="button button--ghost" href="{{ url_for('ui.mind_page') }}">Mind</a>
                <div class="user-summary">
                    <span class="user-summary__name" id="user-name"></span>
                    <span class="user-summary__role" id="user-role"></span>
                </div>
                <button type="button" class="button button--secondary" id="logout">Sign out</button>
            </div>
        </header>
        <nav class="subnav" aria-label="7M navigation">
            <a class="subnav__link" href="{{ url_for('ui.mind_page') }}">Mind</a>
            <a class="subnav__link" href="{{ url_for('ui.man_page') }}">Man</a>
            <a class="subnav__link" href="{{ url_for('ui.machines_page') }}">Machine</a>
            <a class="subnav__link subnav__link--active" href="{{ url_for('ui.material_page') }}">Material</a>
            <a class="subnav__link" href="{{ url_for('ui.market_page') }}">Market</a>
            <a class="subnav__link" href="{{ url_for('ui.manufacturing_page') }}">Manufacturing</a>
            <a class="subnav__link" href="{{ url_for('ui.money_page') }}">Money</a>
        </nav>
        <section class="section">
            <header class="section__header">
                <h1>Inventory & supply visibility</h1>
            </header>
            <p class="section__description">
                Keep production running by tracking raw materials, spare parts, and consumables. Review
                what is on hand, what is reserved for jobs, and what needs to be ordered next.
            </p>
            <div class="section__grid">
                <article class="tile">
                    <h2 class="tile__title">Stock snapshot</h2>
                    <p class="tile__description">
                        Monitor inventory aging and reorder thresholds to prevent stock-outs.
                    </p>
                </article>
                <article class="tile">
                    <h2 class="tile__title">Supplier performance</h2>
                    <p class="tile__description">
                        Review supplier lead times and delivery quality to guide purchasing decisions.
                    </p>
                </article>
                <article class="tile">
                    <h2 class="tile__title">Consumption trends</h2>
                    <p class="tile__description">
                        Analyze how materials are consumed across jobs to forecast future demand.
                    </p>
                </article>
                <article class="tile">
                    <h2 class="tile__title">Pending requisitions</h2>
                    <p class="tile__description">
                        Follow up on open purchase requests and approvals so critical parts arrive on
                        time.
                    </p>
                </article>
            </div>
            <div class="material-receipts-card stock-status-card">
                <div class="material-receipts-card__header stock-status-card__header">
                    <div>
                        <h2 class="material-receipts-card__title">Stock Status</h2>
                        <p class="material-receipts-card__meta">
                            Review closing balances for each material as at the selected date.
                        </p>
                    </div>
                    <div class="stock-status-card__controls">
                        <label class="stock-status-card__label" for="stock-status-date">
                            Closing stock as at
                        </label>
                        <input
                            class="stock-status-card__input"
                            type="date"
                            id="stock-status-date"
                            name="stock-status-date"
                        />
                    </div>
                </div>
                <p class="empty-state" id="stock-status-empty">Loading stock status…</p>
                <div class="table-wrapper" id="stock-status-table-wrapper" hidden>
                    <table class="data-table" id="stock-status-table">
                        <thead>
                            <tr>
                                <th scope="col">Item Name</th>
                                <th scope="col">Qty (Ton)</th>
                                <th scope="col">Value (Rs.)</th>
                            </tr>
                        </thead>
                        <tbody id="stock-status-table-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="material-receipts-card supplier-registry-card">
                <div class="material-receipts-card__header">
                    <div>
                        <h2 class="material-receipts-card__title">Supplier registry</h2>
                        <p class="material-receipts-card__meta">
                            Review registered suppliers and keep their contact details at your fingertips.
                        </p>
                    </div>
                    <a class="button" href="{{ url_for('ui.material_mrn_new_page') }}">Register supplier</a>
                </div>
                <form class="material-receipts-card__search" id="supplier-search-form">
                    <label class="sr-only" for="supplier-search-input">Search suppliers</label>
                    <input
                        id="supplier-search-input"
                        type="search"
                        name="q"
                        placeholder="Search by supplier name, registration, or contact"
                        autocomplete="off"
                    />
                    <div class="material-receipts-card__actions">
                        <button type="submit" class="button button--secondary">Search</button>
                        <button type="button" class="button button--ghost" id="supplier-clear-button">Clear</button>
                    </div>
                </form>
                <p class="empty-state" id="supplier-empty-state">Loading suppliers…</p>
                <div class="table-wrapper" id="supplier-table-wrapper" hidden>
                    <table class="data-table" id="supplier-table">
                        <thead>
                            <tr>
                                <th scope="col">Supplier</th>
                                <th scope="col">Registration no.</th>
                                <th scope="col">Category</th>
                                <th scope="col">Primary phone</th>
                                <th scope="col">Credit period</th>
                            </tr>
                        </thead>
                        <tbody id="supplier-table-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="material-receipts-card">
                <div class="material-receipts-card__header">
                    <div>
                        <h2 class="material-receipts-card__title">Material receipts</h2>
                        <p class="material-receipts-card__meta">
                            Review the latest material receipt notes recorded by your team.
                        </p>
                    </div>
                    <a class="button" href="{{ url_for('ui.material_mrn_new_page') }}">Record material receipt</a>
                </div>
                <form class="material-receipts-card__search" id="mrn-search-form">
                    <label class="sr-only" for="mrn-search-input">Search material receipts</label>
                    <input
                        id="mrn-search-input"
                        type="search"
                        name="q"
                        placeholder="Search by MRN number, supplier, or material"
                        autocomplete="off"
                    />
                    <div class="material-receipts-card__actions">
                        <button type="submit" class="button button--secondary">Search</button>
                        <button type="button" class="button button--ghost" id="mrn-clear-button">Clear</button>
                    </div>
                </form>
                <p class="empty-state" id="mrn-empty-state">Loading material receipts…</p>
                <div class="table-wrapper" id="mrn-table-wrapper" hidden>
                    <table class="data-table" id="mrn-table">
                        <thead>
                            <tr>
                                <th scope="col">MRN number</th>
                                <th scope="col">Date</th>
                                <th scope="col">Supplier</th>
                                <th scope="col">Material</th>
                                <th scope="col">Qty (Ton)</th>
                                <th scope="col">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="mrn-table-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="material-receipts-card" id="briquette-production-card">
                <div class="material-receipts-card__header">
                    <div>
                        <h2 class="material-receipts-card__title">Production Entry – Briquette Production</h2>
                        <p class="material-receipts-card__meta">
                            Monitor briquette output alongside the daily material mix and FIFO cost.
                        </p>
                    </div>
                </div>
                <p class="empty-state" id="briquette-production-empty">Loading briquette production…</p>
                <div class="table-wrapper" id="briquette-production-table-wrapper" hidden>
                    <table class="data-table" id="briquette-production-table">
                        <thead>
                            <tr>
                                <th scope="col" rowspan="2">Date</th>
                                <th scope="col" rowspan="2">Briquette Production (Ton)</th>
                                <th scope="col" colspan="5">Material Consumed (Ton)</th>
                                <th scope="col" rowspan="2">Unit Cost of Briquette (Kg)</th>
                                <th scope="col" rowspan="2">Total Material Cost</th>
                                <th scope="col" rowspan="2">Update Mix</th>
                            </tr>
                            <tr id="briquette-material-headings">
                                <th scope="col">Sawdust</th>
                                <th scope="col">Wood Shaving</th>
                                <th scope="col">Wood Powder</th>
                                <th scope="col">Peanut Husk</th>
                                <th scope="col">Fire Cut</th>
                            </tr>
                        </thead>
                        <tbody id="briquette-production-table-body"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>
    <div class="modal" id="briquette-mix-modal" hidden aria-hidden="true">
        <div class="modal__overlay" data-modal-dismiss></div>
        <div class="modal__content" role="dialog" aria-modal="true" aria-labelledby="briquette-mix-title">
            <header class="modal__header modal__header--with-actions">
                <div>
                    <h2 class="modal__title" id="briquette-mix-title">Update mix</h2>
                    <p class="modal__subtitle" id="briquette-mix-subtitle">
                        Adjust material usage and let the system recalculate FIFO costs automatically.
                    </p>
                </div>
                <button type="button" class="modal__close" id="briquette-mix-close" aria-label="Close mix editor">
                    &times;
                </button>
            </header>
            <div class="modal__body">
                <form class="modal__form" id="briquette-mix-form">
                    <div class="modal__grid">
                        <label class="modal__field">
                            <span class="modal__label">Date</span>
                            <input id="briquette-mix-date" type="text" class="modal__input" readonly />
                        </label>
                        <label class="modal__field">
                            <span class="modal__label">Dry factor</span>
                            <input
                                id="briquette-dry-factor"
                                name="dry_factor"
                                type="number"
                                step="0.0001"
                                min="0"
                                class="modal__input"
                                autocomplete="off"
                            />
                        </label>
                        <label class="modal__field">
                            <span class="modal__label">Sawdust (Ton)</span>
                            <input id="briquette-sawdust" type="number" class="modal__input" readonly />
                        </label>
                        <label class="modal__field">
                            <span class="modal__label">Wood Shaving (Ton)</span>
                            <input
                                id="briquette-wood-shaving"
                                name="wood_shaving_ton"
                                type="number"
                                step="0.001"
                                min="0"
                                class="modal__input"
                                autocomplete="off"
                            />
                        </label>
                        <label class="modal__field">
                            <span class="modal__label">Wood Powder (Ton)</span>
                            <input
                                id="briquette-wood-powder"
                                name="wood_powder_ton"
                                type="number"
                                step="0.001"
                                min="0"
                                class="modal__input"
                                autocomplete="off"
                            />
                        </label>
                        <label class="modal__field">
                            <span class="modal__label">Peanut Husk (Ton)</span>
                            <input
                                id="briquette-peanut-husk"
                                name="peanut_husk_ton"
                                type="number"
                                step="0.001"
                                min="0"
                                class="modal__input"
                                autocomplete="off"
                            />
                        </label>
                        <label class="modal__field">
                            <span class="modal__label">Fire Cut (Ton)</span>
                            <input
                                id="briquette-fire-cut"
                                name="fire_cut_ton"
                                type="number"
                                step="0.001"
                                min="0"
                                class="modal__input"
                                autocomplete="off"
                            />
                        </label>
                    </div>
                    <div class="modal__field modal__field--full">
                        <span class="modal__label">Total briquette output</span>
                        <p class="modal__hint"><span id="briquette-output-kg">0.00</span> kg</p>
                    </div>
                    <div class="table-wrapper">
                        <table class="data-table data-table--compact" id="briquette-cost-table">
                            <thead>
                                <tr>
                                    <th scope="col">Material</th>
                                    <th scope="col">Qty (Kg)</th>
                                    <th scope="col">Qty (Ton)</th>
                                    <th scope="col">Purchase Price (Rs/Kg)</th>
                                    <th scope="col">Total Cost (Rs)</th>
                                </tr>
                            </thead>
                            <tbody id="briquette-cost-table-body"></tbody>
                        </table>
                    </div>
                    <div class="modal__field modal__field--full">
                        <p class="modal__label">Total material cost</p>
                        <p class="modal__hint" id="briquette-total-cost">Rs 0.00</p>
                    </div>
                    <div class="modal__field modal__field--full">
                        <p class="modal__label">Unit cost of briquette (per Kg)</p>
                        <p class="modal__hint" id="briquette-unit-cost">Rs 0.0000</p>
                    </div>
                    <p class="modal__feedback" id="briquette-mix-feedback" hidden></p>
                    <p class="modal__feedback modal__feedback--error" id="briquette-mix-error" hidden></p>
                    <div class="modal__actions">
                        <button type="button" class="button button--ghost" id="briquette-mix-cancel">Cancel</button>
                        <button type="submit" class="button" id="briquette-mix-save">Save mix</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        const token = localStorage.getItem("samprox_token");
        const userRaw = localStorage.getItem("samprox_user");
        let user;

        try {
            user = userRaw ? JSON.parse(userRaw) : null;
        } catch (_) {
            user = null;
        }

        if (!token || !user) {
            window.location.href = "/";
        }

        if (user?.role === "maintenance_manager" && window.location.pathname !== "/machines") {
            window.location.replace("/machines");
        }

        const roleLabels = {
            admin: "Admin",
            production_manager: "Production Manager",
            maintenance_manager: "Maintenance Manager",
            finance_manager: "Finance Manager",
            technician: "Technician",
        };

        const userNameEl = document.getElementById("user-name");
        const userRoleEl = document.getElementById("user-role");
        const logoutButton = document.getElementById("logout");

        userNameEl.textContent = user?.name || "Unknown";
        userRoleEl.textContent = roleLabels[user?.role] || "";

        logoutButton.addEventListener("click", () => {
            localStorage.removeItem("samprox_token");
            localStorage.removeItem("samprox_user");
            window.location.href = "/";
        });

        const stockStatusTableBody = document.getElementById("stock-status-table-body");
        const stockStatusTableWrapper = document.getElementById("stock-status-table-wrapper");
        const stockStatusEmptyState = document.getElementById("stock-status-empty");
        const stockStatusDateInput = document.getElementById("stock-status-date");
        const supplierTableBody = document.getElementById("supplier-table-body");
        const supplierTableWrapper = document.getElementById("supplier-table-wrapper");
        const supplierEmptyState = document.getElementById("supplier-empty-state");
        const supplierSearchForm = document.getElementById("supplier-search-form");
        const supplierSearchInput = document.getElementById("supplier-search-input");
        const supplierClearButton = document.getElementById("supplier-clear-button");

        const mrnTableBody = document.getElementById("mrn-table-body");
        const mrnTableWrapper = document.getElementById("mrn-table-wrapper");
        const mrnEmptyState = document.getElementById("mrn-empty-state");
        const mrnSearchForm = document.getElementById("mrn-search-form");
        const mrnSearchInput = document.getElementById("mrn-search-input");
        const mrnClearButton = document.getElementById("mrn-clear-button");
        const briquetteTableBody = document.getElementById("briquette-production-table-body");
        const briquetteTableWrapper = document.getElementById("briquette-production-table-wrapper");
        const briquetteEmptyState = document.getElementById("briquette-production-empty");
        const briquetteMaterialHeadings = document.getElementById("briquette-material-headings");
        const briquetteModal = document.getElementById("briquette-mix-modal");
        const briquetteModalForm = document.getElementById("briquette-mix-form");
        const briquetteModalDate = document.getElementById("briquette-mix-date");
        const briquetteDryFactorInput = document.getElementById("briquette-dry-factor");
        const briquetteSawdustInput = document.getElementById("briquette-sawdust");
        const briquetteWoodShavingInput = document.getElementById("briquette-wood-shaving");
        const briquetteWoodPowderInput = document.getElementById("briquette-wood-powder");
        const briquettePeanutHuskInput = document.getElementById("briquette-peanut-husk");
        const briquetteFireCutInput = document.getElementById("briquette-fire-cut");
        const briquetteOutputKg = document.getElementById("briquette-output-kg");
        const briquetteCostTableBody = document.getElementById("briquette-cost-table-body");
        const briquetteTotalCost = document.getElementById("briquette-total-cost");
        const briquetteUnitCost = document.getElementById("briquette-unit-cost");
        const briquetteModalFeedback = document.getElementById("briquette-mix-feedback");
        const briquetteModalError = document.getElementById("briquette-mix-error");
        const briquetteModalClose = document.getElementById("briquette-mix-close");
        const briquetteModalCancel = document.getElementById("briquette-mix-cancel");
        const briquetteSaveButton = document.getElementById("briquette-mix-save");

        let briquetteMaterialOrder = [];
        let briquetteMaterialLabels = {};
        let briquetteModalDateValue = null;
        let briquetteDryerProductionTon = 0;

        function formatNumber(value, fractionDigits) {
            const numeric = Number.parseFloat(value);
            if (Number.isNaN(numeric)) {
                return "—";
            }
            return numeric.toLocaleString(undefined, {
                minimumFractionDigits: fractionDigits,
                maximumFractionDigits: fractionDigits,
            });
        }

        function isoToday() {
            const today = new Date();
            const month = String(today.getMonth() + 1).padStart(2, "0");
            const day = String(today.getDate()).padStart(2, "0");
            return `${today.getFullYear()}-${month}-${day}`;
        }

        function renderStockStatusRows(items) {
            if (!stockStatusTableBody || !stockStatusTableWrapper || !stockStatusEmptyState) {
                return;
            }

            stockStatusTableBody.innerHTML = "";

            if (!Array.isArray(items) || items.length === 0) {
                stockStatusTableWrapper.hidden = true;
                stockStatusEmptyState.hidden = false;
                stockStatusEmptyState.textContent = "No stock data available for the selected date.";
                return;
            }

            items.forEach((item) => {
                const row = document.createElement("tr");
                if (item.key === "opening_total") {
                    row.classList.add("stock-status-table__opening-row");
                }

                const nameCell = document.createElement("td");
                nameCell.textContent = item.label || item.name || item.key || "—";
                row.appendChild(nameCell);

                const qtyCell = document.createElement("td");
                qtyCell.textContent = formatNumber(item.quantity_ton, 3);
                row.appendChild(qtyCell);

                const valueCell = document.createElement("td");
                valueCell.textContent = formatNumber(item.value_rs, 2);
                row.appendChild(valueCell);

                stockStatusTableBody.appendChild(row);
            });

            stockStatusEmptyState.hidden = true;
            stockStatusTableWrapper.hidden = false;
        }

        async function loadStockStatus(asOf) {
            if (!stockStatusEmptyState || !stockStatusTableBody) {
                return;
            }

            stockStatusEmptyState.hidden = false;
            stockStatusEmptyState.textContent = "Loading stock status…";
            if (stockStatusTableWrapper) {
                stockStatusTableWrapper.hidden = true;
            }

            try {
                const url = new URL("/api/material/stock-status", window.location.origin);
                if (asOf) {
                    url.searchParams.set("as_of", asOf);
                }
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error("Failed to load stock status");
                }
                const data = await response.json();
                renderStockStatusRows(Array.isArray(data.items) ? data.items : []);
                if (stockStatusDateInput && data.as_of) {
                    stockStatusDateInput.value = data.as_of;
                }
            } catch (error) {
                console.error(error);
                stockStatusEmptyState.hidden = false;
                stockStatusEmptyState.textContent =
                    "Unable to load stock status right now. Please try again.";
            }
        }

        if (stockStatusDateInput) {
            const defaultDate = isoToday();
            if (!stockStatusDateInput.value) {
                stockStatusDateInput.value = defaultDate;
            }
            stockStatusDateInput.addEventListener("change", () => {
                const value = stockStatusDateInput.value || defaultDate;
                loadStockStatus(value);
            });
            loadStockStatus(stockStatusDateInput.value);
        } else {
            loadStockStatus(isoToday());
        }

        function renderSupplierRows(items) {
            if (!supplierTableBody || !supplierTableWrapper || !supplierEmptyState) {
                return;
            }

            supplierTableBody.innerHTML = "";

            if (!items || items.length === 0) {
                supplierTableWrapper.hidden = true;
                supplierEmptyState.hidden = false;
                supplierEmptyState.textContent = "No suppliers registered yet.";
                return;
            }

            items.forEach((item) => {
                const row = document.createElement("tr");

                const nameCell = document.createElement("td");
                nameCell.textContent = item.name || "—";
                row.appendChild(nameCell);

                const regCell = document.createElement("td");
                regCell.textContent = item.supplierRegNo || "—";
                row.appendChild(regCell);

                const categoryCell = document.createElement("td");
                categoryCell.textContent = item.category || "—";
                row.appendChild(categoryCell);

                const phoneCell = document.createElement("td");
                phoneCell.textContent = item.primaryPhone || item.phone || "—";
                row.appendChild(phoneCell);

                const creditCell = document.createElement("td");
                creditCell.textContent = item.creditPeriod || "—";
                row.appendChild(creditCell);

                supplierTableBody.appendChild(row);
            });

            supplierEmptyState.hidden = true;
            supplierTableWrapper.hidden = false;
        }

        async function loadSuppliers(query = "") {
            if (!supplierTableBody || !supplierEmptyState) {
                return;
            }

            supplierEmptyState.hidden = false;
            supplierEmptyState.textContent = "Loading suppliers…";
            if (supplierTableWrapper) {
                supplierTableWrapper.hidden = true;
            }

            try {
                const url = new URL("/api/material/suppliers", window.location.origin);
                url.searchParams.set("limit", "15");
                if (query && query.trim()) {
                    url.searchParams.set("search", query.trim());
                }
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error("Failed to load suppliers");
                }
                const data = await response.json();
                if (!Array.isArray(data)) {
                    renderSupplierRows([]);
                    return;
                }
                renderSupplierRows(data);
            } catch (error) {
                console.error(error);
                supplierEmptyState.hidden = false;
                supplierEmptyState.textContent =
                    "Unable to load suppliers right now. Please try again.";
            }
        }

        function formatDate(value) {
            if (!value) {
                return "—";
            }
            const parts = value.split("-");
            if (parts.length !== 3) {
                return value;
            }
            const [year, month, day] = parts.map((part) => Number.parseInt(part, 10));
            if (Number.isNaN(year) || Number.isNaN(month) || Number.isNaN(day)) {
                return value;
            }
            const dateObject = new Date(year, month - 1, day);
            return dateObject.toLocaleDateString(undefined, {
                year: "numeric",
                month: "short",
                day: "numeric",
            });
        }

        function renderBriquetteMaterialHeadings(order, labels) {
            if (!briquetteMaterialHeadings) {
                return;
            }

            const fragment = document.createDocumentFragment();
            if (Array.isArray(order) && order.length) {
                order.forEach((key) => {
                    const th = document.createElement("th");
                    th.scope = "col";
                    th.textContent = labels?.[key] || key;
                    fragment.appendChild(th);
                });
            } else {
                ["Sawdust", "Wood Shaving", "Wood Powder", "Peanut Husk", "Fire Cut"].forEach((label) => {
                    const th = document.createElement("th");
                    th.scope = "col";
                    th.textContent = label;
                    fragment.appendChild(th);
                });
            }

            briquetteMaterialHeadings.innerHTML = "";
            briquetteMaterialHeadings.appendChild(fragment);
        }

        function renderBriquetteCostBreakdown(rows) {
            if (!briquetteCostTableBody) {
                return;
            }

            briquetteCostTableBody.innerHTML = "";
            if (!Array.isArray(rows) || rows.length === 0) {
                const emptyRow = document.createElement("tr");
                const cell = document.createElement("td");
                cell.colSpan = 5;
                cell.textContent = "No cost data available.";
                emptyRow.appendChild(cell);
                briquetteCostTableBody.appendChild(emptyRow);
                return;
            }

            rows.forEach((row) => {
                const tr = document.createElement("tr");
                const materialCell = document.createElement("td");
                materialCell.textContent = row.label || "—";
                tr.appendChild(materialCell);

                const qtyKgCell = document.createElement("td");
                qtyKgCell.textContent = formatNumber(row.quantity_kg, 3);
                tr.appendChild(qtyKgCell);

                const qtyTonCell = document.createElement("td");
                qtyTonCell.textContent = formatNumber(row.quantity_ton, 3);
                tr.appendChild(qtyTonCell);

                const unitPriceCell = document.createElement("td");
                unitPriceCell.textContent = formatNumber(row.unit_price, 4);
                tr.appendChild(unitPriceCell);

                const totalCostCell = document.createElement("td");
                totalCostCell.textContent = formatNumber(row.total_cost, 2);
                tr.appendChild(totalCostCell);

                briquetteCostTableBody.appendChild(tr);
            });
        }

        function clearBriquetteModalFeedback() {
            if (briquetteModalFeedback) {
                briquetteModalFeedback.hidden = true;
                briquetteModalFeedback.textContent = "";
                briquetteModalFeedback.classList.remove("modal__feedback--success");
            }
            if (briquetteModalError) {
                briquetteModalError.hidden = true;
                briquetteModalError.textContent = "";
            }
        }

        function setBriquetteModalFeedback(message, { isError = false } = {}) {
            if (isError) {
                if (briquetteModalError) {
                    briquetteModalError.hidden = false;
                    briquetteModalError.textContent = message;
                }
                if (briquetteModalFeedback) {
                    briquetteModalFeedback.hidden = true;
                    briquetteModalFeedback.textContent = "";
                    briquetteModalFeedback.classList.remove("modal__feedback--success");
                }
                return;
            }

            if (briquetteModalFeedback) {
                briquetteModalFeedback.hidden = false;
                briquetteModalFeedback.textContent = message;
                briquetteModalFeedback.classList.add("modal__feedback--success");
            }
            if (briquetteModalError) {
                briquetteModalError.hidden = true;
                briquetteModalError.textContent = "";
            }
        }

        function closeBriquetteModal() {
            if (!briquetteModal) {
                return;
            }
            briquetteModal.classList.remove("modal--open");
            briquetteModal.setAttribute("hidden", "");
            briquetteModal.setAttribute("aria-hidden", "true");
            document.body.classList.remove("modal-open");
            briquetteModalDateValue = null;
            briquetteDryerProductionTon = 0;
            if (briquetteModalForm) {
                briquetteModalForm.reset();
            }
            clearBriquetteModalFeedback();
        }

        function updateSawdustPreview() {
            if (!briquetteDryFactorInput || !briquetteSawdustInput) {
                return;
            }
            const dryFactor = Number.parseFloat(briquetteDryFactorInput.value || "0");
            if (!Number.isFinite(dryFactor)) {
                briquetteSawdustInput.value = "0.000";
                return;
            }
            const sawdustTons = Math.max(0, briquetteDryerProductionTon * dryFactor);
            briquetteSawdustInput.value = sawdustTons.toFixed(3);
        }

        function populateBriquetteModal(data) {
            if (!data) {
                return;
            }
            if (briquetteModalDate) {
                briquetteModalDate.value = formatDate(data.date) || data.date || "—";
            }
            if (typeof data.dry_factor === "number" && briquetteDryFactorInput) {
                briquetteDryFactorInput.value = data.dry_factor.toFixed(4);
            } else if (briquetteDryFactorInput) {
                briquetteDryFactorInput.value = "0.0000";
            }
            briquetteDryerProductionTon = Number.parseFloat(data.dryer_production_ton || "0") || 0;

            if (briquetteOutputKg) {
                briquetteOutputKg.textContent = formatNumber(data.briquette_output_kg, 2);
            }

            const materials = data.materials || {};
            if (briquetteWoodShavingInput) {
                const value = Number.parseFloat(materials.wood_shaving) || 0;
                briquetteWoodShavingInput.value = value.toFixed(3);
            }
            if (briquetteWoodPowderInput) {
                const value = Number.parseFloat(materials.wood_powder) || 0;
                briquetteWoodPowderInput.value = value.toFixed(3);
            }
            if (briquettePeanutHuskInput) {
                const value = Number.parseFloat(materials.peanut_husk) || 0;
                briquettePeanutHuskInput.value = value.toFixed(3);
            }
            if (briquetteFireCutInput) {
                const value = Number.parseFloat(materials.fire_cut) || 0;
                briquetteFireCutInput.value = value.toFixed(3);
            }
            if (briquetteSawdustInput) {
                const sawdustValue = Number.parseFloat(data.sawdust_ton) || 0;
                briquetteSawdustInput.value = sawdustValue.toFixed(3);
            }

            if (briquetteTotalCost) {
                briquetteTotalCost.textContent = `Rs ${formatNumber(data.total_material_cost, 2)}`;
            }
            if (briquetteUnitCost) {
                briquetteUnitCost.textContent = `Rs ${formatNumber(data.unit_cost_per_kg, 4)}`;
            }

            renderBriquetteCostBreakdown(data.cost_breakdown);
        }

        async function fetchBriquetteMix(dateIso) {
            if (!dateIso) {
                return;
            }
            clearBriquetteModalFeedback();
            if (briquetteSaveButton) {
                briquetteSaveButton.disabled = true;
            }
            try {
                const response = await fetch(`/api/material/briquette-production/${dateIso}`);
                if (!response.ok) {
                    throw new Error("Unable to load mix details.");
                }
                const data = await response.json();
                populateBriquetteModal(data);
                if (Array.isArray(data.material_order)) {
                    briquetteMaterialOrder = data.material_order;
                }
                if (data.material_labels) {
                    briquetteMaterialLabels = data.material_labels;
                }
                renderBriquetteMaterialHeadings(briquetteMaterialOrder, briquetteMaterialLabels);
                updateSawdustPreview();
                if (briquetteSaveButton) {
                    briquetteSaveButton.disabled = false;
                }
            } catch (error) {
                console.error(error);
                setBriquetteModalFeedback("Unable to load mix details. Please try again.", { isError: true });
                if (briquetteSaveButton) {
                    briquetteSaveButton.disabled = false;
                }
            }
        }

        function openBriquetteModal(dateIso) {
            if (!briquetteModal || !dateIso) {
                return;
            }
            briquetteModalDateValue = dateIso;
            briquetteModal.removeAttribute("hidden");
            briquetteModal.setAttribute("aria-hidden", "false");
            briquetteModal.classList.add("modal--open");
            document.body.classList.add("modal-open");
            if (briquetteSaveButton) {
                briquetteSaveButton.disabled = true;
            }
            clearBriquetteModalFeedback();
            fetchBriquetteMix(dateIso);
        }

        function renderBriquetteRows(entries) {
            if (!briquetteTableBody || !briquetteTableWrapper || !briquetteEmptyState) {
                return;
            }

            briquetteTableBody.innerHTML = "";

            if (!Array.isArray(entries) || entries.length === 0) {
                briquetteTableWrapper.hidden = true;
                briquetteEmptyState.hidden = false;
                briquetteEmptyState.textContent = "No briquette production entries recorded yet.";
                return;
            }

            entries.forEach((entry) => {
                const tr = document.createElement("tr");
                const dateCell = document.createElement("td");
                dateCell.textContent = formatDate(entry.date) || entry.date || "—";
                tr.appendChild(dateCell);

                const productionCell = document.createElement("td");
                productionCell.textContent = formatNumber(entry.briquette_production_ton, 3);
                tr.appendChild(productionCell);

                if (!Array.isArray(briquetteMaterialOrder) || briquetteMaterialOrder.length === 0) {
                    briquetteMaterialOrder = Object.keys(entry.materials || {});
                }

                briquetteMaterialOrder.forEach((key) => {
                    const cell = document.createElement("td");
                    const value = (entry.materials && entry.materials[key]) || 0;
                    cell.textContent = formatNumber(value, 3);
                    tr.appendChild(cell);
                });

                const unitCostCell = document.createElement("td");
                unitCostCell.textContent = formatNumber(entry.unit_cost_per_kg, 4);
                tr.appendChild(unitCostCell);

                const totalCostCell = document.createElement("td");
                totalCostCell.textContent = formatNumber(entry.total_material_cost, 2);
                tr.appendChild(totalCostCell);

                const actionCell = document.createElement("td");
                const actionButton = document.createElement("button");
                actionButton.type = "button";
                actionButton.className = "button button--secondary";
                actionButton.textContent = entry.has_mix ? "Edit mix" : "Update mix";
                actionButton.dataset.mixDate = entry.date;
                actionCell.appendChild(actionButton);
                tr.appendChild(actionCell);

                briquetteTableBody.appendChild(tr);
            });

            briquetteEmptyState.hidden = true;
            briquetteTableWrapper.hidden = false;
        }

        async function loadBriquetteProductionEntries() {
            if (!briquetteEmptyState) {
                return;
            }

            briquetteEmptyState.hidden = false;
            briquetteEmptyState.textContent = "Loading briquette production…";
            if (briquetteTableWrapper) {
                briquetteTableWrapper.hidden = true;
            }

            try {
                const response = await fetch("/api/material/briquette-production");
                if (!response.ok) {
                    throw new Error("Failed to load briquette production entries.");
                }
                const data = await response.json();
                if (Array.isArray(data.material_order)) {
                    briquetteMaterialOrder = data.material_order;
                }
                if (data.material_labels) {
                    briquetteMaterialLabels = data.material_labels;
                }
                renderBriquetteMaterialHeadings(briquetteMaterialOrder, briquetteMaterialLabels);
                renderBriquetteRows(data.entries || []);
            } catch (error) {
                console.error(error);
                if (briquetteEmptyState) {
                    briquetteEmptyState.hidden = false;
                    briquetteEmptyState.textContent = "Unable to load briquette production right now.";
                }
            }
        }

        if (supplierSearchForm) {
            supplierSearchForm.addEventListener("submit", (event) => {
                event.preventDefault();
                const query = supplierSearchInput ? supplierSearchInput.value : "";
                loadSuppliers(query);
            });
        }

        if (supplierClearButton) {
            supplierClearButton.addEventListener("click", () => {
                if (supplierSearchInput) {
                    supplierSearchInput.value = "";
                }
                loadSuppliers("");
            });
        }

        if (supplierSearchInput) {
            supplierSearchInput.addEventListener("input", () => {
                if (supplierSearchInput.value.trim() === "") {
                    loadSuppliers("");
                }
            });
        }

        function renderMrnRows(items) {
            if (!mrnTableBody || !mrnTableWrapper || !mrnEmptyState) {
                return;
            }

            mrnTableBody.innerHTML = "";

            if (!items || items.length === 0) {
                mrnTableWrapper.hidden = true;
                mrnEmptyState.hidden = false;
                mrnEmptyState.textContent = "No material receipts recorded yet.";
                return;
            }

            items.forEach((item) => {
                const row = document.createElement("tr");

                const mrnCell = document.createElement("td");
                const mrnLink = document.createElement("a");
                mrnLink.className = "data-table__link";
                mrnLink.href = `/material/mrn/${item.id}`;
                mrnLink.textContent = item.mrn_no;
                mrnCell.appendChild(mrnLink);
                row.appendChild(mrnCell);

                const dateCell = document.createElement("td");
                dateCell.textContent = formatDate(item.date);
                row.appendChild(dateCell);

                const supplierCell = document.createElement("td");
                supplierCell.textContent =
                    (item.supplier && item.supplier.name) || item.vehicle_no || "—";
                row.appendChild(supplierCell);

                const materialCell = document.createElement("td");
                let materialSummary = "—";
                if (Array.isArray(item.items) && item.items.length > 0) {
                    const firstItem = item.items[0];
                    const firstName = (firstItem.item && firstItem.item.name) || firstItem.name || "—";
                    if (item.items.length === 1) {
                        materialSummary = firstName;
                    } else {
                        materialSummary = `${firstName} + ${item.items.length - 1} more`;
                    }
                }
                materialCell.textContent = materialSummary;
                row.appendChild(materialCell);

                const qtyCell = document.createElement("td");
                qtyCell.textContent = formatNumber(item.qty_ton, 3);
                row.appendChild(qtyCell);

                const amountCell = document.createElement("td");
                amountCell.textContent = formatNumber(item.amount, 2);
                row.appendChild(amountCell);

                mrnTableBody.appendChild(row);
            });

            mrnEmptyState.hidden = true;
            mrnTableWrapper.hidden = false;
        }

        async function loadMrns(query = "") {
            if (!mrnTableBody || !mrnEmptyState) {
                return;
            }

            mrnEmptyState.hidden = false;
            mrnEmptyState.textContent = "Loading material receipts…";
            if (mrnTableWrapper) {
                mrnTableWrapper.hidden = true;
            }

            try {
                const url = new URL("/api/material/mrn", window.location.origin);
                if (query && query.trim()) {
                    url.searchParams.set("q", query.trim());
                }
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error("Failed to load MRNs");
                }
                const data = await response.json();
                if (!Array.isArray(data)) {
                    renderMrnRows([]);
                    return;
                }
                renderMrnRows(data);
            } catch (error) {
                console.error(error);
                mrnEmptyState.hidden = false;
                mrnEmptyState.textContent =
                    "Unable to load material receipts right now. Please try again.";
            }
        }

        if (mrnSearchForm) {
            mrnSearchForm.addEventListener("submit", (event) => {
                event.preventDefault();
                const query = mrnSearchInput ? mrnSearchInput.value : "";
                loadMrns(query);
            });
        }

        if (mrnClearButton) {
            mrnClearButton.addEventListener("click", () => {
                if (mrnSearchInput) {
                    mrnSearchInput.value = "";
                }
                loadMrns("");
            });
        }

        if (mrnSearchInput) {
            mrnSearchInput.addEventListener("input", () => {
                if (mrnSearchInput.value.trim() === "") {
                    loadMrns("");
                }
            });
        }

        if (briquetteTableBody) {
            briquetteTableBody.addEventListener("click", (event) => {
                const button = event.target.closest("button[data-mix-date]");
                if (!button) {
                    return;
                }
                const dateIso = button.dataset.mixDate;
                openBriquetteModal(dateIso);
            });
        }

        if (briquetteModalClose) {
            briquetteModalClose.addEventListener("click", () => {
                closeBriquetteModal();
            });
        }

        if (briquetteModalCancel) {
            briquetteModalCancel.addEventListener("click", () => {
                closeBriquetteModal();
            });
        }

        if (briquetteModal) {
            briquetteModal.addEventListener("click", (event) => {
                if (event.target && event.target.dataset && "modalDismiss" in event.target.dataset) {
                    closeBriquetteModal();
                }
            });
        }

        document.addEventListener("keydown", (event) => {
            if (event.key === "Escape" && briquetteModal && !briquetteModal.hasAttribute("hidden")) {
                closeBriquetteModal();
            }
        });

        if (briquetteDryFactorInput) {
            briquetteDryFactorInput.addEventListener("input", updateSawdustPreview);
        }

        if (briquetteModalForm) {
            briquetteModalForm.addEventListener("submit", async (event) => {
                event.preventDefault();
                if (!briquetteModalDateValue) {
                    setBriquetteModalFeedback("No date selected.", { isError: true });
                    return;
                }

                if (briquetteSaveButton) {
                    briquetteSaveButton.disabled = true;
                }
                clearBriquetteModalFeedback();

                const payload = {
                    dry_factor: briquetteDryFactorInput ? briquetteDryFactorInput.value : null,
                    wood_shaving_ton: briquetteWoodShavingInput ? briquetteWoodShavingInput.value : null,
                    wood_powder_ton: briquetteWoodPowderInput ? briquetteWoodPowderInput.value : null,
                    peanut_husk_ton: briquettePeanutHuskInput ? briquettePeanutHuskInput.value : null,
                    fire_cut_ton: briquetteFireCutInput ? briquetteFireCutInput.value : null,
                };

                try {
                    const response = await fetch(`/api/material/briquette-production/${briquetteModalDateValue}`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(payload),
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        const message = errorData?.msg || "Unable to save mix details.";
                        throw new Error(message);
                    }

                    const data = await response.json();
                    populateBriquetteModal(data);
                    setBriquetteModalFeedback("Mix updated successfully.");
                    loadBriquetteProductionEntries();
                } catch (error) {
                    console.error(error);
                    setBriquetteModalFeedback(error.message || "Unable to save mix details.", { isError: true });
                } finally {
                    if (briquetteSaveButton) {
                        briquetteSaveButton.disabled = false;
                    }
                }
            });
        }

        loadSuppliers("");
        loadMrns("");
        loadBriquetteProductionEntries();
    </script>
</body>
</html>
