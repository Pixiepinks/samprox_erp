<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Market | SAMPROX ERP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" />
</head>
<body>
    <div class="page">
        <header class="topbar">
            <div class="brand">
                <div class="brand__logo">S</div>
                <div class="brand__details">
                    <p class="brand__name">SAMPROX ERP</p>
                    <p class="brand__section">Market Insights</p>
                </div>
            </div>
            <div class="topbar__actions">
                <a class="button button--ghost" href="{{ url_for('ui.mind_page') }}">Mind</a>
                <div class="user-summary">
                    <span class="user-summary__name" id="user-name"></span>
                    <span class="user-summary__role" id="user-role"></span>
                </div>
                <button type="button" class="button button--secondary" id="logout">Sign out</button>
            </div>
        </header>
        <nav class="subnav" aria-label="7M navigation">
            <a class="subnav__link" href="{{ url_for('ui.mind_page') }}">Mind</a>
            <a class="subnav__link" href="{{ url_for('ui.man_page') }}">Man</a>
            <a class="subnav__link" href="{{ url_for('ui.machines_page') }}">Machine</a>
            <a class="subnav__link" href="{{ url_for('ui.material_page') }}">Material</a>
            <a class="subnav__link subnav__link--active" href="{{ url_for('ui.market_page') }}">Market</a>
            <a class="subnav__link" href="{{ url_for('ui.manufacturing_page') }}">Manufacturing</a>
            <a class="subnav__link" href="{{ url_for('ui.money_page') }}">Money</a>
        </nav>
        <section class="section">
            <header class="section__header">
                <h1>Demand & customer alignment</h1>
            </header>
            <p class="section__description">
                Keep production aligned with market demand by reviewing orders, forecasts, and customer
                feedback. Use this page to coordinate priorities across sales, production, and service.
            </p>
            <div class="section__grid">
                <article class="tile">
                    <h2 class="tile__title">Sales pipeline</h2>
                    <p class="tile__description">
                        Track upcoming orders and opportunities to plan capacity and inventory.
                    </p>
                </article>
                <article class="tile">
                    <h2 class="tile__title">Customer feedback</h2>
                    <p class="tile__description">
                        Collect insights from support tickets and surveys to improve service quality.
                    </p>
                </article>
                <article class="tile">
                    <h2 class="tile__title">Competitor watch</h2>
                    <p class="tile__description">
                        Highlight market trends and competitor moves that influence pricing or demand.
                    </p>
                </article>
                <article class="tile">
                    <h2 class="tile__title">Promotion calendar</h2>
                    <p class="tile__description">
                        Coordinate marketing campaigns with production capabilities to avoid bottlenecks.
                    </p>
                </article>
            </div>
            <article class="production-card sales-entry" aria-labelledby="sales-entry-title">
                <div>
                    <h2 id="sales-entry-title">Record sales entry</h2>
                    <p class="sales-entry__subtitle">
                        Capture forecasted or actual sales to instantly refresh the performance report below.
                    </p>
                </div>
                <form id="sales-entry-form" class="sales-entry__form" aria-label="Record sales entry">
                    <label class="sales-entry__field" for="sales-entry-date">
                        <span class="sales-entry__label">Date</span>
                        <input type="date" id="sales-entry-date" name="date" class="sales-entry__input" required />
                    </label>
                    <label class="sales-entry__field" for="sales-entry-customer">
                        <span class="sales-entry__label">Customer</span>
                        <select id="sales-entry-customer" name="customer_id" class="sales-entry__select" required></select>
                    </label>
                    <label class="sales-entry__field" for="sales-entry-type">
                        <span class="sales-entry__label">Entry type</span>
                        <select id="sales-entry-type" name="sale_type" class="sales-entry__select" required>
                            <option value="actual">Actual sale</option>
                            <option value="forecast">Forecast sale</option>
                        </select>
                    </label>
                    <label class="sales-entry__field" for="sales-entry-unit-price">
                        <span class="sales-entry__label">Unit price (Rs/Ton)</span>
                        <input
                            type="number"
                            id="sales-entry-unit-price"
                            name="unit_price"
                            class="sales-entry__input"
                            inputmode="decimal"
                            step="0.01"
                            min="0"
                            placeholder="0.00"
                            required
                        />
                    </label>
                    <label class="sales-entry__field" for="sales-entry-quantity">
                        <span class="sales-entry__label">Quantity (Tons)</span>
                        <input
                            type="number"
                            id="sales-entry-quantity"
                            name="quantity_tons"
                            class="sales-entry__input"
                            inputmode="decimal"
                            step="0.01"
                            min="0"
                            placeholder="0.00"
                            required
                        />
                    </label>
                    <div class="sales-entry__field">
                        <span class="sales-entry__label">Sales value (Rs)</span>
                        <output id="sales-entry-total" class="sales-entry__total" aria-live="polite">0.00</output>
                    </div>
                    <div class="sales-entry__actions">
                        <button type="submit" class="button" id="sales-entry-submit">Save entry</button>
                    </div>
                </form>
                <p id="sales-entry-feedback" class="sales-entry__feedback" role="status" aria-live="polite"></p>
            </article>
            <article class="production-card sales-report" aria-labelledby="sales-report-title">
                <div class="production-card__header">
                    <div>
                        <h2 id="sales-report-title">Customer sales performance</h2>
                        <p id="sales-report-subtitle" class="sales-report__subtitle">
                            Select a month and year to compare forecasted versus actual sales by customer.
                        </p>
                    </div>
                    <form id="sales-report-form" class="sales-report__controls" aria-label="Customer sales filters">
                        <label class="sales-report__field" for="sales-report-month">
                            <span class="sales-report__label">Month</span>
                            <select id="sales-report-month" name="month" class="sales-report__input" required></select>
                        </label>
                        <label class="sales-report__field" for="sales-report-year">
                            <span class="sales-report__label">Year</span>
                            <select id="sales-report-year" name="year" class="sales-report__input" required></select>
                        </label>
                        <label class="sales-report__field" for="sales-report-customer">
                            <span class="sales-report__label">Customer</span>
                            <select id="sales-report-customer" name="customer_id" class="sales-report__input">
                                <option value="">All customers</option>
                            </select>
                        </label>
                        <button type="submit" class="button" id="sales-report-submit">Load report</button>
                    </form>
                </div>
                <p id="sales-report-feedback" class="sales-report__feedback" role="status" aria-live="polite"></p>
                <div id="sales-report-results" class="sales-report__results" aria-live="polite"></div>
            </article>
        </section>
    </div>
    <script>
        const token = localStorage.getItem("samprox_token");
        const userRaw = localStorage.getItem("samprox_user");
        let user;

        try {
            user = userRaw ? JSON.parse(userRaw) : null;
        } catch (_) {
            user = null;
        }

        if (!token || !user) {
            window.location.href = "/";
        }

        const roleLabels = {
            admin: "Admin",
            production_manager: "Production Manager",
            maintenance_manager: "Maintenance Manager",
            technician: "Technician",
        };

        const userNameEl = document.getElementById("user-name");
        const userRoleEl = document.getElementById("user-role");
        const logoutButton = document.getElementById("logout");
        const entryForm = document.getElementById("sales-entry-form");
        const entryDateInput = document.getElementById("sales-entry-date");
        const entryCustomerSelect = document.getElementById("sales-entry-customer");
        const entryTypeSelect = document.getElementById("sales-entry-type");
        const entryUnitPriceInput = document.getElementById("sales-entry-unit-price");
        const entryQuantityInput = document.getElementById("sales-entry-quantity");
        const entryTotalOutput = document.getElementById("sales-entry-total");
        const entryFeedbackEl = document.getElementById("sales-entry-feedback");
        const entrySubmitButton = document.getElementById("sales-entry-submit");
        const addCustomerOptionValue = "__create__";

        function handleUnauthorized() {
            localStorage.removeItem("samprox_token");
            localStorage.removeItem("samprox_user");
            window.location.href = "/";
        }

        userNameEl.textContent = user?.name || "Unknown";
        userRoleEl.textContent = roleLabels[user?.role] || "";

        logoutButton.addEventListener("click", () => {
            handleUnauthorized();
        });

        const monthNames = [
            "January",
            "February",
            "March",
            "April",
            "May",
            "June",
            "July",
            "August",
            "September",
            "October",
            "November",
            "December",
        ];

        const reportForm = document.getElementById("sales-report-form");
        const monthSelect = document.getElementById("sales-report-month");
        const yearSelect = document.getElementById("sales-report-year");
        const customerSelect = document.getElementById("sales-report-customer");
        const submitButton = document.getElementById("sales-report-submit");
        const feedbackEl = document.getElementById("sales-report-feedback");
        const resultsEl = document.getElementById("sales-report-results");
        const subtitleEl = document.getElementById("sales-report-subtitle");

        const knownCustomers = new Map();
        const numberFormatter = new Intl.NumberFormat(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
        });

        function formatAmount(value) {
            return numberFormatter.format(value || 0);
        }

        function updateSubtitle(year, month) {
            if (!subtitleEl) {
                return;
            }
            if (!year || !month) {
                subtitleEl.textContent =
                    "Select a month and year to compare forecasted versus actual sales by customer.";
                return;
            }
            const monthIndex = Math.max(1, Math.min(12, Number(month))) - 1;
            const monthName = monthNames[monthIndex] || "";
            subtitleEl.textContent = `${monthName} ${year}`.trim();
        }

        function setFeedback(message, variant = "info") {
            if (!feedbackEl) {
                return;
            }

            const variants = ["sales-report__feedback--error", "sales-report__feedback--success", "sales-report__feedback--info"];
            feedbackEl.classList.remove("sales-report__feedback--visible", ...variants);

            if (!message) {
                feedbackEl.textContent = "";
                return;
            }

            feedbackEl.textContent = message;
            if (variant === "error") {
                feedbackEl.classList.add("sales-report__feedback--error");
            } else if (variant === "success") {
                feedbackEl.classList.add("sales-report__feedback--success");
            } else {
                feedbackEl.classList.add("sales-report__feedback--info");
            }
            feedbackEl.classList.add("sales-report__feedback--visible");
        }

        function setEntryFeedback(message, variant = "info") {
            if (!entryFeedbackEl) {
                return;
            }

            const variants = ["sales-entry__feedback--error", "sales-entry__feedback--success"];
            entryFeedbackEl.classList.remove("sales-entry__feedback--visible", ...variants);

            if (!message) {
                entryFeedbackEl.textContent = "";
                return;
            }

            entryFeedbackEl.textContent = message;
            if (variant === "error") {
                entryFeedbackEl.classList.add("sales-entry__feedback--error");
            } else if (variant === "success") {
                entryFeedbackEl.classList.add("sales-entry__feedback--success");
            }
            entryFeedbackEl.classList.add("sales-entry__feedback--visible");
        }

        function registerCustomers(customers) {
            if (!Array.isArray(customers)) {
                return;
            }

            customers.forEach((customer) => {
                const id = Number(customer.customer_id ?? customer.id);
                const name = customer.customer_name ?? customer.name;
                if (!id || !name) {
                    return;
                }
                const existingName = knownCustomers.get(id);
                if (existingName !== name) {
                    knownCustomers.set(id, name);
                }
            });
        }

        function refreshCustomerSelectors() {
            const sorted = Array.from(knownCustomers.entries()).sort((a, b) => a[1].localeCompare(b[1]));

            if (customerSelect) {
                const previousValue = customerSelect.value;
                customerSelect.innerHTML = "";
                const defaultOption = document.createElement("option");
                defaultOption.value = "";
                defaultOption.textContent = "All customers";
                customerSelect.appendChild(defaultOption);

                sorted.forEach(([id, name]) => {
                    const option = document.createElement("option");
                    option.value = String(id);
                    option.textContent = name;
                    customerSelect.appendChild(option);
                });

                if (previousValue && customerSelect.querySelector(`option[value="${previousValue}"]`)) {
                    customerSelect.value = previousValue;
                }
            }

            if (entryCustomerSelect) {
                const previousValue =
                    entryCustomerSelect.value && entryCustomerSelect.value !== addCustomerOptionValue
                        ? entryCustomerSelect.value
                        : "";
                entryCustomerSelect.innerHTML = "";

                const placeholderOption = document.createElement("option");
                placeholderOption.value = "";
                placeholderOption.textContent = "Select a customer";
                entryCustomerSelect.appendChild(placeholderOption);

                const createOption = document.createElement("option");
                createOption.value = addCustomerOptionValue;
                createOption.textContent = "➕ Add new customer";
                entryCustomerSelect.appendChild(createOption);

                sorted.forEach(([id, name]) => {
                    const option = document.createElement("option");
                    option.value = String(id);
                    option.textContent = name;
                    entryCustomerSelect.appendChild(option);
                });

                if (previousValue && entryCustomerSelect.querySelector(`option[value="${previousValue}"]`)) {
                    entryCustomerSelect.value = previousValue;
                } else {
                    entryCustomerSelect.value = "";
                }
            }
        }

        function updateCustomerOptions(customers) {
            registerCustomers(customers);
            refreshCustomerSelectors();
        }

        function updateEntryTotal() {
            if (!entryTotalOutput) {
                return;
            }

            const unit = Number.parseFloat(entryUnitPriceInput?.value ?? "0");
            const quantity = Number.parseFloat(entryQuantityInput?.value ?? "0");
            const safeUnit = Number.isFinite(unit) ? unit : 0;
            const safeQuantity = Number.isFinite(quantity) ? quantity : 0;
            const total = safeUnit * safeQuantity;
            entryTotalOutput.textContent = numberFormatter.format(total || 0);
        }

        async function createCustomer(name) {
            if (!token) {
                return null;
            }

            const response = await fetch("/api/market/customers", {
                method: "POST",
                headers: {
                    Authorization: `Bearer ${token}`,
                    "Content-Type": "application/json",
                    Accept: "application/json",
                },
                body: JSON.stringify({ name }),
            });

            if (response.status === 401) {
                handleUnauthorized();
                return null;
            }

            const data = await response.json().catch(() => ({}));
            if (!response.ok) {
                if (response.status === 409 && data.customer) {
                    return { customer: data.customer, alreadyExists: true };
                }
                throw new Error(data.msg || "Unable to create customer.");
            }

            return { customer: data.customer, alreadyExists: false };
        }

        async function loadCustomers() {
            if (!token) {
                refreshCustomerSelectors();
                return;
            }

            try {
                const response = await fetch("/api/market/customers", {
                    headers: {
                        Authorization: `Bearer ${token}`,
                        Accept: "application/json",
                    },
                });

                if (response.status === 401) {
                    handleUnauthorized();
                    return;
                }

                if (!response.ok) {
                    throw new Error("Unable to load customers");
                }

                const data = await response.json();
                registerCustomers(data.customers || []);
            } catch (error) {
                console.error(error);
            } finally {
                refreshCustomerSelectors();
            }
        }

        if (entryCustomerSelect) {
            entryCustomerSelect.addEventListener("change", async (event) => {
                if (event.target.value !== addCustomerOptionValue) {
                    return;
                }

                const name = window.prompt("Enter the new customer name:");
                if (!name) {
                    entryCustomerSelect.value = "";
                    return;
                }

                const trimmedName = name.trim();
                if (!trimmedName) {
                    entryCustomerSelect.value = "";
                    setEntryFeedback("Customer name cannot be empty.", "error");
                    return;
                }

                try {
                    const result = await createCustomer(trimmedName);
                    if (!result || !result.customer) {
                        entryCustomerSelect.value = "";
                        return;
                    }
                    const { customer, alreadyExists } = result;
                    registerCustomers([customer]);
                    refreshCustomerSelectors();
                    entryCustomerSelect.value = String(customer.id);
                    const message = alreadyExists
                        ? `Customer "${customer.name}" already exists and is ready to use.`
                        : `Customer "${customer.name}" created successfully.`;
                    setEntryFeedback(message, "success");
                } catch (error) {
                    console.error(error);
                    entryCustomerSelect.value = "";
                    setEntryFeedback(error?.message || "Unable to create customer.", "error");
                }
            });
        }

        if (entryForm) {
            if (entryDateInput) {
                const today = new Date().toISOString().split("T")[0];
                entryDateInput.value = today;
            }

            updateEntryTotal();

            if (entryUnitPriceInput) {
                entryUnitPriceInput.addEventListener("input", updateEntryTotal);
                entryUnitPriceInput.addEventListener("change", updateEntryTotal);
            }

            if (entryQuantityInput) {
                entryQuantityInput.addEventListener("input", updateEntryTotal);
                entryQuantityInput.addEventListener("change", updateEntryTotal);
            }

            entryForm.addEventListener("submit", async (event) => {
                event.preventDefault();

                if (!token) {
                    setEntryFeedback("You are not signed in.", "error");
                    return;
                }

                if (!entryCustomerSelect || !entryDateInput || !entryTypeSelect || !entryUnitPriceInput || !entryQuantityInput) {
                    setEntryFeedback("Sales entry form is not ready.", "error");
                    return;
                }

                const customerValue = entryCustomerSelect.value;
                if (!customerValue || customerValue === addCustomerOptionValue) {
                    setEntryFeedback("Please select a customer.", "error");
                    return;
                }

                const dateValue = entryDateInput.value;
                if (!dateValue) {
                    setEntryFeedback("Please choose a date.", "error");
                    return;
                }

                const unitPriceValue = Number(entryUnitPriceInput.value);
                const quantityValue = Number(entryQuantityInput.value);

                if (!Number.isFinite(unitPriceValue) || unitPriceValue < 0 || !Number.isFinite(quantityValue) || quantityValue < 0) {
                    setEntryFeedback("Enter valid unit price and quantity values.", "error");
                    return;
                }

                const payload = {
                    date: dateValue,
                    customer_id: Number(customerValue),
                    sale_type: entryTypeSelect.value,
                    unit_price: unitPriceValue,
                    quantity_tons: quantityValue,
                };

                setEntryFeedback("Saving sales entry…");
                if (entrySubmitButton) {
                    entrySubmitButton.disabled = true;
                }

                try {
                    const response = await fetch("/api/market/sales", {
                        method: "POST",
                        headers: {
                            Authorization: `Bearer ${token}`,
                            "Content-Type": "application/json",
                            Accept: "application/json",
                        },
                        body: JSON.stringify(payload),
                    });

                    if (response.status === 401) {
                        handleUnauthorized();
                        return;
                    }

                    const data = await response.json().catch(() => ({}));
                    if (!response.ok) {
                        throw new Error(data.msg || "Unable to save sales entry.");
                    }

                    setEntryFeedback("Sales entry recorded successfully.", "success");
                    if (entryUnitPriceInput) {
                        entryUnitPriceInput.value = "";
                    }
                    if (entryQuantityInput) {
                        entryQuantityInput.value = "";
                    }
                    updateEntryTotal();
                    await loadReport();
                } catch (error) {
                    console.error(error);
                    setEntryFeedback(error?.message || "Unable to save sales entry.", "error");
                } finally {
                    if (entrySubmitButton) {
                        entrySubmitButton.disabled = false;
                    }
                }
            });
        }

        refreshCustomerSelectors();
        loadCustomers();

        function renderCustomer(customer) {
            const card = document.createElement("article");
            card.className = "sales-report__customer";

            const header = document.createElement("div");
            header.className = "sales-report__customer-header";

            const headingWrapper = document.createElement("div");
            const nameEl = document.createElement("h3");
            nameEl.className = "sales-report__customer-name";
            nameEl.textContent = customer.customer_name;
            headingWrapper.appendChild(nameEl);

            const summaryEl = document.createElement("p");
            summaryEl.className = "sales-report__customer-summary";
            summaryEl.textContent = "Daily comparison of forecasted and actual sales.";
            headingWrapper.appendChild(summaryEl);

            const totals = document.createElement("dl");
            totals.className = "sales-report__totals";

            const variance = customer.monthly_actual_total - customer.monthly_forecast_total;
            const totalsConfig = [
                { label: "Forecast", value: customer.monthly_forecast_total },
                { label: "Actual", value: customer.monthly_actual_total },
                { label: "Variance", value: variance },
            ];

            totalsConfig.forEach(({ label, value }) => {
                const group = document.createElement("div");
                group.className = "sales-report__totals-item";
                const dt = document.createElement("dt");
                dt.textContent = label;
                const dd = document.createElement("dd");
                dd.textContent = formatAmount(value);
                dd.className = "sales-report__totals-value";
                if (label === "Variance") {
                    if (value > 0) {
                        dd.classList.add("sales-report__variance--positive");
                    } else if (value < 0) {
                        dd.classList.add("sales-report__variance--negative");
                    }
                }
                group.appendChild(dt);
                group.appendChild(dd);
                totals.appendChild(group);
            });

            header.appendChild(headingWrapper);
            header.appendChild(totals);
            card.appendChild(header);

            const table = document.createElement("table");
            table.className = "sales-report__table";

            const thead = document.createElement("thead");
            const headRow = document.createElement("tr");
            ["Date", "Forecast", "Actual", "Variance"].forEach((label, index) => {
                const th = document.createElement("th");
                th.textContent = label;
                if (index > 0) {
                    th.className = "sales-report__cell--numeric";
                }
                headRow.appendChild(th);
            });
            thead.appendChild(headRow);
            table.appendChild(thead);

            const tbody = document.createElement("tbody");

            if (!customer.dates.length) {
                const row = document.createElement("tr");
                const cell = document.createElement("td");
                cell.colSpan = 4;
                cell.className = "sales-report__empty-row";
                cell.textContent = "No sales recorded for this customer.";
                row.appendChild(cell);
                tbody.appendChild(row);
            } else {
                customer.dates.forEach((entry) => {
                    const row = document.createElement("tr");

                    const dateCell = document.createElement("td");
                    dateCell.textContent = entry.date;
                    row.appendChild(dateCell);

                    const forecastCell = document.createElement("td");
                    forecastCell.textContent = formatAmount(entry.forecast_amount);
                    forecastCell.className = "sales-report__cell--numeric";
                    row.appendChild(forecastCell);

                    const actualCell = document.createElement("td");
                    actualCell.textContent = formatAmount(entry.actual_amount);
                    actualCell.className = "sales-report__cell--numeric";
                    row.appendChild(actualCell);

                    const varianceValue = entry.actual_amount - entry.forecast_amount;
                    const varianceCell = document.createElement("td");
                    varianceCell.textContent = formatAmount(varianceValue);
                    varianceCell.className = "sales-report__cell--numeric";
                    if (varianceValue > 0) {
                        varianceCell.classList.add("sales-report__variance--positive");
                    } else if (varianceValue < 0) {
                        varianceCell.classList.add("sales-report__variance--negative");
                    }
                    row.appendChild(varianceCell);

                    tbody.appendChild(row);
                });
            }

            table.appendChild(tbody);
            card.appendChild(table);
            return card;
        }

        function renderReport(data) {
            if (!resultsEl) {
                return;
            }

            resultsEl.innerHTML = "";
            if (!data || !Array.isArray(data.customers) || data.customers.length === 0) {
                const empty = document.createElement("p");
                empty.className = "sales-report__empty";
                empty.textContent = "No sales data available for the selected period.";
                resultsEl.appendChild(empty);
                return;
            }

            const container = document.createElement("div");
            container.className = "sales-report__customers";

            data.customers.forEach((customer) => {
                container.appendChild(renderCustomer(customer));
            });

            resultsEl.appendChild(container);
        }

        function populateSelectors() {
            if (!monthSelect || !yearSelect) {
                return;
            }

            const now = new Date();
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();

            monthNames.forEach((name, index) => {
                const option = document.createElement("option");
                option.value = String(index + 1);
                option.textContent = name;
                monthSelect.appendChild(option);
            });

            const startYear = currentYear - 2;
            const endYear = currentYear + 1;
            for (let year = endYear; year >= startYear; year -= 1) {
                const option = document.createElement("option");
                option.value = String(year);
                option.textContent = String(year);
                yearSelect.appendChild(option);
            }

            monthSelect.value = String(currentMonth);
            yearSelect.value = String(currentYear);
            updateSubtitle(currentYear, currentMonth);
        }

        async function loadReport() {
            if (!token || !monthSelect || !yearSelect || !submitButton || !resultsEl) {
                return;
            }

            const year = yearSelect.value;
            const month = monthSelect.value;

            updateSubtitle(year, month);
            setFeedback("Loading customer sales…", "info");
            resultsEl.innerHTML = '<p class="sales-report__loading">Loading report…</p>';

            submitButton.disabled = true;

            try {
                const params = new URLSearchParams({
                    year: String(year),
                    month: String(month),
                });
                if (customerSelect && customerSelect.value) {
                    params.append("customer_id", customerSelect.value);
                }

                const response = await fetch(`/api/reports/customer-sales?${params.toString()}`, {
                    headers: {
                        Authorization: `Bearer ${token}`,
                        Accept: "application/json",
                    },
                });

                if (response.status === 401) {
                    handleUnauthorized();
                    return;
                }

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ msg: "Unable to load report" }));
                    throw new Error(errorData.msg || "Unable to load report");
                }

                const data = await response.json();
                updateCustomerOptions(data.customers || []);
                renderReport(data);

                if (data.customers && data.customers.length > 0) {
                    const totalCustomers = data.customers.length;
                    setFeedback(
                        `Showing sales data for ${totalCustomers} ${totalCustomers === 1 ? "customer" : "customers"}.`,
                        "success",
                    );
                } else {
                    setFeedback("No sales data recorded for the selected period.", "info");
                }
            } catch (error) {
                console.error(error);
                resultsEl.innerHTML = "";
                const errorMessage = error?.message || "Unable to load report.";
                setFeedback(errorMessage, "error");
            } finally {
                submitButton.disabled = false;
            }
        }

        if (reportForm) {
            populateSelectors();
            reportForm.addEventListener("submit", (event) => {
                event.preventDefault();
                loadReport();
            });
            loadReport();
        }
    </script>
</body>
</html>
