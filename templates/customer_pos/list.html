<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Customer POs | SAMPROX ERP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" />
</head>
<body>
    <div class="page">
        <header class="topbar">
            <div class="brand">
                <div class="brand__logo">S</div>
                <div class="brand__details">
                    <p class="brand__name">SAMPROX ERP</p>
                    <p class="brand__section">Market | Customer POs</p>
                </div>
            </div>
            <div class="topbar__actions">
                <a class="button button--ghost" href="{{ url_for('ui.market_page') }}">Back to Market</a>
            </div>
        </header>
        <section class="section">
            <header class="section__header">
                <div>
                    <h1>Customer Purchase Orders</h1>
                    <p class="section__description">Track customer purchase orders, delivery status, and outstanding balances.</p>
                </div>
                <a class="button" href="{{ url_for('customer_pos.new_purchase_order') }}">Create Customer PO</a>
            </header>
            <article class="production-card">
                <header class="production-card__header">
                    <div>
                        <h2>Filters</h2>
                        <p class="sales-entry__subtitle">Narrow the list by customer, status, or date range.</p>
                    </div>
                </header>
                <form class="sales-report__controls" method="get">
                    <label class="sales-report__field" for="date_from">
                        <span class="sales-report__label">Date from</span>
                        <input id="date_from" name="date_from" type="date" class="sales-report__input" value="{{ request.args.get('date_from', '') }}" />
                    </label>
                    <label class="sales-report__field" for="date_to">
                        <span class="sales-report__label">Date to</span>
                        <input id="date_to" name="date_to" type="date" class="sales-report__input" value="{{ request.args.get('date_to', '') }}" />
                    </label>
                    <label class="sales-report__field" for="customer_id">
                        <span class="sales-report__label">Customer</span>
                        <select id="customer_id" name="customer_id" class="sales-report__input">
                            <option value="">All customers</option>
                            {% for customer in customers %}
                                <option value="{{ customer.id }}" {% if request.args.get('customer_id')|int == customer.id %}selected{% endif %}>{{ customer.name }}</option>
                            {% endfor %}
                        </select>
                    </label>
                    <label class="sales-report__field" for="status">
                        <span class="sales-report__label">Status</span>
                        <select id="status" name="status" class="sales-report__input">
                            <option value="">All statuses</option>
                            {% for status in statuses %}
                                <option value="{{ status.value }}" {% if request.args.get('status') == status.value %}selected{% endif %}>{{ status.value }}</option>
                            {% endfor %}
                        </select>
                    </label>
                    <div class="sales-report__actions">
                        <button type="submit" class="button">Filter</button>
                        <a class="button button--ghost" href="{{ url_for('customer_pos.list_purchase_orders') }}">Reset</a>
                    </div>
                </form>
            </article>
            <article class="production-card sales-report" aria-labelledby="po-list-title">
                <header class="production-card__header">
                    <div>
                        <h2 id="po-list-title">Purchase order list</h2>
                        <p class="sales-report__subtitle">Sorted by most recent orders first.</p>
                    </div>
                </header>
                <div class="table-container sales-admin__table-container">
                    <table class="sales-admin__table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>PO Number</th>
                                <th>Customer</th>
                                <th>Customer Ref</th>
                                <th>Delivery Date</th>
                                <th>Status</th>
                                <th class="text-end">Grand Total</th>
                                <th class="sales-admin__actions-header">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in orders %}
                                <tr>
                                    <td>{{ order.po_date.strftime('%Y-%m-%d') if order.po_date else '' }}</td>
                                    <td>{{ order.po_number }}</td>
                                    <td>{{ order.customer.name if order.customer else '' }}</td>
                                    <td>{{ order.customer_reference or '-' }}</td>
                                    <td>{{ order.delivery_date.strftime('%Y-%m-%d') if order.delivery_date else '-' }}</td>
                                    <td>
                                        {% set badge_class = {
                                            'Draft': 'badge--secondary',
                                            'Confirmed': 'badge--primary',
                                            'Partially Delivered': 'badge--warning',
                                            'Fully Delivered': 'badge--success',
                                            'Cancelled': 'badge--danger'
                                        }[order.status.value if order.status else 'Draft'] %}
                                        <span class="badge {{ badge_class }}">{{ order.status.value if order.status else 'Draft' }}</span>
                                    </td>
                                    <td class="text-end">{{ '{:,.2f}'.format(order.grand_total or 0) }}</td>
                                    <td class="sales-admin__actions">
                                        <a class="button button--ghost button--small" href="{{ url_for('customer_pos.edit_purchase_order', po_id=order.id) }}">View / Edit</a>
                                        <form class="inline-form" action="{{ url_for('customer_pos.update_purchase_order_status', po_id=order.id) }}" method="post">
                                            <select name="status" class="sales-report__input sales-report__input--compact">
                                                {% for status in statuses %}
                                                    <option value="{{ status.value }}" {% if order.status == status %}selected{% endif %}>{{ status.value }}</option>
                                                {% endfor %}
                                            </select>
                                            <button type="submit" class="button button--ghost button--small">Change</button>
                                        </form>
                                        <form class="inline-form" action="{{ url_for('customer_pos.delete_purchase_order', po_id=order.id) }}" method="post" onsubmit="return confirm('Delete this PO?');">
                                            <button type="submit" class="button button--secondary button--small">Delete</button>
                                        </form>
                                    </td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="8" class="text-center">No purchase orders found.</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </article>
        </section>
    </div>
</body>
</html>
