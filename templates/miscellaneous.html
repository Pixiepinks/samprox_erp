<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Miscellaneous | SAMPROX ERP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" />
</head>
<body>
    <div class="page">
        <header class="topbar">
            <div class="brand">
                <div class="brand__logo">S</div>
                <div class="brand__details">
                    <p class="brand__name">SAMPROX ERP</p>
                    <p class="brand__section">Miscellaneous Overview</p>
                </div>
            </div>
            <div class="topbar__actions">
                <a class="button button--ghost" href="{{ url_for('ui.mind_page') }}">Mind</a>
                <div class="user-summary">
                    <span class="user-summary__name" id="user-name"></span>
                    <span class="user-summary__role" id="user-role"></span>
                </div>
                <button type="button" class="button button--secondary" id="logout">Sign out</button>
            </div>
        </header>
        <nav class="subnav" aria-label="7M navigation">
            <a class="subnav__link" href="{{ url_for('ui.mind_page') }}">Mind</a>
            <a class="subnav__link" href="{{ url_for('ui.man_page') }}">Man</a>
            <a class="subnav__link" href="{{ url_for('ui.machines_page') }}">Machine</a>
            <a class="subnav__link" href="{{ url_for('ui.material_page') }}">Material</a>
            <a class="subnav__link" href="{{ url_for('ui.market_page') }}">Market</a>
            <a class="subnav__link" href="{{ url_for('ui.manufacturing_page') }}">Manufacturing</a>
            <a class="subnav__link" href="{{ url_for('ui.movers_page') }}">Movers</a>
            <a class="subnav__link" href="{{ url_for('ui.money_page') }}">Money</a>
            <a class="subnav__link subnav__link--active" href="{{ url_for('ui.miscellaneous_page') }}">Miscellaneous</a>
            <a
                class="subnav__link"
                href="{{ url_for('ui.mechanism_page') }}"
                id="mechanism-link"
                hidden
            >Mechanism</a>
        </nav>
        <section class="section">
            <header class="section__header">
                <h1>Miscellaneous workspace</h1>
            </header>
            <p class="section__description">
                Capture the extras that don’t fit neatly into the other modules—internal notes, quick references,
                and one-off tasks that keep operations moving.
            </p>
            <div class="section__grid">
                <article class="tile misc-tile" id="dealersTile" role="button" tabindex="0" aria-pressed="false">
                    <h2 class="tile__title">Dealers</h2>
                    <p class="tile__description">
                        View and manage all the dealers.
                    </p>
                </article>
                <article class="tile misc-tile" id="bulkDealersTile" role="button" tabindex="0" aria-pressed="false">
                    <h2 class="tile__title">Bulk Updation</h2>
                    <p class="tile__description">
                        Bulk create Dealers (Non-Samprox customers) via CSV upload.
                    </p>
                </article>
                <article class="tile">
                    <h2 class="tile__title">Reference links</h2>
                    <p class="tile__description">
                        Centralize helpful resources, SOPs, or checklists for fast access in daily standups.
                    </p>
                </article>
                <article class="tile">
                    <h2 class="tile__title">Action items</h2>
                    <p class="tile__description">
                        Track unplanned follow-ups and make sure nothing slips through the cracks between teams.
                    </p>
                </article>
                <article class="tile">
                    <h2 class="tile__title">Parking lot ideas</h2>
                    <p class="tile__description">
                        Collect future improvements and experiments before promoting them into a dedicated module.
                    </p>
                </article>
            </div>
        </section>
    </div>
    <div id="dealersModal" class="fullscreen-modal hidden" role="dialog" aria-modal="true" aria-labelledby="dealersModalTitle">
        <div class="fullscreen-modal__backdrop"></div>
        <div class="fullscreen-modal__dialog">
            <header class="fullscreen-modal__header">
                <h2 id="dealersModalTitle">Dealers</h2>
                <button type="button" class="fullscreen-modal__close" aria-label="Close dealers list">✖</button>
            </header>
            <div class="fullscreen-modal__body">
                <div class="fullscreen-modal__table-wrapper" id="dealersTableWrapper">
                    <div id="dealersLoading" class="fullscreen-modal__status">Loading dealers…</div>
                    <div id="dealersError" class="fullscreen-modal__status fullscreen-modal__status--error hidden">
                        Unable to load dealers. Please try again.
                    </div>
                    <table class="dealers-table hidden" aria-describedby="dealersModalTitle">
                        <thead>
                            <tr>
                                <th scope="col">customer_code</th>
                                <th scope="col">customer_name</th>
                                <th scope="col">area_code</th>
                                <th scope="col">city</th>
                                <th scope="col">district</th>
                                <th scope="col">province</th>
                                <th scope="col">managed_by</th>
                                <th scope="col">company</th>
                            </tr>
                        </thead>
                        <tbody id="dealersTableBody"></tbody>
                    </table>
                </div>
            </div>
            <footer class="fullscreen-modal__footer">
                <button type="button" class="button fullscreen-modal__footer-close" data-close-modal>Close</button>
            </footer>
        </div>
    </div>
    <div id="bulkDealersModal" class="fullscreen-modal hidden" role="dialog" aria-modal="true" aria-labelledby="bulkDealersModalTitle">
        <div class="fullscreen-modal__backdrop"></div>
        <div class="fullscreen-modal__dialog fullscreen-modal__dialog--wide">
            <header class="fullscreen-modal__header">
                <h2 id="bulkDealersModalTitle">Bulk Updation — Dealers</h2>
                <button type="button" class="fullscreen-modal__close" aria-label="Close bulk upload">✖</button>
            </header>
            <div class="fullscreen-modal__body">
                <div class="bulk-modal__controls">
                    <label class="bulk-modal__field">
                        <span class="bulk-modal__label">Company <span class="bulk-modal__required">*</span></span>
                        <select id="bulkCompanySelect" class="edit-form__input">
                            <option value="">Select company</option>
                        </select>
                    </label>
                    <label class="bulk-modal__field bulk-modal__toggle">
                        <input type="checkbox" id="bulkStrictMode" />
                        <span>Strict mode (fail all if any error)</span>
                    </label>
                    <button type="button" class="button button--ghost" id="downloadBulkTemplate">
                        Download template
                    </button>
                </div>
                <div class="bulk-modal__upload">
                    <label class="bulk-modal__field bulk-modal__upload-field">
                        <span class="bulk-modal__label">CSV file <span class="bulk-modal__required">*</span></span>
                        <input type="file" id="bulkFileInput" accept=".csv" />
                    </label>
                    <div class="bulk-modal__actions">
                        <button type="button" class="button button--secondary" id="validateBulkBtn">Validate</button>
                        <button type="button" class="button button--primary" id="importBulkBtn">Import</button>
                        <button type="button" class="button button--ghost" data-close-modal>Cancel</button>
                    </div>
                </div>
                <div id="bulkStatus" class="fullscreen-modal__status hidden"></div>
                <div id="bulkError" class="fullscreen-modal__status fullscreen-modal__status--error hidden"></div>
                <div class="bulk-modal__summary hidden" id="bulkSummary">
                    <p class="bulk-modal__summary-title">Import summary</p>
                    <div class="bulk-modal__summary-grid">
                        <div class="bulk-modal__summary-item">
                            <p class="bulk-modal__summary-label">Inserted</p>
                            <p class="bulk-modal__summary-value" id="bulkInsertedCount">0</p>
                        </div>
                        <div class="bulk-modal__summary-item">
                            <p class="bulk-modal__summary-label">Failed</p>
                            <p class="bulk-modal__summary-value" id="bulkFailedCount">0</p>
                        </div>
                        <div class="bulk-modal__summary-item">
                            <p class="bulk-modal__summary-label">Generated codes</p>
                            <p class="bulk-modal__summary-value" id="bulkGeneratedCount">0</p>
                        </div>
                    </div>
                    <button type="button" class="button button--ghost hidden" id="downloadErrorReport">
                        Download error report CSV
                    </button>
                </div>
                <div class="fullscreen-modal__table-wrapper bulk-modal__preview hidden" id="bulkPreviewWrapper">
                    <table class="dealers-table" aria-describedby="bulkDealersModalTitle">
                        <thead>
                            <tr>
                                <th scope="col">Row</th>
                                <th scope="col">customer_code</th>
                                <th scope="col">customer_name</th>
                                <th scope="col">area_code</th>
                                <th scope="col">city</th>
                                <th scope="col">district</th>
                                <th scope="col">province</th>
                                <th scope="col">managed_by</th>
                                <th scope="col">Error</th>
                            </tr>
                        </thead>
                        <tbody id="bulkPreviewBody"></tbody>
                    </table>
                </div>
            </div>
            <footer class="fullscreen-modal__footer">
                <button type="button" class="button fullscreen-modal__footer-close" data-close-modal>Close</button>
            </footer>
        </div>
    </div>
    <script>
        const token = localStorage.getItem("samprox_token");
        const userRaw = localStorage.getItem("samprox_user");
        let user;

        try {
            user = userRaw ? JSON.parse(userRaw) : null;
        } catch (_) {
            user = null;
        }

        if (!token || !user) {
            window.location.href = "/";
        }

        if (user?.role === "outside_manager" && window.location.pathname !== "/responsibility_portal") {
            window.location.replace("/responsibility_portal");
        }

        if (user?.role === "maintenance_manager" && window.location.pathname !== "/machines") {
            window.location.replace("/machines");
        }

        const roleLabels = {
            admin: "Admin",
            production_manager: "Production Manager",
            maintenance_manager: "Maintenance Manager",
            finance_manager: "Finance Manager",
            technician: "Technician",
            outside_manager: "Member Of Rainbow Group",
        };

        const userNameEl = document.getElementById("user-name");
        const userRoleEl = document.getElementById("user-role");
        const logoutButton = document.getElementById("logout");
        const mechanismLink = document.getElementById("mechanism-link");

        userNameEl.textContent = user?.name || "Unknown";
        userRoleEl.textContent = roleLabels[user?.role] || "";
        if (mechanismLink) {
            if (user?.role === "admin") {
                mechanismLink.hidden = false;
            } else {
                mechanismLink.remove();
            }
        }

        logoutButton.addEventListener("click", async () => {
            try {
                await fetch("/api/auth/logout", { method: "POST", credentials: "include" });
            } catch (error) {
                console.error("Failed to log out", error);
            } finally {
                localStorage.removeItem("samprox_token");
                localStorage.removeItem("samprox_user");
                window.location.href = "/";
            }
        });

        const dealersTile = document.getElementById("dealersTile");
        const dealersModal = document.getElementById("dealersModal");
        const dealersCloseButtons = dealersModal.querySelectorAll(".fullscreen-modal__close, [data-close-modal]");
        const dealersLoading = document.getElementById("dealersLoading");
        const dealersError = document.getElementById("dealersError");
        const dealersTable = dealersModal.querySelector(".dealers-table");
        const dealersTableBody = document.getElementById("dealersTableBody");
        let dealersLoaded = false;
        let dealersCache = [];

        const toggleScrollLock = (locked) => {
            if (locked) {
                document.body.classList.add("modal-open");
            } else {
                document.body.classList.remove("modal-open");
            }
        };

        const closeDealersModal = () => {
            dealersModal.classList.add("hidden");
            toggleScrollLock(false);
        };

        const renderDealers = (records = []) => {
            dealersTableBody.innerHTML = "";
            const safeValue = (value) => (value ?? value === 0 ? value : "—");

            records.forEach((dealer) => {
                const row = document.createElement("tr");
                [
                    "customer_code",
                    "customer_name",
                    "area_code",
                    "city",
                    "district",
                    "province",
                    "managed_by",
                    "company",
                ].forEach((key) => {
                    const cell = document.createElement("td");
                    cell.textContent = safeValue(dealer[key]);
                    row.appendChild(cell);
                });
                dealersTableBody.appendChild(row);
            });
        };

        const showDealersModal = async () => {
            dealersModal.classList.remove("hidden");
            toggleScrollLock(true);
            if (dealersLoaded) return;

            dealersLoading.classList.remove("hidden");
            dealersError.classList.add("hidden");
            dealersTable.classList.add("hidden");

            try {
                const response = await fetch("/api/dealers", {
                    headers: { Authorization: `Bearer ${token}` },
                });
                if (!response.ok) {
                    throw new Error(`Request failed: ${response.status}`);
                }
                const data = await response.json();
                dealersCache = Array.isArray(data) ? data : data?.data || [];
                renderDealers(dealersCache);
                dealersLoaded = true;
                dealersTable.classList.remove("hidden");
            } catch (error) {
                console.error("Failed to load dealers", error);
                dealersError.classList.remove("hidden");
            } finally {
                dealersLoading.classList.add("hidden");
            }
        };

        dealersTile.addEventListener("click", showDealersModal);
        dealersTile.addEventListener("keydown", (event) => {
            if (event.key === "Enter" || event.key === " ") {
                event.preventDefault();
                showDealersModal();
            }
        });

        dealersCloseButtons.forEach((button) => {
            button.addEventListener("click", closeDealersModal);
        });

        dealersModal.addEventListener("click", (event) => {
            if (event.target === dealersModal || event.target.classList.contains("fullscreen-modal__backdrop")) {
                closeDealersModal();
            }
        });

        const bulkDealersTile = document.getElementById("bulkDealersTile");
        const bulkDealersModal = document.getElementById("bulkDealersModal");
        const bulkCloseButtons = bulkDealersModal.querySelectorAll(".fullscreen-modal__close, [data-close-modal]");
        const bulkCompanySelect = document.getElementById("bulkCompanySelect");
        const bulkStrictMode = document.getElementById("bulkStrictMode");
        const bulkFileInput = document.getElementById("bulkFileInput");
        const bulkPreviewBody = document.getElementById("bulkPreviewBody");
        const bulkStatus = document.getElementById("bulkStatus");
        const bulkError = document.getElementById("bulkError");
        const bulkSummary = document.getElementById("bulkSummary");
        const bulkInsertedCount = document.getElementById("bulkInsertedCount");
        const bulkFailedCount = document.getElementById("bulkFailedCount");
        const bulkGeneratedCount = document.getElementById("bulkGeneratedCount");
        const downloadTemplateBtn = document.getElementById("downloadBulkTemplate");
        const downloadErrorReportBtn = document.getElementById("downloadErrorReport");
        const validateBulkBtn = document.getElementById("validateBulkBtn");
        const importBulkBtn = document.getElementById("importBulkBtn");
        const bulkPreviewWrapper = document.getElementById("bulkPreviewWrapper");
        const allowedBulkRoles = ["admin", "finance_manager", "production_manager"];
        let errorReportToken = null;

        const hideBulkForUnauthorized = () => {
            if (!allowedBulkRoles.includes(user?.role)) {
                bulkDealersTile?.remove();
                bulkDealersModal?.remove();
            }
        };

        hideBulkForUnauthorized();

        const resetBulkState = () => {
            bulkStatus.classList.add("hidden");
            bulkError.classList.add("hidden");
            bulkStatus.textContent = "";
            bulkError.textContent = "";
            bulkSummary.classList.add("hidden");
            bulkInsertedCount.textContent = "0";
            bulkFailedCount.textContent = "0";
            bulkGeneratedCount.textContent = "0";
            downloadErrorReportBtn.classList.add("hidden");
            errorReportToken = null;
            bulkPreviewBody.innerHTML = "";
            bulkPreviewWrapper.classList.add("hidden");
        };

        const loadCompanies = async () => {
            try {
                const resp = await fetch("/api/companies", { headers: { Authorization: `Bearer ${token}` } });
                if (!resp.ok) throw new Error(`Failed to load companies: ${resp.status}`);
                const payload = await resp.json();
                const data = Array.isArray(payload) ? payload : payload?.data || [];
                bulkCompanySelect.innerHTML = '<option value=\"\">Select company</option>';
                data.forEach((company) => {
                    const option = document.createElement("option");
                    option.value = company.id;
                    option.textContent = company.name;
                    bulkCompanySelect.appendChild(option);
                });
            } catch (error) {
                console.error(error);
                bulkError.textContent = "Unable to load companies. Please retry.";
                bulkError.classList.remove("hidden");
            }
        };

        const openBulkModal = async () => {
            if (!allowedBulkRoles.includes(user?.role)) return;
            resetBulkState();
            bulkDealersModal.classList.remove("hidden");
            toggleScrollLock(true);
            await loadCompanies();
        };

        const closeBulkModal = () => {
            bulkDealersModal.classList.add("hidden");
            toggleScrollLock(false);
        };

        const renderPreview = (rows = []) => {
            bulkPreviewBody.innerHTML = "";
            rows.forEach((row) => {
                const tr = document.createElement("tr");
                if (row.error) {
                    tr.classList.add("bulk-row--error");
                }
                const cells = [
                    row.row_number,
                    row.customer_code || "",
                    row.customer_name || "",
                    row.area_code || "",
                    row.city || "",
                    row.district || "",
                    row.province || "",
                    row.managed_by || "",
                    row.error || "",
                ];
                cells.forEach((value) => {
                    const td = document.createElement("td");
                    td.textContent = value ?? "";
                    tr.appendChild(td);
                });
                bulkPreviewBody.appendChild(tr);
            });
            bulkPreviewWrapper.classList.remove("hidden");
        };

        const downloadTemplate = () => {
            window.open("/api/dealers/bulk-template", "_blank");
        };

        const validateBulk = async () => {
            resetBulkState();
            const companyId = bulkCompanySelect.value;
            if (!companyId) {
                bulkError.textContent = "Please select a company.";
                bulkError.classList.remove("hidden");
                return;
            }
            const file = bulkFileInput.files?.[0];
            if (!file) {
                bulkError.textContent = "Please choose a CSV file to validate.";
                bulkError.classList.remove("hidden");
                return;
            }
            const formData = new FormData();
            formData.append("company_id", companyId);
            formData.append("file", file);
            bulkStatus.textContent = "Validating file…";
            bulkStatus.classList.remove("hidden");
            try {
                const resp = await fetch("/api/dealers/bulk-validate", {
                    method: "POST",
                    headers: { Authorization: `Bearer ${token}` },
                    body: formData,
                });
                const payload = await resp.json();
                if (!resp.ok || !payload?.ok) {
                    const errors = payload?.errors?.join?.(", ") || payload?.error || "Validation failed.";
                    throw new Error(errors);
                }
                const rows = payload.data?.rows || [];
                renderPreview(rows);
                bulkStatus.textContent = `Validation complete — Valid: ${payload.data.valid_count}, Failed: ${payload.data.failed_count}`;
            } catch (error) {
                bulkStatus.classList.add("hidden");
                bulkError.textContent = error.message || "Validation failed.";
                bulkError.classList.remove("hidden");
            }
        };

        const importBulk = async () => {
            resetBulkState();
            const companyId = bulkCompanySelect.value;
            if (!companyId) {
                bulkError.textContent = "Please select a company.";
                bulkError.classList.remove("hidden");
                return;
            }
            const file = bulkFileInput.files?.[0];
            if (!file) {
                bulkError.textContent = "Please choose a CSV file to import.";
                bulkError.classList.remove("hidden");
                return;
            }
            const formData = new FormData();
            formData.append("company_id", companyId);
            formData.append("file", file);
            formData.append("strict_mode", bulkStrictMode.checked ? "true" : "false");
            bulkStatus.textContent = "Importing dealers…";
            bulkStatus.classList.remove("hidden");
            try {
                const resp = await fetch("/api/dealers/bulk-import", {
                    method: "POST",
                    headers: { Authorization: `Bearer ${token}` },
                    body: formData,
                });
                const payload = await resp.json();
                if (!resp.ok || !payload?.ok) {
                    const message = payload?.error || "Import failed.";
                    if (payload?.error_report_token) {
                        errorReportToken = payload.error_report_token;
                        downloadErrorReportBtn.classList.remove("hidden");
                    }
                    throw new Error(message);
                }
                const data = payload.data || {};
                bulkInsertedCount.textContent = data.inserted_count ?? 0;
                bulkFailedCount.textContent = data.failed_count ?? 0;
                bulkGeneratedCount.textContent = data.generated_codes_count ?? 0;
                errorReportToken = data.error_report_token;
                if (errorReportToken) {
                    downloadErrorReportBtn.classList.remove("hidden");
                }
                bulkSummary.classList.remove("hidden");
                bulkStatus.textContent = "Import completed.";
                if (Array.isArray(data.failed_rows)) {
                    renderPreview(data.failed_rows);
                }
                dealersLoaded = false;
            } catch (error) {
                bulkStatus.classList.add("hidden");
                bulkError.textContent = error.message || "Import failed.";
                bulkError.classList.remove("hidden");
            }
        };

        const downloadErrorReport = () => {
            if (!errorReportToken) return;
            window.open(`/api/dealers/bulk-error-report/${errorReportToken}`, "_blank");
        };

        bulkDealersTile?.addEventListener("click", openBulkModal);
        bulkDealersTile?.addEventListener("keydown", (event) => {
            if (event.key === "Enter" || event.key === " ") {
                event.preventDefault();
                openBulkModal();
            }
        });

        bulkCloseButtons.forEach((button) => {
            button.addEventListener("click", closeBulkModal);
        });

        bulkDealersModal?.addEventListener("click", (event) => {
            if (event.target === bulkDealersModal || event.target.classList.contains("fullscreen-modal__backdrop")) {
                closeBulkModal();
            }
        });

        downloadTemplateBtn?.addEventListener("click", downloadTemplate);
        downloadErrorReportBtn?.addEventListener("click", downloadErrorReport);
        validateBulkBtn?.addEventListener("click", validateBulk);
        importBulkBtn?.addEventListener("click", importBulk);

        window.addEventListener("keydown", (event) => {
            if (event.key === "Escape") {
                if (!dealersModal.classList.contains("hidden")) {
                    closeDealersModal();
                }
                if (bulkDealersModal && !bulkDealersModal.classList.contains("hidden")) {
                    closeBulkModal();
                }
            }
        });
    </script>
</body>
</html>
