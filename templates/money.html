<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Money | SAMPROX ERP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" />
</head>
<body data-active-tab="{{ active_tab or 'overview' }}">
    <div class="page">
        <header class="topbar">
            <div class="brand">
                <div class="brand__logo">S</div>
                <div class="brand__details">
                    <p class="brand__name">SAMPROX ERP</p>
                    <p class="brand__section">Money Overview</p>
                </div>
            </div>
            <div class="topbar__actions">
                <a class="button button--ghost" href="{{ url_for('ui.mind_page') }}">Mind</a>
                <div class="user-summary">
                    <span class="user-summary__name" id="user-name"></span>
                    <span class="user-summary__role" id="user-role"></span>
                </div>
                <button type="button" class="button button--secondary" id="logout">Sign out</button>
            </div>
        </header>
        <nav class="subnav" aria-label="7M navigation">
            <a class="subnav__link" href="{{ url_for('ui.mind_page') }}">Mind</a>
            <a class="subnav__link" href="{{ url_for('ui.man_page') }}">Man</a>
            <a class="subnav__link" href="{{ url_for('ui.machines_page') }}">Machine</a>
            <a class="subnav__link" href="{{ url_for('ui.material_page') }}">Material</a>
            <a class="subnav__link" href="{{ url_for('ui.market_page') }}">Market</a>
            <a class="subnav__link" href="{{ url_for('ui.manufacturing_page') }}">Manufacturing</a>
            <a class="subnav__link" href="{{ url_for('ui.movers_page') }}">Movers</a>
            <a class="subnav__link subnav__link--active" href="{{ url_for('ui.money_page') }}">Money</a>
            <a
                class="subnav__link"
                href="{{ url_for('ui.mechanism_page') }}"
                id="mechanism-link"
                hidden
            >Mechanism</a>
        </nav>
        <section class="section">
            {% set current_tab = active_tab or 'overview' %}
            <div class="tab-switcher" role="tablist" aria-label="Money sections">
                <button
                    class="tab-switcher__button {% if current_tab == 'overview' %}tab-switcher__button--active{% endif %}"
                    data-tab="overview"
                    role="tab"
                    aria-selected="{{ 'true' if current_tab == 'overview' else 'false' }}"
                >
                    Overview
                </button>
                <button
                    class="tab-switcher__button {% if current_tab == 'petty-cash' %}tab-switcher__button--active{% endif %}"
                    data-tab="petty-cash"
                    role="tab"
                    aria-selected="{{ 'true' if current_tab == 'petty-cash' else 'false' }}"
                >
                    Petty Cash
                </button>
                <button
                    class="tab-switcher__button {% if current_tab == 'financials' %}tab-switcher__button--active{% endif %}"
                    data-tab="financials"
                    role="tab"
                    aria-selected="{{ 'true' if current_tab == 'financials' else 'false' }}"
                >
                    Financials
                </button>
            </div>

            <div class="tab-panel {% if current_tab == 'overview' %}tab-panel--active{% endif %}" id="tab-overview" role="tabpanel" aria-label="Financial overview">
                <header class="section__header">
                    <h1>Financial performance snapshot</h1>
                </header>
                <p class="section__description">
                    Connect operations with finance by monitoring budgets, spending, and cash flow. Use the
                    insights here to control costs and prioritize high-value work.
                </p>
                <div class="section__grid">
                    <article class="tile">
                        <h2 class="tile__title">Budget vs. actual</h2>
                        <p class="tile__description">
                            Compare planned spending against actuals across departments and job types.
                        </p>
                    </article>
                    <article class="tile">
                        <h2 class="tile__title">Job costing</h2>
                        <p class="tile__description">
                            Track labour, material, and machine time consumption to understand job margins.
                        </p>
                    </article>
                    <article class="tile">
                        <h2 class="tile__title">Cash flow outlook</h2>
                        <p class="tile__description">
                            Review upcoming receivables and payables to plan funding and investments.
                        </p>
                    </article>
                    <article class="tile">
                        <h2 class="tile__title">Capital planning</h2>
                        <p class="tile__description">
                            Highlight equipment upgrades and large purchases to align with financial targets.
                        </p>
                    </article>
                </div>
            </div>

            <div class="tab-panel {% if current_tab == 'petty-cash' %}tab-panel--active{% endif %}" id="tab-petty-cash" role="tabpanel" aria-label="Petty cash weekly travel claims">
                <header class="section__header">
                    <div>
                        <p class="eyebrow">New</p>
                        <h1>Petty Cash – Weekly Travel Claims</h1>
                        <p class="section__description">
                            Capture weekly travel expenses directly inside the table. Edit each weekday cell inline and keep totals in sync automatically.
                        </p>
                    </div>
                    <div class="status-pill" id="petty-status">Draft</div>
                </header>

                <div class="petty-card">
                    <div class="form-grid">
                        <label class="form-field">
                            <span>Company</span>
                            <select id="petty-company"></select>
                        </label>
                        <label class="form-field">
                            <span>Employee</span>
                            <select id="petty-employee"></select>
                        </label>
                        <label class="form-field">
                            <span>Week starting</span>
                            <input id="petty-week-start" type="date" />
                        </label>
                        <label class="form-field">
                            <span>Week ending</span>
                            <input id="petty-week-end" type="date" readonly />
                        </label>
                        <label class="form-field">
                            <span>Sheet No</span>
                            <input id="petty-sheet" type="text" readonly />
                        </label>
                        <label class="form-field">
                            <span>Vehicle No</span>
                            <input id="petty-vehicle" type="text" placeholder="Enter vehicle number" />
                        </label>
                        <label class="form-field form-field--wide">
                            <span>Area visited</span>
                            <textarea id="petty-area" rows="2" placeholder="Enter locations covered"></textarea>
                        </label>
                    </div>

                    <div class="petty-table-wrapper">
                        <table class="petty-table">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Expense Type</th>
                                    <th>MON</th>
                                    <th>TUE</th>
                                    <th>WED</th>
                                    <th>THU</th>
                                    <th>FRI</th>
                                    <th>SAT</th>
                                    <th>SUN</th>
                                    <th>TOTAL</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="petty-lines"></tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="9" class="total-label">TOTAL EXPENSES</td>
                                    <td colspan="2" class="total-value" id="petty-total">0.00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div class="petty-toolbar">
                        <button class="button button--ghost" id="petty-add-row">+ Add Row</button>
                        <div class="petty-actions">
                            <button class="button button--secondary" id="petty-save">Save Draft</button>
                            <button class="button" id="petty-submit">Submit for Approval</button>
                            <button class="button" id="petty-approve">Approve</button>
                            <button class="button button--danger" id="petty-reject">Reject</button>
                            <button class="button" id="petty-paid">Mark as Paid</button>
                        </div>
                    </div>
                    <p class="helper-text" id="petty-helper">Click any weekday cell to enter an amount. Empty cells are treated as 0.</p>
                    <p class="helper-text helper-text--error" id="petty-error" hidden></p>
                </div>
            </div>

            <div class="tab-panel {% if current_tab == 'financials' %}tab-panel--active{% endif %}" id="tab-financials" role="tabpanel" aria-label="Financial statements capture">
                <header class="section__header">
                    <div>
                        <p class="eyebrow">New</p>
                        <h1>Financial Statements</h1>
                        <p class="section__description">
                            Capture IFRS-format financial statements for each company or view the consolidated group.
                            Enter monthly amounts for the April–March financial year.
                        </p>
                    </div>
                </header>

                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        <div class="alert-stack">
                            {% for category, message in messages %}
                                <div class="alert alert--{{ category }}">{{ message }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endwith %}

                <form class="financials-filter" method="get" action="{{ url_for('ui.financials_page') }}">
                    <label class="form-field">
                        <span>Company</span>
                        <select name="company_id" id="financial-company">
                            <option value="group" {% if is_group %}selected{% endif %}>Group (All Companies)</option>
                            {% for company in companies %}
                                <option value="{{ company.id }}" {% if not is_group and company.id == selected_company_id %}selected{% endif %}>
                                    {{ company.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </label>
                    <label class="form-field">
                        <span>Statement</span>
                        <select name="statement_type" id="financial-statement">
                            <option value="income" {% if statement_type == 'income' %}selected{% endif %}>Income Statement</option>
                            <option value="sofp" {% if statement_type == 'sofp' %}selected{% endif %}>Statement of Financial Position</option>
                            <option value="cashflow" {% if statement_type == 'cashflow' %}selected{% endif %}>Cash Flow Statement</option>
                            <option value="equity" {% if statement_type == 'equity' %}selected{% endif %}>Statement of Changes in Equity</option>
                        </select>
                    </label>
                    <label class="form-field">
                        <span>Financial Year</span>
                        <select name="financial_year" id="financial-year">
                            {% for year_option in financial_year_options %}
                                <option value="{{ year_option }}" {% if financial_year == year_option %}selected{% endif %}>
                                    {{ year_option }}–{{ year_option + 1 }}
                                </option>
                            {% endfor %}
                        </select>
                    </label>
                    <div class="financials-filter__actions">
                        <button class="button" type="submit">Load</button>
                    </div>
                </form>

                {% if financial_lines %}
                    <form class="financials-card" method="post" action="{{ url_for('ui.save_financials') }}">
                        <input type="hidden" name="company_id" value="{{ 'group' if is_group else selected_company_id or '' }}" />
                        <input type="hidden" name="statement_type" value="{{ statement_type }}" />
                        <input type="hidden" name="financial_year" value="{{ financial_year }}" />

                        <div class="financials-table-wrapper">
                            <table class="financials-table">
                                <thead>
                                    <tr>
                                        <th class="financials-label-column">Line Item</th>
                                        {% for month in financial_months %}
                                            <th class="financials-month-column">{{ month.label }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for line in financial_lines %}
                                        {% set row_classes = [] %}
                                        {% if line.is_section %}
                                            {% set _ = row_classes.append('financials-row--section') %}
                                        {% endif %}
                                        {% if line.is_subtotal %}
                                            {% set _ = row_classes.append('financials-row--subtotal') %}
                                        {% endif %}
                                        <tr class="financials-row {{ ' '.join(row_classes) }}">
                                            <th class="financials-label" style="padding-left: {{ (line.level or 0) * 16 }}px">
                                                {{ line.label }}
                                            </th>
                                            {% for month in financial_months %}
                                                {% set existing_value = (financial_values_map or {}).get((month.year, month.month, line.line_key)) %}
                                                {% set display_value = '' if existing_value is none else '%.2f' % existing_value %}
                                                <td class="financials-cell">
                                                    {% if line.is_section %}
                                                        <span class="financials-section-spacer">—</span>
                                                    {% else %}
                                                        <input
                                                            type="number"
                                                            step="0.01"
                                                            inputmode="decimal"
                                                            class="financial-cell"
                                                            name="values[{{ month.year }}][{{ month.month }}][{{ line.line_key }}]"
                                                            value="{{ display_value }}"
                                                            data-year="{{ month.year }}"
                                                            data-month="{{ month.month }}"
                                                            data-line-key="{{ line.line_key }}"
                                                            {% if line.is_calculated %}readonly{% endif %}
                                                        />
                                                    {% endif %}
                                                </td>
                                            {% endfor %}
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <div class="financials-actions">
                            {% if is_group %}
                                <p class="helper-text">Select a company (not Group) to save edits.</p>
                            {% endif %}
                            <button class="button" type="submit" {% if is_group %}disabled{% endif %}>Save</button>
                        </div>
                    </form>
                {% else %}
                    <p class="helper-text">No statement lines found. Add a report line to begin capturing data.</p>
                {% endif %}

                <div class="financials-new-line">
                    <button class="button button--ghost" type="button" id="financials-new-line-toggle">Create New Report Line</button>
                    <form class="financials-new-line__form" id="financials-new-line-form" method="post" action="{{ url_for('ui.create_financial_line') }}" hidden>
                        <input type="hidden" name="company_id" value="{{ 'group' if is_group else selected_company_id or '' }}" />
                        <input type="hidden" name="financial_year" value="{{ financial_year }}" />

                        <div class="financials-new-line__grid">
                            <label class="form-field">
                                <span>Statement</span>
                                <select name="statement_type" id="new-line-statement">
                                    <option value="income" {% if statement_type == 'income' %}selected{% endif %}>Income Statement</option>
                                    <option value="sofp" {% if statement_type == 'sofp' %}selected{% endif %}>Statement of Financial Position</option>
                                    <option value="cashflow" {% if statement_type == 'cashflow' %}selected{% endif %}>Cash Flow Statement</option>
                                    <option value="equity" {% if statement_type == 'equity' %}selected{% endif %}>Statement of Changes in Equity</option>
                                </select>
                            </label>
                            <label class="form-field">
                                <span>Label</span>
                                <input name="label" id="new-line-label" type="text" placeholder="e.g. Revenue" required />
                            </label>
                            <label class="form-field">
                                <span>Line Key</span>
                                <input name="line_key" id="new-line-key" type="text" placeholder="e.g. revenue" />
                            </label>
                            <label class="form-field">
                                <span>Level</span>
                                <input name="level" type="number" min="0" step="1" value="0" />
                            </label>
                            <label class="form-field">
                                <span>Display Order</span>
                                <input name="display_order" type="number" step="1" min="0" />
                            </label>
                            <label class="form-field form-field--checkbox">
                                <span class="form-field__checkbox">
                                    <input type="checkbox" name="is_section" />
                                    <span>Section Header</span>
                                </span>
                            </label>
                            <label class="form-field form-field--checkbox">
                                <span class="form-field__checkbox">
                                    <input type="checkbox" name="is_subtotal" />
                                    <span>Subtotal</span>
                                </span>
                            </label>
                        </div>
                        <div class="financials-new-line__actions">
                            <button class="button button--secondary" type="submit">Add Line</button>
                        </div>
                    </form>
                </div>
            </div>
        </section>
    </div>
    <script>
        const token = localStorage.getItem("samprox_token");
        const userRaw = localStorage.getItem("samprox_user");
        let user;

        try {
            user = userRaw ? JSON.parse(userRaw) : null;
        } catch (_) {
            user = null;
        }

        if (!token || !user) {
            window.location.href = "/";
        }

        if (user?.role === "outside_manager" && window.location.pathname !== "/responsibility_portal") {
            window.location.replace("/responsibility_portal");
        }

        if (user?.role === "maintenance_manager" && window.location.pathname !== "/machines") {
            window.location.replace("/machines");
        }

        const roleLabels = {
            admin: "Admin",
            production_manager: "Production Manager",
            maintenance_manager: "Maintenance Manager",
            finance_manager: "Finance Manager",
            technician: "Technician",
            outside_manager: "Member Of Rainbow Group",
        };

        const userNameEl = document.getElementById("user-name");
        const userRoleEl = document.getElementById("user-role");
        const logoutButton = document.getElementById("logout");
        const mechanismLink = document.getElementById("mechanism-link");

        userNameEl.textContent = user?.name || "Unknown";
        userRoleEl.textContent = roleLabels[user?.role] || "";
        if (mechanismLink) {
            if (user?.role === "admin") {
                mechanismLink.hidden = false;
            } else {
                mechanismLink.remove();
            }
        }

        logoutButton.addEventListener("click", async () => {
            try {
                await fetch("/api/auth/logout", { method: "POST", credentials: "include" });
            } catch (error) {
                console.error("Failed to log out", error);
            } finally {
                localStorage.removeItem("samprox_token");
                localStorage.removeItem("samprox_user");
                window.location.href = "/";
            }
        });

        const tabButtons = document.querySelectorAll(".tab-switcher__button");
        const tabPanels = document.querySelectorAll(".tab-panel");
        const initialTab = document.body.dataset.activeTab || "overview";

        function activateTab(target) {
            tabButtons.forEach((btn) => {
                const isTarget = btn.dataset.tab === target;
                btn.classList.toggle("tab-switcher__button--active", isTarget);
                btn.setAttribute("aria-selected", isTarget);
            });
            tabPanels.forEach((panel) => {
                panel.classList.toggle("tab-panel--active", panel.id === `tab-${target}`);
            });
        }

        activateTab(initialTab);

        tabButtons.forEach((button) => {
            button.addEventListener("click", () => {
                activateTab(button.dataset.tab);
            });
        });

        const pettyState = {
            claim: null,
            employees: [],
            companies: [],
        };

        let addRowPending = false;

        const pettyEls = {
            company: document.getElementById("petty-company"),
            employee: document.getElementById("petty-employee"),
            weekStart: document.getElementById("petty-week-start"),
            weekEnd: document.getElementById("petty-week-end"),
            sheet: document.getElementById("petty-sheet"),
            vehicle: document.getElementById("petty-vehicle"),
            area: document.getElementById("petty-area"),
            linesBody: document.getElementById("petty-lines"),
            total: document.getElementById("petty-total"),
            status: document.getElementById("petty-status"),
            helper: document.getElementById("petty-helper"),
            error: document.getElementById("petty-error"),
            addRow: document.getElementById("petty-add-row"),
            save: document.getElementById("petty-save"),
            submit: document.getElementById("petty-submit"),
            approve: document.getElementById("petty-approve"),
            reject: document.getElementById("petty-reject"),
            paid: document.getElementById("petty-paid"),
        };

        const managerRoles = ["admin", "finance_manager", "production_manager"];

        function formatAmount(value) {
            const num = Number(value || 0);
            if (Number.isNaN(num)) return "0.00";
            return num.toFixed(2);
        }

        function showError(message) {
            pettyEls.error.textContent = message || "";
            pettyEls.error.hidden = !message;
        }

        function authHeaders() {
            return {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
            };
        }

        async function fetchJson(url, options = {}) {
            const response = await fetch(url, {
                ...options,
                headers: { ...authHeaders(), ...(options.headers || {}) },
            });

            if (response.status === 401) {
                localStorage.removeItem("samprox_token");
                localStorage.removeItem("samprox_user");
                window.location.replace("/");
                return { ok: false, data: {} };
            }

            let data;
            try {
                data = await response.json();
            } catch (error) {
                data = {};
            }
            return { ok: response.ok, data };
        }

        function updateStatusBadge(status) {
            pettyEls.status.textContent = status || "Draft";
        }

        function renderHeader() {
            const claim = pettyState.claim;
            if (!claim) return;

            const selectedCompany = claim.company?.key;
            pettyEls.company.innerHTML = "";
            pettyState.companies.forEach((company) => {
                const option = document.createElement("option");
                option.value = company.key;
                option.textContent = company.name;
                if (company.key === selectedCompany) {
                    option.selected = true;
                }
                pettyEls.company.appendChild(option);
            });

            if (!pettyEls.company.options.length && claim.company?.name) {
                const fallback = document.createElement("option");
                fallback.value = selectedCompany || "";
                fallback.textContent = claim.company.name;
                fallback.selected = true;
                pettyEls.company.appendChild(fallback);
            }

            pettyEls.sheet.value = claim.sheet_no || "";
            pettyEls.weekStart.value = claim.week_start_date;
            pettyEls.weekEnd.value = claim.week_end_date;
            pettyEls.vehicle.value = claim.vehicle_no || "";
            pettyEls.area.value = claim.area_visited || "";
            updateStatusBadge(claim.status);

            const employees = [...pettyState.employees];
            const hasCurrent = employees.some((emp) => emp.id === claim.employee.id);
            if (!hasCurrent && claim.employee?.id) {
                employees.unshift(claim.employee);
            }

            pettyEls.employee.innerHTML = "";
            employees.forEach((emp) => {
                const option = document.createElement("option");
                option.value = emp.id;
                option.textContent = emp.name;
                if (emp.id === claim.employee.id) {
                    option.selected = true;
                }
                pettyEls.employee.appendChild(option);
            });

            const locked = ["Approved", "Paid"].includes(claim.status);
            [pettyEls.employee, pettyEls.weekStart, pettyEls.vehicle, pettyEls.area].forEach((field) => {
                field.disabled = locked;
            });
        }

        function buildAmountInput(line, field, locked) {
            const input = document.createElement("input");
            input.type = "number";
            input.step = "0.01";
            input.inputMode = "decimal";
            input.value = formatAmount(line[field]);
            input.className = "cell-input";
            input.disabled = locked;
            input.addEventListener("keydown", (event) => {
                if (event.key === "Enter") {
                    event.preventDefault();
                    persistLineUpdate(line.id, { [field]: input.value });
                }
            });
            input.addEventListener("blur", () => {
                persistLineUpdate(line.id, { [field]: input.value });
            });
            return input;
        }

        function buildTextInput(line, locked) {
            const input = document.createElement("input");
            input.type = "text";
            input.value = line.expense_type || "";
            input.className = "cell-input cell-input--text";
            input.disabled = locked;
            input.addEventListener("blur", () => {
                persistLineUpdate(line.id, { expense_type: input.value });
            });
            input.addEventListener("keydown", (event) => {
                if (event.key === "Enter") {
                    event.preventDefault();
                    input.blur();
                }
            });
            return input;
        }

        function renderLines() {
            const claim = pettyState.claim;
            if (!claim) return;
            pettyEls.linesBody.innerHTML = "";
            const locked = ["Approved", "Paid"].includes(claim.status);

            (claim.lines || []).forEach((line, index) => {
                const row = document.createElement("tr");

                const numberCell = document.createElement("td");
                numberCell.textContent = index + 1;
                row.appendChild(numberCell);

                const expenseCell = document.createElement("td");
                expenseCell.appendChild(buildTextInput(line, locked));
                row.appendChild(expenseCell);

                [
                    "mon_amount",
                    "tue_amount",
                    "wed_amount",
                    "thu_amount",
                    "fri_amount",
                    "sat_amount",
                    "sun_amount",
                ].forEach((field) => {
                    const cell = document.createElement("td");
                    cell.appendChild(buildAmountInput(line, field, locked));
                    row.appendChild(cell);
                });

                const totalCell = document.createElement("td");
                totalCell.className = "total-cell";
                totalCell.textContent = formatAmount(line.row_total);
                row.appendChild(totalCell);

                const deleteCell = document.createElement("td");
                if (!locked) {
                    const deleteButton = document.createElement("button");
                    deleteButton.type = "button";
                    deleteButton.className = "icon-button";
                    deleteButton.textContent = "✕";
                    deleteButton.title = "Delete row";
                    deleteButton.addEventListener("click", () => deleteLine(line.id));
                    deleteCell.appendChild(deleteButton);
                }
                row.appendChild(deleteCell);

                pettyEls.linesBody.appendChild(row);
            });

            pettyEls.total.textContent = formatAmount(claim.total_expenses);

            pettyEls.addRow.disabled = locked || addRowPending;
            pettyEls.helper.textContent = locked
                ? "This claim is locked because it has been approved or paid."
                : "Click any weekday cell to enter an amount. Empty cells are treated as 0.";
        }

        function applyClaim(claim) {
            pettyState.claim = claim;
            renderHeader();
            renderLines();
        }

        async function loadEmployees(companyKey) {
            const query = companyKey ? `?company=${encodeURIComponent(companyKey)}` : "";
            const { ok, data } = await fetchJson(`/api/petty-cash/employees${query}`);
            if (ok && Array.isArray(data)) {
                pettyState.employees = data;
                if (pettyState.claim) {
                    renderHeader();
                }
            }
        }

        async function loadCompanies() {
            const { ok, data } = await fetchJson("/api/petty-cash/companies");
            if (ok && Array.isArray(data)) {
                pettyState.companies = data;
            }
        }

        async function initPettyCash() {
            await loadCompanies();
            const { ok, data } = await fetchJson("/api/petty-cash/weekly-claims/init");
            if (!ok || !data.claim) {
                showError(data.msg || "Unable to load petty cash claim.");
                return;
            }
            applyClaim(data.claim);
            await loadEmployees(data.claim.company?.key);
            showError("");
        }

        async function persistLineUpdate(lineId, payload) {
            if (!pettyState.claim) return;
            const claimId = pettyState.claim.id;
            const { ok, data } = await fetchJson(
                `/api/petty-cash/weekly-claims/${claimId}/lines/${lineId}`,
                { method: "PUT", body: JSON.stringify(payload) }
            );
            if (!ok || !data.claim) {
                showError(data.msg || "Unable to save line update.");
                return;
            }
            applyClaim(data.claim);
            showError("");
        }

        async function deleteLine(lineId) {
            if (!pettyState.claim) return;
            const claimId = pettyState.claim.id;
            const { ok, data } = await fetchJson(
                `/api/petty-cash/weekly-claims/${claimId}/lines/${lineId}`,
                { method: "DELETE" }
            );
            if (!ok || !data.claim) {
                showError(data.msg || "Unable to delete row.");
                return;
            }
            applyClaim(data.claim);
            showError("");
        }

        async function addLine() {
            if (addRowPending) return;

            if (!pettyState.claim) {
                await initPettyCash();
            }

            if (!pettyState.claim) {
                showError("Unable to add a new row because the claim could not be loaded.");
                return;
            }

            addRowPending = true;
            pettyEls.addRow.disabled = true;

            try {
                const { ok, data } = await fetchJson(
                    `/api/petty-cash/weekly-claims/${pettyState.claim.id}/lines`,
                    { method: "POST", body: JSON.stringify({}) }
                );
                if (!ok || !data.claim) {
                    showError(data.msg || "Unable to add a new row.");
                    return;
                }
                applyClaim(data.claim);
                showError("");
            } catch (error) {
                console.error("Failed to add petty cash row", error);
                showError("Unable to add a new row. Please try again.");
            } finally {
                addRowPending = false;
                const locked = pettyState.claim && ["Approved", "Paid"].includes(pettyState.claim.status);
                pettyEls.addRow.disabled = Boolean(locked);
            }
        }

        async function updateHeader(payload) {
            if (!pettyState.claim) return;
            const { ok, data } = await fetchJson(
                `/api/petty-cash/weekly-claims/${pettyState.claim.id}`,
                { method: "PUT", body: JSON.stringify(payload) }
            );
            if (!ok || !data.claim) {
                showError(data.msg || "Unable to update claim header.");
                return;
            }
            applyClaim(data.claim);
            showError("");
        }

        async function updateStatus(newStatus) {
            if (!pettyState.claim) return;
            const { ok, data } = await fetchJson(
                `/api/petty-cash/weekly-claims/${pettyState.claim.id}/status`,
                { method: "POST", body: JSON.stringify({ status: newStatus }) }
            );
            if (!ok || !data.claim) {
                showError(data.msg || "Unable to update status.");
                return;
            }
            applyClaim(data.claim);
            showError("");
        }

        pettyEls.employee.addEventListener("change", (event) => {
            updateHeader({ employee_id: Number(event.target.value) });
        });

        pettyEls.company.addEventListener("change", (event) => {
            const companyKey = event.target.value;
            updateHeader({ company_id: companyKey });
            loadEmployees(companyKey);
        });

        pettyEls.weekStart.addEventListener("change", (event) => {
            updateHeader({ week_start_date: event.target.value });
        });

        pettyEls.vehicle.addEventListener("blur", (event) => {
            updateHeader({ vehicle_no: event.target.value });
        });

        pettyEls.area.addEventListener("blur", (event) => {
            updateHeader({ area_visited: event.target.value });
        });

        pettyEls.addRow.addEventListener("click", addLine);
        pettyEls.save.addEventListener("click", () => updateStatus("Draft"));
        pettyEls.submit.addEventListener("click", () => updateStatus("Submitted"));
        pettyEls.approve.addEventListener("click", () => updateStatus("Approved"));
        pettyEls.reject.addEventListener("click", () => updateStatus("Rejected"));
        pettyEls.paid.addEventListener("click", () => updateStatus("Paid"));

        const financialsNewLineToggle = document.getElementById("financials-new-line-toggle");
        const financialsNewLineForm = document.getElementById("financials-new-line-form");
        const financialsLineLabel = document.getElementById("new-line-label");
        const financialsLineKey = document.getElementById("new-line-key");
        let lineKeyTouched = false;

        function slugify(value) {
            return (value || "")
                .toString()
                .trim()
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, "_")
                .replace(/^_+|_+$/g, "");
        }

        if (financialsNewLineToggle && financialsNewLineForm) {
            financialsNewLineToggle.addEventListener("click", () => {
                financialsNewLineForm.hidden = !financialsNewLineForm.hidden;
            });
        }

        if (financialsLineKey) {
            financialsLineKey.addEventListener("input", () => {
                lineKeyTouched = true;
            });
        }

        if (financialsLineLabel && financialsLineKey) {
            financialsLineLabel.addEventListener("input", () => {
                if (!lineKeyTouched) {
                    financialsLineKey.value = slugify(financialsLineLabel.value);
                }
            });
        }

        function toggleManagerActions() {
            const isManager = managerRoles.includes(user?.role);
            [pettyEls.approve, pettyEls.paid].forEach((btn) => {
                btn.disabled = !isManager;
                btn.title = isManager ? "" : "Only managers/finance can approve or mark as paid";
            });
        }

        toggleManagerActions();
        initPettyCash();
    </script>
</body>
</html>
