<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sales Visits | SAMPROX ERP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" />
</head>
<body>
    <div class="page">
        <header class="topbar">
            <div class="brand">
                <div class="brand__logo">S</div>
                <div class="brand__details">
                    <p class="brand__name">SAMPROX ERP</p>
                    <p class="brand__section">Responsibility Portal</p>
                </div>
            </div>
            <div class="topbar__actions">
                <a class="button button--ghost" id="header-back-link" href="{{ url_for('ui.money_page') }}">Money</a>
                <div class="user-summary">
                    <span class="user-summary__name" id="user-name"></span>
                    <span class="user-summary__role" id="user-role"></span>
                </div>
                <button type="button" class="button button--secondary" id="logout">Sign out</button>
            </div>
        </header>
        <main class="section">
            <header class="section__header">
                <div>
                    <p class="eyebrow">Field tracking</p>
                    <h1>Sales Visits</h1>
                    <p class="section__description">
                        Plan visits, capture check-ins, and manage approvals for your sales team.
                    </p>
                </div>
                <div class="section__actions">
                    <button class="button button--primary" id="new-visit">Create visit</button>
                </div>
            </header>

            <div class="card">
                <div class="filters">
                    <label class="form-field">
                        <span>Date from</span>
                        <input id="filter-from" type="date" />
                    </label>
                    <label class="form-field">
                        <span>Date to</span>
                        <input id="filter-to" type="date" />
                    </label>
                    <label class="form-field" id="filter-sales-container" hidden>
                        <span>Sales user</span>
                        <select id="filter-sales">
                            <option value="">All</option>
                        </select>
                    </label>
                    <button class="button button--secondary button--small" id="apply-filters">Apply</button>
                    <button class="button button--ghost button--small" id="clear-filters">Clear</button>
                </div>
                <div class="table-container table-container--scrollable" style="margin-top: 1rem;">
                    <table id="sales-visits-table" class="team-table responsibility-table">
                        <thead>
                            <tr>
                                <th>Visit No</th>
                                <th>Date</th>
                                <th class="col-sales-person">Sales Person</th>
                                <th>Customer / Prospect</th>
                                <th class="col-city">City</th>
                                <th>Purpose</th>
                                <th>Check-in</th>
                                <th>Check-out</th>
                                <th>Duration</th>
                                <th>GPS</th>
                                <th>Exception</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="visit-rows">
                            <tr id="visits-empty">
                                <td colspan="12" style="text-align:center;">No visits yet.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div class="modal" id="visit-modal" hidden>
        <div class="modal__overlay" data-modal-dismiss></div>
        <div class="modal__content">
            <header class="modal__header">
                <h2 id="visit-modal-title">Create visit</h2>
                <button class="modal__close" data-modal-dismiss aria-label="Close">×</button>
            </header>
            <div class="modal__body">
                <div class="alert alert--error" id="visit-modal-error" hidden></div>
                <form id="visit-form" class="form-grid">
                    <label class="form-field">
                        <span>Visit date</span>
                        <input type="date" id="visit-date" required />
                    </label>
                    <label class="form-field">
                        <span>Non Samprox Customer (optional)</span>
                        <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
                            <div style="flex: 1;">
                                <input type="text" id="non-samprox-search" placeholder="Search code, name, city" />
                                <select id="nsc-select" style="margin-top: 0.25rem; width: 100%;">
                                    <option value="">Select customer (optional)</option>
                                </select>
                            </div>
                            <div style="display: flex; gap: 0.35rem;">
                                <button type="button" class="button button--secondary button--small" id="btn-nsc-create">Create customer</button>
                                <button type="button" class="button button--ghost button--small" id="btn-nsc-edit">Edit customer</button>
                            </div>
                        </div>
                        <div class="alert alert--error" id="nsc-editor-msg" hidden></div>
                    </label>
                    <label class="form-field">
                        <span>Prospect name (if no customer)</span>
                        <input type="text" id="visit-prospect" placeholder="Prospect name" />
                    </label>
                    <label class="form-field">
                        <span>Purpose</span>
                        <input type="text" id="visit-purpose" />
                    </label>
                    <label class="form-field">
                        <span>Remarks</span>
                        <textarea id="visit-remarks" rows="2"></textarea>
                    </label>
                    <label class="checkbox">
                        <input type="checkbox" id="visit-planned" />
                        <span>Planned visit</span>
                    </label>
                </form>
            </div>
            <footer class="modal__footer">
                <button class="button button--ghost" data-modal-dismiss>Cancel</button>
                <button class="button button--primary" id="visit-save">Save</button>
            </footer>
        </div>
    </div>

    <div class="modal" id="non-samprox-modal" hidden>
        <div class="modal__overlay" data-modal-dismiss></div>
        <div class="modal__content">
            <header class="modal__header" style="display:flex; align-items:center; justify-content: space-between; gap: 0.5rem;">
                <div>
                    <h2 id="non-samprox-title">Create Non Samprox Customer</h2>
                    <p id="non-samprox-subtitle" class="eyebrow" style="margin-top: 0.1rem;"></p>
                </div>
                <button class="button button--ghost button--small" id="cancel-edit" hidden type="button">Cancel edit</button>
                <button class="modal__close" data-modal-dismiss aria-label="Close">×</button>
            </header>
            <div class="modal__body" id="nsc-editor" data-mode="create">
                <div class="alert alert--error" id="non-samprox-error" hidden></div>
                <form id="non-samprox-form" class="form-grid">
                    <input type="hidden" id="nsc-edit-id" />
                    <label class="form-field">
                        <span>Company Name</span>
                        <select id="ns-company" required></select>
                    </label>
                    <label class="form-field">
                        <span>Customer Code</span>
                        <input type="text" id="ns-customer-code" placeholder="Auto-generated" readonly />
                        <p class="eyebrow text--error" id="ns-code-error" hidden style="margin-top: 0.2rem;">Unable to generate customer code</p>
                    </label>
                    <label class="form-field">
                        <span>Customer Name</span>
                        <input type="text" id="ns-customer-name" required />
                    </label>
                    <label class="form-field">
                        <span>City</span>
                        <input type="text" id="ns-city" list="ns-city-list" />
                        <datalist id="ns-city-list"></datalist>
                    </label>
                    <label class="form-field">
                        <span>Area Code</span>
                        <input type="text" id="ns-area-code" />
                    </label>
                    <label class="form-field">
                        <span>District</span>
                        <input type="text" id="ns-district" />
                    </label>
                    <label class="form-field">
                        <span>Province</span>
                        <input type="text" id="ns-province" />
                    </label>
                    <label class="form-field">
                        <span>Managed By</span>
                        <select id="ns-managed-by"></select>
                    </label>
                    <label class="form-field" id="ns-active-field" hidden>
                        <span>Active</span>
                        <select id="ns-active">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </label>
                </form>
            </div>
            <footer class="modal__footer">
                <button class="button button--ghost" data-modal-dismiss>Cancel</button>
                <button class="button button--primary" id="ns-save">Save</button>
            </footer>
        </div>
    </div>

    <div class="modal" id="attachment-modal" hidden>
        <div class="modal__overlay" data-modal-dismiss></div>
        <div class="modal__content">
            <header class="modal__header">
                <h2>Add attachment</h2>
                <button class="modal__close" data-modal-dismiss aria-label="Close">×</button>
            </header>
            <div class="modal__body">
                <div class="alert alert--error" id="attachment-error" hidden></div>
                <label class="form-field">
                    <span>File URL</span>
                    <input type="url" id="attachment-url" required />
                </label>
                <label class="form-field">
                    <span>File type</span>
                    <input type="text" id="attachment-type" placeholder="photo / doc" />
                </label>
            </div>
            <footer class="modal__footer">
                <button class="button button--ghost" data-modal-dismiss>Cancel</button>
                <button class="button button--primary" id="attachment-save">Save</button>
            </footer>
        </div>
    </div>

    <script>
        const token = localStorage.getItem("samprox_token");
        const user = JSON.parse(localStorage.getItem("samprox_user") || "null");
        const locationDataUrl = "{{ url_for('static', filename='data/lk_locations.json') }}";

        if (!token || !user) {
            window.location.href = "/";
        }
        if (user?.role === "sales_manager") {
            const allowedSalesManagerPaths = new Set(["/sales/dashboard", "/sales/data-entry", "/sales/reports", "/sales_visits"]);
            if (!allowedSalesManagerPaths.has(window.location.pathname)) {
                window.location.replace("/sales/dashboard");
            }
        }

        const backLink = document.getElementById("header-back-link");
        if (user?.role === "sales_manager") {
            backLink?.setAttribute("href", "/sales/dashboard");
            if (backLink) backLink.textContent = "Dashboard";
        }

        const roleLabels = {
            admin: "Admin",
            production_manager: "Production Manager",
            maintenance_manager: "Maintenance Manager",
            finance_manager: "Finance Manager",
            technician: "Technician",
            outside_manager: "Outside Manager",
            sales_manager: "Sales Manager",
            sales: "Sales",
        };

        const userNameEl = document.getElementById("user-name");
        const userRoleEl = document.getElementById("user-role");
        userNameEl.textContent = user?.name || "";
        userRoleEl.textContent = roleLabels[user?.role] || "";

        document.getElementById("logout").addEventListener("click", async () => {
            try {
                await fetch("/api/auth/logout", { method: "POST", credentials: "include" });
            } catch (_) {
            } finally {
                localStorage.removeItem("samprox_token");
                localStorage.removeItem("samprox_user");
                window.location.href = "/";
            }
        });

        const headers = {
            Accept: "application/json",
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
        };
        const showSalesPersonColumn = user?.role !== "sales";
        const showCityColumn = ["admin", "finance_manager", "production_manager", "sales_manager"].includes(user?.role);

        function authFetch(url, options = {}) {
            return fetch(url, {
                credentials: "include",
                headers,
                ...options,
                headers: { ...headers, ...(options.headers || {}) },
            });
        }

        function getElement(id) {
            const el = document.getElementById(id);
            if (!el) {
                console.error(`Missing field: ${id}`);
            }
            return el;
        }

        const elements = {
            visitRows: getElement("visit-rows"),
            visitsEmpty: getElement("visits-empty"),
            filterFrom: getElement("filter-from"),
            filterTo: getElement("filter-to"),
            filterSales: getElement("filter-sales"),
            filterSalesContainer: getElement("filter-sales-container"),
            applyFilters: getElement("apply-filters"),
            clearFilters: getElement("clear-filters"),
            newVisit: getElement("new-visit"),
            visitModal: getElement("visit-modal"),
            visitModalError: getElement("visit-modal-error"),
            visitDate: getElement("visit-date"),
            visitNonSamprox: getElement("nsc-select"),
            visitNonSamproxSearch: getElement("non-samprox-search"),
            visitProspect: getElement("visit-prospect"),
            visitPurpose: getElement("visit-purpose"),
            visitRemarks: getElement("visit-remarks"),
            visitPlanned: getElement("visit-planned"),
            visitSave: getElement("visit-save"),
            visitForm: getElement("visit-form"),
            openCustomerModal: getElement("btn-nsc-create"),
            editCustomer: getElement("btn-nsc-edit"),
            nonSamproxModal: getElement("non-samprox-modal"),
            nonSamproxForm: getElement("non-samprox-form"),
            nonSamproxError: getElement("non-samprox-error"),
            nonSamproxTitle: getElement("non-samprox-title"),
            nonSamproxSubtitle: getElement("non-samprox-subtitle"),
            cancelEdit: getElement("cancel-edit"),
            nsCustomerCode: getElement("ns-customer-code"),
            nsCustomerCodeError: getElement("ns-code-error"),
            nsCustomerName: getElement("ns-customer-name"),
            nsAreaCode: getElement("ns-area-code"),
            nsCity: getElement("ns-city"),
            nsCityList: getElement("ns-city-list"),
            nsDistrict: getElement("ns-district"),
            nsProvince: getElement("ns-province"),
            nsManagedBy: getElement("ns-managed-by"),
            nsCompany: getElement("ns-company"),
            nsActiveField: getElement("ns-active-field"),
            nsActive: getElement("ns-active"),
            nsSave: getElement("ns-save"),
            nscEditor: getElement("nsc-editor"),
            nscEditorMsg: getElement("nsc-editor-msg"),
            nscEditId: getElement("nsc-edit-id"),
            attachmentModal: getElement("attachment-modal"),
            attachmentUrl: getElement("attachment-url"),
            attachmentType: getElement("attachment-type"),
            attachmentSave: getElement("attachment-save"),
            attachmentError: getElement("attachment-error"),
        };

        let activeVisitId = null;
        let visits = [];
        let team = [];
        let nonSamproxCustomers = [];
        let companies = [];
        let nonSamproxMode = "create";
        let editingCustomerId = null;
        let locationData = [];
        let locationLookup = new Map();

        function showNscMessage(message = "") {
            if (!elements.nscEditorMsg) return;
            elements.nscEditorMsg.textContent = message;
            elements.nscEditorMsg.hidden = !message;
        }

        function showCodeError(message = "Unable to generate customer code") {
            if (elements.nsCustomerCodeError) {
                elements.nsCustomerCodeError.textContent = message;
                elements.nsCustomerCodeError.hidden = false;
            }
            if (elements.nsSave) {
                elements.nsSave.disabled = true;
            }
        }

        function clearCodeError() {
            if (elements.nsCustomerCodeError) {
                elements.nsCustomerCodeError.hidden = true;
                elements.nsCustomerCodeError.textContent = "";
            }
        }

        function clearNscMessage() {
            showNscMessage("");
        }

        function getLiveLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error("Geolocation is not supported by this browser."));
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        resolve({
                            lat: Number(pos.coords.latitude.toFixed(7)),
                            lng: Number(pos.coords.longitude.toFixed(7)),
                            accuracy: pos.coords.accuracy ? Math.round(pos.coords.accuracy) : null,
                        });
                    },
                    (err) => {
                        if (err.code === err.PERMISSION_DENIED) reject(new Error("Location permission is required to check-in."));
                        else if (err.code === err.POSITION_UNAVAILABLE) reject(new Error("Unable to detect location. Please try again."));
                        else if (err.code === err.TIMEOUT) reject(new Error("Location request timed out. Please try again."));
                        else reject(new Error("Failed to get location."));
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 },
                );
            });
        }

        function openModal(modal) {
            modal.hidden = false;
        }

        function closeModal(modal) {
            modal.hidden = true;
            const error = modal.querySelector(".alert");
            if (error) {
                error.hidden = true;
                error.textContent = "";
            }
        }

        document.querySelectorAll("[data-modal-dismiss]").forEach((el) => {
            el.addEventListener("click", (event) => {
                const modal = event.target.closest(".modal");
                if (modal) closeModal(modal);
            });
        });

        function formatTime(value) {
            if (!value) return "";
            const date = new Date(value);
            return date.toLocaleString("en-GB", { timeZone: "Asia/Colombo" });
        }

        function toggleColumnVisibility(selector, visible) {
            const cells = document.querySelectorAll(selector);
            cells.forEach((cell) => {
                cell.hidden = !visible;
                cell.style.display = visible ? "" : "none";
            });
        }

        function updateColumnVisibility() {
            toggleColumnVisibility(".col-sales-person", showSalesPersonColumn);
            toggleColumnVisibility(".col-city", showCityColumn);
            const hiddenCount = (showSalesPersonColumn ? 0 : 1) + (showCityColumn ? 0 : 1);
            const totalColumns = 12;
            const visibleColumns = totalColumns - hiddenCount;
            if (elements.visitsEmpty && elements.visitsEmpty.firstElementChild) {
                elements.visitsEmpty.firstElementChild.colSpan = visibleColumns;
            }
        }

        function renderVisits() {
            elements.visitRows.innerHTML = "";
            if (!visits.length) {
                elements.visitRows.appendChild(elements.visitsEmpty);
                elements.visitsEmpty.hidden = false;
                updateColumnVisibility();
                return;
            }
            elements.visitsEmpty.hidden = true;
            visits.forEach((visit) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${visit.visit_no}</td>
                    <td>${visit.visit_date || ""}</td>
                    <td class="col-sales-person">${visit.sales_user_name || ""}</td>
                    <td>${visit.customer_display_name || visit.customer_name || visit.prospect_name || "-"}</td>
                    <td class="col-city">${visit.non_samprox_customer_city || ""}</td>
                    <td>${visit.purpose || ""}</td>
                    <td>${visit.check_in_time ? formatTime(visit.check_in_time) : "—"}</td>
                    <td>${visit.check_out_time ? formatTime(visit.check_out_time) : "—"}</td>
                    <td>${visit.duration_minutes ?? ""}</td>
                    <td>${formatGpsStatus(visit)}</td>
                    <td>${visit.approval_status || ""}</td>
                    <td>
                        <div class="badge-group">
                            ${renderActions(visit)}
                        </div>
                    </td>
                `;
                elements.visitRows.appendChild(row);
            });
            updateColumnVisibility();
        }

        function renderActions(visit) {
            const actions = [];
            const isOwner = visit.sales_user_id === user.id;
            const isAdmin = user.role === "admin";
            const isManager = user.role === "outside_manager";
            if ((isOwner || isAdmin) && !visit.check_in_time) {
                actions.push(`<button class="button button--ghost button--small" data-action="check-in" data-id="${visit.id}">Check-in</button>`);
            }
            if ((isOwner || isAdmin) && visit.check_in_time && !visit.check_out_time) {
                actions.push(`<button class="button button--ghost button--small" data-action="check-out" data-id="${visit.id}">Check-out</button>`);
            }
            if ((isOwner || isAdmin) && !visit.check_out_time) {
                actions.push(`<button class="button button--ghost button--small" data-action="edit" data-id="${visit.id}">Edit</button>`);
            }
            if ((isOwner || isAdmin) && visit.check_in_time) {
                actions.push(`<button class="button button--ghost button--small" data-action="attach" data-id="${visit.id}">Attachments</button>`);
            }
            if ((isAdmin || isManager) && visit.approval_status === "PENDING") {
                actions.push(`<button class="button button--secondary button--small" data-action="approve" data-id="${visit.id}">Approve</button>`);
                actions.push(`<button class="button button--ghost button--small" data-action="reject" data-id="${visit.id}">Reject</button>`);
            }
            return actions.join(" ");
        }

        function formatGpsStatus(visit) {
            if (visit.gps_mismatch) return "Mismatch";
            const accuracy = visit.check_in_accuracy_m || visit.check_out_accuracy_m;
            const label = accuracy ? `OK (±${accuracy}m)` : "OK";
            const lat = visit.check_in_lat ?? visit.check_out_lat;
            const lng = visit.check_in_lng ?? visit.check_out_lng;
            if (lat == null || lng == null) return label;
            const mapUrl = `https://www.google.com/maps?q=${lat},${lng}`;
            return `${label} <a href="${mapUrl}" target="_blank" rel="noopener">Map</a>`;
        }

        async function loadVisits() {
            const params = new URLSearchParams();
            if (elements.filterFrom.value) params.append("date_from", elements.filterFrom.value);
            if (elements.filterTo.value) params.append("date_to", elements.filterTo.value);
            if (elements.filterSales.value) params.append("sales_user_id", elements.filterSales.value);
            const response = await authFetch(`/api/sales-visits?${params.toString()}`);
            const data = await response.json();
            if (!data.ok) {
                console.error(data.error || "Unable to load visits");
                return;
            }
            visits = data.data || [];
            renderVisits();
        }

        function upsertNonSamproxOption(customer) {
            if (!customer) return;
            const optionValue = String(customer.id);
            const exists = Array.from(elements.visitNonSamprox.options || []).some((opt) => opt.value === optionValue);
            if (!exists) {
                const option = document.createElement("option");
                const cityLabel = customer.city ? ` (${customer.city})` : "";
                option.value = optionValue;
                option.textContent = `${customer.customer_code} — ${customer.customer_name}${cityLabel}`;
                elements.visitNonSamprox.appendChild(option);
            }
        }

        function renderNonSamproxOptions(selectedId = "") {
            const selectionValue = selectedId ? String(selectedId) : "";
            elements.visitNonSamprox.innerHTML = "";
            const placeholder = document.createElement("option");
            placeholder.value = "";
            placeholder.textContent = "Select customer (optional)";
            elements.visitNonSamprox.appendChild(placeholder);
            nonSamproxCustomers.forEach((customer) => {
                const option = document.createElement("option");
                const cityLabel = customer.city ? ` (${customer.city})` : "";
                option.value = String(customer.id);
                option.textContent = `${customer.customer_code} — ${customer.customer_name}${cityLabel}`;
                elements.visitNonSamprox.appendChild(option);
            });
            if (selectionValue) {
                elements.visitNonSamprox.value = selectionValue;
            }
            toggleEditCustomerButton();
        }

        function toggleEditCustomerButton() {
            if (!elements.editCustomer || !elements.visitNonSamprox) return;
            const selectedId = elements.visitNonSamprox.value;
            const allowedRoles = ["sales", "outside_manager", "admin"];
            if (!allowedRoles.includes(user.role)) {
                elements.editCustomer.hidden = true;
                return;
            }
            elements.editCustomer.hidden = false;
            const disabled = !selectedId;
            elements.editCustomer.disabled = disabled;
            elements.editCustomer.classList.toggle("button--ghost-disabled", disabled);
        }

        function updateNonSamproxCache(customer) {
            if (!customer?.id) return;
            const idx = nonSamproxCustomers.findIndex((c) => c.id === customer.id);
            if (idx >= 0) {
                nonSamproxCustomers[idx] = customer;
            } else {
                nonSamproxCustomers.push(customer);
            }
        }

        async function loadNonSamproxCustomers(searchTerm = "") {
            const params = new URLSearchParams();
            if (searchTerm) params.append("q", searchTerm);
            const response = await authFetch(`/api/non-samprox-customers?${params.toString()}`);
            const data = await response.json();
            if (!data.ok) {
                console.error(data.error || "Unable to load customers");
                return;
            }
            nonSamproxCustomers = data.data || [];
            renderNonSamproxOptions(elements.visitNonSamprox.value);
        }

        async function loadCompanies() {
            if (companies.length) return;
            try {
                const response = await authFetch("/api/companies");
                const data = await response.json();
                if (!data.ok) return;
                companies = data.data || [];
            } catch (err) {
                console.error("Unable to load companies", err);
                return;
            }
            elements.nsCompany.innerHTML = "";
            const placeholder = document.createElement("option");
            placeholder.value = "";
            placeholder.textContent = "Select company";
            elements.nsCompany.appendChild(placeholder);
            companies.forEach((company) => {
                const option = document.createElement("option");
                option.value = company.id;
                option.textContent = company.name;
                elements.nsCompany.appendChild(option);
            });
        }

        function buildManagedByOptions() {
            const options = new Map();
            if (user?.id && user?.name) {
                options.set(user.id, { id: user.id, name: user.name, role: user.role });
            }
            if (user.role === "outside_manager") {
                team.forEach((m) => {
                    if (m.sales_user) options.set(m.sales_user.id, m.sales_user);
                });
            }
            return Array.from(options.values());
        }

        async function populateManagedBySelect() {
            elements.nsManagedBy.innerHTML = "";
            let managedByChoices = [];
            try {
                if (user.role === "admin") {
                    const response = await authFetch("/api/users");
                    const data = await response.json();
                    const items = Array.isArray(data) ? data : data?.data || [];
                    managedByChoices = items.filter((u) => u.role === "sales" || u.role === "outside_manager");
                } else if (user.role === "outside_manager" || user.role === "sales") {
                    managedByChoices = buildManagedByOptions();
                }
            } catch (err) {
                console.error("Unable to load managed-by users", err);
            }

            managedByChoices.forEach((optionData) => {
                const option = document.createElement("option");
                option.value = optionData.id;
                const roleLabel = optionData.role ? ` (${optionData.role})` : "";
                option.textContent = `${optionData.name}${roleLabel}`;
                elements.nsManagedBy.appendChild(option);
            });

            if (user.role === "sales") {
                elements.nsManagedBy.value = user.id;
                elements.nsManagedBy.disabled = true;
            } else {
                elements.nsManagedBy.disabled = false;
                if (managedByChoices.length && !elements.nsManagedBy.value) {
                    elements.nsManagedBy.value = managedByChoices[0].id;
                }
            }
        }

        async function loadTeam() {
            if (!["admin", "outside_manager"].includes(user.role)) return;
            elements.filterSalesContainer.hidden = false;
            const response = await authFetch("/api/sales-visits/team");
            const data = await response.json();
            if (!data.ok) return;
            team = data.data || [];
            const uniqueUsers = new Map();
            team.forEach((m) => {
                if (m.sales_user) uniqueUsers.set(m.sales_user.id, m.sales_user);
                if (m.manager) uniqueUsers.set(m.manager.id, m.manager);
            });
            uniqueUsers.forEach((u) => {
                const option = document.createElement("option");
                option.value = u.id;
                option.textContent = `${u.name} (${u.role})`;
                elements.filterSales.appendChild(option);
            });
        }

        elements.applyFilters.addEventListener("click", () => loadVisits());
        elements.clearFilters.addEventListener("click", () => {
            elements.filterFrom.value = "";
            elements.filterTo.value = "";
            elements.filterSales.value = "";
            loadVisits();
        });

        elements.newVisit.addEventListener("click", () => {
            activeVisitId = null;
            elements.visitForm.reset();
            elements.visitDate.valueAsDate = new Date();
            renderNonSamproxOptions();
            elements.visitNonSamproxSearch.value = "";
            openModal(elements.visitModal);
        });

        elements.visitNonSamprox.addEventListener("change", () => {
            toggleEditCustomerButton();
            clearNscMessage();
        });

        elements.visitSave.addEventListener("click", async () => {
            elements.visitModalError.hidden = true;
            const payload = {
                visit_date: elements.visitDate.value,
                non_samprox_customer_id: elements.visitNonSamprox.value || null,
                prospect_name: elements.visitProspect.value,
                purpose: elements.visitPurpose.value,
                remarks: elements.visitRemarks.value,
                planned: elements.visitPlanned.checked,
            };
            const url = activeVisitId ? `/api/sales-visits/${activeVisitId}` : "/api/sales-visits";
            const method = activeVisitId ? "PUT" : "POST";
            const response = await authFetch(url, { method, body: JSON.stringify(payload) });
            const data = await response.json();
            if (!data.ok) {
                elements.visitModalError.textContent = data.error || "Unable to save visit";
                elements.visitModalError.hidden = false;
                return;
            }
            closeModal(elements.visitModal);
            await loadVisits();
        });

        elements.visitRows.addEventListener("click", async (event) => {
            const button = event.target.closest("button[data-action]");
            if (!button) return;
            const action = button.dataset.action;
            const visitId = button.dataset.id;

            if (action === "edit") {
                const visit = visits.find((v) => v.id === visitId);
                if (!visit) return;
                activeVisitId = visitId;
                elements.visitDate.value = visit.visit_date || "";
                elements.visitNonSamprox.value = visit.non_samprox_customer_id ? String(visit.non_samprox_customer_id) : "";
                if (visit.non_samprox_customer_id && visit.non_samprox_customer_name) {
                    upsertNonSamproxOption({
                        id: visit.non_samprox_customer_id,
                        customer_code: visit.non_samprox_customer_code || "",
                        customer_name: visit.non_samprox_customer_name || "",
                        city: visit.non_samprox_customer_city || "",
                    });
                    elements.visitNonSamprox.value = String(visit.non_samprox_customer_id);
                }
                elements.visitProspect.value = visit.prospect_name || "";
                elements.visitPurpose.value = visit.purpose || "";
                elements.visitRemarks.value = visit.remarks || "";
                elements.visitPlanned.checked = !!visit.planned;
                openModal(elements.visitModal);
                return;
            }

            if (action === "attach") {
                activeVisitId = visitId;
                elements.attachmentUrl.value = "";
                elements.attachmentType.value = "";
                openModal(elements.attachmentModal);
                return;
            }

            if (action === "check-in" || action === "check-out") {
                const originalText = button.textContent;
                button.disabled = true;
                button.textContent = "Locating...";
                try {
                    const { lat, lng, accuracy } = await getLiveLocation();
                    button.textContent = "Saving...";
                    const response = await authFetch(
                        `/api/sales-visits/${visitId}/${action === "check-in" ? "check-in" : "check-out"}`,
                        {
                            method: "POST",
                            body: JSON.stringify({ lat, lng, accuracy_m: accuracy }),
                        },
                    );
                    const data = await response.json();
                    if (!data.ok) {
                        throw new Error(data.error || "Unable to update visit");
                    }
                    await loadVisits();
                } catch (err) {
                    alert(err.message || "Unable to update visit");
                } finally {
                    button.disabled = false;
                    button.textContent = originalText;
                }
                return;
            }

            if (action === "approve" || action === "reject") {
                const note = prompt("Approval note (optional)") || "";
                const response = await authFetch(`/api/sales-visits/${visitId}/approve`, {
                    method: "POST",
                    body: JSON.stringify({ action: action === "approve" ? "APPROVE" : "REJECT", approval_note: note }),
                });
                const data = await response.json();
                if (!data.ok) {
                    alert(data.error || "Unable to update approval");
                }
                await loadVisits();
            }
        });

        elements.attachmentSave.addEventListener("click", async () => {
            elements.attachmentError.hidden = true;
            if (!activeVisitId) return;
            const payload = {
                file_url: elements.attachmentUrl.value,
                file_type: elements.attachmentType.value,
            };
            const response = await authFetch(`/api/sales-visits/${activeVisitId}/attachments`, {
                method: "POST",
                body: JSON.stringify(payload),
            });
            const data = await response.json();
            if (!data.ok) {
                elements.attachmentError.textContent = data.error || "Unable to save attachment";
                elements.attachmentError.hidden = false;
                return;
            }
            closeModal(elements.attachmentModal);
        });

        document.querySelectorAll(".modal__overlay, .modal__close").forEach((el) => {
            el.addEventListener("click", () => {
                closeModal(el.closest(".modal"));
            });
        });

        elements.visitNonSamproxSearch.addEventListener("input", () => {
            const term = elements.visitNonSamproxSearch.value;
            loadNonSamproxCustomers(term);
        });

        async function loadNextNonSamproxCode(companyId) {
            elements.nsCustomerCode.value = "";
            elements.nsCustomerCode.placeholder = companyId ? "Loading..." : "Select company";
            clearCodeError();
            if (elements.nsSave) {
                elements.nsSave.disabled = !companyId;
            }
            if (!companyId) return;
            try {
                const response = await authFetch(`/api/non-samprox-customers/next-code?company_id=${companyId}`);
                const data = await response.json();
                const nextCode = data?.data?.next_code || data?.data?.customer_code || data?.next_code;
                if (data.ok && nextCode) {
                    elements.nsCustomerCode.value = nextCode;
                    elements.nsCustomerCode.placeholder = "Auto-generated";
                    if (elements.nsSave) elements.nsSave.disabled = false;
                } else {
                    showCodeError("Unable to generate customer code");
                }
            } catch (err) {
                console.error("Unable to load next customer code", err);
                showCodeError("Unable to generate customer code");
            }
        }

        function normalizeCityName(value = "") {
            return value.trim().toLowerCase();
        }

        async function loadLocationData() {
            if (locationData.length) return locationData;
            try {
                const response = await fetch(locationDataUrl);
                if (!response.ok) throw new Error("Failed to fetch location data");
                const data = await response.json();
                locationData = Array.isArray(data) ? data : [];
                locationLookup = new Map(locationData.map((item) => [normalizeCityName(item.city), item]));
                renderCityOptions(elements.nsCity.value);
            } catch (err) {
                console.error("Unable to load location data", err);
            }
            return locationData;
        }

        function getCityMatches(term = "") {
            const normalized = normalizeCityName(term);
            if (!locationData.length) return [];
            if (!normalized) return locationData.slice(0, 50);
            return locationData.filter((item) => normalizeCityName(item.city).includes(normalized)).slice(0, 50);
        }

        function renderCityOptions(term = "") {
            if (!locationData.length || !elements.nsCityList) return;
            elements.nsCityList.innerHTML = "";
            getCityMatches(term).forEach((item) => {
                const option = document.createElement("option");
                option.value = item.city;
                option.label = `${item.city} — ${item.areaCode}`;
                elements.nsCityList.appendChild(option);
            });
        }

        function applyLocationForCity(cityName) {
            const match = locationLookup.get(normalizeCityName(cityName));
            if (match) {
                elements.nsAreaCode.value = match.areaCode || "";
                elements.nsDistrict.value = match.district || "";
                elements.nsProvince.value = match.province || "";
            } else if (!cityName) {
                elements.nsAreaCode.value = "";
                elements.nsDistrict.value = "";
                elements.nsProvince.value = "";
            }
        }

        function setNonSamproxMode(mode, customer = null) {
            nonSamproxMode = mode;
            editingCustomerId = mode === "edit" ? customer?.id || editingCustomerId : null;
            if (elements.nscEditor) {
                elements.nscEditor.dataset.mode = mode;
            }
            if (elements.nscEditId) {
                elements.nscEditId.value = mode === "edit" && editingCustomerId ? editingCustomerId : "";
            }
            elements.nonSamproxTitle.textContent = mode === "edit" ? "Edit Non Samprox Customer" : "Create Non Samprox Customer";
            elements.nsSave.textContent = mode === "edit" ? "Update" : "Save";
            elements.cancelEdit.hidden = mode !== "edit";
            elements.nonSamproxSubtitle.textContent =
                mode === "edit" && customer ? `${customer.customer_code || ""} — ${customer.customer_name || ""}` : "";
            if (user.role === "sales") {
                elements.nsManagedBy.disabled = true;
            } else {
                elements.nsManagedBy.disabled = false;
            }
            const showActive = user.role === "outside_manager" || user.role === "admin";
            elements.nsActiveField.hidden = !showActive;
            if (!showActive) {
                elements.nsActive.value = "true";
            } else if (mode === "create") {
                elements.nsActive.value = "true";
            }
            if (elements.nsSave) {
                elements.nsSave.disabled = false;
            }
        }

        function populateNonSamproxForm(customer) {
            elements.nsCustomerCode.value = customer?.customer_code || "";
            elements.nsCustomerName.value = customer?.customer_name || "";
            elements.nsAreaCode.value = customer?.area_code || "";
            elements.nsCity.value = customer?.city || "";
            elements.nsDistrict.value = customer?.district || "";
            elements.nsProvince.value = customer?.province || "";
            renderCityOptions(customer?.city || elements.nsCity.value);
            applyLocationForCity(customer?.city || elements.nsCity.value);
            if (customer?.managed_by_user_id) {
                elements.nsManagedBy.value = customer.managed_by_user_id;
            }
            if (customer?.company_id) {
                elements.nsCompany.value = customer.company_id;
            }
            if (customer?.is_active != null) {
                elements.nsActive.value = String(Boolean(customer.is_active));
            } else {
                elements.nsActive.value = "true";
            }
        }

        elements.openCustomerModal.addEventListener("click", async () => {
            let preloadFailed = false;
            clearNscMessage();
            try {
                await loadCompanies();
                await populateManagedBySelect();
                await loadLocationData();
            } catch (err) {
                preloadFailed = true;
                console.error("Unable to preload non Samprox data", err);
            }
            if (elements.nonSamproxForm) {
                elements.nonSamproxForm.reset();
            }
            setNonSamproxMode("create");
            clearCodeError();
            if (user.role === "sales") {
                elements.nsManagedBy.value = user.id;
                elements.nsManagedBy.disabled = true;
            }
            renderCityOptions();
            applyLocationForCity("");
            elements.nsCustomerCode.readOnly = true;
            elements.nsCustomerCode.placeholder = "Auto-generated";
            elements.nonSamproxError.hidden = true;
            await loadNextNonSamproxCode(elements.nsCompany.value);
            if (preloadFailed) {
                showNscMessage("Some customer options could not be loaded. You can still add details manually.");
            }
            openModal(elements.nonSamproxModal);
        });

        elements.cancelEdit.addEventListener("click", async () => {
            setNonSamproxMode("create");
            elements.nonSamproxForm.reset();
            clearCodeError();
            await loadNextNonSamproxCode(elements.nsCompany.value);
            elements.nonSamproxError.hidden = true;
            clearNscMessage();
        });

        elements.editCustomer.addEventListener("click", async (event) => {
            event.preventDefault();
            clearNscMessage();
            const selectedId = elements.visitNonSamprox.value;
            if (!selectedId) {
                showNscMessage("Select a customer to edit");
                return;
            }
            await loadCompanies();
            await populateManagedBySelect();
            await loadLocationData();
            elements.nonSamproxError.hidden = true;
            elements.nonSamproxForm.reset();
            clearCodeError();
            try {
                const response = await authFetch(`/api/non-samprox-customers/${selectedId}`);
                const data = await response.json();
                if (!data.ok) {
                    const message = response.status === 403 ? "You do not have permission to edit this customer." : "Unable to load customer. Please try again.";
                    showNscMessage(message);
                    console.error("Failed to load customer", response.status, data);
                    return;
                }
                const customer = data.data;
                editingCustomerId = customer?.id || selectedId;
                setNonSamproxMode("edit", customer);
                populateNonSamproxForm(customer);
                elements.nsCustomerCode.readOnly = true;
                renderCityOptions(customer?.city || "");
                applyLocationForCity(customer?.city || "");
                if (user.role === "sales") {
                    elements.nsManagedBy.disabled = true;
                }
                clearNscMessage();
                openModal(elements.nonSamproxModal);
            } catch (err) {
                console.error("Failed to load customer", err);
                showNscMessage("Unable to load customer. Please try again.");
            }
        });

        elements.nsSave.addEventListener("click", async () => {
            elements.nonSamproxError.hidden = true;
            const payload = {
                customer_name: elements.nsCustomerName.value,
                area_code: elements.nsAreaCode.value,
                city: elements.nsCity.value,
                district: elements.nsDistrict.value,
                province: elements.nsProvince.value,
                company_id: elements.nsCompany.value,
                customer_code: elements.nsCustomerCode.value,
            };

            if (user.role !== "sales" && elements.nsManagedBy.value) {
                payload.managed_by_user_id = Number(elements.nsManagedBy.value);
            }
            if ((user.role === "outside_manager" || user.role === "admin") && nonSamproxMode === "edit") {
                payload.is_active = elements.nsActive.value === "true";
            }

            const editId = (elements.nscEditId && elements.nscEditId.value) || editingCustomerId;
            const isEdit = nonSamproxMode === "edit" && editId;
            const url = isEdit ? `/api/non-samprox-customers/${editId}` : "/api/non-samprox-customers";
            const method = isEdit ? "PUT" : "POST";
            const response = await authFetch(url, {
                method,
                body: JSON.stringify(payload),
            });
            const data = await response.json();
            if (!data.ok) {
                const message =
                    response.status === 403
                        ? "You do not have permission to edit this customer."
                        : data.error || "Unable to save customer";
                elements.nonSamproxError.textContent = message;
                elements.nonSamproxError.hidden = false;
                return;
            }
            const saved = data.data;
            closeModal(elements.nonSamproxModal);
            updateNonSamproxCache(saved);
            renderNonSamproxOptions(saved?.id || elements.visitNonSamprox.value);
            if (saved?.id) {
                elements.visitNonSamprox.value = String(saved.id);
            }
            await loadNonSamproxCustomers(elements.visitNonSamproxSearch.value);
            if (saved?.id) {
                elements.visitNonSamprox.value = String(saved.id);
            }
            setNonSamproxMode("create");
            clearNscMessage();
        });

        elements.nsCity.addEventListener("input", () => {
            renderCityOptions(elements.nsCity.value);
            applyLocationForCity(elements.nsCity.value);
        });
        elements.nsCity.addEventListener("change", () => {
            applyLocationForCity(elements.nsCity.value);
        });
        elements.nsCompany.addEventListener("change", async () => {
            clearNscMessage();
            await loadNextNonSamproxCode(elements.nsCompany.value);
        });

        updateColumnVisibility();
        loadLocationData();
        loadTeam()
            .catch(() => {})
            .finally(async () => {
                await loadNonSamproxCustomers();
                await loadVisits();
            });
    </script>
</body>
</html>
